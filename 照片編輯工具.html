<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片編輯工具</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 載入 Fabric.js 函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- HEIC/HEIF format support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>

    <!-- 載入多種開源中文字型 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC&family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&family=Long+Cang&family=Ma+Shan+Zheng&family=Hanalei+Fill&family=Liu+Jian+Mao+Cao&family=Yuji+Boku&family=Kaisei+Decol&family=Shippori+Mincho&display=swap" rel="stylesheet">
    <style>
        /* A large collection of free open-source Chinese fonts */
        @import url('https://fonts.googleapis.com/css2?family=GenSenRounded+TW:wght@400;700&family=GenYoMin&family=Balsamiq+Sans:wght@400;700&family=Chilanka&family=Dosis:wght@200..800&family=Kalam:wght@300;400;700&family=Kaushan+Script&family=Lobster&family=Mansalva&family=Nanum+Pen+Script&family=Patrick+Hand&family=Permanent+Marker&family=Satisfy&family=Varela+Round&family=Zeyada&family=Kaisei+Tokumin:wght@400;500;700&family=Shippori+Mincho+B1:wght@400;500;600;700;800&family=Zen+Maru+Gothic:wght@300;400;500;700;900&family=M+PLUS+Rounded+1c:wght@300;400;500;700;800;900&family=Noto+Serif+JP:wght@200..900&family=Noto+Sans+JP:wght@100..900&family=Hina+Mincho&family=Kosugi+Maru&family=Pinyon+Script&family=Cormorant+Garamond:wght@300;400;500;600;700&family=Playfair+Display:wght@400..900&family=Cutive+Mono&family=Fira+Sans+Extra+Condensed:wght@100..900&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&family=Josefin+Sans:wght@100..700&family=Mukta:wght@200..800&family=Lora:ital,wght@0,400..700;1,400..700&family=Sarabun:wght@100..800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gen+Jyuu+Gothic+L:wght@400;700&display=swap');
        
        /* New fonts added */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&family=Taipei+Sans+TC:wght@400;700&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&family=Long+Cang&family=Liu+Jian+Mao+Cao&family=Yuji+Boku&family=Kaisei+Decol&family=Shippori+Mincho&family=Kaisei+Tokumin:wght@400;500;700&family=Shippori+Mincho+B1:wght@400;500;600;700;800&display=swap&text=%E6%80%9D%E6%BA%90%E6%9F%94%E9%BB%91%E9%AB%94%E5%8F%B0%E5%8C%97%E9%BB%91%E9%AB%94%E6%BA%90%E7%9F%B3%E9%BB%91%E9%AB%94%E6%BA%90%E6%A8%A3%E9%BB%91%E9%AB%94%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E6%99%AE%E6%83%A0%E9%AB%94%E7%8D%85%E5%B0%BE%E5%9C%93%E9%AB%94%E6%A5%B7%E6%9B%B8%E9%A2%A8');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&display=swap'); /* For Alibaba PuHuiTi */
        @import url('https://fonts.googleapis.com/css2?family=Fandol+Kai&display=swap'); /* For regular script */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/fontsource-noto-sans-sc/4.5.1/noto-sans-sc.css');
        
        @font-face {
            font-family: 'Alibaba PuHuiTi';
            src: url('https://fonts.gstatic.com/s/notosanssc/v35/kJe_BypfJ7QyPq-Q8p-R2P_-9WpBwA78TqF9T4C9B4Q.woff2') format('woff2');
        }
        @font-face {
            font-family: 'GenSenRounded';
            src: url('https://fonts.gstatic.com/s/gensanrounded/v1/F-xYwM0-oGv-QJc2kH5lDqA7gHwG2A.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Source Han Sans';
            src: url('https://fonts.gstatic.com/s/sourcehansans/v11/A8qj_tGqP4oM1Qo9K4IuP2B-91t2P7Yv1P5gL5P5Q.woff2') format('woff2');
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #1a202c; /* Dark text for contrast */
        }
        .container-card {
            background-color: #ffffff; /* White card background */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .tool-panel {
            background-color: #f8fafc; /* Light gray panel background */
        }
        .tool-button {
            background-color: #e2e8f0; /* Light button background */
            color: #4a5568; /* Dark text */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tool-button:hover {
            background-color: #3b82f6; /* Blue hover color */
            color: #fff;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }
        .tool-button:disabled {
            background-color: #cbd5e1; /* Gray for disabled buttons */
            color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        .upload-btn {
            background-color: #3b82f6; /* Blue as the slider color */
            color: #fff;
            font-weight: 700;
        }
        .upload-btn:hover {
            background-color: #2563eb; /* Darker blue */
        }
        .tool-button.filter-btn:hover {
            background-color: #6366f1; /* Indigo hover color for filters */
        }
        .tool-button.download-btn {
            background-color: #10b981; /* Green for download */
            color: #fff;
        }
        .tool-button.download-btn:hover {
            background-color: #059669;
        }
        .tool-button.reset-btn {
            background-color: #ef4444; /* Red for reset */
            color: #fff;
        }
        .tool-button.reset-btn:hover {
            background-color: #dc2626;
        }
        .tool-button.undo-btn {
            background-color: #f59e0b; /* Amber for undo */
            color: #fff;
        }
        .tool-button.undo-btn:hover {
            background-color: #d97706;
        }
        .tool-slider-container {
            background-color: #e2e8f0; /* Light background for sliders */
            padding: 0.5rem; /* Reduced padding */
            border-radius: 0.5rem;
        }
        /* Custom CSS for a better-looking slider */
        input[type="range"]::-webkit-slider-runnable-track {
            background: #cbd5e1;
            border-radius: 9999px;
            height: 8px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border-radius: 50%;
            margin-top: -4px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease, transform 0.3s ease;
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            background: #2563eb;
            transform: scale(1.1);
        }
        .panel-heading {
            color: #3b82f6; /* Blue color for headings */
        }
        .slider-control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .slider-arrow-btn {
            background-color: #cbd5e1;
            color: #4a5568;
            padding: 0.25rem;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .slider-arrow-btn:hover {
            background-color: #a0aec0;
        }
        select#font-family option {
            font-family: var(--font-family); /* Use the value from the option as a CSS variable */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start p-8 min-h-screen text-gray-800">

    <!-- Title and Subtitle -->
    <div class="w-full text-center mb-2 relative">
        <!-- macOS-style window controls -->
        <div class="absolute left-4 top-5 flex items-center gap-2">
            <span class="block w-3 h-3 rounded-full bg-[#FF5F57]" style="box-shadow: 0 1px 3px rgba(0,0,0,0.12);"></span>
            <span class="block w-3 h-3 rounded-full bg-[#FFBD2E]" style="box-shadow: 0 1px 3px rgba(0,0,0,0.12);"></span>
            <span class="block w-3 h-3 rounded-full bg-[#28CA42]" style="box-shadow: 0 1px 3px rgba(0,0,0,0.12);"></span>
        </div>
        
        <h1 class="text-3xl font-bold panel-heading">照片編輯工具</h1>
        <p class="text-base text-gray-600 mt-1">在瀏覽器端編輯照片，提供風格濾鏡特效、色彩光影調整及文字添加等工具，讓您輕鬆美化圖片</p>
        <p class="text-sm text-gray-600 mt-0">製作者：陳政德</p>
    </div>

    <!-- Main container for canvas and tools -->
    <div class="flex flex-col md:flex-row w-full max-w-7xl gap-3 items-start">
        
        <!-- Main Canvas Area - top aligned -->
        <div class="flex-1 w-full bg-white rounded-xl shadow-inner flex flex-col items-center justify-start p-2 overflow-hidden container-card">
            <canvas id="photo-canvas" class="rounded-xl border-2 border-dashed border-gray-300 max-w-full max-h-[75vh]"></canvas>
        </div>

        <!-- Right Side Control Panel - No scrollbar, reduced gap and padding -->
        <div class="w-full md:w-80 flex flex-col gap-2 p-2 rounded-xl container-card">
            <!-- Basic Tools -->
            <div>
                <h2 class="text-base font-bold mb-1 panel-heading">基本工具</h2>
                <!-- Reduced padding and gap -->
                <div class="bg-white p-1 rounded-lg shadow-sm tool-panel flex flex-col gap-1">
                    <div class="flex justify-between items-center gap-1">
                        <label for="image-upload" class="cursor-pointer tool-button upload-btn py-2 px-3 rounded-xl shadow-sm text-sm font-bold w-1/2 text-center">
                            <i class="fas fa-upload text-sm mr-1"></i> 選擇照片
                        </label>
                        <input type="file" id="image-upload" accept="image/*,.heic,.heif" class="hidden">
                        <button id="undo-btn" class="tool-button undo-btn py-2 px-3 rounded-xl shadow-sm w-1/4" title="復原">
                            <i class="fas fa-reply text-sm"></i>
                        </button>
                        <button id="reset-btn" class="tool-button reset-btn py-2 px-3 rounded-xl shadow-sm w-1/4" title="重設所有變更">
                            <i class="fas fa-rotate-left text-sm"></i>
                        </button>
                    </div>
                    <div class="slider-control-group">
                        <label for="zoom-slider" class="block text-xs font-medium text-gray-600 flex-shrink-0">縮放</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('zoom-slider', -0.05)">-</button>
                        <input type="range" id="zoom-slider" min="0.1" max="3" value="1" step="0.05" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                        <button class="slider-arrow-btn" onclick="adjustSlider('zoom-slider', 0.05)">+</button>
                        <span id="zoom-value" class="text-xs text-gray-600 w-8 text-right">100%</span>
                    </div>
                    <div class="slider-control-group">
                        <label for="rotate-slider" class="block text-xs font-medium text-gray-600 flex-shrink-0">旋轉</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('rotate-slider', -1)">-</button>
                        <input type="range" id="rotate-slider" min="-180" max="180" value="0" step="1" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                        <button class="slider-arrow-btn" onclick="adjustSlider('rotate-slider', 1)">+</button>
                        <span id="rotate-value" class="text-xs text-gray-600 w-8 text-right">0°</span>
                    </div>
                    <div class="flex justify-between gap-1">
                        <button id="crop-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm w-full text-xs"><i class="fas fa-crop-simple text-xs mr-1"></i> 剪裁</button>
                    </div>
                </div>
            </div>

            <!-- Filter & Effects -->
            <div>
                <h2 class="text-base font-bold mb-1 panel-heading">濾鏡與特效</h2>
                <!-- Reduced padding and gap -->
                <div class="bg-white p-1 rounded-lg shadow-sm tool-panel grid grid-cols-3 gap-1">
                    <button id="landscape-btn" class="filter-btn tool-button py-1 px-3 rounded-xl shadow-sm text-xs">風景</button>
                    <button id="food-btn" class="filter-btn tool-button py-1 px-3 rounded-xl shadow-sm text-xs">食物</button>
                    <button id="clarity-btn" class="filter-btn tool-button py-1 px-3 rounded-xl shadow-sm text-xs">清晰</button>
                    <button id="brighten-shadows-btn" class="filter-btn tool-button py-1 px-3 rounded-xl shadow-sm text-xs">陰影增亮</button>
                    <button id="beauty-skin-btn" class="filter-btn tool-button py-1 px-3 rounded-xl shadow-sm text-xs">美肌</button>
                    <button id="highlight-recovery-btn" class="filter-btn tool-button py-1 px-3 rounded-xl shadow-sm text-xs">亮部調暗</button>
                </div>
            </div>

            <!-- Advanced Tools -->
            <div>
                <h2 class="text-base font-bold mb-1 panel-heading">進階工具</h2>
                <!-- Reduced padding and gap -->
                <div class="tool-slider-container p-1">
                    <div class="slider-control-group">
                        <label for="brightness-slider" class="text-xs font-medium text-gray-600 flex-shrink-0">亮度</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('brightness-slider', -0.01)">-</button>
                        <input type="range" id="brightness-slider" min="-1" max="1" value="0" step="0.01" class="w-full">
                        <button class="slider-arrow-btn" onclick="adjustSlider('brightness-slider', 0.01)">+</button>
                    </div>
                    <div class="slider-control-group">
                        <label for="contrast-slider" class="text-xs font-medium text-gray-600 flex-shrink-0">對比度</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('contrast-slider', -0.01)">-</button>
                        <input type="range" id="contrast-slider" min="-1" max="1" value="0" step="0.01" class="w-full">
                        <button class="slider-arrow-btn" onclick="adjustSlider('contrast-slider', 0.01)">+</button>
                    </div>
                    <div class="slider-control-group">
                        <label for="saturation-slider" class="text-xs font-medium text-gray-600 flex-shrink-0">飽和度</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('saturation-slider', -0.01)">-</button>
                        <input type="range" id="saturation-slider" min="-1" max="1" value="0" step="0.01" class="w-full">
                        <button class="slider-arrow-btn" onclick="adjustSlider('saturation-slider', 0.01)">+</button>
                    </div>
                    <div class="slider-control-group">
                        <label for="sharpen-slider" class="text-xs font-medium text-gray-600 flex-shrink-0">銳化</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('sharpen-slider', -0.01)">-</button>
                        <input type="range" id="sharpen-slider" min="0" max="1" value="0" step="0.01" class="w-full">
                        <button class="slider-arrow-btn" onclick="adjustSlider('sharpen-slider', 0.01)">+</button>
                    </div>
                    <div class="slider-control-group">
                        <label for="shadow-slider" class="text-xs font-medium text-gray-600 flex-shrink-0">陰影</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('shadow-slider', -0.01)">-</button>
                        <input type="range" id="shadow-slider" min="0" max="1" value="0" step="0.01" class="w-full">
                        <button class="slider-arrow-btn" onclick="adjustSlider('shadow-slider', 0.01)">+</button>
                    </div>
                    <div class="slider-control-group">
                        <label for="gamma-slider" class="text-xs font-medium text-gray-600 flex-shrink-0">Gamma 校正</label>
                        <button class="slider-arrow-btn" onclick="adjustSlider('gamma-slider', -0.05)">-</button>
                        <input type="range" id="gamma-slider" min="0.1" max="5" value="1" step="0.05" class="w-full">
                        <button class="slider-arrow-btn" onclick="adjustSlider('gamma-slider', 0.05)">+</button>
                    </div>
                </div>
            </div>
            
            <!-- Text & Grouping & Download Tools -->
            <div>
                <h2 class="text-base font-bold mb-1 panel-heading">文字與圖形工具</h2>
                <div class="bg-white p-1 rounded-lg shadow-sm tool-panel flex flex-col gap-1 mb-1">
                    <div class="flex gap-1">
                        <button id="add-text-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs w-1/2"><i class="fas fa-font text-xs mr-1"></i>加入文字</button>
                        <button id="add-shape-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs w-1/2"><i class="fas fa-shapes text-xs mr-1"></i>加入圖形</button>
                    </div>
                    <div id="text-options" class="hidden flex flex-col gap-1 mt-1">
                        <label for="font-family" class="text-xs font-medium text-gray-600">字型</label>
                        <select id="font-family" class="w-full p-1 rounded-md bg-gray-100 text-gray-800 border border-gray-300">
                            <!-- 已新增超過 30 種中文字型選項 -->
                            <option value="Noto Sans TC" style="font-family: 'Noto Sans TC'">思源黑體 (標準)</option>
                            <option value="Noto Serif TC" style="font-family: 'Noto Serif TC'">思源宋體 (優雅)</option>
                            <option value="Taipei Sans TC" style="font-family: 'Taipei Sans TC'">台北黑體 (免費授權)</option>
                            <option value="GenSenRounded" style="font-family: 'GenSenRounded'">思源柔黑體</option>
                            <option value="GenYoMin" style="font-family: 'GenYoMin'">源樣黑體</option>
                            <option value="Source Han Sans" style="font-family: 'Source Han Sans'">源石黑體</option>
                            <option value="Alibaba PuHuiTi" style="font-family: 'Alibaba PuHuiTi'">阿里巴巴普惠體</option>
                            <option value="Ma Shan Zheng" style="font-family: 'Ma Shan Zheng'">楷書體 (草書)</option>
                            <option value="Long Cang" style="font-family: 'Long Cang'">龍藏體 (書法)</option>
                            <option value="ShiWei Round" style="font-family: 'ShiWei Round'">獅尾圓體</option>
                            <option value="Zhi Mang Xing" style="font-family: 'Zhi Mang Xing'">字夢行 (手寫)</option>
                            <option value="Liu Jian Mao Cao" style="font-family: 'Liu Jian Mao Cao'">柳體 (草書)</option>
                            <option value="Yuji Boku" style="font-family: 'Yuji Boku'">游築書體</option>
                            <option value="Kaisei Decol" style="font-family: 'Kaisei Decol'">海星 (裝飾)</option>
                            <option value="Shippori Mincho" style="font-family: 'Shippori Mincho'">細明體 (細緻)</option>
                            <option value="M PLUS Rounded 1c" style="font-family: 'M PLUS Rounded 1c'">M Plus 圓體</option>
                            <option value="Zen Maru Gothic" style="font-family: 'Zen Maru Gothic'">禪丸黑體 (圓體)</option>
                            <option value="Noto Serif JP" style="font-family: 'Noto Serif JP'">思源宋體日文版</option>
                            <option value="Noto Sans JP" style="font-family: 'Noto Sans JP'">思源黑體日文版</option>
                            <option value="Hina Mincho" style="font-family: 'Hina Mincho'">雛明朝體</option>
                            <option value="Kosugi Maru" style="font-family: 'Kosugi Maru'">小杉圓體</option>
                            <option value="Pinyon Script" style="font-family: 'Pinyon Script'">花式手寫體</option>
                            <option value="Cormorant Garamond" style="font-family: 'Cormorant Garamond'">華麗字體</option>
                            <option value="Playfair Display" style="font-family: 'Playfair Display'">古典襯線體</option>
                            <option value="Cutive Mono" style="font-family: 'Cutive Mono'">等寬打字機體</option>
                            <option value="Fira Sans Extra Condensed" style="font-family: 'Fira Sans Extra Condensed'">窄版無襯線體</option>
                            <option value="PT Serif" style="font-family: 'PT Serif'">襯線體</option>
                            <option value="Josefin Sans" style="font-family: 'Josefin Sans'">幾何復古體</option>
                            <option value="Mukta" style="font-family: 'Mukta'">現代無襯線體</option>
                            <option value="Lora" style="font-family: 'Lora'">優雅襯線體</option>
                            <option value="Sarabun" style="font-family: 'Sarabun'">Sarabun 字體</option>
                            <option value="Kaisei Tokumin" style="font-family: 'Kaisei Tokumin'">開成德明朝體</option>
                            <option value="Shippori Mincho B1" style="font-family: 'Shippori Mincho B1'">細明體 B1</option>
                            <option value="Kaushan Script" style="font-family: 'Kaushan Script'">手寫筆刷體</option>
                            <option value="Permanent Marker" style="font-family: 'Permanent Marker'">麥克筆塗鴉</option>
                            <option value="Varela Round" style="font-family: 'Varela Round'">圓潤無襯線</option>
                        </select>
                        <label for="font-size" class="text-xs font-medium text-gray-600">大小</label>
                        <input type="range" id="font-size" min="10" max="100" value="30" class="w-full">
                        <label for="font-color" class="text-xs font-medium text-gray-600">顏色</label>
                        <input type="color" id="font-color" value="#000000" class="w-full h-8 bg-gray-100 border-none">
                    </div>
                    <div id="shape-options" class="hidden flex flex-col gap-1 mt-1">
                        <div class="grid grid-cols-4 gap-1">
                            <button id="add-line-btn" class="tool-button p-2 rounded-xl" title="直線"><i class="fas fa-minus"></i></button>
                            <button id="add-rect-btn" class="tool-button p-2 rounded-xl" title="框線"><i class="far fa-square"></i></button>
                            <button id="add-circle-btn" class="tool-button p-2 rounded-xl" title="圓形"><i class="far fa-circle"></i></button>
                            <button id="add-arrow-btn" class="tool-button p-2 rounded-xl" title="箭頭"><i class="fas fa-long-arrow-alt-right"></i></button>
                            <button id="add-diamond-btn" class="tool-button p-2 rounded-xl" title="菱形"><i class="far fa-gem"></i></button>
                            <button id="add-rounded-rect-btn" class="tool-button p-2 rounded-xl" title="圓角矩形"><i class="fas fa-vector-square"></i></button>
                            <button id="free-draw-btn" class="tool-button p-2 rounded-xl" title="自由劃線"><i class="fas fa-pencil-alt"></i></button>
                        </div>
                        <div class="mt-2 flex flex-col gap-1">
                            <label for="shape-stroke-width" class="text-xs font-medium text-gray-600">線條寬度</label>
                            <input type="range" id="shape-stroke-width" min="1" max="50" value="2" class="w-full">
                            <label for="shape-stroke-color" class="text-xs font-medium text-gray-600">線條顏色</label>
                            <input type="color" id="shape-stroke-color" value="#000000" class="w-full h-8 bg-gray-100 border-none">
                        </div>
                    </div>
                </div>
                
                <h2 class="text-base font-bold mb-1 panel-heading">群組</h2>
                <div class="bg-white p-1 rounded-lg shadow-sm tool-panel flex gap-1">
                    <button id="group-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm w-1/2 text-xs" disabled><i class="fas fa-object-group text-xs mr-1"></i> 群組</button>
                    <button id="ungroup-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm w-1/2 text-xs" disabled><i class="fas fa-object-ungroup text-xs mr-1"></i> 取消群組</button>
                </div>
                
                <h2 class="text-base font-bold mb-1 panel-heading">下載</h2>
                <div class="bg-white p-1 rounded-lg shadow-sm tool-panel">
                    <div class="flex gap-2 mb-2">
                        <div class="w-1/2">
                            <label for="download-format" class="block mb-1 text-xs font-bold text-gray-600">照片類型</label>
                            <select id="download-format" class="w-full px-1 py-0.5 rounded-md bg-gray-100 text-gray-800 border border-gray-300 text-xs">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label for="download-resolution" class="block mb-1 text-xs font-bold text-gray-600">解析度</label>
                            <select id="download-resolution" class="w-full px-1 py-0.5 rounded-md bg-gray-100 text-gray-800 border border-gray-300 text-xs">
                                <option value="original">原始</option>
                                <option value="1280x720">HD (1280x720)</option>
                                <option value="1920x1080">Full HD (1920x1080)</option>
                                <option value="2560x1440">2K (2560x1440)</option>
                                <option value="3840x2160">4K (3840x2160)</option>
                            </select>
                        </div>
                    </div>
                    <button id="download-btn" class="tool-button download-btn w-full py-2 rounded-xl shadow-md"><i class="fas fa-download text-sm mr-1"></i>下載照片</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let canvas, img, originalImageSrc;
        let croppingRect, isCropping = false;
        let history = []; // To store states for undo functionality
        let historyIndex = -1;

        // Function to save the current canvas state to history
        function saveState() {
            const state = JSON.stringify(canvas.toJSON());
            history = history.slice(0, historyIndex + 1); // Discard redo states
            history.push(state);
            historyIndex++;
        }

        // Function to undo the last action
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = history[historyIndex];
                canvas.loadFromJSON(state, () => {
                    canvas.renderAll();
                    updateSliders(); // Sync sliders with the restored state
                });
            }
        }
        
        // Function to update sliders based on the current image state
        function updateSliders() {
            if (img) {
                document.getElementById('zoom-slider').value = img.scaleX;
                document.getElementById('zoom-value').innerText = `${Math.round(img.scaleX * 100)}%`;
                document.getElementById('rotate-slider').value = img.angle;
                document.getElementById('rotate-value').innerText = `${Math.round(img.angle)}°`;

                // Update advanced tool sliders based on filters
                let brightnessFilter = img.filters.find(f => f.type === 'Brightness');
                let contrastFilter = img.filters.find(f => f.type === 'Contrast');
                let saturationFilter = img.filters.find(f => f.type === 'Saturation');
                let gammaFilter = img.filters.find(f => f.type === 'Gamma');

                document.getElementById('brightness-slider').value = brightnessFilter ? brightnessFilter.brightness : 0;
                document.getElementById('contrast-slider').value = contrastFilter ? contrastFilter.contrast : 0;
                document.getElementById('saturation-slider').value = saturationFilter ? saturationFilter.saturation : 0;
                document.getElementById('gamma-slider').value = gammaFilter ? gammaFilter.gamma[0] : 1;
            }
        }
        
        // Function to adjust slider value with arrow buttons
        function adjustSlider(id, delta) {
            const slider = document.getElementById(id);
            let value = parseFloat(slider.value) + delta;
            // Clamp the value within the min/max range
            value = Math.min(Math.max(value, parseFloat(slider.min)), parseFloat(slider.max));
            slider.value = value;
            slider.dispatchEvent(new Event('input'));
        }
        window.adjustSlider = adjustSlider; // Make the function globally accessible

        // Initialize the canvas on window load
        window.onload = function() {
            canvas = new fabric.Canvas('photo-canvas', {
                backgroundColor: '#ffffff' /* White canvas background */
            });

            // Adjust canvas size to fit container and maintain aspect ratio on resize
            function resizeCanvas() {
                const container = canvas.wrapperEl.parentNode;
                let containerWidth = container.offsetWidth;
                let containerHeight = container.offsetHeight;
                const maxWidth = 1200;
                const maxHeight = 700;
                containerWidth = Math.min(containerWidth, maxWidth);
                containerHeight = Math.min(containerHeight, maxHeight);
                
                let newWidth, newHeight;
                if (img) {
                    const ratio = img.width / img.height;
                    if (containerWidth / ratio < containerHeight) {
                        newWidth = containerWidth;
                        newHeight = newWidth / ratio;
                    } else {
                        newHeight = containerHeight;
                        newWidth = newHeight * ratio;
                    }
                } else {
                    // Default dimensions when no image is loaded
                    newWidth = 800;
                    newHeight = 600;
                }
                
                canvas.setDimensions({ width: newWidth, height: newHeight });

                if (img) {
                    const scale = Math.min(newWidth / img.width, newHeight / img.height);
                    img.set({
                        scaleX: scale,
                        scaleY: scale,
                        left: newWidth / 2,
                        top: newHeight / 2,
                        originX: 'center',
                        originY: 'center'
                    });
                    canvas.renderAll();
                }
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // Set up event listeners for file input and buttons
            document.getElementById('image-upload').addEventListener('change', handleImageUpload);
            document.getElementById('zoom-slider').addEventListener('input', handleZoom);
            document.getElementById('download-btn').addEventListener('click', handleDownload);
            document.getElementById('add-text-btn').addEventListener('click', handleAddText);
            document.getElementById('reset-btn').addEventListener('click', handleReset);
            document.getElementById('undo-btn').addEventListener('click', undo); // New undo button
            document.getElementById('crop-btn').addEventListener('click', handleCrop);
            document.getElementById('rotate-slider').addEventListener('input', handleRotate);
            
            // New Shape Tools Event Listeners
            document.getElementById('add-shape-btn').addEventListener('click', toggleShapeOptions);
            document.getElementById('add-line-btn').addEventListener('click', () => handleAddShape('line'));
            document.getElementById('add-rect-btn').addEventListener('click', () => handleAddShape('rect'));
            document.getElementById('add-circle-btn').addEventListener('click', () => handleAddShape('circle'));
            document.getElementById('add-arrow-btn').addEventListener('click', () => handleAddShape('arrow'));
            document.getElementById('add-diamond-btn').addEventListener('click', () => handleAddShape('diamond'));
            document.getElementById('add-rounded-rect-btn').addEventListener('click', () => handleAddShape('rounded-rect'));
            document.getElementById('free-draw-btn').addEventListener('click', toggleFreeDraw);


            // Set up filter button event listeners
            document.getElementById('landscape-btn').addEventListener('click', () => applyFilter('landscape'));
            document.getElementById('food-btn').addEventListener('click', () => applyFilter('food'));
            document.getElementById('clarity-btn').addEventListener('click', () => applyFilter('clarity'));
            document.getElementById('brighten-shadows-btn').addEventListener('click', () => applyFilter('brighten-shadows'));
            document.getElementById('beauty-skin-btn').addEventListener('click', () => applyFilter('beauty-skin'));
            document.getElementById('highlight-recovery-btn').addEventListener('click', () => applyFilter('highlight-recovery'));

            // Set up slider event listeners for real-time adjustments
            document.getElementById('brightness-slider').addEventListener('input', handleSliderChange);
            document.getElementById('contrast-slider').addEventListener('input', handleSliderChange);
            document.getElementById('saturation-slider').addEventListener('input', handleSliderChange);
            document.getElementById('sharpen-slider').addEventListener('input', handleSliderChange);
            document.getElementById('shadow-slider').addEventListener('input', handleSliderChange);
            document.getElementById('gamma-slider').addEventListener('input', handleSliderChange); 
            
            // Set up text tool event listeners
            document.getElementById('font-family').addEventListener('change', updateTextOptions);
            document.getElementById('font-size').addEventListener('input', updateTextOptions);
            document.getElementById('font-color').addEventListener('input', updateTextOptions);
            
            // Set up shape tool event listeners
            document.getElementById('shape-stroke-width').addEventListener('input', updateShapeOptions);
            document.getElementById('shape-stroke-color').addEventListener('input', updateShapeOptions);

            // Grouping button event listeners
            document.getElementById('group-btn').addEventListener('click', groupObjects);
            document.getElementById('ungroup-btn').addEventListener('click', ungroupObjects);

            // Listen for object events to update button states
            canvas.on({
                'selection:created': updateGroupButtons,
                'selection:updated': updateGroupButtons,
                'selection:cleared': updateGroupButtons,
            });

            // Listen for object events to maintain z-index of text
            canvas.on('object:moving', (e) => {
                const activeObject = e.target;
                if (activeObject && activeObject.type === 'image') {
                    // Ensure all text objects are always on top
                    canvas.getObjects().forEach(obj => {
                        if (obj.type === 'i-text') {
                            canvas.bringToFront(obj);
                        }
                    });
                }
            });

            canvas.on('object:modified', saveState);
        };

        // Handles the image file upload
        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            let imageBlob = file;

            // Check if it's a HEIC/HEIF file
            const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');

            if (isHeic) {
                try {
                    imageBlob = await heic2any({
                        blob: file,
                        toType: "image/jpeg",
                        quality: 0.9,
                    });
                } catch (err) {
                    console.error("HEIC conversion failed:", err);
                    return;
                }
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImageSrc = event.target.result;
                fabric.Image.fromURL(originalImageSrc, (oImg) => {
                    canvas.clear();
                    img = oImg;
                    
                    const container = canvas.wrapperEl.parentNode;
                    const ratio = img.width / img.height;
                    let containerWidth = container.offsetWidth;
                    let containerHeight = container.offsetHeight;
                    const maxWidth = 1200;
                    const maxHeight = 700;
                    containerWidth = Math.min(containerWidth, maxWidth);
                    containerHeight = Math.min(containerHeight, maxHeight);
                    
                    let newWidth, newHeight;
                    if (containerWidth / ratio < containerHeight) {
                        newWidth = containerWidth;
                        newHeight = newWidth / ratio;
                    } else {
                        newHeight = containerHeight;
                        newWidth = newHeight * ratio;
                    }
                    canvas.setDimensions({ width: newWidth, height: newHeight });

                    const scale = Math.min(newWidth / img.width, newHeight / img.height);
                    img.set({
                        crossOrigin: 'anonymous',
                        originX: 'center',
                        originY: 'center',
                        left: newWidth / 2,
                        top: newHeight / 2,
                        scaleX: scale,
                        scaleY: scale
                    });
                    
                    canvas.add(img);
                    canvas.renderAll();
                    saveState();
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(imageBlob);
        }

        // Handles the zoom slider functionality
        function handleZoom(e) {
            if (!img) {
                return;
            }
            const scale = parseFloat(e.target.value);
            /* Get the center of the image on the canvas */
            const center = canvas.getCenter();
            img.scaleX = scale;
            img.scaleY = scale;
            img.setCoords();
            canvas.renderAll();
            document.getElementById('zoom-value').innerText = `${Math.round(scale * 100)}%`;
        }
        
        // Handles rotation of the main image object using a slider
        function handleRotate(e) {
            if (!img) {
                return;
            }
            const angle = parseFloat(e.target.value);
            /* Rotate the image around the canvas center */
            const center = canvas.getCenter();
            img.set({
                originX: 'center',
                originY: 'center',
                left: center.left,
                top: center.top,
                angle: angle
            });
            canvas.renderAll();
            document.getElementById('rotate-value').innerText = `${Math.round(angle)}°`;
        }

        // Handles cropping
        function handleCrop() {
            if (!img) {
                return;
            }
            if (isCropping) {
                /* Apply crop */
                const cropWidth = croppingRect.getScaledWidth() / img.getScaledWidth() * img.width;
                const cropHeight = croppingRect.getScaledHeight() / img.getScaledHeight() * img.height;
                const cropX = (croppingRect.left - img.left) / img.getScaledWidth() * img.width;
                const cropY = (croppingRect.top - img.top) / img.getScaledHeight() * img.height;

                img.set({
                    cropX: cropX,
                    cropY: cropY,
                    width: cropWidth,
                    height: cropHeight
                });
                
                canvas.remove(croppingRect);
                isCropping = false;
                canvas.renderAll();
                saveState();
            } else {
                /* Start cropping */
                isCropping = true;
                croppingRect = new fabric.Rect({
                    left: img.left,
                    top: img.top,
                    width: img.getScaledWidth(),
                    height: img.getScaledHeight(),
                    fill: 'rgba(0,0,0,0.3)',
                    stroke: 'white',
                    strokeWidth: 2,
                    selectable: true,
                    hasBorders: true,
                    hasControls: true,
                });
                canvas.add(croppingRect);
                canvas.bringToFront(croppingRect);
                canvas.setActiveObject(croppingRect);
            }
        }

        // Applies a specific filter to the main image object
        function applyFilter(filterName) {
            if (!img) {
                return;
            }

            /* Clear all filters first to prevent stacking */
            img.filters = [];
            
            switch (filterName) {
                case 'clarity':
                    img.filters.push(new fabric.Image.filters.Contrast({ contrast: 0.15 }));
                    img.filters.push(new fabric.Image.filters.Saturation({ saturation: 0.05 }));
                    break;
                case 'brighten-shadows':
                    img.filters.push(new fabric.Image.filters.Gamma({
                        gamma: [2.2, 2.2, 2.2] /* Adjusting the gamma curve to brighten shadows */
                    }));
                    break;
                case 'beauty-skin':
                    /* A simple blur to soften the image */
                    img.filters.push(new fabric.Image.filters.Convolute({
                        matrix: [ 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9 ]
                    }));
                    break;
                case 'landscape':
                    /* Increase contrast and saturation for a more vibrant landscape */
                    img.filters.push(new fabric.Image.filters.Contrast({ contrast: 0.2 }));
                    img.filters.push(new fabric.Image.filters.Saturation({ saturation: 0.2 }));
                    break;
                case 'food':
                    /* Boost saturation and brightness to make food look more appetizing */
                    img.filters.push(new fabric.Image.filters.Saturation({ saturation: 0.3 }));
                    img.filters.push(new fabric.Image.filters.Brightness({ brightness: 0.1 }));
                    break;
                case 'highlight-recovery':
                    /* Reduce brightness in highlights */
                    img.filters.push(new fabric.Image.filters.Gamma({
                        gamma: [0.8, 0.8, 0.8] // Lower gamma to compress highlights
                    }));
                    img.filters.push(new fabric.Image.filters.Contrast({ contrast: 0.05 }));
                    break;
                default:
                    break;
            }
            
            img.applyFilters();
            canvas.renderAll();
            saveState();
        }

        // Handles slider changes for real-time image adjustments
        function handleSliderChange() {
            if (!img) {
                return;
            }

            const brightness = parseFloat(document.getElementById('brightness-slider').value);
            const contrast = parseFloat(document.getElementById('contrast-slider').value);
            const saturation = parseFloat(document.getElementById('saturation-slider').value);
            const sharpen = parseFloat(document.getElementById('sharpen-slider').value);
            const shadow = parseFloat(document.getElementById('shadow-slider').value);
            const gamma = parseFloat(document.getElementById('gamma-slider').value);

            img.filters = [];

            /* Add filters based on slider values */
            if (brightness !== 0) {
                img.filters.push(new fabric.Image.filters.Brightness({ brightness: brightness }));
            }
            if (contrast !== 0) {
                img.filters.push(new fabric.Image.filters.Contrast({ contrast: contrast }));
            }
            if (saturation !== 0) {
                img.filters.push(new fabric.Image.filters.Saturation({ saturation: saturation }));
            }
            if (sharpen > 0) {
                img.filters.push(new fabric.Image.filters.Convolute({
                    matrix: [0, -1, 0, -1, 5, -1, 0, -1, 0]
                }));
            }
            if (shadow > 0) {
                img.filters.push(new fabric.Image.filters.Brightness({ brightness: shadow * 0.2 }));
                img.filters.push(new fabric.Image.filters.Contrast({ contrast: shadow * 0.1 }));
            }
            if (gamma !== 1) {
                img.filters.push(new fabric.Image.filters.Gamma({ gamma: [gamma, gamma, gamma] }));
            }

            img.applyFilters();
            canvas.renderAll();
        }
        
        // Adds a text object to the canvas
        function handleAddText() {
            if (!img) {
                return;
            }
            
            /* Show text customization options and hide shape options */
            document.getElementById('text-options').classList.remove('hidden');
            document.getElementById('shape-options').classList.add('hidden');
            
            const text = new fabric.IText('點擊並輸入文字', {
                left: 50,
                top: 50,
                fontFamily: document.getElementById('font-family').value,
                fontSize: 30,
                fill: '#000000',
                editable: true,
                hasControls: true,
                hasBorders: true
            });
            canvas.add(text);
            /* Bring the newly added text object to the front */
            canvas.bringToFront(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
            saveState();
        }

        // Updates the active text object based on user selections
        function updateTextOptions() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set({
                    fontFamily: document.getElementById('font-family').value,
                    fontSize: parseInt(document.getElementById('font-size').value, 10),
                    fill: document.getElementById('font-color').value
                });
                canvas.renderAll();
                saveState();
            }
        }
        
        // Toggles the visibility of the shape options panel
        function toggleShapeOptions() {
            document.getElementById('shape-options').classList.toggle('hidden');
            document.getElementById('text-options').classList.add('hidden');
        }

        // Toggles free drawing mode
        function toggleFreeDraw() {
            canvas.isDrawingMode = !canvas.isDrawingMode;
            const btn = document.getElementById('free-draw-btn');
            if (canvas.isDrawingMode) {
                btn.classList.add('bg-blue-500', 'text-white');
                canvas.freeDrawingBrush.color = document.getElementById('shape-stroke-color').value;
                canvas.freeDrawingBrush.width = parseInt(document.getElementById('shape-stroke-width').value, 10);
            } else {
                btn.classList.remove('bg-blue-500', 'text-white');
            }
        }
        
        // Updates active shape or free drawing brush
        function updateShapeOptions() {
            const strokeWidth = parseInt(document.getElementById('shape-stroke-width').value, 10);
            const strokeColor = document.getElementById('shape-stroke-color').value;
            
            // Update free drawing brush if active
            if (canvas.isDrawingMode) {
                canvas.freeDrawingBrush.width = strokeWidth;
                canvas.freeDrawingBrush.color = strokeColor;
            }
            
            // Update selected object
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type !== 'image' && activeObject.type !== 'i-text') {
                // For arrow (group)
                if (activeObject.type === 'group' && activeObject._objects.length === 2) {
                    activeObject._objects[0].set({ stroke: strokeColor, strokeWidth: strokeWidth });
                    activeObject._objects[1].set({ fill: strokeColor });
                } else { // For other shapes
                     activeObject.set({
                        stroke: strokeColor,
                        strokeWidth: strokeWidth
                    });
                }
                canvas.renderAll();
                saveState();
            }
        }

        // Adds a shape to the canvas
        function handleAddShape(shapeType) {
            if (!img) return;

            if (canvas.isDrawingMode) {
                toggleFreeDraw();
            }
            
            const strokeWidth = parseInt(document.getElementById('shape-stroke-width').value, 10);
            const strokeColor = document.getElementById('shape-stroke-color').value;

            let shape;
            const commonOptions = {
                left: 100,
                top: 100,
                fill: 'transparent',
                stroke: strokeColor,
                strokeWidth: strokeWidth
            };

            switch (shapeType) {
                case 'line':
                    shape = new fabric.Line([50, 50, 200, 50], { ...commonOptions, fill: null });
                    break;
                case 'rect':
                    shape = new fabric.Rect({ ...commonOptions, width: 150, height: 100 });
                    break;
                case 'circle':
                    shape = new fabric.Circle({ ...commonOptions, radius: 50 });
                    break;
                case 'rounded-rect':
                    shape = new fabric.Rect({ ...commonOptions, width: 150, height: 100, rx: 10, ry: 10 });
                    break;
                case 'diamond':
                    shape = new fabric.Polygon([
                        { x: 0, y: 50 }, { x: 75, y: 0 }, { x: 150, y: 50 }, { x: 75, y: 100 }
                    ], { ...commonOptions });
                    break;
                case 'arrow':
                    const line = new fabric.Line([0, 0, 150, 0], { stroke: commonOptions.stroke, strokeWidth: commonOptions.strokeWidth });
                    const triangle = new fabric.Triangle({
                        left: 150, top: 0, originX: 'center', originY: 'center',
                        width: 10, height: 10, fill: commonOptions.stroke, angle: 90
                    });
                    shape = new fabric.Group([line, triangle], { left: commonOptions.left, top: commonOptions.top });
                    break;
            }

            if (shape) {
                canvas.add(shape);
                canvas.setActiveObject(shape);
                canvas.renderAll();
                saveState();
            }
        }

        // Handles image download
        function handleDownload() {
            if (!img) {
                return;
            }
            
            const format = document.getElementById('download-format').value;
            const resolution = document.getElementById('download-resolution').value;
            let width, height;

            if (resolution === 'original') {
                width = img.width;
                height = img.height;
            } else {
                [width, height] = resolution.split('x').map(Number);
            }

            const link = document.createElement('a');
            
            const dataURL = canvas.toDataURL({
                format: format,
                quality: 1.0,
                multiplier: width / canvas.getWidth()
            });
            
            link.href = dataURL;
            link.download = `edited_photo_${resolution}.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Resets all changes by reloading the original image
        function handleReset() {
            if (!originalImageSrc) {
                return;
            }
            
            fabric.Image.fromURL(originalImageSrc, (oImg) => {
                canvas.clear();
                img = oImg;
                img.set({
                    crossOrigin: 'anonymous',
                    originX: 'center',
                    originY: 'center',
                    left: canvas.getCenter().left,
                    top: canvas.getCenter().top
                });
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                img.scale(scale);
                canvas.add(img);
                canvas.renderAll();
                
                /* Reset all sliders and text options */
                document.getElementById('brightness-slider').value = 0;
                document.getElementById('contrast-slider').value = 0;
                document.getElementById('saturation-slider').value = 0;
                document.getElementById('sharpen-slider').value = 0;
                document.getElementById('shadow-slider').value = 0;
                document.getElementById('gamma-slider').value = 1;
                document.getElementById('zoom-slider').value = 1;
                document.getElementById('rotate-slider').value = 0;
                document.getElementById('zoom-value').innerText = `100%`;
                document.getElementById('rotate-value').innerText = `0°`;
                document.getElementById('text-options').classList.add('hidden');
                document.getElementById('shape-options').classList.add('hidden');
                
                // Clear history and save initial state
                history = [];
                historyIndex = -1;
                saveState();
            }, { crossOrigin: 'anonymous' });
        }

        // Function to group selected objects
        function groupObjects() {
            if (!canvas.getActiveObject() || canvas.getActiveObject().type !== 'activeSelection') {
                return;
            }
            const activeObjects = canvas.getActiveObject();
            if (activeObjects.size() < 2) {
                return;
            }
            const group = activeObjects.toGroup();
            canvas.requestRenderAll();
            saveState();
        }

        // Function to ungroup selected objects
        function ungroupObjects() {
            if (!canvas.getActiveObject() || canvas.getActiveObject().type !== 'group') {
                return;
            }
            const group = canvas.getActiveObject();
            group.ungroupOnCanvas();
            canvas.requestRenderAll();
            saveState();
        }

        // Function to update the disabled state of group/ungroup buttons
        function updateGroupButtons() {
            const activeObject = canvas.getActiveObject();
            document.getElementById('group-btn').disabled = true;
            document.getElementById('ungroup-btn').disabled = true;

            if (activeObject) {
                if (activeObject.type === 'activeSelection') {
                    document.getElementById('group-btn').disabled = false;
                } else if (activeObject.type === 'group') {
                    document.getElementById('ungroup-btn').disabled = false;
                }
            }
        }
    </script>
</body>
</html>
