<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片編輯工具</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 載入 Fabric.js 函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- HEIC/HEIF format support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- PDF.js for PDF import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <!-- 載入多種開源中文字型 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC&family=Noto+Sans+TC:wght@400;700&family=Zhi+Mang+Xing&family=Long+Cang&family=Ma+Shan+Zheng&family=Hanalei+Fill&family=Liu+Jian+Mao+Cao&family=Yuji+Boku&family=Kaisei+Decol&family=Shippori+Mincho&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=GenSenRounded+TW:wght@400;700&family=GenYoMin&family=ZCOOL+KuaiLe&family=Balsamiq+Sans:wght@400;700&family=Chilanka&family=Dosis:wght@200..800&family=Kalam:wght@300;400;700&family=Kaushan+Script&family=Lobster&family=Mansalva&family=Nanum+Pen+Script&family=Patrick+Hand&family=Permanent+Marker&family=Satisfy&family=Varela+Round&family=Zeyada&family=Kaisei+Tokumin:wght@400;500;700&family=Shippori+Mincho+B1:wght@400;500;600;700;800&family=Zen+Maru+Gothic:wght@300;400;500;700;900&family=M+PLUS+Rounded+1c:wght@300;400;500;700;800;900&family=Noto+Serif+JP:wght@200..900&family=Noto+Sans+JP:wght@100..900&family=Hina+Mincho&family=Kosugi+Maru&family=Pinyon+Script&family=Cormorant+Garamond:wght@300;400;500;600;700&family=Playfair+Display:wght@400..900&family=Cutive+Mono&family=Fira+Sans+Extra+Condensed:wght@100..900&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&family=Josefin+Sans:wght@100..700&family=Mukta:wght@200..800&family=Lora:ital,wght@0,400..700;1,400..700&family=Sarabun:wght@100..800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gen+Jyuu+Gothic+L:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&family=Taipei+Sans+TC:wght@400;700&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&family=Long+Cang&family=Liu+Jian+Mao+Cao&family=Yuji+Boku&family=Kaisei+Decol&family=Shippori+Mincho&family=Kaisei+Tokumin:wght@400..700&family=Shippori+Mincho+B1:wght@400..800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fandol+Kai&display=swap');
        
        /* [NEW] Light/Dark Theme Variables */
        :root {
            --bg-color: #f0f4f8;
            --text-color: #1a202c;
            --text-muted-color: #4a5568;
            --card-bg-color: #ffffff;
            --tool-panel-bg-color: #f8fafc;
            --tool-button-bg-color: #e2e8f0;
            --tool-button-text-color: #4a5568;
            --panel-heading-color: #3b82f6;
            --border-color: #e2e8f0;
            --input-bg-color: #f1f5f9;
        }

        html.dark {
            --bg-color: #1a202c;
            --text-color: #e2e8f0;
            --text-muted-color: #a0aec0;
            --card-bg-color: #2d3748;
            --tool-panel-bg-color: #1f2937;
            --tool-button-bg-color: #4a5568;
            --tool-button-text-color: #e2e8f0;
            --panel-heading-color: #60a5fa;
            --border-color: #4a5568;
            --input-bg-color: #4a5568;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container-card { 
            background-color: var(--card-bg-color); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .tool-panel { background-color: var(--tool-panel-bg-color); }
        .tool-button { 
            background-color: var(--tool-button-bg-color); 
            color: var(--tool-button-text-color); 
            transition: all 0.2s ease-in-out; 
        }
        .tool-button:hover:not(:disabled) { background-color: #3b82f6; color: #fff; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2); }
        .tool-button:disabled { background-color: #cbd5e1; color: #a0aec0; cursor: not-allowed; }
        .mode-active { background-color: #3b82f6; color: white !important; }
        
        .upload-btn { background-color: #3b82f6; color: #fff; font-weight: 700; }
        .upload-btn:hover { background-color: #2563eb; }
        .reset-btn { background-color: #ef4444; color: #fff; }
        .reset-btn:hover:not(:disabled) { background-color: #dc2626; }
        .undo-btn { background-color: #f59e0b; color: #fff; }
        .undo-btn:hover:not(:disabled) { background-color: #d97706; }
        .download-btn { background-color: #10b981; color: #fff; }
        .download-btn:hover { background-color: #059669; }
        
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #cbd5e1; border-radius: 9999px; outline: none; opacity: 0.9; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; }
        input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; background: #3b82f6; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        
        .panel-heading, .text-apple-blue { color: var(--panel-heading-color); }
        .text-muted { color: var(--text-muted-color); }
        select, .bg-input { background-color: var(--input-bg-color) !important; color: var(--text-color) !important; }

        .slider-control-group { display: flex; align-items: center; gap: 0.5rem; }
        .slider-arrow-btn { background-color: #cbd5e1; color: #4a5568; padding: 0.25rem; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; }
        .slider-arrow-btn:hover { background-color: #a0aec0; }

        #fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); justify-content: center; align-items: center; z-index: 9999; cursor: zoom-out; overflow: hidden; }
        #fullscreen-image { max-width: none; max-height: none; cursor: grab; }
        #fullscreen-image.grabbing { cursor: grabbing; }
        #fullscreen-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 10000; }
        #fullscreen-controls button { background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; }
        
        .collapsible-header .chevron { transition: transform 0.3s ease-in-out; }
        .collapsible-header .chevron.collapsed { transform: rotate(-90deg); }
        .collapsible-content { max-height: 1000px; overflow: hidden; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; padding-top: 0.25rem; }
        .collapsible-content.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; }
        
        #layer-list .layer-item { transition: background-color 0.2s; }
        #layer-list .layer-item.active { background-color: #dbeafe; color: #1e40af; }
        html.dark #layer-list .layer-item.active { background-color: #374151; color: #eff6ff; }
        .layer-controls button:disabled { color: #cbd5e1; cursor: not-allowed; }

        /* [NEW] Instruction Section Style */
        #instructions-section .step { border-left: 3px solid var(--panel-heading-color); padding-left: 1rem; transition: border-color 0.3s; }
        #instructions-section .step p { color: var(--text-muted-color); }
    </style>
</head>
<body class="flex flex-col items-center justify-start p-4 md:p-8 min-h-screen">
    
    <!-- [NEW] Theme Toggle Button -->
    <div class="absolute top-4 right-4 z-10">
        <button id="theme-toggle" title="切換明暗主題" class="tool-button p-2 rounded-full shadow-md w-10 h-10 flex items-center justify-center">
            <i id="theme-icon" class="fas fa-sun"></i>
        </button>
    </div>

    <div class="w-full mb-4 text-center">
        <h1 class="text-xl md:text-2xl font-bold panel-heading">照片編輯工具</h1>
        <p class="text-sm text-muted mt-0.5">在瀏覽器端編輯照片，提供風格濾鏡特效、色彩光影調整及文字添加等功能</p>
        <p class="text-sm text-muted mt-0">製作者：陳政德</p>
    </div>

    <div id="main-container" class="flex flex-col md:flex-row w-full gap-3 items-start max-w-7xl">
        
        <div id="canvas-wrapper" class="relative flex-1 w-full bg-gray-200 rounded-xl shadow-inner flex items-center justify-center p-2 overflow-auto container-card" style="height: 80vh;">
            <canvas id="photo-canvas" class="rounded-xl"></canvas>
            <canvas id="grid-canvas" class="absolute top-0 left-0 pointer-events-none hidden"></canvas>
        </div>

        <div id="tools-panel" class="w-full md:w-80 flex flex-col gap-2 p-2 rounded-xl container-card max-h-[80vh] overflow-y-auto">
            
            <!-- Layer Panel -->
            <div>
                <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">圖層管理</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div id="layer-panel" class="p-1 rounded-lg shadow-sm tool-panel">
                        <div id="layer-list" class="max-h-48 overflow-y-auto border rounded-md bg-input text-xs" style="border-color: var(--border-color);">
                           <!-- Layer items will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Basic Tools -->
            <div>
                <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">基本工具</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel flex flex-col gap-1">
                        <div class="flex justify-between items-center gap-1">
                            <label for="image-upload" title="從電腦選擇一張照片 (支援 JPG, PNG, HEIC, PDF)" class="cursor-pointer tool-button upload-btn py-2 px-3 rounded-xl shadow-sm text-sm font-bold w-1/2 text-center">
                                <i class="fas fa-upload text-sm mr-1"></i> 選擇照片
                            </label>
                            <input type="file" id="image-upload" accept="image/*,.heic,.heif,.pdf" class="hidden">
                            <button id="undo-btn" class="tool-button undo-btn py-2 px-3 rounded-xl shadow-sm w-1/4" title="復原上一步 (Ctrl+Z)"><i class="fas fa-reply text-sm"></i></button>
                            <button id="reset-btn" class="tool-button reset-btn py-2 px-3 rounded-xl shadow-sm w-1/4" title="重設所有變更"><i class="fas fa-rotate-left text-sm"></i></button>
                        </div>
                        <div class="slider-control-group">
                            <label for="zoom-slider" class="block text-xs font-medium text-muted flex-shrink-0">縮放</label>
                            <button class="slider-arrow-btn" onclick="adjustSlider('zoom-slider', -0.05)" title="縮小">-</button>
                            <input type="range" id="zoom-slider" min="0.1" max="5" value="1" step="0.05" title="調整圖片縮放比例">
                            <button class="slider-arrow-btn" onclick="adjustSlider('zoom-slider', 0.05)" title="放大">+</button>
                            <span id="zoom-value" class="text-xs text-muted w-8 text-right">100%</span>
                        </div>
                        <div class="slider-control-group">
                            <label for="rotate-slider" class="block text-xs font-medium text-muted flex-shrink-0">旋轉</label>
                            <button class="slider-arrow-btn" onclick="adjustSlider('rotate-slider', -1)" title="逆時針旋轉">-</button>
                            <input type="range" id="rotate-slider" min="-180" max="180" value="0" step="1" title="旋轉圖片">
                            <button class="slider-arrow-btn" onclick="adjustSlider('rotate-slider', 1)" title="順時針旋轉">+</button>
                            <span id="rotate-value" class="text-xs text-muted w-8 text-right">0°</span>
                        </div>
                        <button id="crop-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm w-full text-xs" title="剪裁圖片"><i class="fas fa-crop-simple text-xs mr-1"></i> 剪裁</button>
                        <div class="grid grid-cols-3 gap-1 mt-1">
                            <button id="flip-h-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="水平翻轉"><i class="fas fa-arrows-alt-h text-xs mr-1"></i>水平翻轉</button>
                            <button id="flip-v-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="垂直翻轉"><i class="fas fa-arrows-alt-v text-xs mr-1"></i>垂直翻轉</button>
                             <button id="grid-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="顯示/隱藏網格線"><i class="fas fa-border-all text-xs mr-1"></i>網格線</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Tools -->
            <div>
                <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">檢視工具</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel flex flex-col gap-1">
                        <div class="flex flex-wrap gap-1 justify-center">
                            <button id="fullscreen-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs" title="進入全螢幕相片檢視模式 (ESC退出)">全螢幕</button>
                            <button id="fit-canvas-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs" title="將圖片縮放至最適合畫布的大小">縮放至畫布</button>
                            <button id="color-picker-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs" title="點選畫布獲取顏色資訊">色彩選擇器</button>
                        </div>
                        <div id="color-picker-display" class="hidden mt-1 p-2 bg-input rounded-lg text-xs font-mono flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="font-bold">RGB:</span>
                                <span id="rgb-value">---, ---, ---</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold">HEX:</span>
                                <span id="hex-value">#------</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter & Effects -->
            <div>
                 <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">濾鏡與特效</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel flex flex-wrap gap-1">
                        <button onclick="applyPreset('optimize')" class="filter-btn tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="自動最佳化亮度、對比與色彩">最佳化</button>
                        <button onclick="applyPreset('landscape')" class="filter-btn tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="增強風景照的色彩與對比">風景</button>
                        <button onclick="applyPreset('food')" class="filter-btn tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="讓食物照片更鮮豔可口">食物</button>
                        <button onclick="applyPreset('night')" class="filter-btn tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="增亮夜景並添加冷色調">夜景</button>
                        <button onclick="applyFilter('grayscale')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="套用黑白濾鏡">黑白</button>
                        <button onclick="applyFilter('sepia')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="套用復古棕褐色濾鏡">復古</button>
                        <button onclick="applyFilter('invert')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="套用負片效果">負片</button>
                        <button onclick="applyFilter('blur')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="套用模糊效果">模糊</button>
                        <button onclick="applyFilter('pixelate')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="套用像素化效果">像素化</button>
                        <button onclick="applyFilter('vignette')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="新增暗角效果">暈影</button>
                        <button onclick="applyFilter('noise')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="新增雜訊顆粒效果">雜訊</button>
                        <button onclick="applyFilter('emboss')" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs" title="套用浮雕效果">浮雕</button>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Tools -->
            <div>
                <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">進階工具</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel tool-slider-container">
                        <div class="slider-control-group">
                            <label for="brightness-slider" class="text-xs font-medium text-muted flex-shrink-0">亮度</label>
                            <input type="range" id="brightness-slider" min="-1" max="1" value="0" step="0.01" title="調整亮度">
                        </div>
                        <div class="slider-control-group">
                            <label for="contrast-slider" class="text-xs font-medium text-muted flex-shrink-0">對比度</label>
                            <input type="range" id="contrast-slider" min="-1" max="1" value="0" step="0.01" title="調整對比度">
                        </div>
                        <div class="slider-control-group">
                            <label for="saturation-slider" class="text-xs font-medium text-muted flex-shrink-0">飽和度</label>
                            <input type="range" id="saturation-slider" min="-1" max="1" value="0" step="0.01" title="調整飽和度">
                        </div>
                        <div class="slider-control-group">
                            <label for="hue-slider" class="text-xs font-medium text-muted flex-shrink-0">色相</label>
                            <input type="range" id="hue-slider" min="-1" max="1" value="0" step="0.01" title="調整色相">
                        </div>
                        <div class="slider-control-group">
                            <label for="temperature-slider" class="text-xs font-medium text-muted flex-shrink-0">色溫</label>
                            <input type="range" id="temperature-slider" min="-100" max="100" value="0" step="1" title="調整色溫 (冷-暖)">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Special Effects Adjustment Panel -->
            <div id="effects-adjustment-panel" class="hidden">
                 <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">特效調整</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel tool-slider-container">
                        <div id="blur-control" class="slider-control-group hidden">
                            <label for="blur-slider" class="text-xs font-medium text-muted flex-shrink-0">模糊強度</label>
                            <input type="range" id="blur-slider" min="0" max="1" value="0.3" step="0.01" title="調整模糊強度">
                        </div>
                        <div id="pixelate-control" class="slider-control-group hidden">
                            <label for="pixelate-slider" class="text-xs font-medium text-muted flex-shrink-0">像素大小</label>
                            <input type="range" id="pixelate-slider" min="2" max="30" value="8" step="1" title="調整像素大小">
                        </div>
                        <div id="vignette-control" class="slider-control-group hidden">
                            <label for="vignette-slider" class="text-xs font-medium text-muted flex-shrink-0">暈影強度</label>
                            <input type="range" id="vignette-slider" min="0" max="1" value="0.5" step="0.01" title="調整暈影強度">
                        </div>
                        <div id="noise-control" class="slider-control-group hidden">
                            <label for="noise-slider" class="text-xs font-medium text-muted flex-shrink-0">雜訊密度</label>
                            <input type="range" id="noise-slider" min="0" max="500" value="100" step="10" title="調整雜訊密度">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Text & Shape Tools -->
            <div>
                 <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">文字與圖形工具</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel flex flex-col gap-1 mb-1">
                        <div class="flex gap-1">
                            <label for="insert-image-upload" class="cursor-pointer tool-button py-1 px-3 rounded-xl shadow-sm text-xs w-1/3 text-center flex items-center justify-center" title="在照片上插入一張圖片"><i class="fas fa-image text-xs mr-1"></i>插入圖片</label>
                            <input type="file" id="insert-image-upload" accept="image/*,.heic,.heif,.pdf" class="hidden">
                            <button id="add-text-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs w-1/3" title="在照片上加入可編輯的文字"><i class="fas fa-font text-xs mr-1"></i>加入文字</button>
                            <button id="add-shape-btn" class="tool-button py-1 px-3 rounded-xl shadow-sm text-xs w-1/3" title="在照片上加入圖形"><i class="fas fa-shapes text-xs mr-1"></i>加入圖形</button>
                        </div>
                        <div id="text-options" class="hidden flex flex-col gap-1 mt-1 p-2 bg-input rounded-lg">
                            <label for="font-family" class="text-xs font-medium text-muted">字型</label>
                            <select id="font-family" class="w-full p-1 rounded-md border text-sm" style="border-color: var(--border-color);">
                                 <option value="Noto Sans TC" style="--font-family-name: 'Noto Sans TC'">思源黑體 (標準)</option>
                                 <option value="Noto Serif TC" style="--font-family-name: 'Noto Serif TC'">思源宋體 (優雅)</option>
                                 <option value="GenSenRounded TW" style="--font-family-name: 'GenSenRounded TW'">源泉圓體 (圓潤)</option>
                                 <option value="GenYoMin" style="--font-family-name: 'GenYoMin'">源樣明體 (復古)</option>
                                 <option value="Ma Shan Zheng" style="--font-family-name: 'Ma Shan Zheng'">馬善政 (書法)</option>
                                 <option value="ZCOOL KuaiLe" style="--font-family-name: 'ZCOOL KuaiLe'">站酷快樂體 (可愛)</option>
                                 <option value="sans-serif" style="--font-family-name: sans-serif">系統無襯線</option>
                                 <option value="serif" style="--font-family-name: serif">系統襯線</option>
                            </select>
                            <label for="font-size" class="text-xs font-medium text-muted mt-2">大小</label>
                            <input type="range" id="font-size" min="10" max="200" value="40" class="w-full">
                            <label for="font-color" class="text-xs font-medium text-muted mt-2">顏色</label>
                            <input type="color" id="font-color" value="#000000" class="w-full h-8 p-0 border-none cursor-pointer rounded-md">
                        </div>
                        <div id="shape-options" class="hidden flex flex-col gap-1 mt-1 p-2 bg-input rounded-lg">
                            <div class="flex flex-wrap gap-1">
                                <button onclick="handleAddShape('line')" class="tool-button p-2 rounded-xl" title="直線"><i class="fas fa-minus"></i></button>
                                <button onclick="handleAddShape('rect')" class="tool-button p-2 rounded-xl" title="框線"><i class="far fa-square"></i></button>
                                <button onclick="handleAddShape('circle')" class="tool-button p-2 rounded-xl" title="圓形"><i class="far fa-circle"></i></button>
                                <button onclick="handleAddShape('arrow')" class="tool-button p-2 rounded-xl" title="箭頭"><i class="fas fa-long-arrow-alt-right"></i></button>
                                <button onclick="handleAddShape('diamond')" class="tool-button p-2 rounded-xl" title="菱形"><i class="far fa-gem"></i></button>
                                <button onclick="handleAddShape('rounded-rect')" class="tool-button p-2 rounded-xl" title="圓角矩形"><i class="fas fa-vector-square"></i></button>
                                <button id="free-draw-btn" class="tool-button p-2 rounded-xl" title="自由劃線"><i class="fas fa-pencil-alt"></i></button>
                            </div>
                            <div class="mt-2 flex flex-col gap-1">
                                <label for="shape-stroke-width" class="text-xs font-medium text-muted">線條寬度</label>
                                <input type="range" id="shape-stroke-width" min="1" max="50" value="3" class="w-full">
                                <label for="shape-stroke-color" class="text-xs font-medium text-muted">線條顏色</label>
                                <input type="color" id="shape-stroke-color" value="#000000" class="w-full h-8 p-0 border-none cursor-pointer rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Object Tools -->
            <div>
                 <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">物件工具</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel flex flex-col gap-1">
                        <div class="flex flex-wrap gap-1">
                            <button id="cut-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs grow" disabled title="剪下 (Ctrl+X)"><i class="fas fa-cut text-xs mr-1"></i> 剪下</button>
                            <button id="copy-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs grow" disabled title="複製 (Ctrl+C)"><i class="fas fa-copy text-xs mr-1"></i> 複製</button>
                            <button id="paste-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs grow" disabled title="貼上 (Ctrl+V)"><i class="fas fa-paste text-xs mr-1"></i> 貼上</button>
                            <button id="group-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs grow" disabled title="群組物件 (Shift+點選多個物件)"><i class="fas fa-object-group text-xs mr-1"></i> 群組</button>
                            <button id="ungroup-btn" class="tool-button py-1 px-2 rounded-xl shadow-sm text-xs grow" disabled title="取消群組"><i class="fas fa-object-ungroup text-xs mr-1"></i> 取消群組</button>
                            <button id="delete-btn" class="tool-button reset-btn py-1 px-2 rounded-xl shadow-sm text-xs grow" disabled title="刪除 (Delete)"><i class="fas fa-trash-alt text-xs mr-1"></i> 刪除</button>
                        </div>
                        <div id="object-options" class="hidden p-1 mt-1 tool-slider-container">
                             <div class="slider-control-group">
                                <label for="object-rotate-slider" class="text-xs font-medium text-muted flex-shrink-0">旋轉</label>
                                <input type="range" id="object-rotate-slider" min="-180" max="180" value="0" step="1" title="旋轉物件">
                                <span id="object-rotate-value" class="text-xs text-muted w-8 text-right">0°</span>
                            </div>
                        </div>
                        <div id="align-options" class="hidden p-1 mt-1 bg-input rounded-lg grid grid-cols-6 gap-1">
                            <button onclick="handleAlign('left')" class="tool-button p-2 rounded-md" title="靠左對齊"><i class="fas fa-align-left"></i></button>
                            <button onclick="handleAlign('h-center')" class="tool-button p-2 rounded-md" title="水平置中"><i class="fas fa-align-center"></i></button>
                            <button onclick="handleAlign('right')" class="tool-button p-2 rounded-md" title="靠右對齊"><i class="fas fa-align-right"></i></button>
                            <button onclick="handleAlign('top')" class="tool-button p-2 rounded-md" title="靠上對齊"><i class="fas fa-align-left fa-rotate-90"></i></button>
                            <button onclick="handleAlign('v-center')" class="tool-button p-2 rounded-md" title="垂直置中"><i class="fas fa-align-center fa-rotate-90"></i></button>
                            <button onclick="handleAlign('bottom')" class="tool-button p-2 rounded-md" title="靠下對齊"><i class="fas fa-align-right fa-rotate-90"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Download Section -->
            <div>
                <div class="collapsible-header flex justify-between items-center cursor-pointer p-1">
                    <h2 class="text-base font-bold panel-heading">下載</h2>
                    <i class="fas fa-chevron-down chevron text-muted"></i>
                </div>
                <div class="collapsible-content">
                    <div class="p-1 rounded-lg shadow-sm tool-panel">
                        <div class="flex gap-2 mb-2">
                            <div class="w-1/2">
                                <label for="download-format" class="block mb-1 text-xs font-bold text-muted">照片類型</label>
                                <select id="download-format" class="w-full px-1 py-0.5 rounded-md border text-xs bg-input" style="border-color: var(--border-color);">
                                    <option value="png">PNG</option>
                                    <option value="jpeg">JPEG</option>
                                    <option value="svg">SVG</option>
                                    <option value="pdf">PDF</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label for="download-resolution" class="block mb-1 text-xs font-bold text-muted">解析度</label>
                                <select id="download-resolution" class="w-full px-1 py-0.5 rounded-md border text-xs bg-input" style="border-color: var(--border-color);">
                                    <option value="original">原始</option>
                                    <option value="1280x720">HD (1280x720)</option>
                                    <option value="1920x1080">Full HD (1920x1080)</option>
                                    <option value="2560x1440">2K (2560x1440)</option>
                                    <option value="3840x2160">4K (3840x2160)</option>
                                </select>
                            </div>
                        </div>
                        <button id="download-btn" class="tool-button download-btn w-full py-2 rounded-xl shadow-md" title="將編輯完成的照片儲存至電腦"><i class="fas fa-download text-sm mr-1"></i>下載照片</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- [NEW] Instructions Section -->
    <div id="instructions-section" class="w-full max-w-7xl mt-8 p-6 rounded-xl container-card">
        <h2 class="text-xl font-bold panel-heading mb-6 text-center"><i class="fas fa-book-open mr-2"></i>功能與操作說明</h2>
        <div class="grid md:grid-cols-2 gap-x-8 gap-y-6 text-sm">
            <div class="step">
                <h3 class="font-bold mb-1"><i class="fas fa-upload text-apple-blue w-6"></i> 1. 選擇與插入照片</h3>
                <p>點擊 <span class="font-bold text-apple-blue">「選擇照片」</span> 按鈕，從您的裝置上傳一張照片。支援 <span class="font-bold text-apple-blue">JPG, PNG, PDF</span>，以及 iPhone 的 <span class="font-bold text-apple-blue">HEIC</span> 格式。您也可以使用 <span class="font-bold text-apple-blue">「插入圖片」</span> 功能在現有照片上疊加另一張圖。</p>
            </div>
            <div class="step">
                <h3 class="font-bold mb-1"><i class="fas fa-ruler-combined text-apple-blue w-6"></i> 2. 基本調整</h3>
                <p>使用 <span class="font-bold text-apple-blue">縮放</span> 與 <span class="font-bold text-apple-blue">旋轉</span> 滑桿對照片進行基本變形。透過 <span class="font-bold text-apple-blue">剪裁</span> 工具，您可以選取並保留照片的特定區域。還能進行 <span class="font-bold text-apple-blue">水平/垂直翻轉</span>。</p>
            </div>
            <div class="step">
                <h3 class="font-bold mb-1"><i class="fas fa-magic-sparkles text-apple-blue w-6"></i> 3. 濾鏡與進階工具</h3>
                <p>提供多種一鍵套用的 <span class="font-bold text-apple-blue">風格濾鏡</span> (如黑白、復古)。若想更精細地調整，可至 <span class="font-bold text-apple-blue">進階工具</span> 區塊，手動調整 <span class="font-bold text-apple-blue">亮度、對比度、飽和度</span> 等參數。</p>
            </div>
            <div class="step">
                <h3 class="font-bold mb-1"><i class="fas fa-pencil-ruler text-apple-blue w-6"></i> 4. 添加文字與圖形</h3>
                <p>使用 <span class="font-bold text-apple-blue">「加入文字」</span> 功能來添加可自訂字型、大小和顏色的文字。透過 <span class="font-bold text-apple-blue">「加入圖形」</span>，可以繪製線條、方框、圓形等，並可使用 <span class="font-bold text-apple-blue">自由劃線</span> 工具隨意塗鴉。</p>
            </div>
            <div class="step">
                <h3 class="font-bold mb-1"><i class="fas fa-layer-group text-apple-blue w-6"></i> 5. 圖層與物件管理</h3>
                <p><span class="font-bold text-apple-blue">圖層管理</span> 面板會顯示所有您加入的物件。您可以調整它們的上下順序、進行 <span class="font-bold text-apple-blue">鎖定</span> 或 <span class="font-bold text-apple-blue">隱藏</span>。按住 Shift 鍵可選取多個物件進行 <span class="font-bold text-apple-blue">群組</span> 或 <span class="font-bold text-apple-blue">對齊</span> 操作。</p>
            </div>
            <div class="step">
                <h3 class="font-bold mb-1"><i class="fas fa-download text-apple-blue w-6"></i> 6. 下載成品</h3>
                <p>完成編輯後，在 <span class="font-bold text-apple-blue">下載</span> 區塊選擇您需要的 <span class="font-bold text-apple-blue">檔案格式</span> (PNG, JPEG, SVG, PDF) 和 <span class="font-bold text-apple-blue">解析度</span>，然後點擊 <span class="font-bold text-apple-blue">「下載照片」</span> 即可儲存。</p>
            </div>
        </div>
    </div>

    <div id="fullscreen-overlay" class="hidden">
        <img id="fullscreen-image" src="" alt="Fullscreen View">
        <div id="fullscreen-controls">
            <button id="zoom-out-fs" title="縮小">-</button>
            <button id="zoom-in-fs" title="放大">+</button>
        </div>
    </div>

    <div id="custom-tooltip" class="hidden absolute z-[10000] px-3 py-1.5 text-xs font-medium text-white bg-gray-900 rounded-lg shadow-sm pointer-events-none dark:bg-gray-700"></div>

    <script>
        // Global variables and utility functions
        let canvas, img, originalImageSrc;
        let history = []; 
        let historyIndex = -1;
        let clipboard = null;
        let isCropping = false;
        let cropRect = null;
        let isDrawingCropRect = false;
        let cropOrigin = { x: 0, y: 0 };
        let isColorPicking = false;
        let gridCanvas, isGridVisible = false;

        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        fabric.Object.prototype.set({
            borderColor: '#0d6efd',
            cornerColor: '#ffffff',
            cornerStrokeColor: '#0d6efd',
            cornerSize: 12,
            cornerStyle: 'rect',
            transparentCorners: false,
            borderWidth: 3,
            borderScaleFactor: 2
        });
        fabric.Canvas.prototype.selectionColor = 'rgba(13, 110, 253, 0.2)';
        fabric.Canvas.prototype.selectionBorderColor = '#0d6efd';

        function debounce(func, delay) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
        }
        const debouncedSaveState = debounce(saveState, 300);

        // --- History Management ---
        function saveState() {
            if (canvas.isRendering) return;
            const state = JSON.stringify(canvas.toJSON(['selectable', 'evented', 'id', 'name']));
            history = history.slice(0, historyIndex + 1);
            history.push(state);
            historyIndex++;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = history[historyIndex];
                canvas.loadFromJSON(state, () => {
                    img = canvas.getObjects().find(obj => obj.name === 'background');
                    if (img) {
                        img.set({ selectable: false, evented: false });
                    }
                    canvas.renderAll();
                    updateSliders(); 
                    renderLayerPanel();
                });
            }
        }
        
        // --- UI Updates ---
        function updateSliders() {
            if (!img) return;
            document.getElementById('zoom-slider').value = img.scaleX;
            document.getElementById('zoom-value').innerText = `${Math.round(img.scaleX * 100)}%`;
            document.getElementById('rotate-slider').value = img.angle;
            document.getElementById('rotate-value').innerText = `${Math.round(img.angle)}°`;
        }

        function adjustSlider(id, delta) {
            const slider = document.getElementById(id);
            if (!slider) return;
            let value = parseFloat(slider.value) + delta;
            value = Math.min(Math.max(value, parseFloat(slider.min)), parseFloat(slider.max));
            slider.value = value;
            slider.dispatchEvent(new Event('input'));
        }

        // --- Core Application Logic ---
        window.onload = function() {
            canvas = new fabric.Canvas('photo-canvas');
            const canvasWrapper = document.getElementById('canvas-wrapper');
            canvas.setWidth(canvasWrapper.clientWidth - 20);
            canvas.setHeight(canvasWrapper.clientHeight - 20);
            
            customizeFabricControls();
            
            canvas.renderAll();
            setupEventListeners();
            applyInitialTheme();
        };
        
        function customizeFabricControls() {
            const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24"><path fill="#ef4444" stroke="#ef4444" stroke-width="1.5" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>`;
            const rotationIconUrl = 'data:image/svg+xml;base64,' + btoa(svgStr);

            fabric.Image.fromURL(rotationIconUrl, function(img) {
                const rotationControl = new fabric.Control({
                    x: 0, y: -0.5, offsetY: -16, sizeX: 24, sizeY: 24,
                    cursorStyle: 'crosshair', actionHandler: fabric.controlsUtils.rotationWithSnapping, actionName: 'rotate',
                    render: function(ctx, left, top) { ctx.save(); ctx.translate(left, top); ctx.drawImage(img.getElement(), -12, -12, 24, 24); ctx.restore(); }
                });
                fabric.Object.prototype.controls.mtr = rotationControl;
                if (canvas) canvas.renderAll();
            });
        }

        function setupEventListeners() {
            document.getElementById('image-upload').addEventListener('change', handleImageUpload);
            document.getElementById('insert-image-upload').addEventListener('change', handleInsertImageUpload);

            document.getElementById('zoom-slider').addEventListener('input', handleZoom);
            document.getElementById('rotate-slider').addEventListener('input', handleRotate);
            document.getElementById('fullscreen-btn').addEventListener('click', enterFsViewer);
            document.getElementById('fit-canvas-btn').addEventListener('click', fitImageToCanvas);
            document.getElementById('copy-btn').addEventListener('click', handleCopy);
            document.getElementById('cut-btn').addEventListener('click', handleCut);
            document.getElementById('paste-btn').addEventListener('click', handlePaste);
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('delete-btn').addEventListener('click', handleDeleteObject);
            document.getElementById('reset-btn').addEventListener('click', () => handleReset(true));
            document.getElementById('download-btn').addEventListener('click', handleDownload);
            document.getElementById('add-text-btn').addEventListener('click', toggleTextOptions);
            document.getElementById('add-shape-btn').addEventListener('click', toggleShapeOptions);
            document.getElementById('free-draw-btn').addEventListener('click', toggleFreeDraw);
            document.getElementById('group-btn').addEventListener('click', groupObjects);
            document.getElementById('ungroup-btn').addEventListener('click', ungroupObjects);
            document.getElementById('object-rotate-slider').addEventListener('input', handleObjectRotation);
            document.getElementById('crop-btn').addEventListener('click', handleCrop);
            document.getElementById('color-picker-btn').addEventListener('click', toggleColorPicker);
            document.getElementById('flip-h-btn').addEventListener('click', () => handleFlip('horizontal'));
            document.getElementById('flip-v-btn').addEventListener('click', () => handleFlip('vertical'));
            document.getElementById('grid-btn').addEventListener('click', toggleGrid);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme); // [NEW]

            ['brightness', 'contrast', 'saturation', 'hue', 'temperature'].forEach(id => {
                 document.getElementById(`${id}-slider`).addEventListener('input', () => debounce(handleAdvancedAdjustments, 100)());
            });

            ['blur', 'pixelate', 'vignette', 'noise'].forEach(id => {
                const slider = document.getElementById(`${id}-slider`);
                if (slider) slider.addEventListener('input', () => debounce(handleEffectAdjustments, 100)());
            });
            
            document.getElementById('font-family').addEventListener('change', updateTextOptions);
            document.getElementById('font-size').addEventListener('input', updateTextOptions);
            document.getElementById('font-color').addEventListener('input', updateTextOptions);
            document.getElementById('shape-stroke-width').addEventListener('input', updateShapeOptions);
            document.getElementById('shape-stroke-color').addEventListener('input', updateShapeOptions);
            
            canvas.on({
                'selection:created': (e) => { updateObjectActionButtons(e); renderLayerPanel(); },
                'selection:updated': (e) => { updateObjectActionButtons(e); renderLayerPanel(); },
                'selection:cleared': (e) => { updateObjectActionButtons(e); renderLayerPanel(); },
                'object:modified': () => { debouncedSaveState(); renderLayerPanel(); },
                'object:added': () => { debouncedSaveState(); renderLayerPanel(); },
                'object:removed': () => { debouncedSaveState(); renderLayerPanel(); },
                'mouse:move': handleColorPickerMove
            });
            
            window.addEventListener('paste', handleSystemPaste);
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('mousedown', handleOutsideCanvasClick);
            
            const fontSelect = document.getElementById('font-family');
            Array.from(fontSelect.options).forEach(option => { option.style.setProperty('--font-family-name', option.value); });

            setupCustomTooltip();
            setupCollapsiblePanels();
            setupLayerPanel();
        }

        // [NEW] Theme handling
        function applyInitialTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (theme === 'dark') {
                html.classList.add('dark');
                icon.className = 'fas fa-moon';
            } else {
                html.classList.remove('dark');
                icon.className = 'fas fa-sun';
            }
        }
        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyInitialTheme();
        }
        
        // [MODIFIED] Tooltip setup
        function setupCustomTooltip() {
            const tooltip = document.getElementById('custom-tooltip');
            let currentTarget;
            document.body.addEventListener('mouseover', e => {
                const target = e.target.closest('[title]');
                if (!target || !target.title) return;
                currentTarget = target;
                tooltip.innerHTML = currentTarget.title;
                tooltip.classList.remove('hidden');
                currentTarget.setAttribute('data-title', currentTarget.title);
                currentTarget.title = '';
            });
            document.body.addEventListener('mouseout', () => {
                if (currentTarget) {
                    tooltip.classList.add('hidden');
                    currentTarget.title = currentTarget.getAttribute('data-title');
                    currentTarget.removeAttribute('data-title');
                    currentTarget = null;
                }
            });
            document.body.addEventListener('mousemove', e => {
                if (!tooltip.classList.contains('hidden')) {
                    tooltip.style.left = e.pageX + 15 + 'px';
                    tooltip.style.top = e.pageY + 15 + 'px';
                }
            });
        }
        
        function setupCollapsiblePanels() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.nextElementSibling.classList.toggle('collapsed');
                    header.querySelector('.chevron').classList.toggle('collapsed');
                });
            });
        }

        function handleOutsideCanvasClick(e) {
            if (e.target.closest('#canvas-wrapper') || e.target.closest('#tools-panel')) return;
            if (canvas.getActiveObject()) { canvas.discardActiveObject().renderAll(); }
        }

        function updateImageAndCanvasSize(scale) {
            if (!img) return;
            img.scale(scale);
            const newWidth = img.getScaledWidth();
            const newHeight = img.getScaledHeight();
            canvas.setWidth(newWidth);
            canvas.setHeight(newHeight);
            img.center();
            if (isGridVisible) drawGrid(newWidth, newHeight);
            canvas.renderAll();
        }

        // [FIXED] HEIC & PDF handling
        async function convertFileToDataURL(file) {
            // [FIXED] Improved HEIC detection to handle MIME types correctly
            const isHeic = file.type.startsWith('image/heic') || file.type.startsWith('image/heif') || (file.type === '' && (file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')));

            let processedFile = file;
            if (isHeic) {
                document.body.style.cursor = 'wait';
                try {
                    processedFile = await heic2any({ blob: file, toType: "image/png" });
                } catch (err) {
                    console.error("HEIC conversion error:", err);
                    alert('無法轉換 HEIC 檔案。');
                    throw new Error("HEIC Conversion Failed");
                } finally {
                    document.body.style.cursor = 'default';
                }
            }
            
            if (file.type === 'application/pdf') {
                document.body.style.cursor = 'wait';
                try {
                    const pdfData = new Uint8Array(await file.arrayBuffer());
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    await page.render({ canvasContext: tempCanvas.getContext('2d'), viewport }).promise;
                    return tempCanvas.toDataURL('image/png');
                } catch (err) {
                    console.error("PDF processing error:", err);
                    alert('無法讀取 PDF 檔案。');
                    throw new Error("PDF Processing Failed");
                } finally {
                    document.body.style.cursor = 'default';
                }
            }

            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.readAsDataURL(processedFile);
            });
        }
        
        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const dataURL = await convertFileToDataURL(file);
                fabric.Image.fromURL(dataURL, (oImg) => {
                    canvas.clear();
                    history = []; historyIndex = -1;
                    img = oImg;
                    originalImageSrc = dataURL;
                    img.set({ selectable: false, evented: false, name: 'background' });
                    canvas.add(img);
                    fitImageToCanvas();
                    saveState();
                }, { crossOrigin: 'anonymous' });
            } catch (error) {
                console.error("Could not load image:", error);
            }
            e.target.value = null;
        }
        
        async function handleInsertImageUpload(e) {
            const file = e.target.files[0];
            if (!file || !canvas) return;
            try {
                const dataURL = await convertFileToDataURL(file);
                fabric.Image.fromURL(dataURL, (newImg) => {
                    const scale = Math.min((canvas.width * 0.5) / newImg.width, (canvas.height * 0.5) / newImg.height);
                    newImg.scale(scale).set({ id: Date.now() });
                    canvas.add(newImg).centerObject(newImg).setActiveObject(newImg).requestRenderAll();
                }, { crossOrigin: 'anonymous' });
            } catch (error) {
                console.error("Could not insert image:", error);
            }
            e.target.value = null;
        }

        function handleZoom(e) { if (!img) return; const scale = parseFloat(e.target.value); updateImageAndCanvasSize(scale); document.getElementById('zoom-value').innerText = `${Math.round(scale * 100)}%`; }
        function handleRotate(e) { if (!img) return; const angle = parseFloat(e.target.value); img.set({ angle: angle }).center(); canvas.renderAll(); document.getElementById('rotate-value').innerText = `${Math.round(angle)}°`; debouncedSaveState(); }
        function fitImageToCanvas() { if (!img) return; const wrapper = document.getElementById('canvas-wrapper'); const scale = Math.min(wrapper.clientWidth / img.width, wrapper.clientHeight / img.height) * 0.95; updateImageAndCanvasSize(scale); updateSliders(); debouncedSaveState(); }
        
        function handleAdvancedAdjustments() {
            if (!img) return;
            const adjustments = {
                brightness: parseFloat(document.getElementById('brightness-slider').value),
                contrast: parseFloat(document.getElementById('contrast-slider').value),
                saturation: parseFloat(document.getElementById('saturation-slider').value),
                hue: parseFloat(document.getElementById('hue-slider').value),
                temperature: parseFloat(document.getElementById('temperature-slider').value)
            };
            img.filters = img.filters.filter(f => !['Brightness', 'Contrast', 'Saturation', 'HueRotation', 'ColorMatrix'].includes(f.type));
            if (adjustments.brightness !== 0) img.filters.push(new fabric.Image.filters.Brightness({ brightness: adjustments.brightness }));
            if (adjustments.contrast !== 0) img.filters.push(new fabric.Image.filters.Contrast({ contrast: adjustments.contrast }));
            if (adjustments.saturation !== 0) img.filters.push(new fabric.Image.filters.Saturation({ saturation: adjustments.saturation }));
            if (adjustments.hue !== 0) img.filters.push(new fabric.Image.filters.HueRotation({ rotation: adjustments.hue }));
            if (adjustments.temperature !== 0) {
                const tempValue = adjustments.temperature / 100;
                const matrix = [ 1, 0, 0, 0, tempValue > 0 ? tempValue * 0.2 : 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, tempValue < 0 ? -tempValue * 0.2 : 0, 0, 0, 0, 1, 0 ];
                img.filters.push(new fabric.Image.filters.ColorMatrix({ matrix: matrix }));
            }
            img.applyFilters();
            canvas.renderAll();
            debouncedSaveState();
        }
        
        function handleEffectAdjustments() {
            if (!img) return;
            const effects = {
                blur: document.getElementById('blur-slider').value,
                pixelate: document.getElementById('pixelate-slider').value,
                vignette: document.getElementById('vignette-slider').value,
                noise: document.getElementById('noise-slider').value
            };
            img.filters = img.filters.filter(f => !['Blur', 'Pixelate', 'Vignette', 'Noise'].includes(f.type));
            const panel = document.getElementById('effects-adjustment-panel');
            if(!panel.classList.contains('hidden')) {
                if(!document.getElementById('blur-control').classList.contains('hidden')) img.filters.push(new fabric.Image.filters.Blur({ blur: parseFloat(effects.blur) }));
                if(!document.getElementById('pixelate-control').classList.contains('hidden')) img.filters.push(new fabric.Image.filters.Pixelate({ blocksize: parseInt(effects.pixelate) }));
                if(!document.getElementById('vignette-control').classList.contains('hidden')) img.filters.push(new fabric.Image.filters.Vignette({ radius: 0.7, darkness: parseFloat(effects.vignette) }));
                if(!document.getElementById('noise-control').classList.contains('hidden')) img.filters.push(new fabric.Image.filters.Noise({ noise: parseInt(effects.noise) }));
            }
            img.applyFilters();
            canvas.renderAll();
            debouncedSaveState();
        }

        function applyPreset(presetName) {
            if (!img) return;
            resetImageState(); 
            const sliders = { brightness: document.getElementById('brightness-slider'), contrast: document.getElementById('contrast-slider'), saturation: document.getElementById('saturation-slider') };
            switch (presetName) {
                case 'optimize': sliders.contrast.value = 0.1; sliders.saturation.value = 0.05; break;
                case 'landscape': sliders.contrast.value = 0.2; sliders.saturation.value = 0.2; break;
                case 'food': sliders.brightness.value = 0.1; sliders.saturation.value = 0.3; break;
                case 'night': sliders.brightness.value = 0.2; break;
            }
            handleAdvancedAdjustments();
        }

        function applyFilter(filterName) { 
            if (!img) return; 
            resetImageState();
            const panel = document.getElementById('effects-adjustment-panel');
            const controls = { blur: document.getElementById('blur-control'), pixelate: document.getElementById('pixelate-control'), vignette: document.getElementById('vignette-control'), noise: document.getElementById('noise-control') };
            Object.values(controls).forEach(c => c.classList.add('hidden'));
            panel.classList.add('hidden');
            let hasAdjustableFilter = false;
            switch (filterName) {
                case 'grayscale': img.filters.push(new fabric.Image.filters.Grayscale()); break;
                case 'sepia': img.filters.push(new fabric.Image.filters.Sepia()); break;
                case 'invert': img.filters.push(new fabric.Image.filters.Invert()); break;
                case 'emboss': img.filters.push(new fabric.Image.filters.Convolute({ matrix: [ 1, 1, 1, 1, 0.7, -1, -1, -1, -1 ] })); break;
                case 'blur': case 'pixelate': case 'vignette': case 'noise':
                    hasAdjustableFilter = true;
                    panel.classList.remove('hidden');
                    controls[filterName].classList.remove('hidden');
                    handleEffectAdjustments();
                    break;
            }
            if (!hasAdjustableFilter) { img.applyFilters(); canvas.renderAll(); debouncedSaveState(); }
        }
        
        function handleFlip(direction) { if (!img) return; if (direction === 'horizontal') img.flipX = !img.flipX; else if (direction === 'vertical') img.flipY = !img.flipY; canvas.renderAll(); debouncedSaveState(); }
        function drawGrid(width, height) { if (!gridCanvas) { const gridEl = document.getElementById('grid-canvas'); gridCanvas = new fabric.StaticCanvas(gridEl); } gridCanvas.clear(); const wrapper = document.getElementById('canvas-wrapper'); const canvasEl = document.getElementById('photo-canvas'); const left = canvasEl.offsetLeft; const top = canvasEl.offsetTop; gridCanvas.setDimensions({ width, height }); gridCanvas.getElement().style.left = `${left}px`; gridCanvas.getElement().style.top = `${top}px`; const gridSize = 30; for (let i = 1; i < (width / gridSize); i++) gridCanvas.add(new fabric.Line([i * gridSize, 0, i * gridSize, height], { stroke: 'rgba(255,255,255,0.4)', selectable: false })); for (let i = 1; i < (height / gridSize); i++) gridCanvas.add(new fabric.Line([0, i * gridSize, width, i * gridSize], { stroke: 'rgba(255,255,255,0.4)', selectable: false })); gridCanvas.renderAll(); }
        function toggleGrid() { isGridVisible = !isGridVisible; const gridEl = document.getElementById('grid-canvas'); const gridBtn = document.getElementById('grid-btn'); if (isGridVisible && img) { gridEl.classList.remove('hidden'); gridBtn.classList.add('mode-active'); drawGrid(canvas.getWidth(), canvas.getHeight()); } else { gridEl.classList.add('hidden'); gridBtn.classList.remove('mode-active'); } }
        
        function toggleTextOptions() { const textOptions = document.getElementById('text-options'); if(textOptions.classList.contains('hidden')){ handleAddText(); } textOptions.classList.toggle('hidden'); document.getElementById('shape-options').classList.add('hidden'); }
        function toggleShapeOptions() { document.getElementById('shape-options').classList.toggle('hidden'); document.getElementById('text-options').classList.add('hidden'); }
        function handleAddText() { if (!img) return; const text = new fabric.IText('點擊輸入文字', { left: canvas.getCenter().left, top: canvas.getCenter().top, fill: getComputedStyle(document.body).getPropertyValue('--text-color'), fontFamily: document.getElementById('font-family').value, fontSize: 40, originX: 'center', originY: 'center', id: Date.now() }); canvas.add(text); canvas.bringToFront(text); canvas.setActiveObject(text); canvas.requestRenderAll(); }
        function updateTextOptions() { const activeObject = canvas.getActiveObject(); if (activeObject && activeObject.isType('i-text')) { activeObject.set({ fontFamily: document.getElementById('font-family').value, fontSize: parseInt(document.getElementById('font-size').value, 10), fill: document.getElementById('font-color').value }); canvas.renderAll(); renderLayerPanel(); } }
        function handleAddShape(shapeType) { if (!img) return; const center = canvas.getCenter(); const options = { left: center.left, top: center.top, originX: 'center', originY: 'center', fill: 'transparent', stroke: document.getElementById('shape-stroke-color').value, strokeWidth: parseInt(document.getElementById('shape-stroke-width').value, 10), id: Date.now() }; let shape; switch(shapeType) { case 'line': shape = new fabric.Line([0,0,100,0], {left: center.left, top: center.top, ...options}); shape.set({ left: shape.left - shape.width / 2 }); break; case 'rect': shape = new fabric.Rect({ width: 100, height: 100, ...options }); break; case 'circle': shape = new fabric.Circle({ radius: 50, ...options }); break; case 'rounded-rect': shape = new fabric.Rect({ width: 100, height: 100, rx: 10, ry: 10, ...options }); break; case 'diamond': shape = new fabric.Polygon([{x: -50, y: 0}, {x: 0, y: -50}, {x: 50, y: 0}, {x: 0, y: 50}], { ...options, objectCaching: false }); break; case 'arrow': const arrowPath = 'M 0 7.5 L 80 7.5 L 80 0 L 100 15 L 80 30 L 80 22.5 L 0 22.5 Z'; shape = new fabric.Path(arrowPath, { ...options, fill: options.stroke, strokeWidth: 0, }); shape.scaleToWidth(150); break; } if (shape) { canvas.add(shape); canvas.bringToFront(shape); canvas.setActiveObject(shape); } }
        function toggleFreeDraw() { canvas.isDrawingMode = !canvas.isDrawingMode; document.getElementById('free-draw-btn').classList.toggle('mode-active', canvas.isDrawingMode); if (canvas.isDrawingMode) { canvas.freeDrawingBrush.color = document.getElementById('shape-stroke-color').value; canvas.freeDrawingBrush.width = parseInt(document.getElementById('shape-stroke-width').value, 10); } }
        function updateShapeOptions() { const strokeWidth = parseInt(document.getElementById('shape-stroke-width').value, 10); const strokeColor = document.getElementById('shape-stroke-color').value; if (canvas.isDrawingMode) { canvas.freeDrawingBrush.width = strokeWidth; canvas.freeDrawingBrush.color = strokeColor; } const activeObject = canvas.getActiveObject(); if (activeObject && !activeObject.isType('i-text')) { if (activeObject.isType('path') || (activeObject.isType('group') && activeObject.getObjects('path').length > 0)) { activeObject.set({ fill: strokeColor }); } else { activeObject.set({ stroke: strokeColor, strokeWidth: strokeWidth }); } canvas.renderAll(); renderLayerPanel(); } }

        function toggleColorPicker() { isColorPicking = !isColorPicking; const btn = document.getElementById('color-picker-btn'); const display = document.getElementById('color-picker-display'); btn.classList.toggle('mode-active', isColorPicking); display.classList.toggle('hidden', !isColorPicking); if (isColorPicking) { canvas.selection = false; canvas.defaultCursor = 'crosshair'; canvas.hoverCursor = 'crosshair'; } else { canvas.selection = true; canvas.defaultCursor = 'default'; canvas.hoverCursor = 'move'; } canvas.renderAll(); }
        function handleColorPickerMove(o) { if (!isColorPicking) return; const pointer = canvas.getPointer(o.e); const x = Math.round(pointer.x); const y = Math.round(pointer.y); const ctx = canvas.getContext('2d'); if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) return; const pixel = ctx.getImageData(x, y, 1, 1).data; const r = pixel[0], g = pixel[1], b = pixel[2]; document.getElementById('rgb-value').textContent = `${r}, ${g}, ${b}`; function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); } document.getElementById('hex-value').textContent = rgbToHex(r, g, b); }
        
        function handleCopy() { const activeObject = canvas.getActiveObject(); if (!activeObject) return; activeObject.clone(cloned => { clipboard = cloned; document.getElementById('paste-btn').disabled = false; }); }
        function handleCut() { const activeObject = canvas.getActiveObject(); if (!activeObject) return; activeObject.clone(cloned => { clipboard = cloned; document.getElementById('paste-btn').disabled = false; }); handleDeleteObject(); }
        function handlePaste() { if (!clipboard) return; clipboard.clone(clonedObj => { canvas.discardActiveObject(); clonedObj.set({ left: clipboard.left + 10, top: clipboard.top + 10, evented: true, id: Date.now() }); if (clonedObj.type === 'activeSelection') { clonedObj.canvas = canvas; clonedObj.forEachObject(obj => { obj.set({id: Date.now() + Math.random()}); canvas.add(obj); }); clonedObj.setCoords(); } else { canvas.add(clonedObj); } clipboard.left += 10; clipboard.top += 10; canvas.setActiveObject(clonedObj); canvas.requestRenderAll(); }); }
        function handleDeleteObject() { canvas.getActiveObjects().forEach(obj => canvas.remove(obj)); canvas.discardActiveObject().renderAll(); }
        function groupObjects() { const activeObj = canvas.getActiveObject(); if (!activeObj || activeObj.type !== 'activeSelection') return; activeObj.toGroup(); canvas.requestRenderAll(); }
        function ungroupObjects() { const activeObj = canvas.getActiveObject(); if (!activeObj || activeObj.type !== 'group') return; activeObj.toActiveSelection(); canvas.requestRenderAll(); }
        function handleObjectRotation(e) { const activeObject = canvas.getActiveObject(); if (activeObject) { const angle = parseInt(e.target.value, 10); activeObject.set('angle', angle).setCoords(); canvas.renderAll(); document.getElementById('object-rotate-value').innerText = `${angle}°`; } }

        function handleKeyDown(e) { const activeObject = canvas.getActiveObject(); if (!activeObject || activeObject.isEditing) return; const step = e.shiftKey ? 10 : 1; let moved = false; switch (e.key) { case 'ArrowUp': activeObject.top -= step; moved = true; break; case 'ArrowDown': activeObject.top += step; moved = true; break; case 'ArrowLeft': activeObject.left -= step; moved = true; break; case 'ArrowRight': activeObject.left += step; moved = true; break; } if (moved) { e.preventDefault(); activeObject.setCoords(); canvas.renderAll(); debouncedSaveState(); return; } if (e.ctrlKey || e.metaKey) { if (['c', 'x', 'v', 'z'].includes(e.key.toLowerCase())) e.preventDefault(); switch(e.key.toLowerCase()) { case 'c': handleCopy(); break; case 'x': handleCut(); break; case 'v': handlePaste(); break; case 'z': undo(); break; } } else if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); handleDeleteObject(); } }
        
        function resetImageState() { if (img) { img.filters = []; img.applyFilters(); img.set({ flipX: false, flipY: false }); } ['brightness', 'contrast', 'saturation', 'hue', 'temperature'].forEach(id => document.getElementById(`${id}-slider`).value = 0); const panel = document.getElementById('effects-adjustment-panel'); panel.classList.add('hidden'); ['blur', 'pixelate', 'vignette', 'noise'].forEach(id => document.getElementById(`${id}-control`).classList.add('hidden')); canvas.renderAll(); }
        function handleReset(addToHistory = true) { if (originalImageSrc) { resetImageState(); fitImageToCanvas(); if (addToHistory) saveState(); } }
        function handleDownload() { const format = document.getElementById('download-format').value; const link = document.createElement('a'); if (format === 'pdf') { const { jsPDF } = window.jspdf; const imgData = canvas.toDataURL({format: 'jpeg', quality: 1.0}); const pdf = new jsPDF({ orientation: canvas.width > canvas.height ? 'landscape' : 'portrait', unit: 'px', format: [canvas.width, canvas.height] }); pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height); pdf.save('edited-photo.pdf'); } else if (format === 'svg') { const svgData = canvas.toSVG(); const blob = new Blob([svgData], { type: 'image/svg+xml' }); link.href = URL.createObjectURL(blob); link.download = `edited-photo.svg`; link.click(); URL.revokeObjectURL(link.href); } else { link.href = canvas.toDataURL({ format: format, quality: 1.0 }); link.download = `edited-photo.${format}`; link.click(); } }
        
        function updateObjectActionButtons(e) {
            const activeObject = canvas.getActiveObject();
            const hasActive = !!activeObject;
            const isMulti = hasActive && activeObject.type === 'activeSelection' && activeObject.size() > 1;
            const isGroup = hasActive && activeObject.type === 'group';
            const objectOptions = document.getElementById('object-options');
            if(hasActive && !isMulti && !isGroup){
                objectOptions.classList.remove('hidden');
                const angle = activeObject.angle || 0;
                document.getElementById('object-rotate-slider').value = angle;
                document.getElementById('object-rotate-value').innerText = `${Math.round(angle)}°`;
            } else {
                objectOptions.classList.add('hidden');
            }
            document.getElementById('cut-btn').disabled = !hasActive;
            document.getElementById('copy-btn').disabled = !hasActive;
            document.getElementById('delete-btn').disabled = !hasActive;
            document.getElementById('group-btn').disabled = !isMulti;
            document.getElementById('ungroup-btn').disabled = !isGroup;
            const alignOptions = document.getElementById('align-options');
            alignOptions.classList.toggle('hidden', !isMulti);
        }

        function handleAlign(alignType) {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || activeObj.type !== 'activeSelection' || activeObj.size() < 2) return;
            const items = activeObj.getObjects(); const selectionBox = activeObj.getBoundingRect(); const originalPosition = { left: activeObj.left, top: activeObj.top };
            items.forEach(obj => {
                const objBox = obj.getBoundingRect(); let deltaX = 0, deltaY = 0;
                switch(alignType) {
                    case 'left': deltaX = selectionBox.left - objBox.left; break;
                    case 'right': deltaX = (selectionBox.left + selectionBox.width) - (objBox.left + objBox.width); break;
                    case 'h-center': deltaX = (selectionBox.left + selectionBox.width / 2) - (objBox.left + objBox.width / 2); break;
                    case 'top': deltaY = selectionBox.top - objBox.top; break;
                    case 'bottom': deltaY = (selectionBox.top + selectionBox.height) - (objBox.top + objBox.height); break;
                    case 'v-center': deltaY = (selectionBox.top + selectionBox.height / 2) - (objBox.top + objBox.height / 2); break;
                }
                obj.set({ left: obj.left + deltaX, top: obj.top + deltaY });
            });
            canvas.discardActiveObject(); const sel = new fabric.ActiveSelection(items, { canvas: canvas }); sel.set({ left: originalPosition.left, top: originalPosition.top });
            sel.setCoords(); canvas.setActiveObject(sel).renderAll(); debouncedSaveState();
        }
        
        function setupLayerPanel() {
            const layerList = document.getElementById('layer-list');
            layerList.addEventListener('click', (e) => {
                const target = e.target.closest('[data-id]');
                if (!target) return;
                const id = target.dataset.id;
                const obj = canvas.getObjects().find(o => o.id == id);
                if (!obj) return;
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (action === 'select') canvas.setActiveObject(obj);
                else if (action === 'toggle-visibility') obj.set('visible', !obj.visible);
                else if (action === 'toggle-lock') { const isLocked = !obj.lockMovementX; obj.set({ lockMovementX: isLocked, lockMovementY: isLocked, lockScalingX: isLocked, lockScalingY: isLocked, lockRotation: isLocked, }); }
                else if (action === 'move-up') canvas.bringForward(obj);
                else if (action === 'move-down') canvas.sendBackwards(obj);
                canvas.renderAll(); renderLayerPanel(); 
            });
        }
        
        function renderLayerPanel() {
            const layerList = document.getElementById('layer-list');
            const objects = canvas.getObjects().filter(obj => obj.name !== 'background').reverse();
            const activeObjects = canvas.getActiveObjects();
            if (objects.length === 0) { layerList.innerHTML = `<div class="p-2 text-muted text-center">沒有物件</div>`; return; }
            layerList.innerHTML = objects.map((obj, index) => {
                let name = '物件', icon = 'fa-shapes';
                if (obj.isType('i-text')) { name = obj.text.substring(0, 10) || '文字'; icon = 'fa-font'; }
                else if (obj.isType('image')) { name = '圖片'; icon = 'fa-image'; }
                else if (obj.isType('group')) { name = `群組 (${obj.size()})`; icon = 'fa-object-group'; }
                const isActive = activeObjects.includes(obj); const isLocked = obj.lockMovementX; const totalObjects = objects.length;
                return `<div class="layer-item flex items-center justify-between px-2 py-1 cursor-pointer border-b dark:border-gray-600 ${isActive ? 'active' : ''}" data-id="${obj.id}" data-action="select">
                        <div class="flex items-center gap-2 overflow-hidden"><i class="fas ${icon} text-muted w-4 text-center"></i><span class="truncate">${name}</span></div>
                        <div class="layer-controls flex items-center gap-2 text-muted"><button data-action="move-up" title="上移一層" ${index === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i></button><button data-action="move-down" title="下移一層" ${index === totalObjects - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i></button><button data-action="toggle-lock" title="鎖定/解鎖">${isLocked ? '<i class="fas fa-lock text-blue-500"></i>' : '<i class="fas fa-lock-open"></i>'}</button><button data-action="toggle-visibility" title="顯示/隱藏">${obj.visible ? '<i class="fas fa-eye text-green-500"></i>' : '<i class="fas fa-eye-slash text-red-500"></i>'}</button></div>
                    </div>`;
            }).join('');
        }
        
        function handleSystemPaste(e) { /* ... stub ... */ }

        // Collapsed functions for brevity
        enterFsViewer = function() { if (!img) return; const overlay = document.getElementById('fullscreen-overlay'); const fsImage = document.getElementById('fullscreen-image'); const zoomInBtn = document.getElementById('zoom-in-fs'); const zoomOutBtn = document.getElementById('zoom-out-fs'); let scale = 1, isPanning = false, start = { x: 0, y: 0 }, translate = { x: 0, y: 0 }; fsImage.src = canvas.toDataURL({ format: 'png', quality: 1.0 }); overlay.classList.remove('hidden'); overlay.classList.add('flex'); const updateTransform = () => { fsImage.style.transform = `translate(${translate.x}px, ${translate.y}px) scale(${scale})`; }; const handleMouseDown = e => { e.preventDefault(); isPanning = true; start = { x: e.clientX - translate.x, y: e.clientY - translate.y }; fsImage.classList.add('grabbing'); }; const handleMouseMove = e => { if (!isPanning) return; e.preventDefault(); translate.x = e.clientX - start.x; translate.y = e.clientY - start.y; updateTransform(); }; const handleMouseUp = () => { isPanning = false; fsImage.classList.remove('grabbing'); }; const handleWheel = (e) => { e.preventDefault(); scale += e.deltaY * -0.001; scale = Math.min(Math.max(.125, scale), 8); updateTransform(); }; const exitFs = () => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); fsImage.removeEventListener('mousedown', handleMouseDown); window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); overlay.removeEventListener('wheel', handleWheel); overlay.removeEventListener('click', exitFsOnClick); document.removeEventListener('keydown', exitFsOnEsc); }; const exitFsOnClick = (e) => { if (e.target === overlay) exitFs(); }; const exitFsOnEsc = (e) => { if (e.key === "Escape") exitFs(); }; zoomInBtn.onclick = () => { scale = Math.min(8, scale * 1.2); updateTransform(); }; zoomOutBtn.onclick = () => { scale = Math.max(0.125, scale / 1.2); updateTransform(); }; fsImage.addEventListener('mousedown', handleMouseDown); window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); overlay.addEventListener('wheel', handleWheel); overlay.addEventListener('click', exitFsOnClick); document.addEventListener('keydown', exitFsOnEsc); updateTransform(); }
        
        // [FIXED] Reworked crop function to handle async operations correctly
        handleCrop = function() {
            const cropButton = document.getElementById('crop-btn');
            
            const exitCropMode = () => {
                canvas.defaultCursor = 'default';
                canvas.selection = true;
                if (cropRect) {
                    canvas.remove(cropRect);
                    cropRect = null;
                }
                isCropping = false;
                isDrawingCropRect = false;
                cropButton.classList.remove('mode-active');
                cropButton.innerHTML = '<i class="fas fa-crop-simple text-xs mr-1"></i> 剪裁';
                canvas.off('mouse:down', startCropSelection);
                canvas.off('mouse:move', moveCropSelection);
                canvas.off('mouse:up', endCropSelection);
            };

            if (isCropping) { // If we are in crop mode...
                // And a valid crop rectangle exists, we are confirming the crop
                if (cropRect && cropRect.width > 0 && cropRect.height > 0) {
                    // [FIXED] Correctly remove the cropRect before generating the new image
                    cropRect.set({ visible: false }); // Hide it immediately

                    const dataURL = canvas.toDataURL({
                        left: cropRect.left,
                        top: cropRect.top,
                        width: cropRect.getScaledWidth(),
                        height: cropRect.getScaledHeight()
                    });
                    
                    // Now, fully clear the canvas to ensure nothing is left over
                    canvas.clear();

                    fabric.Image.fromURL(dataURL, (newImg) => {
                        history = [];
                        historyIndex = -1;
                        img = newImg;
                        originalImageSrc = dataURL;
                        img.set({ selectable: false, evented: false, name: 'background' });
                        canvas.add(img);
                        fitImageToCanvas();
                        saveState();
                        exitCropMode(); // Exit crop mode AFTER the new image is loaded and canvas is clean
                    });
                } else {
                    // In crop mode but no valid rectangle drawn, just exit without cropping.
                    exitCropMode();
                }
            } else { // If not in crop mode, then enter it
                isCropping = true;
                cropButton.classList.add('mode-active');
                cropButton.innerHTML = '<i class="fas fa-check text-xs mr-1"></i> 確認剪裁';
                canvas.selection = false;
                canvas.defaultCursor = 'crosshair';
                canvas.on('mouse:down', startCropSelection);
                canvas.on('mouse:move', moveCropSelection);
                canvas.on('mouse:up', endCropSelection);
            }
        }

        // [MODIFIED] Crop rectangle style
        const startCropSelection = (o) => { if (!isCropping) return; isDrawingCropRect = true; const pointer = canvas.getPointer(o.e); cropOrigin.x = pointer.x; cropOrigin.y = pointer.y; if(cropRect) canvas.remove(cropRect); cropRect = new fabric.Rect({ left: cropOrigin.x, top: cropOrigin.y, width: 0, height: 0, fill: 'transparent', stroke: '#0d6efd', strokeDashArray: [5, 5], strokeWidth: 2, selectable: false }); canvas.add(cropRect); }; const moveCropSelection = (o) => { if (!isDrawingCropRect) return; const pointer = canvas.getPointer(o.e); let left = cropOrigin.x, top = cropOrigin.y, width = pointer.x - cropOrigin.x, height = pointer.y - cropOrigin.y; if (width < 0) { left = pointer.x; width = Math.abs(width); } if (height < 0) { top = pointer.y; height = Math.abs(height); } cropRect.set({ left, top, width, height }); canvas.renderAll(); }; const endCropSelection = (o) => { isDrawingCropRect = false; if (cropRect) { if (cropRect.width < 10 || cropRect.height < 10) { canvas.remove(cropRect); cropRect = null; } else { cropRect.set({ selectable: true }); canvas.setActiveObject(cropRect); } } canvas.renderAll(); };
    </script>
</body>
</html>
