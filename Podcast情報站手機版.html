<!DOCTYPE html>
<html lang="zh-Hant" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast導航站</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- 引入 SortableJS 以實現拖曳排序 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        // 用於初始化 TailwindCSS 的明暗模式設定
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* --- macOS 風格化樣式 --- */
        :root {
            --system-blue: #007aff;
            --system-yellow: #ffcc00;
            --system-background-light: #f5f5f7;
            --system-background-dark: #1c1c1e;
            --glass-panel-bg-light: rgba(255, 255, 255, 0.75);
            --glass-panel-bg-dark: rgba(28, 28, 30, 0.75);
            --text-primary-light: #1d1d1f;
            --text-primary-dark: #f5f5f7;
            --text-secondary-light: #6b7280;
            --text-secondary-dark: #8e8e93;
            --border-light: rgba(0, 0, 0, 0.1);
            --border-dark: rgba(255, 255, 255, 0.15);
            --traffic-light-red: #ff5f56;
            --traffic-light-yellow: #ffbd2e;
            --traffic-light-green: #27c93f;
        }

        /* Light Mode (Default) */
        body {
            background-color: var(--system-background-light);
            color: var(--text-primary-light);
        }
        .glass-panel {
            background-color: var(--glass-panel-bg-light);
            border-color: var(--border-light);
        }
        .category-header { color: #8a8a8e; border-bottom-color: var(--border-light); background: var(--glass-panel-bg-light); }
        .tab-btn { color: var(--text-secondary-light); }
        .selected-item { background-color: rgba(0, 122, 255, 0.2) !important; }
        .episode-item.playing { background-color: rgba(0, 122, 255, 0.15); }
        .episode-title, .podcast-title, .text-black { color: var(--text-primary-light); }
        .text-gray-500 { color: var(--text-secondary-light); }
        #player-progress-bar { background: rgba(0,0,0,0.15); }
        .border-gray-200\/80 { border-color: var(--border-light); }
        .border-gray-200\/60 { border-color: var(--border-light); }
        .text-gray-700 { color: var(--text-primary-light); }

        /* Dark Mode */
        html.dark body {
            background-color: var(--system-background-dark);
            color: var(--text-primary-dark);
        }
        html.dark .glass-panel {
            background-color: var(--glass-panel-bg-dark);
            border-color: var(--border-dark);
        }
        html.dark .category-header { color: var(--text-secondary-dark); border-bottom-color: var(--border-dark); background: var(--glass-panel-bg-dark); }
        html.dark .tab-btn { color: var(--text-secondary-dark); }
        html.dark .selected-item { background-color: rgba(10, 132, 255, 0.3) !important; }
        html.dark .episode-item.playing { background-color: rgba(10, 132, 255, 0.25); }
        html.dark .episode-title, html.dark .podcast-title, html.dark .text-black { color: var(--text-primary-dark); }
        html.dark .text-gray-500 { color: var(--text-secondary-dark); }
        html.dark #player-progress-bar { background: rgba(255,255,255,0.15); }
        html.dark .hover\:bg-gray-200\/80:hover { background-color: rgba(255, 255, 255, 0.1); }
        html.dark ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.25); }
        html.dark ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
        html.dark .border-gray-200\/80 { border-color: var(--border-dark); }
        html.dark .border-gray-200\/60 { border-color: var(--border-dark); }
        html.dark .text-gray-700 { color: var(--text-primary-dark); }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "Arial", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::selection { background-color: var(--system-blue); color: white; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        .glass-panel {
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .main-container { display: grid; gap: 1rem; grid-template-columns: 1fr; }
        
        @media (min-width: 1024px) {
            .main-container { grid-template-columns: 380px 1fr; gap: 1.5rem; }
        }

        .favorite-btn.favorited svg { fill: var(--system-yellow); stroke: var(--system-yellow); }
        
        #tooltip { transition: opacity 0.2s; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }

        .sortable-ghost { opacity: 0.4; background: rgba(0, 122, 255, 0.2); }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        .category-header {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            padding: 12px 8px 4px; border-bottom: 1px solid;
            position: sticky; top: -16px; /* Match panel padding */
            z-index: 10;
        }
        
        #audio-player-container.is-hidden { display: none; }
        @media (min-width: 1024px) {
            #audio-player-container.is-hidden { display: block; transform: translateY(100%); }
        }
        
        .episode-item.playing .episode-title { font-weight: 600; color: var(--system-blue); }
        .episode-item .play-btn { display: block; }
        .episode-item .sound-wave-container { display: none; }
        .episode-item.playing .play-btn { display: none; }
        .episode-item.playing .sound-wave-container { display: flex; }

        @keyframes sound-wave-pulse { 0% { transform: scaleY(0.3); } 30% { transform: scaleY(1); } 60% { transform: scaleY(0.5); } 100% { transform: scaleY(0.3); } }
        .sound-wave { transform-origin: 50% 100%; animation: sound-wave-pulse 1.2s ease-in-out infinite; fill: var(--system-blue); }
        .sound-wave-1 { animation-delay: 0s; } .sound-wave-2 { animation-delay: 0.2s; } .sound-wave-3 { animation-delay: 0.4s; }

        .episode-progress-bar-container { position: absolute; bottom: 2px; left: 8px; right: 8px; height: 3px; background-color: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .episode-progress-bar { height: 100%; background-color: var(--system-blue); width: 0%; transition: width 0.2s linear; }
        
        #player-progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 5px; border-radius: 5px; outline: none; cursor: pointer; }
        #player-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; }
        #player-progress-bar::-moz-range-thumb { width: 14px; height: 14px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; border: none; }

        .spinner { width: 32px; height: 32px; border: 4px solid; border-top-color: var(--system-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        html.light .spinner { border-color: rgba(0,0,0,0.1); border-top-color: var(--system-blue); }
        html.dark .spinner { border-color: rgba(255,255,255,0.1); border-top-color: var(--system-blue); }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 lg:h-screen lg:flex lg:flex-col">
    <div id="tooltip" class="hidden fixed z-50 p-3 rounded-lg bg-black/80 text-white text-sm shadow-lg max-w-sm pointer-events-none">
        <h5 id="tooltip-title" class="font-bold mb-1 line-clamp-2"></h5>
        <p id="tooltip-description" class="text-xs opacity-80 max-h-24 overflow-hidden text-ellipsis"></p>
    </div>

    <div class="container mx-auto p-4 max-w-7xl flex-grow flex flex-col relative">
        <button id="theme-toggle-btn" class="absolute top-6 right-6 z-20 p-2 rounded-full bg-gray-200/80 dark:bg-gray-700/80">
            <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
        </button>

        <header class="glass-panel p-4 mb-4 flex-shrink-0">
            <div class="flex items-center mb-4">
                <div class="flex space-x-2 mr-4">
                    <span class="block w-3 h-3 rounded-full" style="background-color: var(--traffic-light-red);"></span>
                    <span class="block w-3 h-3 rounded-full" style="background-color: var(--traffic-light-yellow);"></span>
                    <span class="block w-3 h-3 rounded-full" style="background-color: var(--traffic-light-green);"></span>
                </div>
                <div class="flex-grow text-center">
                    <h1 class="text-xl font-bold text-black podcast-title">Podcast 導航站</h1>
                    <p class="text-xs text-gray-500 mt-1">製作者：陳政德</p>
                </div>
                <div class="w-14"></div> <!-- Placeholder to balance the theme toggle button -->
            </div>
            <form id="search-form" class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="search-input" placeholder="例如：百靈果、科技島讀..." class="w-full px-4 py-1.5 bg-gray-200/80 dark:bg-gray-800/80 border border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--system-blue)] transition duration-300" required>
                <button type="submit" class="bg-[var(--system-blue)] text-white px-5 py-1.5 rounded-lg font-semibold hover:opacity-90 transition duration-300 flex flex-row items-center justify-center gap-2 whitespace-nowrap">
                    <i data-lucide="search" class="w-5 h-5"></i>
                    <span>搜尋</span>
                </button>
            </form>
        </header>
        
        <div id="loader" class="text-center p-10 hidden">
             <div class="glass-panel inline-block p-8">
                <div role="status" class="flex justify-center items-center flex-col">
                     <div class="spinner"></div>
                    <p class="mt-4 text-gray-500">正在努力搜尋中...</p>
                </div>
            </div>
        </div>

        <main id="main-content" class="main-container flex-grow min-h-0">
            <div id="podcast-results" class="glass-panel p-4 overflow-y-auto">
                <div class="flex border-b border-gray-200/80 mb-2">
                    <button id="tab-search-results" class="tab-btn px-4 py-2 font-semibold text-sm border-b-2">搜尋結果</button>
                    <button id="tab-favorites" class="tab-btn px-4 py-2 font-semibold text-sm border-b-2">我的最愛</button>
                </div>
                <div id="podcast-list-container">
                    <div id="podcast-list" class="space-y-0.5">
                        <p class="text-gray-500 text-center pt-8">請先搜尋您感興趣的 Podcast。</p>
                    </div>
                </div>
                <div id="favorite-podcast-list-container" class="hidden">
                    <div id="favorite-podcast-list"></div>
                </div>
            </div>

            <div id="episodes-container" class="glass-panel p-4 overflow-y-auto hidden lg:flex lg:flex-col">
                <button id="back-to-results-btn" class="lg:hidden flex items-center gap-2 mb-3 text-sm font-semibold text-[var(--system-blue)]"><i data-lucide="arrow-left" class="w-4 h-4"></i>返回搜尋結果</button>
                <div id="podcast-detail-header" class="mb-2 hidden items-center gap-3 flex-shrink-0">
                    <img id="detail-artwork" src="" alt="Podcast Artwork" class="w-10 h-10 rounded-lg shadow-md flex-shrink-0">
                    <div class="text-left overflow-hidden">
                        <div class="flex items-center gap-2">
                            <h2 id="detail-title" class="text-base font-bold text-black podcast-title truncate"></h2>
                            <button id="favorite-podcast-btn" class="favorite-btn text-gray-400 hover:text-[var(--system-yellow)] transition-colors flex-shrink-0" title="收藏此 Podcast">
                                <i data-lucide="star" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p id="detail-artist" class="text-xs text-gray-500 truncate"></p>
                    </div>
                </div>
                <h3 class="text-base font-bold mb-2 border-b border-gray-200/80 pb-2 text-black flex-shrink-0">單集列表</h3>
                <div id="episode-list" class="space-y-0 overflow-y-auto">
                    <p class="text-gray-500 text-center pt-8">請先從左側選擇一個 Podcast 以顯示單集列表。</p>
                </div>
            </div>
        </main>
        
        <footer id="audio-player-container" class="is-hidden relative lg:sticky lg:bottom-0 lg:left-0 lg:right-0 glass-panel p-3 lg:p-4 lg:transition-transform lg:duration-500 flex-shrink-0 mt-4 lg:mt-0">
            <audio id="audio-player" class="hidden"></audio>
            <div class="flex items-center gap-3">
                <img id="player-artwork" src="https://placehold.co/48x48/f5f5f7/333?text=?" alt="Now Playing Artwork" class="w-12 h-12 rounded-md flex-shrink-0">
                <div class="flex-grow min-w-0">
                    <p class="font-semibold text-black podcast-title truncate text-sm" id="now-playing-title">未選擇音訊</p>
                    <p class="text-xs text-gray-500 truncate" id="now-playing-artist"></p>
                    <div class="flex items-center gap-2 mt-1.5">
                        <span id="current-time" class="text-xs text-gray-500 font-mono">0:00</span>
                        <input type="range" id="player-progress-bar" min="0" max="100" value="0" class="w-full">
                        <span id="duration" class="text-xs text-gray-500 font-mono">0:00</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-around items-center mt-2">
                <button id="playback-rate-btn" title="播放速度" class="p-2 text-gray-500 hover:text-black w-12 text-center font-mono text-xs font-bold">1.0x</button>
                <button id="rewind-btn" title="倒退 15 秒" class="p-2 text-gray-500 hover:text-black"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                <button id="prev-episode-btn" title="上一集" class="p-2 text-gray-500 hover:text-black disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="skip-back" class="w-6 h-6"></i></button>
                <button id="play-pause-btn" title="播放/暫停" class="p-2 bg-[var(--system-blue)] text-white rounded-full w-12 h-12 flex items-center justify-center mx-2 shadow-lg"><i data-lucide="play" class="w-7 h-7"></i></button>
                <button id="next-episode-btn" title="下一集" class="p-2 text-gray-500 hover:text-black disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="skip-forward" class="w-6 h-6"></i></button>
                <button id="fast-forward-btn" title="快進 15 秒" class="p-2 text-gray-500 hover:text-black"><i data-lucide="rotate-cw" class="w-5 h-5"></i></button>
                <button id="placeholder-btn" class="p-2 w-12"></button> <!-- Placeholder for symmetry -->
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allDOMElements = {
                // ... (原有元素)
                searchForm: document.getElementById('search-form'),
                searchInput: document.getElementById('search-input'),
                loader: document.getElementById('loader'),
                mainContent: document.getElementById('main-content'),
                podcastResults: document.getElementById('podcast-results'),
                episodesContainer: document.getElementById('episodes-container'),
                podcastListContainer: document.getElementById('podcast-list-container'),
                favoritePodcastListContainer: document.getElementById('favorite-podcast-list-container'),
                podcastList: document.getElementById('podcast-list'),
                favoritePodcastList: document.getElementById('favorite-podcast-list'),
                episodeList: document.getElementById('episode-list'),
                audioPlayerContainer: document.getElementById('audio-player-container'),
                audioPlayer: document.getElementById('audio-player'),
                nowPlayingTitle: document.getElementById('now-playing-title'),
                podcastDetailHeader: document.getElementById('podcast-detail-header'),
                detailArtwork: document.getElementById('detail-artwork'),
                detailTitle: document.getElementById('detail-title'),
                detailArtist: document.getElementById('detail-artist'),
                backToResultsBtn: document.getElementById('back-to-results-btn'),
                tabSearchResults: document.getElementById('tab-search-results'),
                tabFavorites: document.getElementById('tab-favorites'),
                favoritePodcastBtn: document.getElementById('favorite-podcast-btn'),
                tooltip: document.getElementById('tooltip'),
                tooltipTitle: document.getElementById('tooltip-title'),
                tooltipDescription: document.getElementById('tooltip-description'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                
                // -- 新增的播放器元素 --
                playerArtwork: document.getElementById('player-artwork'),
                nowPlayingArtist: document.getElementById('now-playing-artist'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                prevEpisodeBtn: document.getElementById('prev-episode-btn'),
                nextEpisodeBtn: document.getElementById('next-episode-btn'),
                rewindBtn: document.getElementById('rewind-btn'),
                fastForwardBtn: document.getElementById('fast-forward-btn'),
                playbackRateBtn: document.getElementById('playback-rate-btn'),
                playerProgressBar: document.getElementById('player-progress-bar'),
                currentTime: document.getElementById('current-time'),
                duration: document.getElementById('duration'),
            };
            const { searchForm, searchInput, loader, mainContent, podcastResults, episodesContainer, podcastListContainer, favoritePodcastListContainer, podcastList, favoritePodcastList, episodeList, audioPlayerContainer, audioPlayer, nowPlayingTitle, podcastDetailHeader, detailArtwork, detailTitle, detailArtist, backToResultsBtn, tabSearchResults, tabFavorites, favoritePodcastBtn, tooltip, tooltipTitle, tooltipDescription, themeToggleBtn, playerArtwork, nowPlayingArtist, playPauseBtn, prevEpisodeBtn, nextEpisodeBtn, rewindBtn, fastForwardBtn, playbackRateBtn, playerProgressBar, currentTime, duration } = allDOMElements;

            const CORS_PROXY = 'https://corsproxy.io/?';

            let favoritePodcasts = [], currentPodcast = null, currentEpisodeList = [], currentEpisodeIndex = -1, sortableInstance = null;
            const playbackRates = [1.0, 1.2, 1.5, 2.0, 0.8];
            let currentRateIndex = 0;

            const sanitizeHTML = (str) => { const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; };
            const cleanDescription = (desc) => desc.replace(/<[^>]+>/g, '').replace(/(\r\n|\n|\r)/gm, " ").trim();
            const formatTime = (s) => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}`;

            const getPlaybackProgress = () => JSON.parse(localStorage.getItem('playbackProgress')) || '{}';
            const savePlaybackProgress = (episodeId, time, duration) => {
                if (!episodeId || !duration) return;
                const progressData = getPlaybackProgress();
                progressData[episodeId] = { currentTime: time, duration: duration };
                localStorage.setItem('playbackProgress', JSON.stringify(progressData));
            };

            const loadFavorites = () => { favoritePodcasts = JSON.parse(localStorage.getItem('favoritePodcasts')) || []; displayFavoritePodcasts(); };
            const saveFavorites = () => { localStorage.setItem('favoritePodcasts', JSON.stringify(favoritePodcasts)); displayFavoritePodcasts(); updateFavoriteButtonState(); };
            const isPodcastFavorited = (podcast) => favoritePodcasts.some(p => p.collectionId === podcast.collectionId);
            const toggleFavoritePodcast = () => {
                if (!currentPodcast) return;
                const index = favoritePodcasts.findIndex(p => p.collectionId === currentPodcast.collectionId);
                if (index > -1) { favoritePodcasts.splice(index, 1); } else { favoritePodcasts.push(currentPodcast); }
                saveFavorites();
            };
            const updateFavoriteButtonState = () => {
                if (!currentPodcast) return;
                favoritePodcastBtn.classList.toggle('favorited', isPodcastFavorited(currentPodcast));
            };
            
            const showResultsView = () => { if (window.innerWidth < 1024) { podcastResults.classList.remove('hidden'); episodesContainer.classList.add('hidden'); } };
            const showEpisodesView = () => { if (window.innerWidth < 1024) { podcastResults.classList.add('hidden'); episodesContainer.classList.remove('hidden'); } };
            
            const setActiveTab = (activeTab) => {
                [tabSearchResults, tabFavorites].forEach(tab => { tab.style.borderColor = 'transparent'; tab.style.color = ''; });
                activeTab.style.borderColor = 'var(--system-blue)'; activeTab.style.color = 'var(--system-blue)';
            };
            
            // --- UI 渲染函式 (優化版) ---
            const createPodcastItem = (podcast, isFavorite = false) => {
                const item = document.createElement('div');
                // 優化：減少 padding, gap，使列表更緊湊
                item.className = 'flex items-center gap-2 p-1.5 rounded-lg hover:bg-gray-200/80 dark:hover:bg-gray-700/60 transition duration-200';
                item.dataset.id = podcast.collectionId;
                item.innerHTML = `
                    ${isFavorite ? '<i data-lucide="grip-vertical" class="drag-handle w-5 h-5 text-gray-400"></i>' : ''}
                    <img src="${podcast.artworkUrl60}" alt="${sanitizeHTML(podcast.collectionName)}" class="w-10 h-10 rounded-md object-cover flex-shrink-0">
                    <div class="flex-grow overflow-hidden">
                        <h4 class="font-semibold podcast-title truncate text-sm">${sanitizeHTML(podcast.collectionName)}</h4>
                        <p class="text-xs text-gray-500 truncate">${sanitizeHTML(podcast.artistName)}</p>
                        <p class="text-xs text-gray-500 truncate mt-0.5">${sanitizeHTML(podcast.primaryGenreName)}</p>
                    </div>
                    ${isFavorite ? '<button class="delete-favorite-btn p-1.5 text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>' : ''}
                `;
                item.addEventListener('click', () => {
                    document.querySelectorAll('.selected-item').forEach(el => el.classList.remove('selected-item'));
                    item.classList.add('selected-item');
                    currentPodcast = podcast;
                    detailArtwork.src = podcast.artworkUrl100; detailTitle.textContent = podcast.collectionName; detailArtist.textContent = podcast.artistName;
                    updateFavoriteButtonState(); podcastDetailHeader.classList.remove('hidden'); podcastDetailHeader.classList.add('flex');
                    fetchEpisodes(podcast.feedUrl); showEpisodesView();
                });
                if (isFavorite) {
                    item.querySelector('.delete-favorite-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        favoritePodcasts = favoritePodcasts.filter(p => p.collectionId !== podcast.collectionId);
                        saveFavorites();
                    });
                }
                return item;
            };

            const displayPodcasts = (podcasts) => {
                podcastList.innerHTML = '';
                if (podcasts.length === 0) { podcastList.innerHTML = `<p class="text-gray-500 text-center pt-8">找不到相關的 Podcast。</p>`; return; }
                podcasts.forEach(podcast => podcastList.appendChild(createPodcastItem(podcast)));
                lucide.createIcons();
            };
            
            const displayFavoritePodcasts = () => {
                favoritePodcastList.innerHTML = '';
                if (favoritePodcasts.length === 0) { favoritePodcastList.innerHTML = `<p class="text-gray-500 text-center pt-8">尚無收藏的 Podcast。</p>`; return; }
                const grouped = favoritePodcasts.reduce((acc, podcast) => {
                    const genre = podcast.primaryGenreName || '未分類';
                    if (!acc[genre]) acc[genre] = [];
                    acc[genre].push(podcast);
                    return acc;
                }, {});
                Object.keys(grouped).sort().forEach(genre => {
                    const header = document.createElement('h3');
                    header.className = 'category-header';
                    header.textContent = genre;
                    favoritePodcastList.appendChild(header);
                    const groupContainer = document.createElement('div');
                    groupContainer.dataset.genre = genre;
                    groupContainer.className = 'space-y-0.5';
                    grouped[genre].forEach(podcast => groupContainer.appendChild(createPodcastItem(podcast, true)));
                    favoritePodcastList.appendChild(groupContainer);
                });
                initSortable();
                lucide.createIcons();
            };

            const initSortable = () => {
                if (sortableInstance) sortableInstance.destroy();
                const groups = favoritePodcastList.querySelectorAll('[data-genre]');
                groups.forEach(group => {
                    new Sortable(group, {
                        group: 'favorites', animation: 150, ghostClass: 'sortable-ghost', handle: '.drag-handle',
                        onEnd: (evt) => {
                            const allIdsInOrder = Array.from(favoritePodcastList.querySelectorAll('[data-id]')).map(el => el.dataset.id);
                            favoritePodcasts.sort((a, b) => allIdsInOrder.indexOf(String(a.collectionId)) - allIdsInOrder.indexOf(String(b.collectionId)));
                            localStorage.setItem('favoritePodcasts', JSON.stringify(favoritePodcasts));
                        }
                    });
                });
            };

            async function fetchEpisodes(feedUrl) {
                if (mainContent.parentElement) { mainContent.parentElement.appendChild(audioPlayerContainer); }
                episodeList.innerHTML = `<div class="flex justify-center items-center h-full pt-8"><div class="spinner"></div><p class="ml-3 text-gray-500">正在載入單集...</p></div>`;
                try {
                    const response = await fetch(`${CORS_PROXY}${encodeURIComponent(feedUrl)}`);
                    if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                    const xmlText = await response.text();
                    const xmlDoc = new DOMParser().parseFromString(xmlText, "application/xml");
                    if (xmlDoc.querySelector("parsererror")) throw new Error("無法解析 RSS feed。");
                    
                    const progressData = getPlaybackProgress();
                    currentEpisodeList = Array.from(xmlDoc.querySelectorAll("item")).map((item, index) => {
                        const guid = item.querySelector("guid")?.textContent || item.querySelector("enclosure")?.getAttribute("url") || `ep-${index}`;
                        return { 
                            guid: guid,
                            title: item.querySelector("title")?.textContent || '無標題', 
                            description: cleanDescription(item.querySelector("description")?.textContent || ''), 
                            audioUrl: item.querySelector("enclosure")?.getAttribute("url")
                        }
                    }).filter(item => item.audioUrl);
                    
                    renderEpisodes(currentEpisodeList);
                } catch (error) { console.error('獲取單集列表時發生錯誤:', error); episodeList.innerHTML = `<p class="text-red-500 text-center">無法載入單集列表。</p>`; currentEpisodeList = []; }
                updatePlayerButtons();
            }

            const renderEpisodes = (items) => {
                episodeList.innerHTML = '';
                if (items.length === 0) { episodeList.innerHTML = `<p class="text-gray-500 text-center">這個 Podcast 沒有可用的單集。</p>`; return; }
                const progressData = getPlaybackProgress();
                items.forEach((item, index) => {
                    const episodeItem = document.createElement('div');
                    // 優化：減少 padding, 使文字更小
                    episodeItem.className = 'episode-item relative py-1.5 px-2 border-b border-gray-200/60 last:border-b-0 flex justify-between items-center gap-2 hover:bg-gray-200/80 dark:hover:bg-gray-700/60 rounded-lg';
                    episodeItem.dataset.index = index;
                    
                    const progress = progressData[item.guid];
                    const progressPercent = progress && progress.duration ? (progress.currentTime / progress.duration) * 100 : 0;
                    
                    episodeItem.innerHTML = `
                        <p class="flex-grow text-xs text-gray-700 truncate episode-title">${sanitizeHTML(item.title)}</p>
                        <button class="play-btn p-1.5 rounded-full text-[var(--system-blue)]" title="播放"><i data-lucide="play-circle" class="w-5 h-5"></i></button>
                        <div class="sound-wave-container w-6 h-6 items-center justify-center">
                            <svg viewBox="0 0 24 24" class="w-5 h-5">
                                <rect class="sound-wave sound-wave-1" x="4" y="8" width="3" height="8" rx="1"></rect>
                                <rect class="sound-wave sound-wave-2" x="10" y="5" width="3" height="14" rx="1"></rect>
                                <rect class="sound-wave sound-wave-3" x="16" y="8" width="3" height="8" rx="1"></rect>
                            </svg>
                        </div>
                        <div class="episode-progress-bar-container">
                             <div class="episode-progress-bar" style="width: ${progressPercent}%;"></div>
                        </div>
                    `;
                    episodeItem.querySelector('.play-btn').addEventListener('click', (e) => { e.stopPropagation(); playEpisode(index); });
                    episodeItem.addEventListener('mouseenter', (e) => showTooltip(e, item.title, item.description));
                    episodeItem.addEventListener('mouseleave', hideTooltip);
                    episodeItem.addEventListener('mousemove', updateTooltipPosition);
                    episodeList.appendChild(episodeItem);
                });
                lucide.createIcons();
            };

            const updateCurrentlyPlayingUI = (newIndex) => {
                 document.querySelectorAll('.episode-item.playing').forEach(el => el.classList.remove('playing'));
                 if (newIndex > -1) {
                    const episodeItem = episodeList.querySelector(`.episode-item[data-index="${newIndex}"]`);
                    if (episodeItem) {
                        episodeItem.classList.add('playing');
                        if (window.innerWidth < 1024) {
                            episodeItem.after(audioPlayerContainer);
                        }
                    }
                 }
            };

            const playEpisode = (index) => {
                if (index < 0 || index >= currentEpisodeList.length) return;
                
                updateCurrentlyPlayingUI(index);
                currentEpisodeIndex = index;
                const episode = currentEpisodeList[index];
                
                audioPlayer.src = episode.audioUrl;
                nowPlayingTitle.textContent = episode.title;
                nowPlayingArtist.textContent = currentPodcast.artistName;
                playerArtwork.src = currentPodcast.artworkUrl100;
                
                const progressData = getPlaybackProgress();
                const savedProgress = progressData[episode.guid];
                if (savedProgress && savedProgress.currentTime < savedProgress.duration * 0.98) {
                    audioPlayer.currentTime = savedProgress.currentTime;
                }

                audioPlayer.play().catch(e => console.error("播放失敗:", e));
                
                playPauseBtn.innerHTML = `<i data-lucide="pause" class="w-7 h-7"></i>`;
                lucide.createIcons();
                audioPlayerContainer.classList.remove('is-hidden');
                 if (window.innerWidth >= 1024) {
                    audioPlayerContainer.style.transform = 'translateY(0)';
                }

                updatePlayerButtons();
            };
            
            const togglePlayPause = () => {
                if(audioPlayer.paused) {
                    if (audioPlayer.src) {
                        audioPlayer.play();
                        playPauseBtn.innerHTML = `<i data-lucide="pause" class="w-7 h-7"></i>`;
                    }
                } else {
                    audioPlayer.pause();
                    playPauseBtn.innerHTML = `<i data-lucide="play" class="w-7 h-7"></i>`;
                }
                lucide.createIcons();
            };

            const updatePlayerButtons = () => { prevEpisodeBtn.disabled = currentEpisodeIndex <= 0; nextEpisodeBtn.disabled = currentEpisodeIndex >= currentEpisodeList.length - 1; };
            const playNext = () => playEpisode(currentEpisodeIndex + 1);
            const playPrev = () => playEpisode(currentEpisodeIndex - 1);

            const showTooltip = (event, title, description) => {
                if (window.innerWidth < 1024) return;
                tooltipTitle.textContent = title;
                tooltipDescription.textContent = description || '無描述';
                tooltip.classList.remove('hidden');
                updateTooltipPosition(event);
            };
            const hideTooltip = () => tooltip.classList.add('hidden');
            const updateTooltipPosition = (event) => { tooltip.style.left = `${event.clientX + 15}px`; tooltip.style.top = `${event.clientY + 15}px`; };

            async function searchPodcasts(term) {
                podcastList.innerHTML = ''; episodeList.innerHTML = '<p class="text-gray-500 text-center pt-8">請先選擇 Podcast。</p>';
                podcastDetailHeader.classList.add('hidden'); podcastDetailHeader.classList.remove('flex');
                mainContent.classList.add('hidden'); loader.classList.remove('hidden'); currentPodcast = null;
                try {
                    const response = await fetch(`${CORS_PROXY}${encodeURIComponent(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=podcast&entity=podcast&country=TW&limit=50`)}`);
                    if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                    const data = await response.json();
                    displayPodcasts(data.results);
                } catch (error) { console.error('搜尋 Podcast 時發生錯誤:', error); podcastList.innerHTML = `<p class="text-red-500 text-center">搜尋失敗，請稍後再試。</p>`;
                } finally { loader.classList.add('hidden'); mainContent.classList.remove('hidden'); }
            }

            // --- 事件監聽器 ---
            searchForm.addEventListener('submit', async (e) => { e.preventDefault(); const term = searchInput.value.trim(); if (term) { tabSearchResults.click(); showResultsView(); await searchPodcasts(term); } });
            backToResultsBtn.addEventListener('click', showResultsView);
            favoritePodcastBtn.addEventListener('click', toggleFavoritePodcast);
            
            // Player listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevEpisodeBtn.addEventListener('click', playPrev);
            nextEpisodeBtn.addEventListener('click', playNext);
            rewindBtn.addEventListener('click', () => { audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 15); });
            fastForwardBtn.addEventListener('click', () => { audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 15); });
            playbackRateBtn.addEventListener('click', () => {
                currentRateIndex = (currentRateIndex + 1) % playbackRates.length;
                const newRate = playbackRates[currentRateIndex];
                audioPlayer.playbackRate = newRate;
                playbackRateBtn.textContent = `${newRate.toFixed(1)}x`;
            });
            playerProgressBar.addEventListener('input', (e) => {
                if(!isNaN(audioPlayer.duration)) audioPlayer.currentTime = (e.target.value / 100) * audioPlayer.duration;
            });

            audioPlayer.addEventListener('play', () => {
                playPauseBtn.innerHTML = `<i data-lucide="pause" class="w-7 h-7"></i>`;
                lucide.createIcons();
            });
            audioPlayer.addEventListener('pause', () => {
                playPauseBtn.innerHTML = `<i data-lucide="play" class="w-7 h-7"></i>`;
                lucide.createIcons();
            });

            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('loadedmetadata', () => {
                duration.textContent = formatTime(audioPlayer.duration);
            });
            audioPlayer.addEventListener('timeupdate', () => {
                 if (isNaN(audioPlayer.duration)) return;
                 currentTime.textContent = formatTime(audioPlayer.currentTime);
                 if (document.activeElement !== playerProgressBar) {
                     playerProgressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                 }
                 const episode = currentEpisodeList[currentEpisodeIndex];
                 if (episode) {
                     savePlaybackProgress(episode.guid, audioPlayer.currentTime, audioPlayer.duration);
                     const playingItem = document.querySelector('.episode-item.playing .episode-progress-bar');
                     if(playingItem) {
                         playingItem.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
                     }
                 }
            });

            tabSearchResults.addEventListener('click', () => { setActiveTab(tabSearchResults); podcastListContainer.classList.remove('hidden'); favoritePodcastListContainer.classList.add('hidden'); });
            tabFavorites.addEventListener('click', () => { setActiveTab(tabFavorites); podcastListContainer.classList.add('hidden'); favoritePodcastListContainer.classList.remove('hidden'); displayFavoritePodcasts(); });

            // --- 明暗主題切換 ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                }
                localStorage.setItem('theme', theme);
                lucide.createIcons();
            };

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                applyTheme(currentTheme === 'light' ? 'dark' : 'light');
            });


            // --- 初始化 ---
            const init = () => {
                const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(savedTheme);
                loadFavorites(); 
                tabSearchResults.click(); 
                updatePlayerButtons(); 
            };
            init();
        });
    </script>
</body>
</html>
