<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Podcast情報站手機板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- General & Theme --- */
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #b3b3b3;
            --player-height: 80px; /* Adjusted for progress bar */
            --header-height: 56px;
        }
        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #f0f2f5;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #65676b;
        }
        html, body { height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: var(--color-text-primary); margin: 0; -webkit-tap-highlight-color: transparent; font-size: 14px; }
        #app-container { display: flex; flex-direction: column; height: 100vh; padding-bottom: var(--player-height); box-sizing: border-box; }
        .app-view { display: none; flex-direction: column; flex-grow: 1; overflow: hidden; background-color: var(--color-bg); }
        .view-header { display: flex; align-items: center; padding: 0 0.75rem; height: var(--header-height); background-color: var(--color-surface); flex-shrink: 0; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--color-interactive-element); }
        .view-content { flex-grow: 1; overflow-y: auto; padding: 0.75rem; }
        .back-btn { background: none; border: none; color: var(--color-text-primary); font-size: 1.1rem; cursor: pointer; padding: 0.5rem; margin-right: 0.5rem; }
        #theme-toggle-btn { background-color: transparent !important; color: var(--color-text-secondary); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* --- Library & Search View --- */
        #library-view .controls-container { margin: 0.75rem 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .view-mode-toggle { display: flex; background: var(--color-interactive-element); padding: 2px; border-radius: 9999px; }
        .view-mode-btn { background: transparent; border: none; color: var(--color-text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .view-mode-btn.active { background: var(--color-surface-hover); color: var(--color-text-primary); }
        #filter-favorites-btn, #sort-direction-btn { background-color: var(--color-interactive-element); color: var(--color-text-primary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        #filter-favorites-btn.active { background-color: #ff3b30; color: white; }
        .genre-filter-container { position: relative; }
        #genre-filter-btn { background-color: #007AFF; color: white; border: none; border-radius: 0.5rem; padding: 0.5rem 1rem; width: 100%; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        #genre-filter-list { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--color-surface-hover); border-radius: 0.5rem; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid var(--color-interactive-element); }
        #genre-filter-list a { display: flex; align-items: center; padding: 0.5rem 1rem; color: var(--color-text-primary); text-decoration: none; user-select: none; }
        #genre-filter-list a:hover { background-color: #007AFF; color: white; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.4rem 0.5rem; position: relative; border-bottom: 1px solid var(--color-interactive-element); }
        .sidebar-item:last-child { border-bottom: none; }
        #sidebar-items.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; }
        #sidebar-items.grid-view .sidebar-item { flex-direction: column; padding: 0.5rem; height: auto; text-align: center; gap: 0.25rem; border-bottom: none; border-radius: 0.5rem; background-color: var(--color-surface); }
        #sidebar-items.grid-view .sidebar-item img { width: 100% !important; height: auto !important; aspect-ratio: 1/1; border-radius: 0.5rem; }
        #search-results-podcasts { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; }
        .search-result-item { position: relative; display: flex; flex-direction: column; cursor: pointer; }
        .add-to-fav-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.7); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; z-index: 5; }
        .add-to-fav-btn.is-favorite { background-color: #FF453A; }

        /* --- Podcast Detail View --- */
        .podcast-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .podcast-header img { width: 5rem; height: 5rem; border-radius: 0.5rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); flex-shrink: 0; }
        .episode-item { display: flex; flex-direction: column; gap: 0.25rem; padding: 0.5rem; border-bottom: 1px solid var(--color-interactive-element); cursor: pointer; position: relative; }
        .episode-item:last-child { border-bottom: none; }
        .episode-item.is-listened .font-semibold { color: var(--color-text-secondary); }
        .episode-progress-bar-container { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: var(--color-interactive-element); }
        .episode-progress-bar { height: 100%; background-color: #007AFF; width: 0%; }
        .episode-item.is-playing-item { background-color: rgba(0, 122, 255, 0.3); }
        .episode-item.is-playing-item .font-semibold { color: #007AFF; }
        .sound-icon-container { display: none; }
        .episode-item.is-playing-item .sound-icon-container { display: inline-block; color: #007AFF; margin-left: 0.5rem; }
        .sound-icon-container svg { width: 16px; height: 16px; vertical-align: middle; }
        @keyframes sound-wave-pulse { 0% { transform: scaleY(0.3); } 30% { transform: scaleY(1); } 60% { transform: scaleY(0.5); } 100% { transform: scaleY(0.3); } }
        .sound-wave { transform-origin: 50% 100%; animation: sound-wave-pulse 1.2s ease-in-out infinite; }
        .sound-wave-1 { animation-delay: 0s; } .sound-wave-2 { animation-delay: 0.2s; } .sound-wave-3 { animation-delay: 0.4s; }
        .spinner { border: 4px solid var(--color-surface-hover); border-top-color: #007AFF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Player --- */
        .player { position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-height); background-color: var(--color-surface); border-top: 1px solid var(--color-interactive-element); z-index: 100; display: flex; flex-direction: column; justify-content: center; padding: 0.5rem 0.75rem; gap: 0.25rem; }
        .player-main { display: flex; align-items: center; gap: 0.75rem; width: 100%; }
        .player-info { flex: 1; display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        #player-album-art { width: 44px; height: 44px; border-radius: 0.25rem; }
        #player-title-container.marquee #player-title { display: inline-block; padding-left: 100%; animation: scroll-text 15s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .player-controls-wrapper { display: flex; align-items: center; gap: 1rem; }
        .play-pause-btn { width: 2.75rem; height: 2.75rem; border-radius: 50%; background-color: var(--color-text-primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;}
        .play-pause-btn i { color: var(--color-bg); font-size: 1.1rem; }
        .simple-control-btn { font-size: 1.1rem; color: var(--color-text-secondary); background: none; border: none; padding: 0.5rem; cursor: pointer;}
        .progress-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
        #progress-bar { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: var(--color-interactive-element); border-radius: 2px; outline: none; transition: opacity 0.2s; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--color-text-primary); border-radius: 50%; cursor: pointer; }
        #progress-bar::-moz-range-thumb { width: 12px; height: 12px; background: var(--color-text-primary); border-radius: 50%; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Library View -->
        <div id="library-view" class="app-view">
            <header class="view-header">
                <h1 class="text-lg font-bold flex-grow">我的私藏Podcast</h1>
                <button id="theme-toggle-btn" title="切換主題"></button>
            </header>
            <div class="view-content">
                <div class="my-2 flex items-center gap-2">
                    <div class="relative flex-grow">
                        <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none z-10 text-sm"></i>
                        <input type="text" placeholder="搜尋 iTunes..." id="search-input" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 pl-10 pr-4 rounded-full border-none w-full text-base">
                    </div>
                    <button id="search-btn" class="bg-[#1DB954] text-white py-2 px-3 rounded-full border-none cursor-pointer flex-shrink-0 font-semibold text-sm">搜尋</button>
                </div>
                <div class="controls-container">
                    <div class="genre-filter-container">
                        <button id="genre-filter-btn"><span id="genre-filter-btn-text">所有類別</span><i class="fas fa-chevron-down text-xs"></i></button>
                        <div id="genre-filter-list"></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="view-mode-toggle" title="切換視圖">
                            <button id="view-mode-list" class="view-mode-btn active"><i class="fas fa-list"></i></button>
                            <button id="view-mode-grid" class="view-mode-btn"><i class="fas fa-grip"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="filter-favorites-btn" title="只顯示我的最愛"><i class="fas fa-heart"></i></button>
                            <button id="sort-direction-btn" title="排序"><i id="sort-icon" class="fas fa-arrow-up-wide-short"></i></button>
                        </div>
                    </div>
                </div>
                <div id="sidebar-items" class="flex flex-col"></div>
            </div>
        </div>

        <!-- Search Results View -->
        <div id="search-results-view" class="app-view">
            <header class="view-header">
                <button class="back-btn" data-target-view="library-view"><i class="fas fa-chevron-left"></i></button>
                <h1 class="text-lg font-bold flex-grow">搜尋結果</h1>
                <div id="search-pagination-controls" class="flex items-center gap-1"></div>
            </header>
            <div id="search-results-podcasts" class="view-content"></div>
        </div>

        <!-- Podcast Detail View -->
        <div id="podcast-detail-view" class="app-view"></div>
    </div>

    <!-- Player -->
    <footer class="player" id="player">
        <div class="player-main">
            <div class="player-info">
                <img id="player-album-art" src="https://placehold.co/60x60/222/fff?text=Pod" alt="單集圖片">
                <div class="flex-1 overflow-hidden">
                    <div id="player-title-container" class="overflow-hidden whitespace-nowrap">
                        <span id="player-title" class="font-semibold" title="尚未播放任何內容">尚未播放任何內容</span>
                    </div>
                    <span id="player-artist" class="text-xs text-gray-400 truncate"></span>
                </div>
            </div>
            <div class="player-controls-wrapper">
                 <button id="play-pause-btn" class="play-pause-btn"><i id="play-pause-icon" class="fas fa-play"></i></button>
                 <button id="skip-forward-btn" class="simple-control-btn"><i class="fas fa-rotate-right"></i></button>
            </div>
        </div>
        <div class="progress-container">
            <span id="current-time" class="text-xs w-10 text-center">0:00</span>
            <input type="range" id="progress-bar" value="0" min="0" max="100" step="0.1">
            <span id="duration" class="text-xs w-10 text-center">0:00</span>
        </div>
    </footer>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const views = document.querySelectorAll('.app-view');
        const podcastDetailView = document.getElementById('podcast-detail-view');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const playerTitleContainer = document.getElementById('player-title-container');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const playerAlbumArt = document.getElementById('player-album-art');
        const sidebarItemsContainer = document.getElementById('sidebar-items');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const searchInput = document.getElementById('search-input');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const genreFilterBtn = document.getElementById('genre-filter-btn');
        const genreFilterList = document.getElementById('genre-filter-list');
        const genreFilterBtnText = document.getElementById('genre-filter-btn-text');

        // --- SVG Icons ---
        const soundIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><rect class="sound-wave sound-wave-1" x="4" y="8" width="4" height="8" rx="1"></rect><rect class="sound-wave sound-wave-2" x="10" y="5" width="4" height="14" rx="1"></rect><rect class="sound-wave sound-wave-3" x="16" y="8" width="4" height="8" rx="1"></rect></svg>`;
        const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>`;
        const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>`;
        
        // --- State Management ---
        const audio = new Audio();
        const collectionCache = {};
        let playerState = { currentEpisode: null, playlist: [], currentIndex: -1, isPlaying: false };
        let isFavoritesFilterActive = false;
        let isFetchingDetails = false;
        let lastProgressUpdateTime = 0;
        let currentGenreFilter = 'All';
        let searchState = { term: '', results: [], offset: 0, limit: 30 };
        
        const GENRES = { 'All': '所有類別', 'True Crime': '犯罪紀實', 'Comedy': '喜劇', 'Society & Culture': '社會與文化', 'News': '新聞', 'Health & Fitness': '健康與瘦身', 'Sports': '運動', 'Business': '商業', 'Education': '教育', 'Arts': '藝術', 'Science': '科學', 'History': '歷史', 'Religion & Spirituality': '宗教與精神生活', 'Kids & Family': '兒童與家庭', 'Music': '音樂', 'TV & Film': '電視與電影', 'Technology': '科技', 'Leisure': '休閒', 'Fiction': '小說', 'Government': '政府' };

        // --- View Manager ---
        function showView(viewId) {
            views.forEach(v => v.style.display = v.id === viewId ? 'flex' : 'none');
            const contentElement = document.querySelector(`#${viewId} .view-content`);
            if (contentElement) contentElement.scrollTop = 0;
        }

        // --- Local Storage Helpers ---
        const getCollection = () => JSON.parse(localStorage.getItem('podcastCollectionMobile') || '[]');
        const saveCollection = (collection) => localStorage.setItem('podcastCollectionMobile', JSON.stringify(collection));
        const getPlaybackProgress = () => JSON.parse(localStorage.getItem('playbackProgressMobile') || '{}');
        const savePlaybackProgress = (episodeId, currentTime, duration) => {
            if (!episodeId || !duration) return;
            const progressData = getPlaybackProgress();
            progressData[episodeId] = { currentTime, duration };
            localStorage.setItem('playbackProgressMobile', JSON.stringify(progressData));
        };
        const formatTime = (s) => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}`;
        const formatFileSize = (bytes) => { if (!bytes || bytes == 0) return ''; const mb = parseInt(bytes, 10) / (1024 * 1024); return mb < 0.1 ? '' : `${mb.toFixed(1)}MB`; };
        const formatDuration = (d) => { if (!d || d == 0) return ''; let s; if(String(d).includes(':')){const p=String(d).split(':').reverse();s=p.reduce((a,c,i)=>a+parseInt(c)*Math.pow(60,i),0)}else{s=parseInt(d,10)} if(isNaN(s)||s===0)return''; const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const sec=s%60; let r=`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; return h>0?`${h}:${r}`:r;};

        // --- Library Management ---
        const loadCollection = () => {
            sidebarItemsContainer.innerHTML = '';
            let collection = getCollection();
            if (isFavoritesFilterActive) collection = collection.filter(p => p.isFavorite);
            if (currentGenreFilter !== 'All') collection = collection.filter(p => p.primaryGenreName && p.primaryGenreName.includes(currentGenreFilter));
            const sortIcon = document.getElementById('sort-icon');
            const isAsc = sortIcon.classList.contains('fa-arrow-up-wide-short');
            collection.sort((a, b) => isAsc ? a.collectionName.localeCompare(b.collectionName, 'zh-Hant') : b.collectionName.localeCompare(a.collectionName, 'zh-Hant'));
            collection.forEach(podcast => renderCollectionItem(podcast));
        };
        const addToCollection = (podcast) => { if (!getCollection().some(i => i.collectionId === podcast.collectionId)) { const c = getCollection(); c.unshift({ ...podcast, addedAt: Date.now(), isFavorite: false }); saveCollection(c); loadCollection(); updateSearchItemUI(podcast.collectionId, true); }};
        const removeFromCollection = (collectionId) => { saveCollection(getCollection().filter(p => p.collectionId !== collectionId)); loadCollection(); updateSearchItemUI(collectionId, false); };
        const toggleFavoriteStatus = (collectionId) => { const c = getCollection(); const p = c.find(i => i.collectionId === collectionId); if(p){p.isFavorite=!p.isFavorite; saveCollection(c); loadCollection();} };
        
        function renderCollectionItem(podcast) {
            const item = document.createElement('div');
            item.className = 'sidebar-item';
            item.dataset.id = podcast.collectionId;
            item.innerHTML = `
                <img src="${podcast.artworkUrl60}" alt="" class="w-9 h-9 rounded-md flex-shrink-0">
                <div class="flex-1 overflow-hidden">
                    <div class="font-medium text-sm truncate leading-tight">${podcast.collectionName}</div>
                    <div class="text-xs text-gray-400 truncate leading-tight">${podcast.artistName}</div>
                </div>`;
            item.addEventListener('click', () => fetchEpisodes(podcast.collectionId));
            sidebarItemsContainer.appendChild(item);
        }

        // --- Search ---
        function updateSearchItemUI(collectionId, isCollected) { const btn = document.querySelector(`.add-to-fav-btn[data-id="${collectionId}"]`); if(btn){btn.classList.toggle('is-favorite', isCollected); btn.querySelector('i').className = isCollected ? 'fas' : 'far';} }
        async function searchPodcasts(term, newOffset = 0) {
            if (!term) return;
            showView('search-results-view');
            const container = document.getElementById('search-results-podcasts');
            if(newOffset === 0) container.innerHTML = `<div class="w-full flex justify-center mt-8 col-span-full"><div class="spinner w-10 h-10"></div></div>`;
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=podcast&limit=${searchState.limit}&offset=${newOffset}`);
                const data = await res.json();
                searchState = { ...searchState, term, results: newOffset === 0 ? data.results : [...searchState.results, ...data.results], offset: newOffset };
                if(newOffset === 0) container.innerHTML = '';
                if (!searchState.results.length) container.innerHTML = '<p class="col-span-full text-center text-gray-400">沒有找到相關播客。</p>';
                const collection = getCollection();
                data.results.forEach(podcast => {
                    const isCollected = collection.some(i => i.collectionId === podcast.collectionId);
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `<img src="${podcast.artworkUrl600}" class="w-full rounded-lg mb-1 shadow-lg aspect-square"><span class="font-semibold text-xs truncate w-full">${podcast.collectionName}</span><span class="text-[0.65rem] text-gray-400 truncate w-full">${podcast.artistName}</span><button class="add-to-fav-btn ${isCollected ? 'is-favorite' : ''}" data-id="${podcast.collectionId}"><i class="${isCollected ? 'fas':'far'} fa-heart"></i></button>`;
                    item.addEventListener('click', (e) => !e.target.closest('button') && fetchEpisodes(podcast.collectionId));
                    item.querySelector('.add-to-fav-btn').addEventListener('click', (e) => { e.stopPropagation(); e.currentTarget.classList.contains('is-favorite') ? removeFromCollection(podcast.collectionId) : addToCollection(podcast); });
                    container.appendChild(item);
                });
                renderPaginationControls(data.results.length === searchState.limit);
            } catch (error) { container.innerHTML = '<p class="text-center text-gray-400 col-span-full">搜尋失敗，請稍後再試。</p>'; }
        }
        function renderPaginationControls(canGoForward) {
            const container = document.getElementById('search-pagination-controls');
            container.innerHTML = '';
            const canGoBack = searchState.offset > 0;
            const createBtn = (icon, enabled, clickHandler) => {
                const btn = document.createElement('button');
                btn.className = `p-2 rounded-full ${enabled ? 'text-white' : 'text-gray-600'}`;
                btn.disabled = !enabled;
                btn.innerHTML = `<i class="fas ${icon}"></i>`;
                btn.addEventListener('click', clickHandler);
                return btn;
            };
            if(canGoBack || canGoForward) {
                container.appendChild(createBtn('fa-chevron-left', canGoBack, () => searchPodcasts(searchState.term, searchState.offset - searchState.limit)));
                container.appendChild(createBtn('fa-chevron-right', canGoForward, () => searchPodcasts(searchState.term, searchState.offset + searchState.limit)));
            }
        }
        
        // --- CORE: Podcast Feed Fetching Logic ---
        async function fetchWithTimeout(resource, options = {}) { const {timeout=10000}=options; const c=new AbortController(); const id=setTimeout(()=>c.abort(),timeout); try {const r=await fetch(resource,{...options,signal:c.signal}); return r;} catch(e){if(e.name==='AbortError'){throw new Error(`請求超時`)} throw e;} finally {clearTimeout(id);} }
        async function getPodcastInfo(collectionId) { if (collectionCache[collectionId] && collectionCache[collectionId].feedUrl) return collectionCache[collectionId]; const res = await fetch(`https://itunes.apple.com/lookup?id=${collectionId}`); if (!res.ok) throw new Error(`iTunes API 請求失敗`); const d = await res.json(); if (d.resultCount === 0 || !d.results[0].feedUrl) throw new Error('找不到 Podcast 或無效的 Feed URL'); collectionCache[collectionId] = d.results[0]; return d.results[0]; }
        async function parseFeed(feedUrl, podcastInfo) {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(feedUrl)}`;
            try {
                const res = await fetchWithTimeout(proxyUrl, { timeout: 10000 });
                if (!res.ok) throw new Error(`代理伺服器錯誤: ${res.status}`);
                const xmlText = await res.text();
                const doc = new DOMParser().parseFromString(xmlText, "application/xml");
                if (doc.querySelector("parsererror")) throw new Error('XML 解析失敗');
                const episodes = Array.from(doc.querySelectorAll("item")).map(item => {
                    const enclosure = item.querySelector("enclosure");
                    if (!enclosure || !enclosure.getAttribute("url")) return null;
                    return { trackId: item.querySelector("guid")?.textContent || enclosure.getAttribute("url"), trackName: item.querySelector("title")?.textContent || '無標題單集', episodeUrl: enclosure.getAttribute("url"), releaseDate: item.querySelector("pubDate")?.textContent || new Date().toISOString(), artworkUrl600: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl600, duration: item.querySelector("itunes\\:duration, duration")?.textContent||0, fileSize: enclosure.getAttribute("length")||0 };
                }).filter(Boolean);
                if (episodes.length === 0) throw new Error('Feed 中無有效的音訊單集');
                return episodes;
            } catch (error) { console.error(`[Feed Parser] FAILED: ${error.message}`); throw new Error(`無法載入 Feed: ${error.message}`); }
        }
        async function fetchEpisodes(collectionId) {
            if (isFetchingDetails) return;
            isFetchingDetails = true;
            showView('podcast-detail-view');
            try {
                const podcastInfo = await getPodcastInfo(collectionId);
                renderPodcastShell(podcastInfo);
                if (podcastInfo.episodes) {
                    populateEpisodesList(podcastInfo.episodes, podcastInfo);
                } else {
                    const episodes = await parseFeed(podcastInfo.feedUrl, podcastInfo);
                    collectionCache[collectionId].episodes = episodes;
                    populateEpisodesList(episodes, podcastInfo);
                }
            } catch (error) {
                console.error(`[CRITICAL] Failed to load podcast ID ${collectionId}:`, error);
                podcastDetailView.innerHTML = `<header class="view-header"><button class="back-btn" onclick="showView(document.getElementById('search-input').value ? 'search-results-view' : 'library-view')"><i class="fas fa-chevron-left"></i></button></header><div class="flex flex-col items-center justify-center h-full text-center text-[var(--color-text-secondary)] p-4"><p class="font-bold">無法載入節目</p><p class="text-sm mt-1">${error.message}</p></div>`;
            } finally {
                isFetchingDetails = false;
            }
        }

        // --- UI Rendering ---
        function renderPodcastShell(podcast) {
            podcastDetailView.innerHTML = `
                <header class="view-header">
                    <button class="back-btn" data-target-view="${searchInput.value ? 'search-results-view' : 'library-view'}"><i class="fas fa-chevron-left"></i></button>
                    <h1 class="text-base font-bold flex-grow truncate">${podcast.collectionName}</h1>
                </header>
                <div class="view-content">
                    <div class="podcast-header"><img src="${podcast.artworkUrl600}" alt="${podcast.collectionName}"><div class="flex-1"><h2 class="text-lg font-bold">${podcast.collectionName}</h2><p class="text-sm mt-1 text-gray-400">${podcast.artistName}</p><button id="add-to-collection-btn" class="mt-2 bg-[#1DB954] text-white font-bold py-1 px-3 rounded-full text-xs">收藏</button></div></div>
                    <h3 class="text-base font-bold my-2">所有單集</h3>
                    <div id="episodes-placeholder" class="text-center text-gray-400 py-8"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-sm">載入中...</p></div>
                </div>`;
            podcastDetailView.querySelector('.back-btn').addEventListener('click', (e) => showView(e.currentTarget.dataset.targetView));
            document.getElementById('add-to-collection-btn').addEventListener('click', () => addToCollection(podcast));
        }
        function populateEpisodesList(episodes, podcast) {
            const placeholder = document.getElementById('episodes-placeholder');
            if (!placeholder) return;
            const progressData = getPlaybackProgress();
            const episodesHTML = episodes.map((ep) => {
                const prog = progressData[ep.trackId];
                const progPercent = prog && prog.duration ? (prog.currentTime / prog.duration) * 100 : 0;
                const isListened = progPercent > 95;
                return `<div class="episode-item ${isListened ? 'is-listened' : ''}" data-episode-id="${CSS.escape(String(ep.trackId))}">
                    <div class="flex items-center w-full"><div class="flex-1 overflow-hidden"><div class="font-semibold truncate text-sm">${ep.trackName}<span class="sound-icon-container">${soundIconSVG}</span></div></div><a href="${ep.episodeUrl}" download="${ep.trackName}.mp3" class="ml-2 p-2 text-gray-400" onclick="event.stopPropagation()"><i class="fas fa-download"></i></a></div>
                    <div class="text-xs text-gray-500 flex justify-between w-full"><span>${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</span><span>${formatDuration(ep.duration) || formatFileSize(ep.fileSize)}</span></div>
                    <div class="episode-progress-bar-container"><div class="episode-progress-bar" style="width:${progPercent}%"></div></div>
                </div>`;
            }).join('');
            placeholder.outerHTML = `<div class="podcast-episodes">${episodesHTML}</div>`;
            podcastDetailView.querySelectorAll('.episode-item').forEach(item => {
                const ep = episodes.find(e => String(e.trackId) === item.dataset.episodeId);
                if (ep) item.addEventListener('click', () => playEpisode(ep, podcast.artistName, episodes));
            });
            syncPlayerUI();
        }

        // --- Player Logic ---
        const syncPlayerUI = () => {
            const { currentEpisode, isPlaying } = playerState;
            playerTitleContainer.classList.toggle('marquee', !!currentEpisode);
            if (currentEpisode) { playerTitle.textContent = currentEpisode.trackName; playerArtist.textContent = currentEpisode.artistName; playerAlbumArt.src = currentEpisode.artworkUrl600; } 
            else { playerTitle.textContent = '尚未播放'; playerArtist.textContent = ''; playerAlbumArt.src = 'https://placehold.co/60x60/222/fff?text=Pod'; }
            document.querySelector('.episode-item.is-playing-item')?.classList.remove('is-playing-item');
            if (isPlaying && currentEpisode) {
                const el = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                if (el) el.classList.add('is-playing-item');
            }
            playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
        };
        const playEpisode = (episode, host, playlist) => {
            if (playerState.currentEpisode?.trackId === episode.trackId) { togglePlayPause(); return; }
            playerState = { currentEpisode: { ...episode, artistName: host }, playlist, currentIndex: playlist.findIndex(i => i.trackId === episode.trackId), isPlaying: true };
            audio.src = episode.episodeUrl;
            const savedProgress = getPlaybackProgress()[episode.trackId];
            if (savedProgress && savedProgress.currentTime < savedProgress.duration * 0.95) audio.currentTime = savedProgress.currentTime;
            audio.play();
            syncPlayerUI();
        };
        const togglePlayPause = () => { if (!playerState.currentEpisode) return; audio.paused ? audio.play() : audio.pause(); };

        // --- Initialization ---
        function initialize() {
            audio.addEventListener('play', () => { playerState.isPlaying = true; syncPlayerUI(); });
            audio.addEventListener('pause', () => { playerState.isPlaying = false; syncPlayerUI(); });
            audio.addEventListener('timeupdate', () => { if(isNaN(audio.duration)) return; const {currentTime, duration} = audio; progressBar.value = (currentTime/duration)*100; currentTimeEl.textContent = formatTime(currentTime); durationEl.textContent = formatTime(duration); if(playerState.currentEpisode){const now=Date.now(); if(now-lastProgressUpdateTime > 2000){savePlaybackProgress(playerState.currentEpisode.trackId,currentTime,duration); lastProgressUpdateTime=now;} const epItem=document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(playerState.currentEpisode.trackId))}"]`); if(epItem){epItem.querySelector('.episode-progress-bar').style.width=`${(currentTime/duration)*100}%`; epItem.classList.toggle('is-listened', currentTime/duration>0.95);}} });
            audio.addEventListener('ended', () => { if(playerState.currentEpisode){savePlaybackProgress(playerState.currentEpisode.trackId, audio.duration, audio.duration);} const nextIndex = playerState.currentIndex + 1; if(nextIndex < playerState.playlist.length){const nextEp = playerState.playlist[nextIndex]; playEpisode(nextEp, playerState.currentEpisode.artistName, playerState.playlist);}else{playerState.isPlaying=false; syncPlayerUI();} });
            progressBar.addEventListener('input', (e) => { if(audio.duration) audio.currentTime = (e.target.value/100)*audio.duration; });

            document.getElementById('search-btn').addEventListener('click', () => searchPodcasts(searchInput.value, 0));
            searchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchPodcasts(e.target.value, 0));
            document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('skip-forward-btn').addEventListener('click', () => audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 15));
            
            const applyTheme = (t) => { document.documentElement.setAttribute('data-theme', t); themeToggleBtn.innerHTML = t === 'dark' ? sunIconSVG : moonIconSVG; localStorage.setItem('themeMobile', t); };
            themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

            document.getElementById('view-mode-list').addEventListener('click', (e) => { sidebarItemsContainer.classList.remove('grid-view'); e.currentTarget.classList.add('active'); document.getElementById('view-mode-grid').classList.remove('active'); });
            document.getElementById('view-mode-grid').addEventListener('click', (e) => { sidebarItemsContainer.classList.add('grid-view'); e.currentTarget.classList.add('active'); document.getElementById('view-mode-list').classList.remove('active'); });
            const filterFavoritesBtn = document.getElementById('filter-favorites-btn');
            filterFavoritesBtn.addEventListener('click', () => { isFavoritesFilterActive = !isFavoritesFilterActive; filterFavoritesBtn.classList.toggle('active', isFavoritesFilterActive); loadCollection(); });
            document.getElementById('sort-direction-btn').addEventListener('click', () => { const icon = document.getElementById('sort-icon'); icon.classList.toggle('fa-arrow-up-wide-short'); icon.classList.toggle('fa-arrow-down-wide-short'); loadCollection(); });

            populateGenreFilter();
            genreFilterBtn.addEventListener('click', () => genreFilterList.style.display = genreFilterList.style.display === 'block' ? 'none' : 'block');
            window.addEventListener('click', (e) => { if (!genreFilterBtn.contains(e.target)) genreFilterList.style.display = 'none'; });
            
            applyTheme(localStorage.getItem('themeMobile') || 'dark');
            loadCollection();
            syncPlayerUI();
            showView('library-view');
        }

        function populateGenreFilter() {
            genreFilterList.innerHTML = '';
            Object.entries(GENRES).forEach(([key, value]) => {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = value;
                link.dataset.genre = key;
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentGenreFilter = e.currentTarget.dataset.genre;
                    genreFilterBtnText.textContent = GENRES[currentGenreFilter];
                    genreFilterList.style.display = 'none';
                    loadCollection();
                });
                genreFilterList.appendChild(link);
            });
        }
        initialize();
    });
    </script>
</body>
</html>
