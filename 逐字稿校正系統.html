<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逐字稿校正系統</title>
    
    <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com/"></script>
    <style>
        /* ==== 基礎與主題設定 ==== */
        :root {
            --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        html, body {
            margin: 0; padding: 0; line-height: 1.6; font-size: 15px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: #f5f5f7; color: #1d1d1f; transition: background-color 0.3s ease, color 0.3s ease; overflow-x: hidden;
        }
        body.dark-mode {
            background-color: #1e1e1e; color: #f5f5f7;
        }

        /* ==== 視窗容器 ==== */
        .window-container {
            width: 90vw; max-width: 1400px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); overflow: hidden;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            transition: background-color 0.3s ease; position: absolute; top: 1vh; left: 50%; transform: translateX(-50%);
        }
        body.dark-mode .window-container {
            background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(70, 70, 70, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        /* ==== 內容與標題 ==== */
        .content-wrapper { padding: 24px; }
        .main-header {
            display: flex; justify-content: space-between; align-items: center; padding-top: 4px; margin-bottom: 24px;
        }
        .header-side-panel { flex: 1; }
        .header-side-panel:last-of-type { display: flex; justify-content: flex-end; }
        .header-center-panel { flex: 2; text-align: center; }
        
        .main-title { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.02em; color: #007aff; }
        body.dark-mode .main-title { color: #0A84FF; }
        .subtitle { font-size: 0.9rem; color: #6e6e73; margin: 0; line-height: 1.3; }
        body.dark-mode .subtitle { color: #a1a1a6; }

        .traffic-lights { display: flex; gap: 8px; }
        .traffic-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-red { background-color: #ff5f57; } .dot-yellow { background-color: #ffbd2e; } .dot-green { background-color: #27c93f; }
        .theme-toggle {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.05); transition: all 0.2s var(--ease-out);
        }
        .theme-toggle:hover { background-color: rgba(0, 0, 0, 0.1); transform: scale(1.1); }
        body.dark-mode .theme-toggle { background-color: rgba(255, 255, 255, 0.1); }
        body.dark-mode .theme-toggle:hover { background-color: rgba(255, 255, 255, 0.2); }
        .theme-icon { width: 16px; height: 16px; }

        /* ==== 編輯區塊 ==== */
        .editor-container { display: flex; flex-direction: row; gap: 24px; transition: flex-direction 0.3s var(--ease-out); }
        .editor-container.layout-vertical { flex-direction: column; }
        .editor-box {
            flex: 1; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%);
            border-radius: 10px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); transition: background-color 0.3s ease; display: flex; flex-direction: column;
        }
        body.dark-mode .editor-box { background: rgba(60, 60, 60, 0.5); border: 1px solid rgba(80, 80, 80, 0.1); }
        .editor-header { display: flex; align-items: center; border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding-bottom: 12px; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;}
        body.dark-mode .editor-header { border-bottom-color: rgba(255, 255, 255, 0.1); }
        
        .editor-box h3 {
            margin: 0; padding: 0; border: none; font-weight: 600; font-size: 1.125rem; color: #007aff; display: flex; align-items: center; gap: 8px;
        }
        body.dark-mode .editor-box h3 { color: #0A84FF; }
        .input-area-note { font-size: 0.85rem; font-weight: 400; color: #1d1d1f; }
        body.dark-mode .input-area-note { color: #a1a1a6; }
        .controls-group { display: flex; gap: 12px; }

        .input-div, .output-div {
            width: 100%; height: 450px; flex-grow: 1; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 12px 16px;
            line-height: 1.7; box-sizing: border-box; resize: vertical; background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease; white-space: pre-wrap; 
            overflow-y: scroll;
            font-family: 'SF Mono', 'Menlo', 'Consolas', 'Courier New', monospace; text-align: justify;
        }
        .input-div { color: #1d1d1f; }
        body.dark-mode .input-div { background-color: rgba(30, 30, 30, 0.7); color: #f5f5f7; border-color: rgba(255, 255, 255, 0.15); }
        .input-div:empty::before { content: attr(data-placeholder); color: #a1a1a6; pointer-events: none; }
        body.dark-mode .input-div:empty::before { color: #6e6e73; }
        .output-div { color: #007aff; }
        body.dark-mode .output-div { background-color: rgba(30, 30, 30, 0.7); color: #0A84FF; border-color: rgba(255, 255, 255, 0.15); }
        .input-div:focus, .output-div:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }

        .typo {
            cursor: pointer; border-radius: 4px; padding: 1px 3px; font-weight: bold; transition: background-color 0.2s;
        }
        .typo:hover { background-color: rgba(0, 122, 255, 0.2) !important; }
        .original-typo { color: #155724; background-color: #d4edda; }
        body.dark-mode .original-typo { color: #7ee292; background-color: rgba(40, 167, 69, 0.2); }
        .corrected { color: #ff3b30; background-color: rgba(255, 59, 48, 0.1); }
        body.dark-mode .corrected { color: #ff453a; background-color: rgba(255, 69, 58, 0.15); }
        
        .correction-popover {
            position: absolute; background-color: #fff; border: 1px solid #d2d2d7; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px; padding: 12px; z-index: 1001; display: none; flex-direction: column; gap: 8px; font-size: 14px;
            animation: fadeIn 0.2s var(--ease-out);
        }
        body.dark-mode .correction-popover { background-color: #333; border-color: #555; }
        .popover-suggestion { margin-bottom: 4px; }
        .popover-buttons { display: flex; gap: 8px; }

        .mac-button {
            padding: 8px 16px; font-size: 14px; font-weight: 500; color: #ffffff; background-color: #007aff; border: none;
            border-radius: 8px; cursor: pointer; transition: all 0.2s var(--ease-out); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .mac-button:hover { background-color: #0056b3; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .mac-button:active { transform: scale(0.98); }
        .mac-button svg { width: 16px; height: 16px; }
        .mac-button-secondary { background-color: #8e8e93; }
        .mac-button-secondary:hover { background-color: #636366; }
        .mac-button-accent { background-color: #ff9500; }
        .mac-button-accent:hover { background-color: #d97e00; }
        .mac-button-success { background-color: #28a745; }
        .mac-button-success:hover { background-color: #218838; }
        
        .icon-button { 
            background-color: transparent; border: none; padding: 4px; border-radius: 6px; color: #8e8e93; 
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .icon-button:hover { background-color: rgba(0, 0, 0, 0.05); color: #1d1d1f; }
        body.dark-mode .icon-button { color: #a1a1a6; }
        body.dark-mode .icon-button:hover { background-color: rgba(255, 255, 255, 0.1); color: #f5f5f7; }
        
        .feature-settings { display: flex; align-items: center; gap: 32px; margin-top: 16px; margin-bottom: 16px; justify-content: center; }
        .setting-item { display: flex; align-items: center; gap: 8px; font-size: 1rem; font-weight: 600; }
        /* MODIFIED: Changed background color to navy blue */
        .setting-item > span,
        .setting-item > label[for="realtime-toggle"],
        .setting-item .icon-button span {
            font-size: 1.05rem;
            color: white !important;
            background-color: #000080; /* Navy Blue */
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 500;
            display: inline-block;
        }
        body.dark-mode .setting-item > span,
        body.dark-mode .setting-item > label[for="realtime-toggle"],
        body.dark-mode .setting-item .icon-button span {
            background-color: #000080; /* Navy Blue */
        }

        .stats-dashboard { 
            font-size: 0.85rem; color: #6e6e73; white-space: nowrap;
        }
        body.dark-mode .stats-dashboard { color: #a1a1a6; }
        .stat-word-count { color: #28a745; font-weight: 600; }
        .stat-typo-count { color: #ff3b30; font-weight: 600; }
        body.dark-mode .stat-word-count { color: #30d158; }
        body.dark-mode .stat-typo-count { color: #ff453a; }

        .font-size-display { font-weight: 600; min-width: 3ch; text-align: center; color: #1d1d1f; }
        body.dark-mode .font-size-display { color: #f5f5f7; }
        
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #007aff; }
        input:checked + .slider:before { transform: translateX(14px); }

        .feature-explanation-container { margin-top: 32px; display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 24px; }
        .feature-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.4)); border-radius: 12px;
            padding: 24px; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s var(--ease-out), box-shadow 0.3s var(--ease-out);
        }
        .feature-card:hover { transform: translateY(-6px); box-shadow: 0 8px 12px rgba(0, 0, 0, 0.07), 0 20px 30px rgba(0, 0, 0, 0.07); }
        body.dark-mode .feature-card {
            background: linear-gradient(145deg, rgba(60, 60, 60, 0.7), rgba(40, 40, 40, 0.5)); border: 1px solid rgba(80, 80, 80, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .feature-card:hover { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15), 0 20px 35px rgba(0, 0, 0, 0.15); }
        .feature-card .feature-icon { width: 48px; height: 48px; margin-bottom: 16px; }
        .feature-card h4 { font-size: 1.125rem; font-weight: 600; color: #007aff; margin: 0 0 8px 0; }
        body.dark-mode .feature-card h4 { color: #0A84FF; }
        .feature-card p, .feature-card ul { font-size: 0.95rem; color: #6e6e73; line-height: 1.6; }
        .feature-card ul { padding-left: 20px; margin-top: 12px; }
        .feature-card li { margin-bottom: 8px; }
        body.dark-mode .feature-card p, body.dark-mode .feature-card ul { color: #a1a1a6; }
        .text-apple-blue { color: #007aff; font-weight: 600; }
        body.dark-mode .text-apple-blue { color: #0A84FF; }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 247, 250, 0.5); backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%); display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        body.dark-mode .overlay { background: rgba(30, 30, 30, 0.5); }
        .overlay.visible { opacity: 1; visibility: visible; }
        .spinner {
            width: 48px; height: 48px; border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #007aff; border-radius: 50%; animation: spin 1s linear infinite;
        }
        body.dark-mode .spinner { border-color: rgba(255, 255, 255, 0.1); border-left-color: #007aff; }
        
        .modal {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); 
            padding: 24px; 
            width: 90%; 
            max-width: 750px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.3s var(--ease-out);
            transition: box-shadow 0.3s var(--ease-out);
            display: flex;
            flex-direction: column;
        }
        .modal:hover {
             box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }
        body.dark-mode .modal { 
            background: rgba(40, 40, 40, 0.7);
            border: 1px solid rgba(70, 70, 70, 0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
        }
        body.dark-mode .modal:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h4 { margin: 0; font-size: 1.2rem; }
        .modal-body { flex-shrink: 1; min-height: 0; }
        .modal-body #dict-table { width: 100%; border-collapse: collapse; }
        
        .modal-body #dict-table th {
            background-color: #007aff;
            color: white;
            font-weight: 600;
        }
        body.dark-mode .modal-body #dict-table th {
            background-color: #0A84FF;
        }
        .modal-body #dict-table th, .modal-body #dict-table td { 
            padding: 2px 8px;
            border: 1px solid rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .modal-body #dict-table td {
            font-weight: 600;
        }

        .modal-body #dict-table .delete-btn {
            color: #ff3b30;
            margin: 0 auto;
        }
        body.dark-mode .modal-body #dict-table .delete-btn {
            color: #ff453a;
        }

        #close-modal-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ff3b30;
            color: white;
            transition: all 0.2s ease;
            padding: 0;
        }
        #close-modal-btn svg {
            width: 18px;
            height: 18px;
        }
        #close-modal-btn:hover {
            background-color: #d92c23;
            color: white;
            transform: scale(1.1);
        }
        
        .modal-footer {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: stretch;
            flex-shrink: 0;
        }
        .modal-io-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .export-buttons-group {
            display: flex;
            gap: 8px;
        }
        .modal-footer .input-group { 
            display: flex; 
            flex-grow: 1; 
            gap: 8px; 
            justify-content: center;
        }

        #dict-typo-input, #dict-correction-input {
            background-color: #fffacd;
        }
        body.dark-mode #dict-typo-input, 
        body.dark-mode #dict-correction-input { 
            background-color: #595533;
            border-color: #777;
            color: #f5f5f7;
        }

        body.dark-mode .modal-body #dict-table th, body.dark-mode .modal-body #dict-table td { border-color: rgba(255,255,255,0.15); }
        .modal-body #dict-table tbody tr { transition: background-color 0.2s var(--ease-out); }
        .modal-body #dict-table tbody tr:hover { background-color: rgba(0, 0, 0, 0.05); }
        body.dark-mode .modal-body #dict-table tbody tr:hover { background-color: rgba(255, 255, 255, 0.08); }
        
        body.dark-mode .modal-footer input { background-color: #555; border-color: #777; color: #fff; }
        
        .dict-table-container {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        body.dark-mode .dict-table-container {
            border-color: rgba(255,255,255,0.15);
        }
        #dict-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .search-highlight {
            background-color: yellow !important;
            color: black !important;
        }
        .current-search {
            outline: 2px solid #ff3b30;
            outline-offset: -2px;
        }
        .sortable-header {
            position: relative;
        }
        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            opacity: 0.9;
        }
        .sortable-header.sort-asc::after {
            border-bottom-color: white;
        }
        .sortable-header.sort-desc::after {
            border-top-color: white;
        }


        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        @media (max-width: 1024px) {
            .editor-container:not(.layout-vertical) { flex-direction: column; }
            .input-div, .output-div { height: 350px; }
        }
        @media (max-width: 768px) {
            .window-container { width: 95vw; }
            .main-header { flex-wrap: wrap; justify-content: center; }
            .header-center-panel { flex-basis: 100%; order: 2; }
            .header-side-panel:first-of-type { order: 1; }
            .header-side-panel:last-of-type { order: 3; }
            .main-title { font-size: 1.5rem; }
            .subtitle { font-size: 0.85rem; }
            .editor-header { flex-direction: column; align-items: flex-start; }
            .feature-settings { flex-wrap: wrap; }
            .modal-io-container { justify-content: center; }
        }
    </style>
</head>
<body>
    <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;">
    <input type="file" id="import-dict-input" accept=".html,.csv,.xlsx,.xls" style="display: none;">

    <div id="loader" class="overlay"><div class="spinner"></div></div>

    <div id="dictionary-modal" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h4 style="font-weight: bold;">自訂詞典</h4>
                <button id="close-modal-btn" class="icon-button" title="關閉"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body">
                <p style="text-align:center; font-size: 16px; font-weight: bold; color:#6e6e73; margin-bottom: 8px; margin-top: 0;"><strong>此列表中的詞彙校正功能位於文章輸入區，點選「套用自訂校正」圖示即可執行</strong></p>
                <div id="dict-search-container" style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px; padding: 4px; background-color: rgba(0,0,0,0.05); border-radius: 8px;">
                    <input type="text" id="dict-search-input" placeholder="搜尋列表中的文字..." style="flex-grow: 1; border: 1px solid #ccc; border-radius: 6px; padding: 4px 8px;">
                    <span id="dict-search-count" style="font-size: 14px; min-width: 60px; text-align: center; color: #6e6e73;">0 / 0</span>
                    <button id="dict-search-prev-btn" class="mac-button mac-button-secondary" style="padding: 4px 8px;">&lt;</button>
                    <button id="dict-search-next-btn" class="mac-button mac-button-secondary" style="padding: 4px 8px;">&gt;</button>
                </div>
                <div class="dict-table-container">
                    <table id="dict-table">
                        <thead><tr><th style="width: 50px;">序號</th><th class="sortable-header" data-sort-key="typo" style="cursor: pointer;">錯別字<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:1em; height:1em; display: inline-block; vertical-align: text-bottom; margin-left: 4px; opacity: 0.7;" stroke="currentColor"><path d="M7 15L12 20L17 15M7 9L12 4L17 9" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></th><th class="sortable-header" data-sort-key="correction" style="cursor: pointer;">校正字<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:1em; height:1em; display: inline-block; vertical-align: text-bottom; margin-left: 4px; opacity: 0.7;" stroke="currentColor"><path d="M7 15L12 20L17 15M7 9L12 4L17 9" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></th><th>刪除</th></tr></thead>
                        <tbody id="dict-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-io-container">
                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <button id="import-dict-btn" class="mac-button mac-button-accent">匯入詞典</button>
                        <a href="https://fyc43703.github.io/chengder/%E9%80%90%E5%AD%97%E7%A8%BF%E6%A0%A1%E6%AD%A3%E7%B3%BB%E7%B5%B1%E8%87%AA%E8%A8%82%E8%A9%9E%E5%85%B8%E5%8F%83%E8%80%83%E7%AF%84%E4%BE%8B.csv" target="_blank" style="font-size: 14px; font-weight: 500; text-decoration: none; color: #007aff;">自訂詞典參考範例檔</a>
                        <button id="dict-delete-all-btn" class="mac-button" style="background-color: #ff3b30;">刪除全部詞彙</button>
                    </div>
                    <div class="export-buttons-group">
                        <button id="export-dict-html-btn" class="mac-button mac-button-success">匯出 HTML</button>
                        <button id="export-dict-csv-btn" class="mac-button mac-button-success">匯出 CSV</button>
                        <button id="export-dict-rtf-btn" class="mac-button mac-button-success">匯出 RTF</button>
                    </div>
                </div>
                <div style="width:100%; border-top: 1px solid rgba(0,0,0,0.1); margin-top: 8px; padding-top: 16px;">
                     <p style="text-align:center; font-size: 16px; font-weight: bold; color:#6e6e73; margin-bottom: 8px; margin-top: 0;">請於此欄位單筆新增詞彙。若需大量新增，建議先以 Excel 彙整後再批量匯入詞典</p>
                    <div class="input-group">
                        <input type="text" id="dict-typo-input" placeholder="錯別字...">
                        <input type="text" id="dict-correction-input" placeholder="校正字...">
                        <button id="dict-add-btn" class="mac-button">新增</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="correction-popover" class="correction-popover">
        <div class="popover-suggestion"></div>
        <div class="popover-buttons"></div>
    </div>

    <div class="window-container">
        <div class="content-wrapper">
            <header class="main-header">
                <div class="header-side-panel"><div class="traffic-lights"><div class="traffic-dot dot-red"></div><div class="traffic-dot dot-yellow"></div><div class="traffic-dot dot-green"></div></div></div>
                <div class="header-center-panel">
                    <h1 class="main-title">逐字稿校正系統</h1>
                    <h2 class="subtitle">系統內建詞庫比對功能，支援匯入自訂詞典，可自動校正錯別字並匯出修正結果。請務必人工再次複核</h2>
                    <h3 class="subtitle">製作者：陳政德</h3>
                </div>
                <div class="header-side-panel">
                     <div id="theme-toggle" class="theme-toggle" title="切換明暗主題">
                        <svg id="icon-moon" class="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                        <svg id="icon-sun" class="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12H.75m.386-6.364l1.591 1.591M12 6.375a5.625 5.625 0 100 11.25 5.625 5.625 0 000-11.25z" /></svg>
                    </div>
                </div>
            </header>
            
            <div class="feature-settings">
                <div class="setting-item"><label for="realtime-toggle">即時校正</label><label class="switch"><input type="checkbox" id="realtime-toggle"><span class="slider"></span></label></div>
                <div class="setting-item"><span>版面模式</span><button id="layout-toggle-btn" class="icon-button" title="切換並排/上下模式"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.75 5H8.25C6.45507 5 5 6.45507 5 8.25V15.75C5 17.5449 6.45507 19 8.25 19H15.75C17.5449 19 19 17.5449 19 15.75V8.25C19 6.45507 17.5449 5 15.75 5Z" stroke="#78787a" stroke-width="1.5"/><path d="M12 5V19" stroke="#5d61f1" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 12H19" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12H9" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 8H19" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 8H9" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 16H19" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 16H9" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
                <div class="setting-item"><button id="manage-dict-btn" class="icon-button" title="管理自訂詞典"><span>管理詞典</span><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.25 4.75C6.25 4.19772 6.69772 3.75 7.25 3.75H16.75C17.3023 3.75 17.75 4.19772 17.75 4.75V19.25C17.75 19.8023 17.3023 20.25 16.75 20.25H7.25C6.69772 20.25 6.25 19.8023 6.25 19.25V4.75Z" stroke="#8a8a8a" stroke-width="1.5"/><path d="M9.75 8.25H14.25" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round"/><path d="M9.75 11.25H14.25" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round"/><path d="M9.75 14.25H12.25" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round"/><path d="M6.25 4.75H4.75C4.19772 4.75 3.75 5.19772 3.75 5.75V18.25C3.75 18.8023 4.19772 19.25 4.75 19.25H6.25" stroke="#5d61f1" stroke-width="1.5"/></svg></button></div>
                <div class="setting-item">
                    <span>文字大小</span>
                    <button id="font-size-decrease-btn" class="icon-button" title="縮小文字"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:20px;height:20px;"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg></button>
                    <span id="font-size-display" class="font-size-display">16px</span>
                    <button id="font-size-increase-btn" class="icon-button" title="放大文字"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:20px;height:20px;"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg></button>
                </div>
            </div>

            <div id="editor-container" class="editor-container">
                <div class="editor-box">
                    <div class="editor-header">
                        <h3>文章輸入區：<span class="input-area-note">※ 文字間空格請刪除</span></h3>
                        <div class="header-controls-wrapper" style="flex-grow: 1; display: flex; justify-content: space-between; align-items: center;">
                            <button id="import-pdf-btn" class="mac-button mac-button-accent" title="從電腦匯入 PDF 檔案"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><span>匯入PDF</span></button>
                            <div class="controls-group">
                                <button id="apply-custom-dict-btn" class="mac-button" title="根據自訂詞典取代文章內的錯字"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.998 15.998 0 011.622-3.385m5.043.025a15.998 15.998 0 001.622-3.385m3.388 1.62a15.998 15.998 0 00-1.622-3.385m-5.043-.025a15.998 15.998 0 01-3.388-1.621m7.732 0c.618-.349 1.295-.65 2.008-.864m-7.732 0c.618-.349 1.295-.65 2.008-.864m-1.788 6.443a.75.75 0 00.158.848l.301.301A.75.75 0 0015.63 17.62a3.75 3.75 0 005.272-5.272l.301.301a.75.75 0 001.06-1.06l-1.5-1.5a.75.75 0 00-1.06 0l-.301.301a.75.75 0 00-.158.848z"></path></svg><span>套用自訂校正</span></button>
                                <button id="check-btn" class="mac-button" title="手動執行一次校正"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>開始校正</span></button>
                                <button id="clear-btn" class="mac-button mac-button-secondary" title="清除左右兩邊的所有文字"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.576 0c-.245.035-.488.072-.732.114m15.026 0a48.232 48.232 0 01-4.042-.392M6.343 5.79l-1.246-1.37a1.5 1.5 0 010-2.122l1.246-1.372a1.5 1.5 0 012.122 0l1.246 1.37a1.5 1.5 0 010 2.122l-1.246 1.372a1.5 1.5 0 01-2.122 0z" /></svg><span>清除內容</span></button>
                            </div>
                        </div>
                    </div>
                    <div id="input-text" class="input-div" contenteditable="true" data-placeholder="點擊「匯入PDF」選擇檔案，或直接貼上文字內容進行校正。"></div>
                </div>
                <div class="editor-box">
                    <div class="editor-header">
                        <h3>校正後之文字：</h3>
                        <div id="stats-dashboard" class="stats-dashboard"><span>總字數: <span class="stat-word-count">0</span> | 發現錯字: <span class="stat-typo-count">0</span></span></div>
                    </div>
                    <div class="controls-group" style="justify-content: flex-end; margin-bottom: 12px;">
                        <button id="compare-diff-btn" class="mac-button mac-button-secondary" title="將目前標示的差異匯出為 CSV 報告"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125A1.125 1.125 0 003 5.625v12.75c0 .621.504 1.125 1.125 1.125z" /></svg><span>差異比對</span></button>
                        <button id="accept-all-btn" class="mac-button" title="採納所有修正建議"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:20px;height:20px;"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg><span>全部採納</span></button>
                        <button id="copy-btn" class="mac-button" title="複製校正後的純文字內容"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5 .124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg><span>複製文字</span></button>
                        <button id="download-btn" class="mac-button mac-button-success" title="將校正後的文字下載為 RTF 檔案"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg><span>下載檔案</span></button>
                    </div>
                    <div id="output-div" class="output-div" contenteditable="false" aria-readonly="true"></div>
                </div>
            </div>
            
            <div class="feature-explanation-container">
                <div class="feature-card">
                    <svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#FFD766" d="M40 61H10c-2.21 0-4-1.79-4-4V7c0-2.21 1.79-4 4-4h20l14 14v40c0 2.21-1.79 4-4 4z"></path><path fill="#FFF" d="M30 3h- पॉइंट586L43.586 17H30z" opacity=".5"></path><path fill="#F37E7E" d="M26 21h12v4H26zm0 8h4v4h-4zm-8-4h4v4h-4zm8 12h12v4H26zm-8-4h4v4h-4zm16-8h4v4h-4zm-8-4h12v4H26zm-8 8h4v4h-4zm16 4h4v4h-4zm-8 8h12v4H26z"></path><path fill="#F3A2A2" d="M18 25h4v4h-4zm8-4h4v4h-4zm-8 8h4v4h-4zm8 4h4v4h-4zm-8 8h4v4h-4z"></path><path fill="#5955A5" d="M46 37h12v4H46zm0 8h4v4h-4zm-8-4h4v4h-4zm8 12h12v4H46zm-8-4h4v4h-4zm16-8h4v4h-4zm-8-4h12v4H46zm-8 8h4v4h-4zm16 4h4v4h-4zm-8 8h12v4H46z"></path><path fill="#9FA4F5" d="M38 41h4v4h-4zm8-4h4v4h-4zm-8 8h4v4h-4zm8 4h4v4h-4zm-8 8h4v4h-4z"></path></g></svg>
                    <h4>智慧匯入與編輯</h4>
                    <p>我們致力於簡化您的工作流程。您無須再手動從文件中複製文字，只需點擊 <span class="text-apple-blue">匯入PDF</span> 按鈕，系統就會自動讀取並解析文件內容，直接呈現在文章輸入區。此外，我們也提供便捷的輔助工具，提升您的編輯效率：</p>
                    <ul>
                        <li><strong class="text-apple-blue">匯入 PDF：</strong> 自動提取 PDF 文件的純文字，省去繁瑣的複製貼上步驟，讓您能立即開始校對，特別適合處理數位逐字稿或會議記錄。</li>
                        <li><strong class="text-apple-blue">套用自訂校正：</strong> 在執行全自動校正前，您可以先點擊此按鈕。系統會優先根據您個人建立的「自訂詞典」進行一輪取代，確保您的專有名詞或慣用語得到正確處理。</li>
                        <li><strong class="text-apple-blue">清除內容：</strong> 當您想開始一項新的校對任務時，點擊此按鈕即可一鍵清空「文章輸入區」與「校正後文字區」的所有內容，無需手動刪除，快速恢復初始狀態。</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#5955A5" d="M44 61H16c-2.21 0-4-1.79-4-4V7c0-2.21 1.79-4 4-4h32c2.21 0 4 1.79 4 4v28l-12 12v10c0 2.21-1.79 4-4 4z"></path><path fill="#FFF" d="M52 35h- पॉइंट586L40.586 46H52z" opacity=".5"></path><path fill="#FFD766" d="M22 17h20v2H22zm0 8h20v2H22zm0 8h20v2H22zm0 8h12v2H22z"></path><path fill="#9FA4F5" d="M40 45h12v12H40z"></path><path fill="#5955A5" d="M47.333 48.071l-1.414 1.414 2.828 2.828-2.828 2.828 1.414 1.414 2.828-2.828 2.829 2.828 1.414-1.414-2.829-2.828 2.829-2.828-1.414-1.414-2.829 2.828z"></path></g></svg>
                    <h4>智慧互動校正</h4>
                    <p>本系統提供高度彈性與互動性的校正體驗。您可以根據自己的習慣選擇最適合的工作模式，並對每一處修正建議進行精準控制。</p>
                    <ul>
                        <li><strong class="text-apple-blue">即時校正：</strong> 開啟此開關後，系統會在您輸入或貼上文字時自動進行背景分析，即時標示出可能的錯別字，如同文書處理軟體中的拼寫檢查功能。</li>
                        <li><strong class="text-apple-blue">開始校正：</strong> 若您偏好一次性完成校對，可以在輸入完所有內容後點擊此按鈕。系統會對全文進行一次完整的掃描與比對，並在左右兩側同步標示出原文與修正後的建議。</li>
                        <li><strong class="text-apple-blue">互動式修正：</strong> 在校正結果區，點擊任一被標示的 <span style="color: #ff3b30; background-color: rgba(255, 59, 48, 0.1);">紅色</span> 建議文字，會彈出一個小視窗，讓您清楚看到「原文」與「建議修正」。您可以選擇「採納」此建議，或「忽略」以保留原文，給予您完全的控制權。</li>
                        <li><strong class="text-apple-blue">全部採納：</strong> 當您預覽過校正結果並感到滿意時，點擊此按鈕即可一鍵接受所有系統建議的修正，省去逐一點擊的麻煩，大幅提升效率。</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#66B3FF" d="M40 61H10c-2.21 0-4-1.79-4-4V7c0-2.21 1.79-4 4-4h20l14 14v40c0 2.21-1.79 4-4 4z"></path><path fill="#FFF" d="M30 3h- पॉइंट586L43.586 17H30z" opacity=".5"></path><path fill="#2E75B6" d="M22 25h20v2H22zm0 8h20v2H22zm0 8h20v2H22z"></path><g fill="#66B3FF"><path d="M42 37H22a2 2 0 0 1-2-2v-6c0-1.1.9-2 2-2h20a2 2 0 0 1 2 2v6c0 1.1-.9 2-2 2z"></path></g><path fill="#FFFFFF" d="M54 41H34a2 2 0 0 1-2-2v-6c0-1.1.9-2 2-2h20a2 2 0 0 1 2 2v6c0 1.1-.9 2-2 2z"></path><path fill="#2E75B6" d="M38 35h12v2H38zm0 4h12v2H38z"></path></g></svg>
                    <h4>成果匯出與分享</h4>
                    <p>完成校對後，您可以輕鬆地將成果應用於各種場景。我們提供了多種匯出格式，無論是提交報告、分享筆記，或是備份您的個人化設定，都能輕鬆搞定。</p>
                    <ul>
                        <li><strong class="text-apple-blue">複製文字：</strong> 一鍵將右側「校正後文字區」的純文字內容複製到剪貼簿，方便您快速貼到 Email、報告、即時訊息等任何地方。</li>
                        <li><strong class="text-apple-blue">下載檔案 (RTF)：</strong> 將校正後的文字儲存為通用的 RTF (Rich Text Format) 格式。這是一種跨平台相容性極高的檔案，無論在 Windows、macOS 或其他作業系統上，都能用文書處理軟體輕鬆開啟。</li>
                        <li><strong class="text-apple-blue">差異比對 (CSV)：</strong> 點擊此按鈕可匯出一份詳細的「文字修正比對報告」。報告以 CSV 格式儲存，可用 Excel 或 Google Sheets 開啟，清晰列出每一處的「原文」與「修正後」文字，非常適合用於工作審核、成果彙報或教學分析。</li>
                        <li><strong class="text-apple-blue">自訂詞典匯出/匯入：</strong> 您精心建立的個人詞典可以匯出為 HTML (方便預覽)、CSV (方便編輯與備份) 或 RTF (方便列印) 檔案，輕鬆與同事共享或在不同電腦間同步。反之，您也可以透過「匯入詞典」功能，快速載入他人分享或自己備份的詞典檔案。</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#9FA4F5" d="M61 32c0 16.016-12.984 29-29 29S3 48.016 3 32 15.984 3 32 3s29 12.984 29 29"></path><path fill="#FFD766" d="M56.485 32c0-9.04-4.887-17.008-12.243-21.213C39.54 3.067 31.022 0 22 0 9.85 0 0 9.85 0 22c0 9.022 3.067 17.54 7.787 22.242C11.992 49.113 20 53.999 29 54c12.15 0 22-9.85 22-22 0-2.073-.304-4.066-.828-5.945C54.02 24.34 56.485 28.536 56.485 32z"></path><g fill="#F37E7E"><path d="M28 20l-4 4-4-4 4-4zM24 28l-4 4-4-4 4-4zM32 28l-4 4-4-4 4-4z"></path></g></g></svg>
                    <h4>舒適個人化體驗</h4>
                    <p>我們相信，好的工具應該能適應您的使用習慣。本系統提供豐富的個人化設定，讓您在最舒適的環境下進行校對工作，專注於文字本身。</p>
                    <ul>
                        <li><strong class="text-apple-blue">明暗主題切換：</strong> 提供明亮與暗黑兩種介面主題。暗黑模式可減少螢幕眩光，在夜間或長時間使用下，有效舒緩眼睛疲勞。系統也會自動偵測並套用您作業系統的偏好設定。</li>
                        <li><strong class="text-apple-blue">版面模式切換：</strong> 您可以自由選擇「並排」或「上下」兩種版面配置。「並排」模式適合寬螢幕，方便左右對照；「上下」模式則適合筆電或窄螢幕，讓閱讀更流暢。</li>
                        <li><strong class="text-apple-blue">文字大小調整：</strong> 透過 "+" 和 "-" 按鈕，輕鬆調整編輯區的字體大小，找到最適合您視力與螢幕解析度的尺寸，提升閱讀舒適度。</li>
                        <li><strong class="text-apple-blue">管理詞典：</strong> 這是系統的核心個人化功能。點擊後會開啟一個專屬管理視窗，您可以在此：單筆「新增」詞彙、精準「刪除」詞條、對列表進行「排序」與「搜尋」，讓您的個人詞典庫管理起來既強大又方便。</li>
                        <li><strong class="text-apple-blue">同步滾動：</strong> 當您滾動一邊的編輯區時，另一邊也會自動同步滾動到對應位置。這個貼心的設計讓您在比對長篇文章時，無需手動調整兩邊的視野，確保原文與校正文稿始終對齊，大幅提升比對效率。</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const elements = {
            inputText: $('#input-text'), outputDiv: $('#output-div'), loader: $('#loader'),
            checkBtn: $('#check-btn'), clearBtn: $('#clear-btn'), copyBtn: $('#copy-btn'),
            downloadBtn: $('#download-btn'), importPdfBtn: $('#import-pdf-btn'),
            pdfFileInput: $('#pdf-file-input'), themeToggle: $('#theme-toggle'),
            iconMoon: $('#icon-moon'), iconSun: $('#icon-sun'),
            editorContainer: $('#editor-container'), layoutToggleBtn: $('#layout-toggle-btn'),
            realtimeToggle: $('#realtime-toggle'), statsDashboard: $('#stats-dashboard'),
            manageDictBtn: $('#manage-dict-btn'), dictionaryModal: $('#dictionary-modal'),
            closeModalBtn: $('#close-modal-btn'), dictListBody: $('#dict-list-body'),
            dictTypoInput: $('#dict-typo-input'), dictCorrectionInput: $('#dict-correction-input'),
            dictAddBtn: $('#dict-add-btn'), correctionPopover: $('#correction-popover'),
            acceptAllBtn: $('#accept-all-btn'), fontSizeDecreaseBtn: $('#font-size-decrease-btn'),
            fontSizeIncreaseBtn: $('#font-size-increase-btn'), fontSizeDisplay: $('#font-size-display'),
            applyCustomDictBtn: $('#apply-custom-dict-btn'), 
            compareDiffBtn: $('#compare-diff-btn'),
            exportDictHTMLBtn: $('#export-dict-html-btn'),
            exportDictCSVBtn: $('#export-dict-csv-btn'),
            exportDictRTFBtn: $('#export-dict-rtf-btn'),
            importDictBtn: $('#import-dict-btn'), importDictInput: $('#import-dict-input'),
            dictDeleteAllBtn: $('#dict-delete-all-btn'),
            dictSearchInput: $('#dict-search-input'), dictSearchCount: $('#dict-search-count'),
            dictSearchPrevBtn: $('#dict-search-prev-btn'), dictSearchNextBtn: $('#dict-search-next-btn'),
        };

        const builtInTypoMap = {"一攻":"一工","一宮":"一工"};
        
        let customDictionary = JSON.parse(localStorage.getItem('customCorrectionDictionary')) || {};
        let isSyncingScroll = false;
        let typoCounter = 0;
        
        const FONT_SIZE_DEFAULT = 16;
        const FONT_SIZE_STEP = 2;
        const FONT_SIZE_MIN = 10;
        const FONT_SIZE_MAX = 32;
        let currentFontSize = parseInt(localStorage.getItem('editorFontSize')) || FONT_SIZE_DEFAULT;
        
        let currentSort = { key: null, direction: 'asc' };
        let searchState = { results: [], currentIndex: -1, term: '' };

        const updateFontSize = (newSize) => {
            const clampedSize = Math.max(FONT_SIZE_MIN, Math.min(FONT_SIZE_MAX, newSize));
            currentFontSize = clampedSize;
            elements.inputText.style.fontSize = `${clampedSize}px`;
            elements.outputDiv.style.fontSize = `${clampedSize}px`;
            elements.fontSizeDisplay.textContent = `${clampedSize}px`;
            localStorage.setItem('editorFontSize', clampedSize);
        };

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        
        const getCombinedTypoMap = () => ({ ...builtInTypoMap, ...customDictionary });

        const checkTypos = () => {
            elements.loader.classList.add('visible');
            const text = elements.inputText.innerText.replace(/(\r\n|\n){3,}/g, '\n\n');
            const combinedMap = getCombinedTypoMap();
            
            const activeTypos = Object.keys(combinedMap).sort((a, b) => b.length - a.length);
            
            if (activeTypos.length === 0) {
                elements.outputDiv.innerHTML = text.replace(/\n/g, '<br>');
                updateStats(text, 0);
                elements.loader.classList.remove('visible');
                return;
            }

            const regex = new RegExp(activeTypos.map(e => e.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|'), 'g');
            const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
            let matchCount = 0;
            typoCounter = 0;

            const highlightedInputHtml = safeText.replace(regex, (matchedTypo) => {
                const id = typoCounter++;
                matchCount++;
                return `<span class="typo original-typo" data-id="${id}" data-original="${matchedTypo}">${matchedTypo}</span>`;
            });
            
            typoCounter = 0;
            const correctedHtml = safeText.replace(regex, (matchedTypo) => {
                const id = typoCounter++;
                const correction = combinedMap[matchedTypo];
                return `<span class="typo corrected" data-id="${id}" data-original="${matchedTypo}" data-correction="${correction}">${correction}</span>`;
            });

            setTimeout(() => {
                elements.inputText.innerHTML = highlightedInputHtml.replace(/\n/g, '<br>');
                elements.outputDiv.innerHTML = correctedHtml.replace(/\n/g, '<br>');
                updateStats(text, matchCount);
                elements.loader.classList.remove('visible');
            }, 300);
        };
        const debouncedCheckTypos = debounce(checkTypos, 500);

        const updateStats = (text, typoCount) => {
            const wordCount = text.trim().length;
            elements.statsDashboard.innerHTML = `<span>總字數: <span class="stat-word-count">${wordCount}</span> | 發現錯字: <span class="stat-typo-count">${typoCount}</span></span>`;
        };
        
        const showCorrectionPopover = (target) => {
            const { id, original } = target.dataset;
            const combinedMap = getCombinedTypoMap();
            const correction = combinedMap[original] || original;

            elements.correctionPopover.style.display = 'flex';
            const rect = target.getBoundingClientRect();
            elements.correctionPopover.style.left = `${rect.left + window.scrollX}px`;
            elements.correctionPopover.style.top = `${rect.bottom + window.scrollY + 5}px`;
            $('.popover-suggestion').innerHTML = `原文: <strong>${original}</strong> → 建議: <strong>${correction}</strong>`;
            $('.popover-buttons').innerHTML = `<button class="mac-button" data-action="accept" data-id="${id}">採納</button><button class="mac-button mac-button-secondary" data-action="ignore" data-id="${id}">忽略</button>`;
        };

        const hideCorrectionPopover = () => { elements.correctionPopover.style.display = 'none'; };

        const handleCorrection = (id, action) => {
            const originalSpan = $(`#input-text .typo[data-id='${id}']`);
            const correctedSpan = $(`#output-div .typo[data-id='${id}']`);
            if (originalSpan && correctedSpan) {
                const textToKeep = action === 'accept' ? correctedSpan.dataset.correction : originalSpan.dataset.original;
                originalSpan.replaceWith(document.createTextNode(textToKeep));
                correctedSpan.replaceWith(document.createTextNode(textToKeep));
            }
            hideCorrectionPopover();
            updateStats(elements.inputText.innerText, $$('.typo.original-typo').length);
        };
        
        const renderDictionary = () => {
            let dictionaryItems = Object.keys(customDictionary).map(typo => ({ typo, correction: customDictionary[typo] }));

            if (currentSort.key) {
                dictionaryItems.sort((a, b) => {
                    const valA = a[currentSort.key] || '';
                    const valB = b[currentSort.key] || '';
                    const comparison = valA.localeCompare(valB, 'zh-Hans-CN');
                    return currentSort.direction === 'asc' ? comparison : -comparison;
                });
            }

            elements.dictListBody.innerHTML = dictionaryItems.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.typo}</td>
                    <td>${item.correction}</td>
                    <td><button class="icon-button delete-btn" data-typo="${item.typo}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></td>
                </tr>
            `).join('');

            elements.dictListBody.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const keyToRemove = e.currentTarget.dataset.typo;
                    delete customDictionary[keyToRemove];
                    localStorage.setItem('customCorrectionDictionary', JSON.stringify(customDictionary));
                    renderDictionary();
                };
            });
            
            performSearch();
        };

        const syncScroll = (source, target) => {
            if (isSyncingScroll) return;
            isSyncingScroll = true;
            const percentage = source.scrollTop / (source.scrollHeight - source.clientHeight);
            target.scrollTop = percentage * (target.scrollHeight - target.clientHeight);
            setTimeout(() => { isSyncingScroll = false; }, 50);
        };

        const clearSearch = () => {
            $$('#dict-table .search-highlight').forEach(el => el.classList.remove('search-highlight', 'current-search'));
            searchState.results = [];
            searchState.currentIndex = -1;
            elements.dictSearchCount.textContent = '0 / 0';
        };

        const performSearch = () => {
            const searchTerm = elements.dictSearchInput.value.trim().toLowerCase();
            clearSearch();
            searchState.term = searchTerm;

            if (searchTerm === '') return;

            const cells = $$('#dict-list-body td:nth-child(2), #dict-list-body td:nth-child(3)');
            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(searchTerm)) {
                    cell.classList.add('search-highlight');
                    searchState.results.push(cell);
                }
            });

            if (searchState.results.length > 0) {
                searchState.currentIndex = 0;
                const currentCell = searchState.results[searchState.currentIndex];
                currentCell.classList.add('current-search');
                currentCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                elements.dictSearchCount.textContent = `${searchState.currentIndex + 1} / ${searchState.results.length}`;
            }
        };
        
        const navigateSearch = (direction) => {
            if (searchState.results.length === 0) return;
            
            searchState.results[searchState.currentIndex].classList.remove('current-search');
            
            if (direction === 'next') {
                searchState.currentIndex = (searchState.currentIndex + 1) % searchState.results.length;
            } else {
                searchState.currentIndex = (searchState.currentIndex - 1 + searchState.results.length) % searchState.results.length;
            }

            const currentCell = searchState.results[searchState.currentIndex];
            currentCell.classList.add('current-search');
            currentCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            elements.dictSearchCount.textContent = `${searchState.currentIndex + 1} / ${searchState.results.length}`;
        };


        elements.checkBtn.addEventListener('click', checkTypos);
        elements.clearBtn.addEventListener('click', () => {
            elements.inputText.innerHTML = '';
            elements.outputDiv.innerHTML = '';
            updateStats('', 0);
        });
        
        elements.inputText.addEventListener('input', () => {
            updateStats(elements.inputText.innerText, $$('.typo.original-typo').length);
            if (elements.realtimeToggle.checked) debouncedCheckTypos();
        });
        
        elements.inputText.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
        });

        elements.layoutToggleBtn.addEventListener('click', () => {
            elements.editorContainer.classList.toggle('layout-vertical');
        });

        elements.inputText.addEventListener('scroll', () => syncScroll(elements.inputText, elements.outputDiv));
        elements.outputDiv.addEventListener('scroll', () => syncScroll(elements.outputDiv, elements.inputText));

        document.body.addEventListener('click', (e) => {
            const typoEl = e.target.closest('.typo');
            const popoverButtonEl = e.target.closest('.popover-buttons button');
            if (typoEl) {
                showCorrectionPopover(typoEl);
                return;
            }
            if (popoverButtonEl) {
                const { action, id } = popoverButtonEl.dataset;
                if (action === 'accept' || action === 'ignore') handleCorrection(id, action);
                return;
            }
            if (!e.target.closest('#correction-popover')) hideCorrectionPopover();
        });
        
        elements.compareDiffBtn.addEventListener('click', () => {
            const correctedSpans = $$('#output-div .typo.corrected');

            if (correctedSpans.length === 0) {
                alert('沒有偵測到任何自動修正的差異可供比對。\n請先執行「開始校正」。');
                return;
            }

            const csvRows = ['"序號","原文","修正後"'];
            
            correctedSpans.forEach((span, index) => {
                const original = span.dataset.original;
                const correction = span.innerText;
                
                const escapedOriginal = `"${original.replace(/"/g, '""')}"`;
                const escapedCorrection = `"${correction.replace(/"/g, '""')}"`;
                csvRows.push(`${index + 1},${escapedOriginal},${escapedCorrection}`);
            });
            
            const csvContent = '\uFEFF' + csvRows.join('\n');
            downloadFile(csvContent, '文字修正比對報告.csv', 'text/csv;charset=utf-8;');
        });

        elements.acceptAllBtn.addEventListener('click', () => {
            $$('#output-div .typo.corrected').forEach(span => {
                const id = span.dataset.id;
                const originalSpan = $(`#input-text .typo[data-id='${id}']`);
                const textToKeep = span.dataset.correction;
                if(originalSpan) originalSpan.replaceWith(document.createTextNode(textToKeep));
                span.replaceWith(document.createTextNode(textToKeep));
            });
            updateStats(elements.inputText.innerText, 0);
        });
        
        elements.manageDictBtn.addEventListener('click', () => {
            renderDictionary();
            elements.dictionaryModal.classList.add('visible');
        });
        elements.closeModalBtn.addEventListener('click', () => elements.dictionaryModal.classList.remove('visible'));
        
        const addDictEntry = () => {
            const typo = elements.dictTypoInput.value.trim();
            const correction = elements.dictCorrectionInput.value.trim();
            
            if (!typo || !correction) return;

            if (builtInTypoMap.hasOwnProperty(typo)) {
                alert(`詞彙 "${typo}" 已存在於內建詞典中，無法新增。`);
                return;
            }

            if (customDictionary.hasOwnProperty(typo)) {
                alert(`詞彙 "${typo}" 已存在於您的自訂詞典中。`);
                return;
            }

            customDictionary[typo] = correction;
            localStorage.setItem('customCorrectionDictionary', JSON.stringify(customDictionary));
            renderDictionary();
            elements.dictTypoInput.value = '';
            elements.dictCorrectionInput.value = '';
            elements.dictTypoInput.focus();
        };

        elements.dictAddBtn.addEventListener('click', addDictEntry);
        elements.dictCorrectionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addDictEntry();
        });
        
        elements.applyCustomDictBtn.addEventListener('click', () => {
            let text = elements.inputText.innerText;
            const customKeys = Object.keys(customDictionary).sort((a, b) => b.length - a.length);
            if(customKeys.length === 0) return;
            const regex = new RegExp(customKeys.map(e => e.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|'), 'g');
            text = text.replace(regex, (matched) => customDictionary[matched]);
            elements.inputText.innerText = text;
            if(elements.realtimeToggle.checked) checkTypos();
        });

        const getROCDateFilenamePrefix = () => {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `逐字稿校正系統自訂詞典${rocYear}${month}${day}`;
        };

        const downloadFile = (content, fileName, mimeType) => {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        };

        const encodeRTFUnicode = (str) => {
            let result = '';
            for (const char of str) {
                const charCode = char.charCodeAt(0);
                if ('{}\\\''.includes(char)) {
                    result += `\\${char}`;
                } else if (charCode > 127) {
                    result += `\\u${charCode}?`;
                } else {
                    result += char;
                }
            }
            return result;
        };

        elements.exportDictHTMLBtn.addEventListener('click', () => {
            if(Object.keys(customDictionary).length === 0) {
                alert('自訂詞典是空的！');
                return;
            }
            let htmlContent = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>逐字稿校正詞典</title><style>body{font-family:sans-serif;padding:1em;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}</style></head><body><h1>自訂校正詞典</h1><table id="dict-export-table"><thead><tr><th>錯別字</th><th>校正字</th></tr></thead><tbody>`;
            for(const typo in customDictionary) {
                htmlContent += `<tr><td>${typo}</td><td>${customDictionary[typo]}</td></tr>`;
            }
            htmlContent += `</tbody></table></body></html>`;
            downloadFile(htmlContent, `${getROCDateFilenamePrefix()}.html`, 'text/html');
        });

        elements.exportDictCSVBtn.addEventListener('click', () => {
            if (Object.keys(customDictionary).length === 0) {
                alert('自訂詞典是空的！');
                return;
            }
            const csvRows = ['"錯別字","校正字"'];
            for (const typo in customDictionary) {
                const escapedTypo = `"${typo.replace(/"/g, '""')}"`;
                const escapedCorrection = `"${customDictionary[typo].replace(/"/g, '""')}"`;
                csvRows.push(`${escapedTypo},${escapedCorrection}`);
            }
            const csvContent = '\uFEFF' + csvRows.join('\n');
            downloadFile(csvContent, `${getROCDateFilenamePrefix()}.csv`, 'text/csv;charset=utf-8;');
        });
        
        elements.exportDictRTFBtn.addEventListener('click', () => {
            if (Object.keys(customDictionary).length === 0) {
                alert('自訂詞典是空的！');
                return;
            }
            let rtfContent = '{\\rtf1\\ansi\\ansicpg950\\deff0{\\fonttbl{\\f0\\fnil\\fcharset136 Microsoft JhengHei;}}\\pard\\sa200\\sl276\\slmult1\\f0\\fs24 ';
            rtfContent += '\\trowd \\trgaph108\\ql\\clbrdrb\\brdrs\\brdrw10 \\clbrdrl\\brdrs\\brdrw10 \\clbrdrr\\brdrs\\brdrw10 \\clbrdrt\\brdrs\\brdrw10 \\cellx4500\\ql\\clbrdrb\\brdrs\\brdrw10 \\clbrdrl\\brdrs\\brdrw10 \\clbrdrr\\brdrs\\brdrw10 \\clbrdrt\\brdrs\\brdrw10 \\cellx9000 ';
            rtfContent += `\\pard\\intbl\\b ${encodeRTFUnicode('錯別字')}\\b0\\cell\\b ${encodeRTFUnicode('校正字')}\\b0\\cell\\row`;
            for (const typo in customDictionary) {
                rtfContent += '\\trowd \\trgaph108\\ql\\clbrdrb\\brdrs\\brdrw10 \\clbrdrl\\brdrs\\brdrw10 \\clbrdrr\\brdrs\\brdrw10 \\clbrdrt\\brdrs\\brdrw10 \\cellx4500\\ql\\clbrdrb\\brdrs\\brdrw10 \\clbrdrl\\brdrs\\brdrw10 \\clbrdrr\\brdrs\\brdrw10 \\clbrdrt\\brdrs\\brdrw10 \\cellx9000 ';
                rtfContent += `\\pard\\intbl ${encodeRTFUnicode(typo)}\\cell ${encodeRTFUnicode(customDictionary[typo])}\\cell\\row`;
            }
            rtfContent += '}';
            downloadFile(rtfContent, `${getROCDateFilenamePrefix()}.rtf`, 'application/rtf');
        });
        
        elements.importDictBtn.addEventListener('click', () => elements.importDictInput.click());
        elements.importDictInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            const extension = file.name.split('.').pop().toLowerCase();

            reader.onload = (event) => {
                const fileData = event.target.result;
                let importCount = 0;

                try {
                    if (extension === 'html') {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(fileData, 'text/html');
                        const table = doc.getElementById('dict-export-table');
                        if(!table) throw new Error('HTML 檔案格式不符。');
                        
                        const rows = table.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if(cells.length >= 2) {
                                const typo = cells[0].innerText.trim();
                                const correction = cells[1].innerText.trim();
                                if(typo && correction) {
                                    customDictionary[typo] = correction;
                                    importCount++;
                                }
                            }
                        });
                    } else if (extension === 'csv') {
                        const lines = fileData.split(/\r\n|\n/);
                        lines.forEach((line, index) => {
                            if(index === 0 && (line.includes('錯別字') || line.includes('typo'))) return;
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                const typo = parts[0].trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                                const correction = parts[1].trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                                if (typo && correction) {
                                    customDictionary[typo] = correction;
                                    importCount++;
                                }
                            }
                        });
                    } else if (['xlsx', 'xls'].includes(extension)) {
                         if (typeof XLSX === 'undefined') {
                            throw new Error('Excel讀取功能所需的程式庫 (XLSX) 尚未載入。');
                        }
                        const workbook = XLSX.read(fileData, { type: 'binary' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        const startIndex = (data.length > 0 && data[0][0] && (data[0][0].includes('錯別字') || String(data[0][0]).toLowerCase().includes('typo'))) ? 1 : 0;

                        for (let i = startIndex; i < data.length; i++) {
                            const row = data[i];
                            if (row && row.length >= 2 && row[0] && row[1]) {
                                 const typo = String(row[0]).trim();
                                 const correction = String(row[1]).trim();
                                 if (typo && correction) {
                                     customDictionary[typo] = correction;
                                     importCount++;
                                 }
                            }
                        }
                    } else {
                        throw new Error('不支援的檔案格式。請選擇 .html, .csv, .xlsx, 或 .xls 檔案。');
                    }
                    localStorage.setItem('customCorrectionDictionary', JSON.stringify(customDictionary));
                    renderDictionary();
                    alert(`成功匯入 ${importCount} 個詞條！`);

                } catch (error) {
                    alert(`匯入失敗：${error.message}`);
                }
            };
            
            reader.onerror = () => alert('讀取檔案失敗。');

            if (['xlsx', 'xls'].includes(extension)) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file, 'utf-8');
            }
            
            e.target.value = null;
        });

        elements.dictDeleteAllBtn.addEventListener('click', () => {
            if (Object.keys(customDictionary).length === 0) {
                alert('自訂詞典已經是空的！');
                return;
            }
            if (confirm('確定要刪除所有自訂詞彙嗎？此操作無法復原。')) {
                customDictionary = {};
                localStorage.setItem('customCorrectionDictionary', JSON.stringify(customDictionary));
                renderDictionary();
                alert('已刪除所有自訂詞彙。');
            }
        });

        elements.fontSizeIncreaseBtn.addEventListener('click', () => updateFontSize(currentFontSize + FONT_SIZE_STEP));
        elements.fontSizeDecreaseBtn.addEventListener('click', () => updateFontSize(currentFontSize - FONT_SIZE_STEP));

        elements.dictSearchInput.addEventListener('input', debounce(performSearch, 300));
        elements.dictSearchNextBtn.addEventListener('click', () => navigateSearch('next'));
        elements.dictSearchPrevBtn.addEventListener('click', () => navigateSearch('prev'));

        $$('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sortKey;
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'asc';
                }
                $$('.sortable-header').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                renderDictionary();
            });
        });

        const setupExistingFeatures = () => {
            elements.copyBtn.addEventListener('click', () => {
                const originalButtonSpan = elements.copyBtn.querySelector('span');
                const originalText = originalButtonSpan.textContent;
                navigator.clipboard.writeText(elements.outputDiv.innerText).then(() => {
                    originalButtonSpan.textContent = '已複製！';
                    setTimeout(() => { originalButtonSpan.textContent = originalText; }, 2000);
                }, () => {
                    originalButtonSpan.textContent = '複製失敗';
                    setTimeout(() => { originalButtonSpan.textContent = originalText; }, 2000);
                });
            });

            elements.downloadBtn.addEventListener('click', () => {
                const outputText = elements.outputDiv.innerText;
                if (!outputText) return;
                let rtfContent = '{\\rtf1\\ansi\\ansicpg950\\deff0{\\fonttbl{\\f0\\fnil\\fcharset136 Microsoft JhengHei;}}\\pard\\sa200\\sl276\\slmult1\\f0\\fs24 ';
                for (let char of outputText) {
                    const charCode = char.charCodeAt(0);
                    if (char === '\n') rtfContent += '\\par\n';
                    else if ('{}\\\''.includes(char)) rtfContent += `\\${char}`;
                    else if (charCode > 127) rtfContent += `\\u${charCode}?`;
                    else rtfContent += char;
                }
                rtfContent += '}';
                const blob = new Blob([rtfContent], { type: 'application/rtf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = '校正後文字.rtf'; a.click();
                URL.revokeObjectURL(url);
            });
            
            elements.importPdfBtn.addEventListener('click', () => elements.pdfFileInput.click());
            elements.pdfFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || file.type !== 'application/pdf') return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    elements.loader.classList.add('visible');
                    try {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
                        const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                        }
                        elements.inputText.innerText = fullText.trim();
                        if(elements.realtimeToggle.checked) checkTypos();
                        else updateStats(fullText.trim(), 0);
                    } catch (error) {
                        alert('無法讀取 PDF 檔案。可能已損毀、加密或因瀏覽器安全限制，建議在本機伺服器環境下執行。');
                    } finally {
                        elements.loader.classList.remove('visible');
                        event.target.value = null; 
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            const toggleTheme = () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                elements.iconMoon.style.display = isDarkMode ? 'none' : 'block';
                elements.iconSun.style.display = isDarkMode ? 'block' : 'none';
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            };

            elements.themeToggle.addEventListener('click', toggleTheme);
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.body.classList.add('dark-mode');
            }
            const isDarkMode = document.body.classList.contains('dark-mode');
            elements.iconMoon.style.display = isDarkMode ? 'none' : 'block';
            elements.iconSun.style.display = isDarkMode ? 'block' : 'none';
        };

        setupExistingFeatures();
        updateFontSize(currentFontSize);
        updateStats('', 0);
    });
    </script>
</body>
</html>
