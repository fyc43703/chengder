<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逐字稿校正系統 (Pro)</title>
    
    <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ==== 基礎與主題設定 ==== */
        :root {
            --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        html, body {
            margin: 0; padding: 0; line-height: 1.6; font-size: 15px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: #f5f5f7; color: #1d1d1f; transition: background-color 0.3s ease, color 0.3s ease; overflow-x: hidden;
        }
        body.dark-mode {
            background-color: #1e1e1e; color: #f5f5f7;
        }

        /* ==== 視窗容器 ==== */
        .window-container {
            width: 90vw; max-width: 1400px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); overflow: hidden;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            transition: background-color 0.3s ease; position: absolute; top: 1vh; left: 50%; transform: translateX(-50%);
        }
        body.dark-mode .window-container {
            background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(70, 70, 70, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        /* ==== 內容與標題 ==== */
        .content-wrapper { padding: 24px; }
        .main-header {
            display: flex; justify-content: space-between; align-items: center; padding-top: 4px; margin-bottom: 24px;
        }
        .header-side-panel { flex: 1; }
        .header-side-panel:last-of-type { display: flex; justify-content: flex-end; }
        .header-center-panel { flex: 2; text-align: center; }
        
        .main-title { font-size: 1.6rem; font-weight: 700; letter-spacing: -0.02em; color: #007aff; }
        body.dark-mode .main-title { color: #0A84FF; }
        .subtitle { font-size: 0.9rem; color: #6e6e73; margin: 0; line-height: 1.3; }
        body.dark-mode .subtitle { color: #a1a1a6; }

        .traffic-lights { display: flex; gap: 8px; }
        .traffic-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-red { background-color: #ff5f57; } .dot-yellow { background-color: #ffbd2e; } .dot-green { background-color: #27c93f; }
        .theme-toggle {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.05); transition: all 0.2s var(--ease-out);
        }
        .theme-toggle:hover { background-color: rgba(0, 0, 0, 0.1); transform: scale(1.1); }
        body.dark-mode .theme-toggle { background-color: rgba(255, 255, 255, 0.1); }
        body.dark-mode .theme-toggle:hover { background-color: rgba(255, 255, 255, 0.2); }
        .theme-icon { width: 16px; height: 16px; }

        /* ==== 編輯區塊 ==== */
        .editor-container { display: flex; flex-direction: row; gap: 24px; transition: flex-direction 0.3s var(--ease-out); }
        .editor-container.layout-vertical { flex-direction: column; }
        .editor-box {
            flex: 1; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%);
            border-radius: 10px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); transition: background-color 0.3s ease; display: flex; flex-direction: column;
        }
        body.dark-mode .editor-box { background: rgba(60, 60, 60, 0.5); border: 1px solid rgba(80, 80, 80, 0.1); }
        .editor-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding-bottom: 12px; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;}
        body.dark-mode .editor-header { border-bottom-color: rgba(255, 255, 255, 0.1); }
        
        .editor-box h3 {
            margin: 0; padding: 0; border: none; font-weight: 600; font-size: 1.125rem; color: #007aff; display: flex; align-items: center; gap: 8px;
        }
        body.dark-mode .editor-box h3 { color: #0A84FF; }
        .input-area-note { font-size: 0.85rem; font-weight: 400; color: #1d1d1f; }
        body.dark-mode .input-area-note { color: #a1a1a6; }
        .controls-group { display: flex; gap: 12px; }

        .input-div, .output-div {
            width: 100%; height: 450px; flex-grow: 1; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 12px 16px;
            line-height: 1.7; box-sizing: border-box; resize: vertical; background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease; white-space: pre-wrap; 
            overflow-y: scroll;
            font-family: 'SF Mono', 'Menlo', 'Consolas', 'Courier New', monospace; text-align: justify;
        }
        .input-div { color: #1d1d1f; }
        body.dark-mode .input-div { background-color: rgba(30, 30, 30, 0.7); color: #f5f5f7; border-color: rgba(255, 255, 255, 0.15); }
        .input-div:empty::before { content: attr(data-placeholder); color: #a1a1a6; pointer-events: none; }
        body.dark-mode .input-div:empty::before { color: #6e6e73; }
        .output-div { color: #007aff; }
        body.dark-mode .output-div { background-color: rgba(30, 30, 30, 0.7); color: #0A84FF; border-color: rgba(255, 255, 255, 0.15); }
        .input-div:focus, .output-div:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }

        .typo {
            cursor: pointer; border-radius: 4px; padding: 1px 3px; font-weight: bold; transition: background-color 0.2s;
        }
        .typo:hover { background-color: rgba(0, 122, 255, 0.2) !important; }
        .original-typo { color: #155724; background-color: #d4edda; }
        body.dark-mode .original-typo { color: #7ee292; background-color: rgba(40, 167, 69, 0.2); }
        .corrected { color: #ff3b30; background-color: rgba(255, 59, 48, 0.1); }
        body.dark-mode .corrected { color: #ff453a; background-color: rgba(255, 69, 58, 0.15); }
        
        .correction-popover {
            position: absolute; background-color: #fff; border: 1px solid #d2d2d7; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px; padding: 12px; z-index: 1001; display: none; flex-direction: column; gap: 8px; font-size: 14px;
            animation: fadeIn 0.2s var(--ease-out);
        }
        body.dark-mode .correction-popover { background-color: #333; border-color: #555; }
        .popover-suggestion { margin-bottom: 4px; }
        .popover-buttons { display: flex; gap: 8px; }

        .mac-button {
            padding: 8px 16px; font-size: 14px; font-weight: 500; color: #ffffff; background-color: #007aff; border: none;
            border-radius: 8px; cursor: pointer; transition: all 0.2s var(--ease-out); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .mac-button:hover { background-color: #0056b3; transform: scale(1.05); }
        .mac-button:active { transform: scale(0.98); }
        .mac-button svg { width: 16px; height: 16px; }
        .mac-button-secondary { background-color: #8e8e93; }
        .mac-button-secondary:hover { background-color: #636366; }
        .mac-button-accent { background-color: #ff9500; }
        .mac-button-accent:hover { background-color: #d97e00; }
        .mac-button-success { background-color: #28a745; }
        .mac-button-success:hover { background-color: #218838; }
        
        .icon-button { 
            background-color: transparent; border: none; padding: 4px; border-radius: 6px; color: #8e8e93; 
            display: flex; align-items: center; gap: 6px;
        }
        .icon-button:hover { background-color: rgba(0, 0, 0, 0.05); color: #1d1d1f; }
        body.dark-mode .icon-button { color: #a1a1a6; }
        body.dark-mode .icon-button:hover { background-color: rgba(255, 255, 255, 0.1); color: #f5f5f7; }
        
        .feature-settings { display: flex; align-items: center; gap: 16px; margin-top: 16px; margin-bottom: 16px; }
        .setting-item { 
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
            font-weight: 600;
        }
        .stats-dashboard { 
            font-size: 0.85rem; color: #6e6e73; white-space: nowrap;
            margin-left: auto;
        }
        body.dark-mode .stats-dashboard { color: #a1a1a6; }
        .font-size-display { font-weight: 600; min-width: 3ch; text-align: center; color: #1d1d1f; }
        body.dark-mode .font-size-display { color: #f5f5f7; }
        
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #007aff; }
        input:checked + .slider:before { transform: translateX(14px); }

        .feature-explanation-container { margin-top: 32px; display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 24px; }
        .feature-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.4)); border-radius: 12px;
            padding: 24px; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s var(--ease-out), box-shadow 0.3s var(--ease-out);
        }
        .feature-card:hover { transform: translateY(-6px); box-shadow: 0 8px 12px rgba(0, 0, 0, 0.07), 0 20px 30px rgba(0, 0, 0, 0.07); }
        body.dark-mode .feature-card {
            background: linear-gradient(145deg, rgba(60, 60, 60, 0.7), rgba(40, 40, 40, 0.5)); border: 1px solid rgba(80, 80, 80, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .feature-card:hover { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15), 0 20px 35px rgba(0, 0, 0, 0.15); }
        .feature-card .feature-icon { width: 48px; height: 48px; margin-bottom: 16px; }
        .feature-card h4 { font-size: 1.125rem; font-weight: 600; color: #007aff; margin: 0 0 8px 0; }
        body.dark-mode .feature-card h4 { color: #0A84FF; }
        .feature-card p { font-size: 0.95rem; color: #6e6e73; line-height: 1.6; }
        body.dark-mode .feature-card p { color: #a1a1a6; }
        .text-apple-blue { color: #007aff; font-weight: 600; }
        body.dark-mode .text-apple-blue { color: #0A84FF; }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245, 247, 250, 0.5); backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%); display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        body.dark-mode .overlay { background: rgba(30, 30, 30, 0.5); }
        .overlay.visible { opacity: 1; visibility: visible; }
        .spinner {
            width: 48px; height: 48px; border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #007aff; border-radius: 50%; animation: spin 1s linear infinite;
        }
        body.dark-mode .spinner { border-color: rgba(255, 255, 255, 0.1); border-left-color: #007aff; }
        .modal {
            background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); padding: 24px; width: 90%; max-width: 500px;
            animation: fadeIn 0.3s var(--ease-out);
        }
        body.dark-mode .modal { background-color: #333; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h4 { margin: 0; font-size: 1.2rem; }
        .modal-body #dict-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border: 1px solid #d2d2d7; border-radius: 8px; }
        body.dark-mode .modal-body #dict-list { border-color: #555; }
        #dict-list li { padding: 8px 12px; border-bottom: 1px solid #d2d2d7; display: flex; justify-content: space-between; align-items: center; }
        body.dark-mode #dict-list li { border-bottom-color: #555; }
        #dict-list li:last-child { border-bottom: none; }
        .modal-footer { margin-top: 16px; display: flex; gap: 8px; }
        .modal-footer input { flex-grow: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #d2d2d7; }
        body.dark-mode .modal-footer input { background-color: #555; border-color: #777; color: #fff; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        @media (max-width: 1024px) {
            .editor-container:not(.layout-vertical) { flex-direction: column; }
            .input-div, .output-div { height: 350px; }
        }
        @media (max-width: 768px) {
            .window-container { width: 95vw; }
            .main-header { flex-wrap: wrap; justify-content: center; }
            .header-center-panel { flex-basis: 100%; order: 2; }
            .header-side-panel:first-of-type { order: 1; }
            .header-side-panel:last-of-type { order: 3; }
            .main-title { font-size: 1.5rem; }
            .subtitle { font-size: 0.85rem; }
            .editor-header { flex-direction: column; align-items: flex-start; }
            .feature-settings { flex-wrap: wrap; }
            .stats-dashboard { margin-left: 0; flex-basis: 100%; text-align: right; }
        }
    </style>
</head>
<body>
    <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;">
    <div id="loader" class="overlay"><div class="spinner"></div></div>
    <div id="dictionary-modal" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <h4>自訂詞典</h4>
                <button id="close-modal-btn" class="icon-button" title="關閉"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px;height:20px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body">
                <p style="font-size:14px; color:#6e6e73; margin-top:0; margin-bottom:12px;">此處的詞彙將不會被標示為錯字。</p>
                <ul id="dict-list"></ul>
            </div>
            <div class="modal-footer">
                <input type="text" id="dict-add-input" placeholder="新增詞彙...">
                <button id="dict-add-btn" class="mac-button">新增</button>
            </div>
        </div>
    </div>
    <div id="correction-popover" class="correction-popover">
        <div class="popover-suggestion"></div>
        <div class="popover-buttons"></div>
    </div>

    <div class="window-container">
        <div class="content-wrapper">
            <header class="main-header">
                <div class="header-side-panel"><div class="traffic-lights"><div class="traffic-dot dot-red"></div><div class="traffic-dot dot-yellow"></div><div class="traffic-dot dot-green"></div></div></div>
                <div class="header-center-panel">
                    <h1 class="main-title">逐字稿校正系統</h1>
                    <h2 class="subtitle">系統比對應用程式內建的詞庫，標示出可能的錯別字，惟辨識準確度非 100% ，請務必人工複核</h2>
                    <h3 class="subtitle">製作者：陳政德</h3>
                </div>
                <div class="header-side-panel">
                     <div id="theme-toggle" class="theme-toggle" title="切換明暗主題">
                        <svg id="icon-moon" class="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                        <svg id="icon-sun" class="theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12H.75m.386-6.364l1.591 1.591M12 6.375a5.625 5.625 0 100 11.25 5.625 5.625 0 000-11.25z" /></svg>
                    </div>
                </div>
            </header>
            
            <div class="feature-settings">
                <div class="setting-item"><label for="realtime-toggle">即時校正</label><label class="switch"><input type="checkbox" id="realtime-toggle"><span class="slider"></span></label></div>
                <div class="setting-item"><span>版面模式</span><button id="layout-toggle-btn" class="icon-button" title="切換並排/上下模式"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.75 5H8.25C6.45507 5 5 6.45507 5 8.25V15.75C5 17.5449 6.45507 19 8.25 19H15.75C17.5449 19 19 17.5449 19 15.75V8.25C19 6.45507 17.5449 5 15.75 5Z" stroke="#78787a" stroke-width="1.5"/><path d="M12 5V19" stroke="#5d61f1" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 12H19" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12H9" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 8H19" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 8H9" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 16H19" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 16H9" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
                <div class="setting-item"><button id="manage-dict-btn" class="icon-button" title="管理自訂詞典"><span>管理詞典</span><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.25 4.75C6.25 4.19772 6.69772 3.75 7.25 3.75H16.75C17.3023 3.75 17.75 4.19772 17.75 4.75V19.25C17.75 19.8023 17.3023 20.25 16.75 20.25H7.25C6.69772 20.25 6.25 19.8023 6.25 19.25V4.75Z" stroke="#8a8a8a" stroke-width="1.5"/><path d="M9.75 8.25H14.25" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round"/><path d="M9.75 11.25H14.25" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round"/><path d="M9.75 14.25H12.25" stroke="#37c9f5" stroke-width="1.5" stroke-linecap="round"/><path d="M6.25 4.75H4.75C4.19772 4.75 3.75 5.19772 3.75 5.75V18.25C3.75 18.8023 4.19772 19.25 4.75 19.25H6.25" stroke="#5d61f1" stroke-width="1.5"/></svg></button></div>
                <div class="setting-item">
                    <span>文字大小</span>
                    <button id="font-size-decrease-btn" class="icon-button" title="縮小文字"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:20px;height:20px;"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg></button>
                    <span id="font-size-display" class="font-size-display">16px</span>
                    <button id="font-size-increase-btn" class="icon-button" title="放大文字"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:20px;height:20px;"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg></button>
                </div>
                <div id="stats-dashboard" class="stats-dashboard"><span>總字數: 0 | 發現錯字: 0</span></div>
            </div>

            <div id="editor-container" class="editor-container">
                <div class="editor-box">
                    <div class="editor-header">
                        <h3>文章輸入區：<span class="input-area-note">※文字間空格請刪除</span></h3>
                        <div class="controls-group">
                             <button id="import-pdf-btn" class="mac-button mac-button-accent" title="從電腦匯入 PDF 檔案"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><span>匯入PDF</span></button>
                            <button id="check-btn" class="mac-button" title="手動執行一次校正"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>開始校正</span></button>
                            <button id="clear-btn" class="mac-button mac-button-secondary" title="清除左右兩邊的所有文字"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.576 0c-.245.035-.488.072-.732.114m15.026 0a48.232 48.232 0 01-4.042-.392M6.343 5.79l-1.246-1.37a1.5 1.5 0 010-2.122l1.246-1.372a1.5 1.5 0 012.122 0l1.246 1.37a1.5 1.5 0 010 2.122l-1.246 1.372a1.5 1.5 0 01-2.122 0z" /></svg><span>清除內容</span></button>
                        </div>
                    </div>
                    <div id="input-text" class="input-div" contenteditable="true" data-placeholder="點擊「匯入PDF」選擇檔案，或直接貼上文字內容進行校正。"></div>
                </div>
                <div class="editor-box">
                    <div class="editor-header">
                        <h3>校正後之文字：</h3>
                        <div class="controls-group">
                            <button id="accept-all-btn" class="mac-button" title="採納所有修正建議"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:20px;height:20px;"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg><span>全部採納</span></button>
                            <button id="copy-btn" class="mac-button" title="複製校正後的純文字內容"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg><span>複製文字</span></button>
                            <button id="download-btn" class="mac-button mac-button-success" title="將校正後的文字下載為 RTF 檔案"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg><span>下載檔案</span></button>
                        </div>
                    </div>
                    <div id="output-div" class="output-div" contenteditable="false" aria-readonly="true"></div>
                </div>
            </div>
            
            <div class="feature-explanation-container">
                <div class="feature-card"><svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#FFD766" d="M40 61H10c-2.21 0-4-1.79-4-4V7c0-2.21 1.79-4 4-4h20l14 14v40c0 2.21-1.79 4-4 4z"></path><path fill="#FFF" d="M30 3h- पॉइंट586L43.586 17H30z" opacity=".5"></path><path fill="#F37E7E" d="M26 21h12v4H26zm0 8h4v4h-4zm-8-4h4v4h-4zm8 12h12v4H26zm-8-4h4v4h-4zm16-8h4v4h-4zm-8-4h12v4H26zm-8 8h4v4h-4zm16 4h4v4h-4zm-8 8h12v4H26z"></path><path fill="#F3A2A2" d="M18 25h4v4h-4zm8-4h4v4h-4zm-8 8h4v4h-4zm8 4h4v4h-4zm-8 8h4v4h-4z"></path><path fill="#5955A5" d="M46 37h12v4H46zm0 8h4v4h-4zm-8-4h4v4h-4zm8 12h12v4H46zm-8-4h4v4h-4zm16-8h4v4h-4zm-8-4h12v4H46zm-8 8h4v4h-4zm16 4h4v4h-4zm-8 8h12v4H46z"></path><path fill="#9FA4F5" d="M38 41h4v4h-4zm8-4h4v4h-4zm-8 8h4v4h-4zm8 4h4v4h-4zm-8 8h4v4h-4z"></path></g></svg>
                    <h4>匯入 PDF 文字</h4><p>點擊 <span class="text-apple-blue">匯入PDF</span> 按鈕，即可從您的電腦選取 PDF 檔案。系統會自動 <span class="text-apple-blue">擷取文件中的文字</span>，並填入左側的「文章輸入區」。</p></div>
                <div class="feature-card"><svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#5955A5" d="M44 61H16c-2.21 0-4-1.79-4-4V7c0-2.21 1.79-4 4-4h32c2.21 0 4 1.79 4 4v28l-12 12v10c0 2.21-1.79 4-4 4z"></path><path fill="#FFF" d="M52 35h- पॉइंट586L40.586 46H52z" opacity=".5"></path><path fill="#FFD766" d="M22 17h20v2H22zm0 8h20v2H22zm0 8h20v2H22zm0 8h12v2H22z"></path><path fill="#9FA4F5" d="M40 45h12v12H40z"></path><path fill="#5955A5" d="M47.333 48.071l-1.414 1.414 2.828 2.828-2.828 2.828 1.414 1.414 2.828-2.828 2.829 2.828 1.414-1.414-2.829-2.828 2.829-2.828-1.414-1.414-2.829 2.828z"></path></g></svg>
                    <h4>智慧互動校正</h4><p>啟用 <span class="text-apple-blue">即時校正</span> 或點擊按鈕，系統會標示錯字。點擊錯字可選擇 <span class="text-apple-blue">採納、忽略或加入自訂詞典</span>，讓校正更精準。</p></div>
                <div class="feature-card"><svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#66B3FF" d="M40 61H10c-2.21 0-4-1.79-4-4V7c0-2.21 1.79-4 4-4h20l14 14v40c0 2.21-1.79 4-4 4z"></path><path fill="#FFF" d="M30 3h- पॉइंट586L43.586 17H30z" opacity=".5"></path><path fill="#2E75B6" d="M22 25h20v2H22zm0 8h20v2H22zm0 8h20v2H22z"></path><g fill="#66B3FF"><path d="M42 37H22a2 2 0 0 1-2-2v-6c0-1.1.9-2 2-2h20a2 2 0 0 1 2 2v6c0 1.1-.9 2-2 2z"></path></g><path fill="#FFFFFF" d="M54 41H34a2 2 0 0 1-2-2v-6c0-1.1.9-2 2-2h20a2 2 0 0 1 2 2v6c0 1.1-.9 2-2 2z"></path><path fill="#2E75B6" d="M38 35h12v2H38zm0 4h12v2H38z"></path></g></svg>
                    <h4>成果匯出與分享</h4><p>完成校正後，您可以點擊 <span class="text-apple-blue">複製文字</span>，或點選 <span class="text-apple-blue">下載檔案</span>，將結果儲存為一份格式化的 <span class="text-apple-blue">RTF 文件</span>，方便編輯與分享。</p></div>
                <div class="feature-card"><svg class="feature-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g fill-rule="evenodd"><path fill="#9FA4F5" d="M61 32c0 16.016-12.984 29-29 29S3 48.016 3 32 15.984 3 32 3s29 12.984 29 29"></path><path fill="#FFD766" d="M56.485 32c0-9.04-4.887-17.008-12.243-21.213C39.54 3.067 31.022 0 22 0 9.85 0 0 9.85 0 22c0 9.022 3.067 17.54 7.787 22.242C11.992 49.113 20 53.999 29 54c12.15 0 22-9.85 22-22 0-2.073-.304-4.066-.828-5.945C54.02 24.34 56.485 28.536 56.485 32z"></path><g fill="#F37E7E"><path d="M28 20l-4 4-4-4 4-4zM24 28l-4 4-4-4 4-4zM32 28l-4 4-4-4 4-4z"></path></g></g></svg>
                    <h4>舒適個人化體驗</h4><p>自由切換 <span class="text-apple-blue">明亮與暗黑主題</span>、<span class="text-apple-blue">並排與上下版面</span>，並透過同步滾動提升比對效率，享受最舒適的視覺與操作體驗。</p></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const elements = {
            inputText: $('#input-text'), outputDiv: $('#output-div'), loader: $('#loader'),
            checkBtn: $('#check-btn'), clearBtn: $('#clear-btn'), copyBtn: $('#copy-btn'),
            downloadBtn: $('#download-btn'), importPdfBtn: $('#import-pdf-btn'),
            pdfFileInput: $('#pdf-file-input'), themeToggle: $('#theme-toggle'),
            iconMoon: $('#icon-moon'), iconSun: $('#icon-sun'),
            editorContainer: $('#editor-container'), layoutToggleBtn: $('#layout-toggle-btn'),
            realtimeToggle: $('#realtime-toggle'), statsDashboard: $('#stats-dashboard'),
            manageDictBtn: $('#manage-dict-btn'), dictionaryModal: $('#dictionary-modal'),
            closeModalBtn: $('#close-modal-btn'), dictList: $('#dict-list'),
            dictAddInput: $('#dict-add-input'), dictAddBtn: $('#dict-add-btn'),
            correctionPopover: $('#correction-popover'), acceptAllBtn: $('#accept-all-btn'),
            fontSizeDecreaseBtn: $('#font-size-decrease-btn'),
            fontSizeIncreaseBtn: $('#font-size-increase-btn'),
            fontSizeDisplay: $('#font-size-display'),
        };

        const typoMap = {"回田":"回填","尋解":"巡檢","啟重擊":"起重機","其樓":"騎樓","鬆托":"鬆脫","商者":"傷者","鋼糧":"鋼梁","木林":"睦鄰","副救":"復舊","西煙":"吸菸","羊角":"仰角","帆部":"帆布","補錯":"補充","安見":"案件","離在者":"罹災者","封善":"風扇","共插":"共築","奔灑":"本市","胃拓":"委託","基莊":"基樁","痛績":"統計","境掐":"逕洽","篡屑":"撰寫","一攻":"一工","一宮":"一工","衣工":"一工","衣公":"一工","衣功":"一工","衣攻":"一工","衣宮":"一工","依公":"一工","依功":"一工","依攻":"一工","依宮":"一工","移宮":"一工","醫工":"一工","醫公":"一工","醫功":"一工","醫攻":"一工","一公處":"一工處","不能不能":"不能","不過不過":"不過","什麼什麼":"什麼","今天今天":"今天","然後然後":"然後","就是就是":"就是"};
        
        let customDictionary = JSON.parse(localStorage.getItem('customDictionary')) || [];
        let isSyncingScroll = false;
        let typoCounter = 0;
        
        const FONT_SIZE_DEFAULT = 16;
        const FONT_SIZE_STEP = 2;
        const FONT_SIZE_MIN = 10;
        const FONT_SIZE_MAX = 32;
        let currentFontSize = parseInt(localStorage.getItem('editorFontSize')) || FONT_SIZE_DEFAULT;

        const updateFontSize = (newSize) => {
            const clampedSize = Math.max(FONT_SIZE_MIN, Math.min(FONT_SIZE_MAX, newSize));
            currentFontSize = clampedSize;
            elements.inputText.style.fontSize = `${clampedSize}px`;
            elements.outputDiv.style.fontSize = `${clampedSize}px`;
            elements.fontSizeDisplay.textContent = `${clampedSize}px`;
            localStorage.setItem('editorFontSize', clampedSize);
        };

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const checkTypos = () => {
            elements.loader.classList.add('visible');
            const text = elements.inputText.innerText;
            const activeTypos = Object.keys(typoMap).filter(typo => !customDictionary.includes(typo)).sort((a, b) => b.length - a.length);
            if (activeTypos.length === 0) {
                elements.outputDiv.innerHTML = text.replace(/\n/g, '<br>');
                updateStats(text, 0);
                elements.loader.classList.remove('visible');
                return;
            }
            const regex = new RegExp(activeTypos.join('|'), 'g');
            const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
            let matchCount = 0;
            typoCounter = 0;
            const highlightedInputHtml = safeText.replace(regex, (matchedTypo) => {
                const id = typoCounter++;
                matchCount++;
                return `<span class="typo original-typo" data-id="${id}" data-original="${matchedTypo}">${matchedTypo}</span>`;
            });
            typoCounter = 0;
            const correctedHtml = safeText.replace(regex, (matchedTypo) => {
                const id = typoCounter++;
                const correction = typoMap[matchedTypo];
                return `<span class="typo corrected" data-id="${id}" data-original="${matchedTypo}" data-correction="${correction}">${correction}</span>`;
            });
            setTimeout(() => {
                elements.inputText.innerHTML = highlightedInputHtml.replace(/\n/g, '<br>');
                elements.outputDiv.innerHTML = correctedHtml.replace(/\n/g, '<br>');
                updateStats(text, matchCount);
                elements.loader.classList.remove('visible');
            }, 300);
        };
        const debouncedCheckTypos = debounce(checkTypos, 500);

        const updateStats = (text, typoCount) => {
            const wordCount = text.trim().length;
            elements.statsDashboard.innerHTML = `<span>總字數: ${wordCount} | 發現錯字: ${typoCount}</span>`;
        };
        
        const showCorrectionPopover = (target) => {
            const { id, original, correction } = target.dataset;
            elements.correctionPopover.style.display = 'flex';
            const rect = target.getBoundingClientRect();
            elements.correctionPopover.style.left = `${rect.left + window.scrollX}px`;
            elements.correctionPopover.style.top = `${rect.bottom + window.scrollY + 5}px`;
            $('.popover-suggestion').innerHTML = `原文: <strong>${original}</strong> → 建議: <strong>${correction || original}</strong>`;
            $('.popover-buttons').innerHTML = `<button class="mac-button" data-action="accept" data-id="${id}">採納</button><button class="mac-button mac-button-secondary" data-action="ignore" data-id="${id}">忽略</button><button class="mac-button mac-button-accent" data-action="add-dict" data-original="${original}">加入詞典</button>`;
        };

        const hideCorrectionPopover = () => { elements.correctionPopover.style.display = 'none'; };

        const handleCorrection = (id, action) => {
            const originalSpan = $(`#input-text .typo[data-id='${id}']`);
            const correctedSpan = $(`#output-div .typo[data-id='${id}']`);
            if (originalSpan && correctedSpan) {
                const textToKeep = action === 'accept' ? correctedSpan.dataset.correction : originalSpan.dataset.original;
                originalSpan.replaceWith(document.createTextNode(textToKeep));
                correctedSpan.replaceWith(document.createTextNode(textToKeep));
            }
            hideCorrectionPopover();
            updateStats(elements.inputText.innerText, $$('.typo.original-typo').length);
        };
        
        const renderDictionary = () => {
            elements.dictList.innerHTML = '';
            customDictionary.forEach(word => {
                const li = document.createElement('li');
                li.textContent = word;
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:16px;height:16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                removeBtn.className = 'icon-button';
                removeBtn.onclick = () => {
                    customDictionary = customDictionary.filter(w => w !== word);
                    localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
                    renderDictionary();
                    checkTypos();
                };
                li.appendChild(removeBtn);
                elements.dictList.appendChild(li);
            });
        };

        const syncScroll = (source, target) => {
            if (isSyncingScroll) return;
            isSyncingScroll = true;
            const percentage = source.scrollTop / (source.scrollHeight - source.clientHeight);
            target.scrollTop = percentage * (target.scrollHeight - target.clientHeight);
            setTimeout(() => { isSyncingScroll = false; }, 50);
        };

        elements.checkBtn.addEventListener('click', checkTypos);
        elements.clearBtn.addEventListener('click', () => {
            elements.inputText.innerHTML = '';
            elements.outputDiv.innerHTML = '';
            updateStats('', 0);
        });
        
        elements.inputText.addEventListener('input', () => {
            if (elements.realtimeToggle.checked) debouncedCheckTypos();
        });
        
        // ==== START: 新增貼上事件處理 ====
        elements.inputText.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
        });
        // ==== END: 新增貼上事件處理 ====

        elements.layoutToggleBtn.addEventListener('click', () => {
            elements.editorContainer.classList.toggle('layout-vertical');
        });

        elements.inputText.addEventListener('scroll', () => syncScroll(elements.inputText, elements.outputDiv));
        elements.outputDiv.addEventListener('scroll', () => syncScroll(elements.outputDiv, elements.inputText));

        document.body.addEventListener('click', (e) => {
            const typoEl = e.target.closest('.typo');
            const popoverButtonEl = e.target.closest('.popover-buttons button');
            if (typoEl) {
                showCorrectionPopover(typoEl);
                return;
            }
            if (popoverButtonEl) {
                const { action, id, original } = popoverButtonEl.dataset;
                if (action === 'accept' || action === 'ignore') handleCorrection(id, action);
                else if (action === 'add-dict' && original && !customDictionary.includes(original)) {
                    customDictionary.push(original);
                    localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
                    hideCorrectionPopover();
                    checkTypos();
                }
                return;
            }
            if (!e.target.closest('#correction-popover')) hideCorrectionPopover();
        });

        elements.acceptAllBtn.addEventListener('click', () => {
            $$('.typo.corrected').forEach(span => handleCorrection(span.dataset.id, 'accept'));
        });
        
        elements.manageDictBtn.addEventListener('click', () => {
            renderDictionary();
            elements.dictionaryModal.classList.add('visible');
        });
        elements.closeModalBtn.addEventListener('click', () => elements.dictionaryModal.classList.remove('visible'));
        elements.dictAddBtn.addEventListener('click', () => {
            const word = elements.dictAddInput.value.trim();
            if (word && !customDictionary.includes(word)) {
                customDictionary.push(word);
                localStorage.setItem('customDictionary', JSON.stringify(customDictionary));
                renderDictionary();
                elements.dictAddInput.value = '';
                checkTypos();
            }
        });
        elements.dictAddInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') elements.dictAddBtn.click();
        });
        
        elements.fontSizeIncreaseBtn.addEventListener('click', () => updateFontSize(currentFontSize + FONT_SIZE_STEP));
        elements.fontSizeDecreaseBtn.addEventListener('click', () => updateFontSize(currentFontSize - FONT_SIZE_STEP));

        const setupExistingFeatures = () => {
            elements.copyBtn.addEventListener('click', () => {
                const originalButtonSpan = elements.copyBtn.querySelector('span');
                const originalText = originalButtonSpan.textContent;
                navigator.clipboard.writeText(elements.outputDiv.innerText).then(() => {
                    originalButtonSpan.textContent = '已複製！';
                    setTimeout(() => { originalButtonSpan.textContent = originalText; }, 2000);
                }, () => {
                    originalButtonSpan.textContent = '複製失敗';
                    setTimeout(() => { originalButtonSpan.textContent = originalText; }, 2000);
                });
            });

            elements.downloadBtn.addEventListener('click', () => {
                const outputText = elements.outputDiv.innerText;
                if (!outputText) return;
                let rtfContent = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0\\fnil\\fcharset136 Microsoft JhengHei;}}\\pard\\sa200\\sl276\\slmult1\\f0\\fs24 ';
                for (let char of outputText) {
                    const charCode = char.charCodeAt(0);
                    if (char === '\n') rtfContent += '\\par\n';
                    else if ('{}\\\''.includes(char)) rtfContent += `\\${char}`;
                    else if (charCode > 127) rtfContent += `\\u${charCode}?`;
                    else rtfContent += char;
                }
                rtfContent += '}';
                const blob = new Blob([rtfContent], { type: 'application/rtf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = '校正後文字.rtf'; a.click();
                URL.revokeObjectURL(url);
            });
            
            elements.importPdfBtn.addEventListener('click', () => elements.pdfFileInput.click());
            elements.pdfFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || file.type !== 'application/pdf') return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    elements.loader.classList.add('visible');
                    try {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
                        const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                        }
                        elements.inputText.innerText = fullText.trim();
                        checkTypos();
                    } catch (error) {
                        alert('無法讀取 PDF 檔案。可能已損毀、加密或因瀏覽器安全限制，建議在本機伺服器環境下執行。');
                    } finally {
                        elements.loader.classList.remove('visible');
                        event.target.value = null; 
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            const toggleTheme = () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                elements.iconMoon.style.display = isDarkMode ? 'none' : 'block';
                elements.iconSun.style.display = isDarkMode ? 'block' : 'none';
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            };

            elements.themeToggle.addEventListener('click', toggleTheme);
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.body.classList.add('dark-mode');
            }
            const isDarkMode = document.body.classList.contains('dark-mode');
            elements.iconMoon.style.display = isDarkMode ? 'none' : 'block';
            elements.iconSun.style.display = isDarkMode ? 'block' : 'none';
        };

        setupExistingFeatures();
        updateFontSize(currentFontSize);
    });
    </script>
</body>
</html>
