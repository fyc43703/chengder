<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Podcast探索家手機板</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqN5yI61Rz5oVn2uW/yTzQ1LzW4zLh1tM5hY6k8n+rE8f/a5iK4Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #b3b3b3;
            --player-height: 90px;
            --nav-height: 60px;
        }

        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #f0f0f0;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #65676b;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
        }

        /* 主應用程式容器 */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: calc(var(--player-height) + var(--nav-height));
            box-sizing: border-box;
        }

        /* 主要內容視圖 */
        .app-view {
            display: none; /* 預設隱藏 */
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--color-bg);
            padding: 1rem;
        }
        .app-view.active {
            display: flex; /* 顯示當前視圖 */
            flex-direction: column;
        }
        
        /* 底部導覽列 */
        .bottom-nav {
            position: fixed;
            bottom: var(--player-height);
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--color-surface);
            border-top: 1px solid var(--color-interactive-element);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--color-text-secondary);
            border: none;
            background: none;
            padding: 8px;
            font-size: 0.75rem;
            width: 80px;
        }
        .nav-item.active {
            color: #3b82f6; /* Tailwind blue-500 */
        }

        /* 底部播放器 */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--player-height);
            background-color: var(--color-surface);
            border-top: 1px solid var(--color-interactive-element);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            padding: 0.5rem 1rem;
            gap: 0.25rem;
        }
        .player-info { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        #player-album-art { width: 40px; height: 40px; border-radius: 0.25rem; flex-shrink: 0; }
        .player-controls { display: flex; align-items: center; justify-content: space-evenly; width: 100%; }
        .player-controls button { color: var(--color-text-primary); font-size: 1.25rem; }
        .play-pause-btn { width: 2.5rem; height: 2.5rem; border-radius: 50%; background-color: var(--color-text-primary); color: var(--color-bg); display: flex; align-items: center; justify-content: center; }
        .progress-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; }
        #progress-bar { width: 100%; height: 100%; background-color: var(--color-interactive-element); }
        #progress { height: 100%; background-color: #3b82f6; width: 0%; }

        /* 搜尋視圖 */
        #search-input { background-color: var(--color-interactive-element); border: none; }
        #search-results-podcasts { grid-template-columns: repeat(2, 1fr); gap: 1rem; }

        /* 收藏庫視圖 */
        #library-controls button { background-color: var(--color-interactive-element); }
        #library-controls button.active { background-color: #3b82f6; color: white; }
        #library-items.grid-view { grid-template-columns: repeat(3, 1fr); }
        .sidebar-item { background-color: var(--color-surface); border-radius: 0.5rem; padding: 0.5rem; }
        
        /* 詳情視圖 */
        #detail-view .header { display: flex; align-items: center; gap: 1rem; padding: 1rem 0; }
        .episode-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--color-interactive-element); }
        .episode-item.is-playing-item { color: #3b82f6; }

        /* Spinner */
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-surface-hover); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div class="app-container">
        <!-- 搜尋視圖 -->
        <div id="search-view" class="app-view active">
            <header class="mb-4">
                <h1 class="text-3xl font-bold mb-4">探索</h1>
                <form id="search-form" class="flex gap-2">
                    <input type="text" id="search-input" placeholder="搜尋 Podcast..." class="w-full px-4 py-2 rounded-full text-lg" required>
                    <button type="submit" class="bg-blue-500 text-white px-5 py-2 rounded-full font-semibold">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </header>
            <div id="search-results-podcasts" class="grid flex-grow">
                <p class="col-span-2 text-center text-gray-500 mt-8">尋找您最愛的 Podcast 節目。</p>
            </div>
        </div>

        <!-- 收藏庫視圖 -->
        <div id="library-view" class="app-view">
             <header class="mb-4">
                 <h1 class="text-3xl font-bold">收藏庫</h1>
                 <div id="library-controls" class="flex items-center gap-2 mt-4">
                    <input type="text" id="local-search-input" placeholder="篩選..." class="flex-grow bg-gray-700 px-4 py-2 rounded-full">
                    <button id="view-mode-toggle" class="p-2 rounded-full w-10 h-10"><i class="fas fa-grip"></i></button>
                    <button id="filter-favorites-btn" class="p-2 rounded-full w-10 h-10"><i class="fas fa-heart"></i></button>
                 </div>
            </header>
            <div id="library-items" class="grid grid-cols-1 gap-4"></div>
        </div>

        <!-- Podcast 詳情視圖 -->
        <div id="detail-view" class="app-view">
            <!-- 內容由 JS 動態生成 -->
        </div>
    </div>
    
    <!-- 底部導覽 -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="search-view">
            <i class="fas fa-search text-2xl"></i>
            <span>探索</span>
        </button>
        <button class="nav-item" data-view="library-view">
            <i class="fas fa-layer-group text-2xl"></i>
            <span>收藏庫</span>
        </button>
    </nav>

    <!-- 底部播放器 -->
    <footer class="player" id="player">
        <div class="player-info">
            <img id="player-album-art" src="https://placehold.co/40x40/222/fff?text=P" alt="專輯封面">
            <div class="flex-1 overflow-hidden">
                <p id="player-title" class="font-bold whitespace-nowrap text-sm truncate">未選擇音訊</p>
                <p id="player-artist" class="text-xs text-gray-400 truncate"></p>
            </div>
            <button id="theme-toggle-btn" class="text-xl w-10 h-10"><i class="fas fa-sun"></i></button>
        </div>
        <div class="player-controls">
            <button id="skip-backward-btn"><i class="fas fa-backward"></i></button>
            <button id="play-pause-btn" class="play-pause-btn">
                <i id="play-pause-icon" class="fas fa-play text-lg"></i>
            </button>
            <button id="skip-forward-btn"><i class="fas fa-forward"></i></button>
        </div>
        <div class="progress-container">
            <div id="progress-bar">
                <div id="progress"></div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CORS 代理服務設定
            const CORS_PROXY = 'https://corsproxy.io/?';

            // DOM 元素
            const views = document.querySelectorAll('.app-view');
            const navItems = document.querySelectorAll('.nav-item');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results-podcasts');
            const libraryItemsContainer = document.getElementById('library-items');
            const detailViewContainer = document.getElementById('detail-view');
            
            const player = document.getElementById('player');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            const playerAlbumArt = document.getElementById('player-album-art');
            const progress = document.getElementById('progress');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');

            const audio = new Audio();
            const collectionCache = {};
            let playerState = { currentEpisode: null, isPlaying: false };
            let currentView = 'search-view';
            
            // --- 核心功能 ---
            const getCollection = () => JSON.parse(localStorage.getItem('podcastCollection') || '[]');
            const saveCollection = (collection) => localStorage.setItem('podcastCollection', JSON.stringify(collection));

            // 顯示指定視圖
            function showView(viewId) {
                views.forEach(view => view.classList.toggle('active', view.id === viewId));
                navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
                currentView = viewId;
            }
            
            // 搜尋 Podcast
            async function searchPodcasts(term) {
                searchResultsContainer.innerHTML = `<div class="col-span-2 flex justify-center mt-8"><div class="spinner"></div></div>`;
                const searchUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=podcast&entity=podcast&country=TW&limit=20`;

                try {
                    const response = await fetch(searchUrl);
                    if (!response.ok) throw new Error('搜尋請求失敗');
                    const data = await response.json();
                    displaySearchResults(data.results);
                } catch (error) {
                    console.error('搜尋失敗:', error);
                    searchResultsContainer.innerHTML = `<p class="col-span-2 text-center text-red-500">搜尋失敗，請稍後再試。</p>`;
                }
            }
            
            // 顯示搜尋結果
            function displaySearchResults(podcasts) {
                searchResultsContainer.innerHTML = '';
                if (podcasts.length === 0) {
                    searchResultsContainer.innerHTML = `<p class="col-span-2 text-center text-gray-500">找不到相關的 Podcast。</p>`;
                    return;
                }
                podcasts.forEach(podcast => {
                    const item = document.createElement('div');
                    item.className = 'flex flex-col items-center text-center cursor-pointer';
                    item.innerHTML = `
                        <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName}" class="w-full rounded-lg mb-2 aspect-square object-cover">
                        <p class="font-semibold text-sm truncate w-full">${podcast.collectionName}</p>
                        <p class="text-xs text-gray-400 truncate w-full">${podcast.artistName}</p>
                    `;
                    item.addEventListener('click', () => fetchEpisodes(podcast));
                    searchResultsContainer.appendChild(item);
                });
            }

            // 獲取單集列表
            async function fetchEpisodes(podcastInfo) {
                showView('detail-view');
                detailViewContainer.innerHTML = `<div class="flex-grow flex justify-center items-center"><div class="spinner"></div></div>`;

                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(podcastInfo.feedUrl)}`;
                
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                    
                    const parseError = xmlDoc.querySelector("parsererror");
                    if (parseError) throw new Error("無法解析 RSS feed。");

                    const items = Array.from(xmlDoc.querySelectorAll("item")).map(item => ({
                        title: item.querySelector("title")?.textContent || '無標題',
                        audioUrl: item.querySelector("enclosure")?.getAttribute("url"),
                        pubDate: item.querySelector("pubDate")?.textContent
                    })).filter(item => item.audioUrl);
                    
                    displayEpisodes(podcastInfo, items);
                } catch (error) {
                    console.error('獲取單集列表時發生錯誤:', error);
                    detailViewContainer.innerHTML = `
                        <div class="text-center text-red-500 p-4">
                            <p class="font-bold">無法載入單集列表</p>
                            <p class="text-sm mt-2">${error.message}</p>
                            <button id="back-btn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-full">返回</button>
                        </div>`;
                    detailViewContainer.querySelector('#back-btn').addEventListener('click', () => showView('search-view'));
                }
            }
            
            // 顯示單集列表
            function displayEpisodes(podcast, episodes) {
                detailViewContainer.innerHTML = `
                    <div class="header">
                        <button id="back-btn" class="text-2xl"><i class="fas fa-chevron-left"></i></button>
                        <img src="${podcast.artworkUrl100}" class="w-16 h-16 rounded-lg">
                        <div>
                            <h2 class="text-xl font-bold">${podcast.collectionName}</h2>
                            <p class="text-sm text-gray-400">${podcast.artistName}</p>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto">
                        ${episodes.map(ep => `
                            <div class="episode-item" data-url="${ep.audioUrl}" data-title="${ep.title}">
                                <div class="flex-1">
                                    <p class="font-semibold">${ep.title}</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(ep.pubDate).toLocaleDateString()}</p>
                                </div>
                                <button class="play-ep-btn text-2xl text-blue-500"><i class="far fa-play-circle"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                detailViewContainer.querySelector('#back-btn').addEventListener('click', () => showView(currentView));
                detailViewContainer.querySelectorAll('.episode-item').forEach(item => {
                    item.addEventListener('click', () => {
                        playEpisode(item.dataset.url, item.dataset.title, podcast.artworkUrl100, podcast.artistName);
                    });
                });
            }

            // 播放單集
            function playEpisode(url, title, artwork, artist) {
                audio.src = url;
                audio.play();
                playerState = { currentEpisode: { url, title, artwork, artist }, isPlaying: true };
                updatePlayerUI();
            }

            // 更新播放器 UI
            function updatePlayerUI() {
                const { currentEpisode, isPlaying } = playerState;
                if (currentEpisode) {
                    playerTitle.textContent = currentEpisode.title;
                    playerArtist.textContent = currentEpisode.artist;
                    playerAlbumArt.src = currentEpisode.artwork;
                }
                playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'} text-lg`;
            }

            // 切換播放/暫停
            function togglePlayPause() {
                if (!playerState.currentEpisode) return;
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
            }

            // 設定主題
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                localStorage.setItem('theme', theme);
            };

            // --- 事件監聽 ---
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) searchPodcasts(searchTerm);
            });

            navItems.forEach(item => {
                item.addEventListener('click', () => showView(item.dataset.view));
            });

            document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('skip-forward-btn').addEventListener('click', () => audio.currentTime += 15);
            document.getElementById('skip-backward-btn').addEventListener('click', () => audio.currentTime -= 15);

            audio.addEventListener('play', () => {
                playerState.isPlaying = true;
                updatePlayerUI();
            });
            audio.addEventListener('pause', () => {
                playerState.isPlaying = false;
                updatePlayerUI();
            });
            audio.addEventListener('timeupdate', () => {
                if (audio.duration) {
                    progress.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
                }
            });
             audio.addEventListener('ended', () => {
                playerState.isPlaying = false;
                updatePlayerUI();
            });

            themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
            });

            // 初始化
            applyTheme(localStorage.getItem('theme') || 'dark');
            showView('search-view');
        });
    </script>
</body>
</html>
