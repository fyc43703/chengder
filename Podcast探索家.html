<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Podcast探索家</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-light.min.css">
<style>
      /* General Styles */
      html, body {
        margin: 0;
        padding: 24px;
        background: #FFFFFF;
        color: #1d1d1f;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        font-size: 15px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      h1, h2, h3, h4, h5, h6, b, strong {
        font-weight: 600; /* Semibold for macOS look */
      }
      h1 { font-weight: 700; } /* Bold for main title */
      
      /* Explicit list styles for consistent rendering in html2canvas */
      ul, ol { padding-left: 2em; margin-top: 1em; margin-bottom: 1em; }
      ul { list-style-type: disc; }
      ol { list-style-type: decimal; }
      li { display: list-item; }

      .hljs-container {
        padding: 1.5rem;
        border-radius: .75rem;
        overflow-x: auto;
        background: #fcfcfd;
        border: 1px solid #d2d2d7;
      }
      .text-highlight{background:linear-gradient(180deg,transparent 25%,#B3D7FF 25%,#B3D7FF 75%,transparent 75%);padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-multiline{background:linear-gradient(180deg,transparent 25%,#B3D7FF 25%,#B3D7FF 75%,transparent 75%);background-size:100% 1.5em;background-repeat:repeat;padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-error{background:linear-gradient(180deg,transparent 25%,#FFD7D8 25%,#FFD7D8 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#D92525}
      .text-highlight-success{background:linear-gradient(180deg,transparent 25%,#D4EDDA 25%,#D4EDDA 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#155724}
    </style></head><body><div style="max-width:1200px;margin:0 auto"><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast探索家</title>
    <!-- 引入 Tailwind CSS 確保響應式設計和現代化外觀 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqN5yI61Rz5oVn2uW/yTzQ1LzW4zLh1tM5hY6k8n+rE8f/a5iK4Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 自定義樣式 */
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #b3b3b3;
            --player-height: 60px;
        }

        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #e4e6e9;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #65676b;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 20rem 1fr;
            height: 100vh;
            padding-top: 0;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            padding-bottom: var(--player-height);
            gap: 0.5rem;
            box-sizing: border-box;
        }
        
        /* 播放器 CSS */
        .player { position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-height); background-color: var(--color-surface); border-top: 1px solid var(--color-border, #282828); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; gap: 1rem; }
        .player-info { flex: 1 1 30%; display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        #player-album-art { width: 40px; height: 40px; border-radius: 0.25rem; flex-shrink: 0; }
        .player-controls-wrapper { flex: 1 1 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 0; gap: 0.1rem; }
        .player-actions-wrapper { flex: 1 1 30%; display: flex; align-items: center; justify-content: flex-end; gap: 1rem; }
        .player button, .player a { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 0; line-height: 1; }
        .player button:hover, .player a:hover { color: var(--color-text-primary); }
        .playback-controls { display: flex; align-items: center; gap: 1.25rem; }
        .simple-control-btn { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; transition: color 0.2s; font-size: 1rem; }
        .simple-control-btn:hover { color: var(--color-text-primary); }
        .detail-nav-btn { color: #A0C4FF; font-size: 1.5rem !important; }
        .detail-nav-btn:hover { color: #8EB8FF; }
        .play-pause-btn { width: 2rem; height: 2rem; border-radius: 50%; background-color: white; color: black; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: transform 0.2s, box-shadow 0.2s; }
        .play-pause-btn:hover { transform: scale(1.1); }
        .play-pause-btn:active { transform: scale(0.95); }
        .play-pause-btn i { color: #A0C4FF; font-size: 0.875rem; }
        .progress-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
        #download-btn { display: none; color: #27C93F; } /* MODIFIED: Changed color to green */
        #download-btn.is-visible { display: inline-block; }
        #download-btn:hover { color: #22a936; } /* MODIFIED: Changed hover color to darker green */

        /* 側邊欄 */
        .sidebar { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; overflow-y: auto; }
        .library-title-styled { background-color: #007AFF; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; display: inline-block; cursor: pointer; align-self: center; }
        .main-container { display: flex; flex-direction: column; gap: 0.5rem; overflow: hidden; }
        .main-content { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1.5rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #theme-toggle-btn { background-color: transparent !important; color: var(--color-text-secondary); width: 44px; height: 44px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* 側邊欄功能區 */
        .sidebar-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        #local-search-input { background: var(--color-interactive-element); border: none; border-radius: 9999px; padding: 0.5rem 1rem 0.5rem 2.5rem; width: 100%; color: var(--color-text-primary); }
        .view-mode-toggle { display: flex; background: var(--color-interactive-element); padding: 2px; border-radius: 9999px; }
        .view-mode-btn { background: transparent; border: none; color: var(--color-text-secondary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .view-mode-btn.active { background: var(--color-surface-hover); color: var(--color-text-primary); }
        #filter-favorites-btn, #sort-direction-btn { background-color: var(--color-interactive-element); color: var(--color-text-primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        #filter-favorites-btn.active { background-color: #ff3b30; color: white; }

        /* 類別篩選下拉選單 */
        .genre-filter-container { position: relative; margin-bottom: 1rem; }
        #genre-filter-btn { background-color: #007AFF; color: white; border: none; border-radius: 0.5rem; padding: 0.5rem 1rem; width: 100%; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        #genre-filter-list { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--color-surface-hover); border-radius: 0.5rem; margin-top: 0.25rem; max-height: 250px; overflow-y: auto; z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid var(--color-interactive-element); }
        #genre-filter-list a { display: flex; align-items: center; padding: 0.5rem 1rem; color: var(--color-text-primary); text-decoration: none; user-select: none; }
        #genre-filter-list a:hover { background-color: #007AFF; color: white; }
        #genre-filter-list a.dragging { opacity: 0.5; }

        /* 側邊欄項目 */
        #sidebar-items.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.5rem; position: relative; }
        .sidebar-item:hover { background-color: var(--color-surface-hover); }
        .sidebar-item.is-active { background-color: #A0C4FF; color: white; }
        .sidebar-item.is-active .text-xs { color: rgba(255,255,255,0.8); }
        #sidebar-items.grid-view .sidebar-item { flex-direction: column; padding: 0.5rem; height: auto; }
        #sidebar-items.grid-view .sidebar-item-number, #sidebar-items.grid-view .sidebar-item__text-wrapper { display: none; }
        #sidebar-items.grid-view .sidebar-item img { width: 100%; height: auto; aspect-ratio: 1/1; border-radius: 0.5rem; }
        #sidebar-items.grid-view .sidebar-item-actions { top: 0.5rem; right: 0.5rem; transform: none; }
        .sidebar-item-number { width: 1.5rem; text-align: center; color: var(--color-text-secondary); flex-shrink: 0; }
        .sidebar-item-actions { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); display: flex; align-items: center; gap: 0.5rem; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .sidebar-item:hover .sidebar-item-actions, #sidebar-items.grid-view .sidebar-item:hover .sidebar-item-actions { opacity: 1; visibility: visible; }
        .sidebar-action-btn { background-color: rgba(0,0,0,0.5); border: none; color: white; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; }
        .sidebar-action-btn:hover { background-color: #ff3b30; }
        .sidebar-action-btn.fav-btn.is-favorite, .sidebar-action-btn.fav-btn:hover { background-color: #ff3b30; }
        .sidebar-item__text-wrapper { line-height: 1.5; height: calc(1.5em * 2); overflow: hidden; }
        
        /* 搜尋結果 */
        .search-result-item { position: relative; background-color: var(--color-surface-hover); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
        .add-to-fav-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: none; opacity: 0; transform: scale(0.8); z-index: 5; }
        .search-result-item:hover .add-to-fav-btn { opacity: 1; transform: scale(1); }
        .add-to-fav-btn:hover { background-color: #FF453A; }
        .add-to-fav-btn.is-favorite { background-color: #FF453A; opacity: 1; transform: scale(1); }
        
        /* Podcast 詳情 */
        .podcast-header { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
        .podcast-header img { width: 3rem; height: 3rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); flex-shrink: 0; }
        .podcast-episodes { display: flex; flex-direction: column; gap: 0.1rem; flex-grow: 1; overflow-y: auto; }
        .episode-item { position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.6rem 0.5rem; border-radius: 0.25rem; }
        .episode-thumbnail-btn { position: relative; width: 2rem; height: 2rem; border-radius: 0.25rem; flex-shrink: 0; cursor: pointer; overflow: hidden; }
        .episode-thumbnail-btn img { width: 100%; height: 100%; object-fit: cover; }
        .episode-main-content { flex: 1; display: flex; align-items: center; gap: 0.75rem; overflow: hidden; cursor: pointer;}
        .episode-number { width: 2.5rem; text-align: right; padding-right: 1rem; color: var(--color-text-secondary); flex-shrink: 0; font-size: 0.875rem; }
        .episode-item:hover { background-color: var(--color-surface-hover); }
        .episode-item.is-listened .font-semibold, .episode-item.is-listened .text-secondary-color { color: var(--color-text-secondary); }
        .episode-item-actions { display: none; align-items: center; gap: 0.75rem; }
        .episode-action-btn { background-color: transparent; border: 1px solid var(--color-text-secondary); color: var(--color-text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .episode-action-btn:hover { background-color: var(--color-text-secondary); color: var(--color-surface); }
        .episode-action-btn.download-action-link { color: #27C93F; border-color: #27C93F; } /* MODIFIED: Changed color to green */
        .episode-action-btn.download-action-link:hover { background-color: #27C93F; color: white; } /* MODIFIED: Changed hover color to green */
        .episode-item:not(.is-playing-item):hover .episode-metadata { display: none; }
        .episode-item:not(.is-playing-item):hover .episode-item-actions { display: flex; }
        .episode-date { font-size: 0.75rem; color: var(--color-text-secondary); white-space: nowrap; }
        .episode-progress-bar-container { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: var(--color-interactive-element); border-radius: 0 0 0.25rem 0.25rem; overflow: hidden; }
        .episode-progress-bar { height: 100%; background-color: #FF3B30; width: 0%; }
        
        /* 新增載入中動畫樣式 */
        #episodes-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; gap: 1rem; color: var(--color-text-secondary); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-surface-hover); border-top-color: #A0C4FF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .small-spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.4); border-top-color: #ffffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-spinner-overlay { position: absolute; left: 0; top: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }

        /* 播放動畫與狀態 */
        .player-title-container.marquee #player-title { display: inline-block; padding-left: 100%; animation: scroll-text 15s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .sound-icon-container { display: none; align-items: center; justify-content: center; flex-shrink: 0; }
        .player-info .sound-icon-container { margin-left: 0.5rem; }
        .player-info .sound-icon-container.is-playing-icon { display: flex; }
        .player-info .sound-icon-container svg { width: 24px; height: 24px; color: #A0C4FF; }
        @keyframes sound-wave-pulse { 0% { transform: scaleY(0.3); } 30% { transform: scaleY(1); } 60% { transform: scaleY(0.5); } 100% { transform: scaleY(0.3); } }
        .sound-wave { transform-origin: 50% 100%; animation: sound-wave-pulse 1.2s ease-in-out infinite; }
        .sound-wave-1 { animation-delay: 0s; } .sound-wave-2 { animation-delay: 0.2s; } .sound-wave-3 { animation-delay: 0.4s; }
        .episode-item.is-playing-item { background-color: #A0C4FF; color: white; }
        .episode-item.is-playing-item .text-sm, .episode-item.is-playing-item .episode-number, .episode-item.is-playing-item .text-secondary-color { color: rgba(255, 255, 255, 0.85); font-weight: 700; }
        .episode-item.is-playing-item .episode-metadata, .episode-item.is-playing-item:hover .episode-item-actions { display: none; }
        .episode-item.is-playing-item .sound-icon-container { display: flex; }
        .episode-item.is-playing-item .sound-icon-container svg { width: 24px; height: 24px; color: white; }
        
        #volume-tooltip { position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background-color: var(--color-interactive-element); color: var(--color-text-primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: none; white-space: nowrap; pointer-events: none; }
        #volume-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-width: 5px; border-style: solid; border-color: var(--color-interactive-element) transparent transparent transparent; }

        /* 進度條優化 */
        #progress-bar { position: relative; height: 8px; }
        #progress-bar:hover #progress-handle { opacity: 1; }
        #progress-handle { width: 0.75rem; height: 0.75rem; background-color: white; border-radius: 50%; position: absolute; right: 0; top: 50%; transform: translate(50%, -50%); opacity: 0; transition: opacity 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.3); }

        /* Modal 樣式 */
        #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #episode-modal { background-color: var(--color-surface); border-radius: 0.75rem; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: var(--color-interactive-element); border: none; color: var(--color-text-primary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        #modal-description { flex-grow: 1; overflow-y: auto; margin-top: 1rem; line-height: 1.7; }
        #modal-description a { color: #A0C4FF; text-decoration: underline; }

        /* 導航按鈕樣式 */
        .nav-button {
            background-color: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-button:hover { opacity: 0.8; }
        .nav-button:disabled { opacity: 0.3; cursor: not-allowed; }
        .nav-button svg { width: 2.25rem; height: 2.25rem; }

    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="flex items-center gap-2 mb-4">
                <div class="flex items-center gap-1.5 pl-1 flex-shrink-0">
                    <span class="block w-3 h-3 bg-[#FF5F56] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#FFBD2E] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#27C93F] rounded-full"></span>
                </div>
                <h2 id="library-title" class="text-lg font-bold library-title-styled" title="回到首頁">我的私藏Podcast</h2>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="relative flex-grow">
                    <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none z-10"></i>
                    <input type="text" placeholder="搜尋 iTunes..." id="search-input" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 pl-10 pr-4 rounded-full border-none w-full">
                </div>
                <button id="search-btn" class="bg-[#27C93F] text-white py-2 px-4 rounded-full border-none cursor-pointer flex-shrink-0 font-semibold">搜尋</button>
            </div>
            
            <div class="genre-filter-container mt-4">
                <button id="genre-filter-btn">
                    <span id="genre-filter-btn-text">所有類別</span>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>
                <div id="genre-filter-list"></div>
            </div>

            <div class="sidebar-controls">
                <div class="relative flex-grow">
                     <i class="fas fa-filter text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none z-10 text-sm"></i>
                    <input type="text" id="local-search-input" placeholder="篩選收藏庫...">
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <div class="view-mode-toggle" title="切換視圖">
                        <button id="view-mode-list" class="view-mode-btn active"><i class="fas fa-list"></i></button>
                        <button id="view-mode-grid" class="view-mode-btn"><i class="fas fa-grip"></i></button>
                    </div>
                    <button id="filter-favorites-btn" title="只顯示我的最愛">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button id="sort-direction-btn" title="排序">
                        <i id="sort-icon" class="fas fa-arrow-up-wide-short"></i>
                    </button>
                </div>
            </div>

            <div id="sidebar-items" class="flex flex-col mt-2"></div>
        </aside>
        <div class="main-container">
            <div id="app-header" class="bg-[var(--color-surface)] p-2 rounded-lg flex items-center justify-between">
                <div class="flex-1 text-center">
                    <h1 class="text-2xl font-bold">Podcast探索家</h1>
                    <p class="text-sm text-[var(--color-text-primary)]">Podcasts 搜尋使用 Apple iTunes Search API ，能隨時聆聽豐富多元的主題節目，並提供下載音訊檔功能</p>
                    <p class="text-xs text-gray-500 mt-1">製作者：陳政德</p>
                </div>
                <button id="theme-toggle-btn" title="切換主題"></button>
            </div>
            <main class="main-content" id="main-content">
                <div id="default-view" class="flex items-center justify-center h-full"></div>
                <div id="search-results-view" class="flex flex-col overflow-hidden" style="display: none;">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <h2 class="text-2xl font-bold">搜尋結果</h2>
                        <div id="search-pagination-controls" class="flex items-center gap-2"></div>
                    </div>
                    <div id="search-results-podcasts" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 overflow-y-auto"></div>
                </div>
                <div id="podcast-detail-view" class="flex flex-col overflow-hidden" style="display: none;"></div>
            </main>
        </div>
    </div>

    <footer class="player" id="player">
        <div class="player-info">
            <img id="player-album-art" src="https://placehold.co/40x40/222/fff?text=Pod" alt="單集圖片">
            <div class="flex flex-col overflow-hidden">
                <div id="player-title-container" class="player-title-container">
                    <span id="player-title" class="font-bold whitespace-nowrap text-sm" title="尚未播放任何內容">尚未播放任何內容</span>
                </div>
                <span id="player-artist" class="text-xs text-gray-400 truncate"></span>
            </div>
            <div id="sound-icon-container" class="sound-icon-container"></div>
        </div>
        <div class="player-controls-wrapper">
            <div class="playback-controls">
                <button id="playback-rate-btn" class="simple-control-btn" title="播放速度"><span id="playback-rate-text" class="text-xs">1.0x</span></button>
                <button id="skip-backward-btn" class="simple-control-btn" title="倒退 15 秒"><i class="fas fa-rotate-left"></i></button>
                <button id="play-pause-btn" class="play-pause-btn" title="播放/暫停">
                    <i id="play-pause-icon" class="fas fa-play"></i>
                </button>
                <button id="skip-forward-btn" class="simple-control-btn" title="快進 15 秒"><i class="fas fa-rotate-right"></i></button>
                <button id="repeat-btn" class="simple-control-btn" title="重複"><i class="fas fa-repeat"></i></button>
            </div>
            <div class="progress-container">
                <span id="current-time" class="text-xs">0:00</span>
                <div id="progress-bar" class="w-full bg-gray-600 rounded cursor-pointer">
                    <div id="progress" class="h-full bg-[#A0C4FF] rounded relative" style="width: 0%;">
                        <div id="progress-handle"></div>
                    </div>
                </div>
                <span id="duration" class="text-xs">0:00</span>
            </div>
        </div>
        <div class="player-actions-wrapper">
            <a id="download-btn" href="#" download title="下載音檔">
                <i class="fas fa-download text-base"></i>
            </a>
            <div id="volume-container" class="relative flex items-center">
                <button id="volume-icon-btn" class="simple-control-btn mr-1"><i class="fas fa-volume-high text-base"></i></button>
                <span id="volume-tooltip">30%</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" class="w-72" title="調整音量">
            </div>
        </div>
    </footer>
    
    <!-- Modal HTML Structure -->
    <div id="modal-overlay">
        <div id="episode-modal">
            <button id="modal-close-btn" title="關閉"><i class="fas fa-times"></i></button>
            <div class="flex items-start gap-4 flex-shrink-0">
                <img id="modal-artwork" src="" class="w-24 h-24 rounded-lg flex-shrink-0">
                <div class="flex-1">
                    <p id="modal-date" class="text-xs text-gray-400 mb-1"></p>
                    <h3 id="modal-title" class="text-lg font-bold"></h3>
                    <p id="modal-artist" class="text-sm text-gray-300"></p>
                    <button id="modal-play-btn" class="mt-3 bg-[#A0C4FF] text-white font-bold py-2 px-6 rounded-full text-sm">
                        <i class="fas fa-play mr-2"></i>播放
                    </button>
                </div>
            </div>
            <div id="modal-description"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const podcastDetailView = document.getElementById('podcast-detail-view');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const playerTitleContainer = document.getElementById('player-title-container');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            const playerAlbumArt = document.getElementById('player-album-art');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const downloadBtn = document.getElementById('download-btn');
            const playbackRateText = document.getElementById('playback-rate-text');
            const repeatBtn = document.getElementById('repeat-btn');
            const soundIconContainer = document.getElementById('sound-icon-container');
            const sidebarItemsContainer = document.getElementById('sidebar-items');
            const sortDirectionBtn = document.getElementById('sort-direction-btn');
            const sortIcon = document.getElementById('sort-icon');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const filterFavoritesBtn = document.getElementById('filter-favorites-btn');
            const localSearchInput = document.getElementById('local-search-input');
            const viewModeListBtn = document.getElementById('view-mode-list');
            const viewModeGridBtn = document.getElementById('view-mode-grid');
            const genreFilterBtn = document.getElementById('genre-filter-btn');
            const genreFilterList = document.getElementById('genre-filter-list');
            const genreFilterBtnText = document.getElementById('genre-filter-btn-text');
            
            // Modal elements
            const modalOverlay = document.getElementById('modal-overlay');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalPlayBtn = document.getElementById('modal-play-btn');

            const soundIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect class="sound-wave sound-wave-1" x="4" y="8" width="4" height="8" rx="1"></rect><rect class="sound-wave sound-wave-2" x="10" y="5" width="4" height="14" rx="1"></rect><rect class="sound-wave sound-wave-3" x="16" y="8" width="4" height="8" rx="1"></rect></svg>`;
            const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>`;
            const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>`;
            
            const audio = new Audio();
            const collectionCache = {};
            let playerState = { currentEpisode: null, playlist: [], currentIndex: -1, isPlaying: false, playbackRate: 1.0, isRepeating: false, _playbackAttempt: 'direct' };
            let isFavoritesFilterActive = false;
            let currentGenreFilter = 'All';
            let isFetchingDetails = false;
            let lastProgressUpdateTime = 0;
            let currentViewSource = 'sidebar';
            let searchState = { term: '', results: [], currentIndex: -1, offset: 0, limit: 50 };

            const GENRES = {
                'All': '所有類別', 'True Crime': '犯罪紀實', 'Comedy': '喜劇', 'Society & Culture': '社會與文化', 'News': '新聞', 
                'Health & Fitness': '健康與瘦身', 'Sports': '運動', 'Business': '商業', 'Education': '教育', 'Arts': '藝術', 
                'Science': '科學', 'History': '歷史', 'Religion & Spirituality': '宗教與精神生活', 'Kids & Family': '兒童與家庭', 
                'Music': '音樂', 'TV & Film': '電視與電影', 'Technology': '科技', 'Leisure': '休閒', 'Fiction': '小說', 'Government': '政府'
            };

            const getCollection = () => JSON.parse(localStorage.getItem('podcastCollection') || '[]');
            const saveCollection = (collection) => localStorage.setItem('podcastCollection', JSON.stringify(collection));

            const getPlaybackProgress = () => JSON.parse(localStorage.getItem('playbackProgress') || '{}');
            const savePlaybackProgress = (episodeId, currentTime, duration) => {
                if (!episodeId || !duration) return;
                const progressData = getPlaybackProgress();
                progressData[episodeId] = { currentTime, duration };
                localStorage.setItem('playbackProgress', JSON.stringify(progressData));
            };

            const loadCollection = () => {
                sidebarItemsContainer.innerHTML = '';
                let collection = getCollection();

                if (isFavoritesFilterActive) {
                    collection = collection.filter(p => p.isFavorite);
                }

                if (currentGenreFilter !== 'All') {
                    // MODIFIED: Changed from '===' to 'includes()' for smart filtering
                    collection = collection.filter(p => p.primaryGenreName && p.primaryGenreName.includes(currentGenreFilter));
                }

                const isAsc = sortIcon.classList.contains('fa-arrow-up-wide-short');
                collection.sort((a, b) => isAsc ? a.collectionName.localeCompare(b.collectionName, 'zh-Hant') : b.collectionName.localeCompare(a.collectionName, 'zh-Hant'));
                
                collection.forEach((podcast, index) => renderCollectionItem(podcast, index + 1));
            };

            const addToCollection = (podcast) => {
                const collection = getCollection();
                if (!collection.some(p => p.collectionId === podcast.collectionId)) {
                    collection.unshift({ ...podcast, addedAt: Date.now(), isFavorite: false });
                    saveCollection(collection);
                    loadCollection();
                    updateSearchItemUI(podcast.collectionId, true);
                }
            };

            const removeFromCollection = (collectionId) => {
                let collection = getCollection().filter(p => p.collectionId !== collectionId);
                saveCollection(collection);
                loadCollection();
                updateSearchItemUI(collectionId, false);
            };

            const toggleFavoriteStatus = (collectionId) => {
                let collection = getCollection();
                const podcast = collection.find(p => p.collectionId === collectionId);
                if (podcast) {
                    podcast.isFavorite = !podcast.isFavorite;
                    saveCollection(collection);
                    loadCollection();
                }
            };
            
            function renderCollectionItem(podcast, number) {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.dataset.id = podcast.collectionId;
                item.title = `${podcast.collectionName} - ${podcast.artistName}`;
                const trashSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.144-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.057-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                const heartIconClass = podcast.isFavorite ? 'fas' : 'far';
                item.innerHTML = `<span class="sidebar-item-number">${number}</span><img src="${podcast.artworkUrl600}" alt="" class="w-12 h-12 rounded-full flex-shrink-0"><div class="flex-1 overflow-hidden sidebar-item__text-wrapper"><div class="font-semibold text-sm">${podcast.collectionName}</div><div class="text-xs text-gray-400">${podcast.artistName}</div></div><div class="sidebar-item-actions"><button class="sidebar-action-btn fav-btn ${podcast.isFavorite ? 'is-favorite' : ''}" title="標記為最愛"><i class="${heartIconClass} fa-heart"></i></button><button class="sidebar-action-btn" title="從收藏移除">${trashSVG}</button></div>`;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.sidebar-item-actions')) return;
                    document.querySelector('.sidebar-item.is-active')?.classList.remove('is-active');
                    item.classList.add('is-active');
                    currentViewSource = 'sidebar';
                    fetchEpisodes(podcast.collectionId);
                });
                const [favBtn, deleteBtn] = item.querySelectorAll('.sidebar-action-btn');
                favBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFavoriteStatus(podcast.collectionId); });
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromCollection(podcast.collectionId); });
                sidebarItemsContainer.appendChild(item);
            }

            function updateSearchItemUI(collectionId, isCollected) {
                const searchItemBtn = document.querySelector(`.add-to-fav-btn[data-id="${collectionId}"]`);
                if (searchItemBtn) {
                    searchItemBtn.classList.toggle('is-favorite', isCollected);
                    searchItemBtn.querySelector('i').className = isCollected ? 'fas' : 'far';
                }
            }
            
            async function searchPodcasts(term, newOffset = 0) {
                const showView = (v) => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById(v).style.display='flex'; };
                if (!term) { showView('default-view'); return; }
                showView('search-results-view');
                const container = document.getElementById('search-results-podcasts');
                container.innerHTML = `<div class="w-full flex justify-center mt-8"><div class="spinner"></div></div>`;
                document.getElementById('search-pagination-controls').innerHTML = ''; // Clear pagination
                try {
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=podcast&country=TW&limit=${searchState.limit}&offset=${newOffset}`);
                    const data = await res.json();
                    
                    searchState.term = term;
                    searchState.offset = newOffset;
                    searchState.results = data.results;

                    container.innerHTML = !data.results.length ? '<p class="col-span-full text-center text-gray-400">沒有找到相關播客。</p>' : '';
                    const collection = getCollection();
                    data.results.forEach((podcast, index) => {
                        const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `<button class="add-to-fav-btn ${isCollected ? 'is-favorite' : ''}" data-id="${podcast.collectionId}" title="加入/移除收藏"><i class="${isCollected ? 'fas' : 'far'} fa-heart"></i></button><img src="${podcast.artworkUrl600}" class="w-full rounded-lg mb-2 shadow-lg"><span class="font-bold text-sm truncate w-full" title="${podcast.collectionName}">${podcast.collectionName}</span><span class="text-xs text-gray-400 truncate w-full" title="${podcast.artistName}">${podcast.artistName}</span>`;
                        item.addEventListener('click', () => {
                            currentViewSource = 'search';
                            searchState.currentIndex = index;
                            fetchEpisodes(podcast.collectionId);
                        });
                        const favBtn = item.querySelector('.add-to-fav-btn');
                        favBtn.addEventListener('click', (e) => { e.stopPropagation(); favBtn.classList.contains('is-favorite') ? removeFromCollection(podcast.collectionId) : addToCollection(podcast); });
                        container.appendChild(item);
                    });
                    renderPaginationControls();
                } catch (error) { container.innerHTML = '<p class="text-center text-gray-400">搜尋失敗。請稍後再試。</p>'; }
            }
            
            async function getPodcastInfo(collectionId) {
                if (collectionCache[collectionId] && collectionCache[collectionId].feedUrl) return collectionCache[collectionId];
                const res = await fetch(`https://itunes.apple.com/lookup?id=${collectionId}&country=TW`);
                if (!res.ok) throw new Error(`iTunes API request failed: ${res.status}`);
                const data = await res.json();
                if (data.resultCount === 0 || !data.results[0].feedUrl) throw new Error('Podcast not found or has no feed URL.');
                collectionCache[collectionId] = data.results[0];
                return data.results[0];
            }
            
            async function fetchWithTimeout(resource, options = {}) {
                const { timeout = 10000 } = options; // 10 second default timeout
                const controller = new AbortController();
                const id = setTimeout(() => {
                    controller.abort();
                }, timeout);

                try {
                    const response = await fetch(resource, {
                        ...options,
                        signal: controller.signal  
                    });
                    return response;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error(`請求超時 (超過 ${timeout/1000} 秒)`);
                    }
                    throw error;
                } finally {
                    clearTimeout(id);
                }
            }

            async function parseFeed(feedUrl, podcastInfo) {
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(feedUrl)}`;
                try {
                    console.log(`[Feed Parser] Attempting to fetch feed via corsproxy.io...`);
                    const res = await fetchWithTimeout(proxyUrl, { timeout: 10000 });
                    if (!res.ok) {
                        throw new Error(`代理伺服器回應錯誤，狀態碼: ${res.status}。代理可能暫時失效或來源 Feed 無效。`);
                    }
                    
                    const xmlText = await res.text();
                    const doc = new DOMParser().parseFromString(xmlText, "application/xml");
                    
                    if (doc.querySelector("parsererror")) {
                        throw new Error('解析 XML 失敗。來源 Feed 格式可能不正確。');
                    }
                    
                    const episodes = Array.from(doc.querySelectorAll("item")).map(item => {
                        const enclosure = item.querySelector("enclosure");
                        if (!enclosure || !enclosure.getAttribute("url")) return null;
                        return {
                            trackId: item.querySelector("guid")?.textContent || enclosure.getAttribute("url"),
                            trackName: item.querySelector("title")?.textContent || 'Untitled Episode',
                            episodeUrl: enclosure.getAttribute("url"),
                            releaseDate: item.querySelector("pubDate")?.textContent || new Date().toISOString(),
                            description: item.querySelector("description")?.textContent || '',
                            artworkUrl60: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl60,
                            artworkUrl600: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl600,
                            duration: item.querySelector("itunes\\:duration, duration")?.textContent || 0,
                            fileSize: enclosure.getAttribute("length") || 0,
                        };
                    }).filter(Boolean);
                    
                    if (episodes.length === 0) {
                        throw new Error('成功解析 RSS Feed，但未找到任何包含音訊檔案的有效單集。');
                    }
                    
                    console.log(`[Feed Parser] SUCCESS: Parsed ${episodes.length} episodes via corsproxy.io.`);
                    return episodes;

                } catch (error) {
                    console.error(`[Feed Parser] FAILED: ${error.message}`);
                    throw new Error(`無法載入 Feed: ${error.message}`);
                }
            }

            async function fetchEpisodes(collectionId) {
                if (isFetchingDetails) return;
                isFetchingDetails = true;
                const showView = (v) => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById(v).style.display = 'flex'; };
                showView('podcast-detail-view');
                
                try {
                    const podcastInfo = await getPodcastInfo(collectionId);
                    renderPodcastShell(podcastInfo);
                    if (podcastInfo.episodes) {
                        populateEpisodesList(podcastInfo.episodes, podcastInfo);
                    } else {
                        const episodes = await parseFeed(podcastInfo.feedUrl, podcastInfo);
                        if (!episodes || episodes.length === 0) throw new Error("No valid episodes were found in the feed after all attempts.");
                        collectionCache[collectionId].episodes = episodes;
                        populateEpisodesList(episodes, podcastInfo);
                    }
                } catch (error) {
                    console.error(`[CRITICAL] Failed to load podcast (ID: ${collectionId}):`, error);
                    podcastDetailView.innerHTML = `<div class="text-center text-[var(--color-text-secondary)] m-auto"><p class="font-bold text-lg mb-2">無法載入節目資訊</p><p class="text-sm">${error.message}</p><p class="text-xs mt-2">提示：請檢查網路連線，或嘗試暫時關閉廣告攔截擴充功能。</p></div>`;
                } finally {
                    isFetchingDetails = false;
                }
            }

            function renderPodcastShell(podcast) {
                const collection = getCollection();
                const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                const btnText = isCollected ? '✓ 已收藏' : '收藏';
                const btnColor = isCollected ? '#6c757d' : '#27C93F';
                const btnDisabled = isCollected ? 'disabled' : '';
                
                let navHeaderHTML = '';
                if (currentViewSource === 'search') {
                    navHeaderHTML = `
                        <div id="detail-view-nav" class="flex items-center justify-between mb-4 flex-shrink-0">
                            <button id="detail-nav-back" class="nav-button" title="返回搜尋結果">
                                <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M22 18H12M12 18L17 13M12 18L17 23" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <div class="flex items-center gap-4">
                                <button id="detail-nav-prev-podcast" class="nav-button" title="上一個節目">
                                     <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M20.25 24L14.25 18L20.25 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                <button id="detail-nav-next-podcast" class="nav-button" title="下一個節目">
                                    <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M15.75 12L21.75 18L15.75 24" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                        </div>`;
                }

                const tooltipText = `節目名稱：${podcast.collectionName}\n主持人：${podcast.artistName}\n類型：${podcast.primaryGenreName}\n單集總數：${podcast.trackCount}`;
                podcastDetailView.innerHTML = `
                    ${navHeaderHTML}
                    <div class="podcast-header">
                        <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName} cover" title="${tooltipText}">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl font-bold truncate">${podcast.collectionName}</h1>
                                <button id="add-to-collection-btn" style="background-color: ${btnColor};" class="text-white font-bold py-1 px-3 rounded-full text-sm ml-4 flex-shrink-0" ${btnDisabled}>${btnText}</button>
                            </div>
                            <p class="text-sm mt-1 truncate">${podcast.artistName}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 mb-2">
                        <h2 class="text-xl font-bold">最新單集</h2>
                        <div class="flex items-center gap-4">
                            <button id="detail-prev-btn" class="simple-control-btn detail-nav-btn" title="上一集"><i class="fas fa-backward-step"></i></button>
                            <button id="detail-next-btn" class="simple-control-btn detail-nav-btn" title="下一集"><i class="fas fa-forward-step"></i></button>
                        </div>
                    </div>
                    <div id="episodes-placeholder"><div class="spinner"></div><p>正在載入節目...</p></div>`;
                
                if (currentViewSource === 'search') {
                    document.getElementById('detail-nav-back').addEventListener('click', () => {
                         document.getElementById('podcast-detail-view').style.display = 'none';
                         document.getElementById('search-results-view').style.display = 'flex';
                    });
                    document.getElementById('detail-nav-prev-podcast').addEventListener('click', navigatePodcastInSearch(-1));
                    document.getElementById('detail-nav-next-podcast').addEventListener('click', navigatePodcastInSearch(1));
                    updateDetailNav();
                }

                const collectBtn = document.getElementById('add-to-collection-btn');
                if (collectBtn && !isCollected) {
                    collectBtn.addEventListener('click', () => {
                        addToCollection(podcast);
                        collectBtn.textContent = '✓ 已收藏';
                        collectBtn.disabled = true;
                        collectBtn.style.backgroundColor = '#6c757d';
                    });
                }
                document.getElementById('detail-prev-btn').addEventListener('click', () => playNextPrev(-1));
                document.getElementById('detail-next-btn').addEventListener('click', () => playNextPrev(1));
            }

            function populateEpisodesList(episodes, podcast) {
                const placeholder = document.getElementById('episodes-placeholder');
                if (!placeholder) return;
                const escapeAttr = (str) => String(str || '').replace(/"/g, '&quot;');
                const progressData = getPlaybackProgress();

                const episodesHTML = episodes.slice(0, 50).map((ep, index) => {
                    const durationFormatted = formatDuration(ep.duration);
                    const sizeFormatted = formatFileSize(ep.fileSize);
                    
                    const progress = progressData[ep.trackId];
                    const progressPercent = progress && progress.duration ? (progress.currentTime / progress.duration) * 100 : 0;
                    const isListened = progressPercent > 95;

                    return `
                    <div class="episode-item ${isListened ? 'is-listened' : ''}" data-episode-id="${escapeAttr(ep.trackId)}">
                        <span class="episode-number">${index + 1}</span>
                        <div class="episode-thumbnail-btn">
                           <img src="${ep.artworkUrl60 || podcast.artworkUrl60}" alt="Episode thumbnail">
                           <div class="loading-spinner-overlay"><div class="small-spinner"></div></div>
                        </div>
                        <div class="episode-main-content">
                             <div class="flex-1 overflow-hidden">
                                <div class="font-semibold truncate text-base" title="${escapeAttr(ep.trackName)}">${ep.trackName}</div>
                            </div>
                        </div>
                        <div class="episode-metadata flex items-center gap-4">
                            <span class="text-xs text-[var(--color-text-secondary)] whitespace-nowrap w-16 text-right">${sizeFormatted || '--- MB'}</span>
                            <span class="text-xs text-[var(--color-text-secondary)] whitespace-nowrap w-12 text-right">${durationFormatted || '--:--'}</span>
                            <span class="episode-date">${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</span>
                        </div>
                        <div class="episode-item-actions">
                            <a href="${ep.episodeUrl}" download="${escapeAttr(ep.trackName)}.mp3" class="episode-action-btn download-action-link" title="下載"><i class="fas fa-download"></i></a>
                        </div>
                        <div class="sound-icon-container">${soundIconSVG}</div>
                        <div class="episode-progress-bar-container">
                            <div class="episode-progress-bar" style="width: ${progressPercent}%;"></div>
                        </div>
                    </div>`}).join('');
                placeholder.outerHTML = `<div class="podcast-episodes">${episodesHTML}</div>`;

                podcastDetailView.querySelectorAll('.episode-item').forEach(item => {
                    const ep = episodes.find(e => e.trackId === item.dataset.episodeId);
                    if (!ep) return;
                    item.querySelector('.episode-main-content').addEventListener('click', () => playEpisode(ep, podcast.artistName, episodes));
                    item.querySelector('.episode-thumbnail-btn').addEventListener('click', (e) => { e.stopPropagation(); openEpisodeModal(ep, podcast, episodes); });
                    item.querySelector('.download-action-link')?.addEventListener('click', (e) => e.stopPropagation());
                });
                syncPlayerUI();
            }
            
            function openEpisodeModal(episode, podcast, playlist) {
                document.getElementById('modal-artwork').src = episode.artworkUrl600 || podcast.artworkUrl600;
                document.getElementById('modal-date').textContent = new Date(episode.releaseDate).toLocaleDateString();
                document.getElementById('modal-title').textContent = episode.trackName;
                document.getElementById('modal-artist').textContent = podcast.artistName;
                document.getElementById('modal-description').innerHTML = episode.description;
                modalPlayBtn.onclick = () => { playEpisode(episode, podcast.artistName, playlist); modalOverlay.style.display = 'none'; };
                modalOverlay.style.display = 'flex';
            }

            const syncPlayerUI = () => {
                const { currentEpisode, isPlaying, playbackRate, isRepeating } = playerState;
                playerTitleContainer.classList.toggle('marquee', !!currentEpisode);
                if (currentEpisode) {
                    playerTitle.textContent = currentEpisode.trackName;
                    playerTitle.title = currentEpisode.trackName;
                    playerArtist.textContent = currentEpisode.artistName;
                    playerAlbumArt.src = currentEpisode.artworkUrl600;
                    downloadBtn.href = currentEpisode.episodeUrl;
                    downloadBtn.setAttribute('download', `${(currentEpisode.trackName || 'download').replace(/[/\\?%*:|"<>]/g, '-')}.mp3`);
                    downloadBtn.classList.add('is-visible');
                } else {
                    playerTitle.textContent = '尚未播放任何內容';
                    playerTitle.title = '尚未播放任何內容';
                    playerArtist.textContent = '';
                    playerAlbumArt.src = 'https://placehold.co/40x40/222/fff?text=Pod';
                    downloadBtn.classList.remove('is-visible');
                }
                soundIconContainer.classList.toggle('is-playing-icon', isPlaying && !!currentEpisode);
                document.querySelector('.episode-item.is-playing-item')?.classList.remove('is-playing-item');
                if (isPlaying && currentEpisode) { document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`)?.classList.add('is-playing-item'); }
                playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
                playbackRateText.textContent = `${playbackRate.toFixed(1)}x`;
                repeatBtn.style.color = isRepeating ? '#A0C4FF' : 'var(--color-text-secondary)';
            };
            
            const playEpisode = (episode, host, playlist) => {
                if (playerState.currentEpisode?.trackId === episode.trackId) {
                    togglePlayPause();
                    return;
                }

                const episodeItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(episode.trackId))}"]`);
                const spinnerContainer = episodeItem?.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');
                
                document.querySelectorAll('.loading-spinner-overlay').forEach(spinner => spinner.style.display = 'none');
                if (spinnerContainer) spinnerContainer.style.display = 'flex';
                
                playerState = {
                    ...playerState,
                    currentEpisode: { ...episode, artistName: host },
                    playlist: playlist,
                    currentIndex: playlist.findIndex(e => e.trackId === episode.trackId),
                    isPlaying: true,
                    _playbackAttempt: 'direct' // Reset attempt state for new episode
                };

                console.log(`[Player] Attempt 1 (Direct): ${episode.episodeUrl}`);
                audio.src = episode.episodeUrl;
                
                const progressData = getPlaybackProgress();
                const savedProgress = progressData[episode.trackId];
                if (savedProgress && savedProgress.currentTime < savedProgress.duration * 0.95) {
                    audio.currentTime = savedProgress.currentTime;
                }

                audio.play().catch(e => console.error("Initial play() was interrupted or failed. The error handler will take over.", e));
                syncPlayerUI();
            };

            const togglePlayPause = () => { if (!playerState.currentEpisode) return; audio.paused ? audio.play() : audio.pause(); };
            const playNextPrev = (offset) => { if (!playerState.playlist?.length) return; let newIndex = playerState.currentIndex + offset; if (newIndex >= 0 && newIndex < playerState.playlist.length) { const nextEp = playerState.playlist[newIndex]; playEpisode(nextEp, playerState.currentEpisode.artistName, playerState.playlist); } };
            const formatTime = (s) => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}`;

            function formatDuration(duration) {
                if (!duration || duration === 0) return '';
                let totalSeconds;
                if (String(duration).includes(':')) {
                    const parts = String(duration).split(':').reverse();
                    totalSeconds = parts.reduce((acc, part, i) => acc + parseInt(part, 10) * Math.pow(60, i), 0);
                } else {
                    totalSeconds = parseInt(duration, 10);
                }
                if (isNaN(totalSeconds) || totalSeconds === 0) return '';
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let result = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (hours > 0) {
                    result = `${hours}:${result}`;
                }
                return result;
            }

            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '';
                const size = parseInt(bytes, 10);
                if (isNaN(size) || size === 0) return '';
                const mb = size / (1024 * 1024);
                if (mb < 0.1) return '';
                return `${mb.toFixed(1)} MB`;
            }

            function renderPaginationControls() {
                const container = document.getElementById('search-pagination-controls');
                container.innerHTML = '';
                
                const canGoBack = searchState.offset > 0;
                const canGoForward = searchState.results.length === searchState.limit;

                const prevButton = document.createElement('button');
                prevButton.className = 'nav-button';
                prevButton.title = '上一頁';
                prevButton.disabled = !canGoBack;
                prevButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>`;
                prevButton.addEventListener('click', () => searchPodcasts(searchState.term, searchState.offset - searchState.limit));

                const nextButton = document.createElement('button');
                nextButton.className = 'nav-button';
                nextButton.title = '下一頁';
                nextButton.disabled = !canGoForward;
                nextButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>`;
                nextButton.addEventListener('click', () => searchPodcasts(searchState.term, searchState.offset + searchState.limit));

                if (canGoBack || canGoForward) {
                     container.appendChild(prevButton);
                     container.appendChild(nextButton);
                }
            }

            function updateDetailNav() {
                const prevBtn = document.getElementById('detail-nav-prev-podcast');
                const nextBtn = document.getElementById('detail-nav-next-podcast');
                if (!prevBtn || !nextBtn) return;

                prevBtn.disabled = searchState.currentIndex <= 0;
                nextBtn.disabled = searchState.currentIndex >= searchState.results.length - 1;
            }

            function navigatePodcastInSearch(direction) {
                return () => {
                    const newIndex = searchState.currentIndex + direction;
                    if (newIndex >= 0 && newIndex < searchState.results.length) {
                        searchState.currentIndex = newIndex;
                        const nextPodcast = searchState.results[newIndex];
                        fetchEpisodes(nextPodcast.collectionId);
                    }
                };
            }

            function saveGenreOrder() {
                const order = Array.from(genreFilterList.querySelectorAll('a')).map(a => a.dataset.genre);
                localStorage.setItem('genreOrder', JSON.stringify(order));
            }

            function populateGenreFilter() {
                const savedOrder = JSON.parse(localStorage.getItem('genreOrder')) || Object.keys(GENRES);
                genreFilterList.innerHTML = '';
                
                savedOrder.forEach(key => {
                    if (!GENRES[key]) return; // Safety check for deleted/old genres
                    const value = GENRES[key];
                    const link = document.createElement('a');
                    link.href = '#';
                    link.innerHTML = `<i class="fas fa-grip-vertical" style="margin-right: 8px; color: var(--color-text-secondary); cursor: grab;"></i> ${value}`;
                    link.dataset.genre = key;
                    link.draggable = true;

                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (e.target.tagName === 'I') { // Don't trigger filter when clicking handle
                            return;
                        }
                        currentGenreFilter = e.currentTarget.dataset.genre;
                        genreFilterBtnText.textContent = GENRES[currentGenreFilter];
                        genreFilterList.style.display = 'none';
                        loadCollection();
                    });
                    genreFilterList.appendChild(link);
                });
            }


            function initialize() {
                soundIconContainer.innerHTML = soundIconSVG;
                
                const volumeSlider = document.getElementById('volume-slider'), volumeIconBtn = document.getElementById('volume-icon-btn'), volumeIcon = volumeIconBtn.querySelector('i'), volumeTooltip = document.getElementById('volume-tooltip'), volumeContainer = document.getElementById('volume-container');
                let lastVolume = parseFloat(volumeSlider.value);
                const updateVolumeUI = (vol) => {
                    const volume = parseFloat(vol), percentage = Math.round(volume * 100);
                    volumeTooltip.textContent = `${percentage}%`;
                    if (volume === 0) volumeIcon.className = 'fas fa-volume-xmark text-base';
                    else if (volume < 0.5) volumeIcon.className = 'fas fa-volume-low text-base';
                    else volumeIcon.className = 'fas fa-volume-high text-base';
                };
                audio.volume = lastVolume; updateVolumeUI(audio.volume);
                volumeSlider.addEventListener('input', (e) => { const newVolume = parseFloat(e.target.value); audio.volume = newVolume; if (newVolume > 0) lastVolume = newVolume; updateVolumeUI(newVolume); });
                volumeIconBtn.addEventListener('click', () => { if (audio.volume > 0) { lastVolume = audio.volume; audio.volume = 0; volumeSlider.value = 0; } else { const restoreVolume = lastVolume > 0 ? lastVolume : 0.3; audio.volume = restoreVolume; volumeSlider.value = restoreVolume; } updateVolumeUI(audio.volume); });
                volumeContainer.addEventListener('mouseenter', () => volumeTooltip.style.display = 'block');
                volumeContainer.addEventListener('mouseleave', () => volumeTooltip.style.display = 'none');

                audio.addEventListener('play', () => { playerState.isPlaying = true; syncPlayerUI(); });
                audio.addEventListener('playing', () => { 
                    const playingItem = document.querySelector('.episode-item.is-playing-item');
                    if(playingItem) {
                       const spinnerContainer = playingItem.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');
                       if (spinnerContainer) spinnerContainer.style.display = 'none';
                    }
                });
                audio.addEventListener('pause', () => { playerState.isPlaying = false; syncPlayerUI(); });
                audio.addEventListener('ended', () => {
                    if (playerState.currentEpisode) {
                        const { trackId } = playerState.currentEpisode;
                        savePlaybackProgress(trackId, audio.duration, audio.duration); // Mark as fully played
                        const epItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(trackId))}"]`);
                        if (epItem) {
                           epItem.classList.add('is-listened');
                           const progressBar = epItem.querySelector('.episode-progress-bar');
                           if(progressBar) progressBar.style.width = '100%';
                        }
                    }
                    playerState.isRepeating ? (audio.currentTime = 0, audio.play()) : playNextPrev(1);
                });
                
                audio.addEventListener('error', (e) => {
                    console.error("[Audio Error] An error occurred:", audio.error);
                    const { currentEpisode, _playbackAttempt } = playerState;
                    if (!currentEpisode) return; 

                    const episodeItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                    const spinnerContainer = episodeItem?.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');

                    if (_playbackAttempt === 'direct') {
                        console.warn("[Player] Direct playback failed. Attempting fallback via proxy.");
                        playerState._playbackAttempt = 'proxy';
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(currentEpisode.episodeUrl)}`;
                        console.log(`[Player] Attempt 2 (Proxy): ${proxyUrl}`);
                        const currentTime = audio.currentTime; 
                        audio.src = proxyUrl;
                        audio.load(); 
                        if(currentTime > 0) audio.currentTime = currentTime;
                        audio.play().catch(err => console.error("Proxy play() failed immediately.", err));
                        return; 
                    }

                    if (_playbackAttempt === 'proxy') {
                         console.error("[Player] Fallback via proxy also failed. Playback aborted.");
                         if (spinnerContainer) spinnerContainer.style.display = 'none';
                         alert(`無法載入音訊檔案：\n直接播放與代理備援皆失敗，可能是檔案來源問題或網路連線不穩定。`);
                         playerState.currentEpisode = null;
                         playerState.isPlaying = false;
                         syncPlayerUI();
                    }
                });

                audio.addEventListener('timeupdate', () => { 
                    if (isNaN(audio.duration)) return; 
                    const { currentTime, duration } = audio;
                    const { currentEpisode } = playerState;

                    progress.style.width = `${(currentTime / duration) * 100}%`; 
                    currentTimeEl.textContent = formatTime(currentTime); 
                    durationEl.textContent = formatTime(duration); 
                    
                    if (currentEpisode) {
                        const now = Date.now();
                        if (now - lastProgressUpdateTime > 2000) {
                            savePlaybackProgress(currentEpisode.trackId, currentTime, duration);
                            lastProgressUpdateTime = now;
                        }
                        
                        const epItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                        if (epItem) {
                            const progressBar = epItem.querySelector('.episode-progress-bar');
                            if(progressBar) progressBar.style.width = `${(currentTime / duration) * 100}%`;
                            if (currentTime / duration > 0.95) {
                                epItem.classList.add('is-listened');
                            } else {
                                epItem.classList.remove('is-listened');
                            }
                        }
                    }
                });

                document.getElementById('library-title').addEventListener('click', () => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById('default-view').style.display='flex'; });
                document.getElementById('search-btn').addEventListener('click', () => searchPodcasts(document.getElementById('search-input').value));
                document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && searchPodcasts(e.target.value));
                document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
                document.getElementById('skip-backward-btn').addEventListener('click', () => audio.currentTime = Math.max(0, audio.currentTime - 15));
                document.getElementById('skip-forward-btn').addEventListener('click', () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 15));
                document.getElementById('progress-bar').addEventListener('click', (e) => { if (audio.duration) audio.currentTime = (e.offsetX / e.currentTarget.offsetWidth) * audio.duration; });
                document.getElementById('playback-rate-btn').addEventListener('click', () => { let newRate = playerState.playbackRate + 0.5; if (newRate > 2.0) newRate = 0.5; playerState.playbackRate = newRate; audio.playbackRate = newRate; syncPlayerUI(); });
                repeatBtn.addEventListener('click', () => { playerState.isRepeating = !playerState.isRepeating; syncPlayerUI(); });
                localSearchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); document.querySelectorAll('.sidebar-item').forEach(item => { item.style.display = item.title.toLowerCase().includes(searchTerm) ? '' : 'none'; }); });
                viewModeListBtn.addEventListener('click', () => { sidebarItemsContainer.classList.remove('grid-view'); viewModeListBtn.classList.add('active'); viewModeGridBtn.classList.remove('active'); });
                viewModeGridBtn.addEventListener('click', () => { sidebarItemsContainer.classList.add('grid-view'); viewModeGridBtn.classList.add('active'); viewModeListBtn.classList.remove('active'); });
                filterFavoritesBtn.addEventListener('click', () => { isFavoritesFilterActive = !isFavoritesFilterActive; filterFavoritesBtn.classList.toggle('active', isFavoritesFilterActive); loadCollection(); });
                sortDirectionBtn.addEventListener('click', () => { sortIcon.classList.toggle('fa-arrow-up-wide-short'); sortIcon.classList.toggle('fa-arrow-down-wide-short'); loadCollection(); });
                const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); themeToggleBtn.innerHTML = theme === 'dark' ? sunIconSVG : moonIconSVG; localStorage.setItem('theme', theme); };
                themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
                
                // Genre Filter Logic
                populateGenreFilter();
                genreFilterBtn.addEventListener('click', () => {
                    genreFilterList.style.display = genreFilterList.style.display === 'block' ? 'none' : 'block';
                });
                
                let draggedItem = null;
                genreFilterList.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('a');
                    setTimeout(() => { if(draggedItem) draggedItem.classList.add('dragging'); }, 0);
                });
                genreFilterList.addEventListener('dragend', (e) => {
                    if(draggedItem) draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });
                genreFilterList.addEventListener('dragover', e => {
                    e.preventDefault();
                    const target = e.target.closest('a');
                    if (target && draggedItem && target !== draggedItem) {
                        const rect = target.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / rect.height > 0.5;
                        genreFilterList.insertBefore(draggedItem, next ? target.nextSibling : target);
                    }
                });
                genreFilterList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if(draggedItem) {
                       draggedItem.classList.remove('dragging');
                       saveGenreOrder();
                    }
                });

                // Modal close events
                modalCloseBtn.addEventListener('click', () => modalOverlay.style.display = 'none');
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.style.display = 'none'; });

                // Close dropdown if clicked outside
                window.addEventListener('click', (e) => {
                    if (!genreFilterBtn.contains(e.target)) {
                        genreFilterList.style.display = 'none';
                    }
                });

                applyTheme(localStorage.getItem('theme') || 'dark');
                loadCollection();
                syncPlayerUI();
            }
            initialize();
        });
    </script>
</body>
</html></div></body></html>