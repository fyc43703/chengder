<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Podcast情報站</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-light.min.css">
<style>
      /* General Styles */
      html, body {
        margin: 0;
        padding: 0;
        background: #FFFFFF;
        color: #1d1d1f;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        font-size: 15px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      h1, h2, h3, h4, h5, h6, b, strong {
        font-weight: 600; /* Semibold for macOS look */
      }
      h1 { font-weight: 700; } /* Bold for main title */
      
      /* Explicit list styles for consistent rendering in html2canvas */
      ul, ol { padding-left: 2em; margin-top: 1em; margin-bottom: 1em; }
      ul { list-style-type: disc; }
      ol { list-style-type: decimal; }
      li { display: list-item; }

      .hljs-container {
        padding: 1.5rem;
        border-radius: .75rem;
        overflow-x: auto;
        background: #fcfcfd;
        border: 1px solid #d2d2d7;
      }
      .text-highlight{background:linear-gradient(180deg,transparent 25%,#A0C4FF 25%,#A0C4FF 75%,transparent 75%);padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-multiline{background:linear-gradient(180deg,transparent 25%,#A0C4FF 25%,#A0C4FF 75%,transparent 75%);background-size:100% 1.5em;background-repeat:repeat;padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-error{background:linear-gradient(180deg,transparent 25%,#FFD7D8 25%,#FFD7D8 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#D92525}
      .text-highlight-success{background:linear-gradient(180deg,transparent 25%,#D4EDDA 25%,#D4EDDA 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#155724}
    </style></head><body><div style="max-width:1600px;margin:0 auto"><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast情報站</title>
    <!-- 引入 Tailwind CSS 確保響應式設計和現代化外觀 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqN5yI61Rz5oVn2uW/yTzQ1LzW4zLh1tM5hY6k8n+rE8f/a5iK4Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 自定義樣式 */
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #b3b3b3;
            --player-height: 60px;
        }

        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #e4e6e9;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #65676b;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 20rem 1fr;
            height: 100vh;
            padding-top: 0;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            padding-bottom: var(--player-height);
            gap: 0.5rem;
            box-sizing: border-box;
        }
        
        /* 播放器 CSS */
        .player { position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-height); background-color: var(--color-surface); border-top: 1px solid var(--color-border, #282828); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; gap: 1rem; }
        .player-info { flex: 1 1 30%; display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        #player-album-art { width: 40px; height: 40px; border-radius: 0.25rem; flex-shrink: 0; }
        .player-controls-wrapper { flex: 1 1 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 0; gap: 0.1rem; }
        .player-actions-wrapper { flex: 1 1 30%; display: flex; align-items: center; justify-content: flex-end; gap: 1rem; }
        .player button, .player a { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 0; line-height: 1; }
        .player button:hover, .player a:hover { color: var(--color-text-primary); }
        .playback-controls { display: flex; align-items: center; gap: 1.25rem; }
        .simple-control-btn { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; transition: color 0.2s; font-size: 1rem; }
        .simple-control-btn:hover { color: var(--color-text-primary); }
        .detail-nav-btn { color: #A0C4FF; font-size: 1.5rem !important; }
        .detail-nav-btn:hover { color: #8EB8FF; }
        .play-pause-btn { width: 2rem; height: 2rem; border-radius: 50%; background-color: white; color: black; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: transform 0.2s, box-shadow 0.2s; }
        .play-pause-btn:hover { transform: scale(1.1); }
        .play-pause-btn:active { transform: scale(0.95); }
        .play-pause-btn i { color: #A0C4FF; font-size: 0.875rem; }
        .progress-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
        #download-btn { display: none; color: #A0C4FF; }
        #download-btn.is-visible { display: inline-block; }
        #download-btn:hover { color: #8EB8FF; }

        /* 側邊欄 */
        .sidebar { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; overflow-y: auto; }
        .library-title-styled { background-color: #A0C4FF; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; display: inline-block; cursor: pointer; align-self: center; }
        .main-container { display: flex; flex-direction: column; gap: 0.5rem; overflow: hidden; }
        .main-content { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1.5rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #theme-toggle-btn { background-color: transparent !important; color: var(--color-text-secondary); width: 44px; height: 44px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* 側邊欄功能區 */
        .sidebar-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        #local-search-input { background: var(--color-interactive-element); border: none; border-radius: 9999px; padding: 0.5rem 1rem 0.5rem 2.5rem; width: 100%; color: var(--color-text-primary); }
        .view-mode-toggle { display: flex; background: var(--color-interactive-element); padding: 2px; border-radius: 9999px; }
        .view-mode-btn { background: transparent; border: none; color: var(--color-text-secondary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .view-mode-btn.active { background: var(--color-surface-hover); color: var(--color-text-primary); }
        #filter-favorites-btn, #sort-direction-btn { background-color: var(--color-interactive-element); color: var(--color-text-primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        #filter-favorites-btn.active { background-color: #ff3b30; color: white; }

        /* 側邊欄項目 */
        #sidebar-items.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; }
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.5rem; position: relative; }
        .sidebar-item:hover { background-color: var(--color-surface-hover); }
        .sidebar-item.is-active { background-color: #A0C4FF; color: white; }
        .sidebar-item.is-active .text-xs { color: rgba(255,255,255,0.8); }
        #sidebar-items.grid-view .sidebar-item { flex-direction: column; padding: 0.5rem; height: auto; }
        #sidebar-items.grid-view .sidebar-item-number, #sidebar-items.grid-view .sidebar-item__text-wrapper { display: none; }
        #sidebar-items.grid-view .sidebar-item img { width: 100%; height: auto; aspect-ratio: 1/1; border-radius: 0.5rem; }
        #sidebar-items.grid-view .sidebar-item-actions { top: 0.5rem; right: 0.5rem; transform: none; }
        .sidebar-item-number { width: 1.5rem; text-align: center; color: var(--color-text-secondary); flex-shrink: 0; }
        .sidebar-item-actions { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); display: flex; align-items: center; gap: 0.5rem; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .sidebar-item:hover .sidebar-item-actions, #sidebar-items.grid-view .sidebar-item:hover .sidebar-item-actions { opacity: 1; visibility: visible; }
        .sidebar-action-btn { background-color: rgba(0,0,0,0.5); border: none; color: white; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; }
        .sidebar-action-btn:hover { background-color: #ff3b30; }
        .sidebar-action-btn.fav-btn.is-favorite, .sidebar-action-btn.fav-btn:hover { background-color: #ff3b30; }
        .sidebar-item__text-wrapper { line-height: 1.5; height: calc(1.5em * 2); overflow: hidden; }
        
        /* 搜尋結果 */
        .search-result-item { position: relative; background-color: var(--color-surface-hover); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
        .add-to-fav-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: none; opacity: 0; transform: scale(0.8); z-index: 5; }
        .search-result-item:hover .add-to-fav-btn { opacity: 1; transform: scale(1); }
        .add-to-fav-btn:hover { background-color: #FF453A; }
        .add-to-fav-btn.is-favorite { background-color: #FF453A; opacity: 1; transform: scale(1); }
        
        /* Podcast 詳情 */
        .podcast-header { display: flex; align-items: center; gap: 1.5rem; flex-shrink: 0; }
        .podcast-header img { width: 4.5rem; height: 4.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); flex-shrink: 0; }
        .podcast-episodes { display: flex; flex-direction: column; gap: 0.1rem; flex-grow: 1; overflow-y: auto; }
        .episode-item { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; }
        .episode-item img { width: 2rem; height: 2rem; border-radius: 0.25rem; flex-shrink: 0; }
        .episode-number { width: 2.5rem; text-align: right; padding-right: 1rem; color: var(--color-text-secondary); flex-shrink: 0; font-size: 0.875rem; }
        .episode-item:hover { background-color: var(--color-surface-hover); }
        .episode-item-actions { display: none; align-items: center; gap: 0.75rem; }
        .episode-action-btn { background-color: transparent; border: 1px solid var(--color-text-secondary); color: var(--color-text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .episode-action-btn:hover { background-color: var(--color-text-secondary); color: var(--color-surface); }
        .episode-action-btn.download-action-link { color: #A0C4FF; border-color: #A0C4FF; }
        .episode-action-btn.download-action-link:hover { background-color: #A0C4FF; color: white; }
        .episode-item:not(.is-playing-item):hover .episode-date { display: none; }
        .episode-item:not(.is-playing-item):hover .episode-item-actions { display: flex; }
        .episode-date { font-size: 0.75rem; color: var(--color-text-secondary); white-space: nowrap; }

        /* 新增載入中動畫樣式 */
        #episodes-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; gap: 1rem; color: var(--color-text-secondary); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-surface-hover); border-top-color: #A0C4FF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 播放動畫與狀態 */
        .player-title-container.marquee #player-title { display: inline-block; padding-left: 100%; animation: scroll-text 15s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .sound-icon-container { display: none; align-items: center; justify-content: center; flex-shrink: 0; }
        .player-info .sound-icon-container { margin-left: 0.5rem; }
        .player-info .sound-icon-container.is-playing-icon { display: flex; }
        .player-info .sound-icon-container svg { width: 24px; height: 24px; color: #A0C4FF; }
        @keyframes sound-wave-pulse { 0% { transform: scaleY(0.3); } 30% { transform: scaleY(1); } 60% { transform: scaleY(0.5); } 100% { transform: scaleY(0.3); } }
        .sound-wave { transform-origin: 50% 100%; animation: sound-wave-pulse 1.2s ease-in-out infinite; }
        .sound-wave-1 { animation-delay: 0s; } .sound-wave-2 { animation-delay: 0.2s; } .sound-wave-3 { animation-delay: 0.4s; }
        .episode-item.is-playing-item { background-color: #A0C4FF; color: white; }
        .episode-item.is-playing-item .text-sm, .episode-item.is-playing-item .episode-number { color: rgba(255, 255, 255, 0.85); font-weight: 700; }
        .episode-item.is-playing-item .episode-date, .episode-item.is-playing-item:hover .episode-item-actions { display: none; }
        .episode-item.is-playing-item .sound-icon-container { display: flex; }
        .episode-item.is-playing-item .sound-icon-container svg { width: 24px; height: 24px; color: white; }
        
        #volume-tooltip { position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background-color: var(--color-interactive-element); color: var(--color-text-primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: none; white-space: nowrap; pointer-events: none; }
        #volume-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-width: 5px; border-style: solid; border-color: var(--color-interactive-element) transparent transparent transparent; }

        /* RWD */
        @media (max-width: 1024px) { .container { grid-template-columns: 16rem 1fr; } }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; padding: 0; padding-bottom: var(--player-height); } .sidebar, .main-container { border-radius: 0; } .player { padding: 0 1rem; gap: 0.75rem; } .player-info { flex-basis: 30%; } #player-album-art { width: 48px; height: 48px; } #player-artist { display: none; } .player-controls-wrapper { flex-basis: 45%; } .playback-controls { gap: 1rem; } .player-actions-wrapper { flex-basis: 25%; gap: 0.5rem; justify-content: flex-end; } }
        @media (max-width: 640px) { .player { padding: 0 0.75rem; gap: 0.5rem; } .main-content { padding: 1rem; } h1.text-2xl { font-size: 1.25rem; } .player-info { flex-basis: 35%; } #player-album-art { width: 40px; height: 40px; } .player-controls-wrapper { flex-basis: 40%; } #current-time, #duration { display: none; } .progress-container { gap: 0; width: 100%; margin: 0 auto; } #progress-bar { margin: 0 0.5rem; } .playback-controls { gap: 0.75rem; } #play-pause-btn { width: 2.5rem; height: 2.5rem; } #play-pause-icon { font-size: 1rem; } .simple-control-btn i { font-size: 0.875rem; } .player-actions-wrapper { flex-basis: 25%; } }
    
        /* 進度條優化 */
        #progress-bar { position: relative; height: 4px; }
        #progress-bar:hover #progress-handle { opacity: 1; }
        #progress-handle { 
            width: 0.75rem; 
            height: 0.75rem; 
            background-color: white; 
            border-radius: 50%; 
            position: absolute; 
            right: 0; 
            top: 50%; 
            transform: translate(50%, -50%); 
            opacity: 0; 
            transition: opacity 0.2s;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="flex items-center gap-2 mb-4">
                <div class="flex items-center gap-1.5 pl-1 flex-shrink-0">
                    <span class="block w-3 h-3 bg-[#FF5F56] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#FFBD2E] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#27C93F] rounded-full"></span>
                </div>
                <h2 id="library-title" class="text-lg font-bold library-title-styled" title="回到首頁">我的私藏Podcast</h2>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="relative flex-grow">
                    <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none z-10"></i>
                    <input type="text" placeholder="搜尋 iTunes..." id="search-input" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 pl-10 pr-4 rounded-full border-none w-full">
                </div>
                <button id="search-btn" class="bg-[#A0C4FF] text-white py-2 px-4 rounded-full border-none cursor-pointer flex-shrink-0 font-semibold">搜尋</button>
            </div>

            <div class="sidebar-controls mt-4">
                <div class="relative flex-grow">
                     <i class="fas fa-filter text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none z-10 text-sm"></i>
                    <input type="text" id="local-search-input" placeholder="篩選收藏庫...">
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <div class="view-mode-toggle" title="切換視圖">
                        <button id="view-mode-list" class="view-mode-btn active"><i class="fas fa-list"></i></button>
                        <button id="view-mode-grid" class="view-mode-btn"><i class="fas fa-grip"></i></button>
                    </div>
                    <button id="filter-favorites-btn" title="只顯示我的最愛">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button id="sort-direction-btn" title="排序">
                        <i id="sort-icon" class="fas fa-arrow-up-wide-short"></i>
                    </button>
                </div>
            </div>

            <div id="sidebar-items" class="flex flex-col mt-2"></div>
        </aside>
        <div class="main-container">
            <div id="app-header" class="bg-[var(--color-surface)] p-2 rounded-lg flex items-center justify-between">
                <div class="flex-1 text-center">
                    <h1 class="text-2xl font-bold">Podcast情報站</h1>
                    <p class="text-sm text-[var(--color-text-primary)]">Podcasts 搜尋使用 Apple iTunes Search API ，能隨時聆聽豐富多元的主題節目，並提供下載音訊檔功能</p>
                    <p class="text-xs text-gray-500 mt-1">製作者：陳政德</p>
                </div>
                <button id="theme-toggle-btn" title="切換主題"></button>
            </div>
            <main class="main-content" id="main-content">
                <div id="default-view" class="flex items-center justify-center h-full"></div>
                <div id="search-results-view" class="flex flex-col overflow-hidden" style="display: none;">
                    <h2 class="text-2xl font-bold mb-4 flex-shrink-0">搜尋結果</h2>
                    <div id="search-results-podcasts" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 overflow-y-auto"></div>
                </div>
                <div id="podcast-detail-view" class="flex flex-col overflow-hidden" style="display: none;"></div>
            </main>
        </div>
    </div>

    <footer class="player" id="player">
        <div class="player-info">
            <img id="player-album-art" src="https://placehold.co/40x40/222/fff?text=Pod" alt="單集圖片">
            <div class="flex flex-col overflow-hidden">
                <div id="player-title-container" class="player-title-container">
                    <span id="player-title" class="font-bold whitespace-nowrap text-sm" title="尚未播放任何內容">尚未播放任何內容</span>
                </div>
                <span id="player-artist" class="text-xs text-gray-400 truncate"></span>
            </div>
            <div id="sound-icon-container" class="sound-icon-container"></div>
        </div>
        <div class="player-controls-wrapper">
            <div class="playback-controls">
                <button id="playback-rate-btn" class="simple-control-btn" title="播放速度"><span id="playback-rate-text" class="text-xs">1.0x</span></button>
                <button id="skip-backward-btn" class="simple-control-btn" title="倒退 15 秒"><i class="fas fa-rotate-left"></i></button>
                <button id="play-pause-btn" class="play-pause-btn" title="播放/暫停">
                    <i id="play-pause-icon" class="fas fa-play"></i>
                </button>
                <button id="skip-forward-btn" class="simple-control-btn" title="快進 15 秒"><i class="fas fa-rotate-right"></i></button>
                <button id="repeat-btn" class="simple-control-btn" title="重複"><i class="fas fa-repeat"></i></button>
            </div>
            <div class="progress-container">
                <span id="current-time" class="text-xs">0:00</span>
                <div id="progress-bar" class="w-full bg-gray-600 rounded cursor-pointer">
                    <div id="progress" class="h-full bg-[#A0C4FF] rounded relative" style="width: 0%;">
                        <div id="progress-handle"></div>
                    </div>
                </div>
                <span id="duration" class="text-xs">0:00</span>
            </div>
        </div>
        <div class="player-actions-wrapper">
            <a id="download-btn" href="#" download title="下載音檔">
                <i class="fas fa-download text-base"></i>
            </a>
            <div id="volume-container" class="relative flex items-center">
                <button id="volume-icon-btn" class="simple-control-btn mr-1"><i class="fas fa-volume-high text-base"></i></button>
                <span id="volume-tooltip">30%</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" class="w-24" title="調整音量">
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const podcastDetailView = document.getElementById('podcast-detail-view');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const playerTitleContainer = document.getElementById('player-title-container');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            const playerAlbumArt = document.getElementById('player-album-art');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const downloadBtn = document.getElementById('download-btn');
            const playbackRateText = document.getElementById('playback-rate-text');
            const repeatBtn = document.getElementById('repeat-btn');
            const soundIconContainer = document.getElementById('sound-icon-container');
            const sidebarItemsContainer = document.getElementById('sidebar-items');
            const sortDirectionBtn = document.getElementById('sort-direction-btn');
            const sortIcon = document.getElementById('sort-icon');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const filterFavoritesBtn = document.getElementById('filter-favorites-btn');
            const localSearchInput = document.getElementById('local-search-input');
            const viewModeListBtn = document.getElementById('view-mode-list');
            const viewModeGridBtn = document.getElementById('view-mode-grid');
            
            const soundIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect class="sound-wave sound-wave-1" x="4" y="8" width="4" height="8" rx="1"></rect><rect class="sound-wave sound-wave-2" x="10" y="5" width="4" height="14" rx="1"></rect><rect class="sound-wave sound-wave-3" x="16" y="8" width="4" height="8" rx="1"></rect></svg>`;
            const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>`;
            const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>`;
            
            const audio = new Audio();
            const collectionCache = {};
            let playerState = { currentEpisode: null, playlist: [], currentIndex: -1, isPlaying: false, playbackRate: 1.0, isRepeating: false };
            let isFavoritesFilterActive = false;
            let isFetchingDetails = false; // 新增：請求鎖定旗標

            const getCollection = () => JSON.parse(localStorage.getItem('podcastCollection') || '[]');
            const saveCollection = (collection) => localStorage.setItem('podcastCollection', JSON.stringify(collection));

            const loadCollection = () => {
                sidebarItemsContainer.innerHTML = '';
                let collection = getCollection();
                if (isFavoritesFilterActive) collection = collection.filter(p => p.isFavorite);
                const isAsc = sortIcon.classList.contains('fa-arrow-up-wide-short');
                collection.sort((a, b) => isAsc ? a.collectionName.localeCompare(b.collectionName, 'zh-Hant') : b.collectionName.localeCompare(a.collectionName, 'zh-Hant'));
                collection.forEach((podcast, index) => renderCollectionItem(podcast, index + 1));
            };

            const addToCollection = (podcast) => {
                const collection = getCollection();
                if (!collection.some(p => p.collectionId === podcast.collectionId)) {
                    collection.unshift({ ...podcast, addedAt: Date.now(), isFavorite: false });
                    saveCollection(collection);
                    loadCollection();
                    updateSearchItemUI(podcast.collectionId, true);
                }
            };

            const removeFromCollection = (collectionId) => {
                let collection = getCollection().filter(p => p.collectionId !== collectionId);
                saveCollection(collection);
                loadCollection();
                updateSearchItemUI(collectionId, false);
            };

            const toggleFavoriteStatus = (collectionId) => {
                let collection = getCollection();
                const podcast = collection.find(p => p.collectionId === collectionId);
                if (podcast) {
                    podcast.isFavorite = !podcast.isFavorite;
                    saveCollection(collection);
                    loadCollection();
                }
            };
            
            function renderCollectionItem(podcast, number) {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.dataset.id = podcast.collectionId;
                item.title = `${podcast.collectionName} - ${podcast.artistName}`;
                const trashSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.144-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.057-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                const heartIconClass = podcast.isFavorite ? 'fas' : 'far';
                item.innerHTML = `<span class="sidebar-item-number">${number}</span><img src="${podcast.artworkUrl600}" alt="" class="w-12 h-12 rounded-full flex-shrink-0"><div class="flex-1 overflow-hidden sidebar-item__text-wrapper"><div class="font-semibold text-sm">${podcast.collectionName}</div><div class="text-xs text-gray-400">${podcast.artistName}</div></div><div class="sidebar-item-actions"><button class="sidebar-action-btn fav-btn ${podcast.isFavorite ? 'is-favorite' : ''}" title="標記為最愛"><i class="${heartIconClass} fa-heart"></i></button><button class="sidebar-action-btn" title="從收藏移除">${trashSVG}</button></div>`;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.sidebar-item-actions')) return;
                    document.querySelector('.sidebar-item.is-active')?.classList.remove('is-active');
                    item.classList.add('is-active');
                    fetchEpisodes(podcast.collectionId);
                });
                const [favBtn, deleteBtn] = item.querySelectorAll('.sidebar-action-btn');
                favBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFavoriteStatus(podcast.collectionId); });
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromCollection(podcast.collectionId); });
                sidebarItemsContainer.appendChild(item);
            }

            function updateSearchItemUI(collectionId, isCollected) {
                const searchItemBtn = document.querySelector(`.add-to-fav-btn[data-id="${collectionId}"]`);
                if (searchItemBtn) {
                    searchItemBtn.classList.toggle('is-favorite', isCollected);
                    searchItemBtn.querySelector('i').className = isCollected ? 'fas fa-heart' : 'far fa-heart';
                }
            }
            
            async function searchPodcasts(term) {
                const showView = (v) => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById(v).style.display='flex'; };
                if (!term) { showView('default-view'); return; }
                showView('search-results-view');
                const container = document.getElementById('search-results-podcasts');
                container.innerHTML = `<div class="w-full flex justify-center mt-8"><div style="border:4px solid var(--color-border);border-radius:50%;border-top-color:#A0C4FF;width:40px;height:40px;animation:spin 1s linear infinite;"></div></div>`;
                try {
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=podcast&limit=50`);
                    const data = await res.json();
                    container.innerHTML = !data.results.length ? '<p class="col-span-full text-center text-gray-400">沒有找到相關播客。</p>' : '';
                    const collection = getCollection();
                    data.results.forEach(podcast => {
                        const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `<button class="add-to-fav-btn ${isCollected ? 'is-favorite' : ''}" data-id="${podcast.collectionId}" title="加入/移除收藏"><i class="${isCollected ? 'fas' : 'far'} fa-heart"></i></button><img src="${podcast.artworkUrl600}" class="w-full rounded-lg mb-2 shadow-lg"><span class="font-bold text-sm truncate w-full" title="${podcast.collectionName}">${podcast.collectionName}</span><span class="text-xs text-gray-400 truncate w-full" title="${podcast.artistName}">${podcast.artistName}</span>`;
                        item.addEventListener('click', () => fetchEpisodes(podcast.collectionId));
                        const favBtn = item.querySelector('.add-to-fav-btn');
                        favBtn.addEventListener('click', (e) => { e.stopPropagation(); favBtn.classList.contains('is-favorite') ? removeFromCollection(podcast.collectionId) : addToCollection(podcast); });
                        container.appendChild(item);
                    });
                } catch (error) { container.innerHTML = '<p class="text-center text-gray-400">搜尋失敗。請稍後再試。</p>'; }
            }
            
            // --- START: 全新、極致穩健的核心演算法 ---

            // 輔助函式：取得 Podcast 基本資訊 (含快取)
            async function getPodcastInfo(collectionId) {
                if (collectionCache[collectionId] && collectionCache[collectionId].feedUrl) {
                    return collectionCache[collectionId];
                }
                const response = await fetch(`https://itunes.apple.com/lookup?id=${collectionId}`);
                if (!response.ok) throw new Error(`iTunes API request failed with status ${response.status}`);
                const data = await response.json();
                if (data.resultCount === 0 || !data.results[0].feedUrl) {
                    throw new Error('Podcast not found or does not have a valid feed URL.');
                }
                collectionCache[collectionId] = data.results[0];
                return data.results[0];
            }

            // 主要方法：使用 rss2json API
            async function fetchWithRss2Json(feedUrl, podcastInfo) {
                const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`);
                if (!response.ok) throw new Error(`rss2json API request failed with status ${response.status}`);
                const data = await response.json();
                if (data.status !== 'ok') throw new Error(`rss2json failed to parse feed: ${data.message}`);
                
                return data.items.map(item => ({
                    trackId: item.guid,
                    trackName: item.title,
                    episodeUrl: item.enclosure.link,
                    releaseDate: item.pubDate,
                    artworkUrl60: item.thumbnail || podcastInfo.artworkUrl60,
                    artworkUrl600: item.thumbnail || podcastInfo.artworkUrl600
                })).filter(ep => ep.episodeUrl); // 確保有音檔連結
            }

            // 備援方法：使用 AllOrigins + DOMParser
            async function fetchWithAllOrigins(feedUrl, podcastInfo) {
                const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(feedUrl)}`);
                if (!response.ok) throw new Error(`AllOrigins proxy request failed with status ${response.status}`);
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlText, "application/xml");
                const errorNode = doc.querySelector("parsererror");
                if (errorNode) throw new Error(`DOMParser failed to parse XML: ${errorNode.textContent}`);

                const episodes = [];
                doc.querySelectorAll("item").forEach(item => {
                    const enclosure = item.querySelector("enclosure");
                    if (enclosure && enclosure.getAttribute("url")) {
                        episodes.push({
                            trackId: item.querySelector("guid")?.textContent || enclosure.getAttribute("url"),
                            trackName: item.querySelector("title")?.textContent || 'Untitled Episode',
                            episodeUrl: enclosure.getAttribute("url"),
                            releaseDate: item.querySelector("pubDate")?.textContent || new Date().toISOString(),
                            artworkUrl60: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl60,
                            artworkUrl600: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl600,
                        });
                    }
                });
                return episodes;
            }

            // 核心演算法主函式
            async function fetchEpisodes(collectionId) {
                if (isFetchingDetails) {
                    console.warn("A fetch operation is already in progress.");
                    return;
                }
                isFetchingDetails = true;

                const showView = (v) => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById(v).style.display = 'flex'; };
                showView('podcast-detail-view');
                
                let podcastInfo;
                try {
                    // 步驟 1: 獲取 Podcast 基本資訊
                    podcastInfo = await getPodcastInfo(collectionId);
                    renderPodcastShell(podcastInfo); // 立即渲染外殼，提升體驗

                    // 檢查快取中是否已有單集列表
                    if (podcastInfo.episodes) {
                        populateEpisodesList(podcastInfo.episodes, podcastInfo);
                        isFetchingDetails = false;
                        return;
                    }

                    // 步驟 2: 備援鏈解析
                    let episodes;
                    try {
                        // 主要方法
                        console.log(`Attempting to fetch [${podcastInfo.collectionName}] with PRIMARY method (rss2json)...`);
                        episodes = await fetchWithRss2Json(podcastInfo.feedUrl, podcastInfo);
                    } catch (primaryError) {
                        console.warn(`Primary method failed: ${primaryError.message}. Falling back to SECONDARY method.`);
                        try {
                            // 備援方法
                            console.log(`Attempting to fetch [${podcastInfo.collectionName}] with FALLBACK method (AllOrigins + DOMParser)...`);
                            episodes = await fetchWithAllOrigins(podcastInfo.feedUrl, podcastInfo);
                        } catch (fallbackError) {
                            console.error(`Fallback method also failed: ${fallbackError.message}`);
                            // 當所有方法都失敗時，拋出最終錯誤
                            throw new Error("Both primary and fallback methods failed to retrieve and parse the feed.");
                        }
                    }

                    if (!episodes || episodes.length === 0) {
                        throw new Error("Feed was retrieved, but no valid episodes could be found.");
                    }
                    
                    // 步驟 3: 成功後快取並渲染
                    console.log(`Successfully fetched ${episodes.length} episodes for [${podcastInfo.collectionName}].`);
                    collectionCache[collectionId].episodes = episodes;
                    populateEpisodesList(episodes, podcastInfo);

                } catch (error) {
                    console.error(`[CRITICAL] Failed to load podcast (ID: ${collectionId}):`, error);
                    displayFetchError(podcastDetailView, error.message);
                } finally {
                    isFetchingDetails = false; // 釋放鎖定
                }
            }

            // 輔助函式：顯示錯誤訊息
            function displayFetchError(container, message) {
                container.innerHTML = `<div class="text-center text-[var(--color-text-secondary)] m-auto">
                    <p class="font-bold text-lg mb-2">無法載入節目資訊</p>
                    <p class="text-sm">${message || '請檢查您的網路連線，或該節目來源可能已失效。'}</p>
                    <button id="retry-fetch-btn" class="mt-4 bg-[#A0C4FF] text-white font-bold py-2 px-4 rounded-full">重試</button>
                </div>`;
                // 注意：這裡未實現重試按鈕的功能，因為需要傳遞 collectionId。
                // 為了簡化，使用者可以點擊側邊欄項目來重試。
            }

            function renderPodcastShell(podcast) {
                const tooltipText = `節目名稱：${podcast.collectionName}\n主持人：${podcast.artistName}\n類型：${podcast.primaryGenreName}\n單集總數：${podcast.trackCount}`;
                podcastDetailView.innerHTML = `
                    <div class="podcast-header">
                        <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName} cover" title="${tooltipText}">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-2">
                                <h1 class="text-xl font-bold truncate">${podcast.collectionName}</h1>
                                <button id="add-to-collection-btn" class="bg-[#A0C4FF] text-white font-bold py-1 px-3 rounded-full text-sm flex-shrink-0">收藏</button>
                                <div class="ml-auto flex items-center gap-4 flex-shrink-0">
                                    <button id="detail-prev-btn" class="simple-control-btn detail-nav-btn" title="上一集"><i class="fas fa-backward-step"></i></button>
                                    <button id="detail-next-btn" class="simple-control-btn detail-nav-btn" title="下一集"><i class="fas fa-forward-step"></i></button>
                                </div>
                            </div>
                            <p class="text-sm mt-1 truncate">${podcast.artistName}</p>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold mt-4 mb-2">最新單集</h2>
                    <div id="episodes-placeholder" class="flex flex-col justify-center items-center flex-grow-1 gap-4 text-[var(--color-text-secondary)]">
                        <div class="spinner"></div>
                        <p>正在載入節目，請稍候...</p>
                    </div>`;
                document.getElementById('add-to-collection-btn').addEventListener('click', () => addToCollection(podcast));
                document.getElementById('detail-prev-btn').addEventListener('click', () => playNextPrev(-1));
                document.getElementById('detail-next-btn').addEventListener('click', () => playNextPrev(1));
            }

            function populateEpisodesList(episodes, podcast) {
                const placeholder = document.getElementById('episodes-placeholder');
                if (!placeholder) return;

                const escapeAttr = (str) => String(str || '').replace(/"/g, '&quot;');
                const episodesHTML = episodes.slice(0, 20).map((ep, index) => {
                    const safeFileName = `${(ep.trackName || 'download').replace(/[/\\?%*:|"<>]/g, '-')}.mp3`;
                    return `<div class="episode-item" data-episode-id="${escapeAttr(ep.trackId)}" title="${escapeAttr(ep.trackName)} - ${escapeAttr(podcast.artistName)}">
                                <span class="episode-number">${index + 1}</span>
                                <div class="flex items-center gap-3 overflow-hidden flex-1">
                                    <img src="${ep.artworkUrl60}" class="flex-shrink-0" alt="Episode thumbnail">
                                    <div class="flex-1 overflow-hidden">
                                        <div class="font-semibold truncate" title="${escapeAttr(ep.trackName)}">${ep.trackName}</div>
                                        <div class="text-sm truncate" title="${escapeAttr(podcast.artistName)}">${podcast.artistName}</div>
                                    </div>
                                </div>
                                <span class="episode-date">${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</span>
                                <div class="episode-item-actions">
                                    <button class="episode-action-btn play-action-btn" title="播放"><i class="fas fa-play"></i></button>
                                    <a href="${ep.episodeUrl}" download="${safeFileName}" class="episode-action-btn download-action-link" title="下載"><i class="fas fa-download"></i></a>
                                </div>
                                <div class="sound-icon-container">${soundIconSVG}</div>
                            </div>`;
                }).join('');
                
                placeholder.outerHTML = `<div class="podcast-episodes">${episodesHTML}</div>`;

                podcastDetailView.querySelectorAll('.episode-item').forEach(item => {
                    const ep = episodes.find(e => e.trackId === item.dataset.episodeId);
                    if (!ep) return;
                    item.addEventListener('click', (e) => { if (!e.target.closest('.episode-item-actions')) playEpisode(ep, podcast.artistName, episodes); });
                    item.querySelector('.play-action-btn').addEventListener('click', (e) => { e.stopPropagation(); playEpisode(ep, podcast.artistName, episodes); });
                    item.querySelector('.download-action-link').addEventListener('click', (e) => e.stopPropagation());
                });
                syncPlayerUI();
            }
            // --- END: 全新、極致穩健的核心演算法 ---

            const syncPlayerUI = () => {
                const { currentEpisode, isPlaying, playbackRate, isRepeating } = playerState;
                playerTitleContainer.classList.toggle('marquee', !!currentEpisode);
                if (currentEpisode) {
                    playerTitle.textContent = currentEpisode.trackName;
                    playerTitle.title = currentEpisode.trackName;
                    playerArtist.textContent = currentEpisode.artistName;
                    playerAlbumArt.src = currentEpisode.artworkUrl600;
                    downloadBtn.href = currentEpisode.episodeUrl;
                    downloadBtn.setAttribute('download', `${(currentEpisode.trackName || 'download').replace(/[/\\?%*:|"<>]/g, '-')}.mp3`);
                    downloadBtn.classList.add('is-visible');
                } else {
                    playerTitle.textContent = '尚未播放任何內容';
                    playerTitle.title = '尚未播放任何內容';
                    playerArtist.textContent = '';
                    playerAlbumArt.src = 'https://placehold.co/40x40/222/fff?text=Pod';
                    downloadBtn.classList.remove('is-visible');
                }
                soundIconContainer.classList.toggle('is-playing-icon', isPlaying && !!currentEpisode);
                document.querySelector('.episode-item.is-playing-item')?.classList.remove('is-playing-item');
                if (isPlaying && currentEpisode) { document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`)?.classList.add('is-playing-item'); }
                playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
                playbackRateText.textContent = `${playbackRate.toFixed(1)}x`;
                repeatBtn.style.color = isRepeating ? '#A0C4FF' : 'var(--color-text-secondary)';
            };

            const playEpisode = (episode, host, playlist) => {
                if (playerState.currentEpisode?.trackId === episode.trackId) { togglePlayPause(); return; }
                const reversedPlaylist = [...playlist].reverse();
                playerState = { ...playerState, currentEpisode: { ...episode, artistName: host }, playlist: playlist, currentIndex: playlist.findIndex(e => e.trackId === episode.trackId), isPlaying: true };
                audio.src = episode.episodeUrl;
                audio.playbackRate = playerState.playbackRate;
                audio.play();
                syncPlayerUI();
            };

            const togglePlayPause = () => { if (!playerState.currentEpisode) return; audio.paused ? audio.play() : audio.pause(); };
            const playNextPrev = (offset) => { if (!playerState.playlist?.length) return; let newIndex = playerState.currentIndex + offset; if (newIndex >= 0 && newIndex < playerState.playlist.length) { const nextEp = playerState.playlist[newIndex]; playEpisode(nextEp, playerState.currentEpisode.artistName, playerState.playlist); } };
            const formatTime = (s) => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}`;

            function initialize() {
                soundIconContainer.innerHTML = soundIconSVG;
                
                // --- START: NEW & FIXED VOLUME CONTROL LOGIC ---
                const volumeSlider = document.getElementById('volume-slider');
                const volumeIconBtn = document.getElementById('volume-icon-btn');
                const volumeIcon = volumeIconBtn.querySelector('i');
                const volumeTooltip = document.getElementById('volume-tooltip');
                const volumeContainer = document.getElementById('volume-container');
                let lastVolume = parseFloat(volumeSlider.value);

                const updateVolumeUI = (vol) => {
                    const volume = parseFloat(vol);
                    const percentage = Math.round(volume * 100);
                    volumeTooltip.textContent = `${percentage}%`;
                    
                    if (volume === 0) {
                        volumeIcon.className = 'fas fa-volume-xmark text-base';
                    } else if (volume < 0.5) {
                        volumeIcon.className = 'fas fa-volume-low text-base';
                    } else {
                        volumeIcon.className = 'fas fa-volume-high text-base';
                    }
                };

                audio.volume = lastVolume;
                updateVolumeUI(audio.volume);

                volumeSlider.addEventListener('input', (e) => {
                    const newVolume = parseFloat(e.target.value);
                    audio.volume = newVolume;
                    if (newVolume > 0) {
                        lastVolume = newVolume;
                    }
                    updateVolumeUI(newVolume);
                });

                volumeIconBtn.addEventListener('click', () => {
                    if (audio.volume > 0) {
                        lastVolume = audio.volume;
                        audio.volume = 0;
                        volumeSlider.value = 0;
                    } else {
                        const restoreVolume = lastVolume > 0 ? lastVolume : 0.3;
                        audio.volume = restoreVolume;
                        volumeSlider.value = restoreVolume;
                    }
                    updateVolumeUI(audio.volume);
                });

                volumeContainer.addEventListener('mouseenter', () => {
                    volumeTooltip.style.display = 'block';
                });
                volumeContainer.addEventListener('mouseleave', () => {
                    volumeTooltip.style.display = 'none';
                });
                // --- END: NEW & FIXED VOLUME CONTROL LOGIC ---

                audio.addEventListener('play', () => { playerState.isPlaying = true; syncPlayerUI(); });
                audio.addEventListener('pause', () => { playerState.isPlaying = false; syncPlayerUI(); });
                audio.addEventListener('ended', () => playerState.isRepeating ? (audio.currentTime = 0, audio.play()) : playNextPrev(1));
                audio.addEventListener('timeupdate', () => { if (isNaN(audio.duration)) return; progress.style.width = `${(audio.currentTime / audio.duration) * 100}%`; currentTimeEl.textContent = formatTime(audio.currentTime); durationEl.textContent = formatTime(audio.duration); });
                document.getElementById('library-title').addEventListener('click', () => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById('default-view').style.display='flex'; });
                document.getElementById('search-btn').addEventListener('click', () => searchPodcasts(document.getElementById('search-input').value));
                document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && searchPodcasts(e.target.value));
                document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
                document.getElementById('skip-backward-btn').addEventListener('click', () => audio.currentTime = Math.max(0, audio.currentTime - 15));
                document.getElementById('skip-forward-btn').addEventListener('click', () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 15));
                document.getElementById('progress-bar').addEventListener('click', (e) => { if (audio.duration) audio.currentTime = (e.offsetX / e.currentTarget.offsetWidth) * audio.duration; });
                document.getElementById('playback-rate-btn').addEventListener('click', () => { let newRate = playerState.playbackRate + 0.5; if (newRate > 2.0) newRate = 0.5; playerState.playbackRate = newRate; audio.playbackRate = newRate; syncPlayerUI(); });
                repeatBtn.addEventListener('click', () => { playerState.isRepeating = !playerState.isRepeating; syncPlayerUI(); });
                localSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        const title = item.title.toLowerCase();
                        item.style.display = title.includes(searchTerm) ? '' : 'none';
                    });
                });
                viewModeListBtn.addEventListener('click', () => { sidebarItemsContainer.classList.remove('grid-view'); viewModeListBtn.classList.add('active'); viewModeGridBtn.classList.remove('active'); });
                viewModeGridBtn.addEventListener('click', () => { sidebarItemsContainer.classList.add('grid-view'); viewModeGridBtn.classList.add('active'); viewModeListBtn.classList.remove('active'); });
                filterFavoritesBtn.addEventListener('click', () => { isFavoritesFilterActive = !isFavoritesFilterActive; filterFavoritesBtn.classList.toggle('active', isFavoritesFilterActive); loadCollection(); });
                sortDirectionBtn.addEventListener('click', () => { sortIcon.classList.toggle('fa-arrow-up-wide-short'); sortIcon.classList.toggle('fa-arrow-down-wide-short'); loadCollection(); });
                const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); themeToggleBtn.innerHTML = theme === 'dark' ? sunIconSVG : moonIconSVG; localStorage.setItem('theme', theme); };
                themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
                applyTheme(localStorage.getItem('theme') || 'dark');
                loadCollection();
                syncPlayerUI();
            }
            initialize();
        });
    </script>
</body>
</html></div></body></html>
