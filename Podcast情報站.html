<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Podcast情報站</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-light.min.css">
<style>
      /* General Styles */
      html, body {
        margin: 0;
        padding: 0; /* MODIFICATION: Removed 24px padding to align content to the top */
        background: #FFFFFF;
        color: #1d1d1f;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        font-size: 15px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      h1, h2, h3, h4, h5, h6, b, strong {
        font-weight: 600; /* Semibold for macOS look */
      }
      h1 { font-weight: 700; } /* Bold for main title */
      
      /* Explicit list styles for consistent rendering in html2canvas */
      ul, ol { padding-left: 2em; margin-top: 1em; margin-bottom: 1em; }
      ul { list-style-type: disc; }
      ol { list-style-type: decimal; }
      li { display: list-item; }

      .hljs-container {
        padding: 1.5rem;
        border-radius: .75rem;
        overflow-x: auto;
        background: #fcfcfd;
        border: 1px solid #d2d2d7;
      }
      .text-highlight{background:linear-gradient(180deg,transparent 25%,#B3D7FF 25%,#B3D7FF 75%,transparent 75%);padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-multiline{background:linear-gradient(180deg,transparent 25%,#B3D7FF 25%,#B3D7FF 75%,transparent 75%);background-size:100% 1.5em;background-repeat:repeat;padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-error{background:linear-gradient(180deg,transparent 25%,#FFD7D8 25%,#FFD7D8 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#D92525}
      .text-highlight-success{background:linear-gradient(180deg,transparent 25%,#D4EDDA 25%,#D4EDDA 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#155724}
    </style></head><body><div style="max-width:1600px;margin:0 auto"><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast情報站</title>
    <!-- 引入 Tailwind CSS 確保響應式設計和現代化外觀 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqN5yI61Rz5oVn2uW/yTzQ1LzW4zLh1tM5hY6k8n+rE8f/a5iK4Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 自定義樣式 */
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #b3b3b3;
            --player-height: 90px;
        }

        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #e4e6e9;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #65676b;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0; /* 新增：移除瀏覽器預設的 body 邊距 */
        }

        .container {
            display: grid;
            grid-template-columns: 20rem 1fr;
            height: 100vh;
            /* 修正：使用更明確的 padding 寫法，強制移除頂部空間 */
            padding-top: 0;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            padding-bottom: var(--player-height); /* 底部保留播放器空間 */
            gap: 0.5rem; /* FIX: 加入間隔，分隔左右區塊 */
            box-sizing: border-box;
        }
        
        /* --- 全新重寫、靈感源自範例的播放器 CSS --- */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--player-height);
            background-color: var(--color-surface);
            border-top: 1px solid var(--color-border, #282828);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            gap: 1rem;
        }

        .player-info {
            flex: 1 1 30%;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
        }

        .player-controls-wrapper {
            flex: 1 1 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }

        .player-actions-wrapper {
            flex: 1 1 30%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* 按鈕的通用樣式 */
        .player button,
        .player a {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .player button:hover,
        .player a:hover {
            color: var(--color-text-primary);
        }
        
        /* 播放控制按鈕設計 - iPhone 風格 */
        .control-btn {
            background-color: #007AFF; /* 藍色背景 */
            color: white; /* 白色圖標 */
            width: 44px;
            height: 44px;
            border-radius: 50%; /* 圓形 */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* 質感陰影 */
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            transform: scale(0.95);
            box-shadow: none;
        }

        .control-btn i {
            font-size: 1.25rem;
        }

        /* 主播放按鈕放大 */
        #play-pause-btn .control-btn {
            width: 60px;
            height: 60px;
            font-size: 2rem;
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* 新增的按鈕樣式 */
        .simple-control-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .simple-control-btn:hover {
            color: var(--color-text-primary);
        }
        
        .play-pause-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background-color: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .play-pause-btn:hover {
            transform: scale(1.1);
        }

        .play-pause-btn:active {
            transform: scale(0.9);
        }


        /* 主控制按鈕 */
        .main-controls {
            display: flex;
            align-items: center;
            gap: 1rem; /* 調整按鈕間距 */
            margin-bottom: 0.5rem;
        }

        /* 播放進度條 */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        /* 下載按鈕的可見性控制 */
        #download-btn {
            display: none;
        }

        #download-btn.is-visible {
            display: inline-block;
        }

        /* --- 重寫結束 --- */
        .sidebar {
            background-color: var(--color-surface);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            overflow-y: auto;
        }

        .library-title-styled {
            background-color: #007AFF;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: inline-block;
            align-self: flex-start;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: hidden;
        }

        .main-content {
            background-color: var(--color-surface);
            border-radius: 0.5rem;
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 新的標頭按鈕位置 */
        #theme-toggle-btn {
            background-color: transparent !important;
            color: var(--color-text-secondary);
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* MODIFICATION: Adjusted gap for number */
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            position: relative;
        }

        .sidebar-item:hover {
            background-color: var(--color-surface-hover);
        }
        
        /* MODIFICATION START: Styles for numbering */
        .sidebar-item-number {
            width: 1.5rem;
            text-align: center;
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }
        /* MODIFICATION END */

        .delete-btn {
            position: absolute;
            top: 50%;
            right: 0.75rem;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            color: var(--color-text-primary);
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .sidebar-item:hover .delete-btn {
            opacity: 1;
            visibility: visible;
        }

        .delete-btn:hover {
            background-color: #e53e3e;
            color: white;
        }

        .sidebar-item__text-wrapper {
            line-height: 1.5;
            height: calc(1.5em * 2);
            overflow: hidden;
        }

        .podcast-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .podcast-header img {
            width: 4.5rem;
            height: 4.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }

        .podcast-episodes {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .episode-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .episode-item img {
            width: 2rem;
            height: 2rem;
            border-radius: 0.25rem;
            flex-shrink-0;
        }
        
        /* MODIFICATION START: Styles for numbering */
        .episode-number {
            width: 2.5rem;
            text-align: right;
            padding-right: 1rem;
            color: var(--color-text-secondary);
            flex-shrink: 0;
            font-size: 0.875rem;
        }
        
        .episode-item.is-playing-item .episode-number {
            color: white;
            font-weight: 700;
        }
        /* MODIFICATION END */

        .episode-item .font-semibold {
            font-size: 0.875rem;
        }

        .episode-item:hover {
            background-color: var(--color-surface-hover);
        }

        .episode-date {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        .player-title-container {
            overflow: hidden;
        }

        .player-title-container.marquee #player-title {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-text 15s linear infinite;
        }

        @keyframes scroll-text {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-100%);
            }
        }
        
        .sound-icon-container {
            display: none; 
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .player-info .sound-icon-container {
             margin-left: 0.5rem;
        }

        .player-info .sound-icon-container.is-playing-icon {
            display: flex; 
        }
        
        .player-info .sound-icon-container svg {
            width: 24px;
            height: 24px;
            color: #1DB954; 
        }

        @keyframes sound-wave-pulse {
            0% { transform: scaleY(0.3); }
            30% { transform: scaleY(1); }
            60% { transform: scaleY(0.5); }
            100% { transform: scaleY(0.3); }
        }

        .sound-wave {
            transform-origin: 50% 100%;
            animation: sound-wave-pulse 1.2s ease-in-out infinite;
        }
        .sound-wave-1 { animation-delay: 0s; }
        .sound-wave-2 { animation-delay: 0.2s; }
        .sound-wave-3 { animation-delay: 0.4s; }
        
        .episode-item.is-playing-item {
            background-color: #007AFF; 
            color: white; 
        }
        
        .episode-item.is-playing-item .text-sm {
            color: rgba(255, 255, 255, 0.85);
        }

        .episode-item.is-playing-item .episode-date {
            display: none;
        }

        .episode-item.is-playing-item .sound-icon-container {
            display: flex;
        }
        
        .episode-item.is-playing-item .sound-icon-container svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        #volume-tooltip {
            position: absolute;
            bottom: 150%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-interactive-element);
            color: var(--color-text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            display: none;
            white-space: nowrap;
            pointer-events: none;
        }

        #volume-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: var(--color-interactive-element) transparent transparent transparent;
        }

        /* --- RWD (響應式網頁設計) 調整 START --- */
        /* 核心原則：保持播放器功能完整性，維持單行三段式結構不換行 */

        @media (max-width: 1024px) {
             /* --- 調整整體佈局以適應較小的桌面或平板 --- */
            .container {
                /* 將側邊欄寬度變小 */
                grid-template-columns: 16rem 1fr;
            }
        }


        @media (max-width: 768px) {
            /* --- 平板尺寸調整 --- */
            
            /* 改變整體佈局為垂直堆疊 */
            .container {
                grid-template-columns: 1fr; /* 單欄佈局 */
                padding-left: 0;
                padding-right: 0;
                padding-top: 0;
            }
            
            .sidebar, .main-container {
                 border-radius: 0;
            }
            
            /* --- 播放器內部調整 (不換行) --- */

            .player {
                padding: 0 1rem; /* 減少左右內邊距 */
                gap: 0.75rem; /* 縮小三個主要區塊的間距 */
            }

            /* 左側資訊區 */
            .player-info {
                flex-basis: 30%; /* 減少基礎寬度 */
            }
            #player-album-art {
                width: 48px;
                height: 48px;
            }
            #player-artist {
                display: none; /* 隱藏藝人名稱以節省空間 */
            }

            /* 中間控制區 */
            .player-controls-wrapper {
                flex-basis: 45%; /* 增加控制區的相對寬度 */
            }
            .playback-controls {
                gap: 1rem; /* 縮小控制按鈕間距 */
            }

            /* 右側功能區 */
            .player-actions-wrapper {
                 flex-basis: 25%; /* 減少基礎寬度 */
                 gap: 0.5rem; /* 縮小音量和下載按鈕的間距 */
                 justify-content: flex-end;
            }
            #volume-slider {
                width: 80px; /* 縮短音量滑桿 */
            }
        }

        @media (max-width: 640px) {
            /* --- 手機尺寸下的進一步優化 --- */
            
            .player {
                padding: 0 0.75rem;
                gap: 0.5rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            h1.text-2xl {
                font-size: 1.25rem; /* 縮小標題字體 */
            }

            /* 左側資訊區 */
            .player-info {
                flex-basis: 35%;
            }
            #player-album-art {
                width: 40px;
                height: 40px;
            }

            /* 中間控制區 */
            .player-controls-wrapper {
                 flex-basis: 40%;
            }
            
            /* 隱藏時間文字，為進度條爭取最大空間 */
            #current-time, #duration {
                display: none;
            }
            .progress-container {
                gap: 0;
                width: 100%;
                margin: 0 auto;
            }
             #progress-bar {
                margin: 0 0.5rem;
            }

            .playback-controls {
                gap: 0.75rem; /* 進一步壓縮按鈕間距 */
            }
            
            #play-pause-btn {
                width: 2.5rem; /* 縮小主播放按鈕 */
                height: 2.5rem;
            }
            
            #play-pause-icon {
                font-size: 1rem;
            }
            
            .simple-control-btn i {
                font-size: 0.875rem; /* 稍微縮小圖標 */
            }

            /* 右側功能區 */
             .player-actions-wrapper {
                 flex-basis: 25%;
            }
            #volume-slider {
                width: 60px; /* 極限縮短音量條 */
            }
        }
         /* --- RWD (響應式網頁設計) 調整 END --- */

    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 id="library-title" class="text-xl font-bold library-title-styled" title="回到首頁">我的私藏Podcast</h2>
            <div class="my-4 flex items-center gap-2">
                <div class="relative flex-grow">
                    <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none z-10"></i>
                    <input type="text" placeholder="想播放什麼內容？" id="search-input" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 pl-10 pr-4 rounded-full border-none w-full">
                </div>
                <button id="search-btn" class="bg-[#1DB954] text-white py-2 px-4 rounded-full border-none cursor-pointer flex-shrink-0 font-semibold">搜尋</button>
            </div>
            <!-- 新增的過濾器和排序按鈕 -->
            <div id="filter-sort-container" class="flex items-center gap-2 mb-4">
                <div class="flex-grow">
                    <select id="sort-order" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 px-4 rounded-full border-none w-full">
                        <option value="recent">最近播放</option>
                        <option value="name">按名稱排序</option>
                    </select>
                </div>
                <button id="sort-direction-btn" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center">
                    <i id="sort-icon" class="fas fa-arrow-up-wide-short"></i>
                </button>
            </div>
            <div id="sidebar-items" class="flex flex-col"></div>
        </aside>
        <div class="main-container">
            <!-- 標頭區塊：包含標題和主題切換按鈕 -->
            <div id="app-header" class="bg-[var(--color-surface)] p-2 rounded-lg flex items-center justify-between">
                <div class="flex-1 text-center">
                    <h1 class="text-2xl font-bold">Podcast情報站</h1>
                    <p class="text-sm text-gray-400">Podcast數位音訊節目能隨時隨地聆聽豐富多元的主題內容，並提供下載音訊檔功能</p>
                    <p class="text-xs text-gray-500 mt-1">製作者：陳政德</p>
                </div>
                <!-- 主題切換按鈕移到標頭內 -->
                <button id="theme-toggle-btn" title="切換主題"></button>
            </div>
            <main class="main-content" id="main-content">
                <div id="default-view" class="flex items-center justify-center h-full"></div>
                <div id="search-results-view" class="flex flex-col overflow-hidden" style="display: none;">
                    <h2 class="text-2xl font-bold mb-4 flex-shrink-0">搜尋結果</h2>
                    <div id="search-results-podcasts" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 overflow-y-auto"></div>
                </div>
                <div id="podcast-detail-view" class="flex flex-col overflow-hidden" style="display: none;"></div>
            </main>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- ========= 全新、穩健的 FOOTER 播放器 HTML 框架 ========= -->
    <!-- ======================================================= -->
    <footer class="player" id="player">
        <!-- 左側區塊：歌曲資訊 -->
        <div class="player-info">
            <img id="player-album-art" src="https://placehold.co/60x60/222/fff?text=Pod" alt="單集圖片" class="w-16 h-16 rounded-lg flex-shrink-0">
            <div class="flex flex-col overflow-hidden">
                <div id="player-title-container" class="player-title-container">
                    <span id="player-title" class="font-bold whitespace-nowrap">尚未播放任何內容</span>
                </div>
                <span id="player-artist" class="text-sm text-gray-400 truncate"></span>
            </div>
            <div id="sound-icon-container" class="sound-icon-container">
                <!-- SVG will be injected here by JavaScript -->
            </div>
        </div>

        <!-- 中間區塊：主要播放控制 -->
        <div class="player-controls-wrapper">
            <div class="playback-controls">
                <button id="playback-rate-btn" class="simple-control-btn" title="播放速度"><span id="playback-rate-text">1.0x</span></button>
                <button id="skip-backward-btn" class="simple-control-btn" title="倒退 15 秒"><i class="fas fa-rotate-left"></i></button>
                <button id="play-pause-btn" class="play-pause-btn" title="播放/暫停">
                    <i id="play-pause-icon" class="fas fa-play text-xl"></i>
                </button>
                <button id="skip-forward-btn" class="simple-control-btn" title="快進 15 秒"><i class="fas fa-rotate-right"></i></button>
                <button id="repeat-btn" class="simple-control-btn" title="重複"><i class="fas fa-repeat"></i></button>
            </div>
            <div class="progress-container">
                <span id="current-time" class="text-xs">0:00</span>
                <div id="progress-bar" class="w-full h-1 bg-gray-600 rounded cursor-pointer">
                    <div id="progress" class="h-full bg-blue-500 rounded" style="width: 0%;"></div>
                </div>
                <span id="duration" class="text-xs">0:00</span>
            </div>
        </div>

        <!-- 右側區塊：輔助功能與音量 -->
        <div class="player-actions-wrapper">
            <a id="download-btn" href="#" download title="下載音檔">
                <i class="fas fa-download text-lg"></i>
            </a>
            <div id="volume-container" class="relative flex items-center">
                <button id="volume-icon-btn" class="simple-control-btn mr-1"><i class="fas fa-volume-high"></i></button>
                <span id="volume-tooltip">50%</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5" class="w-24" title="調整音量">
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素獲取 ---
            const mainContent = document.getElementById('main-content');
            const defaultView = document.getElementById('default-view');
            const searchResultsView = document.getElementById('search-results-view');
            const podcastDetailView = document.getElementById('podcast-detail-view');
            // 主要播放控制按鈕
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playPauseIcon = document.getElementById('play-pause-icon');
            // 其他播放器元素
            const playerTitleContainer = document.getElementById('player-title-container');
            const volumeContainer = document.getElementById('volume-container');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeTooltip = document.getElementById('volume-tooltip');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            const playerAlbumArt = document.getElementById('player-album-art');
            const progressBar = document.getElementById('progress-bar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const downloadBtn = document.getElementById('download-btn');
            const playbackRateBtn = document.getElementById('playback-rate-btn');
            const playbackRateText = document.getElementById('playback-rate-text');
            const skipBackwardBtn = document.getElementById('skip-backward-btn');
            const skipForwardBtn = document.getElementById('skip-forward-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const soundIconContainer = document.getElementById('sound-icon-container');
            // 頁面其他元素
            const sidebar = document.getElementById('sidebar-items');
            const libraryTitle = document.getElementById('library-title');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const sortOrderSelect = document.getElementById('sort-order');
            const sortDirectionBtn = document.getElementById('sort-direction-btn');
            const sortIcon = document.getElementById('sort-icon');
            
            const soundIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect class="sound-wave sound-wave-1" x="4" y="8" width="4" height="8" rx="1"></rect><rect class="sound-wave sound-wave-2" x="10" y="5" width="4" height="14" rx="1"></rect><rect class="sound-wave sound-wave-3" x="16" y="8" width="4" height="8" rx="1"></rect></svg>`;

            // --- 核心邏輯 (Single Source of Truth) ---
            const audio = new Audio();
            const collectionCache = {};
            let playerState = {
                currentEpisode: null,
                playlist: [],
                currentIndex: -1,
                isPlaying: false,
                playbackRate: 1.0,
                isRepeating: false
            };

            // 更新播放按鈕圖標
            function updatePlayPauseIcon(isPlaying) {
                playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'} text-xl`;
            }

            const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>`;
            const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>`;

            function syncPlayerUI() {
                const {
                    currentEpisode,
                    isPlaying,
                    playbackRate,
                    isRepeating
                } = playerState;
                
                playerTitleContainer.classList.toggle('marquee', !!currentEpisode);

                if (currentEpisode) {
                    playerTitle.textContent = currentEpisode.trackName;
                    playerArtist.textContent = currentEpisode.artistName;
                    playerAlbumArt.src = currentEpisode.artworkUrl600;

                    downloadBtn.href = currentEpisode.episodeUrl;
                    const safeFileName = currentEpisode.trackName.replace(/[/\\?%*:|"<>]/g, '-') + '.mp3';
                    downloadBtn.setAttribute('download', safeFileName);
                    downloadBtn.classList.add('is-visible');

                } else {
                    playerTitle.textContent = '尚未播放任何內容';
                    playerArtist.textContent = '';
                    playerAlbumArt.src = 'https://placehold.co/60x60/222/fff?text=Pod';

                    downloadBtn.href = '#';
                    downloadBtn.removeAttribute('download');
                    downloadBtn.classList.remove('is-visible');
                }
                
                soundIconContainer.classList.toggle('is-playing-icon', isPlaying && !!currentEpisode);
                
                const currentlyPlayingItem = document.querySelector('.episode-item.is-playing-item');
                if (currentlyPlayingItem) {
                    currentlyPlayingItem.classList.remove('is-playing-item');
                }
                // Only highlight if it's actually playing, not just paused on a track
                if (isPlaying && currentEpisode) {
                    const newPlayingItem = document.querySelector(`.episode-item[data-episode-id="${currentEpisode.trackId}"]`);
                    if (newPlayingItem) {
                        newPlayingItem.classList.add('is-playing-item');
                    }
                }

                updatePlayPauseIcon(isPlaying);
                playbackRateText.textContent = `${playbackRate.toFixed(1)}x`;
                repeatBtn.style.color = isRepeating ? '#007AFF' : 'var(--color-text-secondary)';
            }

            function playEpisode(episode, host, playlist) {
                if (playerState.currentEpisode?.trackId === episode.trackId) {
                    togglePlayPause();
                    return;
                }
                playerState = {
                    ...playerState,
                    currentEpisode: { ...episode,
                        artistName: host
                    },
                    playlist: playlist,
                    currentIndex: playlist.findIndex(e => e.trackId === episode.trackId),
                    isPlaying: true
                };
                audio.src = episode.episodeUrl;
                audio.playbackRate = playerState.playbackRate;
                audio.play();
                syncPlayerUI();
            }

            function togglePlayPause() {
                if (!playerState.currentEpisode) return;
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
            }

            function playNextPrev(offset) {
                if (!playerState.playlist?.length) return;
                const newIndex = playerState.currentIndex + offset;
                if (newIndex >= 0 && newIndex < playerState.playlist.length) {
                    const nextEpisode = playerState.playlist[newIndex];
                    const artistName = playerState.currentEpisode.artistName;
                    playEpisode(nextEpisode, artistName, playerState.playlist);
                } else if (playerState.isRepeating) {
                    const nextEpisode = playerState.playlist[0];
                    const artistName = playerState.currentEpisode.artistName;
                    playEpisode(nextEpisode, artistName, playerState.playlist);
                }
            }

            audio.addEventListener('play', () => {
                playerState.isPlaying = true;
                syncPlayerUI();
            });
            audio.addEventListener('pause', () => {
                playerState.isPlaying = false;
                syncPlayerUI();
            });
            audio.addEventListener('ended', () => {
                if (playerState.isRepeating) {
                    audio.currentTime = 0;
                    audio.play();
                } else {
                    playNextPrev(1);
                }
            });
            audio.addEventListener('timeupdate', () => {
                if (isNaN(audio.duration)) return;
                progress.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
                durationEl.textContent = formatTime(audio.duration);
            });

            const showView = (viewName) => {
                [defaultView, searchResultsView, podcastDetailView].forEach(v => v.style.display = 'none');
                const viewMap = {
                    default: defaultView,
                    search: searchResultsView,
                    detail: podcastDetailView
                };
                if (viewMap[viewName]) viewMap[viewName].style.display = 'flex';
            };
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                themeToggleBtn.innerHTML = theme === 'dark' ? sunIconSVG : moonIconSVG;
                localStorage.setItem('theme', theme);
            };
            const getFavorites = () => JSON.parse(localStorage.getItem('favoritePodcasts') || '[]');
            const loadFavorites = () => {
                sidebar.innerHTML = '';
                const favorites = getFavorites();
                let sortedFavorites = [...favorites];
                
                const sortOrder = sortOrderSelect.value;
                const isAsc = sortIcon.classList.contains('fa-arrow-up-wide-short');

                if (sortOrder === 'name') {
                    sortedFavorites.sort((a, b) => {
                        const comparison = a.collectionName.localeCompare(b.collectionName, 'zh-Hant');
                        return isAsc ? comparison : -comparison;
                    });
                } else { // 'recent'
                    if (!isAsc) {
                        sortedFavorites.reverse();
                    }
                }

                sortedFavorites.forEach((podcast, index) => renderFavoriteInSidebar(podcast, index + 1));
            };
            const saveFavorite = (podcast) => {
                const favorites = getFavorites();
                if (!favorites.some(fav => fav.collectionId === podcast.collectionId)) {
                    favorites.push(podcast);
                    localStorage.setItem('favoritePodcasts', JSON.stringify(favorites));
                    loadFavorites();
                }
            };
            const deleteFavorite = (collectionId) => {
                const favorites = getFavorites().filter(fav => fav.collectionId !== collectionId);
                localStorage.setItem('favoritePodcasts', JSON.stringify(favorites));
                document.querySelector(`.sidebar-item[data-id="${collectionId}"]`)?.remove();
                loadFavorites(); 
            };

            function renderFavoriteInSidebar(podcast, number) {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.dataset.id = podcast.collectionId;
                item.title = `${podcast.collectionName} - ${podcast.artistName}`;
                item.innerHTML = `<span class="sidebar-item-number">${number}</span><img src="${podcast.artworkUrl600}" alt="" class="w-12 h-12 rounded-full flex-shrink-0"><div class="flex-1 overflow-hidden sidebar-item__text-wrapper"><div class="font-semibold text-sm">${podcast.collectionName}</div><div class="text-xs text-gray-400">${podcast.artistName}</div></div><button class="delete-btn" title="從音樂庫移除"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-3.5 h-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>`;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-btn')) return;
                    fetchEpisodes(podcast.collectionId);
                });
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFavorite(podcast.collectionId);
                });
                sidebar.appendChild(item);
            }
            async function searchPodcasts(term) {
                if (!term) {
                    showView('default');
                    return;
                }
                showView('search');
                const resultsContainer = document.getElementById('search-results-podcasts');
                resultsContainer.innerHTML = `<div class="w-full flex justify-center mt-8"><div style="border:4px solid var(--color-border);border-radius:50%;border-top-color:#007AFF;width:40px;height:40px;animation:spin 1s linear infinite;"></div></div>`;
                try {
                    const response = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=podcast&limit=50`);
                    renderSearchResults((await response.json()).results);
                } catch (error) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-400">搜尋失敗。請稍後再試。</p>';
                }
            }
            async function fetchEpisodes(collectionId) {
                podcastDetailView.innerHTML = `<div class="w-full h-full flex justify-center items-center"><div style="border:4px solid var(--color-border);border-radius:50%;border-top-color:#007AFF;width:40px;height:40px;animation:spin 1s linear infinite;"></div></div>`;
                showView('detail');
                if (collectionCache[collectionId]) {
                    renderPodcastContent(collectionCache[collectionId]);
                    return;
                }
                try {
                    const response = await fetch(`https://itunes.apple.com/lookup?id=${collectionId}&entity=podcastEpisode&limit=100`);
                    const data = await response.json();
                    if (data.results.length > 0) {
                        const podcastInfo = data.results.shift();
                        collectionCache[collectionId] = { ...podcastInfo,
                            episodes: data.results
                        };
                        renderPodcastContent(collectionCache[collectionId]);
                    } else {
                        throw new Error('No episodes');
                    }
                } catch (error) {
                    podcastDetailView.innerHTML = '<p class="text-center text-gray-400">載入單集失敗。請稍後再試。</p>';
                }
            }

            function renderSearchResults(podcasts) {
                const container = document.getElementById('search-results-podcasts');
                container.innerHTML = !podcasts.length ? '<p class="text-center text-gray-400">沒有找到相關播客。</p>' : '';
                podcasts.forEach(podcast => {
                    const item = document.createElement('div');
                    item.className = 'bg-[var(--color-surface-hover)] p-3 rounded-lg flex flex-col items-center text-center cursor-pointer';
                    item.innerHTML = `<img src="${podcast.artworkUrl600}" class="w-full rounded-lg mb-1"><span class="font-bold text-sm truncate w-full">${podcast.collectionName}</span><span class="text-xs text-gray-400">${podcast.artistName}</span>`;
                    item.addEventListener('click', () => fetchEpisodes(podcast.collectionId));
                    container.appendChild(item);
                });
            }
            const formatDate = (iso) => iso ? new Date(iso).toLocaleDateString('sv-SE') : '';

            function renderPodcastContent(podcast) {
                podcastDetailView.innerHTML = `<div class="podcast-header"><img src="${podcast.artworkUrl600}"><div class="flex-1"><div class="flex items-center gap-4"><h1 class="text-xl font-bold">${podcast.collectionName}</h1><button id="favorite-btn" class="bg-[#1DB954] text-white font-bold py-1 px-3 rounded-full text-sm">收藏</button></div><p class="text-sm mt-1">${podcast.artistName}</p></div></div><h2 class="text-xl font-bold mt-4 mb-2">所有單集</h2><div class="podcast-episodes">${podcast.episodes.map((ep, index) => `<div class="episode-item" data-episode-id="${ep.trackId}"><span class="episode-number">${index + 1}</span><div class="flex items-center gap-3 overflow-hidden flex-1"><img src="${ep.artworkUrl60}" class="flex-shrink-0"><div class="flex-1 overflow-hidden"><div class="font-semibold truncate">${ep.trackName}</div><div class="text-sm truncate">${podcast.artistName}</div></div></div><span class="episode-date">${formatDate(ep.releaseDate)}</span><div class="sound-icon-container">${soundIconSVG}</div></div>`).join('')}</div>`;
                
                document.getElementById('favorite-btn').addEventListener('click', () => saveFavorite(podcast));
                document.querySelectorAll('.episode-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const ep = podcast.episodes.find(e => e.trackId === parseInt(item.dataset.episodeId));
                        playEpisode(ep, podcast.artistName, podcast.episodes);
                    });
                });
                
                syncPlayerUI();
            }
            const formatTime = (seconds) => {
                if (isNaN(seconds)) return '0:00';
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };
            const updateVolumeTooltip = () => {
                const percent = Math.round(volumeSlider.value * 100);
                volumeTooltip.textContent = `${percent}%`;
                const thumbWidth = 16;
                const sliderWidth = volumeSlider.offsetWidth;
                const thumbPos = (volumeSlider.value / volumeSlider.max) * (sliderWidth - thumbWidth) + (thumbWidth / 2);
                const finalLeft = volumeSlider.offsetLeft + thumbPos;
                volumeTooltip.style.left = `${finalLeft}px`;
            };

            function initialize() {
                soundIconContainer.innerHTML = soundIconSVG;

                libraryTitle.addEventListener('click', () => showView('default'));
                themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
                progressBar.addEventListener('click', (e) => {
                    if (audio.duration) audio.currentTime = (e.offsetX / progressBar.offsetWidth) * audio.duration;
                });
                volumeSlider.addEventListener('input', () => {
                    audio.volume = volumeSlider.value;
                    updateVolumeTooltip();
                });
                volumeContainer.addEventListener('mouseenter', () => {
                    volumeTooltip.style.display = 'block';
                    updateVolumeTooltip();
                });
                volumeContainer.addEventListener('mouseleave', () => {
                    volumeTooltip.style.display = 'none';
                });

                playPauseBtn.addEventListener('click', togglePlayPause);
                skipBackwardBtn.addEventListener('click', () => audio.currentTime = Math.max(0, audio.currentTime - 15));
                skipForwardBtn.addEventListener('click', () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 15));
                
                playbackRateBtn.addEventListener('click', () => {
                    let newRate = playerState.playbackRate + 0.5;
                    if (newRate > 2.0) newRate = 0.5;
                    playerState.playbackRate = newRate;
                    audio.playbackRate = newRate;
                    syncPlayerUI();
                });

                repeatBtn.addEventListener('click', () => {
                    playerState.isRepeating = !playerState.isRepeating;
                    syncPlayerUI();
                });

                sortOrderSelect.addEventListener('change', loadFavorites);
                sortDirectionBtn.addEventListener('click', () => {
                    sortIcon.classList.toggle('fa-arrow-up-wide-short');
                    sortIcon.classList.toggle('fa-arrow-down-wide-short');
                    loadFavorites();
                });

                searchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchPodcasts(e.target.value));
                searchBtn.addEventListener('click', () => searchPodcasts(searchInput.value));
                applyTheme(localStorage.getItem('theme') || 'dark');
                loadFavorites();
                showView('default');
                syncPlayerUI();
            }

            initialize();
        });
    </script>
</body>
</html></div></body></html>
