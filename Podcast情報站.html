<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Podcast導航站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqN5yI61Rz5oVn2uW/yTzQ1LzW4zLh1tM5hY6k8n+rE8f/a5iK4Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js" xintegrity="sha512-TelkP3PCMJv+QzVYLEBBcMh5yGzBscUAc3Jy/BSoJxyD/GxFMLRxEunHk+KdaNf1rBzmSAUGeBCDOKWIDmbpGA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* 自定義樣式 */
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #a0a0a0;
            --player-height: 60px;
        }

        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #e4e6e9;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #505255;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'PingFang TC', 'Microsoft JhengHei UI', 'Heiti TC', 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 20rem 1fr;
            height: 100vh;
            padding-top: 0;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            padding-bottom: var(--player-height);
            gap: 0.5rem;
            box-sizing: border-box;
        }
        
        /* 播放器 CSS */
        .player { position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-height); background-color: var(--color-surface); border-top: 1px solid var(--color-border, #282828); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; gap: 1rem; }
        .player-info { flex: 1 1 30%; display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        #player-album-art { width: 40px; height: 40px; border-radius: 0.25rem; flex-shrink: 0; }
        .player-controls-wrapper { flex: 1 1 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 0; gap: 0.1rem; }
        .player-actions-wrapper { flex: 1 1 30%; display: flex; align-items: center; justify-content: flex-end; gap: 1rem; }
        .player button, .player a { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 0; line-height: 1; }
        .player button:hover, .player a:hover { color: var(--color-text-primary); }
        .playback-controls { display: flex; align-items: center; gap: 1.25rem; }
        .simple-control-btn { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; transition: color 0.2s; font-size: 1rem; }
        .simple-control-btn:hover { color: var(--color-text-primary); }
        .detail-nav-btn { color: #A0C4FF; font-size: 1.5rem !important; }
        .detail-nav-btn:hover { color: #8EB8FF; }
        .play-pause-btn { width: 2rem; height: 2rem; border-radius: 50%; background-color: white; color: black; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: transform 0.2s, box-shadow 0.2s; }
        .play-pause-btn:hover { transform: scale(1.1); }
        .play-pause-btn:active { transform: scale(0.95); }
        .play-pause-btn i { color: #A0C4FF; font-size: 0.875rem; }
        .progress-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
        #download-btn { display: none; color: #27C93F; }
        #download-btn.is-visible { display: inline-block; }
        #download-btn:hover { color: #22a936; }

        /* 側邊欄 */
        .sidebar { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; overflow-y: auto; }
        .library-title-styled { background-color: #007AFF; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; display: inline-block; cursor: pointer; align-self: center; }
        .main-container { display: flex; flex-direction: column; gap: 0.5rem; overflow: hidden; }
        .main-content { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1.5rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #theme-toggle-btn { background-color: transparent !important; color: var(--color-text-secondary); width: 44px; height: 44px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* [修改] 主標題顏色 */
        #app-header h1 {
            color: #007AFF;
        }

        /* 側邊欄功能區 */
        .sidebar-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; margin-top: 1rem; }
        #local-search-input { background: var(--color-interactive-element); border: none; border-radius: 9999px; padding: 0.5rem 1rem 0.5rem 2.5rem; width: 100%; color: var(--color-text-primary); }
        .view-mode-toggle { display: flex; background: var(--color-interactive-element); padding: 2px; border-radius: 9999px; }
        .view-mode-btn { background: transparent; border: none; color: var(--color-text-secondary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .view-mode-btn.active { background: var(--color-surface-hover); color: var(--color-text-primary); }
        #filter-favorites-btn, #sort-direction-btn { background-color: var(--color-interactive-element); color: var(--color-text-primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        #filter-favorites-btn.active { background-color: #ff3b30; color: white; }
        
        /* [優化] 搜尋框清除按鈕 */
        #search-input-container .clear-search-btn {
            display: none;
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: #6c757d;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            line-height: 18px;
            text-align: center;
        }
        #search-input-container .clear-search-btn:hover { background: #8e8e93; }

        /* 分類主題樣式調整 */
        .sidebar-genre-header {
            background-color: transparent;
            color: var(--color-text-primary);
            padding: 0;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            align-self: flex-start;
        }
        .sidebar-genre-header .genre-icon { width: 20px; height: 20px; flex-shrink: 0; }
        /* [修改] 分類標題文字加粗 */
        .sidebar-genre-header .genre-text { background-color: #dbeafe; color: #1e40af; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: 700; line-height: 1.2; }
        html[data-theme="dark"] .sidebar-genre-header .genre-text { background-color: #1e3a8a; color: #eff6ff; }


        /* 側邊欄項目: 列表視圖 (預設) */
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.5rem; position: relative; }
        .sidebar-item:hover { background-color: var(--color-surface-hover); }
        .sidebar-item.is-active { background-color: #007AFF; color: white; } /* [修改] 作用中項目背景色 */
        .sidebar-item.is-active .font-semibold { color: white; } /* [新增] 作用中項目文字顏色 */
        .sidebar-item.is-active .text-xs, .sidebar-item.is-active .text-gray-400 { color: rgba(255,255,255,0.8); }
        .sidebar-item-actions { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); display: flex; align-items: center; gap: 0.5rem; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .sidebar-item:hover .sidebar-item-actions { opacity: 1; visibility: visible; }
        .sidebar-action-btn { background-color: rgba(0,0,0,0.5); border: none; color: white; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; }
        .sidebar-action-btn:hover { background-color: #ff3b30; }
        .sidebar-action-btn.fav-btn.is-favorite, .sidebar-action-btn.fav-btn:hover { background-color: #ff3b30; }
        .sidebar-item__text-wrapper { line-height: 1.4; overflow: hidden; }

        /* 側邊欄項目: 網格視圖 */
        #sidebar-items.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; }
        #sidebar-items.grid-view .sidebar-genre-header { grid-column: 1 / -1; display: flex; align-self: flex-start; }
        #sidebar-items.grid-view .sidebar-item { flex-direction: column; padding: 0.5rem; height: auto; align-items: flex-start; }
        #sidebar-items.grid-view .sidebar-item__text-wrapper .text-xs.text-gray-400 { display: none; }
        /* [修改] Podcast照片與下方的文字說明需緊貼 */
        #sidebar-items.grid-view .sidebar-item img { width: 100%; height: auto; aspect-ratio: 1/1; border-radius: 0.5rem; margin-bottom: 0.25rem; }
        #sidebar-items.grid-view .sidebar-item-actions { top: 0.5rem; right: 0.5rem; transform: none; }
        #sidebar-items.grid-view .sidebar-item__text-wrapper .font-semibold { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; white-space: normal; word-break: break-all; min-height: 2.8em; }
        
        /* [新增] 拖曳排序相關樣式 */
        .sortable-ghost {
            background: var(--color-surface-hover);
            opacity: 0.4;
            border-radius: 0.5rem;
            border: 1px dashed var(--color-text-secondary);
        }

        .drag-handle {
            opacity: 0;
            cursor: grab;
            color: var(--color-text-secondary);
            transition: opacity 0.2s;
            padding: 0 0.5rem;
            align-self: stretch;
            display: flex;
            align-items: center;
            margin-left: -0.5rem;
        }

        #sidebar-items:not(.is-sorting-disabled) .sidebar-item:hover .drag-handle {
            opacity: 0.6;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        #sidebar-items.grid-view .sidebar-item .drag-handle {
            display: none;
        }

        #sidebar-items.is-sorting-disabled .sidebar-item {
            cursor: pointer;
        }

        #sidebar-items.grid-view.is-sorting-disabled .sidebar-item {
            cursor: pointer;
        }

        #sidebar-items.grid-view:not(.is-sorting-disabled) .sidebar-item {
            cursor: grab;
        }
        #sidebar-items.grid-view:not(.is-sorting-disabled) .sidebar-item:active {
            cursor: grabbing;
        }


        /* 搜尋結果 */
        .search-result-item { position: relative; background-color: var(--color-surface-hover); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
        .add-to-fav-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: none; opacity: 0; transform: scale(0.8); z-index: 5; }
        .search-result-item:hover .add-to-fav-btn { opacity: 1; transform: scale(1); }
        .add-to-fav-btn:hover { background-color: #FF453A; }
        .add-to-fav-btn.is-favorite { background-color: #FF453A; opacity: 1; transform: scale(1); }
        
        /* Podcast 詳情 */
        .podcast-header { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
        .podcast-header img { width: 3rem; height: 3rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); flex-shrink: 0; }
        /* [修改] 減少單集列表的垂直間距 */
        .podcast-episodes { display: flex; flex-direction: column; gap: 0; flex-grow: 1; overflow-y: auto; }
        .episode-item { position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .episode-item .font-semibold { color: var(--color-text-secondary); }
        .episode-thumbnail-btn { position: relative; width: 2rem; height: 2rem; border-radius: 0.25rem; flex-shrink: 0; cursor: pointer; overflow: hidden; }
        .episode-thumbnail-btn img { width: 100%; height: 100%; object-fit: cover; }
        .episode-main-content { flex: 1; display: flex; align-items: center; gap: 0.75rem; overflow: hidden; cursor: pointer;}
        .episode-number { width: 2.5rem; text-align: right; padding-right: 1rem; color: var(--color-text-secondary); flex-shrink: 0; font-size: 0.875rem; }
        .episode-item:hover { background-color: var(--color-surface-hover); }
        .episode-item.is-listened .font-semibold, .episode-item.is-listened .text-secondary-color { color: var(--color-text-secondary); opacity: 0.6; }
        .episode-item-actions { display: none; align-items: center; gap: 0.75rem; }
        .episode-action-btn { background-color: transparent; border: 1px solid var(--color-text-secondary); color: var(--color-text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .episode-action-btn:hover { background-color: var(--color-text-secondary); color: var(--color-surface); }
        .episode-action-btn.download-action-link { color: #27C93F; border-color: #27C93F; }
        .episode-action-btn.download-action-link:hover { background-color: #27C93F; color: white; }
        /* [新增] 分享按鈕樣式 */
        .episode-action-btn.share-action-btn { color: #007AFF; border-color: #007AFF; }
        .episode-action-btn.share-action-btn:hover { background-color: #007AFF; color: white; }
        /* [新增] 儲存單集按鈕樣式 */
        .episode-action-btn.save-episode-btn { color: #FFBD2E; border-color: #FFBD2E; }
        .episode-action-btn.save-episode-btn:hover, .episode-action-btn.save-episode-btn.is-saved { background-color: #FFBD2E; color: white; }
        .episode-item:not(.is-playing-item):hover .episode-metadata { display: none; }
        .episode-item:not(.is-playing-item):hover .episode-item-actions { display: flex; }
        .episode-date { font-size: 0.75rem; color: var(--color-text-secondary); white-space: nowrap; }
        .episode-progress-bar-container { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: var(--color-interactive-element); border-radius: 0 0 0.25rem 0.25rem; overflow: hidden; }
        .episode-progress-bar { height: 100%; background-color: #FF3B30; width: 0%; }
        
        /* 載入中動畫樣式 */
        #episodes-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; gap: 1rem; color: var(--color-text-secondary); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-surface-hover); border-top-color: #A0C4FF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .small-spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.4); border-top-color: #ffffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-spinner-overlay { position: absolute; left: 0; top: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 5; }

        /* 播放動畫與狀態 */
        .player-title-container.marquee #player-title { display: inline-block; padding-left: 100%; animation: scroll-text 15s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .sound-icon-container { display: none; align-items: center; justify-content: center; flex-shrink: 0; }
        .player-info .sound-icon-container { margin-left: 0.5rem; }
        .player-info .sound-icon-container.is-playing-icon { display: flex; }
        .player-info .sound-icon-container svg { width: 24px; height: 24px; color: #A0C4FF; }
        @keyframes sound-wave-pulse { 0% { transform: scaleY(0.3); } 30% { transform: scaleY(1); } 60% { transform: scaleY(0.5); } 100% { transform: scaleY(0.3); } }
        .sound-wave { transform-origin: 50% 100%; animation: sound-wave-pulse 1.2s ease-in-out infinite; }
        .sound-wave-1 { animation-delay: 0s; } .sound-wave-2 { animation-delay: 0.2s; } .sound-wave-3 { animation-delay: 0.4s; }
        .episode-item.is-playing-item { background-color: #A0C4FF; color: white; }
        .episode-item.is-playing-item .font-semibold, .episode-item.is-playing-item .text-sm, .episode-item.is-playing-item .episode-number, .episode-item.is-playing-item .text-secondary-color { color: white; font-weight: 700; opacity: 1; }
        .episode-item.is-playing-item .episode-metadata, .episode-item.is-playing-item:hover .episode-item-actions { display: none; }
        .episode-item.is-playing-item .sound-icon-container { display: flex; }
        .episode-item.is-playing-item .sound-icon-container svg { width: 24px; height: 24px; color: white; }
        
        #volume-tooltip { position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background-color: var(--color-interactive-element); color: var(--color-text-primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: none; white-space: nowrap; pointer-events: none; }
        #volume-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-width: 5px; border-style: solid; border-color: var(--color-interactive-element) transparent transparent transparent; }

        /* 進度條優化 */
        #progress-bar { position: relative; height: 8px; }
        #progress-bar:hover #progress-handle { opacity: 1; }
        #progress-handle { width: 0.75rem; height: 0.75rem; background-color: white; border-radius: 50%; position: absolute; right: 0; top: 50%; transform: translate(50%, -50%); opacity: 0; transition: opacity 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.3); }

        /* Modal 樣式 */
        #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #episode-modal { background-color: var(--color-surface); border-radius: 0.75rem; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: var(--color-interactive-element); border: none; color: var(--color-text-primary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        #modal-description { flex-grow: 1; overflow-y: auto; margin-top: 1rem; line-height: 1.7; }
        #modal-description a { color: #A0C4FF; text-decoration: underline; }

        /* 導航按鈕樣式 */
        .nav-button { background-color: transparent; border: none; padding: 0; cursor: pointer; transition: opacity 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .nav-button:hover { opacity: 0.8; }
        .nav-button:disabled { opacity: 0.3; cursor: not-allowed; }
        .nav-button svg { width: 2.25rem; height: 2.25rem; }

        /* [優化] 主頁排版樣式 */
        #default-view {
            overflow-y: auto;
            align-items: flex-start;
            justify-content: flex-start;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 20%);
        }

        html[data-theme="light"] #default-view {
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.02) 0%, rgba(0, 0, 0, 0) 20%);
        }

        #default-view-content {
            padding: 2rem;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            color: var(--color-text-primary);
        }

        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-interactive-element);
        }
        /* [修改] Tab 按鈕樣式 */
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: #001f3f; /* [修改] 海軍藍 */
            cursor: pointer;
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* [修改] 粗體 */
            border-radius: 0.5rem 0.5rem 0 0;
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-btn:hover {
            background-color: #e0eaff; /* [修改] 淡粉藍色 */
            color: #0056b3; 
        }
        .tab-btn.active {
            background-color: #c4d7ff; /* [修改] 粉色系的藍色 */
            color: #001f3f; /* [修改] 海軍藍 */
            font-weight: 700;
        }
        .tab-btn.active::after {
            content: none; /* 移除底線 */
        }


        .tab-panel {
            display: none;
            padding: 2rem;
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            border: 1px solid var(--color-surface-hover);
            animation: fadeIn 0.4s ease;
        }
        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .intro-section {
            display: flex;
            align-items: flex-start;
            gap: 1.25rem;
            margin-bottom: 2.5rem;
        }
        .intro-section:last-child {
            margin-bottom: 0;
        }
        .intro-icon { flex-shrink: 0; width: 48px; height: 48px; margin-top: 0.25rem; }
        .intro-title { display: inline-block; background-color: #dbeafe; color: #1e40af; padding: 0.1rem 0.5rem; border-radius: 0.375rem; font-size: 1.1em; font-weight: 700; margin-bottom: 0.75rem; }
        html[data-theme="dark"] .intro-title { background-color: #1e3a8a; color: #eff6ff; }
        .intro-text, .intro-text .li-sub-text, .intro-text p { font-size: 17px; color: var(--color-text-secondary); line-height: 1.8; font-weight: 400; text-align: justify; }
        .intro-text strong { color: var(--color-text-primary); font-weight: 600; }
        .intro-text ul { list-style-position: inside; padding-left: 0; list-style-type: none; }
        .intro-text li { margin-bottom: 1.75rem; }
        .intro-text .li-sub-text { padding-left: 1.75rem; margin-top: 0.5rem; }
        .intro-text .li-sub-text p { margin-bottom: 0.75rem; }
        
        /* [優化] Toast 通知樣式 */
        #toast-container {
            position: fixed;
            bottom: calc(var(--player-height) + 1rem);
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            pointer-events: none;
        }
        .toast {
            background-color: #27C93F;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.error {
            background-color: #ff3b30;
        }

        /* [新增] 歡迎表單樣式 */
        #welcome-modal {
            transform: translateY(20px);
            opacity: 0;
            animation: welcome-modal-anim 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes welcome-modal-anim {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* [新增] 下載/匯入按鈕樣式 */
        #download-rtf-btn, #import-rtf-btn {
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }
        #download-rtf-btn { background-color: #007AFF; }
        #download-rtf-btn:hover { background-color: #0056b3; }
        #import-rtf-btn { background-color: #34C759; }
        #import-rtf-btn:hover { background-color: #2ca349; }


        /* [修改] 已存單集表格樣式 */
        #tab-saved-episodes .saved-episodes-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        #tab-saved-episodes .saved-episodes-table th {
            text-align: left;
            padding: 0.25rem 1rem; /* 再次減少垂直內距 */
            color: var(--color-text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            border-bottom: 2px solid var(--color-interactive-element);
        }
        #tab-saved-episodes .saved-episodes-table td {
            padding: 0.25rem 1rem; /* 再次減少垂直內距 */
            vertical-align: middle;
            background-color: var(--color-surface);
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--color-interactive-element);
        }
        #tab-saved-episodes .saved-episodes-table tr:last-child td {
            border-bottom: none;
        }
        #tab-saved-episodes .saved-episodes-table tr:not(thead tr):hover td {
            background-color: var(--color-surface-hover);
        }
        #tab-saved-episodes .saved-episodes-table td:first-child { border-radius: 0; }
        #tab-saved-episodes .saved-episodes-table td:last-child { border-radius: 0; }


        /* 設定欄位寬度 */
        #tab-saved-episodes .col-title { width: 50%; }
        #tab-saved-episodes .col-podcast { width: 20%; }
        #tab-saved-episodes .col-date { width: 15%; }
        #tab-saved-episodes .col-actions { width: 15%; }

        #tab-saved-episodes .saved-episode-artwork {
            width: 40px;
            height: 40px;
            border-radius: 0.25rem;
            flex-shrink: 0;
        }
        #tab-saved-episodes .saved-episode-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 350px; /* 根據父容器寬度調整 */
        }
        html[data-theme="light"] #tab-saved-episodes .saved-episode-title { color: #1d1d1f; }

        #tab-saved-episodes .saved-episode-artist {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        #tab-saved-episodes .action-link {
            background: transparent;
            border: none;
            color: #007AFF;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
            font-weight: 500;
        }
        #tab-saved-episodes .action-link:hover {
            text-decoration: underline;
        }

        #tab-saved-episodes .remove-saved-btn {
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.5;
            transition: all 0.2s;
        }
        #tab-saved-episodes .remove-saved-btn:hover {
            opacity: 1;
            color: #ff3b30;
        }

    </style>
</head>
<body>
    <div id="welcome-modal-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[2001]" style="display: none;">
        <div id="welcome-modal" class="bg-[var(--color-surface)] rounded-xl p-8 max-w-md w-11/12 text-center shadow-2xl transition-all duration-300">
            <h2 class="text-2xl font-bold mb-2 text-[var(--color-text-primary)]">歡迎使用 Podcast 導航站</h2>
            <p class="text-[var(--color-text-secondary)] mb-6">請輸入您的暱稱，打造您專屬的私藏 Podcast。<br>點擊「略過」後將不再顯示此提示。</p>
            <form id="welcome-form" class="flex flex-col">
                <input type="text" id="nickname-input" placeholder="您的暱稱或姓名" class="w-full bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-3 px-4 rounded-lg border-none mb-4 focus:ring-2 focus:ring-[#007AFF] focus:outline-none transition-shadow">
                <button type="submit" class="w-full bg-[#007AFF] text-white font-bold py-3 px-4 rounded-lg mb-2 hover:bg-[#0056b3] transition-colors duration-200">設定暱稱</button>
                <button type="button" id="skip-welcome-btn" class="w-full bg-transparent text-[var(--color-text-secondary)] py-2 px-4 rounded-lg hover:bg-[var(--color-surface-hover)] transition-colors duration-200">略過</button>
            </form>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <div class="container">
        <aside class="sidebar">
            <div class="flex items-center gap-2 mb-4">
                <div class="flex items-center gap-1.5 pl-1 flex-shrink-0">
                    <span class="block w-3 h-3 bg-[#FF5F56] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#FFBD2E] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#27C93F] rounded-full"></span>
                </div>
                <h2 id="library-title" class="text-lg font-bold library-title-styled" title="回到首頁">我的私藏Podcast</h2>
            </div>
            
            <div class="flex items-center gap-2">
                 <div id="search-input-container" class="relative flex-grow">
                    <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none z-10"></i>
                    <input type="text" placeholder="搜尋 iTunes..." id="search-input" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 pl-10 pr-10 rounded-full border-none w-full">
                    <button class="clear-search-btn" id="clear-search-btn" title="清除搜尋">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <button id="search-btn" class="bg-[#27C93F] text-white py-2 px-4 rounded-full border-none cursor-pointer flex-shrink-0 font-semibold">搜尋</button>
            </div>
            
            <div class="sidebar-controls">
                <div class="relative flex-grow">
                     <i class="fas fa-filter text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none z-10 text-sm"></i>
                    <input type="text" id="local-search-input" placeholder="篩選收藏庫...">
                </div>
                <div class="flex items-center gap-2 flex-shrink: 0;">
                    <div class="view-mode-toggle" title="切換視圖">
                        <button id="view-mode-list" class="view-mode-btn active"><i class="fas fa-list"></i></button>
                        <button id="view-mode-grid" class="view-mode-btn"><i class="fas fa-grip"></i></button>
                    </div>
                    <button id="filter-favorites-btn" title="只顯示我的最愛">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button id="sort-direction-btn" title="排序">
                        <i id="sort-icon" class="fas fa-arrow-up-wide-short"></i>
                    </button>
                </div>
            </div>

            <div id="sidebar-items" class="flex flex-col mt-2">
                 <div id="collection-empty-state" class="text-center p-4 text-[var(--color-text-secondary)]" style="display: none;">
                    <i class="fas fa-box-open text-4xl mb-3"></i>
                    <p class="font-bold">收藏庫是空的</p>
                    <p class="text-sm mt-1">試著搜尋您感興趣的節目吧！</p>
                </div>
            </div>
        </aside>
        <div class="main-container">
            <div id="app-header" class="bg-[var(--color-surface)] p-2 rounded-lg flex items-center justify-between">
                <div class="flex-1 text-center">
                    <h1 class="text-2xl font-bold">Podcast 導航站</h1>
                    <p class="text-sm text-[var(--color-text-primary)]">Podcasts 搜尋使用 Apple iTunes Search API ，能隨時聆聽豐富多元的主題節目，並提供下載音訊檔功能</p>
                    <p class="text-xs text-gray-500 mt-1">製作者：陳政德</p>
                </div>
                <button id="theme-toggle-btn" title="切換主題"></button>
            </div>
            <main class="main-content" id="main-content">
                <div id="default-view" class="h-full">
                    <div id="default-view-content">
                        <div class="tabs-nav">
                            <button class="tab-btn active" data-tab="tab-what-is">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                                Podcast 介紹
                            </button>
                            <button class="tab-btn" data-tab="tab-how-it-works">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                運作核心
                            </button>
                            <button class="tab-btn" data-tab="tab-features">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                功能簡介
                            </button>
                            <button class="tab-btn" data-tab="tab-usage">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                活用音訊檔
                            </button>
                            <button class="tab-btn" data-tab="tab-storage">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4" /></svg>
                                儲存媒體庫
                            </button>
                            <button class="tab-btn" data-tab="tab-saved-episodes">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
                                已存單集
                            </button>
                        </div>
                
                        <div class="tabs-content">
                            <div id="tab-what-is" class="tab-panel active">
                                <div class="intro-section">
                                    <div class="intro-icon">
                                       <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"><path d="M48 24c0 13.255-10.745 24-24 24S0 37.255 0 24 10.745 0 24 0s24 10.745 24 24z" fill="url(#_Linear1)"/><path d="M24 37.1c-6.8 0-12.3-5.5-12.3-12.3V11.7c0-3.4 2.8-6.2 6.2-6.2s6.2 2.8 6.2 6.2v13.1c0 3.4-2.8 6.2-6.2 6.2zm0-29.6c-2.4 0-4.3 1.9-4.3 4.3v13.1c0 2.4 1.9 4.3 4.3 4.3s4.3-1.9 4.3-4.3V11.7c0-2.4-1.9-4.3-4.3-4.3z" fill="#fff"/><path d="M24 43.1c-1.3 0-2.3-.9-2.5-2.1h-4.8c.2 3.8 3.4 6.7 7.3 6.7s7.1-2.9 7.3-6.7h-4.8c-.2 1.2-1.2 2.1-2.5 2.1z" fill="#546e7a"/><defs><linearGradient id="_Linear1" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(0 48 -48 0 24 0)"><stop offset="0" stop-color="#f44336"/><stop offset="1" stop-color="#ffc107"/></linearGradient></defs></svg>
                                    </div>
                                    <div>
                                        <div class="intro-title">Podcast 介紹</div>
                                        <p class="intro-text">
                                            Podcast（中文常譯為「播客」）是一種數位音訊節目，您可以將其想像為「可以隨時點播收聽的網路廣播」。與傳統廣播不同，Podcast 透過網路 <strong style="color: #007AFF;">RSS Feed</strong> 技術訂閱與發布，節目內容包羅萬象，從新聞時事、科技新知、商業財經到喜劇脫口秀等應有盡有。常見的格式包含<strong style="color: #007AFF;">單人主持</strong>、<strong style="color: #007AFF;">雙人對談</strong>、<strong style="color: #007AFF;">圓桌論壇</strong>或精緻的<strong style="color: #007AFF;">敘事 storytelling</strong> 等，創作者的入門門檻相對較低，造就了其內容的多元性與獨特性。
                                        </p>
                                        <p class="intro-text mt-4">
                                            自 2004 年問世以來，Podcast 憑藉其「<strong style="color: #007AFF;">陪伴感</strong>」與「<strong style="color: #007AFF;">多工性</strong>」の特質，在全球迅速普及。聽眾可以在通勤、運動、做家事等場景下，利用零碎時間隨時隨地收聽，享受不被廣告干擾的沉浸式體驗。從早期的 <strong style="color: #007AFF;">Apple iTunes</strong> 到現今的 <strong style="color: #007AFF;">Spotify</strong>、<strong style="color: #007AFF;">Google Podcasts</strong> 等平台，收聽管道日益普及，使 Podcast 成為現代人獲取資訊、學習新知和娛樂放鬆的重要媒介。
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div id="tab-how-it-works" class="tab-panel">
                                <div class="intro-section">
                                    <div class="intro-icon">
                                        <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"><path d="M48 24c0 13.255-10.745 24-24 24S0 37.255 0 24 10.745 0 24 0s24 10.745 24 24z" fill="url(#_Linear2)"/><path d="M37.8 28.3c-2.4 3.1-6 4.9-9.9 4.9-4.8 0-9.1-2.5-11.7-6.5h8c1.3 1.5 3.2 2.4 5.2 2.4 3.7 0 6.8-3 6.8-6.8 0-3.7-3-6.8-6.8-6.8-2 0-3.8.9-5.2 2.4h-8c2.6-4 6.9-6.5 11.7-6.5 3.9 0 7.5 1.8 9.9 4.9l4.5 4.5-4.5 4.5z" fill="#fff" fill-rule="nonzero"/><path d="M19.3 28.7H5.2l4.5-4.5-4.5-4.5h14.1c1.3 1.5 3.2 2.4 5.2 2.4 3.7 0 6.8-3 6.8-6.8 0-1.2-.3-2.3-.9-3.3L26 9.3c1.1.7 2.1 1.6 2.8 2.8-2.6 4-6.9 6.5-11.7 6.5-1.9 0-3.8-.5-5.5-1.4l-3.2 3.2c2.1 1.7 4.6 2.7 7.2 2.7 2.8 0 5.4-1.1 7.4-3.1l2.3 2.3C24.4 27.5 21.9 28.7 19.3 28.7z" fill="#fff" fill-rule="nonzero"/><defs><linearGradient id="_Linear2" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(0 48 -48 0 24 0)"><stop offset="0" stop-color="#00bcd4"/><stop offset="1" stop-color="#2196f3"/></linearGradient></defs></svg>
                                    </div>
                                    <div>
                                        <div class="intro-title">本程式的運作核心</div>
                                        <p class="intro-text">
                                            「Podcast 導航站」的核心是建立在強大且豐富的 <strong style="color: #007AFF;">Apple iTunes Search API</strong> 之上，讓您能夠搜尋並存取全球數以萬計的 Podcast 節目。為了確保在任何網路環境下都能穩定、快速地載入節目資訊與音訊檔案，本程式特別透過一個名為 <strong style="color: #007AFF;">`corsproxy.io`</strong> 的<strong style="color: #007AFF;">代理伺服器</strong>來處理所有網路請求。這個代理伺服器扮演著一個可靠的中間人角色，協助我們的應用程式順利地從 iTunes 和各個 Podcast 的主機上抓取資料，完美繞過了瀏覽器的安全限制，大幅提升了資料讀取的成功率與穩定性。
                                        </p>
                                        <p class="intro-text mt-4">
                                            然而，在部分具有嚴格資安管制的公司或機構網路中，IT 部門可能會基於安全考量，設定<strong style="color: #007AFF;">防火牆</strong>阻擋所有未經許可的外部代理伺服器，`corsproxy.io` 也可能在其中。這是因為代理伺服器理論上可能被用於繞過內部網路篩選、或成為資料外洩的管道。因此，若您在公司網路環境下發現無法載入節目單集，這很可能是由於防火牆規則所致，屬於預期現象。
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div id="tab-features" class="tab-panel">
                                <div class="intro-section">
                                    <div class="intro-icon">
                                      <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2"><path d="M48 24c0 13.255-10.745 24-24 24S0 37.255 0 24 10.745 0 24 0s24 10.745 24 24z" fill="url(#_Linear3)"/><path d="M21.2 37.1l-6.9-6.9L18 26.5l3.2 3.2 9.8-9.8 4.7 4.7-14.5 12.5zm0-13.6l-6.9-6.9L18 12.9l3.2 3.2 9.8-9.8 4.7 4.7-14.5 12.5z" fill="#fff"/><defs><linearGradient id="_Linear3" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(0 48 -48 0 24 0)"><stop offset="0" stop-color="#8bc34a"/><stop offset="1" stop-color="#4caf50"/></linearGradient></defs></svg>
                                    </div>
                                    <div>
                                        <div class="intro-title">功能簡介與使用說明</div>
                                        <div class="intro-text">
                                             <p>「Podcast導航站」為您量身打造了一套完整、直覺且功能強大的工具，讓您能輕鬆徜徉在 Podcast 的聲音世界中。以下是各項核心功能的詳細操作說明：</p>
                                            <ul>
                                                <li>
                                                    <strong><i class="fas fa-search text-[#007AFF]"></i><span style="color:#007AFF;"> 強大的節目搜尋</span></strong>
                                                    <div class="li-sub-text">
                                                        <p><strong>操作步驟：</strong><br>
                                                        1. 找到左側邊欄最上方的「搜尋 iTunes...」輸入框。<br>
                                                        2. 輸入節目名稱、主持人或任何您感興趣的主題關鍵字（例如：「科技」、「理財」）。<br>
                                                        3. 點擊右側綠色的「搜尋」按鈕，或直接按下鍵盤上的 Enter 鍵。<br>
                                                        </p>
                                                        <p class="mt-2"><strong>優點說明：</strong><br>
                                                        直接串接 Apple 的龐大資料庫，全球數以萬計的節目任您探索。搜尋結果會以清晰的卡片形式呈現，並提供分頁功能，讓您輕鬆瀏覽，不錯過任何好節目。
                                                        </p>
                                                    </div>
                                                </li>
                                
                                                <li>
                                                    <strong><i class="fas fa-folder-plus text-[#FFBD2E]"></i><span style="color:#007AFF;"> 智慧收藏庫管理</span></strong>
                                                    <div class="li-sub-text">
                                                        <p><strong>一鍵收藏節目／單集：</strong><br>
                                                        在搜尋結果中，將滑鼠移至節目封面上，點擊出現的 <i class="far fa-heart" style="color: #FF453A;"></i> 愛心圖示即可收藏整個節目。進入節目單集列表後，將滑鼠移到任一單集上，點擊 <i class="far fa-bookmark" style="color: #FFBD2E;"></i> 書籤圖示即可單獨儲存該集，方便日後快速收聽。</p>
                                                        <p class="mt-2"><strong>自動分類與篩選：</strong><br>
                                                        收藏的節目會自動依照官方類型分組。您可以使用上方的篩選框快速查找，或點擊 <i class="fas fa-heart" style="color: #FF453A;"></i> 按鈕只顯示標記為「最愛」的節目。</p>
                                                        <p class="mt-2"><strong>個人化視圖與排序：</strong><br>
                                                        透過 <i class="fas fa-list" style="color: #007AFF;"></i> 和 <i class="fas fa-grip" style="color: #007AFF;"></i> 圖示在「列表」與「網格」模式間切換。點擊排序圖示可在三種模式間循環切換：「手動排序」(<i class="fas fa-grip-vertical" style="color: #007AFF;"></i>)、「A-Z 升序」(<i class="fas fa-arrow-up-wide-short" style="color: #007AFF;"></i>) 與「Z-A 降序」(<i class="fas fa-arrow-down-wide-short" style="color: #007AFF;"></i>)。在「手動排序」模式下，您可以直接拖曳節目來自由排列順序，打造最符合您習慣的收藏庫。</p>
                                                        <p class="mt-2"><strong><i class="fas fa-database" style="color: #8E8E93;"></i> 資料儲存提醒：</strong><br>
                                                        「✓ 已收藏」的節目列表與「已存單集」都是使用您瀏覽器的「本機儲存空間」(localStorage) 功能儲存的。這代表資料只會留在您當前的電腦與瀏覽器中，不會同步到其他裝置。若您更換瀏覽器或清除快取，這些列表將會遺失。</p>
                                                    </div>
                                                </li>
                                
                                                <li>
                                                    <strong><i class="fas fa-headphones-alt text-[#27C93F]"></i><span style="color:#007AFF;"> 沉浸式播放體驗</span></strong>
                                                    <div class="li-sub-text">
                                                        <p><strong>操作步驟：</strong><br>
                                                        進入任一收藏的節目後，點擊單集列表中的任一集即可開始播放。所有控制功能都集中在畫面底部的播放器。</p>
                                                        <p class="mt-2"><strong>高階播放功能：</strong></p>
                                                        <ul class="list-disc pl-5 opacity-90">
                                                            <li><strong>進度記憶：</strong>自動記錄每一集的收聽進度，下次回來從上次中斷處繼續聽。</li>
                                                            <li><strong>精準快轉：</strong><i class="fas fa-rotate-left" style="color: #A0C4FF;"></i> / <i class="fas fa-rotate-right" style="color: #A0C4FF;"></i> 按鈕可前後快轉 15 秒，方便跳過不感興趣的片段。</li>
                                                            <li><strong>變速播放：</strong>可在 0.5x 至 2.0x 之間調整語速，滿足高效學習或放鬆聆聽的需求。</li>
                                                            <li><strong>單集下載：</strong>點擊 <i class="fas fa-download" style="color: #27C93F;"></i> 圖示，即可將音訊檔下載至您的電腦中，實現真正的離線收聽。</li>
                                                        </ul>
                                                    </div>
                                                </li>
                                
                                                <li>
                                                    <strong><i class="fas fa-star text-[#FF3B30]"></i><span style="color:#007AFF;"> 貼心的輔助設計</span></strong>
                                                    <div class="li-sub-text">
                                                        <p><strong><i class="fas fa-adjust" style="color: #FFBD2E;"></i> 明暗主題切換：</strong><br>
                                                        點擊右上角的太陽 / 月亮圖示，即可在兩種視覺主題間無縫切換，保護您的眼睛，無論白天黑夜都有最佳體驗。</p>
                                                        <p class="mt-2"><strong><i class="fas fa-info-circle" style="color: #007AFF;"></i> 單集詳情速覽：</strong><br>
                                                        在單集列表中，點擊最左側的「單集封面圖」，會彈出該集的完整內容簡介 (Show Notes)，幫助您在播放前快速了解單集主題與大綱。</p>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab-usage" class="tab-panel">
                                <div class="intro-section">
                                    <div class="intro-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="none"><path d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6s20.4 9.1 20.4 20.4-9.1 20.4-20.4 20.4z" fill="#00bcd4"/><path d="M19.9 14.3h8.2v19.4h-8.2V14.3zm-3.7 2.5h-2.4v14.5h2.4V16.8zm15.6 0h-2.4v14.5h2.4V16.8z" fill="#fff"/></svg>
                                    </div>
                                    <div>
                                        <div class="intro-title">活用音訊檔：從聽到讀的轉化</div>
                                        <p class="intro-text">
                                            本程式提供的「<strong style="color: #007AFF;">單集下載</strong>」功能，不僅僅是為了離線收聽。下載後的 MP3 音訊檔是一個強大的素材，您可以將它上傳至 Google 的 <strong style="color: #007AFF;">NotebookLM</strong> 或其他 <strong style="color: #007AFF;">AI 語音轉文字服務</strong>。這些工具能將數十分鐘的訪談或演講，在短時間内自動轉換為<strong style="color: #007AFF;">逐字稿</strong>。
                                        </p>
                                        <p class="intro-text mt-4">
                                            擁有逐字稿後，您便能利用 <strong style="color: #007AFF;">AI 的強大摘要能力</strong>，快速整理出該集 Podcast 的核心重點、關鍵引述或主題大綱，製作成一份精簡的摘要報告。這個流程將單向的「<strong style="color: #007AFF;">聆聽</strong>」體驗，轉化為可搜尋、可分析、可再利用的「<strong style="color: #007AFF;">閱讀</strong>」材料，對於學習新知、研究特定主題或製作內容摘要都非常有幫助。
                                        </p>
                                    </div>
                                </div>
                            </div>
                             <div id="tab-storage" class="tab-panel">
                                <div class="intro-section">
                                    <div class="intro-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 48 48"><path d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6s20.4 9.1 20.4 20.4-9.1 20.4-20.4 20.4z" fill="#757575"/><path d="M24 10.4c-7.5 0-13.6 3-13.6 6.8v1.8c0 3.7 6.1 6.8 13.6 6.8s13.6-3 13.6-6.8v-1.8c0-3.7-6.1-6.8-13.6-6.8zm0 13.6c-7.5 0-13.6-3-13.6-6.8v3.6c0 3.7 6.1 6.8 13.6 6.8s13.6-3 13.6-6.8v-3.6c0 3.7-6.1 6.8-13.6 6.8zm0 9.1c-7.5 0-13.6-3-13.6-6.8v3.6c0 3.8 6.1 6.8 13.6 6.8s13.6-3 13.6-6.8v-3.6c0 3.8-6.1 6.8-13.6 6.8z" fill="#fff"/></svg>
                                    </div>
                                    <div>
                                        <div class="intro-title">關於媒體庫的儲存</div>
                                        <p class="intro-text">
                                            您的收藏列表是透過瀏覽器內建的「<strong style="color: #007AFF;">本機儲存空間</strong>」(localStorage) 功能儲存在您的電腦中。這代表資料是跟隨瀏覽器且完全私密的，但若您更換瀏覽器或清除快取，紀錄將會遺失。為了方便您<strong style="color: #007AFF;">備份</strong>與<strong style="color: #007AFF;">還原</strong>您的收藏，我們提供了匯入與匯出功能。
                                        </p>
                                        <p class="intro-text mt-4">
                                            <strong><i class="fas fa-download text-[#007AFF]"></i><span style="color:#007AFF;"> 下載節目表</span></strong>：點擊此按鈕，會將您目前收藏的所有節目匯出成一個 <strong style="color: #007AFF;">.html 備份檔</strong>。請妥善保管此檔案。<br>
                                            <strong><i class="fas fa-upload text-[#34C759]"></i><span style="color:#007AFF;"> 匯入節目表</span></strong>：點擊此按鈕，並選取先前下載的 <strong style="color: #007AFF;">.html 備份檔</strong>。程式會讀取檔案內容，自動搜尋並將節目重新加入您的收藏庫。
                                        </p>
                                        <p class="intro-text mt-4">
                                            <strong><i class="fas fa-exclamation-triangle text-[#FFBD2E]"></i> 注意事項</strong>：匯入功能是透過<strong style="color: #007AFF;">節目名稱</strong>與<strong style="color: #007AFF;">主持人名稱</strong>在 iTunes 上重新搜尋來還原。若 Podcast 的名稱或主持人在 iTunes 上已有變更，可能會導致部分節目無法成功還原。此外，匯入過程<strong style="color: #007AFF;">不會重複加入</strong>您收藏庫中已有的節目，只會新增不存在的節目。
                                        </p>
                                        <div class="mt-8 flex items-center gap-4">
                                            <button id="download-rtf-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                                下載 Podcast 節目表
                                            </button>
                                            <button id="import-rtf-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4-4m0 0-4 4m4-4v12" /></svg>
                                                匯入 Podcast 節目表
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab-saved-episodes" class="tab-panel">
                                 <div class="intro-section">
                                    <div class="intro-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 48 48"><path fill="#FFBD2E" d="M37.3 6H10.7C8.1 6 6 8.1 6 10.7v26.6C6 39.9 8.1 42 10.7 42h26.6c2.6 0 4.7-2.1 4.7-4.7V10.7C42 8.1 39.9 6 37.3 6z"></path><path fill="#FFF" d="m29.5 13.5-5.5 5.5-5.5-5.5-2.5 2.5 5.5 5.5-5.5 5.5 2.5 2.5 5.5-5.5 5.5 5.5 2.5-2.5-5.5-5.5 5.5-5.5z"></path><path fill="#fff" d="M15.4 34.6V13.4h5.2v21.2h-5.2z"></path></svg>
                                    </div>
                                    <div>
                                        <div class="intro-title">已儲存的單集列表</div>
                                        <p class="intro-text">
                                           這裡是您跨節目收藏的單集集中地。無論是某個訪談的精彩片段或一集發人深省的內容，都可儲存於此，方便隨時回味。為了讓您能<strong style="color: #007AFF;">備份</strong>或在不同裝置間<strong style="color: #007AFF;">轉移</strong>這份寶貴的列表，這裡也提供了完整的匯入與匯出功能。
                                        </p>
                                        <p class="intro-text mt-4">
                                            <strong><i class="fas fa-download text-[#007AFF]"></i><span style="color:#007AFF;"> 下載列表 (HTML)</span></strong>：點擊此按鈕，會將您目前儲存的所有單集資訊匯出成一個獨立的 <strong style="color: #007AFF;">.html 備份檔</strong>，您可以將此檔案存放在任何地方。<br>
                                            <strong><i class="fas fa-upload text-[#34C759]"></i><span style="color:#007AFF;"> 匯入儲存的單集列表</span></strong>：點擊後選擇您之前下載的 <strong style="color: #007AFF;">.html 備份檔</strong>，程式會智慧地讀取檔案內容，並將其中尚未存在於您目前列表中的單集加回來。
                                        </p>
                                         <p class="intro-text mt-4">
                                            <strong><i class="fas fa-info-circle text-[#FFBD2E]"></i> 注意事項</strong>：匯入過程<strong style="color: #007AFF;">不會重複加入</strong>已經存在的單集，因此您可以放心執行，不用擔心列表會變得雜亂。這是確保您精心挑選的單集列表永不遺失的最佳方式。
                                        </p>
                                    </div>
                                </div>
                                <div id="saved-episodes-content">
                                    <!-- 內容將由 JavaScript 動態生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="search-results-view" class="flex flex-col overflow-hidden" style="display: none;">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <h2 class="text-2xl font-bold">搜尋結果</h2>
                        <div id="search-pagination-controls" class="flex items-center gap-2"></div>
                    </div>
                    <div id="search-results-podcasts" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 overflow-y-auto"></div>
                </div>
                <div id="podcast-detail-view" class="flex flex-col overflow-hidden" style="display: none;"></div>
            </main>
        </div>
    </div>
    <input type="file" id="import-rtf-input" hidden accept=".html">
    <input type="file" id="import-saved-episodes-input" hidden accept=".html">

    <footer class="player" id="player">
        <div class="player-info">
            <img id="player-album-art" src="https://placehold.co/40x40/222/fff?text=Pod" alt="單集圖片">
            <div class="flex flex-col overflow-hidden">
                <div id="player-title-container" class="player-title-container">
                    <span id="player-title" class="font-bold whitespace-nowrap text-sm" title="尚未播放任何內容">尚未播放任何內容</span>
                </div>
                <span id="player-artist" class="text-xs text-gray-400 truncate"></span>
            </div>
            <div id="sound-icon-container" class="sound-icon-container"></div>
        </div>
        <div class="player-controls-wrapper">
            <div class="playback-controls">
                <button id="playback-rate-btn" class="simple-control-btn" title="播放速度"><span id="playback-rate-text" class="text-xs">1.0x</span></button>
                <button id="skip-backward-btn" class="simple-control-btn" title="倒退 15 秒"><i class="fas fa-rotate-left"></i></button>
                <button id="play-pause-btn" class="play-pause-btn" title="播放/暫停">
                    <i id="play-pause-icon" class="fas fa-play"></i>
                </button>
                <button id="skip-forward-btn" class="simple-control-btn" title="快進 15 秒"><i class="fas fa-rotate-right"></i></button>
                <button id="repeat-btn" class="simple-control-btn" title="重複播放"><i class="fas fa-repeat"></i></button>
            </div>
            <div class="progress-container">
                <span id="current-time" class="text-xs">0:00</span>
                <div id="progress-bar" class="w-full bg-gray-600 rounded cursor-pointer">
                    <div id="progress" class="h-full bg-[#A0C4FF] rounded relative" style="width: 0%;">
                        <div id="progress-handle"></div>
                    </div>
                </div>
                <span id="duration" class="text-xs">0:00</span>
            </div>
        </div>
        <div class="player-actions-wrapper">
            <a id="download-btn" href="#" download title="下載音檔">
                <i class="fas fa-download text-base"></i>
            </a>
            <div id="volume-container" class="relative flex items-center">
                <button id="volume-icon-btn" class="simple-control-btn mr-1"><i class="fas fa-volume-high text-base"></i></button>
                <span id="volume-tooltip">30%</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" class="w-20" title="調整音量">
            </div>
        </div>
    </footer>
    
    <div id="modal-overlay">
        <div id="episode-modal">
            <button id="modal-close-btn" title="關閉"><i class="fas fa-times"></i></button>
            <div class="flex items-start gap-4 flex-shrink-0">
                <img id="modal-artwork" src="" class="w-24 h-24 rounded-lg flex-shrink-0">
                <div class="flex-1">
                    <p id="modal-date" class="text-xs text-gray-400 mb-1"></p>
                    <h3 id="modal-title" class="text-lg font-bold"></h3>
                    <p id="modal-artist" class="text-sm text-gray-300"></p>
                    <button id="modal-play-btn" class="mt-3 bg-[#A0C4FF] text-white font-bold py-2 px-6 rounded-full text-sm">
                        <i class="fas fa-play mr-2"></i>播放
                    </button>
                </div>
            </div>
            <div id="modal-description"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // [優化] 集中管理 DOM 元素
            const domElements = {
                sidebarItemsContainer: document.getElementById('sidebar-items'),
                collectionEmptyState: document.getElementById('collection-empty-state'),
                searchInput: document.getElementById('search-input'),
                clearSearchBtn: document.getElementById('clear-search-btn'),
                searchBtn: document.getElementById('search-btn'),
                libraryTitle: document.getElementById('library-title'),
                mainContent: document.getElementById('main-content'),
                defaultView: document.getElementById('default-view'),
                searchResultsView: document.getElementById('search-results-view'),
                podcastDetailView: document.getElementById('podcast-detail-view'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                playPauseIcon: document.getElementById('play-pause-icon'),
                playerTitleContainer: document.getElementById('player-title-container'),
                playerTitle: document.getElementById('player-title'),
                playerArtist: document.getElementById('player-artist'),
                playerAlbumArt: document.getElementById('player-album-art'),
                progress: document.getElementById('progress'),
                progressBar: document.getElementById('progress-bar'),
                currentTimeEl: document.getElementById('current-time'),
                durationEl: document.getElementById('duration'),
                downloadBtn: document.getElementById('download-btn'),
                playbackRateBtn: document.getElementById('playback-rate-btn'),
                playbackRateText: document.getElementById('playback-rate-text'),
                repeatBtn: document.getElementById('repeat-btn'),
                skipBackwardBtn: document.getElementById('skip-backward-btn'),
                skipForwardBtn: document.getElementById('skip-forward-btn'),
                soundIconContainer: document.getElementById('sound-icon-container'),
                sortDirectionBtn: document.getElementById('sort-direction-btn'),
                sortIcon: document.getElementById('sort-icon'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                filterFavoritesBtn: document.getElementById('filter-favorites-btn'),
                localSearchInput: document.getElementById('local-search-input'),
                viewModeListBtn: document.getElementById('view-mode-list'),
                viewModeGridBtn: document.getElementById('view-mode-grid'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                modalPlayBtn: document.getElementById('modal-play-btn'),
                toastContainer: document.getElementById('toast-container'),
                volumeSlider: document.getElementById('volume-slider'),
                volumeIconBtn: document.getElementById('volume-icon-btn'),
                volumeTooltip: document.getElementById('volume-tooltip'),
                volumeContainer: document.getElementById('volume-container'),
                welcomeModalOverlay: document.getElementById('welcome-modal-overlay'),
                welcomeModal: document.getElementById('welcome-modal'),
                welcomeForm: document.getElementById('welcome-form'),
                nicknameInput: document.getElementById('nickname-input'),
                skipWelcomeBtn: document.getElementById('skip-welcome-btn'),
                downloadRtfBtn: document.getElementById('download-rtf-btn'),
                savedEpisodesContent: document.getElementById('saved-episodes-content'),
                importRtfBtn: document.getElementById('import-rtf-btn'),
                importRtfInput: document.getElementById('import-rtf-input'),
                importSavedEpisodesInput: document.getElementById('import-saved-episodes-input'),
            };

            const soundIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect class="sound-wave sound-wave-1" x="4" y="8" width="4" height="8" rx="1"></rect><rect class="sound-wave sound-wave-2" x="10" y="5" width="4" height="14" rx="1"></rect><rect class="sound-wave sound-wave-3" x="16" y="8" width="4" height="8" rx="1"></rect></svg>`;
            const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>`;
            const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>`;
            
            const CORS_PROXY = 'https://corsproxy.io/?';
            const GENRE_ICONS = {
                'Default': '<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g1" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#90a4ae"/><stop offset="1" stop-color="#546e7a"/></linearGradient></defs><path fill="url(#g1)" d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6s20.4 9.1 20.4 20.4-9.1 20.4-20.4 20.4z"/><path fill="#fff" d="M24 34c-5.5 0-10-4.5-10-10V14c0-2.8 2.2-5 5-5s5 2.2 5 5v10c0 2.8-2.2 5-5 5zm-8-10c0 4.4 3.6 8 8 8s8-3.6 8-8V14c0-4.4-3.6-8-8-8s-8 3.6-8 8v10z"/></svg>',
                'Technology': '<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g2" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#4fc3f7"/><stop offset="1" stop-color="#039be5"/></linearGradient></defs><path fill="url(#g2)" d="M40.4 3.6H7.6C5.4 3.6 3.6 5.4 3.6 7.6v25.8c0 2.2 1.8 4 4 4h32.8c2.2 0 4-1.8 4-4V7.6c0-2.2-1.8-4-4-4z"/><path fill="#fff" d="M19 12.9h-5.2v2.6H19zm-5.2 5.2H19v2.6h-5.2zm5.2 5.2h-5.2v2.6H19zm2.6-10.4h5.2v2.6h-5.2zm0 5.2h5.2v2.6h-5.2zm5.2 5.2h-5.2v2.6h5.2zm2.6-10.4H35v2.6h-5.8zm0 5.2H35v2.6h-5.8zm5.8 5.2H29v2.6H35z"/><path fill="#607d8b" d="M44.4 37.1H3.6v3.7c0 2.1 1.7 3.8 3.8 3.8h33.2c2.1 0 3.8-1.7 3.8-3.8v-3.7z"/></svg>',
                'Business': '<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g3" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#66bb6a"/><stop offset="1" stop-color="#388e3c"/></linearGradient></defs><path fill="#cfd8dc" d="M3.6 14.7h40.8v28.1H3.6z"/><path fill="url(#g3)" d="M42.6 11H5.4c-1 0-1.8.8-1.8 1.8v3.7h40.8v-3.7c0-1-.8-1.8-1.8-1.8z"/><path fill="#546e7a" d="M30.4 5.5h-12.8c-1 0-1.8.8-1.8 1.8v3.7h16.4V7.3c0-1-.8-1.8-1.8-1.8z"/></svg>',
                'News': '<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g4" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ff7043"/><stop offset="1" stop-color="#e64a19"/></linearGradient></defs><circle fill="url(#g4)" cx="24" cy="24" r="20.4"/><path fill="#fff" d="M15.8 32.1h16.4v3.7H15.8zM15.8 24.7h16.4v3.7H15.8zM15.8 17.2h16.4v3.7H15.8zM15.8 9.8h16.4v3.7H15.8z"/></svg>',
                'Arts': '<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g5" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ab47bc"/><stop offset="1" stop-color="#7b1fa2"/></linearGradient></defs><path fill="url(#g5)" d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6s20.4 9.1 20.4 20.4-9.1 20.4-20.4 20.4z"/><path fill="#fff" d="M24 35.3c-6.2 0-11.3-5.1-11.3-11.3s5.1-11.3 11.3-11.3 11.3 5.1 11.3 11.3-5.1 11.3-11.3 11.3z"/><path fill="#ce93d8" d="M38 35.3c-2.3 0-4.2-1.9-4.2-4.2s1.9-4.2 4.2-4.2 4.2 1.9 4.2 4.2-1.9 4.2-4.2 4.2z"/></svg>',
                'Health & Fitness': '<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g6" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#f06292"/><stop offset="1" stop-color="#d81b60"/></linearGradient></defs><path fill="url(#g6)" d="M24 44.4L21.3 42c-8.9-8-15.7-13.7-15.7-21.1C5.6 12.3 12 6 19.4 6c3.2 0 6.3 1.5 8.3 4l2.3-3.1 2.3 3.1c2-2.5 5.1-4 8.3-4 7.4 0 13.8 6.3 13.8 14.9 0 7.4-6.7 13.1-15.7 21.1L24 44.4z"/></svg>',
                'Sports':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g7" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ffca28"/><stop offset="1" stop-color="#ffa000"/></linearGradient></defs><circle fill="url(#g7)" cx="24" cy="24" r="20.4"/><path d="M24 12.7c-2.1 0-3.8 1.7-3.8 3.8s1.7 3.8 3.8 3.8 3.8-1.7 3.8-3.8-1.7-3.8-3.8-3.8zm-7.6 7.6c-2.1 0-3.8 1.7-3.8 3.8s1.7 3.8 3.8 3.8 3.8-1.7 3.8-3.8-1.7-3.8-3.8-3.8zm15.2 0c-2.1 0-3.8 1.7-3.8 3.8s1.7 3.8 3.8 3.8 3.8-1.7 3.8-3.8-1.7-3.8-3.8-3.8z" fill="#fff"/></svg>',
                'Comedy':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g8" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#FFEE58"/><stop offset="1" stop-color="#F9A825"/></linearGradient></defs><circle cx="24" cy="24" r="20.4" fill="url(#g8)"/><path d="M17.4,19.8c-2.1,0-3.8,1.7-3.8,3.8s1.7,3.8,3.8,3.8s3.8-1.7,3.8-3.8S19.5,19.8,17.4,19.8z M30.6,19.8c-2.1,0-3.8,1.7-3.8,3.8s1.7,3.8,3.8,3.8s3.8-1.7,3.8-3.8S32.7,19.8,30.6,19.8z M24,30c-5,0-9.4,2.7-12,6.8c2.6,4,7,6.8,12,6.8s9.4-2.7,12-6.8C33.4,32.7,29,30,24,30z"/></svg>',
                'Society & Culture':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g9" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ef5350"/><stop offset="1" stop-color="#c62828"/></linearGradient></defs><circle cx="24" cy="24" r="20.4" fill="url(#g9)"/><path d="M24 12.9c-2.8 0-5.1 2.3-5.1 5.1s2.3 5.1 5.1 5.1 5.1-2.3 5.1-5.1-2.3-5.1-5.1-5.1zm0 7.7c-1.4 0-2.6-1.1-2.6-2.6s1.1-2.6 2.6-2.6 2.6 1.1 2.6 2.6-1.1 2.6-2.6 2.6zm0 7.7c-7.7 0-14.1 4.3-15.3 10.2h30.6c-1.2-5.9-7.6-10.2-15.3-10.2z" fill="#fff"/></svg>',
                'Education':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g10" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#42a5f5"/><stop offset="1" stop-color="#1565c0"/></linearGradient></defs><path fill="url(#g10)" d="M24 3.6L3.6 14.1l20.4 10.5 20.4-10.5L24 3.6zm0 24.2L8.5 20.1l15.5-8 15.5 8L24 27.8z"/><path fill="#1e88e5" d="M9.9 29.3l-4.2 2.1c-1.1.6-1.8 1.8-1.8 3v5.5h12.1v-8.4l-6.1-2.2zm28.2 0l-6.1 2.2v8.4h12.1v-5.5c0-1.2-.7-2.4-1.8-3l-4.2-2.1z"/></svg>',
                'History':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g11" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#8d6e63"/><stop offset="1" stop-color="#5d4037"/></linearGradient></defs><circle cx="24" cy="24" r="20.4" fill="url(#g11)"/><path d="M24 10.4c-7.5 0-13.6 6.1-13.6 13.6s6.1 13.6 13.6 13.6 13.6-6.1 13.6-13.6-6.1-13.6-13.6-13.6zm0 24c-5.7 0-10.4-4.7-10.4-10.4s4.7-10.4 10.4-10.4 10.4 4.7 10.4 10.4-4.7 10.4-10.4 10.4z" fill="#fff"/><path d="M25.3 15.4h-2.6v9.3l8 4.7 1.3-2.2-6.7-3.9z" fill="#fff"/></svg>',
                'Science':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g12" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#26a69a"/><stop offset="1" stop-color="#00695c"/></linearGradient></defs><path fill="url(#g12)" d="M44.4 24c0 11.3-9.1 20.4-20.4 20.4S3.6 35.3 3.6 24 12.7 3.6 24 3.6s20.4 9.1 20.4 20.4z"/><path d="M30.4 16.5c-1.1-1.3-2.5-2.2-4.1-2.7-2.3-.7-4.8-.3-6.8 1.1-2.9 2-4.2 5.6-3.2 9l-4.5 2.5c-1.1.6-1.5 2-1 3.1.6 1.1 2 1.5 3.1 1l4.5-2.5c1.4 2.2 3.6 3.8 6.1 4.5 3.3.9 6.7.1 9.2-2.3s3.4-6.1 2.3-9.5c-.7-2.1-2.2-3.8-4.2-4.7z" fill="#fff"/></svg>',
                'True Crime':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g13" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#757575"/><stop offset="1" stop-color="#424242"/></linearGradient></defs><circle cx="24" cy="24" r="20.4" fill="url(#g13)"/><path d="M32.5 28.3l-4.5-4.5c1.2-1.6 1.9-3.6 1.9-5.7 0-5.2-4.2-9.4-9.4-9.4s-9.4 4.2-9.4 9.4 4.2 9.4 9.4 9.4c2.1 0 4.1-.7 5.7-1.9l4.5 4.5 1.7-1.7zm-12-3.8c-3.8 0-6.9-3.1-6.9-6.9s3.1-6.9 6.9-6.9 6.9 3.1 6.9 6.9-3.1 6.9-6.9 6.9z" fill="#fff"/></svg>',
                'Music':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g14" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ec407a"/><stop offset="1" stop-color="#ad1457"/></linearGradient></defs><circle cx="24" cy="24" r="20.4" fill="url(#g14)"/><path d="M20.2 13.9v12.3c0 2.6-2.1 4.7-4.7 4.7s-4.7-2.1-4.7-4.7 2.1-4.7 4.7-4.7c.8 0 1.6.2 2.3.6V11.2h10.4v2.7h-8z" fill="#fff"/></svg>',
                'TV & Film':'<svg class="genre-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g15" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#5c6bc0"/><stop offset="1" stop-color="#303f9f"/></linearGradient></defs><path fill="url(#g15)" d="M37.9 3.6H10.1C7.8 3.6 6 5.4 6 7.6v32.8c0 2.2 1.8 4 4.1 4h27.8c2.3 0 4.1-1.8 4.1-4V7.6c0-2.2-1.8-4-4.1-4z"/><path d="M16.5 14h-5.4v5.4h5.4V14zm0 8.1h-5.4v5.4h5.4v-5.4zm0 8.1h-5.4v5.4h5.4v-5.4zm8.1-16.2h-5.4v5.4h5.4V14zm0 8.1h-5.4v5.4h5.4v-5.4zm0 8.1h-5.4v5.4h5.4v-5.4zm8.1-16.2h-5.4v5.4h5.4V14zm0 8.1h-5.4v5.4h5.4v-5.4zm0 8.1h-5.4v5.4h5.4v-5.4z" fill="#fff"/></svg>',
            };

            const audio = new Audio();
            const collectionCache = {};
            let playerState = { currentEpisode: null, playlist: [], currentIndex: -1, isPlaying: false, _playbackAttempt: 'direct' };
            let isFavoritesFilterActive = false;
            let isFetchingDetails = false;
            let lastProgressUpdateTime = 0;
            let currentViewSource = 'sidebar';
            let searchState = { term: '', results: [], currentIndex: -1, offset: 0, limit: 50 };
            
            let sortableInstance = null;
            let sortMode = 'manual';

            const updateLibraryTitle = (name) => {
                if (name) {
                    const titleEl = document.createElement('span');
                    titleEl.textContent = `${name}的私藏Podcast`;
                    domElements.libraryTitle.innerHTML = '';
                    domElements.libraryTitle.appendChild(titleEl);
                } else {
                    domElements.libraryTitle.textContent = '我的私藏Podcast';
                }
            };

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                domElements.toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };

            const getCollection = () => JSON.parse(localStorage.getItem('podcastCollection') || '[]');
            const saveCollection = (collection) => localStorage.setItem('podcastCollection', JSON.stringify(collection));
            const getSavedEpisodes = () => JSON.parse(localStorage.getItem('savedEpisodes') || '[]');
            const saveSavedEpisodes = (episodes) => localStorage.setItem('savedEpisodes', JSON.stringify(episodes));
            const getPlaybackProgress = () => JSON.parse(localStorage.getItem('playbackProgress') || '{}');
            const savePlaybackProgress = (episodeId, currentTime, duration) => {
                if (!episodeId || !duration) return;
                const progressData = getPlaybackProgress();
                progressData[episodeId] = { currentTime, duration };
                localStorage.setItem('playbackProgress', JSON.stringify(progressData));
            };
            
            const getPlayerSettings = () => JSON.parse(localStorage.getItem('playerSettings') || '{}');
            const savePlayerSettings = () => {
                const settings = {
                    volume: audio.volume,
                    playbackRate: audio.playbackRate,
                    isRepeating: playerState.isRepeating,
                    lastVolume: lastVolume 
                };
                localStorage.setItem('playerSettings', JSON.stringify(settings));
            };
            
            // [修改] 調整下載節目表的版面與內容
            const downloadCollectionAsRtf = () => {
                const collection = getCollection();
                if (collection.length === 0) {
                    showToast('您的媒體庫是空的，無法下載。', 'error');
                    return;
                }

                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${yyyy}-${mm}-${dd}`;
                const filename = `Podcast 節目表 ${formattedDate}.html`;
                const escapeHTML = (str) => String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

                let htmlContent = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Podcast 節目表 ${formattedDate}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f5f5f7; color: #333; }
        .container { max-width: 95%; margin: 40px auto; padding: 20px; }
        .title-bar { display: flex; align-items: center; justify-content: center; position: relative; padding: 16px; margin-bottom: 20px; }
        .traffic-lights { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background-color: #ff5f56; } .dot.yellow { background-color: #ffbd2e; } .dot.green { background-color: #27c93f; }
        .title-bar h1 { margin: 0; font-size: 1.2rem; font-weight: 600; color: #007aff; }
        table { border-collapse: collapse; width: 100%; background-color: rgba(255, 255, 255, 0.6); -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); overflow: hidden; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); vertical-align: middle; }
        th { font-weight: 600; }
        tr:last-child td { border-bottom: none; }
        .podcast-icon { width: 40px; height: 40px; border-radius: 8px; }
        a { color: #007aff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-bar">
            <div class="traffic-lights"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
            <h1>Podcast 節目表 (${formattedDate})</h1>
        </div>
        <table>
            <thead><tr><th>類型</th><th colspan="2">節目名稱</th><th>主持人 (來源)</th><th>節目連結</th></tr></thead>
            <tbody>`;

                collection.forEach(podcast => {
                    const genre = escapeHTML(podcast.primaryGenreName || 'N/A');
                    const name = escapeHTML(podcast.collectionName || 'N/A');
                    const artist = escapeHTML(podcast.artistName || 'N/A');
                    const artworkUrl = podcast.artworkUrl60 || 'https://placehold.co/40x40/f5f5f7/333?text=NA';
                    const podcastLink = escapeHTML(podcast.collectionViewUrl || '#');
                    
                    htmlContent += `
                        <tr data-collection-name="${name}" data-artist-name="${artist}">
                           <td>${genre}</td>
                           <td><img src="${artworkUrl}" alt="icon" class="podcast-icon"></td>
                           <td>${name}</td>
                           <td>${artist}</td>
                           <td><a href="${podcastLink}" target="_blank">收聽頁面</a></td>
                        </tr>`;
                });
                
                htmlContent += `</tbody></table></div></body></html>`;

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("節目表 HTML 檔案匯出成功！", "success");
            };

            async function handleCollectionImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const htmlString = e.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, 'text/html');
                    const rows = doc.querySelectorAll('tbody tr');

                    if (rows.length === 0) {
                        showToast('未在檔案中找到可匯入的節目。', 'error');
                        return;
                    }

                    showToast(`找到 ${rows.length} 個節目，正在搜尋並匯入...`);
                    
                    const currentCollection = getCollection();
                    const existingIds = new Set(currentCollection.map(p => p.collectionId));
                    let addedCount = 0;
                    let failedCount = 0;

                    const importPromises = Array.from(rows).map(row => {
                        const collectionName = row.dataset.collectionName;
                        const artistName = row.dataset.artistName;

                        if (!collectionName || !artistName) return Promise.resolve(null);
                        
                        const searchTerm = `${collectionName} ${artistName}`;
                        const targetUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(searchTerm)}&entity=podcast&limit=5`;
                        
                        return fetch(CORS_PROXY + encodeURIComponent(targetUrl))
                            .then(res => res.json())
                            .then(data => {
                                if (data.results && data.results.length > 0) {
                                    const bestMatch = data.results.find(p => p.collectionName === collectionName && p.artistName === artistName);
                                    return bestMatch || data.results[0];
                                }
                                return null;
                            })
                            .catch(err => {
                                console.error('匯入搜尋失敗:', collectionName, err);
                                return null;
                            });
                    });

                    const results = await Promise.allSettled(importPromises);
                    
                    let newPodcasts = [];
                    for (const result of results) {
                        if (result.status === 'fulfilled' && result.value) {
                            const podcast = result.value;
                            if (!existingIds.has(podcast.collectionId)) {
                                newPodcasts.push({ ...podcast, addedAt: Date.now(), isFavorite: false });
                                existingIds.add(podcast.collectionId);
                                addedCount++;
                            }
                        } else {
                            failedCount++;
                        }
                    }

                    if (newPodcasts.length > 0) {
                        const updatedCollection = [...newPodcasts, ...currentCollection];
                        saveCollection(updatedCollection);
                        loadCollection();
                        domElements.defaultView.style.display = 'none';
                    }

                    showToast(`匯入完成！成功新增 ${addedCount} 個節目，失敗 ${failedCount} 個。`, 'success');
                    event.target.value = '';
                };
                reader.readAsText(file);
            }

            const loadCollection = () => {
                let collection = getCollection();
                let filteredCollection = isFavoritesFilterActive ? collection.filter(p => p.isFavorite) : collection;

                const searchTerm = domElements.localSearchInput.value.toLowerCase();
                if (searchTerm) {
                    filteredCollection = filteredCollection.filter(p => p.collectionName.toLowerCase().includes(searchTerm) || p.artistName.toLowerCase().includes(searchTerm));
                }

                domElements.sidebarItemsContainer.innerHTML = ''; 

                if (collection.length === 0) {
                    domElements.collectionEmptyState.style.display = 'block';
                    domElements.sidebarItemsContainer.appendChild(domElements.collectionEmptyState);
                    return;
                }
                
                domElements.collectionEmptyState.style.display = 'none';

                if (filteredCollection.length === 0) {
                    domElements.sidebarItemsContainer.innerHTML = `<p class="text-center text-sm text-[var(--color-text-secondary)] p-4">沒有符合篩選條件的項目。</p>`;
                    return;
                }
                
                if (sortMode === 'manual' && !searchTerm && !isFavoritesFilterActive) {
                    filteredCollection.forEach(podcast => renderCollectionItem(podcast));
                } else {
                    const groupedByGenre = filteredCollection.reduce((acc, podcast) => {
                        const genre = podcast.primaryGenreName || '未分類';
                        if (!acc[genre]) { acc[genre] = []; }
                        acc[genre].push(podcast);
                        return acc;
                    }, {});

                    const sortedGenres = Object.keys(groupedByGenre).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                    
                    sortedGenres.forEach(genre => {
                        const header = document.createElement('h3');
                        header.className = 'sidebar-genre-header';
                        const iconSVG = GENRE_ICONS[genre] || GENRE_ICONS['Default'];
                        header.innerHTML = `${iconSVG}<span class="genre-text">${genre}</span>`;
                        domElements.sidebarItemsContainer.appendChild(header);

                        const podcastsInGenre = groupedByGenre[genre];
                        
                        if (sortMode !== 'manual') {
                            const isAsc = sortMode === 'asc';
                            podcastsInGenre.sort((a, b) => 
                                isAsc 
                                ? a.collectionName.localeCompare(b.collectionName, 'zh-Hant') 
                                : b.collectionName.localeCompare(a.collectionName, 'zh-Hant')
                            );
                        }
                        
                        podcastsInGenre.forEach(podcast => renderCollectionItem(podcast));
                    });
                }
            };
            
            const addToCollection = (podcast) => {
                const collection = getCollection();
                if (!collection.some(p => p.collectionId === podcast.collectionId)) {
                    collection.unshift({ ...podcast, addedAt: Date.now(), isFavorite: false });
                    saveCollection(collection);
                    loadCollection();
                    updateSearchItemUI(podcast.collectionId, true);
                    domElements.defaultView.style.display = 'none';
                    showToast(`已將「${podcast.collectionName}」加入收藏`); 
                }
            };

            const removeFromCollection = (collectionId) => {
                let collection = getCollection();
                const podcast = collection.find(p => p.collectionId === collectionId);
                collection = collection.filter(p => p.collectionId !== collectionId);
                saveCollection(collection);
                loadCollection();
                updateSearchItemUI(collectionId, false);
                 if (getCollection().length === 0) {
                    domElements.defaultView.style.display = 'flex';
                }
                if(podcast) showToast(`已從收藏移除「${podcast.collectionName}」`, 'error'); 
            };

            const toggleFavoriteStatus = (collectionId) => {
                let collection = getCollection();
                const podcast = collection.find(p => p.collectionId === collectionId);
                if (podcast) {
                    podcast.isFavorite = !podcast.isFavorite;
                    saveCollection(collection);
                    if (isFavoritesFilterActive && !podcast.isFavorite) {
                        loadCollection();
                    } else {
                        const item = document.querySelector(`.sidebar-item[data-id="${collectionId}"]`);
                        if (item) {
                            const favBtn = item.querySelector('.fav-btn');
                            favBtn.classList.toggle('is-favorite', podcast.isFavorite);
                            favBtn.querySelector('i').className = `fa-heart ${podcast.isFavorite ? 'fas' : 'far'}`;
                        }
                    }
                    showToast(podcast.isFavorite ? `已將「${podcast.collectionName}」標記為最愛` : `已將「${podcast.collectionName}」取消最愛`);
                }
            };
            
            function renderCollectionItem(podcast) {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.dataset.id = podcast.collectionId;
                item.title = `${podcast.collectionName} - ${podcast.artistName}`;
                const trashSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.144-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.057-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                const heartIconClass = podcast.isFavorite ? 'fas' : 'far';
                item.innerHTML = `
                    <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                    <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName}" class="w-12 h-12 rounded-lg flex-shrink-0">
                    <div class="flex-1 overflow-hidden sidebar-item__text-wrapper">
                        <div class="font-semibold text-sm">${podcast.collectionName}</div>
                        <div class="text-xs text-gray-400 truncate">${podcast.artistName}</div>
                    </div>
                    <div class="sidebar-item-actions">
                        <button class="sidebar-action-btn fav-btn ${podcast.isFavorite ? 'is-favorite' : ''}" title="標記為最愛"><i class="${heartIconClass} fa-heart"></i></button>
                        <button class="sidebar-action-btn" title="從收藏移除">${trashSVG}</button>
                    </div>`;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.sidebar-item-actions') || e.target.closest('.drag-handle')) return;
                    document.querySelector('.sidebar-item.is-active')?.classList.remove('is-active');
                    item.classList.add('is-active');
                    currentViewSource = 'sidebar';
                    fetchEpisodes(podcast.collectionId);
                });
                const [favBtn, deleteBtn] = item.querySelectorAll('.sidebar-action-btn');
                favBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFavoriteStatus(podcast.collectionId); });
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromCollection(podcast.collectionId); });
                domElements.sidebarItemsContainer.appendChild(item);
            }

            function updateSearchItemUI(collectionId, isCollected) {
                const searchItemBtn = document.querySelector(`.add-to-fav-btn[data-id="${collectionId}"]`);
                if (searchItemBtn) {
                    searchItemBtn.classList.toggle('is-favorite', isCollected);
                    searchItemBtn.querySelector('i').className = `fa-heart ${isCollected ? 'fas' : 'far'}`;
                }
            }
            
            async function searchPodcasts(term, newOffset = 0) {
                const showView = (v) => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById(v).style.display='flex'; };
                if (!term) { 
                    showView('default-view');
                    return; 
                }
                showView('search-results-view');
                const container = document.getElementById('search-results-podcasts');
                container.innerHTML = `<div class="w-full flex justify-center mt-8 col-span-full"><div class="spinner"></div></div>`;
                document.getElementById('search-pagination-controls').innerHTML = '';
                try {
                    const targetUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=podcast&limit=${searchState.limit}&offset=${newOffset}`;
                    const res = await fetch(CORS_PROXY + encodeURIComponent(targetUrl));
                    const data = await res.json();
                    
                    searchState.term = term;
                    searchState.offset = newOffset;
                    searchState.results = data.results;

                    container.innerHTML = !data.results.length ? '<p class="col-span-full text-center text-gray-400">沒有找到相關播客。</p>' : '';
                    const collection = getCollection();
                    data.results.forEach((podcast, index) => {
                        const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `<button class="add-to-fav-btn ${isCollected ? 'is-favorite' : ''}" data-id="${podcast.collectionId}" title="加入/移除收藏"><i class="fa-heart ${isCollected ? 'fas' : 'far'}"></i></button><img src="${podcast.artworkUrl600}" class="w-full rounded-lg mb-1 shadow-lg"><span class="font-bold text-sm truncate w-full" title="${podcast.collectionName}">${podcast.collectionName}</span><span class="text-xs text-gray-400 truncate w-full" title="${podcast.artistName}">${podcast.artistName}</span>`;
                        item.addEventListener('click', () => {
                            currentViewSource = 'search';
                            searchState.currentIndex = index;
                            fetchEpisodes(podcast.collectionId);
                        });
                        const favBtn = item.querySelector('.add-to-fav-btn');
                        favBtn.addEventListener('click', (e) => { e.stopPropagation(); favBtn.classList.contains('is-favorite') ? removeFromCollection(podcast.collectionId) : addToCollection(podcast); });
                        container.appendChild(item);
                    });
                    renderPaginationControls();
                } catch (error) { container.innerHTML = '<p class="text-center text-gray-400 col-span-full">搜尋失敗，請檢查網路連線或稍後再試。</p>'; }
            }
            
            async function getPodcastInfo(collectionId) {
                if (collectionCache[collectionId] && collectionCache[collectionId].feedUrl) return collectionCache[collectionId];
                const targetUrl = `https://itunes.apple.com/lookup?id=${collectionId}`;
                const res = await fetch(CORS_PROXY + encodeURIComponent(targetUrl));
                if (!res.ok) throw new Error(`iTunes API request failed: ${res.status}`);
                const data = await res.json();
                if (data.resultCount === 0 || !data.results[0].feedUrl) throw new Error('Podcast not found or has no feed URL.');
                collectionCache[collectionId] = data.results[0];
                return data.results[0];
            }
            
            async function fetchWithTimeout(resource, options = {}) {
                const { timeout = 10000 } = options;
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const response = await fetch(resource, { ...options, signal: controller.signal });
                    return response;
                } catch (error) {
                    if (error.name === 'AbortError') throw new Error(`請求超時 (超過 ${timeout/1000} 秒)`);
                    throw error;
                } finally {
                    clearTimeout(id);
                }
            }

            async function parseFeed(feedUrl, podcastInfo) {
                const urlWithCacheBuster = new URL(feedUrl);
                urlWithCacheBuster.searchParams.set('_', new Date().getTime());

                const proxyUrl = CORS_PROXY + encodeURIComponent(urlWithCacheBuster.toString());
                try {
                    const res = await fetchWithTimeout(proxyUrl, { timeout: 10000, cache: 'no-cache' });
                    if (!res.ok) throw new Error(`代理伺服器回應錯誤，狀態碼: ${res.status}。`);
                    
                    const xmlText = await res.text();
                    const doc = new DOMParser().parseFromString(xmlText, "application/xml");
                    
                    if (doc.querySelector("parsererror")) throw new Error('解析 XML 失敗，Feed 格式可能不正確。');
                    
                    const episodes = Array.from(doc.querySelectorAll("item")).map(item => {
                        const enclosure = item.querySelector("enclosure");
                        if (!enclosure || !enclosure.getAttribute("url")) return null;
                        return {
                            trackId: item.querySelector("guid")?.textContent || enclosure.getAttribute("url"),
                            trackName: item.querySelector("title")?.textContent || 'Untitled Episode',
                            episodeUrl: enclosure.getAttribute("url"),
                            releaseDate: item.querySelector("pubDate")?.textContent || new Date().toISOString(),
                            description: item.querySelector("description")?.textContent || '',
                            artworkUrl60: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl60,
                            artworkUrl600: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl600,
                            duration: item.querySelector("itunes\\:duration, duration")?.textContent || 0,
                            fileSize: enclosure.getAttribute("length") || 0,
                        };
                    }).filter(Boolean);
                    
                    if (episodes.length === 0) throw new Error('成功解析 RSS Feed，但未找到任何有效的單集。');
                    
                    return episodes;

                } catch (error) {
                    throw new Error(`無法載入 Feed: ${error.message}`);
                }
            }

            async function fetchEpisodes(collectionId) {
                if (isFetchingDetails) return;
                isFetchingDetails = true;
                const showView = (v) => { 
                    domElements.mainContent.querySelectorAll(':scope > div').forEach(d => d.style.display = 'none');
                    domElements[v].style.display = 'flex'; 
                };
                showView('podcastDetailView');
                
                try {
                    const podcastInfo = await getPodcastInfo(collectionId);
                    renderPodcastShell(podcastInfo);
                    const episodes = await parseFeed(podcastInfo.feedUrl, podcastInfo);
                    if (collectionCache[collectionId]) {
                        collectionCache[collectionId].episodes = episodes;
                    }
                    populateEpisodesList(episodes, podcastInfo);
                } catch (error) {
                    domElements.podcastDetailView.innerHTML = `<div class="text-center text-[var(--color-text-secondary)] m-auto"><p class="font-bold text-lg mb-2">哎呀！節目資訊載入失敗了</p><p class="text-sm">${error.message}</p><p class="text-xs mt-2">可能是對方的伺服器有點問題，或是您的網路不太穩定。請稍後再試試看。</p></div>`;
                } finally {
                    isFetchingDetails = false;
                }
            }

            function renderPodcastShell(podcast) {
                const collection = getCollection();
                const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                const btnText = isCollected ? '✓ 已收藏' : '收藏';
                const btnColor = isCollected ? '#6c757d' : '#27C93F';
                const btnDisabled = isCollected ? 'disabled' : '';
                
                let navHeaderHTML = '';
                if (currentViewSource === 'search') {
                    navHeaderHTML = `
                        <div id="detail-view-nav" class="flex items-center justify-between mb-4 flex-shrink-0">
                            <button id="detail-nav-back" class="nav-button" title="返回搜尋結果">
                                <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M22 18H12M12 18L17 13M12 18L17 23" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <div class="flex items-center gap-4">
                                <button id="detail-nav-prev-podcast" class="nav-button" title="上一個節目">
                                     <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M20.25 24L14.25 18L20.25 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                <button id="detail-nav-next-podcast" class="nav-button" title="下一個節目">
                                    <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M15.75 12L21.75 18L15.75 24" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                        </div>`;
                }

                const tooltipText = `節目名稱：${podcast.collectionName}\n主持人：${podcast.artistName}\n類型：${podcast.primaryGenreName}\n單集總數：${podcast.trackCount}`;
                domElements.podcastDetailView.innerHTML = `
                    ${navHeaderHTML}
                    <div class="podcast-header">
                        <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName} cover" title="${tooltipText}">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl font-bold truncate">${podcast.collectionName}</h1>
                                <button id="add-to-collection-btn" style="background-color: ${btnColor};" class="text-white font-bold py-1 px-3 rounded-full text-sm ml-4 flex-shrink-0" ${btnDisabled}>${btnText}</button>
                            </div>
                            <p class="text-sm mt-1 truncate">${podcast.artistName}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 mb-2">
                        <h2 class="text-xl font-bold">最新單集</h2>
                        <div class="flex items-center gap-4">
                            <button id="detail-prev-btn" class="simple-control-btn detail-nav-btn" title="上一集"><i class="fas fa-backward-step"></i></button>
                            <button id="detail-next-btn" class="simple-control-btn detail-nav-btn" title="下一集"><i class="fas fa-forward-step"></i></button>
                        </div>
                    </div>
                    <div id="episodes-placeholder"><div class="spinner"></div><p>正在載入節目...</p></div>`;
                
                if (currentViewSource === 'search') {
                    document.getElementById('detail-nav-back').addEventListener('click', () => {
                         domElements.podcastDetailView.style.display = 'none';
                         domElements.searchResultsView.style.display = 'flex';
                    });
                    document.getElementById('detail-nav-prev-podcast').addEventListener('click', navigatePodcastInSearch(-1));
                    document.getElementById('detail-nav-next-podcast').addEventListener('click', navigatePodcastInSearch(1));
                    updateDetailNav();
                }

                const collectBtn = document.getElementById('add-to-collection-btn');
                if (collectBtn && !isCollected) {
                    collectBtn.addEventListener('click', () => {
                        addToCollection(podcast);
                        collectBtn.textContent = '✓ 已收藏';
                        collectBtn.disabled = true;
                        collectBtn.style.backgroundColor = '#6c757d';
                    });
                }
                document.getElementById('detail-prev-btn').addEventListener('click', () => playNextPrev(-1));
                document.getElementById('detail-next-btn').addEventListener('click', () => playNextPrev(1));
            }

            function populateEpisodesList(episodes, podcast) {
                const placeholder = document.getElementById('episodes-placeholder');
                if (!placeholder) return;
                const escapeAttr = (str) => String(str || '').replace(/"/g, '&quot;');
                const progressData = getPlaybackProgress();
                const savedEpisodes = getSavedEpisodes();

                const episodesHTML = episodes.slice(0, 50).map((ep, index) => {
                    const durationFormatted = formatDuration(ep.duration);
                    const sizeFormatted = formatFileSize(ep.fileSize);
                    
                    const progress = progressData[ep.trackId];
                    const progressPercent = progress && progress.duration ? (progress.currentTime / progress.duration) * 100 : 0;
                    const isListened = progressPercent > 95;
                    const isSaved = savedEpisodes.some(savedEp => savedEp.trackId === ep.trackId);
                    const savedIconClass = isSaved ? 'fas' : 'far';

                    return `
                    <div class="episode-item ${isListened ? 'is-listened' : ''}" data-episode-id="${escapeAttr(ep.trackId)}">
                        <span class="episode-number">${index + 1}</span>
                        <div class="episode-thumbnail-btn">
                           <img src="${ep.artworkUrl60 || podcast.artworkUrl60}" alt="Episode thumbnail">
                           <div class="loading-spinner-overlay"><div class="small-spinner"></div></div>
                        </div>
                        <div class="episode-main-content">
                             <div class="flex-1 overflow-hidden">
                                <div class="font-semibold truncate text-sm" title="${escapeAttr(ep.trackName)}">${ep.trackName}</div>
                            </div>
                        </div>
                        <div class="episode-metadata flex items-center gap-4">
                            <span class="text-xs text-[var(--color-text-secondary)] whitespace-nowrap w-16 text-right">${sizeFormatted || '--- MB'}</span>
                            <span class="text-xs text-[var(--color-text-secondary)] whitespace-nowrap w-12 text-right">${durationFormatted || '--:--'}</span>
                            <span class="episode-date">${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</span>
                        </div>
                        <div class="episode-item-actions">
                            <button class="episode-action-btn save-episode-btn ${isSaved ? 'is-saved' : ''}" title="儲存/取消儲存單集"><i class="${savedIconClass} fa-bookmark"></i></button>
                            <button class="episode-action-btn share-action-btn" title="分享連結"><i class="fas fa-share-alt"></i></button>
                            <a href="${ep.episodeUrl}" download="${escapeAttr(ep.trackName)}.mp3" class="episode-action-btn download-action-link" title="下載"><i class="fas fa-download"></i></a>
                        </div>
                        <div class="sound-icon-container">${soundIconSVG}</div>
                        <div class="episode-progress-bar-container">
                            <div class="episode-progress-bar" style="width: ${progressPercent}%;"></div>
                        </div>
                    </div>`}).join('');
                placeholder.outerHTML = `<div class="podcast-episodes">${episodesHTML}</div>`;

                domElements.podcastDetailView.querySelectorAll('.episode-item').forEach(item => {
                    const ep = episodes.find(e => e.trackId === item.dataset.episodeId);
                    if (!ep) return;
                    item.querySelector('.episode-main-content').addEventListener('click', () => playEpisode(ep, podcast.artistName, episodes));
                    item.querySelector('.episode-thumbnail-btn').addEventListener('click', (e) => { e.stopPropagation(); openEpisodeModal(ep, podcast, episodes); });
                    item.querySelector('.download-action-link')?.addEventListener('click', (e) => e.stopPropagation());
                    
                    const saveBtn = item.querySelector('.save-episode-btn');
                    if(saveBtn) {
                        saveBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            saveEpisodeToggle(ep, podcast);
                        });
                    }

                    const shareBtn = item.querySelector('.share-action-btn');
                    if(shareBtn) {
                        shareBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const urlToCopy = ep.episodeUrl;
                            const textArea = document.createElement('textarea');
                            textArea.value = urlToCopy;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-9999px';
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                showToast('已成功複製單集連結！');
                            } catch (err) {
                                showToast('複製連結失敗。', 'error');
                            }
                            document.body.removeChild(textArea);
                        });
                    }
                });
                syncPlayerUI();
            }

            const saveEpisodeToggle = (episode, podcastInfo) => {
                let savedEpisodes = getSavedEpisodes();
                const existingIndex = savedEpisodes.findIndex(e => e.trackId === episode.trackId);
                const saveBtn = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(episode.trackId))}"] .save-episode-btn`);

                if (existingIndex > -1) {
                    savedEpisodes.splice(existingIndex, 1);
                    showToast(`已從儲存移除單集`, 'error');
                    if (saveBtn) {
                        saveBtn.classList.remove('is-saved');
                        saveBtn.querySelector('i').className = 'far fa-bookmark';
                    }
                } else {
                    const episodeToSave = {
                        ...episode,
                        podcastArtistName: podcastInfo.artistName,
                        podcastCollectionId: podcastInfo.collectionId,
                        podcastArtworkUrl600: podcastInfo.artworkUrl600
                    };
                    savedEpisodes.unshift(episodeToSave);
                    showToast(`已儲存單集！`);
                    if (saveBtn) {
                        saveBtn.classList.add('is-saved');
                        saveBtn.querySelector('i').className = 'fas fa-bookmark';
                    }
                }
                saveSavedEpisodes(savedEpisodes);

                if (document.getElementById('tab-saved-episodes')?.classList.contains('active')) {
                    renderSavedEpisodes();
                }
            };
            
            const downloadSavedEpisodesAsHtml = () => {
                const savedEpisodes = getSavedEpisodes();
                if (savedEpisodes.length === 0) {
                    showToast('您的已存單集列表是空的。', 'error');
                    return;
                }

                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const formattedDate = `${yyyy}-${mm}-${dd}`;
                const filename = `已存單集列表 ${formattedDate}.html`;
                const escapeHTML = (str) => String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

                let htmlContent = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>已存單集列表 ${formattedDate}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f5f5f7; color: #333; }
        .container { max-width: 95%; margin: 20px auto; padding: 20px; }
        h1 { color: #007aff; }
        table { border-collapse: collapse; width: 100%; background-color: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); overflow: hidden; }
        th, td { text-align: left; padding: 8px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { font-weight: 600; background-color: #fafafa; }
        tr:last-child td { border-bottom: none; }
        .episode-artwork { width: 50px; height: 50px; border-radius: 8px; }
        a { color: #007aff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>已存單集列表 (${savedEpisodes.length} 集)</h1>
        <table>
            <thead><tr><th colspan="2">單集名稱</th><th>所屬節目</th><th>發布日期</th><th>音訊連結</th></tr></thead>
            <tbody>`;

                savedEpisodes.forEach(ep => {
                    const dataAttributes = `
                        data-track-id="${escapeHTML(ep.trackId)}"
                        data-track-name="${escapeHTML(ep.trackName)}"
                        data-episode-url="${escapeHTML(ep.episodeUrl)}"
                        data-release-date="${escapeHTML(ep.releaseDate)}"
                        data-description="${escapeHTML(ep.description)}"
                        data-artwork-url-600="${escapeHTML(ep.podcastArtworkUrl600)}"
                        data-duration="${escapeHTML(ep.duration)}"
                        data-podcast-artist-name="${escapeHTML(ep.podcastArtistName)}"
                        data-podcast-collection-id="${escapeHTML(ep.podcastCollectionId)}"
                    `;
                    htmlContent += `
                        <tr ${dataAttributes}>
                           <td><img src="${ep.artworkUrl60 || ep.podcastArtworkUrl600}" alt="artwork" class="episode-artwork"></td>
                           <td>${escapeHTML(ep.trackName)}</td>
                           <td>${escapeHTML(ep.podcastArtistName)}</td>
                           <td>${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</td>
                           <td><a href="${escapeHTML(ep.episodeUrl)}" target="_blank">收聽/下載</a></td>
                        </tr>`;
                });
                
                htmlContent += `</tbody></table></div></body></html>`;

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast("已存單集列表 HTML 檔案匯出成功！", "success");
            };

            function handleSavedEpisodesImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const htmlString = e.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, 'text/html');
                    const rows = doc.querySelectorAll('tbody tr');

                    if (rows.length === 0) {
                        showToast('未在檔案中找到可匯入的單集。', 'error');
                        return;
                    }

                    const currentSavedEpisodes = getSavedEpisodes();
                    const existingTrackIds = new Set(currentSavedEpisodes.map(ep => ep.trackId));
                    let newEpisodes = [];

                    rows.forEach(row => {
                        const trackId = row.dataset.trackId;
                        if (trackId && !existingTrackIds.has(trackId)) {
                            const importedEpisode = {
                                trackId: trackId,
                                trackName: row.dataset.trackName,
                                episodeUrl: row.dataset.episodeUrl,
                                releaseDate: row.dataset.releaseDate,
                                description: row.dataset.description,
                                artworkUrl60: row.dataset.artworkUrl600,
                                artworkUrl600: row.dataset.artworkUrl600,
                                duration: row.dataset.duration,
                                podcastArtistName: row.dataset.podcastArtistName,
                                podcastCollectionId: row.dataset.podcastCollectionId,
                            };
                            newEpisodes.push(importedEpisode);
                            existingTrackIds.add(trackId);
                        }
                    });

                    if (newEpisodes.length > 0) {
                        const updatedEpisodes = [...newEpisodes, ...currentSavedEpisodes];
                        saveSavedEpisodes(updatedEpisodes);
                        showToast(`成功匯入 ${newEpisodes.length} 個新單集！`, 'success');
                        renderSavedEpisodes();
                    } else {
                        showToast('檔案中的所有單集都已存在。', 'success');
                    }
                    
                    event.target.value = '';
                };
                reader.readAsText(file);
            }

            const renderSavedEpisodes = () => {
                const container = domElements.savedEpisodesContent;
                if (!container) return;
                const savedEpisodes = getSavedEpisodes();
                container.innerHTML = '';

                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-4';
                
                const title = document.createElement('h2');
                title.className = 'text-xl font-bold';
                title.textContent = `已儲存的單集 (${savedEpisodes.length})`;
                header.appendChild(title);

                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex items-center gap-4';

                if (savedEpisodes.length > 0) {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'bg-[#007AFF] text-white font-semibold py-2 px-4 rounded-lg text-sm inline-flex items-center gap-2 hover:bg-[#0056b3] transition-colors';
                    downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> 下載列表 (HTML)`;
                    downloadBtn.addEventListener('click', downloadSavedEpisodesAsHtml);
                    btnContainer.appendChild(downloadBtn);
                }
                
                const importBtn = document.createElement('button');
                importBtn.className = 'bg-[#34C759] text-white font-semibold py-2 px-4 rounded-lg text-sm inline-flex items-center gap-2 hover:bg-[#2ca349] transition-colors';
                importBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4-4m0 0-4 4m4-4v12" /></svg> 匯入儲存的單集列表`;
                importBtn.addEventListener('click', () => domElements.importSavedEpisodesInput.click());
                btnContainer.appendChild(importBtn);

                header.appendChild(btnContainer);
                container.appendChild(header);

                if (savedEpisodes.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'text-center p-8 text-[var(--color-text-secondary)]';
                    emptyState.innerHTML = `<i class="far fa-bookmark text-4xl mb-3"></i><p class="font-bold">尚未儲存任何單集</p><p class="text-sm mt-1">在節目列表中點擊 <i class="far fa-bookmark"></i> 即可儲存您喜歡的單集。</p>`;
                    container.appendChild(emptyState);
                    return;
                }

                const table = document.createElement('table');
                table.className = 'saved-episodes-table';
                table.innerHTML = `<thead><tr><th class="col-title">單集名稱</th><th class="col-podcast">所屬節目</th><th class="col-date">發布日期</th><th class="col-actions">音訊連結</th></tr></thead><tbody></tbody>`;

                const tbody = table.querySelector('tbody');
                const escapeAttr = (str) => String(str || '').replace(/"/g, '&quot;');
                
                savedEpisodes.forEach(ep => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="col-title"><div class="flex items-center gap-3"><img src="${ep.artworkUrl600 || ep.artworkUrl60}" class="saved-episode-artwork"><span class="saved-episode-title" title="${escapeAttr(ep.trackName)}">${ep.trackName}</span></div></td>
                        <td class="col-podcast"><span class="saved-episode-artist">${ep.podcastArtistName}</span></td>
                        <td class="col-date"><span>${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</span></td>
                        <td class="col-actions"><div class="flex items-center justify-between"><div class="flex items-center gap-1"><button class="play-saved-btn action-link" title="收聽">收聽</button><span class="text-[var(--color-text-secondary)]">/</span><a href="${ep.episodeUrl}" download="${escapeAttr(ep.trackName)}.mp3" class="download-saved-btn action-link" title="下載單集">下載</a></div><button class="remove-saved-btn" title="移除"><i class="fas fa-times-circle"></i></button></div></td>`;

                    tr.querySelector('.download-saved-btn').addEventListener('click', (e) => e.stopPropagation());
                    tr.querySelector('.play-saved-btn').addEventListener('click', async (e) => {
                        e.stopPropagation();
                        showToast('正在準備播放...');
                        try {
                             if (!collectionCache[ep.podcastCollectionId] || !collectionCache[ep.podcastCollectionId].episodes) {
                                const podcastInfo = await getPodcastInfo(ep.podcastCollectionId);
                                const episodes = await parseFeed(podcastInfo.feedUrl, podcastInfo);
                                if(collectionCache[ep.podcastCollectionId]) collectionCache[ep.podcastCollectionId].episodes = episodes;
                             }
                            const fullPlaylist = collectionCache[ep.podcastCollectionId].episodes;
                            playEpisode(ep, ep.podcastArtistName, fullPlaylist);
                        } catch (error) {
                            showToast('無法載入節目完整列表，播放失敗。', 'error');
                        }
                    });

                    tr.querySelector('.remove-saved-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        let currentSaved = getSavedEpisodes();
                        currentSaved = currentSaved.filter(saved => saved.trackId !== ep.trackId);
                        saveSavedEpisodes(currentSaved);
                        showToast('已移除儲存的單集', 'error');
                        renderSavedEpisodes();
                        const mainSaveBtn = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(ep.trackId))}"] .save-episode-btn`);
                        if (mainSaveBtn) {
                             mainSaveBtn.classList.remove('is-saved');
                             mainSaveBtn.querySelector('i').className = 'far fa-bookmark';
                        }
                    });
                    tbody.appendChild(tr);
                });
                container.appendChild(table);
            };
            
            function openEpisodeModal(episode, podcast, playlist) {
                document.getElementById('modal-artwork').src = episode.artworkUrl600 || podcast.artworkUrl600;
                document.getElementById('modal-date').textContent = new Date(episode.releaseDate).toLocaleDateString();
                document.getElementById('modal-title').textContent = episode.trackName;
                document.getElementById('modal-artist').textContent = podcast.artistName;
                document.getElementById('modal-description').innerHTML = episode.description;
                domElements.modalPlayBtn.onclick = () => { playEpisode(episode, podcast.artistName, playlist); domElements.modalOverlay.style.display = 'none'; };
                domElements.modalOverlay.style.display = 'flex';
            }

            const syncPlayerUI = () => {
                const { currentEpisode, isPlaying } = playerState;
                const playbackRate = audio.playbackRate;
                const isRepeating = playerState.isRepeating;
                
                domElements.playerTitleContainer.classList.toggle('marquee', !!currentEpisode);
                if (currentEpisode) {
                    domElements.playerTitle.textContent = currentEpisode.trackName;
                    domElements.playerTitle.title = currentEpisode.trackName;
                    domElements.playerArtist.textContent = currentEpisode.artistName;
                    domElements.playerAlbumArt.src = currentEpisode.artworkUrl600;
                    domElements.downloadBtn.href = currentEpisode.episodeUrl;
                    domElements.downloadBtn.setAttribute('download', `${(currentEpisode.trackName || 'download').replace(/[/\\?%*:|"<>]/g, '-')}.mp3`);
                    domElements.downloadBtn.classList.add('is-visible');
                } else {
                    domElements.playerTitle.textContent = '尚未播放任何內容';
                    domElements.playerTitle.title = '尚未播放任何內容';
                    domElements.playerArtist.textContent = '';
                    domElements.playerAlbumArt.src = 'https://placehold.co/40x40/222/fff?text=Pod';
                    domElements.downloadBtn.classList.remove('is-visible');
                }
                domElements.soundIconContainer.classList.toggle('is-playing-icon', isPlaying && !!currentEpisode);
                document.querySelector('.episode-item.is-playing-item')?.classList.remove('is-playing-item');
                if (isPlaying && currentEpisode) { document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`)?.classList.add('is-playing-item'); }
                domElements.playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
                domElements.playbackRateText.textContent = `${playbackRate.toFixed(1)}x`;
                domElements.repeatBtn.style.color = isRepeating ? '#A0C4FF' : 'var(--color-text-secondary)';
            };
            
            const playEpisode = (episode, host, playlist) => {
                if (playerState.currentEpisode?.trackId === episode.trackId) {
                    togglePlayPause();
                    return;
                }

                const episodeItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(episode.trackId))}"]`);
                const spinnerContainer = episodeItem?.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');
                
                document.querySelectorAll('.loading-spinner-overlay').forEach(spinner => spinner.style.display = 'none');
                if (spinnerContainer) spinnerContainer.style.display = 'flex';
                
                playerState = {
                    ...playerState,
                    currentEpisode: { ...episode, artistName: host },
                    playlist: playlist,
                    currentIndex: playlist.findIndex(e => e.trackId === episode.trackId),
                    isPlaying: true,
                    _playbackAttempt: 'direct'
                };

                audio.src = episode.episodeUrl;
                
                const progressData = getPlaybackProgress();
                const savedProgress = progressData[episode.trackId];
                if (savedProgress && savedProgress.currentTime < savedProgress.duration * 0.95) {
                    audio.currentTime = savedProgress.currentTime;
                } else {
                    audio.currentTime = 0;
                }

                audio.play().catch(e => console.error("Initial play() was interrupted or failed.", e));
                syncPlayerUI();
            };

            const togglePlayPause = () => { if (!playerState.currentEpisode) return; audio.paused ? audio.play() : audio.pause(); };
            const playNextPrev = (offset) => { if (!playerState.playlist?.length) return; let newIndex = playerState.currentIndex + offset; if (newIndex >= 0 && newIndex < playerState.playlist.length) { const nextEp = playerState.playlist[newIndex]; playEpisode(nextEp, playerState.currentEpisode.artistName, playerState.playlist); } };
            const formatTime = (s) => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}`;

            function formatDuration(duration) {
                if (!duration || duration === 0) return '';
                let totalSeconds;
                if (String(duration).includes(':')) {
                    const parts = String(duration).split(':').reverse();
                    totalSeconds = parts.reduce((acc, part, i) => acc + parseInt(part, 10) * Math.pow(60, i), 0);
                } else {
                    totalSeconds = parseInt(duration, 10);
                }
                if (isNaN(totalSeconds) || totalSeconds === 0) return '';
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                
                let result = `${minutes.toString().padStart(hours > 0 ? 2 : 1, '0')}:${(totalSeconds % 60).toString().padStart(2, '0')}`;
                if (hours > 0) result = `${hours}:${result}`;
                return result;
            }

            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '';
                const size = parseInt(bytes, 10);
                if (isNaN(size) || size === 0) return '';
                const mb = size / (1024 * 1024);
                if (mb < 0.1) return '';
                return `${mb.toFixed(1)} MB`;
            }

            function renderPaginationControls() {
                const container = document.getElementById('search-pagination-controls');
                container.innerHTML = '';
                
                const canGoBack = searchState.offset > 0;
                const canGoForward = searchState.results.length === searchState.limit;

                const prevButton = document.createElement('button');
                prevButton.className = 'nav-button';
                prevButton.title = '上一頁';
                prevButton.disabled = !canGoBack;
                prevButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>`;
                prevButton.addEventListener('click', () => searchPodcasts(searchState.term, searchState.offset - searchState.limit));

                const nextButton = document.createElement('button');
                nextButton.className = 'nav-button';
                nextButton.title = '下一頁';
                nextButton.disabled = !canGoForward;
                nextButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>`;
                nextButton.addEventListener('click', () => searchPodcasts(searchState.term, searchState.offset + searchState.limit));

                if (canGoBack || canGoForward) {
                     container.appendChild(prevButton);
                     container.appendChild(nextButton);
                }
            }

            function updateDetailNav() {
                const prevBtn = document.getElementById('detail-nav-prev-podcast');
                const nextBtn = document.getElementById('detail-nav-next-podcast');
                if (!prevBtn || !nextBtn) return;

                prevBtn.disabled = searchState.currentIndex <= 0;
                nextBtn.disabled = searchState.currentIndex >= searchState.results.length - 1;
            }

            function navigatePodcastInSearch(direction) {
                return () => {
                    const newIndex = searchState.currentIndex + direction;
                    if (newIndex >= 0 && newIndex < searchState.results.length) {
                        searchState.currentIndex = newIndex;
                        const nextPodcast = searchState.results[newIndex];
                        fetchEpisodes(nextPodcast.collectionId);
                    }
                };
            }

            const updateSortUI = () => {
                const isManualSortPossible = !isFavoritesFilterActive && !domElements.localSearchInput.value;
                if (sortMode === 'manual' && isManualSortPossible) {
                    domElements.sortIcon.className = 'fas fa-grip-vertical';
                    domElements.sortDirectionBtn.title = '手動排序';
                    domElements.sidebarItemsContainer.classList.remove('is-sorting-disabled');
                    if (sortableInstance) sortableInstance.option('disabled', false);
                } else if (sortMode === 'asc' || (sortMode === 'manual' && !isManualSortPossible)) {
                    domElements.sortIcon.className = 'fas fa-arrow-up-wide-short';
                    domElements.sortDirectionBtn.title = '升序 (A-Z)';
                    domElements.sidebarItemsContainer.classList.add('is-sorting-disabled');
                    if (sortableInstance) sortableInstance.option('disabled', true);
                } else { // 'desc'
                    domElements.sortIcon.className = 'fas fa-arrow-down-wide-short';
                    domElements.sortDirectionBtn.title = '降序 (Z-A)';
                    domElements.sidebarItemsContainer.classList.add('is-sorting-disabled');
                    if (sortableInstance) sortableInstance.option('disabled', true);
                }
            };

            const initializeSorting = () => {
                if (sortableInstance) {
                    sortableInstance.destroy();
                }

                sortableInstance = new Sortable(domElements.sidebarItemsContainer, {
                    animation: 150,
                    handle: '.drag-handle',
                    filter: '.sidebar-genre-header',
                    preventOnFilter: true,
                    ghostClass: 'sortable-ghost',
                    disabled: sortMode !== 'manual',
                    onEnd: (evt) => {
                        if (sortMode !== 'manual') return;

                        const collection = getCollection();
                        const reorderedIds = Array.from(domElements.sidebarItemsContainer.querySelectorAll('.sidebar-item')).map(item => item.dataset.id);
                        
                        const idMap = new Map(collection.map(p => [String(p.collectionId), p]));
                        const reorderedCollection = reorderedIds.map(id => idMap.get(id)).filter(Boolean);

                        saveCollection(reorderedCollection);
                    }
                });
                updateSortUI();
            };

            function initialize() {
                const savedNickname = localStorage.getItem('podcastNickname');
                const welcomeSkipped = localStorage.getItem('welcomeSkipped');

                if (savedNickname) {
                    updateLibraryTitle(savedNickname);
                } else if (!welcomeSkipped) {
                    if (domElements.welcomeModalOverlay) {
                        domElements.welcomeModalOverlay.style.display = 'flex';
                    }
                }

                if(domElements.welcomeForm) {
                    domElements.welcomeForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const nickname = domElements.nicknameInput.value.trim();
                        if (nickname) {
                            localStorage.setItem('podcastNickname', nickname);
                            updateLibraryTitle(nickname);
                            domElements.welcomeModalOverlay.style.display = 'none';
                        } else {
                            domElements.nicknameInput.focus();
                        }
                    });
                }

                if(domElements.skipWelcomeBtn) {
                    domElements.skipWelcomeBtn.addEventListener('click', () => {
                        localStorage.setItem('welcomeSkipped', 'true');
                        domElements.welcomeModalOverlay.style.display = 'none';
                    });
                }
                
                domElements.soundIconContainer.innerHTML = soundIconSVG;
                
                const savedSettings = getPlayerSettings();
                let lastVolume = savedSettings.lastVolume || 0.5;
                audio.volume = savedSettings.volume !== undefined ? savedSettings.volume : 0.5;
                audio.playbackRate = savedSettings.playbackRate || 1.0;
                playerState.isRepeating = savedSettings.isRepeating || false;
                domElements.volumeSlider.value = audio.volume;
                
                const updateVolumeUI = (vol) => {
                    const volume = parseFloat(vol), percentage = Math.round(volume * 100);
                    const volumeIcon = domElements.volumeIconBtn.querySelector('i');
                    domElements.volumeTooltip.textContent = `${percentage}%`;
                    if (volume === 0) volumeIcon.className = 'fas fa-volume-xmark text-base';
                    else if (volume < 0.5) volumeIcon.className = 'fas fa-volume-low text-base';
                    else volumeIcon.className = 'fas fa-volume-high text-base';
                };
                
                updateVolumeUI(audio.volume);

                domElements.volumeSlider.addEventListener('input', (e) => { 
                    const newVolume = parseFloat(e.target.value); 
                    audio.volume = newVolume; 
                    if (newVolume > 0) lastVolume = newVolume; 
                    updateVolumeUI(newVolume); 
                    savePlayerSettings();
                });
                
                domElements.volumeIconBtn.addEventListener('click', () => { 
                    if (audio.volume > 0) { 
                        lastVolume = audio.volume; 
                        audio.volume = 0; 
                        domElements.volumeSlider.value = 0; 
                    } else { 
                        const restoreVolume = lastVolume > 0 ? lastVolume : 0.5; 
                        audio.volume = restoreVolume; 
                        domElements.volumeSlider.value = restoreVolume; 
                    } 
                    updateVolumeUI(audio.volume);
                    savePlayerSettings();
                });
                
                domElements.volumeContainer.addEventListener('mouseenter', () => domElements.volumeTooltip.style.display = 'block');
                domElements.volumeContainer.addEventListener('mouseleave', () => domElements.volumeTooltip.style.display = 'none');
                
                audio.addEventListener('play', () => { playerState.isPlaying = true; syncPlayerUI(); });
                audio.addEventListener('playing', () => { 
                    const playingItem = document.querySelector('.episode-item.is-playing-item');
                    if(playingItem) {
                       const spinnerContainer = playingItem.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');
                       if (spinnerContainer) spinnerContainer.style.display = 'none';
                    }
                });
                audio.addEventListener('pause', () => { playerState.isPlaying = false; syncPlayerUI(); });
                audio.addEventListener('ended', () => {
                    if (playerState.currentEpisode) {
                        const { trackId } = playerState.currentEpisode;
                        savePlaybackProgress(trackId, audio.duration, audio.duration);
                        const epItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(trackId))}"]`);
                        if (epItem) {
                           epItem.classList.add('is-listened');
                           const progressBar = epItem.querySelector('.episode-progress-bar');
                           if(progressBar) progressBar.style.width = '100%';
                        }
                    }
                    if(playerState.isRepeating) {
                        audio.currentTime = 0;
                        audio.play();
                    } else {
                        playNextPrev(1);
                    }
                });
                
                audio.addEventListener('error', (e) => {
                    console.error("[Audio Error]", audio.error);
                    const { currentEpisode, _playbackAttempt } = playerState;
                    if (!currentEpisode) return; 

                    const episodeItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                    const spinnerContainer = episodeItem?.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');

                    if (_playbackAttempt === 'direct') {
                        playerState._playbackAttempt = 'proxy';
                        const proxyUrl = CORS_PROXY + encodeURIComponent(currentEpisode.episodeUrl);
                        const currentTime = audio.currentTime; 
                        audio.src = proxyUrl;
                        audio.load(); 
                        if(currentTime > 0) audio.currentTime = currentTime;
                        audio.play().catch(err => console.error("Proxy play failed.", err));
                        return; 
                    }

                    if (_playbackAttempt === 'proxy') {
                         if (spinnerContainer) spinnerContainer.style.display = 'none';
                         showToast(`無法載入音訊檔案，來源可能已失效`, 'error');
                         playerState.currentEpisode = null;
                         playerState.isPlaying = false;
                         syncPlayerUI();
                    }
                });

                audio.addEventListener('timeupdate', () => { 
                    if (isNaN(audio.duration)) return; 
                    const { currentTime, duration } = audio;
                    const { currentEpisode } = playerState;

                    domElements.progress.style.width = `${(currentTime / duration) * 100}%`; 
                    domElements.currentTimeEl.textContent = formatTime(currentTime); 
                    domElements.durationEl.textContent = formatTime(duration); 
                    
                    if (currentEpisode) {
                        const now = Date.now();
                        if (now - lastProgressUpdateTime > 2000) {
                            savePlaybackProgress(currentEpisode.trackId, currentTime, duration);
                            lastProgressUpdateTime = now;
                        }
                        
                        const epItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                        if (epItem) {
                            const progressBar = epItem.querySelector('.episode-progress-bar');
                            if(progressBar) progressBar.style.width = `${(currentTime / duration) * 100}%`;
                            epItem.classList.toggle('is-listened', currentTime / duration > 0.95);
                        }
                    }
                });

                domElements.libraryTitle.addEventListener('click', () => { 
                    domElements.mainContent.querySelectorAll(':scope > div').forEach(d => d.style.display = 'none');
                    domElements.defaultView.style.display = 'flex';
                });

                domElements.searchBtn.addEventListener('click', () => searchPodcasts(domElements.searchInput.value));
                domElements.searchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchPodcasts(e.target.value));
                domElements.playPauseBtn.addEventListener('click', togglePlayPause);
                domElements.skipBackwardBtn.addEventListener('click', () => audio.currentTime = Math.max(0, audio.currentTime - 15));
                domElements.skipForwardBtn.addEventListener('click', () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 15));
                domElements.progressBar.addEventListener('click', (e) => { if (audio.duration) audio.currentTime = (e.offsetX / e.currentTarget.offsetWidth) * audio.duration; });
                
                domElements.playbackRateBtn.addEventListener('click', () => { 
                    let currentRate = audio.playbackRate;
                    let newRate = currentRate + 0.5; 
                    if (newRate > 2.0) newRate = 0.5; 
                    audio.playbackRate = newRate; 
                    syncPlayerUI();
                    savePlayerSettings();
                });
                
                domElements.repeatBtn.addEventListener('click', () => { 
                    playerState.isRepeating = !playerState.isRepeating; 
                    syncPlayerUI();
                    savePlayerSettings();
                });

                domElements.localSearchInput.addEventListener('input', () => { loadCollection(); updateSortUI(); });
                domElements.viewModeListBtn.addEventListener('click', () => { domElements.sidebarItemsContainer.classList.remove('grid-view'); domElements.viewModeListBtn.classList.add('active'); domElements.viewModeGridBtn.classList.remove('active'); });
                domElements.viewModeGridBtn.addEventListener('click', () => { domElements.sidebarItemsContainer.classList.add('grid-view'); domElements.viewModeGridBtn.classList.add('active'); domElements.viewModeListBtn.classList.remove('active'); });
                domElements.filterFavoritesBtn.addEventListener('click', () => { isFavoritesFilterActive = !isFavoritesFilterActive; domElements.filterFavoritesBtn.classList.toggle('active', isFavoritesFilterActive); loadCollection(); updateSortUI(); });
                
                domElements.sortDirectionBtn.addEventListener('click', () => {
                    const isManualPossible = !isFavoritesFilterActive && !domElements.localSearchInput.value;
                    let modes = isManualPossible ? ['manual', 'asc', 'desc'] : ['asc', 'desc'];
                    
                    let currentModeForCycle = sortMode;
                    if (!isManualPossible && sortMode === 'manual') {
                        currentModeForCycle = 'asc'; 
                    }

                    const currentIndex = modes.indexOf(currentModeForCycle);
                    sortMode = modes[(currentIndex + 1) % modes.length];
                    
                    localStorage.setItem('podcastSortMode', sortMode);
                    updateSortUI();
                    loadCollection();
                });

                
                const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); domElements.themeToggleBtn.innerHTML = theme === 'dark' ? sunIconSVG : moonIconSVG; localStorage.setItem('theme', theme); };
                domElements.themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
                
                domElements.modalCloseBtn.addEventListener('click', () => domElements.modalOverlay.style.display = 'none');
                domElements.modalOverlay.addEventListener('click', (e) => { if (e.target === domElements.modalOverlay) domElements.modalOverlay.style.display = 'none'; });

                domElements.searchInput.addEventListener('input', () => domElements.clearSearchBtn.style.display = domElements.searchInput.value ? 'block' : 'none');
                domElements.clearSearchBtn.addEventListener('click', () => { domElements.searchInput.value = ''; domElements.searchInput.focus(); domElements.clearSearchBtn.style.display = 'none'; });

                document.addEventListener('keydown', (e) => {
                    if(document.activeElement === domElements.searchInput || document.activeElement === domElements.localSearchInput) return;
                    if(e.code === 'Space') { e.preventDefault(); togglePlayPause(); }
                    if(e.code === 'ArrowRight') { e.preventDefault(); domElements.skipForwardBtn.click(); }
                    if(e.code === 'ArrowLeft') { e.preventDefault(); domElements.skipBackwardBtn.click(); }
                });
                
                domElements.downloadRtfBtn.addEventListener('click', downloadCollectionAsRtf);

                domElements.importRtfBtn.addEventListener('click', () => domElements.importRtfInput.click());
                domElements.importRtfInput.addEventListener('change', handleCollectionImport);
                domElements.importSavedEpisodesInput.addEventListener('change', handleSavedEpisodesImport);


                applyTheme(localStorage.getItem('theme') || 'dark');
                sortMode = localStorage.getItem('podcastSortMode') || 'manual';
                loadCollection();
                initializeSorting();
                syncPlayerUI();
                domElements.mainContent.querySelectorAll(':scope > div').forEach(d => d.style.display = 'none');
                domElements.defaultView.style.display = 'flex';

                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabPanels = document.querySelectorAll('.tab-panel');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const targetTab = button.dataset.tab;
                        if (targetTab === 'tab-saved-episodes') {
                            renderSavedEpisodes();
                        }
                        tabPanels.forEach(panel => {
                            panel.classList.remove('active');
                        });
                        document.getElementById(targetTab).classList.add('active');
                    });
                });
            }
            initialize();
        });
    </script>
</body>
</html>
