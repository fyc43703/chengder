<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast導航站</title>
    <!-- 引入 Tailwind CSS 確保響應式設計和現代化外觀 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2eTDRqN5yI61Rz5oVn2uW/yTzQ1LzW4zLh1tM5hY6k8n+rE8f/a5iK4Xg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 自定義樣式 */
        :root {
            --color-bg: #000;
            --color-surface: #121212;
            --color-surface-hover: #282828;
            --color-interactive-element: #242424;
            --color-text-primary: #fff;
            --color-text-secondary: #b3b3b3;
            --player-height: 60px;
        }

        html[data-theme="light"] {
            --color-bg: #f0f2f5;
            --color-surface: #ffffff;
            --color-surface-hover: #e4e6e9;
            --color-interactive-element: #e4e6e9;
            --color-text-primary: #050505;
            --color-text-secondary: #65676b;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: 'PingFang TC', 'Microsoft JhengHei UI', 'Heiti TC', 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 20rem 1fr;
            height: 100vh;
            padding-top: 0;
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            padding-bottom: var(--player-height);
            gap: 0.5rem;
            box-sizing: border-box;
        }
        
        /* 播放器 CSS */
        .player { position: fixed; bottom: 0; left: 0; right: 0; height: var(--player-height); background-color: var(--color-surface); border-top: 1px solid var(--color-border, #282828); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; gap: 1rem; }
        .player-info { flex: 1 1 30%; display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
        #player-album-art { width: 40px; height: 40px; border-radius: 0.25rem; flex-shrink: 0; }
        .player-controls-wrapper { flex: 1 1 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 0; gap: 0.1rem; }
        .player-actions-wrapper { flex: 1 1 30%; display: flex; align-items: center; justify-content: flex-end; gap: 1rem; }
        .player button, .player a { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; padding: 0; line-height: 1; }
        .player button:hover, .player a:hover { color: var(--color-text-primary); }
        .playback-controls { display: flex; align-items: center; gap: 1.25rem; }
        .simple-control-btn { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; transition: color 0.2s; font-size: 1rem; }
        .simple-control-btn:hover { color: var(--color-text-primary); }
        .detail-nav-btn { color: #A0C4FF; font-size: 1.5rem !important; }
        .detail-nav-btn:hover { color: #8EB8FF; }
        .play-pause-btn { width: 2rem; height: 2rem; border-radius: 50%; background-color: white; color: black; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: transform 0.2s, box-shadow 0.2s; }
        .play-pause-btn:hover { transform: scale(1.1); }
        .play-pause-btn:active { transform: scale(0.95); }
        .play-pause-btn i { color: #A0C4FF; font-size: 0.875rem; }
        .progress-container { display: flex; align-items: center; gap: 0.5rem; width: 100%; }
        #download-btn { display: none; color: #27C93F; }
        #download-btn.is-visible { display: inline-block; }
        #download-btn:hover { color: #22a936; }

        /* 側邊欄 */
        .sidebar { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.25rem; overflow-y: auto; }
        .library-title-styled { background-color: #007AFF; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; display: inline-block; cursor: pointer; align-self: center; }
        .main-container { display: flex; flex-direction: column; gap: 0.5rem; overflow: hidden; }
        .main-content { background-color: var(--color-surface); border-radius: 0.5rem; padding: 1.5rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #theme-toggle-btn { background-color: transparent !important; color: var(--color-text-secondary); width: 44px; height: 44px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* 側邊欄功能區 */
        .sidebar-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; margin-top: 1rem; }
        #local-search-input { background: var(--color-interactive-element); border: none; border-radius: 9999px; padding: 0.5rem 1rem 0.5rem 2.5rem; width: 100%; color: var(--color-text-primary); }
        .view-mode-toggle { display: flex; background: var(--color-interactive-element); padding: 2px; border-radius: 9999px; }
        .view-mode-btn { background: transparent; border: none; color: var(--color-text-secondary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .view-mode-btn.active { background: var(--color-surface-hover); color: var(--color-text-primary); }
        #filter-favorites-btn, #sort-direction-btn { background-color: var(--color-interactive-element); color: var(--color-text-primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        #filter-favorites-btn.active { background-color: #ff3b30; color: white; }

        .sidebar-genre-header {
            background-color: #FFBD2E;
            color: white;
            padding: 0.15rem 0.5rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            align-self: flex-start;
        }

        /* 側邊欄項目: 列表視圖 (預設) */
        .sidebar-item { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.5rem; position: relative; }
        .sidebar-item:hover { background-color: var(--color-surface-hover); }
        .sidebar-item.is-active { background-color: #A0C4FF; color: white; }
        .sidebar-item.is-active .text-xs, .sidebar-item.is-active .text-gray-400 { color: rgba(255,255,255,0.8); }
        .sidebar-item-actions { position: absolute; top: 50%; right: 0.75rem; transform: translateY(-50%); display: flex; align-items: center; gap: 0.5rem; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .sidebar-item:hover .sidebar-item-actions { opacity: 1; visibility: visible; }
        .sidebar-action-btn { background-color: rgba(0,0,0,0.5); border: none; color: white; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; }
        .sidebar-action-btn:hover { background-color: #ff3b30; }
        .sidebar-action-btn.fav-btn.is-favorite, .sidebar-action-btn.fav-btn:hover { background-color: #ff3b30; }
        .sidebar-item__text-wrapper { line-height: 1.4; overflow: hidden; }

        /* 側邊欄項目: 網格視圖 */
        #sidebar-items.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; }
        #sidebar-items.grid-view .sidebar-genre-header {
            grid-column: 1 / -1;
            display: flex;
            align-self: flex-start;
        }
        #sidebar-items.grid-view .sidebar-item { flex-direction: column; padding: 0.5rem; height: auto; align-items: flex-start; }
        #sidebar-items.grid-view .sidebar-item__text-wrapper .text-xs.text-gray-400 { display: none; }
        #sidebar-items.grid-view .sidebar-item img { width: 100%; height: auto; aspect-ratio: 1/1; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        #sidebar-items.grid-view .sidebar-item-actions { top: 0.5rem; right: 0.5rem; transform: none; }
        #sidebar-items.grid-view .sidebar-item__text-wrapper .font-semibold {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            word-break: break-all;
            min-height: 2.8em;
        }
        
        /* 搜尋結果 */
        .search-result-item { position: relative; background-color: var(--color-surface-hover); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
        .add-to-fav-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.6); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: none; opacity: 0; transform: scale(0.8); z-index: 5; }
        .search-result-item:hover .add-to-fav-btn { opacity: 1; transform: scale(1); }
        .add-to-fav-btn:hover { background-color: #FF453A; }
        .add-to-fav-btn.is-favorite { background-color: #FF453A; opacity: 1; transform: scale(1); }
        
        /* Podcast 詳情 */
        .podcast-header { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
        .podcast-header img { width: 3rem; height: 3rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4); flex-shrink: 0; }
        .podcast-episodes { display: flex; flex-direction: column; gap: 0.05rem; flex-grow: 1; overflow-y: auto; }
        .episode-item { position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.4rem 0.5rem; border-radius: 0.25rem; }
        .episode-item .font-semibold {
           color: var(--color-text-secondary);
        }
        .episode-thumbnail-btn { position: relative; width: 2rem; height: 2rem; border-radius: 0.25rem; flex-shrink: 0; cursor: pointer; overflow: hidden; }
        .episode-thumbnail-btn img { width: 100%; height: 100%; object-fit: cover; }
        .episode-main-content { flex: 1; display: flex; align-items: center; gap: 0.75rem; overflow: hidden; cursor: pointer;}
        .episode-number { width: 2.5rem; text-align: right; padding-right: 1rem; color: var(--color-text-secondary); flex-shrink: 0; font-size: 0.875rem; }
        .episode-item:hover { background-color: var(--color-surface-hover); }
        .episode-item.is-listened .font-semibold, .episode-item.is-listened .text-secondary-color { color: var(--color-text-secondary); opacity: 0.6; }
        .episode-item-actions { display: none; align-items: center; gap: 0.75rem; }
        .episode-action-btn { background-color: transparent; border: 1px solid var(--color-text-secondary); color: var(--color-text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .episode-action-btn:hover { background-color: var(--color-text-secondary); color: var(--color-surface); }
        .episode-action-btn.download-action-link { color: #27C93F; border-color: #27C93F; }
        .episode-action-btn.download-action-link:hover { background-color: #27C93F; color: white; }
        .episode-item:not(.is-playing-item):hover .episode-metadata { display: none; }
        .episode-item:not(.is-playing-item):hover .episode-item-actions { display: flex; }
        .episode-date { font-size: 0.75rem; color: var(--color-text-secondary); white-space: nowrap; }
        .episode-progress-bar-container { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: var(--color-interactive-element); border-radius: 0 0 0.25rem 0.25rem; overflow: hidden; }
        .episode-progress-bar { height: 100%; background-color: #FF3B30; width: 0%; }
        
        /* 新增載入中動畫樣式 */
        #episodes-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; gap: 1rem; color: var(--color-text-secondary); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--color-surface-hover); border-top-color: #A0C4FF; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .small-spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.4); border-top-color: #ffffff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-spinner-overlay { position: absolute; left: 0; top: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }

        /* 播放動畫與狀態 */
        .player-title-container.marquee #player-title { display: inline-block; padding-left: 100%; animation: scroll-text 15s linear infinite; }
        @keyframes scroll-text { from { transform: translateX(0); } to { transform: translateX(-100%); } }
        .sound-icon-container { display: none; align-items: center; justify-content: center; flex-shrink: 0; }
        .player-info .sound-icon-container { margin-left: 0.5rem; }
        .player-info .sound-icon-container.is-playing-icon { display: flex; }
        .player-info .sound-icon-container svg { width: 24px; height: 24px; color: #A0C4FF; }
        @keyframes sound-wave-pulse { 0% { transform: scaleY(0.3); } 30% { transform: scaleY(1); } 60% { transform: scaleY(0.5); } 100% { transform: scaleY(0.3); } }
        .sound-wave { transform-origin: 50% 100%; animation: sound-wave-pulse 1.2s ease-in-out infinite; }
        .sound-wave-1 { animation-delay: 0s; } .sound-wave-2 { animation-delay: 0.2s; } .sound-wave-3 { animation-delay: 0.4s; }
        .episode-item.is-playing-item { background-color: #A0C4FF; color: white; }
        .episode-item.is-playing-item .font-semibold, .episode-item.is-playing-item .text-sm, .episode-item.is-playing-item .episode-number, .episode-item.is-playing-item .text-secondary-color { color: white; font-weight: 700; opacity: 1; }
        .episode-item.is-playing-item .episode-metadata, .episode-item.is-playing-item:hover .episode-item-actions { display: none; }
        .episode-item.is-playing-item .sound-icon-container { display: flex; }
        .episode-item.is-playing-item .sound-icon-container svg { width: 24px; height: 24px; color: white; }
        
        #volume-tooltip { position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background-color: var(--color-interactive-element); color: var(--color-text-primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: none; white-space: nowrap; pointer-events: none; }
        #volume-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-width: 5px; border-style: solid; border-color: var(--color-interactive-element) transparent transparent transparent; }

        /* 進度條優化 */
        #progress-bar { position: relative; height: 8px; }
        #progress-bar:hover #progress-handle { opacity: 1; }
        #progress-handle { width: 0.75rem; height: 0.75rem; background-color: white; border-radius: 50%; position: absolute; right: 0; top: 50%; transform: translate(50%, -50%); opacity: 0; transition: opacity 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.3); }

        /* Modal 樣式 */
        #modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #episode-modal { background-color: var(--color-surface); border-radius: 0.75rem; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: var(--color-interactive-element); border: none; color: var(--color-text-primary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        #modal-description { flex-grow: 1; overflow-y: auto; margin-top: 1rem; line-height: 1.7; }
        #modal-description a { color: #A0C4FF; text-decoration: underline; }

        /* 導航按鈕樣式 */
        .nav-button {
            background-color: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-button:hover { opacity: 0.8; }
        .nav-button:disabled { opacity: 0.3; cursor: not-allowed; }
        .nav-button svg { width: 2.25rem; height: 2.25rem; }

        /* MODIFIED: 優化說明頁面樣式 */
        #default-view {
            overflow-y: auto; /* 將捲動軸賦予給 #default-view */
            align-items: flex-start;
            justify-content: flex-start;
        }
        #default-view-content {
            padding: 1rem;
            width: 100%;
            color: var(--color-text-primary);
        }
        .intro-section {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .intro-icon {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
        }
        .intro-title {
            display: inline-block;
            background-color: #007AFF;
            color: white;
            padding: 0.15rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .intro-text {
            line-height: 1.7;
            font-size: 16px;
            color: var(--color-text-secondary);
        }
        .intro-text strong {
            color: var(--color-text-primary);
        }
        .intro-text ul {
            list-style-position: inside;
            padding-left: 0;
        }
        .intro-text li {
            margin-bottom: 1.5rem; /* 增加列表項間距 */
        }
         .intro-text .li-sub-text {
            font-size: 15px;
            padding-left: 1.5rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }

    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="flex items-center gap-2 mb-4">
                <div class="flex items-center gap-1.5 pl-1 flex-shrink-0">
                    <span class="block w-3 h-3 bg-[#FF5F56] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#FFBD2E] rounded-full"></span>
                    <span class="block w-3 h-3 bg-[#27C93F] rounded-full"></span>
                </div>
                <h2 id="library-title" class="text-lg font-bold library-title-styled" title="回到首頁">我的私藏Podcast</h2>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="relative flex-grow">
                    <i class="fas fa-search text-gray-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none z-10"></i>
                    <input type="text" placeholder="搜尋 iTunes..." id="search-input" class="bg-[var(--color-interactive-element)] text-[var(--color-text-primary)] py-2 pl-10 pr-4 rounded-full border-none w-full">
                </div>
                <button id="search-btn" class="bg-[#27C93F] text-white py-2 px-4 rounded-full border-none cursor-pointer flex-shrink-0 font-semibold">搜尋</button>
            </div>
            
            <div class="sidebar-controls">
                <div class="relative flex-grow">
                     <i class="fas fa-filter text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none z-10 text-sm"></i>
                    <input type="text" id="local-search-input" placeholder="篩選收藏庫...">
                </div>
                <div class="flex items-center gap-2 flex-shrink: 0;">
                    <div class="view-mode-toggle" title="切換視圖">
                        <button id="view-mode-list" class="view-mode-btn active"><i class="fas fa-list"></i></button>
                        <button id="view-mode-grid" class="view-mode-btn"><i class="fas fa-grip"></i></button>
                    </div>
                    <button id="filter-favorites-btn" title="只顯示我的最愛">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button id="sort-direction-btn" title="排序">
                        <i id="sort-icon" class="fas fa-arrow-up-wide-short"></i>
                    </button>
                </div>
            </div>

            <div id="sidebar-items" class="flex flex-col mt-2"></div>
        </aside>
        <div class="main-container">
            <div id="app-header" class="bg-[var(--color-surface)] p-2 rounded-lg flex items-center justify-between">
                <div class="flex-1 text-center">
                    <h1 class="text-2xl font-bold">Podcast導航站</h1>
                    <p class="text-sm text-[var(--color-text-primary)]">Podcasts 搜尋使用 Apple iTunes Search API ，能隨時聆聽豐富多元的主題節目，並提供下載音訊檔功能</p>
                    <p class="text-xs text-gray-500 mt-1">製作者：陳政德</p>
                </div>
                <button id="theme-toggle-btn" title="切換主題"></button>
            </div>
            <main class="main-content" id="main-content">
                <div id="default-view" class="h-full">
                    <div id="default-view-content">
                        <div class="intro-section">
                            <div class="intro-icon">
                               <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="a" x1="24" y1="4.33" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ff8754"/><stop offset="1" stop-color="#ff5442"/></linearGradient></defs><path fill="url(#a)" d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6 44.4 12.7 44.4 24 35.3 44.4 24 44.4Z"/><path fill="#fff" d="M19.8 15.3c-1.3 0-2.3.5-3.3 1.5-1 1-1.5 2.2-1.5 3.6 0 .6.1 1.2.4 1.8l-3.2 2.3c-.3-1-.5-2-.5-3.1 0-2.1.7-4 2.1-5.6s3.1-2.4 5.1-2.4c2.2 0 4 .8 5.5 2.3s2.2 3.4 2.2 5.6c0 1.9-.6 3.6-1.8 5.1-1.2 1.5-2.8 2.3-4.9 2.3-1.1 0-2.2-.3-3.2-.8l1.3-3.6c.6.3 1.2.4 1.8.4.9 0 1.7-.3 2.4-1 .7-.7 1.1-1.6 1.1-2.6s-.3-1.8-1-2.5c-.7-.7-1.5-1-2.5-1zM28.2 29.7c-1.3 0-2.3.5-3.3 1.5-1 1-1.5 2.2-1.5 3.6 0 .6.1 1.2.4 1.8l-3.2 2.3c-.3-1-.5-2-.5-3.1 0-2.1.7-4 2.1-5.6 1.4-1.6 3.1-2.4 5.1-2.4 2.2 0 4 .8 5.5 2.3 1.5 1.5 2.2 3.4 2.2 5.6 0 1.9-.6 3.6-1.8 5.1-1.2 1.5-2.8 2.3-4.9 2.3-1.1 0-2.2-.3-3.2-.8l1.3-3.6c.6.3 1.2.4 1.8.4.9 0 1.7-.3 2.4-1 .7-.7 1.1-1.6 1.1-2.6s-.3-1.8-1-2.5c-.7-.7-1.5-1-2.5-1z"/></svg>
                            </div>
                            <div>
                                <h3 class="intro-title">什麼是 Podcast？</h3>
                                <p class="intro-text">
                                    Podcast（中文常譯為「播客」）是一種數位音訊節目，您可以將其想像為「可以隨時點播收聽的網路廣播」。與傳統廣播不同，Podcast 的節目內容包羅萬象，從新聞時事、科技新知、商業財經、歷史故事到喜劇脫口秀等應有盡有。節目通常以一集一集的形式發布，聽眾可以透過網路訂閱自己喜愛的節目，並在任何時間、任何地點，使用手機或電腦等裝置下載或串流收聽，享受不被時間與廣告干擾的沉浸式聆聽體驗。
                                </p>
                            </div>
                        </div>

                        <div class="intro-section">
                            <div class="intro-icon">
                                <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="b" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#32beff"/><stop offset="1" stop-color="#0082ff"/></linearGradient></defs><path fill="url(#b)" d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6 44.4 12.7 44.4 24 35.3 44.4 24 44.4Z"/><path fill="#fff" d="M30.6 14.8c-1.6-1.6-3.7-2.4-6.3-2.4-2.6 0-4.7.8-6.3 2.4-1.6 1.6-2.4 3.7-2.4 6.3s.8 4.7 2.4 6.3c1.6 1.6 3.7 2.4 6.3 2.4s4.7-.8 6.3-2.4c1.6-1.6 2.4-3.7 2.4-6.3s-.8-4.7-2.4-6.3zm-2.5 10.1c-1.1 1.1-2.4 1.6-4 1.6s-2.9-.5-4-1.6c-1.1-1.1-1.6-2.4-1.6-4s.5-2.9 1.6-4c1.1-1.1 2.4-1.6 4-1.6s2.9.5 4 1.6c1.1 1.1 1.6 2.4 1.6 4s-.5 2.9-1.6 4zm-9.3 1.8c-1.1-1.1-1.6-2.4-1.6-4s.5-2.9 1.6-4c.5-.5 1.1-.9 1.8-1.2l-3.3-3.3c-2.1 1.6-3.6 3.6-4.5 5.9h4.3c.4-1 .9-1.8 1.6-2.5.7-.7 1.5-1 2.5-1s1.8.3 2.5 1c.7.7 1 1.5 1 2.5s-.3 1.8-1 2.5c-.7.7-1.5 1-2.5 1-.6 0-1.1-.1-1.6-.4zm15.4-9.3c.9 2.3.6 4.6-.8 6.6l3.3 3.3c1.4-2.3 2.1-4.9 2.1-7.7 0-2-.4-3.9-1.3-5.7-1.4.3-2.7.9-3.9 1.8z"/></svg>
                            </div>
                            <div>
                                <h3 class="intro-title">本程式的運作核心</h3>
                                <p class="intro-text">
                                    「Podcast導航站」的核心是建立在強大且豐富的 <strong>Apple iTunes Search API</strong> 之上，讓您能夠搜尋並存取全球數以萬計的 Podcast 節目。為了確保在任何網路環境下都能穩定、快速地載入節目資訊與音訊檔案，本程式特別透過一個名為 <strong>`corsproxy.io` 的代理伺服器</strong>來處理所有網路請求。這個代理伺服器扮演著一個可靠的中間人角色，協助我們的應用程式順利地從 iTunes 和各個 Podcast 的主機上抓取資料，完美繞過了瀏覽器的安全限制，大幅提升了資料讀取的成功率與穩定性。
                                </p>
                            </div>
                        </div>

                        <!-- MODIFIED: 全面更新功能說明 -->
                        <div class="intro-section">
                            <div class="intro-icon">
                              <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="c" x1="24" y1="3.6" x2="24" y2="44.4" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#c57eff"/><stop offset="1" stop-color="#a060ff"/></linearGradient></defs><path fill="url(#c)" d="M24 44.4C12.7 44.4 3.6 35.3 3.6 24S12.7 3.6 24 3.6 44.4 12.7 44.4 24 35.3 44.4 24 44.4Z"/><path fill="#fff" d="M35.6 19.3L28.7 12.4 18.1 23 12.4 17.3 5.5 24.2 18.1 36.8zM24.2 5.5L12.4 17.3 18.1 23 29.9 11.2z"/></svg>
                            </div>
                            <div>
                                <h3 class="intro-title">功能介紹與使用說明</h3>
                                <div class="intro-text">
                                     <p>「Podcast導航站」為您量身打造了一套完整、直覺且功能強大的工具，讓您能輕鬆徜徉在 Podcast 的聲音世界中。以下是各項核心功能的詳細操作說明：</p>
                                    <ul>
                                        <li>
                                            <strong><i class="fas fa-search text-[#007AFF]"></i> 強大的節目搜尋</strong>
                                            <div class="li-sub-text">
                                                <p><strong>操作步驟：</strong><br>
                                                1. 找到左側邊欄最上方的「搜尋 iTunes...」輸入框。<br>
                                                2. 輸入節目名稱、主持人或任何您感興趣的主題關鍵字（例如：「科技」、「理財」）。<br>
                                                3. 點擊右側綠色的「搜尋」按鈕，或直接按下鍵盤上的 Enter 鍵。<br>
                                                </p>
                                                <p class="mt-2"><strong>優點說明：</strong><br>
                                                直接串接 Apple 的龐大資料庫，全球數以萬計的節目任您探索。搜尋結果會以清晰的卡片形式呈現，並提供分頁功能，讓您輕鬆瀏覽，不錯過任何好節目。
                                                </p>
                                            </div>
                                        </li>
                        
                                        <li>
                                            <strong><i class="fas fa-folder-plus text-[#FFBD2E]"></i> 智慧收藏庫管理</strong>
                                            <div class="li-sub-text">
                                                <p><strong>一鍵收藏與移除：</strong><br>
                                                在搜尋結果中，將滑鼠移至節目封面上，點擊出現的 <i class="far fa-heart"></i> 愛心圖示即可收藏。在收藏庫中，同樣將滑鼠移至節目上方，點擊 <i class="fas fa-trash-alt"></i> 垃圾桶圖示即可移除。您的收藏庫會被保存在瀏覽器中，下次開啟時依然存在。</p>
                                                <p class="mt-2"><strong>自動分類與篩選：</strong><br>
                                                收藏的節目會自動依照官方類型分組。您可以使用上方的篩選框快速查找，或點擊 <i class="fas fa-heart"></i> 按鈕只顯示標記為「最愛」的節目。</p>
                                                <p class="mt-2"><strong>個人化視圖與排序：</strong><br>
                                                透過 <i class="fas fa-list"></i> 和 <i class="fas fa-grip"></i> 圖示在「列表」與「網格」模式間切換。點擊 <i class="fas fa-arrow-up-wide-short"></i> 圖示可改變節目排序，完全符合您的瀏覽習慣。</p>
                                            </div>
                                        </li>
                        
                                        <li>
                                            <strong><i class="fas fa-headphones-alt text-[#27C93F]"></i> 沉浸式播放體驗</strong>
                                            <div class="li-sub-text">
                                                <p><strong>操作步驟：</strong><br>
                                                進入任一收藏的節目後，點擊單集列表中的任一集即可開始播放。所有控制功能都集中在畫面底部的播放器。</p>
                                                <p class="mt-2"><strong>高階播放功能：</strong></p>
                                                <ul class="list-disc pl-5 opacity-90 text-sm">
                                                    <li class="mb-1"><strong>進度記憶：</strong> 自動記錄每一集的收聽進度，下次回來從上次中斷處繼續聽。</li>
                                                    <li class="mb-1"><strong>精準快轉：</strong> <i class="fas fa-rotate-left"></i> / <i class="fas fa-rotate-right"></i> 按鈕可前後快轉 15 秒，方便跳過不感興趣的片段。</li>
                                                    <li class="mb-1"><strong>變速播放：</strong> 可在 0.5x 至 2.0x 之間調整語速，滿足高效學習或放鬆聆聽的需求。</li>
                                                    <li><strong>單集下載：</strong> 點擊 <i class="fas fa-download"></i> 圖示，即可將音訊檔下載至您的電腦中，實現真正的離線收聽。</li>
                                                </ul>
                                            </div>
                                        </li>
                        
                                        <li>
                                            <strong><i class="fas fa-star text-[#FF3B30]"></i> 貼心的輔助設計</strong>
                                            <div class="li-sub-text">
                                                <p><strong><i class="fas fa-adjust"></i> 明暗主題切換：</strong><br>
                                                點擊右上角的太陽 / 月亮圖示，即可在兩種視覺主題間無縫切換，保護您的眼睛，無論白天黑夜都有最佳體驗。</p>
                                                <p class="mt-2"><strong><i class="fas fa-info-circle"></i> 單集詳情速覽：</strong><br>
                                                在單集列表中，點擊最左側的「單集封面圖」，會彈出該集的完整內容簡介 (Show Notes)，幫助您在播放前快速了解單集主題與大綱。</p>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="search-results-view" class="flex flex-col overflow-hidden" style="display: none;">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <h2 class="text-2xl font-bold">搜尋結果</h2>
                        <div id="search-pagination-controls" class="flex items-center gap-2"></div>
                    </div>
                    <div id="search-results-podcasts" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 overflow-y-auto"></div>
                </div>
                <div id="podcast-detail-view" class="flex flex-col overflow-hidden" style="display: none;"></div>
            </main>
        </div>
    </div>

    <footer class="player" id="player">
        <div class="player-info">
            <img id="player-album-art" src="https://placehold.co/40x40/222/fff?text=Pod" alt="單集圖片">
            <div class="flex flex-col overflow-hidden">
                <div id="player-title-container" class="player-title-container">
                    <span id="player-title" class="font-bold whitespace-nowrap text-sm" title="尚未播放任何內容">尚未播放任何內容</span>
                </div>
                <span id="player-artist" class="text-xs text-gray-400 truncate"></span>
            </div>
            <div id="sound-icon-container" class="sound-icon-container"></div>
        </div>
        <div class="player-controls-wrapper">
            <div class="playback-controls">
                <button id="playback-rate-btn" class="simple-control-btn" title="播放速度"><span id="playback-rate-text" class="text-xs">1.0x</span></button>
                <button id="skip-backward-btn" class="simple-control-btn" title="倒退 15 秒"><i class="fas fa-rotate-left"></i></button>
                <button id="play-pause-btn" class="play-pause-btn" title="播放/暫停">
                    <i id="play-pause-icon" class="fas fa-play"></i>
                </button>
                <button id="skip-forward-btn" class="simple-control-btn" title="快進 15 秒"><i class="fas fa-rotate-right"></i></button>
                <button id="repeat-btn" class="simple-control-btn" title="重複"><i class="fas fa-repeat"></i></button>
            </div>
            <div class="progress-container">
                <span id="current-time" class="text-xs">0:00</span>
                <div id="progress-bar" class="w-full bg-gray-600 rounded cursor-pointer">
                    <div id="progress" class="h-full bg-[#A0C4FF] rounded relative" style="width: 0%;">
                        <div id="progress-handle"></div>
                    </div>
                </div>
                <span id="duration" class="text-xs">0:00</span>
            </div>
        </div>
        <div class="player-actions-wrapper">
            <a id="download-btn" href="#" download title="下載音檔">
                <i class="fas fa-download text-base"></i>
            </a>
            <div id="volume-container" class="relative flex items-center">
                <button id="volume-icon-btn" class="simple-control-btn mr-1"><i class="fas fa-volume-high text-base"></i></button>
                <span id="volume-tooltip">30%</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" class="w-72" title="調整音量">
            </div>
        </div>
    </footer>
    
    <!-- Modal HTML Structure -->
    <div id="modal-overlay">
        <div id="episode-modal">
            <button id="modal-close-btn" title="關閉"><i class="fas fa-times"></i></button>
            <div class="flex items-start gap-4 flex-shrink-0">
                <img id="modal-artwork" src="" class="w-24 h-24 rounded-lg flex-shrink-0">
                <div class="flex-1">
                    <p id="modal-date" class="text-xs text-gray-400 mb-1"></p>
                    <h3 id="modal-title" class="text-lg font-bold"></h3>
                    <p id="modal-artist" class="text-sm text-gray-300"></p>
                    <button id="modal-play-btn" class="mt-3 bg-[#A0C4FF] text-white font-bold py-2 px-6 rounded-full text-sm">
                        <i class="fas fa-play mr-2"></i>播放
                    </button>
                </div>
            </div>
            <div id="modal-description"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素
            const podcastDetailView = document.getElementById('podcast-detail-view');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const playerTitleContainer = document.getElementById('player-title-container');
            const playerTitle = document.getElementById('player-title');
            const playerArtist = document.getElementById('player-artist');
            const playerAlbumArt = document.getElementById('player-album-art');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const downloadBtn = document.getElementById('download-btn');
            const playbackRateText = document.getElementById('playback-rate-text');
            const repeatBtn = document.getElementById('repeat-btn');
            const soundIconContainer = document.getElementById('sound-icon-container');
            const sidebarItemsContainer = document.getElementById('sidebar-items');
            const sortDirectionBtn = document.getElementById('sort-direction-btn');
            const sortIcon = document.getElementById('sort-icon');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const filterFavoritesBtn = document.getElementById('filter-favorites-btn');
            const localSearchInput = document.getElementById('local-search-input');
            const viewModeListBtn = document.getElementById('view-mode-list');
            const viewModeGridBtn = document.getElementById('view-mode-grid');
            
            // Modal elements
            const modalOverlay = document.getElementById('modal-overlay');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalPlayBtn = document.getElementById('modal-play-btn');

            const soundIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><rect class="sound-wave sound-wave-1" x="4" y="8" width="4" height="8" rx="1"></rect><rect class="sound-wave sound-wave-2" x="10" y="5" width="4" height="14" rx="1"></rect><rect class="sound-wave sound-wave-3" x="16" y="8" width="4" height="8" rx="1"></rect></svg>`;
            const sunIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12h2.25m.386-6.364l1.591 1.591M12 12a6 6 0 100-12 6 6 0 000 12z" /></svg>`;
            const moonIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648z" /></svg>`;
            
            const CORS_PROXY = 'https://corsproxy.io/?';

            const GENRE_ICONS = {
                'Default': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>',
                'Technology': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM9.5 16.5v-2h-2v2h2zm0-3v-2h-2v2h2zm0-3v-2h-2v2h2zm5.5 6h-2v-2h2v2zm0-3h-2v-2h2v2zm0-3h-2v-2h2v2zm4.5 6h-2v-2h2v2zm0-3h-2v-2h2v2zm0-3h-2v-2h2v2z"/></svg>',
                'Business': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M22 6h-5V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H2v13h20V6zm-7-2h-4v2h4V4zm-2 7h-2v-2h2v2zm4 0h-2v-2h2v2zM9 11H7v-2h2v2zm11 7H4v-7h16v7z"/></svg>',
                'News': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>',
                'Arts': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M17.76 3.24C16.27 1.75 14.21 1 12 1s-4.27.75-5.76 2.24C4.75 4.73 4 6.79 4 9s.75 4.27 2.24 5.76C7.73 16.25 9.79 17 12 17s4.27-.75 5.76-2.24C19.25 13.27 20 11.21 20 9s-.75-4.27-2.24-5.76zM12 15c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/><path d="m19.21 15.21-2.83 2.83-2.12-2.12 2.83-2.83c.19-.19.45-.29.71-.29s.52.1.71.29c.39.39.39 1.02 0 1.41z"/></svg>',
                'Health & Fitness': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>',
                'Sports': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>',
                'Comedy': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M9.5 8C8.67 8 8 8.67 8 9.5S8.67 11 9.5 11 11 10.33 11 9.5 10.33 8 9.5 8zm5 0c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5S15.33 8 14.5 8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-4c1.48 0 2.75-.81 3.45-2H8.55c.7 1.19 1.97 2 3.45 2z"/></svg>',
                'Society & Culture': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM7 8.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm5 10.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm5-10.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>',
                'Education': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>',
                'History': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6c-1.66 0-3.14-.69-4.22-1.78L10.36 14.8c.79.79 1.83 1.22 2.92 1.22 2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4h2l-3.89 3.89-.07.14L3 12h3c0-4.97 4.03-9 9-9s9 4.03 9 9-4.03 9-9 9z"/></svg>',
                'Science': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M11.57 2.15c-1.53.5-2.83 1.48-3.9 2.87-1.29 1.68-2.22 3.68-2.48 5.84-.04.34.22.64.56.64.21 0 .4-.13.5-.33.39-1.53 1.24-2.95 2.4-4.22.99-1.12 2.18-1.95 3.52-2.52.3-.13.48-.44.4-.76-.08-.31-.39-.5-.7-.42zM4.07 13.38c.03.32.31.54.62.54.06 0 .12-.01.18-.03 1.93-.68 3.48-2.02 4.68-3.85 1.11-1.69 1.7-3.62 1.69-5.59-.01-.32-.28-.57-.6-.57-.33 0-.6.26-.6.59.01 1.7-.5 3.33-1.46 4.8-1.09 1.65-2.48 2.85-4.23 3.45-.33.11-.53.44-.5.77zm15.42 2.05c-1.53-.5-2.83-1.48-3.9-2.87-1.29-1.68-2.22-3.68-2.48-5.84-.04-.34.22-.64.56-.64.21 0 .4.13.5.33.39 1.53 1.24-2.95 2.4 4.22.99-1.12 2.18-1.95 3.52-2.52.3.13.48-.44.4-.76-.08-.31-.39-.5-.7-.42z"/></svg>',
                'True Crime': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>',
                'Music': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>',
                'TV & Film': '<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0"><path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>',
            };

            const audio = new Audio();
            const collectionCache = {};
            let playerState = { currentEpisode: null, playlist: [], currentIndex: -1, isPlaying: false, playbackRate: 1.0, isRepeating: false, _playbackAttempt: 'direct' };
            let isFavoritesFilterActive = false;
            let isFetchingDetails = false;
            let lastProgressUpdateTime = 0;
            let currentViewSource = 'sidebar';
            let searchState = { term: '', results: [], currentIndex: -1, offset: 0, limit: 50 };

            const getCollection = () => JSON.parse(localStorage.getItem('podcastCollection') || '[]');
            const saveCollection = (collection) => localStorage.setItem('podcastCollection', JSON.stringify(collection));

            const getPlaybackProgress = () => JSON.parse(localStorage.getItem('playbackProgress') || '{}');
            const savePlaybackProgress = (episodeId, currentTime, duration) => {
                if (!episodeId || !duration) return;
                const progressData = getPlaybackProgress();
                progressData[episodeId] = { currentTime, duration };
                localStorage.setItem('playbackProgress', JSON.stringify(progressData));
            };

            const loadCollection = () => {
                sidebarItemsContainer.innerHTML = '';
                let collection = getCollection();

                if (isFavoritesFilterActive) {
                    collection = collection.filter(p => p.isFavorite);
                }

                const groupedByGenre = collection.reduce((acc, podcast) => {
                    const genre = podcast.primaryGenreName || '未分類';
                    if (!acc[genre]) {
                        acc[genre] = [];
                    }
                    acc[genre].push(podcast);
                    return acc;
                }, {});

                const isAsc = sortIcon.classList.contains('fa-arrow-up-wide-short');
                
                const sortedGenres = Object.keys(groupedByGenre).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                
                if (sortedGenres.length === 0 && (localSearchInput.value || isFavoritesFilterActive)) {
                     sidebarItemsContainer.innerHTML = `<p class="text-center text-sm text-[var(--color-text-secondary)] p-4">沒有符合篩選條件的項目。</p>`;
                } else if (sortedGenres.length > 0) {
                    sortedGenres.forEach(genre => {
                        const header = document.createElement('h3');
                        header.className = 'sidebar-genre-header';
                        const iconSVG = GENRE_ICONS[genre] || GENRE_ICONS['Default'];
                        header.innerHTML = `${iconSVG}<span>${genre}</span>`;
                        sidebarItemsContainer.appendChild(header);

                        const podcastsInGenre = groupedByGenre[genre];
                        podcastsInGenre.sort((a, b) => isAsc ? a.collectionName.localeCompare(b.collectionName, 'zh-Hant') : b.collectionName.localeCompare(a.collectionName, 'zh-Hant'));
                        
                        podcastsInGenre.forEach(podcast => renderCollectionItem(podcast));
                    });
                }
            };

            const addToCollection = (podcast) => {
                const collection = getCollection();
                if (!collection.some(p => p.collectionId === podcast.collectionId)) {
                    collection.unshift({ ...podcast, addedAt: Date.now(), isFavorite: false });
                    saveCollection(collection);
                    loadCollection();
                    updateSearchItemUI(podcast.collectionId, true);
                    document.getElementById('default-view').style.display = 'none'; // Hide intro when adding first item
                }
            };

            const removeFromCollection = (collectionId) => {
                let collection = getCollection().filter(p => p.collectionId !== collectionId);
                saveCollection(collection);
                loadCollection();
                updateSearchItemUI(collectionId, false);
                 if (getCollection().length === 0) {
                    document.getElementById('default-view').style.display = 'flex';
                }
            };

            const toggleFavoriteStatus = (collectionId) => {
                let collection = getCollection();
                const podcast = collection.find(p => p.collectionId === collectionId);
                if (podcast) {
                    podcast.isFavorite = !podcast.isFavorite;
                    saveCollection(collection);
                    loadCollection();
                }
            };
            
            function renderCollectionItem(podcast) {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.dataset.id = podcast.collectionId;
                item.title = `${podcast.collectionName} - ${podcast.artistName}`;
                const trashSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.144-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.057-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`;
                const heartIconClass = podcast.isFavorite ? 'fas' : 'far';
                item.innerHTML = `
                    <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName}" class="w-12 h-12 rounded-lg flex-shrink-0">
                    <div class="flex-1 overflow-hidden sidebar-item__text-wrapper">
                        <div class="font-semibold text-sm">${podcast.collectionName}</div>
                        <div class="text-xs text-gray-400 truncate">${podcast.artistName}</div>
                    </div>
                    <div class="sidebar-item-actions">
                        <button class="sidebar-action-btn fav-btn ${podcast.isFavorite ? 'is-favorite' : ''}" title="標記為最愛"><i class="${heartIconClass} fa-heart"></i></button>
                        <button class="sidebar-action-btn" title="從收藏移除">${trashSVG}</button>
                    </div>`;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.sidebar-item-actions')) return;
                    document.querySelector('.sidebar-item.is-active')?.classList.remove('is-active');
                    item.classList.add('is-active');
                    currentViewSource = 'sidebar';
                    fetchEpisodes(podcast.collectionId);
                });
                const [favBtn, deleteBtn] = item.querySelectorAll('.sidebar-action-btn');
                favBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFavoriteStatus(podcast.collectionId); });
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFromCollection(podcast.collectionId); });
                sidebarItemsContainer.appendChild(item);
            }

            function updateSearchItemUI(collectionId, isCollected) {
                const searchItemBtn = document.querySelector(`.add-to-fav-btn[data-id="${collectionId}"]`);
                if (searchItemBtn) {
                    searchItemBtn.classList.toggle('is-favorite', isCollected);
                    searchItemBtn.querySelector('i').className = isCollected ? 'fas' : 'far';
                }
            }
            
            async function searchPodcasts(term, newOffset = 0) {
                const showView = (v) => { document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none'); document.getElementById(v).style.display='flex'; };
                if (!term) { 
                    showView('default-view');
                    return; 
                }
                showView('search-results-view');
                const container = document.getElementById('search-results-podcasts');
                container.innerHTML = `<div class="w-full flex justify-center mt-8"><div class="spinner"></div></div>`;
                document.getElementById('search-pagination-controls').innerHTML = '';
                try {
                    const targetUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=podcast&limit=${searchState.limit}&offset=${newOffset}`;
                    const res = await fetch(CORS_PROXY + encodeURIComponent(targetUrl));
                    const data = await res.json();
                    
                    searchState.term = term;
                    searchState.offset = newOffset;
                    searchState.results = data.results;

                    container.innerHTML = !data.results.length ? '<p class="col-span-full text-center text-gray-400">沒有找到相關播客。</p>' : '';
                    const collection = getCollection();
                    data.results.forEach((podcast, index) => {
                        const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `<button class="add-to-fav-btn ${isCollected ? 'is-favorite' : ''}" data-id="${podcast.collectionId}" title="加入/移除收藏"><i class="${isCollected ? 'fas' : 'far'} fa-heart"></i></button><img src="${podcast.artworkUrl600}" class="w-full rounded-lg mb-2 shadow-lg"><span class="font-bold text-sm truncate w-full" title="${podcast.collectionName}">${podcast.collectionName}</span><span class="text-xs text-gray-400 truncate w-full" title="${podcast.artistName}">${podcast.artistName}</span>`;
                        item.addEventListener('click', () => {
                            currentViewSource = 'search';
                            searchState.currentIndex = index;
                            fetchEpisodes(podcast.collectionId);
                        });
                        const favBtn = item.querySelector('.add-to-fav-btn');
                        favBtn.addEventListener('click', (e) => { e.stopPropagation(); favBtn.classList.contains('is-favorite') ? removeFromCollection(podcast.collectionId) : addToCollection(podcast); });
                        container.appendChild(item);
                    });
                    renderPaginationControls();
                } catch (error) { container.innerHTML = '<p class="text-center text-gray-400">搜尋失敗。請稍後再試。</p>'; }
            }
            
            async function getPodcastInfo(collectionId) {
                if (collectionCache[collectionId] && collectionCache[collectionId].feedUrl) return collectionCache[collectionId];
                const targetUrl = `https://itunes.apple.com/lookup?id=${collectionId}`;
                const res = await fetch(CORS_PROXY + encodeURIComponent(targetUrl));
                if (!res.ok) throw new Error(`iTunes API request failed: ${res.status}`);
                const data = await res.json();
                if (data.resultCount === 0 || !data.results[0].feedUrl) throw new Error('Podcast not found or has no feed URL.');
                collectionCache[collectionId] = data.results[0];
                return data.results[0];
            }
            
            async function fetchWithTimeout(resource, options = {}) {
                const { timeout = 10000 } = options;
                const controller = new AbortController();
                const id = setTimeout(() => {
                    controller.abort();
                }, timeout);

                try {
                    const response = await fetch(resource, {
                        ...options,
                        signal: controller.signal  
                    });
                    return response;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error(`請求超時 (超過 ${timeout/1000} 秒)`);
                    }
                    throw error;
                } finally {
                    clearTimeout(id);
                }
            }

            async function parseFeed(feedUrl, podcastInfo) {
                const proxyUrl = CORS_PROXY + encodeURIComponent(feedUrl);
                try {
                    console.log(`[Feed Parser] Attempting to fetch feed via corsproxy.io...`);
                    const res = await fetchWithTimeout(proxyUrl, { timeout: 10000 });
                    if (!res.ok) {
                        throw new Error(`代理伺服器回應錯誤，狀態碼: ${res.status}。代理可能暫時失效或來源 Feed 無效。`);
                    }
                    
                    const xmlText = await res.text();
                    const doc = new DOMParser().parseFromString(xmlText, "application/xml");
                    
                    if (doc.querySelector("parsererror")) {
                        throw new Error('解析 XML 失敗。來源 Feed 格式可能不正確。');
                    }
                    
                    const episodes = Array.from(doc.querySelectorAll("item")).map(item => {
                        const enclosure = item.querySelector("enclosure");
                        if (!enclosure || !enclosure.getAttribute("url")) return null;
                        return {
                            trackId: item.querySelector("guid")?.textContent || enclosure.getAttribute("url"),
                            trackName: item.querySelector("title")?.textContent || 'Untitled Episode',
                            episodeUrl: enclosure.getAttribute("url"),
                            releaseDate: item.querySelector("pubDate")?.textContent || new Date().toISOString(),
                            description: item.querySelector("description")?.textContent || '',
                            artworkUrl60: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl60,
                            artworkUrl600: item.querySelector('itunes\\:image, image')?.getAttribute('href') || podcastInfo.artworkUrl600,
                            duration: item.querySelector("itunes\\:duration, duration")?.textContent || 0,
                            fileSize: enclosure.getAttribute("length") || 0,
                        };
                    }).filter(Boolean);
                    
                    if (episodes.length === 0) {
                        throw new Error('成功解析 RSS Feed，但未找到任何包含音訊檔案的有效單集。');
                    }
                    
                    console.log(`[Feed Parser] SUCCESS: Parsed ${episodes.length} episodes via corsproxy.io.`);
                    return episodes;

                } catch (error) {
                    console.error(`[Feed Parser] FAILED: ${error.message}`);
                    throw new Error(`無法載入 Feed: ${error.message}`);
                }
            }

            async function fetchEpisodes(collectionId) {
                if (isFetchingDetails) return;
                isFetchingDetails = true;
                const showView = (v) => { 
                    document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none');
                    document.getElementById(v).style.display = 'flex'; 
                };
                showView('podcast-detail-view');
                
                try {
                    const podcastInfo = await getPodcastInfo(collectionId);
                    renderPodcastShell(podcastInfo);
                    if (podcastInfo.episodes) {
                        populateEpisodesList(podcastInfo.episodes, podcastInfo);
                    } else {
                        const episodes = await parseFeed(podcastInfo.feedUrl, podcastInfo);
                        if (!episodes || episodes.length === 0) throw new Error("No valid episodes were found in the feed after all attempts.");
                        collectionCache[collectionId].episodes = episodes;
                        populateEpisodesList(episodes, podcastInfo);
                    }
                } catch (error) {
                    console.error(`[CRITICAL] Failed to load podcast (ID: ${collectionId}):`, error);
                    podcastDetailView.innerHTML = `<div class="text-center text-[var(--color-text-secondary)] m-auto"><p class="font-bold text-lg mb-2">無法載入節目資訊</p><p class="text-sm">${error.message}</p><p class="text-xs mt-2">提示：請檢查網路連線，或嘗試暫時關閉廣告攔截擴充功能。</p></div>`;
                } finally {
                    isFetchingDetails = false;
                }
            }

            function renderPodcastShell(podcast) {
                const collection = getCollection();
                const isCollected = collection.some(p => p.collectionId === podcast.collectionId);
                const btnText = isCollected ? '✓ 已收藏' : '收藏';
                const btnColor = isCollected ? '#6c757d' : '#27C93F';
                const btnDisabled = isCollected ? 'disabled' : '';
                
                let navHeaderHTML = '';
                if (currentViewSource === 'search') {
                    navHeaderHTML = `
                        <div id="detail-view-nav" class="flex items-center justify-between mb-4 flex-shrink-0">
                            <button id="detail-nav-back" class="nav-button" title="返回搜尋結果">
                                <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M22 18H12M12 18L17 13M12 18L17 23" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <div class="flex items-center gap-4">
                                <button id="detail-nav-prev-podcast" class="nav-button" title="上一個節目">
                                     <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M20.25 24L14.25 18L20.25 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                <button id="detail-nav-next-podcast" class="nav-button" title="下一個節目">
                                    <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="18" cy="18" r="18" fill="#007AFF"/><path d="M15.75 12L21.75 18L15.75 24" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                        </div>`;
                }

                const tooltipText = `節目名稱：${podcast.collectionName}\n主持人：${podcast.artistName}\n類型：${podcast.primaryGenreName}\n單集總數：${podcast.trackCount}`;
                podcastDetailView.innerHTML = `
                    ${navHeaderHTML}
                    <div class="podcast-header">
                        <img src="${podcast.artworkUrl600}" alt="${podcast.collectionName} cover" title="${tooltipText}">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex items-center gap-4">
                                <h1 class="text-xl font-bold truncate">${podcast.collectionName}</h1>
                                <button id="add-to-collection-btn" style="background-color: ${btnColor};" class="text-white font-bold py-1 px-3 rounded-full text-sm ml-4 flex-shrink-0" ${btnDisabled}>${btnText}</button>
                            </div>
                            <p class="text-sm mt-1 truncate">${podcast.artistName}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 mb-2">
                        <h2 class="text-xl font-bold">最新單集</h2>
                        <div class="flex items-center gap-4">
                            <button id="detail-prev-btn" class="simple-control-btn detail-nav-btn" title="上一集"><i class="fas fa-backward-step"></i></button>
                            <button id="detail-next-btn" class="simple-control-btn detail-nav-btn" title="下一集"><i class="fas fa-forward-step"></i></button>
                        </div>
                    </div>
                    <div id="episodes-placeholder"><div class="spinner"></div><p>正在載入節目...</p></div>`;
                
                if (currentViewSource === 'search') {
                    document.getElementById('detail-nav-back').addEventListener('click', () => {
                         document.getElementById('podcast-detail-view').style.display = 'none';
                         document.getElementById('search-results-view').style.display = 'flex';
                    });
                    document.getElementById('detail-nav-prev-podcast').addEventListener('click', navigatePodcastInSearch(-1));
                    document.getElementById('detail-nav-next-podcast').addEventListener('click', navigatePodcastInSearch(1));
                    updateDetailNav();
                }

                const collectBtn = document.getElementById('add-to-collection-btn');
                if (collectBtn && !isCollected) {
                    collectBtn.addEventListener('click', () => {
                        addToCollection(podcast);
                        collectBtn.textContent = '✓ 已收藏';
                        collectBtn.disabled = true;
                        collectBtn.style.backgroundColor = '#6c757d';
                    });
                }
                document.getElementById('detail-prev-btn').addEventListener('click', () => playNextPrev(-1));
                document.getElementById('detail-next-btn').addEventListener('click', () => playNextPrev(1));
            }

            function populateEpisodesList(episodes, podcast) {
                const placeholder = document.getElementById('episodes-placeholder');
                if (!placeholder) return;
                const escapeAttr = (str) => String(str || '').replace(/"/g, '&quot;');
                const progressData = getPlaybackProgress();

                const episodesHTML = episodes.slice(0, 50).map((ep, index) => {
                    const durationFormatted = formatDuration(ep.duration);
                    const sizeFormatted = formatFileSize(ep.fileSize);
                    
                    const progress = progressData[ep.trackId];
                    const progressPercent = progress && progress.duration ? (progress.currentTime / progress.duration) * 100 : 0;
                    const isListened = progressPercent > 95;

                    return `
                    <div class="episode-item ${isListened ? 'is-listened' : ''}" data-episode-id="${escapeAttr(ep.trackId)}">
                        <span class="episode-number">${index + 1}</span>
                        <div class="episode-thumbnail-btn">
                           <img src="${ep.artworkUrl60 || podcast.artworkUrl60}" alt="Episode thumbnail">
                           <div class="loading-spinner-overlay"><div class="small-spinner"></div></div>
                        </div>
                        <div class="episode-main-content">
                             <div class="flex-1 overflow-hidden">
                                <div class="font-semibold truncate text-base" title="${escapeAttr(ep.trackName)}">${ep.trackName}</div>
                            </div>
                        </div>
                        <div class="episode-metadata flex items-center gap-4">
                            <span class="text-xs text-[var(--color-text-secondary)] whitespace-nowrap w-16 text-right">${sizeFormatted || '--- MB'}</span>
                            <span class="text-xs text-[var(--color-text-secondary)] whitespace-nowrap w-12 text-right">${durationFormatted || '--:--'}</span>
                            <span class="episode-date">${new Date(ep.releaseDate).toLocaleDateString('sv-SE')}</span>
                        </div>
                        <div class="episode-item-actions">
                            <a href="${ep.episodeUrl}" download="${escapeAttr(ep.trackName)}.mp3" class="episode-action-btn download-action-link" title="下載"><i class="fas fa-download"></i></a>
                        </div>
                        <div class="sound-icon-container">${soundIconSVG}</div>
                        <div class="episode-progress-bar-container">
                            <div class="episode-progress-bar" style="width: ${progressPercent}%;"></div>
                        </div>
                    </div>`}).join('');
                placeholder.outerHTML = `<div class="podcast-episodes">${episodesHTML}</div>`;

                podcastDetailView.querySelectorAll('.episode-item').forEach(item => {
                    const ep = episodes.find(e => e.trackId === item.dataset.episodeId);
                    if (!ep) return;
                    item.querySelector('.episode-main-content').addEventListener('click', () => playEpisode(ep, podcast.artistName, episodes));
                    item.querySelector('.episode-thumbnail-btn').addEventListener('click', (e) => { e.stopPropagation(); openEpisodeModal(ep, podcast, episodes); });
                    item.querySelector('.download-action-link')?.addEventListener('click', (e) => e.stopPropagation());
                });
                syncPlayerUI();
            }
            
            function openEpisodeModal(episode, podcast, playlist) {
                document.getElementById('modal-artwork').src = episode.artworkUrl600 || podcast.artworkUrl600;
                document.getElementById('modal-date').textContent = new Date(episode.releaseDate).toLocaleDateString();
                document.getElementById('modal-title').textContent = episode.trackName;
                document.getElementById('modal-artist').textContent = podcast.artistName;
                document.getElementById('modal-description').innerHTML = episode.description;
                modalPlayBtn.onclick = () => { playEpisode(episode, podcast.artistName, playlist); modalOverlay.style.display = 'none'; };
                modalOverlay.style.display = 'flex';
            }

            const syncPlayerUI = () => {
                const { currentEpisode, isPlaying, playbackRate, isRepeating } = playerState;
                playerTitleContainer.classList.toggle('marquee', !!currentEpisode);
                if (currentEpisode) {
                    playerTitle.textContent = currentEpisode.trackName;
                    playerTitle.title = currentEpisode.trackName;
                    playerArtist.textContent = currentEpisode.artistName;
                    playerAlbumArt.src = currentEpisode.artworkUrl600;
                    downloadBtn.href = currentEpisode.episodeUrl;
                    downloadBtn.setAttribute('download', `${(currentEpisode.trackName || 'download').replace(/[/\\?%*:|"<>]/g, '-')}.mp3`);
                    downloadBtn.classList.add('is-visible');
                } else {
                    playerTitle.textContent = '尚未播放任何內容';
                    playerTitle.title = '尚未播放任何內容';
                    playerArtist.textContent = '';
                    playerAlbumArt.src = 'https://placehold.co/40x40/222/fff?text=Pod';
                    downloadBtn.classList.remove('is-visible');
                }
                soundIconContainer.classList.toggle('is-playing-icon', isPlaying && !!currentEpisode);
                document.querySelector('.episode-item.is-playing-item')?.classList.remove('is-playing-item');
                if (isPlaying && currentEpisode) { document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`)?.classList.add('is-playing-item'); }
                playPauseIcon.className = `fas ${isPlaying ? 'fa-pause' : 'fa-play'}`;
                playbackRateText.textContent = `${playbackRate.toFixed(1)}x`;
                repeatBtn.style.color = isRepeating ? '#A0C4FF' : 'var(--color-text-secondary)';
            };
            
            const playEpisode = (episode, host, playlist) => {
                if (playerState.currentEpisode?.trackId === episode.trackId) {
                    togglePlayPause();
                    return;
                }

                const episodeItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(episode.trackId))}"]`);
                const spinnerContainer = episodeItem?.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');
                
                document.querySelectorAll('.loading-spinner-overlay').forEach(spinner => spinner.style.display = 'none');
                if (spinnerContainer) spinnerContainer.style.display = 'flex';
                
                playerState = {
                    ...playerState,
                    currentEpisode: { ...episode, artistName: host },
                    playlist: playlist,
                    currentIndex: playlist.findIndex(e => e.trackId === episode.trackId),
                    isPlaying: true,
                    _playbackAttempt: 'direct'
                };

                console.log(`[Player] Attempt 1 (Direct): ${episode.episodeUrl}`);
                audio.src = episode.episodeUrl;
                
                const progressData = getPlaybackProgress();
                const savedProgress = progressData[episode.trackId];
                if (savedProgress && savedProgress.currentTime < savedProgress.duration * 0.95) {
                    audio.currentTime = savedProgress.currentTime;
                }

                audio.play().catch(e => console.error("Initial play() was interrupted or failed. The error handler will take over.", e));
                syncPlayerUI();
            };

            const togglePlayPause = () => { if (!playerState.currentEpisode) return; audio.paused ? audio.play() : audio.pause(); };
            const playNextPrev = (offset) => { if (!playerState.playlist?.length) return; let newIndex = playerState.currentIndex + offset; if (newIndex >= 0 && newIndex < playerState.playlist.length) { const nextEp = playerState.playlist[newIndex]; playEpisode(nextEp, playerState.currentEpisode.artistName, playerState.playlist); } };
            const formatTime = (s) => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${(Math.floor(s%60)<10?'0':'')+Math.floor(s%60)}`;

            function formatDuration(duration) {
                if (!duration || duration === 0) return '';
                let totalSeconds;
                if (String(duration).includes(':')) {
                    const parts = String(duration).split(':').reverse();
                    totalSeconds = parts.reduce((acc, part, i) => acc + parseInt(part, 10) * Math.pow(60, i), 0);
                } else {
                    totalSeconds = parseInt(duration, 10);
                }
                if (isNaN(totalSeconds) || totalSeconds === 0) return '';
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let result = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (hours > 0) {
                    result = `${hours}:${result}`;
                }
                return result;
            }

            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '';
                const size = parseInt(bytes, 10);
                if (isNaN(size) || size === 0) return '';
                const mb = size / (1024 * 1024);
                if (mb < 0.1) return '';
                return `${mb.toFixed(1)} MB`;
            }

            function renderPaginationControls() {
                const container = document.getElementById('search-pagination-controls');
                container.innerHTML = '';
                
                const canGoBack = searchState.offset > 0;
                const canGoForward = searchState.results.length === searchState.limit;

                const prevButton = document.createElement('button');
                prevButton.className = 'nav-button';
                prevButton.title = '上一頁';
                prevButton.disabled = !canGoBack;
                prevButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>`;
                prevButton.addEventListener('click', () => searchPodcasts(searchState.term, searchState.offset - searchState.limit));

                const nextButton = document.createElement('button');
                nextButton.className = 'nav-button';
                nextButton.title = '下一頁';
                nextButton.disabled = !canGoForward;
                nextButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>`;
                nextButton.addEventListener('click', () => searchPodcasts(searchState.term, searchState.offset + searchState.limit));

                if (canGoBack || canGoForward) {
                     container.appendChild(prevButton);
                     container.appendChild(nextButton);
                }
            }

            function updateDetailNav() {
                const prevBtn = document.getElementById('detail-nav-prev-podcast');
                const nextBtn = document.getElementById('detail-nav-next-podcast');
                if (!prevBtn || !nextBtn) return;

                prevBtn.disabled = searchState.currentIndex <= 0;
                nextBtn.disabled = searchState.currentIndex >= searchState.results.length - 1;
            }

            function navigatePodcastInSearch(direction) {
                return () => {
                    const newIndex = searchState.currentIndex + direction;
                    if (newIndex >= 0 && newIndex < searchState.results.length) {
                        searchState.currentIndex = newIndex;
                        const nextPodcast = searchState.results[newIndex];
                        fetchEpisodes(nextPodcast.collectionId);
                    }
                };
            }

            function initialize() {
                soundIconContainer.innerHTML = soundIconSVG;
                
                const volumeSlider = document.getElementById('volume-slider'), volumeIconBtn = document.getElementById('volume-icon-btn'), volumeIcon = volumeIconBtn.querySelector('i'), volumeTooltip = document.getElementById('volume-tooltip'), volumeContainer = document.getElementById('volume-container');
                let lastVolume = parseFloat(volumeSlider.value);
                const updateVolumeUI = (vol) => {
                    const volume = parseFloat(vol), percentage = Math.round(volume * 100);
                    volumeTooltip.textContent = `${percentage}%`;
                    if (volume === 0) volumeIcon.className = 'fas fa-volume-xmark text-base';
                    else if (volume < 0.5) volumeIcon.className = 'fas fa-volume-low text-base';
                    else volumeIcon.className = 'fas fa-volume-high text-base';
                };
                audio.volume = lastVolume; updateVolumeUI(audio.volume);
                volumeSlider.addEventListener('input', (e) => { const newVolume = parseFloat(e.target.value); audio.volume = newVolume; if (newVolume > 0) lastVolume = newVolume; updateVolumeUI(newVolume); });
                volumeIconBtn.addEventListener('click', () => { if (audio.volume > 0) { lastVolume = audio.volume; audio.volume = 0; volumeSlider.value = 0; } else { const restoreVolume = lastVolume > 0 ? lastVolume : 0.3; audio.volume = restoreVolume; volumeSlider.value = restoreVolume; } updateVolumeUI(audio.volume); });
                volumeContainer.addEventListener('mouseenter', () => volumeTooltip.style.display = 'block');
                volumeContainer.addEventListener('mouseleave', () => volumeTooltip.style.display = 'none');

                audio.addEventListener('play', () => { playerState.isPlaying = true; syncPlayerUI(); });
                audio.addEventListener('playing', () => { 
                    const playingItem = document.querySelector('.episode-item.is-playing-item');
                    if(playingItem) {
                       const spinnerContainer = playingItem.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');
                       if (spinnerContainer) spinnerContainer.style.display = 'none';
                    }
                });
                audio.addEventListener('pause', () => { playerState.isPlaying = false; syncPlayerUI(); });
                audio.addEventListener('ended', () => {
                    if (playerState.currentEpisode) {
                        const { trackId } = playerState.currentEpisode;
                        savePlaybackProgress(trackId, audio.duration, audio.duration);
                        const epItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(trackId))}"]`);
                        if (epItem) {
                           epItem.classList.add('is-listened');
                           const progressBar = epItem.querySelector('.episode-progress-bar');
                           if(progressBar) progressBar.style.width = '100%';
                        }
                    }
                    playerState.isRepeating ? (audio.currentTime = 0, audio.play()) : playNextPrev(1);
                });
                
                audio.addEventListener('error', (e) => {
                    console.error("[Audio Error] An error occurred:", audio.error);
                    const { currentEpisode, _playbackAttempt } = playerState;
                    if (!currentEpisode) return; 

                    const episodeItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                    const spinnerContainer = episodeItem?.querySelector('.episode-thumbnail-btn .loading-spinner-overlay');

                    if (_playbackAttempt === 'direct') {
                        console.warn("[Player] Direct playback failed. Attempting fallback via proxy.");
                        playerState._playbackAttempt = 'proxy';
                        const proxyUrl = CORS_PROXY + encodeURIComponent(currentEpisode.episodeUrl);
                        console.log(`[Player] Attempt 2 (Proxy): ${proxyUrl}`);
                        const currentTime = audio.currentTime; 
                        audio.src = proxyUrl;
                        audio.load(); 
                        if(currentTime > 0) audio.currentTime = currentTime;
                        audio.play().catch(err => console.error("Proxy play() failed immediately.", err));
                        return; 
                    }

                    if (_playbackAttempt === 'proxy') {
                         console.error("[Player] Fallback via proxy also failed. Playback aborted.");
                         if (spinnerContainer) spinnerContainer.style.display = 'none';
                         alert(`無法載入音訊檔案：\n直接播放與代理備援皆失敗，可能是檔案來源問題或網路連線不穩定。`);
                         playerState.currentEpisode = null;
                         playerState.isPlaying = false;
                         syncPlayerUI();
                    }
                });

                audio.addEventListener('timeupdate', () => { 
                    if (isNaN(audio.duration)) return; 
                    const { currentTime, duration } = audio;
                    const { currentEpisode } = playerState;

                    progress.style.width = `${(currentTime / duration) * 100}%`; 
                    currentTimeEl.textContent = formatTime(currentTime); 
                    durationEl.textContent = formatTime(duration); 
                    
                    if (currentEpisode) {
                        const now = Date.now();
                        if (now - lastProgressUpdateTime > 2000) {
                            savePlaybackProgress(currentEpisode.trackId, currentTime, duration);
                            lastProgressUpdateTime = now;
                        }
                        
                        const epItem = document.querySelector(`.episode-item[data-episode-id="${CSS.escape(String(currentEpisode.trackId))}"]`);
                        if (epItem) {
                            const progressBar = epItem.querySelector('.episode-progress-bar');
                            if(progressBar) progressBar.style.width = `${(currentTime / duration) * 100}%`;
                            if (currentTime / duration > 0.95) {
                                epItem.classList.add('is-listened');
                            } else {
                                epItem.classList.remove('is-listened');
                            }
                        }
                    }
                });

                document.getElementById('library-title').addEventListener('click', () => { 
                    document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none');
                    document.getElementById('default-view').style.display = 'flex';
                });

                document.getElementById('search-btn').addEventListener('click', () => searchPodcasts(document.getElementById('search-input').value));
                document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && searchPodcasts(e.target.value));
                document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
                document.getElementById('skip-backward-btn').addEventListener('click', () => audio.currentTime = Math.max(0, audio.currentTime - 15));
                document.getElementById('skip-forward-btn').addEventListener('click', () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 15));
                document.getElementById('progress-bar').addEventListener('click', (e) => { if (audio.duration) audio.currentTime = (e.offsetX / e.currentTarget.offsetWidth) * audio.duration; });
                document.getElementById('playback-rate-btn').addEventListener('click', () => { let newRate = playerState.playbackRate + 0.5; if (newRate > 2.0) newRate = 0.5; playerState.playbackRate = newRate; audio.playbackRate = newRate; syncPlayerUI(); });
                repeatBtn.addEventListener('click', () => { playerState.isRepeating = !playerState.isRepeating; syncPlayerUI(); });
                localSearchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); document.querySelectorAll('.sidebar-item, .sidebar-genre-header').forEach(item => { item.style.display = 'none'; }); document.querySelectorAll('.sidebar-item').forEach(item => { if (item.title.toLowerCase().includes(searchTerm)) { item.style.display = ''; const genre = item.closest('.sidebar-items').querySelector(`.sidebar-genre-header:has(+ .sidebar-item[data-id="${item.dataset.id}"])`); if(genre) genre.style.display = ''; } }); });
                viewModeListBtn.addEventListener('click', () => { sidebarItemsContainer.classList.remove('grid-view'); viewModeListBtn.classList.add('active'); viewModeGridBtn.classList.remove('active'); });
                viewModeGridBtn.addEventListener('click', () => { sidebarItemsContainer.classList.add('grid-view'); viewModeGridBtn.classList.add('active'); viewModeListBtn.classList.remove('active'); });
                filterFavoritesBtn.addEventListener('click', () => { isFavoritesFilterActive = !isFavoritesFilterActive; filterFavoritesBtn.classList.toggle('active', isFavoritesFilterActive); loadCollection(); });
                sortDirectionBtn.addEventListener('click', () => { sortIcon.classList.toggle('fa-arrow-up-wide-short'); sortIcon.classList.toggle('fa-arrow-down-wide-short'); loadCollection(); });
                const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); themeToggleBtn.innerHTML = theme === 'dark' ? sunIconSVG : moonIconSVG; localStorage.setItem('theme', theme); };
                themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
                
                modalCloseBtn.addEventListener('click', () => modalOverlay.style.display = 'none');
                modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.style.display = 'none'; });

                applyTheme(localStorage.getItem('theme') || 'dark');
                loadCollection();
                syncPlayerUI();
                
                // MODIFIED: Ensure default view is always shown on init
                document.querySelectorAll('#main-content > div').forEach(d => d.style.display = 'none');
                document.getElementById('default-view').style.display = 'flex';
            }
            initialize();
        });
    </script>
</body>
</html>
