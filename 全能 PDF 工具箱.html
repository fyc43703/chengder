<!DOCTYPE html><html lang="zh-Hant"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全能PDF工具箱</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-light.min.css">
    <style>
          /* --- START OF MACOS STYLE TRANSFORMATION --- */
    
          /* 1. 字體與排版系統 */
          @font-face {
            font-family: 'SF Pro Display';
            src: url('https://applesocial.s3.amazonaws.com/assets/styles/fonts/sanfrancisco/sanfranciscodisplay-regular-webfont.woff');
            font-weight: 400;
            font-style: normal;
          }
          @font-face {
            font-family: 'SF Pro Display';
            src: url('https://applesocial.s3.amazonaws.com/assets/styles/fonts/sanfrancisco/sanfranciscodisplay-semibold-webfont.woff');
            font-weight: 600;
            font-style: normal;
          }
          
          /* 2. CSS 變數定義 */
          :root {
            --macos-bg: #F5F5F7;
            --macos-white: #FFFFFF;
            --macos-blue: #007AFF;
            --macos-blue-hover: #0051D5;
            --macos-secondary-btn-bg: #E9E9EB;
            --macos-secondary-btn-bg-hover: #DCDCE0;
            --macos-text: #1D1D1F;
            --macos-text-secondary: #6e6e73;
            --macos-border: rgba(0, 0, 0, 0.1);
            --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --macos-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
            --macos-blur: blur(20px) saturate(180%);
            --red-dot: #FF5F57;
            --yellow-dot: #FFBD2E;
            --green-dot: #28CA42;
            --macos-red: #FF3B30;
            --macos-red-hover: #D62D24;
            --theme-switcher-color: #6e6e73;
            --theme-switcher-bg-hover: #E9E9EB;
            --main-title-color: #000080;
          }
          
          /* --- START OF DARK THEME STYLES --- */
          html.dark {
              --macos-bg: #1D1D1F;
              --macos-white: #2C2C2E;
              --macos-text: #F5F5F7;
              --macos-text-secondary: #8A8A8E;
              --macos-border: rgba(255, 255, 255, 0.15);
              --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
              --macos-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.3);
              --macos-blur: blur(20px) saturate(180%) brightness(70%);
              --macos-secondary-btn-bg: #3A3A3C;
              --macos-secondary-btn-bg-hover: #4A4A4C;
              --theme-switcher-color: #8A8A8E;
              --theme-switcher-bg-hover: #3A3A3C;
              --main-title-color: #92b5ff;
          }

          html.dark .glass-panel, 
          html.dark .feature-card, 
          html.dark .view > .bg-white, 
          html.dark #modal > div, 
          html.dark #insert-pdf-modal > div, 
          html.dark #add-blank-page-modal > div {
              background: rgba(44, 44, 46, 0.7);
          }

          html.dark .view input[type="text"], 
          html.dark .view input[type="number"], 
          html.dark .view input[type="url"], 
          html.dark .view select, 
          html.dark .view input[type="password"], 
          html.dark .view input[type="color"] {
              background-color: var(--macos-secondary-btn-bg);
              color: var(--macos-text);
              border: 1px solid var(--macos-border);
          }

          html.dark .view input:focus, 
          html.dark .view select:focus {
              background-color: #333;
              border-color: var(--macos-blue) !important;
          }

          html.dark .view .bg-gray-50,
          html.dark #ocr-result,
          html.dark .min-h-\[100px\] {
              background-color: rgba(0,0,0,0.15) !important;
              border-color: rgba(255,255,255,0.1) !important;
          }

          html.dark .file-list-item,
          html.dark #images-list .draggable,
          html.dark #edit-pdf-pages .page-item,
          html.dark #handout-source-pages-preview .source-page-item,
          html.dark #rotate-pdf-pages-preview .source-page-item {
              background-color: var(--macos-white);
              border-color: var(--macos-border);
          }
          
          html.dark #loader-overlay {
              background-color: var(--macos-bg);
          }

          html.dark .loader {
               border: 4px solid var(--macos-secondary-btn-bg);
               border-top-color: var(--macos-blue);
          }
          
          html.dark [data-tooltip]::after {
              background-color: rgba(60, 60, 60, 0.9);
              color: #F5F5F7;
          }
          /* --- END OF DARK THEME STYLES --- */

          /* 3. General Styles */
          html, body {
            margin: 0;
            padding: 0;
            background-color: var(--macos-bg);
            color: var(--macos-text);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'PingFang TC', 'Microsoft JhengHei', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            font-size: 15px;
            font-weight: 400;
          }
          
          h1, h2, h3, h4, h5, h6, b, strong {
            font-weight: 600;
            color: var(--macos-text);
          }
          h1 { font-size: 2.25rem; }
          h2 { font-size: 1.25rem; }
          h3 { font-size: 1.1rem; margin-top: 1rem; margin-bottom: 0.5rem; }
          
          #main-title {
              color: var(--main-title-color);
          }

          /* 4. Header & macOS Traffic Lights */
          header {
            position: relative; /* For theme switcher positioning */
            margin-bottom: 0.4rem !important;
          }
          .traffic-lights {
            display: flex;
            gap: 8px;
            padding: 10px 12px 0;
          }
          .traffic-lights .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
          }
          .dot.red { background-color: var(--red-dot); }
          .dot.yellow { background-color: var(--yellow-dot); }
          .dot.green { background-color: var(--green-dot); }
    
          header h1 {
            margin-top: 0.4rem;
            margin-bottom: 0.4rem;
          }
          header p {
            color: var(--macos-text-secondary) !important;
            margin-top: 0;
            margin-bottom: 0;
            line-height: 1.3;
          }
          header p + p {
            margin-top: 0.2rem;
          }
          
          @media (max-width: 480px) {
            body {
                padding: 0;
            }
          }
    
          /* 5. Glassmorphism & Card Styling */
          .glass-panel, .feature-card, .view > .bg-white, #modal > div, #insert-pdf-modal > div, #add-blank-page-modal > div {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: var(--macos-blur);
            -webkit-backdrop-filter: var(--macos-blur);
            border: 1px solid var(--macos-border);
            box-shadow: var(--macos-shadow);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          }
    
          .feature-card {
            cursor: pointer;
            transform: scale(1);
          }
    
          .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--macos-shadow-hover);
          }
          .feature-card:active {
            transform: scale(0.98) translateY(0);
          }
    
          .feature-card h2 {
            color: var(--macos-blue) !important;
          }
          .feature-card p {
            color: var(--macos-text-secondary) !important;
            font-size: 14px;
          }
    
          /* 7. Tool View & Form Styling */
          .view > .bg-white {
            background-color: rgba(255, 255, 255, 0.8) !important;
          }
          .view h2 { color: var(--macos-text); }
          .view p, .view label, .view li { color: var(--macos-text-secondary); }
          .view input[type="text"], .view input[type="number"], .view input[type="url"], .view select, .view input[type="password"], .view input[type="color"] {
            background-color: var(--macos-secondary-btn-bg);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--macos-text);
            transition: all 0.2s ease-in-out;
          }
          .view input:focus, .view select:focus {
            background-color: var(--macos-white);
            border-color: var(--macos-blue) !important;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
            outline: none;
          }
          .view .bg-gray-50 {
            background-color: var(--macos-secondary-btn-bg) !important;
          }
    
          /* 8. Button Styling */
          /* MODIFICATION START: Increased selector specificity to ensure padding is applied correctly */
          #app-container button, #app-container a.button, #app-container #ocr-pdf-view label[for="ocr-pdf-input"] {
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 28px; /* Increased padding for better visual comfort */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            text-decoration: none;
          }
          /* MODIFICATION END */
          /* Icon-only buttons need smaller, square padding */
          #zoom-out-btn, #zoom-in-btn, #handout-zoom-out-btn, #handout-zoom-in-btn, #rotate-zoom-out-btn, #rotate-zoom-in-btn {
            padding: 10px;
          }
          button:active, a.button:active, #ocr-pdf-view label[for="ocr-pdf-input"]:active {
            transform: scale(0.98);
          }
          button:disabled {
            background-color: #E0E0E0 !important;
            color: #A0A0A0 !important;
            cursor: not-allowed;
            opacity: 0.7;
          }
    
          /* Primary Buttons */
          [id$="-btn"], #download-ocr-btn, #ocr-pdf-view label[for="ocr-pdf-input"], #confirm-insert-btn, #confirm-add-blank-page-btn, a.button-primary {
            background-color: var(--macos-blue) !important;
            color: white !important;
          }
          [id$="-btn"]:hover:not(:disabled), #download-ocr-btn:hover:not(:disabled), #ocr-pdf-view label[for="ocr-pdf-input"]:hover, #confirm-insert-btn:hover, #confirm-add-blank-page-btn:hover, a.button-primary:hover {
            background-color: var(--macos-blue-hover) !important;
          }
    
          /* Secondary Buttons (Back to Home) */
          [id^="back-to-home-"] {
            background-color: #F97316 !important; /* Soft Orange */
            color: white !important;
          }
          [id^="back-to-home-"]:hover {
              background-color: #EA580C !important; /* Darker Orange on hover */
          }
          #cancel-insert-btn, #cancel-add-blank-page-btn {
            background-color: var(--macos-secondary-btn-bg) !important;
            color: var(--macos-text) !important;
          }
          #cancel-insert-btn:hover, #cancel-add-blank-page-btn:hover {
            background-color: var(--macos-secondary-btn-bg-hover) !important;
          }
    
          /* Danger Button (Delete Pages) */
          #delete-selected-pages-btn {
              background-color: var(--macos-red) !important;
              color: white !important;
          }
          #delete-selected-pages-btn:hover {
              background-color: var(--macos-red-hover) !important;
          }
          
          /* File Input Buttons */
          input[type="file"] {
            color: var(--macos-text-secondary);
          }
          input[type="file"]::file-selector-button {
            background-color: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            margin-right: 16px;
            transition: background-color 0.2s;
            cursor: pointer;
          }
          input[type="file"]::file-selector-button:hover {
            background-color: var(--macos-blue-hover);
          }
          
          /* 9. Lists and UI Elements */
          .file-list-item, #images-list .draggable, #edit-pdf-pages .page-item, #handout-source-pages-preview .source-page-item, #rotate-pdf-pages-preview .source-page-item {
            background-color: var(--macos-white);
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
          }
          .close-btn {
            color: var(--macos-text-secondary) !important;
            opacity: 0.6;
            transition: opacity 0.2s;
          }
          .close-btn:hover {
            opacity: 1;
          }
          #ocr-result {
              background-color: var(--macos-secondary-btn-bg) !important;
              border-color: transparent !important;
              border-radius: 8px;
          }
          .min-h-\[100px\] {
              background-color: rgba(0,0,0,0.03);
              border: 2px dashed rgba(0,0,0,0.1);
          }
          
          /* 10. Loader */
          .loader {
            width: 30px;
            height: 30px;
            border: 4px solid var(--macos-secondary-btn-bg);
            border-top-color: var(--macos-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
          }
          @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
          /* --- START OF DRAG & DROP FIX STYLES --- */
          .page-item.marked-for-deletion {
            opacity: 0.4;
            position: relative;
            border: 2px solid #FF5F57;
          }
          .page-item.marked-for-deletion::after {
            content: '✖';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #FF5F57;
            font-weight: bold;
            text-shadow: 0 0 5px white;
          }
          
          .drag-placeholder {
            background-color: rgba(0, 122, 255, 0.1);
            border: 2px dashed var(--macos-blue);
            border-radius: 8px;
            box-sizing: border-box; 
          }
          
          .dragging {
            opacity: 0.5 !important;
            box-shadow: var(--macos-shadow-hover);
            transform: scale(1.05);
          }
          
          hr.section-divider {
            border: none;
            height: 1px;
            background-color: var(--macos-border);
            margin: 1rem 0; /* Reduced margin */
          }
          /* --- END OF DRAG & DROP FIX STYLES --- */
          
          /* START: Handout & Rotate Preview Styles */
          #handout-source-pages-preview .source-page-item,
          #rotate-pdf-pages-preview .source-page-item {
            position: relative;
            border-radius: 4px;
            overflow: hidden;
          }
          #handout-source-pages-preview img,
          #rotate-pdf-pages-preview img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
          }
           #handout-source-pages-preview .page-number,
           #rotate-pdf-pages-preview .page-number {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
          }
          /* END: Handout & Rotate Preview Styles */
    
    
          /* Base structural styles */
          .view { display: none; }
          .view.active { display: block; }
          
          /* Styles for the new startup loader overlay */
          #loader-overlay {
            position: fixed;
            inset: 0;
            background-color: var(--macos-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease-out;
          }
          #loader-overlay .loader {
            width: 40px;
            height: 40px;
          }
    
          /* --- START OF GENERIC TOOLTIP STYLES --- */
          [data-tooltip] {
            position: relative;
          }
    
          [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            background-color: rgba(29, 29, 31, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: #FFFFFF;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
          }
    
          [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
          }
          /* --- END OF GENERIC TOOLTIP STYLES --- */

          /* --- START OF HELP VIEW STYLES --- */
          .keyword {
            color: var(--macos-blue);
            font-weight: 600;
          }
          .help-item {
            display: flex;
            align-items: flex-start;
            gap: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--macos-border);
          }
          .help-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
          }
          .help-icon-container {
            flex-shrink: 0;
            margin-top: 4px; /* Align icon slightly better with title */
          }
          .help-text-container ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            color: var(--macos-text-secondary);
          }
          .help-text-container li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
          }
          /* --- END OF HELP VIEW STYLES --- */

          /* --- START OF THEME SWITCHER BUTTON STYLES --- */
          #theme-switcher {
            color: var(--theme-switcher-color);
            transition: background-color 0.2s, color 0.2s;
          }
          #theme-switcher:hover {
              background-color: var(--theme-switcher-bg-hover);
          }
          /* --- END OF THEME SWITCHER BUTTON STYLES --- */
    </style>
    </head>
    <body>
    
        <div id="loader-overlay">
            <div class="loader"></div>
        </div>
        
        <div id="app-container" style="opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out;">
            <div class="w-full max-w-7xl mx-auto p-4 md:w-[90%] lg:w-[85%] md:p-6 lg:p-8"> 
                <header class="mb-4">
                    <div class="traffic-lights">
                        <div class="dot red"></div>
                        <div class="dot yellow"></div>
                        <div class="dot green"></div>
                    </div>
                    <!-- START: 新增的主題切換按鈕 -->
                    <div class="absolute top-2 right-3 z-20">
                        <button id="theme-switcher" class="p-2 rounded-full focus:outline-none" data-tooltip="切換明暗主題">
                            <svg id="theme-icon-sun" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414-1.414l.707.707a1 1 0 11-1.414 1.414l-.707-.707zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                            <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        </button>
                    </div>
                    <!-- END: 新增的主題切換按鈕 -->
                    <div class="text-center">
                        <h1 id="main-title" class="text-3xl md:text-3xl font-bold tracking-tight mt-3">全能PDF工具箱</h1>
                        <p class="text-lg md:text-m mt-0 font-semibold">PDF 文件合併分割、壓縮旋轉、刪除排序、擷取文字圖片等功能</p>
                        <p class="text-sm text-sm mt-0">製作者：陳政德</p>
                    </div>
                    <!-- START: 新增的操作說明按鈕 -->
                    <div class="text-center mt-1">
                        <a href="#" id="show-help-btn" class="inline-block bg-white hover:bg-gray-100 text-m font-semibold py-1 px-1 rounded-lg shadow-sm border border-gray-200 transition-colors">
                            <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            操作說明
                        </a>
                    </div>
                    <!-- END: 新增的操作說明按鈕 -->
                </header>
    
                <div id="home-view" class="view active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div data-view="merge-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將多個 PDF 文件合併成一個檔案。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="mergeGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF6B6B"/><stop offset="100%" stop-color="#FF3838"/></linearGradient><filter id="shadow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="1"/><feOffset dx="1" dy="1" result="offsetblur"/><feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#mergeGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF" transform="translate(0, 2)">
                                <path d="M28 17h14v22H28z" opacity=".7"/>
                                <path d="M22 23h14v22H22z"/>
                                <path d="M40 33h4v2h-4zm-2-2h2v-2h-2zm2 6h2v-2h-2zm-2-2h-2v2h2z"/>
                              </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 合併</h2><p>多個PDF檔案輕鬆合併，快速整合為完整單一檔案</p></div>
                        </div>
                        <div data-view="split-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將單一 PDF 文件分割成多個獨立檔案或指定頁面。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="splitGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#51E28E"/><stop offset="100%" stop-color="#22C55E"/></linearGradient></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#splitGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF" transform="translate(0, 2)">
                                <path d="M22 23v22h7V23zM35 23v22h7V23z"/>
                                <circle cx="32" cy="27" r="1.5"/><circle cx="32" cy="33" r="1.5"/><circle cx="32" cy="39" r="1.5"/>
                              </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 分割</h2><p>快速分割PDF文件檔案，輕鬆拆分為多個獨立文件</p></div>
                        </div>
                        <div data-view="pdf-to-image-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將 PDF 每一頁轉換成 JPG 或 PNG 圖片。">
                             <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="pdfToImgGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD166"/><stop offset="100%" stop-color="#FCA311"/></linearGradient></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#pdfToImgGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF" transform="translate(0, 2)">
                                <path d="M18 24h10v16H18z"/><path d="M34 31h12l-1-1-2 2-3-3-4 4v3h12v-5z"/><path d="M29 31.5l4-4v8l-4-4z"/>
                              </g>
                            </svg>
                             <div><h2 class="text-xl font-semibold">PDF 轉圖片</h2><p>將PDF文件的每一頁轉換為高品質JPG或PNG圖片</p></div>
                        </div>
                        <div data-view="image-to-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將單張圖片轉換為一個 PDF 檔案。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="imgToPdfGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#4D82FF"/><stop offset="100%" stop-color="#0052FF"/></linearGradient></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#imgToPdfGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF" transform="translate(0, 2)">
                                <path d="M18 26h12l-1-1-2 2-3-3-4 4v3h12v-5z"/><path d="M36 24h10v16H36z"/><path d="M31 31.5l4 4v-8l-4 4z"/>
                              </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">圖片轉 PDF</h2><p>將您的單張圖片，快速轉換成標準的PDF檔案格式</p></div>
                        </div>
                        <div data-view="images-to-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將多張圖片合併成一個 PDF 檔案。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="imgsToPdfGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#5f27cd"/><stop offset="100%" stop-color="#341f97"/></linearGradient></defs>
                                <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#imgsToPdfGradient)"/>
                                <g filter="url(#shadow)" fill="#FFF">
                                    <path d="M28 22h16l-1.5-1.5-2.5 2.5-3.5-3.5-5 5v4h16v-6.5z" opacity="0.6"/>
                                    <path d="M24 26h16l-1.5-1.5-2.5 2.5-3.5-3.5-5 5v4h16v-6.5z" opacity="0.8"/>
                                    <path d="M20 30h16l-1.5-1.5-2.5 2.5-3.5-3.5-5 5v4h16v-6.5z"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">多圖轉 PDF</h2><p>批量整合多張圖片檔案，合併成一個完整PDF檔案</p></div>
                        </div>
                        <div data-view="ocr-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="使用 OCR 技術從 PDF 中提取文字內容。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="ocrGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#17C9E3"/><stop offset="100%" stop-color="#00AABF"/></linearGradient></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#ocrGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF" transform="translate(0, 2)">
                                <path d="M22 22h20v4H22zm0 7h20v2H22zm0 5h12v2H22z"/>
                                <path d="M36 34a6 6 0 110 12 6 6 0 010-12zm-2 9l-5 5"/>
                              </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 文字擷取</h2><p>擷取PDF文件中的文字內容，但圖形暫時無法識別</p></div>
                        </div>
                        <div data-view="compress-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="減小 PDF 檔案大小，同時保留文字可選取性。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="compressGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#06B6D4"/><stop offset="100%" stop-color="#0891B2"/></linearGradient></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#compressGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF" transform="translate(0, 2)">
                                <path d="M24 24h-4v4l6-6-6-6v4h-4v4h4zm16 16h4v-4l-6 6 6 6v-4h4v-4h-4zM24 40h-4v-4l-6 6 6 6v-4h4zM40 24h4v4l6-6-6-6v4h-4z"/>
                              </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">壓縮 PDF</h2><p>幫您壓縮PDF檔案大小，同時保持文字選取複製功能</p></div>
                        </div>
                        <div data-view="rotate-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將 PDF 檔案的所有頁面旋轉指定角度。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                              <defs><linearGradient id="rotateGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#F97316"/><stop offset="100%" stop-color="#EA580C"/></linearGradient></defs>
                              <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#rotateGradient)"/>
                              <g filter="url(#shadow)" fill="#FFF">
                                  <path d="M32 18 C 22.059 18 14 26.059 14 36 S 22.059 54 32 54 C 33.15 54 34.257 53.896 35.312 53.693 L 33.771 49.34 C 33.196 49.444 32.607 49.5 32 49.5 C 24.542 49.5 18.5 43.458 18.5 36 S 24.542 22.5 32 22.5 C 39.458 22.5 45.5 28.542 45.5 36 H 41 L 47 44 L 53 36 H 48.5 C 48.5 26.341 41.159 18 32 18 Z" />
                              </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">旋轉 PDF</h2><p>批量處理PDF頁面旋轉，統一設定全文件旋轉角度</p></div>
                        </div>
                        <div data-view="add-page-numbers-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="在 PDF 頁面的頁首或頁尾加上頁碼。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="pageNumGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#8B5CF6"/><stop offset="100%" stop-color="#7C3AED"/></linearGradient></defs>
                                <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#pageNumGradient)"/>
                                <g filter="url(#shadow)" fill="#FFF">
                                    <path d="M22,18 L38,18 L38,22 L42,22 L42,46 L22,46 L22,18 Z M26,38 L38,38 L38,42 L26,42 L26,38 Z M26,32 L38,32 L38,36 L26,36 L26,32 Z M26,26 L34,26 L34,30 L26,30 L26,26 Z"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 加頁碼</h2><p>為PDF文件添加頁碼，自訂顯示位置、大小與格式</p></div>
                        </div>
                        <div data-view="edit-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="重新排序、刪除、插入或新增 PDF 頁面。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="editGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#3B82F6"/><stop offset="100%" stop-color="#2563EB"/></linearGradient></defs>
                                <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#editGradient)"/>
                                <g filter="url(#shadow)" fill="#FFF">
                                    <path d="M42.3,21.7 L45.1,18.9 C46.1,17.9 46.1,16.3 45.1,15.3 L42.7,12.9 C41.7,11.9 40.1,11.9 39.1,12.9 L36.3,15.7 L42.3,21.7 Z M34.6,17.4 L18,34 L18,40 L24,40 L40.6,23.4 L34.6,17.4 Z"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 頁面管理</h2><p>提供PDF頁面預覽功能，支援拖曳排序與刪除功能</p></div>
                        </div>
                        <div data-view="extract-images-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="從 PDF 中提取所有內嵌的圖片並打包下載。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="extractGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#2DD4BF"/><stop offset="100%" stop-color="#14B8A6"/></linearGradient></defs>
                                <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#extractGradient)"/>
                                <g filter="url(#shadow)" fill="#FFF">
                                    <path d="M22,22 L42,22 L42,42 L22,42 L22,22 Z M26,35 L30,30 L32.5,32.5 L35,29 L38,35 L26,35 Z"/>
                                    <path d="M16 16V24H18V18H24V16z M48 16V24H46V18H40V16z M16 40V48H24V46H18V40z M48 40V48H40V46H46V40z"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 擷取圖片</h2><p>自動選取PDF文件中的所有圖片，並提供打包下載服務</p></div>
                        </div>
                        <div data-view="pdf-to-web-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將 PDF 轉換為可滾動或簡報模式的 HTML 網頁。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="webGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#EC4899"/><stop offset="100%" stop-color="#DB2777"/></linearGradient></defs>
                                <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#webGradient)"/>
                                <g filter="url(#shadow)" fill="#FFF">
                                    <path d="M26,24 L22,34 L26,44 M38,24 L42,34 L38,44 M19,34 L45,34"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 轉網頁</h2><p>將PDF每頁轉換為圖片格式，整合為HTML網頁檔案</p></div>
                        </div>
                        <div data-view="word-to-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將 .docx 文件轉換為 PDF 格式（可能會有排版差異）。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="wordGradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#2B579A" /><stop offset="100%" stop-color="#002D62" /></linearGradient></defs>
                                <rect width="60" height="60" x="2" y="2" rx="12" fill="url(#wordGradient)" />
                                <g filter="url(#shadow)" fill="white" font-family="Arial, sans-serif" font-size="32" font-weight="bold">
                                    <text x="20" y="44">W</text>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">Word 轉 PDF</h2><p>解析HTML與CSS技術，將Word文件轉換匯出為PDF格式</p></div>
                        </div>
                        <div data-view="excel-to-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將 .xlsx 文件轉換為 PDF 格式（可能會有排版差異）。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="excelGradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#217346" /><stop offset="100%" stop-color="#004B1C" /></linearGradient></defs>
                                <rect width="60" height="60" x="2" y="2" rx="12" fill="url(#excelGradient)" />
                                <g filter="url(#shadow)" fill="white">
                                    <path d="M22 24h6v6h-6zm8 0h6v6h-6zm8 0h6v6h-6zM22 32h6v6h-6zm8 0h6v6h-6zm8 0h6v6h-6z"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">Excel 轉 PDF</h2><p>解析HTML與CSS技術，將Excel文件轉換匯出為PDF格式</p></div>
                        </div>
                        <div data-view="handout-pdf-view" class="feature-card px-6 py-4 rounded-lg flex items-center space-x-4" data-tooltip="將多頁 PDF 內容排列到單一 A4 頁面上，製作講義。">
                            <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                <defs><linearGradient id="handoutGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#6D28D9"/><stop offset="100%" stop-color="#4C1D95"/></linearGradient></defs>
                                <rect x="2" y="2" width="60" height="60" rx="12" fill="url(#handoutGradient)"/>
                                <g fill="white" filter="url(#shadow)">
                                    <rect x="18" y="18" width="28" height="36" rx="2" fill="rgba(255,255,255,0.8)"/>
                                    <rect x="21" y="21" width="10" height="7"/>
                                    <rect x="33" y="21" width="10" height="7"/>
                                    <rect x="21" y="30" width="10" height="7"/>
                                    <rect x="33" y="30" width="10" height="7"/>
                                    <rect x="21" y="39" width="10" height="7"/>
                                    <rect x="33" y="39" width="10" height="7"/>
                                </g>
                            </svg>
                            <div><h2 class="text-xl font-semibold">PDF 講義製作</h2><p>將PDF多個頁面縮圖排列到單一A4頁面上，以便製作講義</p></div>
                        </div>
                    </div>
                </div>
    
                <!-- Feature Views HTML -->
                <div id="feature-views-container" class="mt-8">
                    <!-- START: 新增的操作說明 View -->
                    <div id="help-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">功能操作說明</h2>
                                <button id="back-to-home-16" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <div class="space-y-6">
                                <!-- PDF 合併 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="mergeGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF6B6B"/><stop offset="100%" stop-color="#FF3838"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#mergeGradient-help)"/><g fill="#FFF" transform="translate(0, 2)"><path d="M28 17h14v22H28z" opacity=".7"/><path d="M22 23h14v22H22z"/><path d="M40 33h4v2h-4zm-2-2h2v-2h-2zm2 6h2v-2h-2zm-2-2h-2v2h2z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 合併</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 合併</b> 功能卡。</li>
                                            <li>點擊 <b class="keyword">選擇檔案</b> 按鈕，或直接將您的 PDF 檔案拖曳至視窗中。</li>
                                            <li>您必須一次選擇 <b class="keyword">多個</b> PDF 檔案。</li>
                                            <li>在檔案列表中，您可以按住檔案名稱並 <b class="keyword">上下拖曳</b> 來調整合併後的順序。</li>
                                            <li>確認順序無誤後，點擊 <b class="keyword">開始合併</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 分割 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="splitGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#51E28E"/><stop offset="100%" stop-color="#22C55E"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#splitGradient-help)"/><g fill="#FFF" transform="translate(0, 2)"><path d="M22 23v22h7V23zM35 23v22h7V23z"/><circle cx="32" cy="27" r="1.5"/><circle cx="32" cy="33" r="1.5"/><circle cx="32" cy="39" r="1.5"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 分割</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 分割</b> 功能卡。</li>
                                            <li>選擇一個要分割的 PDF 檔案。</li>
                                            <li>選擇分割模式：<b class="keyword">分割成單頁 PDF</b> 或 <b class="keyword">按範圍提取</b>。</li>
                                            <li>若選擇按範圍提取，請在輸入框中填入頁碼，例如 <b class="keyword">1-5, 8, 10-12</b>。</li>
                                            <li>點擊 <b class="keyword">開始分割</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 轉圖片 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                         <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="pdfToImgGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD166"/><stop offset="100%" stop-color="#FCA311"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#pdfToImgGradient-help)"/><g fill="#FFF" transform="translate(0, 2)"><path d="M18 24h10v16H18z"/><path d="M34 31h12l-1-1-2 2-3-3-4 4v3h12v-5z"/><path d="M29 31.5l4-4v8l-4-4z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 轉圖片</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 轉圖片</b> 功能卡。</li>
                                            <li>選擇一個要轉換的 PDF 檔案。</li>
                                            <li>選擇您需要的 <b class="keyword">圖片解析度 (DPI)</b> 和 <b class="keyword">圖片格式 (JPG/PNG)</b>。</li>
                                            <li>點擊 <b class="keyword">開始轉換</b> 按鈕，完成後會下載一個 ZIP 壓縮檔。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- 圖片轉 PDF -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="imgToPdfGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#4D82FF"/><stop offset="100%" stop-color="#0052FF"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#imgToPdfGradient-help)"/><g fill="#FFF" transform="translate(0, 2)"><path d="M18 26h12l-1-1-2 2-3-3-4 4v3h12v-5z"/><path d="M36 24h10v16H36z"/><path d="M31 31.5l4 4v-8l-4 4z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">圖片轉 PDF</h3>
                                         <ol>
                                            <li>點擊主選單上的 <b class="keyword">圖片轉 PDF</b> 功能卡。</li>
                                            <li>選擇 <b class="keyword">一張</b> 要轉換的圖片檔案。</li>
                                            <li>設定 <b class="keyword">頁面大小</b> (A4/Letter) 和 <b class="keyword">頁面方向</b> (直向/橫向)。</li>
                                            <li>點擊 <b class="keyword">轉換為 PDF</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- 多圖轉 PDF -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="imgsToPdfGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#5f27cd"/><stop offset="100%" stop-color="#341f97"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#imgsToPdfGradient-help)"/><g fill="#FFF"><path d="M28 22h16l-1.5-1.5-2.5 2.5-3.5-3.5-5 5v4h16v-6.5z" opacity="0.6"/><path d="M24 26h16l-1.5-1.5-2.5 2.5-3.5-3.5-5 5v4h16v-6.5z" opacity="0.8"/><path d="M20 30h16l-1.5-1.5-2.5 2.5-3.5-3.5-5 5v4h16v-6.5z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">多圖轉 PDF</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">多圖轉 PDF</b> 功能卡。</li>
                                            <li>一次選擇 <b class="keyword">多張</b> 要轉換的圖片檔案。</li>
                                            <li>在預覽區中，您可以 <b class="keyword">拖曳圖片</b> 來調整它們在 PDF 中的順序。</li>
                                            <li>設定 <b class="keyword">頁面大小</b> 和 <b class="keyword">頁面方向</b>。</li>
                                            <li>點擊 <b class="keyword">合併並轉換</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 文字擷取 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="ocrGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#17C9E3"/><stop offset="100%" stop-color="#00AABF"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#ocrGradient-help)"/><g fill="#FFF" transform="translate(0, 2)"><path d="M22 22h20v4H22zm0 7h20v2H22zm0 5h12v2H22z"/><path d="M36 34a6 6 0 110 12 6 6 0 010-12zm-2 9l-5 5"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 文字擷取 (OCR)</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 文字擷取</b> 功能卡。</li>
                                            <li>點擊 <b class="keyword">→ 點擊此處加入 PDF 檔案到這裡</b> 按鈕來選擇檔案。</li>
                                            <li>系統會自動開始處理，請耐心等候。狀態列會顯示進度。</li>
                                            <li>處理完成後，辨識出的文字會顯示在下方的預覽框中。</li>
                                            <li>您可以點擊 <b class="keyword">下載為文字檔</b> 按鈕，將結果儲存為 .rtf 檔案。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- 壓縮 PDF -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="compressGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#06B6D4"/><stop offset="100%" stop-color="#0891B2"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#compressGradient-help)"/><g fill="#FFF" transform="translate(0, 2)"><path d="M24 24h-4v4l6-6-6-6v4h-4v4h4zm16 16h4v-4l-6 6 6 6v-4h4v-4h-4zM24 40h-4v-4l-6 6 6 6v-4h4zM40 24h4v4l6-6-6-6v4h-4z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">壓縮 PDF</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">壓縮 PDF</b> 功能卡。</li>
                                            <li>選擇一個要壓縮的 PDF 檔案。</li>
                                            <li>拖曳 <b class="keyword">圖片壓縮品質</b> 滑桿，品質越低，檔案越小，但圖片越模糊。</li>
                                            <li>此功能會保留 <b class="keyword">可搜尋與複製</b> 的文字層。</li>
                                            <li>點擊 <b class="keyword">開始壓縮</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- 旋轉 PDF -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="rotateGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#F97316"/><stop offset="100%" stop-color="#EA580C"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#rotateGradient-help)"/><g fill="#FFF"><path d="M32 18 C 22.059 18 14 26.059 14 36 S 22.059 54 32 54 C 33.15 54 34.257 53.896 35.312 53.693 L 33.771 49.34 C 33.196 49.444 32.607 49.5 32 49.5 C 24.542 49.5 18.5 43.458 18.5 36 S 24.542 22.5 32 22.5 C 39.458 22.5 45.5 28.542 45.5 36 H 41 L 47 44 L 53 36 H 48.5 C 48.5 26.341 41.159 18 32 18 Z" /></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">旋轉 PDF</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">旋轉 PDF</b> 功能卡。</li>
                                            <li>選擇一個要旋轉的 PDF 檔案。</li>
                                            <li>設定 <b class="keyword">旋轉角度</b> (90°, 180°, 270°)。</li>
                                            <li>在 <b class="keyword">旋轉頁面範圍</b> 輸入框中，您可以指定要旋轉的頁面 (例如: 1-3, 5)。若留白，則旋轉 <b class="keyword">所有頁面</b>。</li>
                                            <li>點擊 <b class="keyword">開始旋轉</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 加頁碼 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="pageNumGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#8B5CF6"/><stop offset="100%" stop-color="#7C3AED"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#pageNumGradient-help)"/><g fill="#FFF"><path d="M22,18 L38,18 L38,22 L42,22 L42,46 L22,46 L22,18 Z M26,38 L38,38 L38,42 L26,42 L26,38 Z M26,32 L38,32 L38,36 L26,36 L26,32 Z M26,26 L34,26 L34,30 L26,30 L26,26 Z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 加頁碼</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 加頁碼</b> 功能卡。</li>
                                            <li>選擇一個要加上頁碼的 PDF 檔案。</li>
                                            <li>依序設定 <b class="keyword">頁碼位置</b>、<b class="keyword">字體大小</b>、<b class="keyword">顏色</b>、<b class="keyword">格式</b> (<code>{page}</code>是目前頁碼, <code>{total}</code>是總頁數) 等。</li>
                                            <li>在 <b class="keyword">套用頁碼範圍</b> 輸入框中，可指定頁面 (例如: 2-10)。若留白，則為 <b class="keyword">所有頁面</b> 加上頁碼。</li>
                                            <li>點擊 <b class="keyword">加上頁碼</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 頁面管理 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="editGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#3B82F6"/><stop offset="100%" stop-color="#2563EB"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#editGradient-help)"/><g fill="#FFF"><path d="M42.3,21.7 L45.1,18.9 C46.1,17.9 46.1,16.3 45.1,15.3 L42.7,12.9 C41.7,11.9 40.1,11.9 39.1,12.9 L36.3,15.7 L42.3,21.7 Z M34.6,17.4 L18,34 L18,40 L24,40 L40.6,23.4 L34.6,17.4 Z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 頁面管理</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 頁面管理</b> 功能卡，並選擇檔案。</li>
                                            <li><b class="keyword">排序頁面</b>：直接用滑鼠 <b class="keyword">拖曳</b> 頁面縮圖到新位置。</li>
                                            <li><b class="keyword">刪除頁面</b>：<b class="keyword">點擊</b> 任何您想刪除的頁面縮圖，它會被標記為紅色。可多選。然後點擊上方的 <b class="keyword">刪除頁面</b> 按鈕。</li>
                                            <li><b class="keyword">插入檔案</b>：點擊 <b class="keyword">插入檔案</b> 按鈕，選擇另一個 PDF 及要插入的位置。</li>
                                            <li><b class="keyword">新增空白頁</b>：點擊 <b class="keyword">新增空白頁</b> 按鈕，設定大小、方向及要插入的位置。</li>
                                            <li>完成所有操作後，點擊 <b class="keyword">儲存變更</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 擷取圖片 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="extractGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#2DD4BF"/><stop offset="100%" stop-color="#14B8A6"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#extractGradient-help)"/><g fill="#FFF"><path d="M22,22 L42,22 L42,42 L22,42 L22,22 Z M26,35 L30,30 L32.5,32.5 L35,29 L38,35 L26,35 Z"/><path d="M16 16V24H18V18H24V16z M48 16V24H46V18H40V16z M16 40V48H24V46H18V40z M48 40V48H40V46H46V40z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 擷取圖片</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 擷取圖片</b> 功能卡。</li>
                                            <li>選擇一個包含圖片的 PDF 檔案。</li>
                                            <li>點擊 <b class="keyword">開始擷取</b> 按鈕。</li>
                                            <li>系統會自動掃描文件內所有圖片，並打包成一個 ZIP 壓縮檔供您下載。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- PDF 轉網頁 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="webGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#EC4899"/><stop offset="100%" stop-color="#DB2777"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#webGradient-help)"/><g fill="#FFF"><path d="M26,24 L22,34 L26,44 M38,24 L42,34 L38,44 M19,34 L45,34"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 轉網頁</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 轉網頁</b> 功能卡。</li>
                                            <li>選擇一個要轉換的 PDF 檔案。</li>
                                            <li>選擇 <b class="keyword">瀏覽模式</b>：<b class="keyword">連續捲動</b> (像一般網頁) 或 <b class="keyword">單頁簡報</b> (像PPT)。</li>
                                            <li>選擇 <b class="keyword">頁面寬度</b> 來決定網頁解析度。</li>
                                            <li>點擊 <b class="keyword">開始轉換</b> 按鈕，會下載一個 HTML 檔。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- Word 轉 PDF -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="wordGradient-help" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#2B579A" /><stop offset="100%" stop-color="#002D62" /></linearGradient></defs><rect width="60" height="60" x="2" y="2" rx="12" fill="url(#wordGradient-help)" /><g fill="white" font-family="Arial, sans-serif" font-size="32" font-weight="bold"><text x="20" y="44">W</text></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">Word 轉 PDF</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">Word 轉 PDF</b> 功能卡。</li>
                                            <li>選擇一個 <b class="keyword">.docx</b> 檔案。</li>
                                            <li>點擊 <b class="keyword">轉換並開啟列印</b> 按鈕。</li>
                                            <li>瀏覽器會自動彈出 <b class="keyword">列印預覽</b> 對話框。</li>
                                            <li>在「目的地」或「印表機」選項中選擇 <b class="keyword">另存為 PDF</b> 或 <b class="keyword">Microsoft Print to PDF</b>，然後儲存即可。</li>
                                        </ol>
                                    </div>
                                </div>
                                <!-- Excel 轉 PDF -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="excelGradient-help" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#217346" /><stop offset="100%" stop-color="#004B1C" /></linearGradient></defs><rect width="60" height="60" x="2" y="2" rx="12" fill="url(#excelGradient-help)" /><g fill="white"><path d="M22 24h6v6h-6zm8 0h6v6h-6zm8 0h6v6h-6zM22 32h6v6h-6zm8 0h6v6h-6zm8 0h6v6h-6z"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">Excel 轉 PDF</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">Excel 轉 PDF</b> 功能卡。</li>
                                            <li>選擇一個 <b class="keyword">.xlsx</b> 檔案。</li>
                                            <li>點擊 <b class="keyword">轉換並開啟列印</b> 按鈕。</li>
                                            <li>瀏覽器會自動彈出 <b class="keyword">列印預覽</b> 對話框。</li>
                                            <li>在「目的地」或「印表機」選項中選擇 <b class="keyword">另存為 PDF</b> 或 <b class="keyword">Microsoft Print to PDF</b>，然後儲存即可。</li>
                                        </ol>
                                    </div>
                                </div>
                                 <!-- PDF 講義製作 -->
                                <div class="help-item">
                                    <div class="help-icon-container">
                                        <svg class="w-14 h-14" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="handoutGradient-help" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#6D28D9"/><stop offset="100%" stop-color="#4C1D95"/></linearGradient></defs><rect x="2" y="2" width="60" height="60" rx="12" fill="url(#handoutGradient-help)"/><g fill="white"><rect x="18" y="18" width="28" height="36" rx="2" fill="rgba(255,255,255,0.8)"/><rect x="21" y="21" width="10" height="7"/><rect x="33" y="21" width="10" height="7"/><rect x="21" y="30" width="10" height="7"/><rect x="33" y="30" width="10" height="7"/><rect x="21" y="39" width="10" height="7"/><rect x="33" y="39" width="10" height="7"/></g></svg>
                                    </div>
                                    <div class="help-text-container">
                                        <h3 class="text-lg font-bold">PDF 講義製作</h3>
                                        <ol>
                                            <li>點擊主選單上的 <b class="keyword">PDF 講義製作</b> 功能卡。</li>
                                            <li>選擇要做成講義的 PDF 檔案。</li>
                                            <li>設定 <b class="keyword">版面配置</b> (每頁要放幾張投影片)、<b class="keyword">A4 方向</b>、<b class="keyword">間距</b> 和 <b class="keyword">邊界</b>。</li>
                                            <li>可勾選附加功能，如 <b class="keyword">加上原始頁碼</b>、<b class="keyword">加上邊框</b>、<b class="keyword">為講義加上新頁碼</b> 或 <b class="keyword">加上自訂文字</b>。</li>
                                            <li>所有選項設定完畢後，點擊 <b class="keyword">開始製作</b> 按鈕。</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END: 新增的操作說明 View -->
                    <!-- Merge PDF View -->
                    <div id="merge-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">PDF 合併</h2>
                                <button id="back-to-home-1" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">必須一次選擇多個 PDF 檔案，按住並拖曳檔案以調整合併順序。</p>
                            <input type="file" id="merge-pdf-files" accept=".pdf" multiple class="block w-full text-sm mb-4"/>
                            <div id="merge-pdf-list" class="min-h-[100px] p-2 rounded-md border"></div>
                            <div class="mt-6">
                                <button id="merge-pdf-btn" disabled data-tooltip="開始合併所選的 PDF 檔案">開始合併</button>
                            </div>
                        </div>
                    </div>
                    <!-- Split PDF View -->
                    <div id="split-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">PDF 分割</h2>
                                <button id="back-to-home-2" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">選擇一個 PDF 檔案進行分割。</p>
                            <input type="file" id="split-pdf-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="split-pdf-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            <div id="split-options" class="hidden">
                                <h3 class="font-semibold mb-2">分割模式</h3>
                                <div class="space-y-2">
                                    <label class="flex items-center"><input type="radio" name="split-mode" value="all" class="mr-2" checked> 分割成單頁 PDF</label>
                                    <label class="flex items-center"><input type="radio" name="split-mode" value="range" class="mr-2"> 按範圍提取</label>
                                </div>
                                <div id="split-range-input" class="mt-2 hidden">
                                    <input type="text" id="split-page-range" placeholder="例如: 1-5, 8, 10-12" class="w-full">
                                </div>
                            </div>
                            <div class="mt-6">
                                <button id="split-pdf-btn" disabled data-tooltip="根據所選模式分割 PDF">開始分割</button>
                            </div>
                        </div>
                    </div>
                     <!-- PDF to Image View -->
                    <div id="pdf-to-image-view" class="view">
                         <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                             <div class="flex justify-between items-center mb-4">
                                 <h2 class="text-2xl font-bold">PDF 轉圖片</h2>
                                 <button id="back-to-home-3" class="flex items-center" data-tooltip="返回主選單">
                                     <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                     <span>返回主頁</span>
                                 </button>
                             </div>
                             <p class="mb-4">選擇一個 PDF 檔案，設定解析度和格式後，將其轉換為圖片壓縮檔 (ZIP)。</p>
                             <input type="file" id="pdf-to-image-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                             <div id="pdf-to-image-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                             <div id="pdf-to-image-options" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label for="image-resolution" class="block text-sm font-medium">圖片解析度 (DPI)</label>
                                     <select id="image-resolution" class="mt-1 block w-full">
                                         <option value="150">標準 (150 DPI)</option>
                                         <option value="300" selected>高 (300 DPI)</option>
                                         <option value="600">印刷 (600 DPI)</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label for="image-format" class="block text-sm font-medium">圖片格式</label>
                                     <select id="image-format" class="mt-1 block w-full">
                                         <option value="image/jpeg">JPG</option>
                                         <option value="image/png">PNG</option>
                                     </select>
                                 </div>
                             </div>
                             <div class="mt-6">
                                 <button id="pdf-to-image-btn" disabled data-tooltip="將 PDF 轉換為圖片">開始轉換</button>
                             </div>
                         </div>
                    </div>
                    <!-- Image to PDF View -->
                    <div id="image-to-pdf-view" class="view">
                           <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">圖片轉 PDF</h2>
                                <button id="back-to-home-4" class="flex items-center" data-tooltip="返回主選單">
                                     <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                     <span>返回主頁</span>
                                 </button>
                             </div>
                             <p class="mb-4">選擇一張圖片（JPG, PNG, WEBP等）轉換為 PDF。</p>
                             <input type="file" id="image-file" accept="image/*" class="block w-full text-sm mb-4"/>
                             <div class="my-4 text-center">
                                 <img id="image-preview" src="" class="max-w-full max-h-48 mx-auto hidden rounded-md shadow-sm">
                             </div>
                             <div id="image-options" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label for="image-page-size" class="block text-sm font-medium">頁面大小</label>
                                     <select id="image-page-size" class="mt-1 block w-full">
                                         <option>A4</option>
                                         <option>Letter</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label for="image-orientation" class="block text-sm font-medium">頁面方向</label>
                                     <select id="image-orientation" class="mt-1 block w-full">
                                         <option value="portrait">直向 (Portrait)</option>
                                         <option value="landscape">橫向 (Landscape)</option>
                                     </select>
                                 </div>
                             </div>
                             <div class="mt-6">
                                 <button id="image-to-pdf-btn" disabled data-tooltip="將此圖片轉換為 PDF">轉換為 PDF</button>
                             </div>
                         </div>
                    </div>
                    <!-- Images to PDF View -->
                    <div id="images-to-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">多圖轉 PDF</h2>
                                 <button id="back-to-home-5" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">必須一次選擇多張圖片（JPG, PNG, WEBP, HEIC等），按住並拖曳以排序，然後合併成一個 PDF。</p>
                            <input type="file" id="images-files" accept="image/jpeg, image/png, image/webp, image/gif, image/bmp, image/tiff, image/svg+xml, image/heic, image/heif, .heic, .heif" multiple class="block w-full text-sm mb-4"/>
                            <div id="images-list" class="min-h-[100px] p-2 rounded-md border grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="images-page-size" class="block text-sm font-medium">頁面大小</label>
                                    <select id="images-page-size" class="mt-1 block w-full">
                                        <option>A4</option>
                                        <option>Letter</option>
                                     </select>
                                </div>
                                <div>
                                    <label for="images-orientation" class="block text-sm font-medium">頁面方向</label>
                                    <select id="images-orientation" class="mt-1 block w-full">
                                        <option value="portrait">直向 (Portrait)</option>
                                        <option value="landscape">橫向 (Landscape)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-6">
                                <button id="images-to-pdf-btn" disabled data-tooltip="將所有圖片合併為一個 PDF">合併並轉換</button>
                            </div>
                        </div>
                    </div>
                    <!-- OCR PDF View -->
                    <div id="ocr-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">PDF 文字擷取 (OCR)</h2>
                                <button id="back-to-home-6" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">★文字擷取過程中，畫面持續顯示「轉圈圈」動畫，表示系統無法處理此檔案。</p>
                            <div class="text-center mb-4">
                                <label for="ocr-pdf-input" data-tooltip="選擇要進行文字辨識的 PDF">→ 點擊此處加入 PDF 檔案到這裡</label>
                                <input type="file" id="ocr-pdf-input" accept=".pdf" class="hidden">
                            </div>
                            <div id="ocr-status-container" class="flex items-center justify-start p-3 bg-gray-100 rounded-lg mb-4">
                                <div id="ocr-status" class="text-gray-700">請選擇一個 PDF 檔案開始處理...</div>
                                <button id="download-ocr-btn" class="hidden ml-4" data-tooltip="將辨識結果下載為 .rtf 文字檔">下載為文字檔</button>
                            </div>
                            <pre id="ocr-result" class="w-full bg-gray-50 border border-gray-300 rounded-md p-4 min-h-[200px] max-h-[500px] overflow-y-auto whitespace-pre-wrap break-words">尚未處理檔案。</pre>
                        </div>
                    </div>
                    <!-- Compress PDF View -->
                    <div id="compress-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">壓縮 PDF</h2>
                                <button id="back-to-home-7" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">
                               此方法會大幅壓縮頁面中的圖片以減小檔案大小，同時會疊加一層<strong class="text-green-600">隱形的文字層</strong>，讓您的文件在壓縮後依然可以<strong class="text-green-600">搜尋與複製文字</strong>。
                            </p>
                            <input type="file" id="compress-pdf-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="compress-pdf-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            
                            <div id="compress-options" class="hidden mt-4">
                                <label for="compress-ratio" class="block text-m font-bold">圖片壓縮品質 (品質越低，檔案越小)</label>
                                <div class="flex items-center space-x-4 mt-2">
                                    <input type="range" id="compress-ratio" min="10" max="100" value="70" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="compress-ratio-value" class="font-semibold w-12 text-center">70%</span>
                                </div>
                            </div>
    
                            <div class="mt-6">
                                <button id="compress-pdf-btn" disabled data-tooltip="開始壓縮 PDF 檔案">開始壓縮</button>
                            </div>
                        </div>
                    </div>
                    <!-- Rotate PDF View -->
                    <div id="rotate-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">旋轉 PDF</h2>
                                 <button id="back-to-home-8" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">選擇一個 PDF 檔案，預覽頁面後，設定要旋轉的頁面範圍與角度。</p>
                            <input type="file" id="rotate-pdf-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="rotate-pdf-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            
                            <!-- Thumbnail Preview Section for Rotate -->
                            <div id="rotate-pdf-pages-container" class="hidden mb-4">
                                 <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">來源檔案縮圖預覽</h3>
                                    <div class="flex items-center gap-2">
                                        <button id="rotate-zoom-out-btn" data-tooltip="縮小來源縮圖">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <button id="rotate-zoom-in-btn" data-tooltip="放大來源縮圖">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                        </button>
                                    </div>
                                 </div>
                                <div id="rotate-pdf-pages-preview" class="max-h-56 overflow-y-auto p-2 bg-gray-100 rounded-lg grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));">
                                </div>
                            </div>
    
                            <!-- Enhanced Rotate Options -->
                            <div id="rotate-options" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="rotate-angle" class="block text-sm font-medium">旋轉角度</label>
                                    <select id="rotate-angle" class="mt-1 block w-full">
                                        <option value="90">90° (順時針)</option>
                                        <option value="180">180°</option>
                                        <option value="270">270° (逆時針)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="rotate-page-range" class="block text-sm font-medium">旋轉頁面範圍 (可留白)</label>
                                    <input type="text" id="rotate-page-range" placeholder="例如: 1-5, 8 (留白則全部旋轉)" class="mt-1 block w-full">
                                </div>
                            </div>
    
                            <div class="mt-6">
                                <button id="rotate-pdf-btn" disabled data-tooltip="旋轉指定的 PDF 頁面">開始旋轉</button>
                            </div>
                        </div>
                    </div>
                    <!-- Add Page Numbers PDF View -->
                    <div id="add-page-numbers-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">PDF 加頁碼</h2>
                                <button id="back-to-home-9" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">為您的 PDF 文件添加頁碼。使用 <code>{page}</code> 代表目前頁碼，<code>{total}</code> 代表總頁數。</p>
                            <input type="file" id="add-page-numbers-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="add-page-numbers-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            <div id="add-page-numbers-options" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="page-number-position" class="block text-sm font-medium">頁碼位置</label>
                                    <select id="page-number-position" class="mt-1 block w-full">
                                        <option value="bottom-center">頁尾置中</option>
                                        <option value="bottom-right">頁尾靠右</option>
                                        <option value="bottom-left">頁尾靠左</option>
                                        <option value="top-center">頁首置中</option>
                                        <option value="top-right">頁首靠右</option>
                                        <option value="top-left">頁首靠左</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="page-number-size" class="block text-sm font-medium">字體大小</label>
                                    <input type="number" id="page-number-size" value="12" class="mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="page-number-color" class="block text-sm font-medium">字體顏色</label>
                                    <input type="color" id="page-number-color" value="#000000" class="mt-1 block w-full p-1 h-10">
                                </div>
                                <div>
                                    <label for="page-number-format" class="block text-sm font-medium">頁碼格式</label>
                                    <input type="text" id="page-number-format" value="{page} / {total}" class="mt-1 block w-full">
                                </div>
                                <div>
                                    <label for="page-number-range" class="block text-sm font-medium">套用頁碼範圍 (可留白)</label>
                                    <input type="text" id="page-number-range" placeholder="例如: 2-10, 15" class="mt-1 block w-full">
                                </div>
                                 <div class="flex items-end">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="page-number-bold" class="mr-2 h-5 w-5 rounded">
                                        <span>粗體 (Bold)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-6">
                                <button id="add-page-numbers-btn" disabled data-tooltip="為 PDF 加上頁碼">加上頁碼</button>
                            </div>
                        </div>
                    </div>
                    <!-- Edit PDF View -->
                    <div id="edit-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">PDF 頁面管理</h2>
                                <button id="back-to-home-10" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">載入 PDF 後，拖曳頁面縮圖即可重新排序。您也可以直接點擊頁面縮圖右下角頁碼輸入目標位置來快速移動。</p>
                            <div class="flex items-center flex-wrap gap-4 mb-4">
                                <input type="file" id="edit-pdf-file" accept=".pdf" class="block w-full text-sm md:w-auto flex-grow"/>
                                <div class="flex items-center gap-2">
                                    <button id="zoom-out-btn" class="hidden" data-tooltip="縮小頁面預覽">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button id="zoom-in-btn" class="hidden" data-tooltip="放大頁面預覽">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                    </button>
                                </div>
                                <button id="add-blank-page-btn" class="hidden whitespace-nowrap" data-tooltip="插入新的空白頁面">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z"></path></svg>
                                    <span>新增空白頁</span>
                                </button>
                                <button id="insert-pdf-btn" class="hidden whitespace-nowrap" data-tooltip="插入另一個 PDF 檔案">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path></svg>
                                    <span>插入檔案</span>
                                </button>
                                <button id="delete-selected-pages-btn" class="hidden whitespace-nowrap" data-tooltip="刪除所有已選取的紅色標記頁面">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-1.057.26-1.75.417-1.75.417V17a2 2 0 002 2h6a2 2 0 002-2V4.61c0-.001-1.21-.19-1.75-.417v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.414 0 .75.336.75.75V15a.75.75 0 01-1.5 0V4.75A.75.75 0 0110 4z" clip-rule="evenodd" /></svg>
                                    <span>刪除頁面</span>
                                </button>
                            </div>
                            <div id="edit-pdf-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            <div id="edit-pdf-pages" class="min-h-[200px] p-4 rounded-md border grid gap-6" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));"></div>
                            <div class="mt-6">
                                <button id="edit-pdf-btn" disabled data-tooltip="儲存所有頁面變更">儲存變更</button>
                            </div>
                        </div>
                    </div>
                    <!-- Extract Images from PDF View -->
                    <div id="extract-images-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">PDF 擷取圖片</h2>
                                 <button id="back-to-home-11" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">選擇一個 PDF 檔案，系統將會解析並提取其中所有的圖片，打包成一個 ZIP 壓縮檔。</p>
                            <input type="file" id="extract-images-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="extract-images-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            <div class="mt-6">
                                <button id="extract-images-btn" disabled data-tooltip="開始從 PDF 中擷取所有圖片">開始擷取</button>
                            </div>
                        </div>
                    </div>
                    <!-- PDF to Web View -->
                    <div id="pdf-to-web-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">PDF 轉網頁</h2>
                                 <button id="back-to-home-12" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">選擇一個 PDF 檔案，系統會將每一頁轉換為圖片，並打包成一個 HTML 網頁檔。</p>
                            <input type="file" id="pdf-to-web-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="pdf-to-web-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            
                            <div id="pdf-to-web-options" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="web-layout-mode" class="block text-sm font-medium">瀏覽模式</label>
                                    <select id="web-layout-mode" class="mt-1 block w-full">
                                        <option value="scroll">連續捲動頁面</option>
                                        <option value="slideshow">單頁簡報模式</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="web-resolution" class="block text-sm font-medium">頁面寬度 (解析度)</label>
                                    <select id="web-resolution" class="mt-1 block w-full">
                                        <option value="800">800px (標準)</option>
                                        <option value="1024">1024px (平板)</option>
                                        <option value="1366">1366px (筆電)</option>
                                        <option value="1920">1920px (FHD)</option>
                                        <option value="375">375px (手機)</option>
                                    </select>
                                </div>
                            </div>
    
                            <div class="mt-6">
                                <button id="pdf-to-web-btn" disabled data-tooltip="將 PDF 轉換為 HTML 網頁">開始轉換</button>
                            </div>
                        </div>
                    </div>
                    <!-- Word to PDF View -->
                    <div id="word-to-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Word 轉 PDF</h2>
                                <button id="back-to-home-13" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">1.將Word文件轉換為PDF，係採用瀏覽器端解析HTML和CSS的方式，可能導致排版偏差。</p>
                            <p class="mb-4">2.建議使用Microsoft Word開啟您的檔案，並透過其內建功能匯出PDF文件，此方法可確保渲染引擎最佳化地解讀文件內容。</p>
                            <input type="file" id="word-file-input" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="block w-full text-sm mb-4"/>
                            <div class="mt-6">
                                <button id="word-to-pdf-btn" disabled data-tooltip="轉換後將開啟瀏覽器的列印對話框以儲存為 PDF">轉換並開啟列印</button>
                            </div>
                        </div>
                    </div>
                    <!-- Excel to PDF View -->
                    <div id="excel-to-pdf-view" class="view">
                         <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Excel 轉 PDF</h2>
                                <button id="back-to-home-14" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">1.將Excel文件轉換為PDF，係採用瀏覽器端解析HTML和CSS的方式，可能導致排版偏差。</p>
                            <p class="mb-4">2.建議使用Microsoft Excel開啟您的檔案，並透過其內建功能匯出PDF文件，此方法可確保渲染引擎最佳化地解讀文件內容。</p>
                            <input type="file" id="excel-file-input" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="block w-full text-sm mb-4"/>
                            <div class="mt-6">
                                <button id="excel-to-pdf-btn" disabled data-tooltip="轉換後將開啟瀏覽器的列印對話框以儲存為 PDF">轉換並開啟列印</button>
                            </div>
                        </div>
                    </div>
                    <!-- Handout PDF View (ENHANCED) -->
                    <div id="handout-pdf-view" class="view">
                        <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">PDF 講義製作</h2>
                                <button id="back-to-home-15" class="flex items-center" data-tooltip="返回主選單">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                                    <span>返回主頁</span>
                                </button>
                            </div>
                            <p class="mb-4">將 PDF 的多個頁面縮圖合併到一張 A4 頁面上，方便列印與閱讀。</p>
                            <input type="file" id="handout-pdf-file" accept=".pdf" class="block w-full text-sm mb-4"/>
                            <div id="handout-pdf-info" class="mb-4 text-center p-2 bg-gray-50 rounded">請選擇檔案</div>
                            
                            <div id="handout-source-pages-container" class="hidden mb-4">
                                 <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">來源檔案縮圖預覽</h3>
                                    <div class="flex items-center gap-2">
                                        <button id="handout-zoom-out-btn" data-tooltip="縮小來源縮圖">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <button id="handout-zoom-in-btn" data-tooltip="放大來源縮圖">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                        </button>
                                    </div>
                                 </div>
                                <div id="handout-source-pages-preview" class="max-h-56 overflow-y-auto p-2 bg-gray-100 rounded-lg grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));">
                                </div>
                            </div>
    
                            <div id="handout-options" class="hidden">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-semibold text-gray-700">講義版面設定</h3>
                                    <a href="https://fyc43703.github.io/chengder/PowerPoint%E8%AC%9B%E7%BE%A9%E7%89%88%E9%9D%A2%E9%85%8D%E7%BD%AE%E9%A0%90%E8%A6%BD%E5%B7%A5%E5%85%B7.html" target="_blank" class="button button-primary text-sm !py-1 !px-3" data-tooltip="在新分頁開啟版面配置示意圖">配置預覽示意圖</a>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mt-2">
                                    <div>
                                        <label for="handout-layout" class="block text-sm font-medium">版面配置 (每頁)</label>
                                        <select id="handout-layout" class="mt-1 block w-full">
                                            <option value="2" selected>2 張投影片</option>
                                            <option value="4">4 張投影片</option>
                                            <option value="6">6 張投影片</option>
                                            <option value="8">8 張投影片</option>
                                            <option value="10">10 張投影片</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="handout-orientation" class="block text-sm font-medium">A4 方向</label>
                                        <select id="handout-orientation" class="mt-1 block w-full">
                                            <option value="portrait">直向</option>
                                            <option value="landscape">橫向</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="handout-spacing" class="block text-sm font-medium">縮圖間距 (mm)</label>
                                        <input type="number" id="handout-spacing" value="10" class="mt-1 block w-full">
                                    </div>
                                    <div>
                                        <label for="handout-margins" class="block text-sm font-medium">頁面邊界 (mm)</label>
                                        <input type="number" id="handout-margins" value="10" class="mt-1 block w-full">
                                    </div>
                                    <div>
                                        <label for="handout-page-range" class="block text-sm font-medium">來源頁面範圍 (可留白)</label>
                                        <input type="text" id="handout-page-range" placeholder="例如: 1-5, 8, 10-12" class="mt-1 block w-full">
                                    </div>
                                </div>
                                
                                <hr class="section-divider">
    
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                                    <div>
                                        <label class="flex items-center text-base font-semibold text-gray-700">
                                            <input type="checkbox" id="handout-add-page-numbers" class="mr-2 h-5 w-5 rounded">
                                            <span>在縮圖下方加上原始頁碼</span>
                                        </label>
                                        <div id="handout-original-page-number-options" class="hidden flex flex-col gap-4 mt-2 mb-2">
                                            <div>
                                                <label for="handout-original-page-number-position" class="block text-sm font-medium">頁碼位置</label>
                                                <select id="handout-original-page-number-position" class="mt-1 block w-full">
                                                    <option value="bottom-center">下方置中</option>
                                                    <option value="bottom-right">下方靠右</option>
                                                    <option value="bottom-left">下方靠左</option>
                                                    <option value="top-center">上方置中</option>
                                                    <option value="top-right">上方靠右</option>
                                                    <option value="top-left">上方靠左</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="handout-original-page-number-size" class="block text-sm font-medium">字體大小</label>
                                                <input type="number" id="handout-original-page-number-size" value="8" min="4" class="mt-1 block w-full">
                                            </div>
                                            <div>
                                                <label for="handout-original-page-number-color" class="block text-sm font-medium">字體顏色</label>
                                                <input type="color" id="handout-original-page-number-color" value="#666666" class="mt-1 block w-full p-1 h-10">
                                            </div>
                                            <div class="flex items-end">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="handout-original-page-number-bold" class="mr-2 h-5 w-5 rounded">
                                                    <span>粗體 (Bold)</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="flex items-center text-base font-semibold text-gray-700">
                                            <input type="checkbox" id="handout-add-borders" class="mr-2 h-5 w-5 rounded">
                                            <span>為每張投影片加上邊框</span>
                                        </label>
                                         <div id="handout-border-options" class="hidden flex flex-col gap-4 mt-2 mb-2">
                                            <div>
                                                <label for="handout-border-color" class="block text-sm font-medium">邊框顏色</label>
                                                <input type="color" id="handout-border-color" value="#808080" class="mt-1 block w-full p-1 h-10">
                                            </div>
                                            <div>
                                                <label for="handout-border-width" class="block text-sm font-medium">邊框寬度 (pt)</label>
                                                <input type="number" id="handout-border-width" value="0.5" step="0.5" min="0.5" class="mt-1 block w-full">
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="flex items-center text-base font-semibold text-gray-700">
                                            <input type="checkbox" id="handout-enable-page-numbers" class="mr-2 h-5 w-5 rounded">
                                            <span>為製作出的講義加上新頁碼</span>
                                        </label>
                                        <div id="handout-page-numbers-container" class="hidden flex flex-col gap-4 mt-2">
                                           <div>
                                                <label for="handout-page-number-position" class="block text-sm font-medium">新頁碼位置</label>
                                                <select id="handout-page-number-position" class="mt-1 block w-full">
                                                    <option value="bottom-center">頁尾置中</option>
                                                    <option value="bottom-right">頁尾靠右</option>
                                                    <option value="bottom-left">頁尾靠左</option>
                                                    <option value="top-center">頁首置中</option>
                                                    <option value="top-right">頁首靠右</option>
                                                    <option value="top-left">頁首靠左</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="handout-page-number-size" class="block text-sm font-medium">字體大小</label>
                                                <input type="number" id="handout-page-number-size" value="12" class="mt-1 block w-full">
                                            </div>
                                            <div>
                                                <label for="handout-page-number-color" class="block text-sm font-medium">字體顏色</label>
                                                <input type="color" id="handout-page-number-color" value="#000000" class="mt-1 block w-full p-1 h-10">
                                            </div>
                                            <div>
                                                <label for="handout-page-number-format" class="block text-sm font-medium">頁碼格式</label>
                                                <input type="text" id="handout-page-number-format" value="{page} / {total}" class="mt-1 block w-full">
                                            </div>
                                            <div>
                                                <label for="handout-page-number-range" class="block text-sm font-medium">套用頁碼範圍 (可留白)</label>
                                                <input type="text" id="handout-page-number-range" placeholder="例如: 2-10, 15" class="mt-1 block w-full">
                                            </div>
                                             <div class="flex items-end">
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="handout-page-number-bold" class="mr-2 h-5 w-5 rounded">
                                                    <span>粗體 (Bold)</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="section-divider">
    
                                <div class="col-span-full">
                                    <label class="flex items-center text-base font-semibold text-gray-700">
                                        <input type="checkbox" id="handout-add-custom-text" class="mr-2 h-5 w-5 rounded">
                                        <span>加上自訂文字</span>
                                    </label>
                                </div>
                                <div id="handout-custom-text-options" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mt-2">
                                    <div class="md:col-span-4">
                                        <label for="handout-custom-text-input" class="block text-sm font-medium">文字內容</label>
                                        <input type="text" id="handout-custom-text-input" placeholder="請在此輸入文字" class="mt-1 block w-full">
                                    </div>
                                    <div>
                                        <label for="handout-custom-text-position" class="block text-sm font-medium">文字位置</label>
                                        <select id="handout-custom-text-position" class="mt-1 block w-full">
                                            <option value="top-left">頁首靠左</option>
                                            <option value="top-center">頁首置中</option>
                                            <option value="top-right">頁首靠右</option>
                                            <option value="bottom-left">頁尾靠左</option>
                                            <option value="bottom-center">頁尾置中</option>
                                            <option value="bottom-right">頁尾靠右</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="handout-custom-text-margin" class="block text-sm font-medium">與頁面邊界的距離 (mm)</label>
                                        <input type="number" id="handout-custom-text-margin" value="5" class="mt-1 block w-full">
                                    </div>
                                    <div>
                                        <label for="handout-custom-text-size" class="block text-sm font-medium">字體大小</label>
                                        <input type="number" id="handout-custom-text-size" value="12" class="mt-1 block w-full">
                                    </div>
                                    <div>
                                        <label for="handout-custom-text-color" class="block text-sm font-medium">字體顏色</label>
                                        <input type="color" id="handout-custom-text-color" value="#000000" class="mt-1 block w-full p-1 h-10">
                                    </div>
                                     <div class="flex items-end col-start-1">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="handout-custom-text-first-page-only" class="mr-2 h-5 w-5 rounded">
                                            <span>只顯示在首頁</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
    
                            <div class="mt-6">
                                <button id="handout-pdf-btn" disabled data-tooltip="根據設定開始製作講義">開始製作</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="p-6 md:p-8 rounded-lg shadow-xl text-center max-w-sm w-full mx-4 sm:mx-0">
                <div id="modal-content"></div>
            </div>
        </div>
        
        <!-- Modal for inserting PDF pages -->
        <div id="insert-pdf-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="p-6 md:p-8 rounded-lg shadow-xl max-w-md w-full mx-4 sm:mx-0">
                <h3 class="text-xl font-bold mb-4">插入 PDF 檔案</h3>
                <div class="space-y-4 text-left">
                    <div>
                        <label for="insert-pdf-file-input" class="block text-sm font-medium mb-1">選擇要插入的 PDF</label>
                        <input type="file" id="insert-pdf-file-input" accept=".pdf" class="block w-full text-sm"/>
                    </div>
                    <div>
                        <label for="insert-page-number" class="block text-sm font-medium mb-1">插入到第幾頁之後 (輸入 0 則插入到最前方)</label>
                        <input type="number" id="insert-page-number" value="0" min="0" class="block w-full">
                    </div>
                    <div id="insert-modal-error" class="text-red-600 text-sm hidden"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-insert-btn" data-tooltip="關閉此對話框">取消</button>
                    <button id="confirm-insert-btn" data-tooltip="確認並插入所選檔案">確認插入</button>
                </div>
            </div>
        </div>
        
        <!-- START: New Modal for adding a blank page -->
        <div id="add-blank-page-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="p-6 md:p-8 rounded-lg shadow-xl max-w-md w-full mx-4 sm:mx-0">
                <h3 class="text-xl font-bold mb-4">新增空白頁</h3>
                <div class="space-y-4 text-left">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label for="blank-page-size" class="block text-sm font-medium mb-1">頁面大小</label>
                             <select id="blank-page-size" class="block w-full">
                                 <option value="A4" selected>A4</option>
                                 <option value="Letter">Letter</option>
                             </select>
                        </div>
                        <div>
                             <label for="blank-page-orientation" class="block text-sm font-medium mb-1">頁面方向</label>
                             <select id="blank-page-orientation" class="block w-full">
                                 <option value="portrait" selected>直向</option>
                                 <option value="landscape">橫向</option>
                             </select>
                        </div>
                    </div>
                    <div>
                        <label for="add-blank-page-number" class="block text-sm font-medium mb-1">插入到第幾頁之後 (輸入 0 則插入到最前方)</label>
                        <input type="number" id="add-blank-page-number" value="0" min="0" class="block w-full">
                    </div>
                    <div id="add-blank-page-modal-error" class="text-red-600 text-sm hidden"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-add-blank-page-btn" data-tooltip="關閉此對話框">取消</button>
                    <button id="confirm-add-blank-page-btn" data-tooltip="確認並新增空白頁">確認新增</button>
                </div>
            </div>
        </div>
        <!-- END: New Modal for adding a blank page -->
    
        <!-- External Libraries -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
        <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
        <script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <!-- ** INDUSTRY-STANDARD DRAG & DROP LIBRARY ** -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    
        <!-- App Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    
        // --- START OF THEME SWITCHER LOGIC ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const htmlEl = document.documentElement;

        const setTheme = (theme) => {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                htmlEl.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', theme);
        };

        themeSwitcher.addEventListener('click', () => {
            const currentTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
            setTheme(currentTheme);
        });

        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            setTheme(savedTheme);
        } else if (prefersDark) {
            setTheme('dark');
        } else {
            setTheme('light');
        }
        // --- END OF THEME SWITCHER LOGIC ---

        const loaderOverlay = document.getElementById('loader-overlay');
        const appContainer = document.getElementById('app-container');
        
        loaderOverlay.style.opacity = '0';
        setTimeout(() => {
            loaderOverlay.style.display = 'none';
        }, 300); 
    
        appContainer.style.visibility = 'visible';
        appContainer.style.opacity = '1';
    
        const requiredLibs = ['PDFLib', 'JSZip', 'pdfjsLib', 'Tesseract', 'fontkit', 'mammoth', 'XLSX', 'Sortable'];
        const missingLibs = requiredLibs.filter(lib => typeof window[lib] === 'undefined');
    
        if (missingLibs.length > 0) {
            const errorMsg = `錯誤：必要的程式庫載入失敗 (${missingLibs.join(', ')}). 請檢查您的網路連線，或瀏覽器是否阻擋了腳本載入，然後重新整理頁面。`;
            console.error(errorMsg);
            document.getElementById('app-container').innerHTML = `<div class="text-center p-8"><h1 class="text-2xl font-bold text-red-600">載入失敗</h1><p class="mt-4 text-gray-700">${errorMsg}</p></div>`;
            return; 
        }
        
        const { PDFDocument, rgb, StandardFonts, PageSizes } = PDFLib;
        const views = document.querySelectorAll('.view');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
    
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
        
        let customFontBytes = null;
        let pageEditorSortable = null;
        let handoutSortable = null;
        let modalTimeoutId = null;
        let currentPageThumbnailSize = 150;
        let handoutThumbnailSize = 80;
        let rotateThumbnailSize = 80; // New state for rotate view
        const ZOOM_STEP = 25;
        const MIN_ZOOM = 50;
        const MAX_ZOOM = 300;
    
    
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16) / 255,
                g: parseInt(result[2], 16) / 255,
                b: parseInt(result[3], 16) / 255,
            } : { r: 0, g: 0, b: 0 };
        }
    
        function setupMainMenuNavigation() {
            document.querySelectorAll('.feature-card').forEach(card => {
                card.onclick = function() {
                    const viewId = this.getAttribute('data-view');
                    if (viewId) {
                        showView(viewId);
                    }
                };
            });
        }
        
        setupMainMenuNavigation();
    
        // START: 新增的操作說明按鈕事件
        document.getElementById('show-help-btn').addEventListener('click', (e) => {
            e.preventDefault();
            showView('help-view');
            window.scrollTo(0, 0);
        });
        // END: 新增的操作說明按鈕事件

        function showView(viewId) {
            if (pageEditorSortable) { pageEditorSortable.destroy(); pageEditorSortable = null; }
            if (handoutSortable) { handoutSortable.destroy(); handoutSortable = null; }
    
            views.forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.add('active');
            
            document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');
            
            const uiElements = {
                'merge-pdf-list': el => el.innerHTML = '',
                'split-pdf-info': el => el.innerHTML = '請選擇檔案',
                'split-options': el => el.classList.add('hidden'),
                'pdf-to-image-info': el => el.textContent = '請選擇檔案',
                'pdf-to-image-options': el => el.classList.add('hidden'),
                'image-preview': el => el.classList.add('hidden'),
                'image-options': el => el.classList.add('hidden'),
                'images-list': el => el.innerHTML = '',
                'ocr-status': el => el.innerHTML = '請選擇一個 PDF 檔案開始處理...',
                'ocr-result': el => el.textContent = '尚未處理檔案。',
                'download-ocr-btn': el => {
                    el.classList.add('hidden');
                    el.onclick = null;
                },
                'compress-pdf-info': el => el.textContent = '請選擇檔案',
                'compress-options': el => el.classList.add('hidden'),
                'rotate-pdf-info': el => el.textContent = '請選擇檔案',
                'rotate-options': el => el.classList.add('hidden'),
                'rotate-pdf-pages-container': el => el.classList.add('hidden'), // New
                'rotate-pdf-pages-preview': el => el.innerHTML = '', // New
                'add-page-numbers-info': el => el.textContent = '請選擇檔案',
                'add-page-numbers-options': el => el.classList.add('hidden'),
                'edit-pdf-info': el => el.textContent = '請選擇檔案',
                'edit-pdf-pages': el => el.innerHTML = '',
                'insert-pdf-btn': el => el.classList.add('hidden'),
                'add-blank-page-btn': el => el.classList.add('hidden'),
                'delete-selected-pages-btn': el => el.classList.add('hidden'),
                'zoom-in-btn': el => el.classList.add('hidden'),
                'zoom-out-btn': el => el.classList.add('hidden'),
                'extract-images-info': el => el.textContent = '請選擇檔案',
                'pdf-to-web-info': el => el.textContent = '請選擇檔案',
                'pdf-to-web-options': el => el.classList.add('hidden'),
                'handout-pdf-info': el => el.textContent = '請選擇檔案',
                'handout-source-pages-container': el => el.classList.add('hidden'),
                'handout-options': el => el.classList.add('hidden'),
                'handout-add-custom-text': el => el.checked = false,
                'handout-custom-text-input': el => el.value = '',
                'handout-custom-text-options': el => el.classList.add('hidden'),
            };
    
            Object.keys(uiElements).forEach(id => {
                const element = document.getElementById(id);
                if (element) uiElements[id](element);
            });
    
            const actionButtons = [
                'merge-pdf-btn', 'split-pdf-btn', 'pdf-to-image-btn', 
                'image-to-pdf-btn', 'images-to-pdf-btn', 'compress-pdf-btn', 
                'rotate-pdf-btn', 'add-page-numbers-btn', 
                'edit-pdf-btn', 'extract-images-btn', 'pdf-to-web-btn',
                'word-to-pdf-btn', 'excel-to-pdf-btn', 'handout-pdf-btn'
            ];
            actionButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if(btn) btn.disabled = true;
            });
        }
    
        function showModal(content) { modalContent.innerHTML = content; modal.classList.remove('hidden'); }
        window.hideModal = function() { 
            if (modalTimeoutId) {
                clearTimeout(modalTimeoutId);
                modalTimeoutId = null;
            }
            modal.classList.add('hidden'); 
        }
        
        document.querySelectorAll('[id^="back-to-home-"]').forEach(button => {
            button.addEventListener('click', () => showView('home-view'));
        });
        
        function downloadFile(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
        
        function showDownloadModal(title, message, btnText, blob, filename) {
            const modalHTML = `
                <div class="flex flex-col items-center">
                    <svg class="w-16 h-16 text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-sm text-gray-600 text-left">${message}</p>
                    <div class="mt-6 w-full">
                        <button id="modal-download-btn" class="text-white font-bold py-2 px-4 rounded-lg w-full">${btnText}</button>
                        <button onclick="hideModal()" class="mt-2 font-bold py-2 px-4 rounded-lg w-full">關閉</button>
                    </div>
                </div>`;
            
            showModal(modalHTML);
            
            if (modalTimeoutId) clearTimeout(modalTimeoutId);
    
            const downloadBtn = document.getElementById('modal-download-btn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    downloadFile(blob, filename);
                    modalTimeoutId = setTimeout(hideModal, 1000); 
                };
                downloadBtn.style.backgroundColor = 'var(--macos-blue)';
                downloadBtn.style.color = 'white';
            }
        }
    
        function readFileAsArrayBuffer(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsArrayBuffer(file); }); }
        function readFileAsDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }
    
        function convertImageToPngArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob(blob => {
                            const blobReader = new FileReader();
                            blobReader.onloadend = () => { resolve(blobReader.result); };
                            blobReader.onerror = reject;
                            blobReader.readAsArrayBuffer(blob);
                        }, 'image/png');
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function setupPageEditorWithSortable(container) {
            if (pageEditorSortable) {
                pageEditorSortable.destroy();
            }
            pageEditorSortable = new Sortable(container, {
                animation: 150, 
                ghostClass: 'drag-placeholder',
                dragClass: 'dragging', 
                onEnd: function () {
                    renumberPageItems(container);
                },
            });
        }
        
        window.removeFile = function(element, inputId) {
            const itemToRemove = element.closest('.draggable, .file-list-item');
            if (itemToRemove) itemToRemove.remove();
            const listContainerId = inputId.replace(/-files?$/, '-list');
            const listContainer = document.getElementById(listContainerId);
            const btnId = inputId.replace(/-files?$/, '-btn');
            const btn = document.getElementById(btnId);
            if (btn) {
                const remainingItems = listContainer ? listContainer.children.length : 0;
                if (inputId === 'merge-pdf-files') {
                    btn.disabled = remainingItems < 2;
                } else {
                    btn.disabled = remainingItems < 1;
                }
            }
        }
        
        function renumberPageItems(container) {
            const items = container.querySelectorAll('.page-item');
            items.forEach((item, index) => {
                const pageNumberEl = item.querySelector('.page-number-text');
                if (pageNumberEl) {
                    pageNumberEl.textContent = index + 1;
                }
            });
        }
    
        function handlePageNumberClick(event) {
            const span = event.currentTarget;
            const container = span.parentElement;
            const currentItem = span.closest('.page-item');
            const pageList = currentItem.parentElement;
            const originalPageNum = span.textContent;
    
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'page-number-input w-12 text-center bg-gray-800 text-white rounded';
            input.value = originalPageNum;
            input.min = 1;
            input.max = pageList.querySelectorAll('.page-item').length;
    
            container.innerHTML = '';
            container.appendChild(input);
            input.focus();
            input.select();
    
            const finishEditing = () => {
                container.innerHTML = '';
                container.appendChild(span);
            };
    
            input.addEventListener('blur', finishEditing);
    
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newPageNum = parseInt(input.value, 10);
                    const allItems = [...pageList.querySelectorAll('.page-item')];
                    const totalPages = allItems.length;
    
                    if (!isNaN(newPageNum) && newPageNum >= 1 && newPageNum <= totalPages) {
                        const targetItem = allItems[newPageNum - 1];
                        pageList.removeChild(currentItem);
                        if (newPageNum > originalPageNum) {
                            pageList.insertBefore(currentItem, targetItem.nextSibling);
                        } else {
                            pageList.insertBefore(currentItem, targetItem);
                        }
                        renumberPageItems(pageList);
                    }
                    finishEditing();
                } else if (e.key === 'Escape') {
                    finishEditing();
                }
            });
        }
    
        // --- PDF Modules ---
    
        const mergePdfInput = document.getElementById('merge-pdf-files');
        if (mergePdfInput) {
            const mergePdfList = document.getElementById('merge-pdf-list');
            const mergePdfBtn = document.getElementById('merge-pdf-btn');
            mergePdfInput.addEventListener('change', () => {
                mergePdfList.innerHTML = '';
                Array.from(mergePdfInput.files).forEach(file => {
                    const listItem = document.createElement('div');
                    listItem.className = 'file-list-item draggable p-3 mb-2 flex items-center justify-between cursor-move';
                    listItem.dataset.name = file.name;
                    listItem.innerHTML = `<span class="truncate">${file.name}</span><span class="close-btn font-bold" onclick="removeFile(this, 'merge-pdf-files')" data-tooltip="移除此檔案">✖</span>`;
                    mergePdfList.appendChild(listItem);
                });
                mergePdfBtn.disabled = mergePdfInput.files.length < 2;
            });
            mergePdfBtn.addEventListener('click', async () => {
                showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在合併 PDF...</p>`);
                try {
                    const mergedPdf = await PDFDocument.create();
                    const fileItems = [...mergePdfList.querySelectorAll('.file-list-item')];
                    for (const item of fileItems) {
                        const fileName = item.dataset.name;
                        const file = Array.from(mergePdfInput.files).find(f => f.name === fileName);
                        const pdfBytes = await readFileAsArrayBuffer(file);
                        const pdf = await PDFDocument.load(pdfBytes);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    showDownloadModal('合併成功！', '檔案已準備就緒。', '下載 PDF', blob, 'merged.pdf');
                } catch (error) {
                    console.error("合併失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">合併失敗</h3><p>處理時發生錯誤。</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                }
            });
            new Sortable(mergePdfList, { animation: 150 });
        }
        
        const splitPdfInput = document.getElementById('split-pdf-file');
        if(splitPdfInput) {
            const splitPdfBtn = document.getElementById('split-pdf-btn');
            splitPdfInput.addEventListener('change', async () => {
                if (!splitPdfInput.files.length) return;
                const file = splitPdfInput.files[0];
                document.getElementById('split-pdf-info').textContent = `已選擇：${file.name}`;
                document.getElementById('split-options').classList.add('hidden');
                splitPdfBtn.disabled = true;
                try {
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    const pdf = await PDFDocument.load(pdfBytes);
                    document.getElementById('split-pdf-info').textContent = `已選擇：${file.name} (共 ${pdf.getPageCount()} 頁)`;
                    document.getElementById('split-options').classList.remove('hidden');
                    splitPdfBtn.disabled = false;
                } catch (e) {
                    document.getElementById('split-pdf-info').textContent = '無法讀取此 PDF 檔案。';
                }
            });
            splitPdfBtn.addEventListener('click', async () => {
                 const mode = document.querySelector('input[name="split-mode"]:checked').value;
                 const file = splitPdfInput.files[0];
                 showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在分割 PDF...</p>`);
                 try {
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    const pdf = await PDFDocument.load(pdfBytes);
                    const totalPages = pdf.getPageCount();
                    if (mode === 'all') {
                        const zip = new JSZip();
                        for (let i = 0; i < totalPages; i++) {
                            const newPdf = await PDFDocument.create();
                            const [copiedPage] = await newPdf.copyPages(pdf, [i]);
                            newPdf.addPage(copiedPage);
                            zip.file(`page_${i + 1}.pdf`, await newPdf.save());
                        }
                        const blob = await zip.generateAsync({ type: "blob" });
                        showDownloadModal('分割成功！', `已將 PDF 分割為 ${totalPages} 個檔案。`, '下載 ZIP', blob, 'split_pages.zip');
                    } else if (mode === 'range') {
                        const rangeText = document.getElementById('split-page-range').value;
                        const pagesToExtract = new Set();
                        rangeText.split(',').forEach(part => {
                            if (part.includes('-')) {
                                const [start, end] = part.split('-').map(Number);
                                for (let i = start; i <= end; i++) pagesToExtract.add(i - 1);
                            } else {
                                pagesToExtract.add(Number(part.trim()) - 1);
                            }
                        });
                        const uniquePages = [...pagesToExtract].filter(p => !isNaN(p) && p >= 0 && p < totalPages).sort((a,b)=>a-b);
                        if (uniquePages.length === 0) throw new Error("無效或空的頁碼範圍。");
                        const newPdf = await PDFDocument.create();
                        const copiedPages = await newPdf.copyPages(pdf, uniquePages);
                        copiedPages.forEach(page => newPdf.addPage(page));
                        const blob = new Blob([await newPdf.save()], { type: 'application/pdf' });
                        showDownloadModal('提取成功！', `已成功提取 ${uniquePages.length} 頁。`, '下載 PDF', blob, 'extracted_pages.pdf');
                    }
                 } catch (error) {
                    console.error("分割失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">分割失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                 }
            });
            document.querySelectorAll('input[name="split-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => { 
                    document.getElementById('split-range-input').classList.toggle('hidden', e.target.value !== 'range');
                });
            });
        }
    
        const pdfToImageInput = document.getElementById('pdf-to-image-file');
        if (pdfToImageInput) {
            const pdfToImageBtn = document.getElementById('pdf-to-image-btn');
            pdfToImageInput.addEventListener('change', async () => {
                if (!pdfToImageInput.files.length) return;
                const file = pdfToImageInput.files[0];
                document.getElementById('pdf-to-image-info').textContent = `已選擇：${file.name}`;
                document.getElementById('pdf-to-image-options').classList.add('hidden');
                pdfToImageBtn.disabled = true;
                try {
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    document.getElementById('pdf-to-image-info').textContent = `已選擇：${file.name} (共 ${pdf.numPages} 頁)`;
                    document.getElementById('pdf-to-image-options').classList.remove('hidden');
                    pdfToImageBtn.disabled = false;
                } catch (e) {
                    document.getElementById('pdf-to-image-info').textContent = '無法讀取此 PDF 檔案。';
                }
            });
            pdfToImageBtn.addEventListener('click', async () => {
                const file = pdfToImageInput.files[0];
                if (!file) return;
                showModal(`<div class="loader mx-auto"></div><p id="modal-progress" class="mt-4">準備轉換...</p>`);
                try {
                    const resolution = document.getElementById('image-resolution').value;
                    const format = document.getElementById('image-format').value;
                    const ext = format === 'image/jpeg' ? 'jpg' : 'png';
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const zip = new JSZip();
                    for (let i = 1; i <= pdf.numPages; i++) {
                        document.getElementById('modal-progress').textContent = `正在轉換第 ${i} / ${pdf.numPages} 頁...`;
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: resolution / 72 });
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        const blob = await new Promise(res => canvas.toBlob(res, format, 0.9));
                        zip.file(`page_${i}.${ext}`, blob);
                    }
                    const blob = await zip.generateAsync({ type: "blob" });
                    showDownloadModal('轉換成功！', `已將 ${pdf.numPages} 頁轉換為圖片。`, '下載 ZIP', blob, 'converted_images.zip');
                } catch (error) {
                    console.error("PDF轉圖片失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">轉換失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                }
            });
        }
    
        const imageInput = document.getElementById('image-file');
        if (imageInput) {
            const imageToPdfBtn = document.getElementById('image-to-pdf-btn');
            imageInput.addEventListener('change', async () => {
                if (!imageInput.files.length) return;
                document.getElementById('image-preview').src = await readFileAsDataURL(imageInput.files[0]);
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('image-options').classList.remove('hidden');
                imageToPdfBtn.disabled = false;
            });
            imageToPdfBtn.addEventListener('click', async () => {
                showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在轉換...</p>`);
                try {
                    const pdfDoc = await PDFDocument.create();
                    const imageBytes = await convertImageToPngArrayBuffer(imageInput.files[0]);
                    const image = await pdfDoc.embedPng(imageBytes);
                    let pageSize = PageSizes[document.getElementById('image-page-size').value];
                    if (document.getElementById('image-orientation').value === 'landscape') pageSize = [pageSize[1], pageSize[0]];
                    const page = pdfDoc.addPage(pageSize);
                    const { width, height } = image.scaleToFit(page.getWidth(), page.getHeight());
                    page.drawImage(image, { x: (page.getWidth() - width) / 2, y: (page.getHeight() - height) / 2, width, height });
                    const blob = new Blob([await pdfDoc.save()], { type: 'application/pdf' });
                    showDownloadModal('轉換成功！', '圖片已成功轉換為 PDF。', '下載 PDF', blob, 'image.pdf');
                } catch (error) {
                    console.error("圖片轉PDF失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">轉換失敗</h3><p>處理時發生錯誤。</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                }
            });
        }
    
        const imagesInput = document.getElementById('images-files');
        if (imagesInput) {
            const imagesToPdfBtn = document.getElementById('images-to-pdf-btn');
            const imagesList = document.getElementById('images-list');
            imagesInput.addEventListener('change', async () => {
                imagesList.innerHTML = '';
                for (const file of Array.from(imagesInput.files)) {
                    const listItem = document.createElement('div');
                    listItem.className = 'draggable relative p-2 border rounded-md group';
                    listItem.dataset.name = file.name;
                    listItem.innerHTML = `<img src="${await readFileAsDataURL(file)}" class="w-full h-24 object-cover rounded-md"/><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-xs truncate px-1">${file.name}</span></div><span class="close-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold cursor-pointer" onclick="removeFile(this, 'images-files')" data-tooltip="移除此圖片">✖</span>`;
                    imagesList.appendChild(listItem);
                }
                imagesToPdfBtn.disabled = imagesInput.files.length === 0;
                if (imagesInput.files.length > 0) {
                     new Sortable(imagesList, { animation: 150 });
                }
            });
            imagesToPdfBtn.addEventListener('click', async () => {
                showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在合併轉換...</p>`);
                try {
                    const pdfDoc = await PDFDocument.create();
                    let pageSize = PageSizes[document.getElementById('images-page-size').value];
                    if (document.getElementById('images-orientation').value === 'landscape') pageSize = [pageSize[1], pageSize[0]];
                    const files = Array.from(imagesInput.files);
                    for (const item of [...imagesList.querySelectorAll('.draggable')]) {
                        const file = files.find(f => f.name === item.dataset.name);
                        if (!file) continue;
                        const imageBytes = await convertImageToPngArrayBuffer(file);
                        const image = await pdfDoc.embedPng(imageBytes);
                        const page = pdfDoc.addPage(pageSize);
                        const { width, height } = image.scaleToFit(page.getWidth(), page.getHeight());
                        page.drawImage(image, { x: (page.getWidth() - width) / 2, y: (page.getHeight() - height) / 2, width, height });
                    }
                    const blob = new Blob([await pdfDoc.save()], { type: 'application/pdf' });
                    showDownloadModal('轉換成功！', '圖片已成功合併為 PDF。', '下載 PDF', blob, 'images_merged.pdf');
                } catch (error) {
                    console.error("多圖轉PDF失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">轉換失敗</h3><p>處理時發生錯誤。</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                }
            });
        }
        
        const ocrPdfInput = document.getElementById('ocr-pdf-input');
        if (ocrPdfInput) {
            ocrPdfInput.addEventListener('change', handleOcrFileSelect);
        }
    
        function convertToRtf(text) {
            let rtf = '{\\rtf1\\ansi\\ansicpg1252\\deff0{\\fonttbl{\\f0\\fnil Microsoft JhengHei;}}\n';
            rtf += '\\pard\\uc1\\f0\\fs24\n';
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const charCode = text.charCodeAt(i);
                if (char === '\\' || char === '{' || char === '}') {
                    rtf += '\\' + char;
                } else if (char === '\n') {
                    rtf += '\\par\n';
                } else if (charCode < 128) {
                    rtf += char;
                } else {
                    let unicodeValue = charCode;
                    if (unicodeValue > 32767) {
                        unicodeValue -= 65536;
                    }
                    rtf += `\\u${unicodeValue}?`;
                }
            }
            rtf += '}';
            return rtf;
        }
    
        async function handleOcrFileSelect(event) {
            const file = event.target.files[0];
            const ocrStatusDiv = document.getElementById('ocr-status');
            const downloadOcrBtn = document.getElementById('download-ocr-btn');
            const ocrResultDiv = document.getElementById('ocr-result');
            if (!file || file.type !== 'application/pdf') {
                ocrStatusDiv.textContent = '錯誤：請選擇一個 PDF 檔案！';
                downloadOcrBtn.classList.add('hidden');
                return;
            }
            ocrStatusDiv.innerHTML = '正在讀取檔案...';
            downloadOcrBtn.classList.add('hidden');
            downloadOcrBtn.onclick = null;
            ocrResultDiv.textContent = '';
            try {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        await processOcrPdf(new Uint8Array(this.result));
                    } catch (procError) {
                        console.error('OCR 處理程序失敗:', procError);
                        ocrStatusDiv.innerHTML = `<span class="text-red-600">處理失敗：${procError.message}</span>`;
                        downloadOcrBtn.classList.add('hidden');
                    }
                };
                fileReader.readAsArrayBuffer(file);
            } catch (error) { ocrStatusDiv.textContent = `檔案讀取錯誤：${error.message}`; }
        }
        
        async function processOcrPdf(pdfData) {
            const ocrStatusDiv = document.getElementById('ocr-status');
            const ocrResultDiv = document.getElementById('ocr-result');
            const downloadOcrBtn = document.getElementById('download-ocr-btn');
            let fullText = '';
            let worker; 
            try {
                ocrStatusDiv.innerHTML = '正在初始化 OCR 引擎...<div class="loader inline-block ml-2 w-5 h-5"></div>';
                worker = await Tesseract.createWorker('chi_tra+eng');
                ocrStatusDiv.innerHTML = '正在載入 PDF...<div class="loader inline-block ml-2 w-5 h-5"></div>';
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    ocrStatusDiv.innerHTML = `正在處理第 ${i} / ${pdf.numPages} 頁...<div class="loader inline-block ml-2 w-5 h-5"></div>`;
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    if (pageText.trim().length > 50) {
                        fullText += pageText;
                    } else { 
                        const viewport = page.getViewport({ scale: 2.0 });
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        const { data: { text } } = await worker.recognize(canvas, {}, {
                            logger: m => {
                               if (m.status === 'recognizing text') {
                                    ocrStatusDiv.innerHTML = `第 ${i} / ${pdf.numPages} 頁：OCR 辨識中... ${Math.round(m.progress * 100)}%<div class="loader inline-block ml-2 w-5 h-5"></div>`;
                               }
                            }
                        });
                        fullText += text;
                    }
                    fullText += `\n\n--- 第 ${i} 頁結束 ---\n\n`;
                    ocrResultDiv.textContent = fullText;
                }
                ocrStatusDiv.textContent = `處理完成！共辨識 ${pdf.numPages} 頁。`;
                
                downloadOcrBtn.onclick = () => {
                    const textToDownload = ocrResultDiv.textContent;
                    if (!textToDownload || textToDownload === '尚未處理檔案。') {
                        showModal('<h3 class="text-xl font-bold text-yellow-600">沒有內容可下載</h3><p>請先處理檔案產生文字。</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>');
                        return;
                    }
                    const rtfContent = convertToRtf(textToDownload);
                    const blob = new Blob([rtfContent], { type: 'application/rtf' });
                    downloadFile(blob, '辨識結果.rtf');
                };
                downloadOcrBtn.classList.remove('hidden');
    
            } finally {
                if (worker) await worker.terminate();
            }
        }
    
        const compressPdfInput = document.getElementById('compress-pdf-file');
        if (compressPdfInput) {
            const compressPdfBtn = document.getElementById('compress-pdf-btn');
            const compressRatioSlider = document.getElementById('compress-ratio');
            const compressRatioValue = document.getElementById('compress-ratio-value');
            compressRatioSlider.addEventListener('input', (e) => {
                compressRatioValue.textContent = `${e.target.value}%`;
            });
    
            compressPdfInput.addEventListener('change', () => {
                if (!compressPdfInput.files.length) {
                    document.getElementById('compress-pdf-info').textContent = '請選擇檔案';
                    compressPdfBtn.disabled = true;
                    document.getElementById('compress-options').classList.add('hidden');
                    return;
                }
                const file = compressPdfInput.files[0];
                const originalSize = (file.size / 1024 / 1024).toFixed(2);
                document.getElementById('compress-pdf-info').textContent = `已選擇：${file.name} (大小: ${originalSize} MB)`;
                compressPdfBtn.disabled = false;
                document.getElementById('compress-options').classList.remove('hidden');
            });
    
            compressPdfBtn.addEventListener('click', async () => {
                const file = compressPdfInput.files[0];
                if (!file) return;
    
                const originalSize = file.size;
                showModal(`<div class="loader mx-auto"></div><p id="modal-progress" class="mt-4">準備壓縮...</p>`);
    
                try {
                    if (!customFontBytes) {
                        document.getElementById('modal-progress').textContent = `正在載入中文字體...`;
                        
                        const cssUrl = 'https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400&display=swap';
                        const cssResponse = await fetch(cssUrl, {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                            }
                        });
                        const cssText = await cssResponse.text();
                        
                        const fontUrlMatch = cssText.match(/src: url\((.+?)\) format\('woff2'\)/);
                        if (!fontUrlMatch || !fontUrlMatch[1]) {
                            throw new Error('無法從 Google Fonts API 解析字型 URL。');
                        }
                        const fontUrl = fontUrlMatch[1];
                        
                        customFontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
                    }
    
                    const quality = parseInt(document.getElementById('compress-ratio').value) / 100;
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    
                    const pdfjsDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    const newPdfDoc = await PDFDocument.create();
    
                    newPdfDoc.registerFontkit(fontkit);
    
                    const customFont = await newPdfDoc.embedFont(customFontBytes);
    
                    for (let i = 1; i <= pdfjsDoc.numPages; i++) {
                        document.getElementById('modal-progress').textContent = `正在處理第 ${i} / ${pdfjsDoc.numPages} 頁...`;
                        
                        const page = await pdfjsDoc.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
    
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        const context = canvas.getContext('2d');
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        
                        const jpgDataUrl = canvas.toDataURL('image/jpeg', quality);
                        const jpgBytes = await fetch(jpgDataUrl).then(res => res.arrayBuffer());
                        const jpgImage = await newPdfDoc.embedJpg(jpgBytes);
    
                        const { width, height } = page.getViewport({ scale: 1.0 });
                        const newPage = newPdfDoc.addPage([width, height]);
                        
                        newPage.drawImage(jpgImage, {
                            x: 0,
                            y: 0,
                            width: newPage.getWidth(),
                            height: newPage.getHeight(),
                        });
    
                        const textContent = await page.getTextContent();
                        textContent.items.forEach(item => {
                            const tx = item.transform;
                            const textHeight = tx[3]; 
                            
                            const defaultViewport = page.getViewport({ scale: 1.0 });
                            const y = defaultViewport.height - tx[5] - textHeight;
    
                            newPage.drawText(item.str, {
                                x: tx[4],
                                y: y,
                                font: customFont,
                                size: textHeight,
                                color: rgb(0, 0, 0),
                                opacity: 0,
                            });
                        });
                    }
                    
                    const compressedPdfBytes = await newPdfDoc.save();
                    const newSize = compressedPdfBytes.byteLength;
                    const reduction = originalSize > 0 ? ((originalSize - newSize) / originalSize) * 100 : 0;
                    
                    const blob = new Blob([compressedPdfBytes], { type: 'application/pdf' });
                    
                    const message = `
                        原始大小: ${(originalSize / 1024 / 1024).toFixed(2)} MB<br>
                        壓縮後大小: ${(newSize / 1024 / 1024).toFixed(2)} MB<br>
                        空間節省: ${reduction.toFixed(1)}%
                    `;
                    
                    showDownloadModal('壓縮成功！', message, '下載壓縮後的 PDF', blob, `compressed_${file.name}`);
                } catch (error) {
                    console.error("壓縮失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">壓縮失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                }
            });
        }
    
        const rotatePdfInput = document.getElementById('rotate-pdf-file');
        if (rotatePdfInput) {
            const rotatePdfBtn = document.getElementById('rotate-pdf-btn');
            const rotateZoomInBtn = document.getElementById('rotate-zoom-in-btn');
            const rotateZoomOutBtn = document.getElementById('rotate-zoom-out-btn');
            const rotateSourcePreviewDiv = document.getElementById('rotate-pdf-pages-preview');
    
            const applyRotateZoom = () => {
                rotateSourcePreviewDiv.style.gridTemplateColumns = `repeat(auto-fill, minmax(${rotateThumbnailSize}px, 1fr))`;
            };
            
            if (rotateZoomInBtn) {
                rotateZoomInBtn.addEventListener('click', () => {
                    rotateThumbnailSize = Math.min(MAX_ZOOM, rotateThumbnailSize + ZOOM_STEP);
                    applyRotateZoom();
                });
            }
            if (rotateZoomOutBtn) {
                rotateZoomOutBtn.addEventListener('click', () => {
                    rotateThumbnailSize = Math.max(MIN_ZOOM, rotateThumbnailSize - ZOOM_STEP);
                    applyRotateZoom();
                });
            }
    
            const renderRotateSourcePreview = async (file) => {
                const container = document.getElementById('rotate-pdf-pages-container');
                const infoDiv = document.getElementById('rotate-pdf-info');
                const previewDiv = document.getElementById('rotate-pdf-pages-preview');
    
                infoDiv.innerHTML = '<div class="loader inline-block mr-2"></div>正在載入縮圖預覽...';
                container.classList.remove('hidden');
                previewDiv.innerHTML = '';
    
                try {
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                    
                    const fragment = document.createDocumentFragment();
                    const renderPromises = [];
    
                    for(let i=1; i <= pdf.numPages; i++) {
                        const renderPromise = (async () => {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            
                            const scale = 240 / viewport.width;
                            const scaledViewport = page.getViewport({ scale });
                            canvas.height = scaledViewport.height;
                            canvas.width = scaledViewport.width;
    
                            await page.render({ canvasContext: context, viewport: scaledViewport }).promise;
    
                            const item = document.createElement('div');
                            item.className = 'source-page-item';
                            
                            const img = document.createElement('img');
                            img.src = canvas.toDataURL('image/jpeg', 0.8);
                            const pageNum = document.createElement('span');
                            pageNum.className = 'page-number';
                            pageNum.textContent = i;
                            
                            item.appendChild(img);
                            item.appendChild(pageNum);
                            return item;
                        })();
                        renderPromises.push(renderPromise);
                    }
    
                    const renderedItems = await Promise.all(renderPromises);
                    renderedItems.forEach(item => fragment.appendChild(item));
                    previewDiv.appendChild(fragment);
    
                    setTimeout(() => {
                        infoDiv.textContent = `已選擇：${file.name} (共 ${pdf.numPages} 頁)`;
                    }, 100);
    
                } catch (e) {
                    console.error("Failed to render rotate source preview:", e);
                    infoDiv.textContent = '無法讀取此 PDF 檔案。';
                    container.classList.add('hidden');
                }
            };
    
            rotatePdfInput.addEventListener('change', (e) => {
                if (!e.target.files.length) {
                    document.getElementById('rotate-pdf-info').textContent = '請選擇檔案';
                    document.getElementById('rotate-options').classList.add('hidden');
                    document.getElementById('rotate-pdf-pages-container').classList.add('hidden');
                    rotatePdfBtn.disabled = true;
                    return;
                }
                const file = e.target.files[0];
                document.getElementById('rotate-pdf-info').textContent = `已選擇：${file.name}`;
                document.getElementById('rotate-options').classList.remove('hidden');
                rotatePdfBtn.disabled = false;
                
                rotateThumbnailSize = 80;
                applyRotateZoom();
                renderRotateSourcePreview(file);
            });
    
            rotatePdfBtn.addEventListener('click', async () => {
                const file = rotatePdfInput.files[0];
                if (!file) return;
    
                showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在旋轉 PDF...</p>`);
                
                try {
                    const angle = parseInt(document.getElementById('rotate-angle').value, 10);
                    const rangeText = document.getElementById('rotate-page-range').value;
                    const { degrees } = PDFLib;
    
                    const pdfBytes = await readFileAsArrayBuffer(file);
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const totalPages = pdfDoc.getPageCount();
    
                    const pagesToRotate = new Set();
                    if (rangeText.trim() === '') {
                        for (let i = 0; i < totalPages; i++) pagesToRotate.add(i);
                    } else {
                         rangeText.split(',').forEach(part => {
                            part = part.trim();
                            if (part.includes('-')) {
                                const [start, end] = part.split('-').map(Number);
                                if (!isNaN(start) && !isNaN(end)) {
                                    for (let i = start; i <= end; i++) pagesToRotate.add(i - 1);
                                }
                            } else if (!isNaN(Number(part))) {
                                pagesToRotate.add(Number(part) - 1);
                            }
                        });
                    }
                    
                    const pages = pdfDoc.getPages();
                    let rotatedCount = 0;
                    pages.forEach((page, i) => {
                        if (pagesToRotate.has(i)) {
                            const currentRotation = page.getRotation().angle;
                            page.setRotation(degrees(currentRotation + angle));
                            rotatedCount++;
                        }
                    });
    
                    if (rotatedCount === 0 && rangeText.trim() !== '') {
                        throw new Error('您輸入的頁碼範圍無效或不存在，沒有頁面被旋轉。');
                    }
    
                    const rotatedPdfBytes = await pdfDoc.save();
                    const blob = new Blob([rotatedPdfBytes], { type: 'application/pdf' });
                    
                    const message = (rotatedCount === totalPages && rangeText.trim() === '')
                        ? '所有頁面已成功旋轉。'
                        : `已成功旋轉 ${rotatedCount} 個指定頁面。`;
                    
                    showDownloadModal('旋轉成功！', message, '下載旋轉後的 PDF', blob, `rotated_${file.name}`);
    
                } catch (error) {
                    console.error("旋轉失敗:", error);
                    showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">旋轉失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
                }
            });
        }
    
        const addPageNumbersInput = document.getElementById('add-page-numbers-file');
        if (addPageNumbersInput) {
            const addPageNumbersBtn = document.getElementById('add-page-numbers-btn');
            addPageNumbersInput.addEventListener('change', () => {
                if (!addPageNumbersInput.files.length) {
                    document.getElementById('add-page-numbers-info').textContent = '請選擇檔案';
                    document.getElementById('add-page-numbers-options').classList.add('hidden');
                    addPageNumbersBtn.disabled = true;
                    return;
                }
                const file = addPageNumbersInput.files[0];
                document.getElementById('add-page-numbers-info').textContent = `已選擇：${file.name}`;
                document.getElementById('add-page-numbers-options').classList.remove('hidden');
                addPageNumbersBtn.disabled = false;
            });
    
            addPageNumbersBtn.addEventListener('click', async () => {
                const file = addPageNumbersInput.files[0];
                if (!file) return;
    
                showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在加上頁碼...</p>`);

            try {
                const pdfBytes = await readFileAsArrayBuffer(file);
                const pdfDoc = await PDFDocument.load(pdfBytes);
                
                const isBold = document.getElementById('page-number-bold').checked;
                const font = await pdfDoc.embedFont(isBold ? StandardFonts.HelveticaBold : StandardFonts.Helvetica);

                const position = document.getElementById('page-number-position').value;
                const size = parseInt(document.getElementById('page-number-size').value, 10);
                const colorHex = document.getElementById('page-number-color').value;
                const color = hexToRgb(colorHex);
                const format = document.getElementById('page-number-format').value;
                const rangeText = document.getElementById('page-number-range').value;
                
                const totalPages = pdfDoc.getPageCount();
                
                const pagesToNumber = new Set();
                if (rangeText.trim() === '') {
                    for (let i = 0; i < totalPages; i++) pagesToNumber.add(i);
                } else {
                     rangeText.split(',').forEach(part => {
                        if (part.includes('-')) {
                            const [start, end] = part.split('-').map(Number);
                            for (let i = start; i <= end; i++) pagesToNumber.add(i - 1);
                        } else {
                            pagesToNumber.add(Number(part.trim()) - 1);
                        }
                    });
                }

                const pages = pdfDoc.getPages();
                pages.forEach((page, i) => {
                    if (!pagesToNumber.has(i)) return;
                    
                    const { width, height } = page.getSize();
                    const pageNumberText = format.replace('{page}', i + 1).replace('{total}', totalPages);

                    const textWidth = font.widthOfTextAtSize(pageNumberText, size);
                    let x, y;
                    const margin = 30;

                    if (position.includes('bottom')) y = margin;
                    else y = height - size - margin;

                    if (position.includes('center')) x = width / 2 - textWidth / 2;
                    else if (position.includes('right')) x = width - textWidth - margin;
                    else x = margin;

                    page.drawText(pageNumberText, { x, y, size, font, color: rgb(color.r, color.g, color.b) });
                });

                const newPdfBytes = await pdfDoc.save();
                const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                showDownloadModal('頁碼添加成功！', '已成功為您的 PDF 加上頁碼。', '下載 PDF', blob, `numbered_${file.name}`);

            } catch (error) {
                console.error("加頁碼失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">加頁碼失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }

    const editPdfInput = document.getElementById('edit-pdf-file');
    if (editPdfInput) {
        let pageSources = []; 

        const editPdfBtn = document.getElementById('edit-pdf-btn');
        const insertPdfBtn = document.getElementById('insert-pdf-btn');
        const addBlankPageBtn = document.getElementById('add-blank-page-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-pages-btn');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const editPdfPagesContainer = document.getElementById('edit-pdf-pages');
        
        const insertPdfModal = document.getElementById('insert-pdf-modal');
        const confirmInsertBtn = document.getElementById('confirm-insert-btn');
        const cancelInsertBtn = document.getElementById('cancel-insert-btn');
        const insertFileInput = document.getElementById('insert-pdf-file-input');
        const insertPageNumInput = document.getElementById('insert-page-number');

        const addBlankPageModal = document.getElementById('add-blank-page-modal');
        const confirmAddBlankPageBtn = document.getElementById('confirm-add-blank-page-btn');
        const cancelAddBlankPageBtn = document.getElementById('cancel-add-blank-page-btn');
        const addBlankPageNumInput = document.getElementById('add-blank-page-number');
        
        const showInsertModal = () => {
            const currentPageCount = editPdfPagesContainer.children.length;
            insertPageNumInput.max = currentPageCount;
            insertPageNumInput.value = currentPageCount;
            insertFileInput.value = '';
            document.getElementById('insert-modal-error').classList.add('hidden');
            insertPdfModal.classList.remove('hidden');
        };
        const hideInsertModal = () => insertPdfModal.classList.add('hidden');

        const showAddBlankPageModal = () => {
            const currentPageCount = editPdfPagesContainer.children.length;
            addBlankPageNumInput.max = currentPageCount;
            addBlankPageNumInput.value = currentPageCount;
            document.getElementById('add-blank-page-modal-error').classList.add('hidden');
            addBlankPageModal.classList.remove('hidden');
        };
        const hideAddBlankPageModal = () => addBlankPageModal.classList.add('hidden');

        insertPdfBtn.addEventListener('click', showInsertModal);
        cancelInsertBtn.addEventListener('click', hideInsertModal);
        insertPdfModal.addEventListener('click', (e) => { if (e.target === insertPdfModal) hideInsertModal(); });

        addBlankPageBtn.addEventListener('click', showAddBlankPageModal);
        cancelAddBlankPageBtn.addEventListener('click', hideAddBlankPageModal);
        addBlankPageModal.addEventListener('click', (e) => { if (e.target === addBlankPageModal) hideAddBlankPageModal(); });

        const applyZoom = () => {
            editPdfPagesContainer.style.gridTemplateColumns = `repeat(auto-fill, minmax(${currentPageThumbnailSize}px, 1fr))`;
        };

        zoomInBtn.addEventListener('click', () => {
            currentPageThumbnailSize = Math.min(MAX_ZOOM, currentPageThumbnailSize + ZOOM_STEP);
            applyZoom();
        });
        zoomOutBtn.addEventListener('click', () => {
            currentPageThumbnailSize = Math.max(MIN_ZOOM, currentPageThumbnailSize - ZOOM_STEP);
            applyZoom();
        });

        deleteSelectedBtn.addEventListener('click', () => {
            const pagesToDelete = editPdfPagesContainer.querySelectorAll('.page-item.marked-for-deletion');
            if (pagesToDelete.length === 0) {
                alert('請先點擊頁面以選取要刪除的頁面。');
                return;
            }
            if (confirm(`您確定要刪除選取的 ${pagesToDelete.length} 個頁面嗎？`)) {
                pagesToDelete.forEach(page => page.remove());
                renumberPageItems(editPdfPagesContainer);
                document.getElementById('edit-pdf-info').textContent = `刪除成功！目前共 ${editPdfPagesContainer.children.length} 頁。`;
            }
        });


        const promptForPasswordAndReload = (file) => {
            const password = prompt('此 PDF 文件已被加密，請輸入密碼：');
            if (password) {
                loadPdfForEditing(file, password);
            } else {
                 document.getElementById('edit-pdf-info').textContent = '未提供密碼，無法載入檔案。';
            }
        }

        const loadPdfForEditing = async (file, password = null) => {
            const isInitialLoad = pageSources.length === 0;
            const editPdfInfo = document.getElementById('edit-pdf-info');
            
            if (isInitialLoad) {
                pageSources = [];
                editPdfPagesContainer.innerHTML = '';
                currentPageThumbnailSize = 150; // Reset zoom on new file
                applyZoom();
            }
            editPdfInfo.innerHTML = '<div class="loader inline-block mr-2"></div>正在載入頁面預覽...';
            editPdfBtn.disabled = true;

            try {
                const pdfBytes = await readFileAsArrayBuffer(file);
                const loadingTask = pdfjsLib.getDocument({ data: pdfBytes.slice(0), password: password });
                const pdfjsDoc = await loadingTask.promise;
                const pdfLibDoc = await PDFDocument.load(pdfBytes, { ignoreEncryption: !!password });
                const sourceIndex = pageSources.push(pdfLibDoc) - 1;

                const fragment = document.createDocumentFragment();
                for (let i = 1; i <= pdfjsDoc.numPages; i++) {
                    const page = await pdfjsDoc.getPage(i);
                    const pageItem = await createPageThumbnail(page, sourceIndex, i - 1);
                    fragment.appendChild(pageItem);
                }

                if (isInitialLoad) {
                    editPdfPagesContainer.appendChild(fragment);
                } else {
                    const insertPoint = parseInt(insertPageNumInput.value, 10);
                    const allPageItems = editPdfPagesContainer.children;
                    if (insertPoint === 0) {
                        editPdfPagesContainer.prepend(fragment);
                    } else if (insertPoint >= allPageItems.length) {
                        editPdfPagesContainer.appendChild(fragment);
                    } else {
                        allPageItems[insertPoint - 1].after(fragment);
                    }
                }
                
                renumberPageItems(editPdfPagesContainer);
                setupPageEditorWithSortable(editPdfPagesContainer);
                editPdfInfo.textContent = `操作成功！目前共 ${editPdfPagesContainer.children.length} 頁。`;
                editPdfBtn.disabled = false;
                insertPdfBtn.classList.remove('hidden');
                addBlankPageBtn.classList.remove('hidden');
                deleteSelectedBtn.classList.remove('hidden');
                zoomInBtn.classList.remove('hidden');
                zoomOutBtn.classList.remove('hidden');
            } catch(error) {
                console.error('編輯器載入失敗:', error);
                if (error.name === 'PasswordException') {
                    promptForPasswordAndReload(file);
                } else {
                    editPdfInfo.textContent = `錯誤：無法載入 PDF 預覽 (${error.message || '未知錯誤'})。`;
                }
            } finally {
                if (!isInitialLoad) hideModal();
            }
        };

        editPdfInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) loadPdfForEditing(file);
        });
        
        confirmInsertBtn.addEventListener('click', async () => {
            const file = insertFileInput.files[0];
            const insertPoint = parseInt(insertPageNumInput.value, 10);
            const errorDiv = document.getElementById('insert-modal-error');
            const totalPages = editPdfPagesContainer.children.length;

            if (!file) {
                errorDiv.textContent = '請選擇一個 PDF 檔案。';
                errorDiv.classList.remove('hidden');
                return;
            }
            if (isNaN(insertPoint) || insertPoint < 0 || insertPoint > totalPages) {
                errorDiv.textContent = `請輸入介於 0 與 ${totalPages} 之間的頁碼。`;
                errorDiv.classList.remove('hidden');
                return;
            }
            errorDiv.classList.add('hidden');
            
            showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在插入檔案...</p>`);
            hideInsertModal();
            loadPdfForEditing(file);
        });
        
        confirmAddBlankPageBtn.addEventListener('click', async () => {
            const insertPoint = parseInt(addBlankPageNumInput.value, 10);
            const errorDiv = document.getElementById('add-blank-page-modal-error');
            const totalPages = editPdfPagesContainer.children.length;

            if (isNaN(insertPoint) || insertPoint < 0 || insertPoint > totalPages) {
                errorDiv.textContent = `請輸入介於 0 與 ${totalPages} 之間的頁碼。`;
                errorDiv.classList.remove('hidden');
                return;
            }
            errorDiv.classList.add('hidden');
            hideAddBlankPageModal();
            
            showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在新增空白頁...</p>`);

            try {
                const blankPdfDoc = await PDFDocument.create();
                const size = document.getElementById('blank-page-size').value;
                const orientation = document.getElementById('blank-page-orientation').value;
                let pageSize = PageSizes[size];
                if (orientation === 'landscape') {
                    pageSize = [pageSize[1], pageSize[0]];
                }
                blankPdfDoc.addPage(pageSize);
                
                const sourceIndex = pageSources.push(blankPdfDoc) - 1;
                
                const blankPageItem = createBlankPageThumbnail(sourceIndex, 0);

                const allPageItems = editPdfPagesContainer.children;
                if (insertPoint === 0) {
                    editPdfPagesContainer.prepend(blankPageItem);
                } else if (insertPoint >= allPageItems.length) {
                    editPdfPagesContainer.appendChild(blankPageItem);
                } else {
                    allPageItems[insertPoint - 1].after(blankPageItem);
                }

                renumberPageItems(editPdfPagesContainer);
                document.getElementById('edit-pdf-info').textContent = `新增空白頁成功！目前共 ${editPdfPagesContainer.children.length} 頁。`;
            } catch (error) {
                 console.error('新增空白頁失敗:', error);
                 document.getElementById('edit-pdf-info').textContent = '新增空白頁時發生錯誤。';
            } finally {
                hideModal();
            }
        });


        async function createPageThumbnail(page, sourceIndex, pageIndex) {
            const pageItem = document.createElement('div');
            pageItem.className = 'page-item draggable relative p-2 border rounded-md cursor-move transition-opacity flex flex-col items-center justify-center';
            pageItem.dataset.sourceIndex = sourceIndex;
            pageItem.dataset.pageIndex = pageIndex;
            
            const pageNumberContainer = document.createElement('div');
            pageNumberContainer.className = 'absolute bottom-1 right-1';
            const pageNumberSpan = document.createElement('span');
            pageNumberSpan.className = 'page-number-text bg-black bg-opacity-50 text-white text-xs px-1.5 py-0.5 rounded cursor-pointer';
            pageNumberContainer.appendChild(pageNumberSpan);
            
            pageNumberSpan.addEventListener('click', handlePageNumberClick);
            pageItem.addEventListener('click', (e) => {
                if (!e.target.classList.contains('page-number-text') && !e.target.closest('.page-number-input')) {
                     pageItem.classList.toggle('marked-for-deletion');
                }
            });

            try {
                const canvas = document.createElement('canvas');
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '180px';
                pageItem.appendChild(canvas);
                pageItem.appendChild(pageNumberContainer);

                const viewport = page.getViewport({ scale: 1.0 });
                const scale = Math.min(150 / viewport.width, 180 / viewport.height);
                const scaledViewport = page.getViewport({ scale: scale });
                
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;
                
                await page.render({ canvasContext: canvas.getContext('2d'), viewport: scaledViewport }).promise;
            } catch (renderError) {
                console.warn(`無法渲染頁面 (來源: ${sourceIndex}, 頁碼: ${pageIndex + 1}):`, renderError);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'w-[150px] h-[180px] bg-gray-200 flex items-center justify-center text-center text-sm text-red-500 p-2';
                errorDiv.textContent = '⚠️ 預覽失敗';
                pageItem.appendChild(errorDiv);
                pageItem.appendChild(pageNumberContainer);
            }
            
            return pageItem;
        }

        function createBlankPageThumbnail(sourceIndex, pageIndex) {
            const pageItem = document.createElement('div');
            pageItem.className = 'page-item draggable relative p-2 border rounded-md cursor-move transition-opacity flex flex-col items-center justify-center';
            pageItem.dataset.sourceIndex = sourceIndex;
            pageItem.dataset.pageIndex = pageIndex;
            pageItem.dataset.isBlank = true;

            const blankIndicator = document.createElement('div');
            blankIndicator.className = 'w-[150px] h-[180px] bg-white border-2 border-dashed border-gray-300 flex items-center justify-center text-sm text-gray-500';
            blankIndicator.textContent = '空白頁';
            pageItem.appendChild(blankIndicator);

            const pageNumberContainer = document.createElement('div');
            pageNumberContainer.className = 'absolute bottom-1 right-1';
            const pageNumberSpan = document.createElement('span');
            pageNumberSpan.className = 'page-number-text bg-black bg-opacity-50 text-white text-xs px-1.5 py-0.5 rounded cursor-pointer';
            pageNumberContainer.appendChild(pageNumberSpan);

            pageItem.appendChild(pageNumberContainer);
            
            pageNumberSpan.addEventListener('click', handlePageNumberClick);
            pageItem.addEventListener('click', (e) => {
                if (!e.target.classList.contains('page-number-text') && !e.target.closest('.page-number-input')) {
                     pageItem.classList.toggle('marked-for-deletion');
                }
            });

            return pageItem;
        }

        editPdfBtn.addEventListener('click', async () => {
            if (pageSources.length === 0) return;
            showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在儲存變更...</p>`);

            try {
                const newPdfDoc = await PDFDocument.create();
                const pageItems = [...editPdfPagesContainer.querySelectorAll('.page-item:not(.marked-for-deletion)')];
                
                if (pageItems.length === 0) {
                     throw new Error('不能刪除所有頁面。請至少保留一頁。');
                }

                for(const item of pageItems) {
                    const sourceIndex = parseInt(item.dataset.sourceIndex, 10);
                    const pageIndex = parseInt(item.dataset.pageIndex, 10);
                    const sourceDoc = pageSources[sourceIndex];
                    if (sourceDoc) {
                        const [copiedPage] = await newPdfDoc.copyPages(sourceDoc, [pageIndex]);
                        newPdfDoc.addPage(copiedPage);
                    }
                }

                const newPdfBytes = await newPdfDoc.save();
                const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                showDownloadModal('儲存成功！', '您的 PDF 已根據變更重新儲存。', '下載編輯後的 PDF', blob, `edited_document.pdf`);
            } catch(error) {
                console.error("編輯儲存失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">儲存失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }

    const extractImagesInput = document.getElementById('extract-images-file');
    if (extractImagesInput) {
        const extractImagesBtn = document.getElementById('extract-images-btn');
        extractImagesInput.addEventListener('change', () => {
            if (!extractImagesInput.files.length) {
                document.getElementById('extract-images-info').textContent = '請選擇檔案';
                extractImagesBtn.disabled = true;
                return;
            }
            const file = extractImagesInput.files[0];
            document.getElementById('extract-images-info').textContent = `已選擇：${file.name}`;
            extractImagesBtn.disabled = false;
        });

        extractImagesBtn.addEventListener('click', async () => {
            const file = extractImagesInput.files[0];
            if (!file) return;
            showModal(`<div class="loader mx-auto"></div><p id="modal-progress" class="mt-4">準備擷取圖片...</p>`);
            
            try {
                const pdfBytes = await readFileAsArrayBuffer(file);
                const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                const zip = new JSZip();
                let imageCount = 0;

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    document.getElementById('modal-progress').textContent = `正在掃描第 ${pageNum} / ${pdf.numPages} 頁...`;
                    const page = await pdf.getPage(pageNum);
                    const ops = await page.getOperatorList();
                    
                    for (let i = 0; i < ops.fnArray.length; i++) {
                        if (ops.fnArray[i] === pdfjsLib.OPS.paintImageXObject) {
                            try {
                                const imageName = ops.argsArray[i][0];
                                const imgData = await page.objs.get(imageName);

                                if (!imgData || !imgData.data) {
                                    console.warn(`Skipping image on page ${pageNum} as it contains no data.`);
                                    continue;
                                }
                                
                                let blob;
                                let extension;
                                const data = imgData.data;

                                if (data[0] === 0xFF && data[1] === 0xD8) {
                                    blob = new Blob([data], { type: 'image/jpeg' });
                                    extension = 'jpg';
                                } else {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = imgData.width;
                                    canvas.height = imgData.height;
                                    const ctx = canvas.getContext('2d');
                                    const imageData = ctx.createImageData(imgData.width, imgData.height);
                                    
                                    const numPixels = imgData.width * imgData.height;
                                    const bytesPerPixel = data.length / numPixels;

                                    if (bytesPerPixel === 1) { 
                                        for (let p = 0; p < numPixels; p++) {
                                            const g = data[p];
                                            imageData.data[p * 4] = g;
                                            imageData.data[p * 4 + 1] = g;
                                            imageData.data[p * 4 + 2] = g;
                                            imageData.data[p * 4 + 3] = 255;
                                        }
                                    } else if (bytesPerPixel === 3) { 
                                        for (let p = 0; p < numPixels; p++) {
                                            imageData.data[p * 4] = data[p * 3];
                                            imageData.data[p * 4 + 1] = data[p * 3 + 1];
                                            imageData.data[p * 4 + 2] = data[p * 3 + 2];
                                            imageData.data[p * 4 + 3] = 255;
                                        }
                                    } else if (bytesPerPixel === 4) {
                                        imageData.data.set(data);
                                    } else {
                                        console.warn(`Skipping image with unsupported bytes per pixel: ${bytesPerPixel}`);
                                        continue;
                                    }
                                    
                                    ctx.putImageData(imageData, 0, 0);
                                    blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                                    extension = 'png';
                                }
                                
                                if (blob) {
                                    imageCount++;
                                    zip.file(`page_${pageNum}_img_${imageCount}.${extension}`, blob);
                                }

                            } catch (e) {
                                console.warn(`Skipping an image on page ${pageNum} due to a processing error:`, e);
                            }
                        }
                    }
                }

                if (imageCount === 0) {
                     throw new Error('在文件中找不到可擷取的圖片。可能是圖片格式不受支援。');
                }

                const zipBlob = await zip.generateAsync({ type: "blob" });
                showDownloadModal('擷取成功！', `成功從 PDF 中擷取了 ${imageCount} 張圖片。`, '下載圖片 ZIP', zipBlob, `extracted_images_from_${file.name}.zip`);

            } catch (error) {
                console.error("圖片擷取失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">擷取失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }

    const pdfToWebInput = document.getElementById('pdf-to-web-file');
    if(pdfToWebInput) {
        const pdfToWebBtn = document.getElementById('pdf-to-web-btn');
        pdfToWebInput.addEventListener('change', () => {
            if (!pdfToWebInput.files.length) {
                document.getElementById('pdf-to-web-info').textContent = '請選擇檔案';
                pdfToWebBtn.disabled = true;
                document.getElementById('pdf-to-web-options').classList.add('hidden');
                return;
            }
            const file = pdfToWebInput.files[0];
            document.getElementById('pdf-to-web-info').textContent = `已選擇：${file.name}`;
            pdfToWebBtn.disabled = false;
            document.getElementById('pdf-to-web-options').classList.remove('hidden');
        });

        pdfToWebBtn.addEventListener('click', async () => {
            const file = pdfToWebInput.files[0];
            if (!file) return;

            const layoutMode = document.getElementById('web-layout-mode').value;
            const resolution = document.getElementById('web-resolution').value;

            showModal(`<div class="loader mx-auto"></div><p id="modal-progress" class="mt-4">準備轉換...</p>`);

            try {
                const pdfBytes = await readFileAsArrayBuffer(file);
                const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                const totalPages = pdf.numPages;
                let bodyContent = '';
                let finalHtml = '';

                for (let i = 1; i <= totalPages; i++) {
                     document.getElementById('modal-progress').textContent = `正在處理第 ${i} / ${totalPages} 頁...`;
                     const page = await pdf.getPage(i);
                     const viewport = page.getViewport({ scale: 2.0 });
                     const canvas = document.createElement('canvas');
                     canvas.height = viewport.height;
                     canvas.width = viewport.width;
                     await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                     const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                     
                     if (layoutMode === 'scroll') {
                        bodyContent += `<img src="${dataUrl}" alt="Page ${i}" />\n`;
                     } else { // slideshow
                        bodyContent += `<div class="slide"><img src="${dataUrl}" alt="Page ${i}" /></div>\n`;
                     }
                }

                if (layoutMode === 'scroll') {
                    finalHtml = getScrollableHtml(file.name, bodyContent, resolution);
                } else { // slideshow
                    finalHtml = getSlideshowHtml(file.name, bodyContent, totalPages);
                }

                const blob = new Blob([finalHtml], { type: 'text/html' });
                const newFileName = file.name.replace(/\.[^/.]+$/, "") + ".html";
                showDownloadModal('轉換成功！', '您的 PDF 已成功轉換為 HTML 檔案。', '下載 HTML', blob, newFileName);

            } catch (error) {
                 console.error("PDF轉網頁失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">轉換失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }

    function getScrollableHtml(title, bodyContent, maxWidth) {
        return `
            <!DOCTYPE html>
            <html lang="zh-Hant">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${title}</title>
                <style>
                    body { margin: 0; background-color: #f0f0f0; display: flex; justify-content: center; }
                    .container { max-width: ${maxWidth}px; width: 100%; }
                    img { display: block; width: 100%; height: auto; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                </style>
            </head>
            <body>
                <div class="container">
                    ${bodyContent}
                </div>
            </body>
            </html>`;
    }

    function getSlideshowHtml(title, bodyContent, totalPages) {
         return `
            <!DOCTYPE html>
            <html lang="zh-Hant">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${title}</title>
                <style>
                    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #222; color: white; font-family: sans-serif; }
                    .slideshow-container { position: relative; width: 100%; height: 100%; }
                    .slide { display: none; width: 100%; height: 100%; text-align: center; }
                    .slide.active { display: flex; align-items: center; justify-content: center; }
                    .slide img { max-width: 100%; max-height: 100%; object-fit: contain; }
                    .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.3); color: white; border: none; font-size: 2rem; cursor: pointer; padding: 10px 15px; border-radius: 5px; z-index: 10; user-select: none; }
                    .nav-btn:hover { background-color: rgba(0,0,0,0.6); }
                    #prev-btn { left: 10px; }
                    #next-btn { right: 10px; }
                    #page-counter { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px; }
                </style>
            </head>
            <body>
                <div class="slideshow-container">
                    ${bodyContent}
                </div>
                <button id="prev-btn" class="nav-btn">&lt;</button>
                <button id="next-btn" class="nav-btn">&gt;</button>
                <div id="page-counter"></div>

                <script>
                    const slides = document.querySelectorAll('.slide');
                    const prevBtn = document.getElementById('prev-btn');
                    const nextBtn = document.getElementById('next-btn');
                    const pageCounter = document.getElementById('page-counter');
                    let currentSlide = 0;
                    const totalSlides = ${totalPages};

                    function showSlide(index) {
                        slides.forEach(slide => slide.classList.remove('active'));
                        slides[index].classList.add('active');
                        pageCounter.textContent = \`\${index + 1} / \${totalSlides}\`;
                    }

                    prevBtn.addEventListener('click', () => {
                        currentSlide = (currentSlide > 0) ? currentSlide - 1 : totalSlides - 1;
                        showSlide(currentSlide);
                    });

                    nextBtn.addEventListener('click', () => {
                        currentSlide = (currentSlide < totalSlides - 1) ? currentSlide + 1 : 0;
                        showSlide(currentSlide);
                    });
                    
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowRight') nextBtn.click();
                        if (e.key === 'ArrowLeft') prevBtn.click();
                    });

                    showSlide(0);
                <\/script>
            </body>
            </html>`;
    }

    const wordFileInput = document.getElementById('word-file-input');
    if (wordFileInput) {
        const wordToPdfBtn = document.getElementById('word-to-pdf-btn');
        wordFileInput.addEventListener('change', () => {
            wordToPdfBtn.disabled = !wordFileInput.files.length;
        });

        wordToPdfBtn.addEventListener('click', async () => {
            const file = wordFileInput.files[0];
            if (!file) return;
            showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在轉換 Word 檔案...</p>`);
            try {
                const arrayBuffer = await readFileAsArrayBuffer(file);
                const result = await mammoth.convertToHtml({ arrayBuffer });
                printHtml(result.value, file.name);
                hideModal();
            } catch (error) {
                console.error("Word 轉換失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">轉換失敗</h3><p>${error.message || '無法處理此 Word 檔案。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }

    const excelFileInput = document.getElementById('excel-file-input');
    if (excelFileInput) {
        const excelToPdfBtn = document.getElementById('excel-to-pdf-btn');
        excelFileInput.addEventListener('change', () => {
            excelToPdfBtn.disabled = !excelFileInput.files.length;
        });

        excelToPdfBtn.addEventListener('click', async () => {
            const file = excelFileInput.files[0];
            if (!file) return;
            showModal(`<div class="loader mx-auto"></div><p class="mt-4">正在轉換 Excel 檔案...</p>`);
            try {
                const data = await readFileAsArrayBuffer(file);
                const workbook = XLSX.read(data, { type: 'array' });
                let finalHtml = '';
                workbook.SheetNames.forEach(sheetName => {
                    finalHtml += `<h2>${sheetName}</h2>`;
                    const worksheet = workbook.Sheets[sheetName];
                    finalHtml += XLSX.utils.sheet_to_html(worksheet);
                });
                printHtml(finalHtml, file.name);
                hideModal();
            } catch (error) {
                console.error("Excel 轉換失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">轉換失敗</h3><p>${error.message || '無法處理此 Excel 檔案。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }
    
    /**
     * Renders text to an image using canvas and returns the image bytes and dimensions.
     * This avoids embedding fonts by converting text to a raster image.
     * @param {string} text The text content to render.
     * @param {object} options Styling options for the text.
     * @param {number} options.size Font size in points.
     * @param {string} options.color Hex color string (e.g., '#000000').
     * @returns {Promise<{bytes: ArrayBuffer, width: number, height: number}>}
     */
    async function createTextImageBytes(text, options) {
        const { size, color } = options;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Use a high-resolution multiplier to ensure quality when zoomed
        const dpr = 2; 
        const fontSize = size * dpr;
        // Use a generic font family; the browser will select an appropriate system font
        const font = `${fontSize}px "Microsoft JhengHei", "PingFang TC", sans-serif`;
        ctx.font = font;
        
        const textMetrics = ctx.measureText(text);
        canvas.width = Math.ceil(textMetrics.width);
        canvas.height = Math.ceil(fontSize * 1.4); // Add some vertical padding

        // Re-apply font settings after resizing canvas, as they can be reset
        ctx.font = font;
        ctx.fillStyle = color;
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';
        
        ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        
        const dataUrl = canvas.toDataURL('image/png');
        const imageBytes = await fetch(dataUrl).then(res => res.arrayBuffer());
        
        return { 
            bytes: imageBytes, 
            width: canvas.width / dpr, 
            height: canvas.height / dpr 
        };
    }

    const handoutPdfInput = document.getElementById('handout-pdf-file');
    if (handoutPdfInput) {
        const handoutPdfBtn = document.getElementById('handout-pdf-btn');
        const handoutEnablePageNumbers = document.getElementById('handout-enable-page-numbers');
        const handoutPageNumbersContainer = document.getElementById('handout-page-numbers-container');
        const handoutAddBordersCheckbox = document.getElementById('handout-add-borders');
        const handoutBorderOptionsContainer = document.getElementById('handout-border-options');
        const handoutAddOriginalPageNumbersCheckbox = document.getElementById('handout-add-page-numbers');
        const handoutOriginalPageNumberOptionsContainer = document.getElementById('handout-original-page-number-options');
        const handoutAddCustomTextCheckbox = document.getElementById('handout-add-custom-text');
        const handoutCustomTextOptionsContainer = document.getElementById('handout-custom-text-options');
        const handoutLayoutSelect = document.getElementById('handout-layout');
        const handoutZoomInBtn = document.getElementById('handout-zoom-in-btn');
        const handoutZoomOutBtn = document.getElementById('handout-zoom-out-btn');
        const handoutSourcePreviewDiv = document.getElementById('handout-source-pages-preview');

        const applyHandoutZoom = () => {
            handoutSourcePreviewDiv.style.gridTemplateColumns = `repeat(auto-fill, minmax(${handoutThumbnailSize}px, 1fr))`;
        };

        handoutZoomInBtn.addEventListener('click', () => {
            handoutThumbnailSize = Math.min(MAX_ZOOM, handoutThumbnailSize + ZOOM_STEP);
            applyHandoutZoom();
        });
        handoutZoomOutBtn.addEventListener('click', () => {
            handoutThumbnailSize = Math.max(MIN_ZOOM, handoutThumbnailSize - ZOOM_STEP);
            applyHandoutZoom();
        });

        const renderHandoutSourcePreview = async (file) => {
            const container = document.getElementById('handout-source-pages-container');
            const infoDiv = document.getElementById('handout-pdf-info');
            
            infoDiv.innerHTML = '<div class="loader inline-block mr-2"></div>正在載入縮圖預覽...';
            container.classList.remove('hidden');
            handoutSourcePreviewDiv.innerHTML = '';
            
            try {
                const pdfBytes = await readFileAsArrayBuffer(file);
                const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                
                const fragment = document.createDocumentFragment();
                const renderPromises = [];

                for(let i=1; i <= pdf.numPages; i++) {
                    const renderPromise = (async () => {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        
                        const scale = 240 / viewport.width; // MODIFIED: Increased resolution for clarity
                        const scaledViewport = page.getViewport({ scale });
                        canvas.height = scaledViewport.height;
                        canvas.width = scaledViewport.width;

                        await page.render({ canvasContext: context, viewport: scaledViewport }).promise;

                        const item = document.createElement('div');
                        item.className = 'source-page-item'; // MODIFIED: Not draggable
                        item.dataset.originalIndex = i - 1;

                        const img = document.createElement('img');
                        img.src = canvas.toDataURL('image/jpeg', 0.8);
                        const pageNum = document.createElement('span');
                        pageNum.className = 'page-number';
                        pageNum.textContent = i;
                        
                        item.appendChild(img);
                        item.appendChild(pageNum);
                        return { element: item, originalIndex: i-1 };
                    })();
                    renderPromises.push(renderPromise);
                }

                const renderedItems = await Promise.all(renderPromises);
                renderedItems.sort((a, b) => a.originalIndex - b.originalIndex).forEach(item => fragment.appendChild(item.element));

                handoutSourcePreviewDiv.appendChild(fragment);

                // MODIFIED: Sortable functionality is removed.
                
                setTimeout(() => {
                    infoDiv.textContent = `已選擇：${file.name} (共 ${pdf.numPages} 頁)`;
                }, 100);

            } catch (e) {
                console.error("Failed to render source preview:", e);
                infoDiv.textContent = '無法讀取此 PDF 檔案。';
                container.classList.add('hidden');
            }
        };

        handoutPdfInput.addEventListener('change', (e) => {
             if (!e.target.files.length) {
                document.getElementById('handout-pdf-info').textContent = '請選擇檔案';
                document.getElementById('handout-options').classList.add('hidden');
                document.getElementById('handout-source-pages-container').classList.add('hidden');
                handoutPdfBtn.disabled = true;
                return;
            }
            const file = e.target.files[0];
            document.getElementById('handout-pdf-info').textContent = `已選擇：${file.name}`;
            document.getElementById('handout-options').classList.remove('hidden');
            handoutPdfBtn.disabled = false;
            handoutThumbnailSize = 80;
            applyHandoutZoom();
            renderHandoutSourcePreview(file);
        });
        
        handoutEnablePageNumbers.addEventListener('change', (e) => {
            handoutPageNumbersContainer.classList.toggle('hidden', !e.target.checked);
        });
        
        handoutAddBordersCheckbox.addEventListener('change', (e) => {
            handoutBorderOptionsContainer.classList.toggle('hidden', !e.target.checked);
        });

        handoutAddOriginalPageNumbersCheckbox.addEventListener('change', (e) => {
            handoutOriginalPageNumberOptionsContainer.classList.toggle('hidden', !e.target.checked);
        });

        handoutAddCustomTextCheckbox.addEventListener('change', (e) => {
            handoutCustomTextOptionsContainer.classList.toggle('hidden', !e.target.checked);
        });

        handoutPdfBtn.addEventListener('click', async () => {
            const file = handoutPdfInput.files[0];
            if (!file) return;

            showModal(`<div class="loader mx-auto"></div><p id="modal-progress" class="mt-4">準備製作講義...</p>`);

            try {
                const slidesPerPage = parseInt(document.getElementById('handout-layout').value, 10);
                const orientation = document.getElementById('handout-orientation').value;
                
                let cols, rows;
                if (orientation === 'portrait') {
                    switch (slidesPerPage) {
                        case 2: [cols, rows] = [1, 2]; break;
                        case 4: [cols, rows] = [2, 2]; break;
                        case 6: [cols, rows] = [2, 3]; break;
                        case 8: [cols, rows] = [2, 4]; break;
                        case 10: [cols, rows] = [2, 5]; break;
                        default: [cols, rows] = [1, 2];
                    }
                } else { // landscape
                    switch (slidesPerPage) {
                        case 2: [cols, rows] = [2, 1]; break;
                        case 4: [cols, rows] = [2, 2]; break;
                        case 6: [cols, rows] = [3, 2]; break;
                        case 8: [cols, rows] = [4, 2]; break;
                        case 10: [cols, rows] = [5, 2]; break;
                        default: [cols, rows] = [2, 1];
                    }
                }
                
                const spacingMm = parseFloat(document.getElementById('handout-spacing').value) || 0;
                const marginMm = parseFloat(document.getElementById('handout-margins').value) || 0;
                const rangeText = document.getElementById('handout-page-range').value;
                const addOriginalPageNumbers = document.getElementById('handout-add-page-numbers').checked;
                const addBorders = document.getElementById('handout-add-borders').checked;
                const addCustomText = document.getElementById('handout-add-custom-text').checked;
                const customText = document.getElementById('handout-custom-text-input').value;
const customTextFirstPageOnly = document.getElementById('handout-custom-text-first-page-only').checked;
                const customTextMarginMm = parseFloat(document.getElementById('handout-custom-text-margin').value) || 5;

                const mmToPoints = mm => (mm / 25.4) * 72;
                const spacing = mmToPoints(spacingMm);
                const margin = mmToPoints(marginMm);

                const pdfBytes = await readFileAsArrayBuffer(file);
                
                // Since sorting is disabled, we just get the indices in their original order.
                const pageItems = [...handoutSourcePreviewDiv.querySelectorAll('.source-page-item')];
                let originalPageIndices = pageItems.map(item => parseInt(item.dataset.originalIndex, 10));

                let pageIndicesToProcess;
                if (rangeText.trim() === '') {
                    pageIndicesToProcess = originalPageIndices;
                } else {
                    const pagesToNumberSet = new Set();
                    rangeText.split(',').forEach(part => {
                        part = part.trim();
                        if (part.includes('-')) {
                            const [start, end] = part.split('-').map(Number);
                            if (!isNaN(start) && !isNaN(end)) {
                                for (let i = start; i <= end; i++) pagesToNumberSet.add(i - 1);
                            }
                        } else if (!isNaN(Number(part))) {
                            pagesToNumberSet.add(Number(part) - 1);
                        }
                    });
                    
                    pageIndicesToProcess = originalPageIndices.filter(index => pagesToNumberSet.has(index));
                }
                
                if (pageIndicesToProcess.length === 0) throw new Error("頁面範圍無效或沒有可處理的頁面。");
                
                const handoutPdfDoc = await PDFDocument.create();
                handoutPdfDoc.registerFontkit(fontkit);
                const pagesPerSheet = cols * rows;

                document.getElementById('modal-progress').textContent = '正在嵌入頁面...';
                const embeddedPages = await handoutPdfDoc.embedPdf(pdfBytes, pageIndicesToProcess);
                
                let fontForOriginal;
                if (addOriginalPageNumbers) {
                    const isOriginalBold = document.getElementById('handout-original-page-number-bold').checked;
                    fontForOriginal = await handoutPdfDoc.embedFont(isOriginalBold ? StandardFonts.HelveticaBold : StandardFonts.Helvetica);
                }

                const handoutTotalPages = Math.ceil(embeddedPages.length / pagesPerSheet);

                for (let i = 0; i < embeddedPages.length; i += pagesPerSheet) {
                    const currentHandoutPageNum = (i / pagesPerSheet) + 1;
                    document.getElementById('modal-progress').textContent = `正在處理講義第 ${currentHandoutPageNum} / ${handoutTotalPages} 頁...`;
                    
                    const a4PageSize = orientation === 'landscape' ? [PageSizes.A4[1], PageSizes.A4[0]] : PageSizes.A4;
                    const page = handoutPdfDoc.addPage(a4PageSize);
                    const { width: pageWidth, height: pageHeight } = page.getSize();
                    
                    const usableWidth = pageWidth - (2 * margin);
                    const usableHeight = pageHeight - (2 * margin);
                    const cellWidth = (usableWidth - (cols - 1) * spacing) / cols;
                    const cellHeight = (usableHeight - (rows - 1) * spacing) / rows;

                    const pageChunk = embeddedPages.slice(i, i + pagesPerSheet);
                    
                    pageChunk.forEach((embeddedPage, j) => {
                        const row = Math.floor(j / cols);
                        const col = j % cols;

                        const x = margin + col * (cellWidth + spacing);
                        const y = pageHeight - margin - (row + 1) * cellHeight - row * spacing;

                        const scale = Math.min(cellWidth / embeddedPage.width, cellHeight / embeddedPage.height);
                        const pageDimensions = {
                            width: embeddedPage.width * scale,
                            height: embeddedPage.height * scale,
                        };
                        
                        const centeredX = x + (cellWidth - pageDimensions.width) / 2;
                        const centeredY = y + (cellHeight - pageDimensions.height) / 2;

                        page.drawPage(embeddedPage, { ...pageDimensions, x: centeredX, y: centeredY });
                        
                        if (addBorders) {
                            const borderColorHex = document.getElementById('handout-border-color').value;
                            const borderWidth = parseFloat(document.getElementById('handout-border-width').value);
                            const colorRgb = hexToRgb(borderColorHex);

                            page.drawRectangle({
                                x: centeredX - (borderWidth / 2),
                                y: centeredY - (borderWidth / 2),
                                width: pageDimensions.width + borderWidth,
                                height: pageDimensions.height + borderWidth,
                                borderWidth: borderWidth,
                                borderColor: rgb(colorRgb.r, colorRgb.g, colorRgb.b),
                            });
                        }

                        if (addOriginalPageNumbers) {
                            const pageNumText = `${pageIndicesToProcess[i+j] + 1}`;
                            
                            const position = document.getElementById('handout-original-page-number-position').value;
                            const size = parseInt(document.getElementById('handout-original-page-number-size').value, 10);
                            const colorHex = document.getElementById('handout-original-page-number-color').value;
                            const color = hexToRgb(colorHex);
                            
                            const textWidth = fontForOriginal.widthOfTextAtSize(pageNumText, size);
                            const textHeight = fontForOriginal.heightAtSize(size);
                            let textX, textY;
                            const offset = 2;

                            if (position.includes('bottom')) textY = centeredY - textHeight - offset;
                            else textY = centeredY + pageDimensions.height + offset;

                            if (position.includes('center')) textX = centeredX + (pageDimensions.width - textWidth) / 2;
                            else if (position.includes('right')) textX = centeredX + pageDimensions.width - textWidth;
                            else textX = centeredX;

                            page.drawText(pageNumText, { x: textX, y: textY, size, font: fontForOriginal, color: rgb(color.r, color.g, color.b) });
                        }
                    });

                    if (addCustomText && customText.trim() !== '') {
                        const shouldDrawText = !customTextFirstPageOnly || (customTextFirstPageOnly && currentHandoutPageNum === 1);
                        if(shouldDrawText) {
                            const size = parseInt(document.getElementById('handout-custom-text-size').value, 10);
                            const colorHex = document.getElementById('handout-custom-text-color').value;
                            const textMarginPoints = mmToPoints(customTextMarginMm);

                            const textImage = await createTextImageBytes(customText, {
                                size: size,
                                color: colorHex
                            });

                            const embeddedImage = await handoutPdfDoc.embedPng(textImage.bytes);
                            
                            const position = document.getElementById('handout-custom-text-position').value;
                            const textWidth = textImage.width;
                            const textHeight = textImage.height;
                            let x, y;

                            if (position.includes('bottom')) y = textMarginPoints;
                            else y = pageHeight - textHeight - textMarginPoints;
                            
                            if (position.includes('center')) x = pageWidth / 2 - textWidth / 2;
                            else if (position.includes('right')) x = pageWidth - textWidth - textMarginPoints;
                            else x = textMarginPoints;
                            
                            page.drawImage(embeddedImage, { 
                                x, 
                                y, 
                                width: textWidth, 
                                height: textHeight
                            });
                        }
                    }
                }
                
                if (handoutEnablePageNumbers.checked) {
                    document.getElementById('modal-progress').textContent = `正在為講義加上新頁碼...`;
                    const isBold = document.getElementById('handout-page-number-bold').checked;
                    const font = await handoutPdfDoc.embedFont(isBold ? StandardFonts.HelveticaBold : StandardFonts.Helvetica);
                    const position = document.getElementById('handout-page-number-position').value;
                    const size = parseInt(document.getElementById('handout-page-number-size').value, 10);
                    const colorHex = document.getElementById('handout-page-number-color').value;
                    const color = hexToRgb(colorHex);
                    const format = document.getElementById('handout-page-number-format').value;
                    const numRangeText = document.getElementById('handout-page-number-range').value;
                    
                    const handoutPages = handoutPdfDoc.getPages();
                    const numTotalPages = handoutPages.length;
                    const pagesToNumber = new Set();
                    if (numRangeText.trim() === '') {
                        for (let k = 0; k < numTotalPages; k++) pagesToNumber.add(k);
                    } else {
                         numRangeText.split(',').forEach(part => {
                            if (part.includes('-')) {
                                const [start, end] = part.split('-').map(Number);
                                for (let k = start; k <= end; k++) pagesToNumber.add(k - 1);
                            } else {
                                pagesToNumber.add(Number(part.trim()) - 1);
                            }
                        });
                    }

                    handoutPages.forEach((page, k) => {
                        if (!pagesToNumber.has(k)) return;
                        
                        const { width, height } = page.getSize();
                        const pageNumberText = format.replace('{page}', k + 1).replace('{total}', numTotalPages);
                        const textWidth = font.widthOfTextAtSize(pageNumberText, size);
                        let x, y;
                        const pageMargin = 30;

                        if (position.includes('bottom')) y = pageMargin;
                        else y = height - size - pageMargin;

                        if (position.includes('center')) x = width / 2 - textWidth / 2;
                        else if (position.includes('right')) x = width - textWidth - pageMargin;
                        else x = pageMargin;

                        page.drawText(pageNumberText, { x, y, size, font, color: rgb(color.r, color.g, color.b) });
                    });
                }

                const handoutPdfBytes = await handoutPdfDoc.save();
                const blob = new Blob([handoutPdfBytes], { type: 'application/pdf' });
                showDownloadModal('講義製作成功！', `已成功將 ${embeddedPages.length} 個來源頁面製作成 ${handoutPdfDoc.getPageCount()} 頁講義。`, '下載講義 PDF', blob, `handout_${file.name}`);

            } catch (error) {
                console.error("講義製作失敗:", error);
                showModal(`<h3 class="text-xl font-bold text-red-600 mb-4">製作失敗</h3><p>${error.message || '處理時發生錯誤。'}</p><button onclick="hideModal()" class="mt-4 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button>`);
            }
        });
    }

    function printHtml(htmlContent, title) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html lang="zh-Hant">
            <head>
                <meta charset="UTF-8">
                <title>列印預覽 - ${title}</title>
                <style>
                    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; margin: 2rem; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 2rem; page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                    thead { display: table-header-group; }
                    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; font-weight: bold; }
                    h2 { border-bottom: 2px solid #666; padding-bottom: 5px; margin-top: 2rem; page-break-after: avoid; }
                    @media print {
                        @page { size: A4; margin: 15mm; }
                        body { margin: 0; }
                        h2 { color: #000; }
                    }
                </style>
            </head>
            <body>
                ${htmlContent}
                <script>
                    window.onload = function() {
                        setTimeout(function() { 
                            window.print();
                        }, 500);
                    }
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }
});
</script>
</body>
</html></div></body></html></div></body></html></div></body></html></div></body></html>
