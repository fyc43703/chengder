<!DOCTYPE html>
<html lang="zh-Hant" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>施工照片排版輸出工具</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 引入 HEIC 轉換工具 -->
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <!-- 引入 PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>

    <style>
        /* Light Theme */
        :root.light {
            --bg-color: #f5f5f7;
            --text-color: #1d1d1f;
            --text-secondary-color: #6e6e73;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --border-color: rgba(0, 0, 0, 0.1);
            --input-bg: #fff;
            --instruction-keyword-color: #007aff;
        }

        /* Dark Theme */
        :root.dark {
            --bg-color: #1d1d1f;
            --text-color: #f5f5f7;
            --text-secondary-color: #a1a1a6;
            --glass-bg: rgba(44, 44, 46, 0.7);
            --border-color: rgba(255, 255, 255, 0.15);
            --input-bg: #2c2c2e;
            --instruction-keyword-color: #0a84ff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .transition-all {
            transition: all 0.2s ease-in-out;
        }
        .glass-effect {
            background-color: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        h1, h2, h3 { color: var(--text-color); }
        p, label, select, span { color: var(--text-secondary-color); }
        h3 { color: var(--text-color); }
        .text-blue-600 { color: #007aff; }
        .dark .text-blue-600 { color: #0a84ff; }
        input, select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .dark #roc-date-display { background-color: var(--input-bg); }

        button:disabled, label.disabled-label {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .photo-card:hover .photo-controls {
            opacity: 1;
        }
        .loader-overlay, .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
            color: #333;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .loader-overlay {
            background-color: rgba(245, 245, 247, 0.7);
        }
        .dark .loader-overlay { background-color: rgba(29, 29, 31, 0.7); }
        .modal-overlay {
             background-color: rgba(0, 0, 0, 0.4);
        }
        .loader {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .traffic-lights {
            position: absolute;
            top: 1.25rem;
            left: 1.25rem;
            display: flex;
            gap: 0.5rem;
        }
        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .traffic-light.red { background-color: #ff5f56; }
        .traffic-light.yellow { background-color: #ffbd2e; }
        .traffic-light.green { background-color: #27c93f; }
        
        #roc-date-display {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            padding: 0 0.5rem;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0.5;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.5rem;
        }
        .description-textarea {
            resize: none;
            overflow-y: hidden;
            min-height: 42px;
            transition: height 0.15s ease;
        }
        #pagination-options-container.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .header-field {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }
        .header-field .input-group {
            flex-grow: 1;
        }
        /* 加大核取方塊 */
        .header-field input[type="checkbox"] {
            margin-bottom: 0.5rem; 
            width: 1.25rem;
            height: 1.25rem;
        }
        /* 修正：按鈕內文字與圖示顏色繼承 */
        button span, label span, button i, label i, button svg, label svg {
            color: inherit;
        }
        #image-preview-modal img {
            max-width: 90vw;
            max-height: 85vh;
            object-fit: contain;
        }
        /* 功能說明關鍵字顏色 */
        .instruction-keyword {
            color: var(--instruction-keyword-color);
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen p-8">
    
    <!-- 全螢幕載入指示器 -->
    <div id="loader-overlay" class="loader-overlay" style="display: none;">
        <!-- 內容由 JavaScript 動態生成 -->
    </div>
    
    <!-- Modal 區域 -->
    <div id="image-preview-modal" class="modal-overlay" style="display: none; cursor: zoom-out;">
        <div class="relative">
            <img id="preview-image" src="" alt="圖片預覽">
            <button id="image-preview-close" class="absolute -top-4 -right-4 bg-white rounded-full p-1 text-gray-800 hover:bg-gray-200" style="cursor: pointer;">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="layout-modal" class="modal-overlay" style="display: none;">
        <div class="glass-effect rounded-xl shadow-lg p-6 w-full max-w-lg relative">
            <h2 class="text-xl font-semibold mb-6">版面設定</h2>
            <div class="space-y-4 text-sm">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="layout-orientation" class="font-medium">頁面方向：</label>
                        <select id="layout-orientation" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="portrait">直式 (Portrait)</option>
                            <option value="landscape">橫式 (Landscape)</option>
                        </select>
                    </div>
                    <div>
                        <label for="photos-per-page" class="font-medium">每頁照片數量：</label>
                        <select id="photos-per-page" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="2">2 張</option>
                            <option value="4">4 張</option>
                            <option value="6">6 張</option>
                            <option value="8">8 張</option>
                            <option value="9">9 張</option>
                            <option value="10">10 張</option>
                            <option value="12">12 張</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center pt-2 space-x-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="show-captions" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="show-captions" class="ml-2 block">顯示說明文字</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="show-borders" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="show-borders" class="ml-2 block">顯示框線</label>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="layout-modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold">關閉</button>
            </div>
            <button id="layout-modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="pagination-modal" class="modal-overlay" style="display: none;">
        <div class="glass-effect rounded-xl shadow-lg p-6 w-full max-w-lg relative">
            <h2 class="text-xl font-semibold mb-6">頁碼設定</h2>
            <div class="flex items-center pb-4 border-b border-gray-200 mb-4">
                <input type="checkbox" id="pagination-enabled" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="pagination-enabled" class="ml-2 block font-medium">啟用頁碼</label>
            </div>
            <div id="pagination-options-container" class="transition-opacity">
                <div class="space-y-4 text-sm">
                    <div>
                        <label for="pagination-position" class="font-medium">頁碼位置：</label>
                        <select id="pagination-position" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="center">頁尾置中</option>
                            <option value="left">頁尾靠左</option>
                            <option value="right">頁尾靠右</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pagination-font-size" class="font-medium">字體大小：</label>
                            <input type="number" id="pagination-font-size" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="12">
                        </div>
                        <div>
                            <label for="pagination-font-color" class="font-medium">字體顏色：</label>
                            <input type="color" id="pagination-font-color" class="w-full mt-1 h-10 border rounded-lg cursor-pointer" value="#555555">
                        </div>
                    </div>
                    <div>
                        <label for="pagination-format" class="font-medium">頁碼格式：</label>
                        <input type="text" id="pagination-format" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs mt-1">可用變數：{page} (目前頁), {total} (總頁數)</p>
                    </div>
                    <div>
                        <label for="pagination-range" class="font-medium">套用頁碼範圍 (可留白)：</label>
                        <input type="text" id="pagination-range" placeholder="例如: 2-10, 15 (留白則全部套用)" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="pagination-show-total" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="pagination-show-total" class="ml-2 block">顯示總頁數</label>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button id="pagination-modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold">關閉</button>
            </div>
             <button id="pagination-modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="presets-modal" class="modal-overlay" style="display: none;">
        <div class="glass-effect rounded-xl shadow-lg p-6 w-full max-w-2xl relative">
            <h2 class="text-xl font-semibold mb-4">主題樣板管理</h2>
            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-3">
                    <h3 class="font-semibold">儲存目前設定為樣板</h3>
                    <input type="text" id="preset-name-input" placeholder="請輸入樣板名稱..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="save-preset-btn" class="w-full flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-semibold transition-all shadow-sm">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>儲存樣板</span>
                    </button>
                </div>
                <div class="space-y-3">
                    <h3 class="font-semibold">載入或刪除樣板</h3>
                    <div id="presets-list" class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 max-h-48 overflow-y-auto border">
                        <p class="text-sm text-center py-4">尚無儲存的樣板</p>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="presets-modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold">關閉</button>
            </div>
            <button id="presets-modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto">
        <header class="glass-effect relative rounded-xl shadow-lg p-6 mb-6">
            <div class="traffic-lights">
                <div class="traffic-light red"></div>
                <div class="traffic-light yellow"></div>
                <div class="traffic-light green"></div>
            </div>
             <!-- 新增：主題切換按鈕 -->
            <button id="theme-toggle" title="切換明亮/深色主題" class="absolute top-6 right-6 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                <i data-lucide="sun" class="block dark:hidden"></i>
                <i data-lucide="moon" class="hidden dark:block"></i>
            </button>
            <h1 class="text-2xl font-semibold text-center">
                施工照片排版輸出工具
            </h1>
            <p class="text-center text-sm mt-2">
                匯入多張照片自動處理排版，可自訂主題、標號、日期及頁碼，生成 HTML 檔案並列印為 PDF 報告。
            </p>
            <p class="text-center text-xs mt-1">製作者：陳政德</p>
        </header>

        <div class="glass-effect rounded-xl shadow-lg p-6 mb-6 sticky top-4 z-10">
            <div class="flex flex-col gap-4">
                <div class="flex items-end gap-4">
                    <div class="header-field flex-grow" style="min-width: 400px;">
                        <div class="input-group">
                            <label for="theme-name-input" class="text-sm font-bold text-blue-600">主題名稱：</label>
                            <input type="text" id="theme-name-input" placeholder="請輸入文件主題" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <input type="checkbox" id="show-theme-name" checked title="在報告中顯示主題名稱">
                    </div>
                    <div class="header-field" style="min-width: 320px;">
                        <div class="input-group">
                            <label for="construction-lot-select" class="text-sm font-bold text-blue-600">施工標別：</label>
                            <div class="flex items-center gap-2 mt-1">
                                <select id="construction-lot-select" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option>萬大線</option>
                                    <option>環狀線</option>
                                    <option>環狀線北環段</option>
                                    <option>環狀線南環段</option>
                                    <option>環狀線東環段</option>
                                    <option value="other">無</option>
                                </select>
                                <input type="text" id="construction-lot-input" placeholder="自行輸入補充文字" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <input type="checkbox" id="show-construction-lot" checked title="在報告中顯示施工標別">
                    </div>
                    <div class="header-field" style="min-width: 180px;">
                        <div class="input-group">
                             <label for="report-date-input" class="text-sm font-bold text-blue-600">日期：</label>
                             <div id="report-date-container" class="relative mt-1">
                                <input type="date" id="report-date-input" class="w-full pl-3 pr-2 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-transparent">
                                <span id="roc-date-display" class="text-base"></span>
                             </div>
                        </div>
                         <input type="checkbox" id="show-report-date" checked title="在報告中顯示日期">
                    </div>
                </div>
                
                <div class="flex justify-between items-end gap-4">
                    <div class="flex items-end gap-2">
                         <div id="photo-count-info" class="mr-4"></div>
                         <label id="select-photos-label" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg cursor-pointer transition-all shadow-sm hover:shadow-md" title="選擇圖片或 PDF 檔案匯入">
                            <i data-lucide="upload" class="w-5 h-5"></i>
                            <span class="font-medium">選擇照片/PDF</span>
                            <input type="file" multiple accept="image/jpeg,image/png,image/webp,image/tiff,image/heic,image/heif,image/jfif,application/pdf" id="file-input" class="hidden">
                        </label>
                        <div>
                            <select id="import-resolution" title="設定最終輸出的圖片品質" class="px-3 py-2.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="1.0">低 (檔案小)</option>
                                <option value="1.5" selected>中 (建議)</option>
                                <option value="2.0">高 (品質好)</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button id="layout-settings-btn" class="flex items-center gap-2 bg-teal-700 hover:bg-teal-800 text-white px-5 py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md" title="設定報告的頁面排版">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                            <span class="font-medium">版面</span>
                        </button>
                        <button id="presets-btn" class="flex items-center gap-2 bg-teal-700 hover:bg-teal-800 text-white px-5 py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md" title="儲存或載入常用的設定組合">
                            <i data-lucide="layout-template" class="w-5 h-5"></i>
                            <span class="font-medium">樣板</span>
                        </button>
                        <button id="pagination-settings-btn" class="flex items-center gap-2 bg-teal-700 hover:bg-teal-800 text-white px-5 py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md" title="自訂報告的頁碼樣式與範圍">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="m10 10-2 2 2 2"/><path d="M14 10h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2v-4Z"/></svg>
                            <span class="font-medium">頁碼</span>
                        </button>
                    </div>

                    <div class="flex items-center gap-2">
                        <button id="generate-html-btn" class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-5 py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md" title="將目前的設定與照片生成可列印的 HTML 報告">
                            <i data-lucide="file-code-2" class="w-5 h-5"></i>
                            <span id="generate-html-btn-text" class="font-medium">生成 HTML</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <input type="file" id="insert-file-input" class="hidden" accept="image/jpeg,image/png,image/webp,image/tiff,image/heic,image/heif,image/jfif,application/pdf">

        <main id="photo-list-container">
            <div id="empty-state" class="glass-effect rounded-lg p-12 text-center transition-all">
                <i data-lucide="image-down" class="w-16 h-16 mx-auto mb-4"></i>
                <p class="text-lg font-medium">尚未選擇檔案</p>
                <p class="text-sm mt-2">請點擊上方的「選擇照片/PDF」按鈕開始</p>
            </div>
            <div id="photo-grid" class="grid grid-cols-4 gap-6"></div>
        </main>
        
        <footer class="mt-12 glass-effect rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-semibold text-center mb-8">功能與操作說明</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                
                <div class="glass-effect rounded-lg p-6">
                    <div class="flex items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                        <h3 class="text-lg font-semibold">報告資訊設定</h3>
                    </div>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><b class="instruction-keyword">主題名稱/標別/日期：</b>輸入報告的基本資訊。日期欄位會自動顯示民國年。</li>
                        <li><b class="instruction-keyword">顯示選項：</b>透過欄位旁的 ✓ 核取方塊，可自由決定是否在最終報告的頁首顯示該項資訊。</li>
                    </ul>
                </div>
                
                <div class="glass-effect rounded-lg p-6">
                    <div class="flex items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-3"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path><line x1="16" y1="5" x2="22" y2="5"></line><line x1="19" y1="2" x2="19" y2="8"></line><path d="M12 18L12 12L15 15L12 12L9 15"></path></svg>
                        <h3 class="text-lg font-semibold">檔案匯入</h3>
                    </div>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><b class="instruction-keyword">選擇檔案：</b>支援多選，可同時匯入圖片 (JPG, PNG, HEIC) 或 PDF 檔案。</li>
                        <li><b class="instruction-keyword">PDF 匯入：</b>程式會自動將 PDF 的每一頁完整擷取成一張張圖片並匯入。</li>
                        <li><b class="instruction-keyword">匯入畫質：</b>可選擇「低/中/高」三種品質，此設定會影響 PDF 渲染的清晰度與最終報告的檔案大小。</li>
                    </ul>
                </div>
                
                <div class="glass-effect rounded-lg p-6">
                    <div class="flex items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 mr-3"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                        <h3 class="text-lg font-semibold">照片編輯區</h3>
                    </div>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><b class="instruction-keyword">編輯說明：</b>直接點擊照片下方的文字框即可輸入或修改說明，支援多行文字。</li>
                        <li><b class="instruction-keyword">刪除/插入：</b>滑鼠移至照片上方會顯示控制按鈕，可刪除單張照片，或在此照片後插入新檔案。</li>
                        <li><b class="instruction-keyword">預覽照片：</b>直接點擊照片縮圖，即可彈出大圖預覽視窗，方便檢視細節。</li>
                    </ul>
                </div>

                <div class="glass-effect rounded-lg p-6">
                    <div class="flex items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600 mr-3"><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M3 9h18"></path><path d="M9 21V9"></path></svg>
                        <h3 class="text-lg font-semibold">版面設定</h3>
                    </div>
                     <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><b class="instruction-keyword">頁面方向：</b>可選擇 A4 直式或橫式輸出。</li>
                        <li><b class="instruction-keyword">照片數量：</b>支援每頁 2, 4, 6, 8, 9, 10, 12 張等多種排版。</li>
                        <li><b class="instruction-keyword">顯示選項：</b>可自由選擇是否顯示說明文字與照片框線。</li>
                    </ul>
                </div>
                
                <div class="glass-effect rounded-lg p-6">
                    <div class="flex items-center mb-3">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600 mr-3"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                        <h3 class="text-lg font-semibold">樣板管理</h3>
                    </div>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><b class="instruction-keyword">儲存設定：</b>可將當前的所有設定（包含報告資訊、版面、頁碼、畫質等）儲存成一個樣板。</li>
                        <li><b class="instruction-keyword">快速載入：</b>點擊已儲存的樣板名稱即可一鍵套用所有設定，方便製作固定格式的報告。</li>
                    </ul>
                </div>

                 <div class="glass-effect rounded-lg p-6">
                    <div class="flex items-center mb-3">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600 mr-3"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path><path d="M8 7h6"></path><path d="m10 10-2 2 2 2"></path><path d="M14 10h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2v-4Z"></path></svg>
                        <h3 class="text-lg font-semibold">頁碼設定</h3>
                    </div>
                     <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><b class="instruction-keyword">啟用頁碼：</b>可完全開啟或關閉頁碼功能。</li>
                        <li><b class="instruction-keyword">自訂格式：</b>可設定頁碼位置、字體、顏色，並使用 `{page}` 和 `{total}` 變數自訂格式。</li>
                        <li><b class="instruction-keyword">套用範圍：</b>可指定頁碼僅顯示在特定頁數，例如 `2-10, 15`。</li>
                    </ul>
                </div>

            </div>
        </footer>
    </div>

    <script>
        // --- 應用程式狀態管理 ---
        const AppState = { IDLE: 'idle', PROCESSING_FILES: 'processing_files', GENERATING_HTML: 'generating_html' };
        let appState = AppState.IDLE;
        let photos = [];
        let presets = {};
        let reportInfo = { 
            themeName: '', constructionLot: '', reportDate: '',
            showThemeName: true, showConstructionLot: true, showReportDate: true,
            importResolution: 1.5
        };
        
        let layoutSettings = {
            orientation: 'portrait',
            photosPerPage: 2,
            showCaptions: true,
            showBorders: true
        };

        let paginationSettings = { 
            enabled: true, position: 'center', showTotal: true, fontSize: 12,
            fontColor: '#555555', format: '第 {page} 頁 / 共 {total} 頁', range: ''
        };
        let insertIndex = -1;

        // --- DOM 元素參考 ---
        const dom = {
            fileInput: document.getElementById('file-input'),
            insertFileInput: document.getElementById('insert-file-input'),
            themeNameInput: document.getElementById('theme-name-input'),
            constructionLotSelect: document.getElementById('construction-lot-select'),
            constructionLotInput: document.getElementById('construction-lot-input'),
            reportDateInput: document.getElementById('report-date-input'),
            rocDateDisplay: document.getElementById('roc-date-display'),
            selectPhotosLabel: document.getElementById('select-photos-label'),
            generateHtmlBtn: document.getElementById('generate-html-btn'),
            photoCountInfo: document.getElementById('photo-count-info'),
            emptyState: document.getElementById('empty-state'),
            photoGrid: document.getElementById('photo-grid'),
            loaderOverlay: document.getElementById('loader-overlay'),
            paginationSettingsBtn: document.getElementById('pagination-settings-btn'),
            paginationModal: document.getElementById('pagination-modal'),
            paginationModalClose: document.getElementById('pagination-modal-close'),
            paginationModalCloseIcon: document.getElementById('pagination-modal-close-icon'),
            paginationEnabled: document.getElementById('pagination-enabled'),
            paginationOptionsContainer: document.getElementById('pagination-options-container'),
            paginationPosition: document.getElementById('pagination-position'),
            paginationShowTotal: document.getElementById('pagination-show-total'),
            paginationFontSize: document.getElementById('pagination-font-size'),
            paginationFontColor: document.getElementById('pagination-font-color'),
            paginationFormat: document.getElementById('pagination-format'),
            paginationRange: document.getElementById('pagination-range'),
            presetsBtn: document.getElementById('presets-btn'),
            presetsModal: document.getElementById('presets-modal'),
            presetsModalClose: document.getElementById('presets-modal-close'),
            presetsModalCloseIcon: document.getElementById('presets-modal-close-icon'),
            presetNameInput: document.getElementById('preset-name-input'),
            savePresetBtn: document.getElementById('save-preset-btn'),
            presetsList: document.getElementById('presets-list'),
            layoutSettingsBtn: document.getElementById('layout-settings-btn'),
            layoutModal: document.getElementById('layout-modal'),
            layoutModalClose: document.getElementById('layout-modal-close'),
            layoutModalCloseIcon: document.getElementById('layout-modal-close-icon'),
            layoutOrientation: document.getElementById('layout-orientation'),
            photosPerPage: document.getElementById('photos-per-page'),
            showCaptions: document.getElementById('show-captions'),
            showBorders: document.getElementById('show-borders'),
            showThemeName: document.getElementById('show-theme-name'),
            showConstructionLot: document.getElementById('show-construction-lot'),
            showReportDate: document.getElementById('show-report-date'),
            importResolution: document.getElementById('import-resolution'),
            imagePreviewModal: document.getElementById('image-preview-modal'),
            previewImage: document.getElementById('preview-image'),
            imagePreviewClose: document.getElementById('image-preview-close'),
            themeToggle: document.getElementById('theme-toggle'),
        };

        // --- UI 回饋 (載入、錯誤、成功) ---
        const hideLoaderAndResetState = () => { dom.loaderOverlay.style.display = 'none'; setAppState(AppState.IDLE); };
        const showLoader = (text) => { dom.loaderOverlay.innerHTML = `<div class="loader"></div><p id="loader-text">${text}</p>`; dom.loaderOverlay.style.display = 'flex'; };
        const updateLoaderText = (text) => { const el = document.getElementById('loader-text'); if(el) el.textContent = text; };
        const showError = (message) => {
            dom.loaderOverlay.innerHTML = `<div class="glass-effect rounded-xl shadow-lg p-6 w-full max-w-lg relative text-center"><i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-red-500 mb-4"></i><h2 class="text-xl font-semibold text-gray-800 mb-2">發生錯誤</h2><p class="text-gray-600">${message}</p><button id="error-modal-close" class="mt-6 bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold">關閉</button></div>`;
            lucide.createIcons();
            dom.loaderOverlay.style.display = 'flex';
            document.getElementById('error-modal-close').addEventListener('click', hideLoaderAndResetState, { once: true });
        };
        const showSuccess = (downloadUrl, fileName) => {
            dom.loaderOverlay.innerHTML = `<div class="glass-effect rounded-xl shadow-lg p-6 w-full max-w-lg relative text-center"><i data-lucide="check-circle-2" class="w-12 h-12 mx-auto text-green-500 mb-4"></i><h2 class="text-xl font-semibold text-gray-800 mb-2">HTML 已生成！</h2><p class="text-gray-600 mb-4">請點擊下方按鈕下載檔案。</p><a href="${downloadUrl}" download="${fileName}" id="download-link" class="inline-block bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-semibold">下載檔案</a><br/><button id="success-modal-close" class="mt-6 text-sm text-gray-500 hover:text-gray-700 underline">關閉視窗</button></div>`;
            lucide.createIcons();
            dom.loaderOverlay.style.display = 'flex';
            const closeBtn = document.getElementById('success-modal-close');
            const downloadLink = document.getElementById('download-link');
            const closeAction = () => { URL.revokeObjectURL(downloadUrl); hideLoaderAndResetState(); };
            closeBtn.addEventListener('click', closeAction, { once: true });
            downloadLink.addEventListener('click', () => setTimeout(closeAction, 300), { once: true });
        };

        // --- 核心演算法：狀態管理與 UI 更新 ---
        const setAppState = (newState) => {
            appState = newState;
            const isIdle = appState === AppState.IDLE;
            const hasPhotos = photos.length > 0;
            dom.fileInput.disabled = !isIdle;
            dom.selectPhotosLabel.classList.toggle('disabled-label', !isIdle);
            dom.generateHtmlBtn.disabled = !isIdle || !hasPhotos;
        };
        
        const adjustTextareaHeight = (textarea) => { textarea.style.height = 'auto'; textarea.style.height = `${textarea.scrollHeight}px`; };
        
        const renderPhotos = () => {
            dom.photoGrid.innerHTML = '';
            const hasPhotos = photos.length > 0;
            dom.emptyState.style.display = hasPhotos ? 'none' : 'block';
            dom.photoCountInfo.innerHTML = hasPhotos ? `<span class="font-medium text-sm">共 ${photos.length} 張照片</span>` : '';
             if(!hasPhotos) hideLoaderAndResetState();

            photos.forEach((photo, index) => {
                const card = document.createElement('div');
                card.className = 'photo-card glass-effect rounded-lg shadow-md overflow-hidden flex flex-col transition-all';
                card.innerHTML = `<div class="relative group"><div class="h-48 flex items-center justify-center bg-black/5 overflow-hidden cursor-zoom-in"><img src="${photo.url}" alt="照片 ${index + 1}" class="max-w-full max-h-full object-contain"></div><div class="photo-controls absolute top-2 right-2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-all bg-black/40 p-1 rounded-full"><button title="在此後插入照片" class="insert-btn" data-index="${index}"><i data-lucide="plus-circle" class="w-5 h-5 text-white hover:text-blue-300"></i></button><button title="刪除照片" class="remove-btn" data-id="${photo.id}"><i data-lucide="trash-2" class="w-5 h-5 text-white hover:text-red-400"></i></button></div></div><div class="p-4 flex-grow flex flex-col"><label class="block text-sm font-medium mb-1">說明文字 #${index + 1}</label><textarea data-id="${photo.id}" placeholder="請輸入說明..." class="description-textarea text-input w-full text-center px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow">${photo.description}</textarea></div>`;
                dom.photoGrid.appendChild(card);
                adjustTextareaHeight(card.querySelector('textarea'));
            });
            lucide.createIcons();
        };

        const convertImageToPngData = (url, maxDimension) => new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxDimension) { height *= maxDimension / width; width = maxDimension; }
                } else {
                    if (height > maxDimension) { width *= maxDimension / height; height = maxDimension; }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = (e) => reject(new Error(`圖片載入失敗: ${url}`));
            img.src = url;
        });
        
        const renderPdfPagesAsImages = async (file) => {
            const images = [];
            const data = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(data).promise;
            const scale = parseFloat(dom.importResolution.value);

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                updateLoaderText(`正在渲染 PDF 第 ${pageNum} / ${pdf.numPages} 頁...`);
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                images.push({ 
                    id: Date.now() + Math.random(), 
                    url: canvas.toDataURL('image/jpeg', 0.9),
                    description: '' 
                });
            }
            return images;
        };

        const handleFileSelect = async (e, isInsertion = false) => {
            if (appState !== AppState.IDLE) return;
            setAppState(AppState.PROCESSING_FILES);
            
            const files = Array.from(e.target.files);
            e.target.value = '';
            if (files.length === 0) { setAppState(AppState.IDLE); return; }

            showLoader('準備處理檔案...');
            dom.emptyState.style.display = 'none';

            let newPhotos = [];
            let errorOccurred = false;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateLoaderText(`正在處理檔案 ${i + 1} / ${files.length}: ${file.name}`);
                
                try {
                    if (file.type === 'application/pdf') {
                        const pdfImages = await renderPdfPagesAsImages(file);
                        newPhotos.push(...pdfImages);
                    } else {
                        let processedFile = file;
                        const fileName = file.name.toLowerCase();
                        if (fileName.endsWith('.heic') || fileName.endsWith('.heif')) {
                            updateLoaderText(`正在轉換 HEIC 檔案...`);
                            const convertedBlob = await heic2any({ blob: file, toType: "image/png" });
                            processedFile = new File([convertedBlob], `${file.name.split('.')[0]}.png`, { type: 'image/png' });
                        }
                        newPhotos.push({ 
                            id: Date.now() + Math.random(), 
                            url: URL.createObjectURL(processedFile), 
                            description: '' 
                        });
                    }
                } catch (err) {
                    console.error(`處理檔案失敗: ${file.name}`, err);
                    showError(`檔案 "${file.name}" 處理失敗。`);
                    errorOccurred = true;
                    break; 
                }
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            if (errorOccurred) {
                newPhotos.forEach(p => URL.revokeObjectURL(p.url));
                renderPhotos();
            } else {
                 if (isInsertion && insertIndex !== -1) { photos.splice(insertIndex + 1, 0, ...newPhotos); } 
                 else { photos.push(...newPhotos); }
                renderPhotos();
                hideLoaderAndResetState();
            }
        };

        const updatePhotoText = (id, value) => { const photo = photos.find(p => p.id === id); if (photo) photo.description = value; };
        const removePhoto = (id) => { const photo = photos.find(p => p.id === id); if (photo) URL.revokeObjectURL(photo.url); photos = photos.filter(p => p.id !== id); renderPhotos(); };
        const toRocDate = (dateString, format = 'YYY/MM/DD') => { if (!dateString) return ''; const date = new Date(dateString); if (isNaN(date.getTime())) return ''; const year = date.getFullYear() - 1911; const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); return format.replace('YYY', year).replace('MM', month).replace('DD', day); };
        const parsePageRange = (rangeStr, totalPages) => { const pages = new Set(); if (!rangeStr || rangeStr.trim() === '') { for (let i = 1; i <= totalPages; i++) pages.add(i); return pages; } const parts = rangeStr.split(','); for (const part of parts) { const trimmedPart = part.trim(); if (trimmedPart.includes('-')) { const [start, end] = trimmedPart.split('-').map(Number); if (!isNaN(start) && !isNaN(end)) { for (let i = start; i <= end; i++) { if (i > 0 && i <= totalPages) pages.add(i); } } } else { const page = Number(trimmedPart); if (!isNaN(page) && page > 0 && page <= totalPages) pages.add(page); } } return pages; };
        
        const loadPresets = () => { const storedPresets = localStorage.getItem('photoReportPresets'); presets = storedPresets ? JSON.parse(storedPresets) : {}; renderPresets(); };
        const savePresets = () => { localStorage.setItem('photoReportPresets', JSON.stringify(presets)); renderPresets(); };
        const renderPresets = () => { dom.presetsList.innerHTML = ''; const presetKeys = Object.keys(presets); if (presetKeys.length === 0) { dom.presetsList.innerHTML = `<p class="text-sm text-center py-4">尚無儲存的樣板</p>`; return; } presetKeys.forEach(name => { const item = document.createElement('div'); item.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700'; item.innerHTML = `<span class="font-medium cursor-pointer load-preset-btn" data-name="${name}">${name}</span><button class="delete-preset-btn text-gray-400 hover:text-red-500" data-name="${name}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`; dom.presetsList.appendChild(item); }); lucide.createIcons(); };

        const handleSavePreset = () => {
            const name = dom.presetNameInput.value.trim();
            if (!name) { showError("請輸入樣板名稱！"); return; }
            presets[name] = { ...reportInfo, paginationSettings: { ...paginationSettings }, layoutSettings: { ...layoutSettings } };
            savePresets();
            dom.presetNameInput.value = '';
            dom.presetsModal.style.display = 'none';
        };
        
        const applySettings = (settings) => {
             reportInfo = { ...reportInfo, ...settings };
             dom.themeNameInput.value = reportInfo.themeName || '';
             dom.constructionLotSelect.value = reportInfo.constructionLotSelect || '萬大線';
             dom.constructionLotInput.value = reportInfo.constructionLotInput || '';
             dom.showThemeName.checked = typeof reportInfo.showThemeName === 'boolean' ? reportInfo.showThemeName : true;
             dom.showConstructionLot.checked = typeof reportInfo.showConstructionLot === 'boolean' ? reportInfo.showConstructionLot : true;
             dom.showReportDate.checked = typeof reportInfo.showReportDate === 'boolean' ? reportInfo.showReportDate : true;
             dom.importResolution.value = reportInfo.importResolution || 1.5;

             if (settings.paginationSettings) {
                paginationSettings = { ...paginationSettings, ...settings.paginationSettings };
                dom.paginationEnabled.checked = paginationSettings.enabled;
                dom.paginationPosition.value = paginationSettings.position;
                dom.paginationShowTotal.checked = paginationSettings.showTotal;
                dom.paginationFontSize.value = paginationSettings.fontSize;
                dom.paginationFontColor.value = paginationSettings.fontColor;
                dom.paginationFormat.value = paginationSettings.format;
                dom.paginationRange.value = paginationSettings.range;
             }
             if (settings.layoutSettings) {
                layoutSettings = { ...layoutSettings, ...settings.layoutSettings };
                dom.layoutOrientation.value = layoutSettings.orientation;
                dom.photosPerPage.value = layoutSettings.photosPerPage;
                dom.showCaptions.checked = layoutSettings.showCaptions;
                dom.showBorders.checked = typeof layoutSettings.showBorders === 'boolean' ? layoutSettings.showBorders : true;
             }
             updateReportInfo();
             togglePaginationOptions();
        };

        const handleLoadPreset = (name) => { if (presets[name]) { applySettings(presets[name]); dom.presetsModal.style.display = 'none'; } };
        const handleDeletePreset = (name) => { delete presets[name]; savePresets(); };

        const getGridDimensions = (count) => {
            switch (parseInt(count)) {
                case 2: return { cols: 1, rows: 2 }; case 4: return { cols: 2, rows: 2 };
                case 6: return { cols: 2, rows: 3 }; case 8: return { cols: 2, rows: 4 };
                case 9: return { cols: 3, rows: 3 }; case 10: return { cols: 2, rows: 5 };
                case 12: return { cols: 3, rows: 4 }; default: return { cols: 1, rows: 2 };
            }
        };

        const generateHTML = async () => {
            if (appState !== AppState.IDLE || photos.length === 0) return;
            setAppState(AppState.GENERATING_HTML);
            showLoader('正在生成 HTML 檔案...');

            try {
                const resolutionMap = { '1.0': 800, '1.5': 1280, '2.0': 1920 };
                const maxDimension = resolutionMap[reportInfo.importResolution] || 1280;

                let imageDatas = [];
                for(let i = 0; i < photos.length; i++) {
                    updateLoaderText(`正在轉換圖片 ${i + 1} / ${photos.length}...`);
                    const data = await convertImageToPngData(photos[i].url, maxDimension);
                    imageDatas.push(data);
                }
                
                updateLoaderText('正在組合 HTML 頁面...');
                await new Promise(resolve => setTimeout(resolve, 50));

                const photosPerPage = layoutSettings.photosPerPage;
                const totalPages = Math.ceil(imageDatas.length / photosPerPage);
                const pagesWithFooter = parsePageRange(paginationSettings.range, totalPages);
                
                const { cols, rows } = getGridDimensions(photosPerPage);
                const isLandscape = layoutSettings.orientation === 'landscape';
                const pageDimensions = isLandscape ? { width: '25.7cm', height: '17cm' } : { width: '17cm', height: '25.7cm' };
                
                let dynamicStyles = `@page { size: A4 ${layoutSettings.orientation}; margin: 2cm; } .page { width: ${pageDimensions.width}; height: ${pageDimensions.height}; page-break-after: always; box-sizing: border-box; display: flex; flex-direction: column; } .content-area { flex-grow: 1; display: grid; grid-template-columns: repeat(${cols}, 1fr); grid-template-rows: repeat(${rows}, 1fr); gap: 0.3cm; min-height: 0; } .photo-section { min-height: 0; display: flex; flex-direction: column; border: ${layoutSettings.showBorders ? '0.5pt solid #aaa' : 'none'}; box-sizing: border-box; } .photo-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 0.2cm; box-sizing: border-box; overflow: hidden; min-height: 0; } .photo-container img { height: 100%; width: auto; max-width: 100%; object-fit: contain; } .caption { text-align: center; padding: 0.2cm; border-top: ${layoutSettings.showBorders ? '0.5pt solid #aaa' : 'none'}; box-sizing: border-box; font-size: 14px; flex-shrink: 0; white-space: pre-wrap; word-break: break-word; }`;
                if (!layoutSettings.showCaptions) { dynamicStyles += `.caption { display: none; }`; }

                let bodyContent = '';
                for (let i = 0; i < imageDatas.length; i += photosPerPage) {
                    const currentPage = (i / photosPerPage) + 1;
                    
                    let paginationHtml = '';
                    if(paginationSettings.enabled && pagesWithFooter.has(currentPage)) {
                        let pageText = paginationSettings.format.replace('{page}', currentPage).replace('{total}', totalPages);
                        paginationHtml = `<div class="footer" style="text-align:${paginationSettings.position}; font-size:${paginationSettings.fontSize}px; color:${paginationSettings.fontColor};">${pageText}</div>`;
                    }

                    bodyContent += `<div class="page">`;
                    if (i === 0) {
                        bodyContent += `<div class="header">
                            ${reportInfo.showThemeName && reportInfo.themeName ? `<h1 class="main-title">${reportInfo.themeName}</h1>` : ''}
                            <div class="sub-header">
                                ${reportInfo.showConstructionLot && reportInfo.constructionLot ? `<p>施工標別：${reportInfo.constructionLot}</p>` : ''}
                                ${reportInfo.showReportDate && reportInfo.reportDate ? `<p>日期：${toRocDate(reportInfo.reportDate)}</p>` : ''}
                            </div>
                        </div>`;
                    }

                    bodyContent += `<div class="content-area">`;
                    const formatDescription = (desc) => (desc || '&nbsp;').replace(/\n/g, '<br>');

                    for (let j = 0; j < photosPerPage; j++) {
                        const photoIndex = i + j;
                        if (photoIndex < imageDatas.length) {
                            bodyContent += `<div class="photo-section"><div class="photo-container"><img src="${imageDatas[photoIndex]}" /></div><div class="caption">${formatDescription(photos[photoIndex].description)}</div></div>`;
                        } else {
                            bodyContent += `<div style="border: none;"></div>`;
                        }
                    }
                    bodyContent += `</div>${paginationHtml}</div>`;
                }

                const htmlTemplate = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${reportInfo.themeName || '照片報告'}</title><style>body { margin: 0; font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; -webkit-print-color-adjust: exact; color-adjust: exact; } .header { margin-bottom: 0.5cm; flex-shrink: 0; } .header .main-title { font-size: 28px; font-weight: bold; text-align: center; margin: 0 0 8px 0; } .header .sub-header { font-size: 14px; text-align: left; } .header .sub-header p { margin: 2px 0; font-weight: bold; } .footer { flex-shrink: 0; padding-top: 0.5cm; box-sizing: border-box; } ${dynamicStyles}</style></head><body>${bodyContent}</body></html>`;

                const blob = new Blob([htmlTemplate], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const dateToFormat = reportInfo.reportDate ? new Date(reportInfo.reportDate) : new Date();
                const rocYear = dateToFormat.getFullYear() - 1911;
                const month = String(dateToFormat.getMonth() + 1).padStart(2, '0');
                const day = String(dateToFormat.getDate()).padStart(2, '0');
                const rocDateStr = `${rocYear}-${month}-${day}`;
                
                const fileName = `${reportInfo.themeName || '照片報告'}_${layoutSettings.photosPerPage}張_${rocDateStr}.html`;
                
                showSuccess(url, fileName);
                
            } catch (error) {
                console.error('HTML 生成失敗:', error);
                showError(`產生過程發生問題：${error.message}`);
            }
        };
        
        const saveSessionData = () => { const data = { ...reportInfo }; delete data.constructionLotSelect; delete data.constructionLotInput; localStorage.setItem('reportSession', JSON.stringify(data)); };
        const loadSessionData = () => { const data = JSON.parse(localStorage.getItem('reportSession')); if (data) { applySettings(data); } };
        const updateReportInfo = () => { 
            const selectValue = dom.constructionLotSelect.value; 
            const inputValue = dom.constructionLotInput.value.trim(); 
            let combinedLot = selectValue === 'other' ? inputValue : selectValue; 
            if (selectValue !== 'other' && inputValue) { combinedLot = `${selectValue} ${inputValue}`; } 
            reportInfo.themeName = dom.themeNameInput.value;
            reportInfo.constructionLot = combinedLot;
            reportInfo.reportDate = dom.reportDateInput.value;
            reportInfo.showThemeName = dom.showThemeName.checked;
            reportInfo.showConstructionLot = dom.showConstructionLot.checked;
            reportInfo.showReportDate = dom.showReportDate.checked;
            reportInfo.importResolution = dom.importResolution.value;
            dom.rocDateDisplay.textContent = toRocDate(reportInfo.reportDate); 
            saveSessionData(); 
        }

        [dom.fileInput, dom.insertFileInput].forEach(input => input.addEventListener('change', (e) => handleFileSelect(e, input === dom.insertFileInput)));
        [dom.themeNameInput, dom.constructionLotSelect, dom.constructionLotInput, dom.reportDateInput, dom.showThemeName, dom.showConstructionLot, dom.showReportDate, dom.importResolution].forEach(input => { input.addEventListener('input', updateReportInfo); input.addEventListener('change', updateReportInfo); });
        dom.generateHtmlBtn.addEventListener('click', generateHTML);
        dom.photoGrid.addEventListener('input', (e) => { if (e.target.classList.contains('text-input')) { const id = parseFloat(e.target.dataset.id); updatePhotoText(id, e.target.value); if(e.target.tagName === 'TEXTAREA') { adjustTextareaHeight(e.target); } } });
        
        dom.photoGrid.addEventListener('click', (e) => { 
            const button = e.target.closest('button'); 
            if (button) { // Handle button clicks (delete, insert)
                if (appState === AppState.PROCESSING_FILES) return; 
                if (button.classList.contains('remove-btn')) { removePhoto(parseFloat(button.dataset.id)); } 
                else if (button.classList.contains('insert-btn')) { insertIndex = parseInt(button.dataset.index, 10); dom.insertFileInput.click(); }
            } else if (e.target.tagName === 'IMG') { // Handle image preview click
                dom.previewImage.src = e.target.src;
                dom.imagePreviewModal.style.display = 'flex';
            }
        });

        const closePreviewModal = () => { dom.imagePreviewModal.style.display = 'none'; dom.previewImage.src = ''; };
        dom.imagePreviewModal.addEventListener('click', closePreviewModal);
        
        const setupModal = (btn, modal, closeBtn, closeIcon) => { btn.addEventListener('click', () => modal.style.display = 'flex'); const closeModal = () => modal.style.display = 'none'; closeBtn.addEventListener('click', closeModal); closeIcon.addEventListener('click', closeModal); };
        setupModal(dom.layoutSettingsBtn, dom.layoutModal, dom.layoutModalClose, dom.layoutModalCloseIcon);
        setupModal(dom.paginationSettingsBtn, dom.paginationModal, dom.paginationModalClose, dom.paginationModalCloseIcon);
        setupModal(dom.presetsBtn, dom.presetsModal, dom.presetsModalClose, dom.presetsModalCloseIcon);

        const updatePaginationSettings = (key, value) => { paginationSettings[key] = value; };
        const togglePaginationOptions = () => { const isEnabled = dom.paginationEnabled.checked; dom.paginationOptionsContainer.classList.toggle('disabled', !isEnabled); dom.paginationOptionsContainer.querySelectorAll('input, select').forEach(input => input.disabled = !isEnabled); };
        dom.paginationEnabled.addEventListener('change', () => { paginationSettings.enabled = dom.paginationEnabled.checked; togglePaginationOptions(); });
        dom.paginationPosition.addEventListener('change', (e) => updatePaginationSettings('position', e.target.value));
        dom.paginationFontSize.addEventListener('input', (e) => updatePaginationSettings('fontSize', e.target.value));
        dom.paginationFontColor.addEventListener('input', (e) => updatePaginationSettings('fontColor', e.target.value));
        dom.paginationRange.addEventListener('input', (e) => updatePaginationSettings('range', e.target.value));
        const syncPaginationFormat = () => { const isChecked = dom.paginationShowTotal.checked; let currentFormat = dom.paginationFormat.value; const hasTotal = currentFormat.includes('{total}'); const totalRegex = /(\s*(\/|,|，)\s*(共|of)\s*{total}\s*(頁|pages|)?)/i; if (isChecked && !hasTotal) { currentFormat += ' / 共 {total} 頁'; } else if (!isChecked && hasTotal) { currentFormat = currentFormat.replace(totalRegex, '').trim(); } dom.paginationFormat.value = currentFormat; updatePaginationSettings('format', currentFormat); updatePaginationSettings('showTotal', isChecked); };
        dom.paginationFormat.addEventListener('input', (e) => { const format = e.target.value; const hasTotal = format.includes('{total}'); dom.paginationShowTotal.checked = hasTotal; updatePaginationSettings('format', format); updatePaginationSettings('showTotal', hasTotal); });
        dom.paginationShowTotal.addEventListener('change', syncPaginationFormat);

        dom.layoutOrientation.addEventListener('change', (e) => layoutSettings.orientation = e.target.value);
        dom.photosPerPage.addEventListener('change', (e) => layoutSettings.photosPerPage = parseInt(e.target.value, 10));
        dom.showCaptions.addEventListener('change', (e) => layoutSettings.showCaptions = e.target.checked);
        dom.showBorders.addEventListener('change', (e) => layoutSettings.showBorders = e.target.checked);

        dom.savePresetBtn.addEventListener('click', handleSavePreset);
        dom.presetsList.addEventListener('click', (e) => { const loadBtn = e.target.closest('.load-preset-btn'); const deleteBtn = e.target.closest('.delete-preset-btn'); if (loadBtn) { handleLoadPreset(loadBtn.dataset.name); } else if (deleteBtn) { handleDeletePreset(deleteBtn.dataset.name); } });
        
        // 主題切換邏輯
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
            } else {
                document.documentElement.classList.add('light');
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('theme', theme);
        };
        dom.themeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });


        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }
            
            loadSessionData();
            loadPresets();
            if (!dom.reportDateInput.value) { const today = new Date(); dom.reportDateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; }
            updateReportInfo(); 
            renderPhotos();
            lucide.createIcons();
            
            dom.paginationEnabled.checked = paginationSettings.enabled;
            togglePaginationOptions();
            dom.layoutOrientation.value = layoutSettings.orientation;
            dom.photosPerPage.value = layoutSettings.photosPerPage;
            dom.showCaptions.checked = layoutSettings.showCaptions;
            dom.showBorders.checked = layoutSettings.showBorders;
        });
    </script>
</body>
</html>
