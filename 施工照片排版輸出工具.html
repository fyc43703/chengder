<!DOCTYPE html><html lang="zh-Hant"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>施工照片排版輸出工具</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-light.min.css">
<style>
      /* General Styles */
      html, body {
        margin: 0;
        padding: 24px;
        background: #FFFFFF;
        color: #1d1d1f;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        font-size: 15px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      h1, h2, h3, h4, h5, h6, b, strong {
        font-weight: 600; /* Semibold for macOS look */
      }
      h1 { font-weight: 700; } /* Bold for main title */
      
      /* Explicit list styles for consistent rendering in html2canvas */
      ul, ol { padding-left: 2em; margin-top: 1em; margin-bottom: 1em; }
      ul { list-style-type: disc; }
      ol { list-style-type: decimal; }
      li { display: list-item; }

      .hljs-container {
        padding: 1.5rem;
        border-radius: .75rem;
        overflow-x: auto;
        background: #fcfcfd;
        border: 1px solid #d2d2d7;
      }
      .text-highlight{background:linear-gradient(180deg,transparent 25%,#B3D7FF 25%,#B3D7FF 75%,transparent 75%);padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-multiline{background:linear-gradient(180deg,transparent 25%,#B3D7FF 25%,#B3D7FF 75%,transparent 75%);background-size:100% 1.5em;background-repeat:repeat;padding:0 2px;margin:0;display:inline;line-height:inherit;box-decoration-break:clone;-webkit-box-decoration-break:clone;border-radius:2px;font-weight:500}
      .text-highlight-error{background:linear-gradient(180deg,transparent 25%,#FFD7D8 25%,#FFD7D8 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#D92525}
      .text-highlight-success{background:linear-gradient(180deg,transparent 25%,#D4EDDA 25%,#D4EDDA 75%,transparent 75%);padding:0 2px;border-radius:2px;color:#155724}
    </style></head><body><div style="max-width:1200px;margin:0 auto"><!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>施工照片排版輸出工具</title>

    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. 引入 HEIC 轉換工具 -->
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <style>
        /* **修正**: macOS 風格樣式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
            background-color: #f5f5f7;
        }
        .transition-all {
            transition: all 0.2s ease-in-out;
        }
        .glass-effect {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        button:disabled, label.disabled-label {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .photo-card:hover .photo-controls {
            opacity: 1;
        }
        .loader-overlay, .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
            color: #333;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .loader-overlay {
            background-color: rgba(245, 245, 247, 0.7);
        }
        .modal-overlay {
             background-color: rgba(0, 0, 0, 0.4);
        }
        .loader {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .traffic-lights {
            position: absolute;
            top: 1.25rem;
            left: 1.25rem;
            display: flex;
            gap: 0.5rem;
        }
        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .traffic-light.red { background-color: #ff5f56; }
        .traffic-light.yellow { background-color: #ffbd2e; }
        .traffic-light.green { background-color: #27c93f; }
        #report-date-container {
            position: relative;
        }
        #roc-date-display {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            background-color: white;
            padding-right: 0.5rem;
            color: #333;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0.5;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen p-8">
    
    <!-- 全螢幕載入指示器 -->
    <div id="loader-overlay" class="loader-overlay" style="display: none;">
        <div class="loader"></div>
        <p id="loader-text">處理中...</p>
    </div>
    
    <!-- 頁碼設定 Modal -->
    <div id="pagination-modal" class="modal-overlay" style="display: none;">
        <div class="glass-effect rounded-xl shadow-lg p-6 w-full max-w-lg relative">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">頁碼設定</h2>
            <div class="space-y-4 text-sm">
                <div>
                    <label for="pagination-position" class="font-medium text-gray-600">頁碼位置：</label>
                    <select id="pagination-position" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/80">
                        <option value="center">頁尾置中</option>
                        <option value="left">頁尾靠左</option>
                        <option value="right">頁尾靠右</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="pagination-font-size" class="font-medium text-gray-600">字體大小：</label>
                        <input type="number" id="pagination-font-size" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/80" value="12">
                    </div>
                    <div>
                        <label for="pagination-font-color" class="font-medium text-gray-600">字體顏色：</label>
                        <input type="color" id="pagination-font-color" class="w-full mt-1 h-10 border border-gray-300 rounded-lg cursor-pointer" value="#555555">
                    </div>
                </div>

                <div>
                    <label for="pagination-format" class="font-medium text-gray-600">頁碼格式：</label>
                    <input type="text" id="pagination-format" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/80">
                    <p class="text-xs text-gray-500 mt-1">可用變數：{page} (目前頁), {total} (總頁數)</p>
                </div>
                
                 <div>
                     <label for="pagination-range" class="font-medium text-gray-600">套用頁碼範圍 (可留白)：</label>
                     <input type="text" id="pagination-range" placeholder="例如: 2-10, 15 (留白則全部套用)" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/80">
                </div>

                <div class="flex items-center pt-2">
                    <input type="checkbox" id="pagination-show-total" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="pagination-show-total" class="ml-2 block text-gray-900">顯示總頁數</label>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button id="pagination-modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded-lg font-semibold">關閉</button>
            </div>
             <button id="pagination-modal-close-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>


    <div id="app" class="max-w-7xl mx-auto">
        <!-- 標題 -->
        <header class="glass-effect relative rounded-xl shadow-lg p-6 mb-6">
            <div class="traffic-lights">
                <div class="traffic-light red"></div>
                <div class="traffic-light yellow"></div>
                <div class="traffic-light green"></div>
            </div>
            <h1 class="text-2xl font-semibold text-gray-800 text-center">
                施工照片排版輸出工具
            </h1>
            <p class="text-center text-gray-500 text-sm mt-2">
                匯入多張照片自動處理1頁2張排版，可自訂主題、標號、日期及頁碼，生成 HTML 檔案並列印為 PDF 報告。
            </p>
            <p class="text-center text-gray-400 text-xs mt-1">製作者：陳政德</p>
        </header>

        <!-- 操作面板 -->
        <div class="glass-effect rounded-xl shadow-lg p-6 mb-6 sticky top-4 z-10">
            <div class="flex flex-col gap-4">
                <!-- 第一行: 輸入區 -->
                <div class="flex items-end gap-4">
                    <div class="flex-grow" style="min-width: 400px;">
                        <label for="theme-name-input" class="text-sm font-bold text-blue-600">主題名稱：</label>
                        <input type="text" id="theme-name-input" placeholder="請輸入文件主題" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end gap-2" style="min-width: 320px;">
                         <div class="flex-grow">
                            <label for="construction-lot-select" class="text-sm font-bold text-blue-600">施工標別：</label>
                            <select id="construction-lot-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option>萬大線</option>
                                <option>環狀線</option>
                                <option>環狀線北環段</option>
                                <option>環狀線南環段</option>
                                <option>東環段</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                         <div class="flex-shrink">
                             <input type="text" id="construction-lot-input" placeholder="自行輸入補充文字" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div style="min-width: 180px;">
                         <label for="report-date-input" class="text-sm font-bold text-blue-600">日期：</label>
                         <div id="report-date-container" class="relative mt-1">
                            <input type="date" id="report-date-input" class="w-full pl-3 pr-2 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-transparent">
                            <span id="roc-date-display" class="text-base"></span>
                         </div>
                    </div>
                </div>
                
                <!-- 第二行: 按鈕區 -->
                <div class="flex justify-end items-end gap-4">
                     <label id="select-photos-label" class="flex items-center gap-2 bg-[#007aff] hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg cursor-pointer transition-all shadow-sm hover:shadow-md">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <span class="font-medium">選擇照片</span>
                        <input type="file" multiple accept="image/jpeg,image/png,image/webp,image/tiff,image/heic,image/heif,image/jfif" id="file-input" class="hidden">
                    </label>
                    <div id="photo-count-info" class="text-gray-500 mr-auto"></div>
                    <!-- **修正**: 直接嵌入 SVG 圖示 -->
                    <button id="pagination-settings-btn" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-5 py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-numbered"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="m10 10-2 2 2 2"/><path d="M14 10h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2v-4Z"/></svg>
                        <span class="font-medium">頁碼設定</span>
                    </button>
                    <button id="generate-html-btn" class="flex items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white px-5 py-2.5 rounded-lg transition-all shadow-sm hover:shadow-md">
                        <i data-lucide="file-code-2" class="w-5 h-5"></i>
                        <span id="generate-html-btn-text" class="font-medium">生成 HTML</span>
                    </button>
                </div>
            </div>
        </div>
        
        <input type="file" id="insert-file-input" class="hidden" accept="image/jpeg,image/png,image/webp,image/tiff,image/heic,image/heif,image/jfif">

        <main id="photo-list-container">
            <div id="empty-state" class="glass-effect rounded-lg p-12 text-center transition-all">
                <i data-lucide="image-down" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
                <p class="text-gray-600 text-lg font-medium">尚未選擇照片</p>
                <p class="text-gray-500 text-sm mt-2">請點擊上方的「選擇照片」按鈕開始</p>
            </div>
            <div id="photo-grid" class="grid grid-cols-4 gap-6"></div>
        </main>
    </div>

    <script>
        // --- 應用程式狀態管理 ---
        const AppState = {
            IDLE: 'idle',
            PROCESSING_IMAGES: 'processing_images',
            GENERATING_HTML: 'generating_html'
        };
        let appState = AppState.IDLE;
        let photos = [];
        let reportInfo = { themeName: '', constructionLot: '', reportDate: '' };
        let paginationSettings = { 
            position: 'center', 
            showTotal: true,
            fontSize: 12,
            fontColor: '#555555',
            format: '第 {page} 頁 / 共 {total} 頁',
            range: ''
        };
        let insertIndex = -1;

        // --- DOM 元素參考 ---
        const dom = {
            fileInput: document.getElementById('file-input'),
            insertFileInput: document.getElementById('insert-file-input'),
            themeNameInput: document.getElementById('theme-name-input'),
            constructionLotSelect: document.getElementById('construction-lot-select'),
            constructionLotInput: document.getElementById('construction-lot-input'),
            reportDateInput: document.getElementById('report-date-input'),
            rocDateDisplay: document.getElementById('roc-date-display'),
            selectPhotosLabel: document.getElementById('select-photos-label'),
            generateHtmlBtn: document.getElementById('generate-html-btn'),
            photoCountInfo: document.getElementById('photo-count-info'),
            emptyState: document.getElementById('empty-state'),
            photoGrid: document.getElementById('photo-grid'),
            loaderOverlay: document.getElementById('loader-overlay'),
            loaderText: document.getElementById('loader-text'),
            paginationSettingsBtn: document.getElementById('pagination-settings-btn'),
            paginationModal: document.getElementById('pagination-modal'),
            paginationModalClose: document.getElementById('pagination-modal-close'),
            paginationModalCloseIcon: document.getElementById('pagination-modal-close-icon'),
            paginationPosition: document.getElementById('pagination-position'),
            paginationShowTotal: document.getElementById('pagination-show-total'),
            paginationFontSize: document.getElementById('pagination-font-size'),
            paginationFontColor: document.getElementById('pagination-font-color'),
            paginationFormat: document.getElementById('pagination-format'),
            paginationRange: document.getElementById('pagination-range'),
        };

        // --- 核心演算法：狀態管理與 UI 更新 ---
        const setAppState = (newState) => {
            appState = newState;
            const isIdle = appState === AppState.IDLE;
            const hasPhotos = photos.length > 0;

            dom.fileInput.disabled = !isIdle;
            if (isIdle) {
                dom.selectPhotosLabel.classList.remove('disabled-label');
            } else {
                dom.selectPhotosLabel.classList.add('disabled-label');
            }
            
            dom.generateHtmlBtn.disabled = !isIdle || !hasPhotos;

            if (isIdle) {
                hideLoader();
            } else {
                let message = '處理中...';
                switch (appState) {
                    case AppState.PROCESSING_IMAGES: message = '正在處理照片...'; break;
                    case AppState.GENERATING_HTML: message = '正在生成 HTML...'; break;
                }
                showLoader(message);
            }
        };

        const showLoader = (text) => {
            dom.loaderText.textContent = text;
            dom.loaderOverlay.style.display = 'flex';
        };
        const hideLoader = () => {
            dom.loaderOverlay.style.display = 'none';
        };

        // --- 渲染與資料處理 ---
        const renderPhotos = () => {
            dom.photoGrid.innerHTML = '';
            const hasPhotos = photos.length > 0;
            dom.emptyState.style.display = hasPhotos ? 'none' : 'block';
            
            dom.photoCountInfo.innerHTML = hasPhotos ? `<span class="font-medium text-sm">共 ${photos.length} 張照片</span>` : '';
            
            setAppState(AppState.IDLE); 

            photos.forEach((photo, index) => {
                const card = document.createElement('div');
                card.className = 'photo-card glass-effect rounded-lg shadow-md overflow-hidden flex flex-col transition-all hover:shadow-lg hover:-translate-y-1';
                card.innerHTML = `
                    <div class="relative">
                        <div class="h-48 flex items-center justify-center bg-black/5 overflow-hidden"><img src="${photo.url}" alt="照片 ${index + 1}" class="max-w-full max-h-full object-contain"></div>
                        <div class="photo-controls absolute top-2 right-2 flex gap-1.5 opacity-0 transition-all bg-black/40 p-1 rounded-full">
                            <button title="在此後插入照片" class="insert-btn" data-index="${index}"><i data-lucide="plus-circle" class="w-5 h-5 text-white hover:text-blue-300"></i></button>
                            <button title="刪除照片" class="remove-btn" data-id="${photo.id}"><i data-lucide="trash-2" class="w-5 h-5 text-white hover:text-red-400"></i></button>
                        </div>
                    </div>
                    <div class="p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">說明文字 #${index + 1}</label>
                        <input type="text" value="${photo.description}" data-id="${photo.id}" placeholder="請輸入說明..." class="text-input w-full text-center px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>`;
                dom.photoGrid.appendChild(card);
            });
            lucide.createIcons();
        };

        const convertImageToPngData = (url, frameWidth = 800, frameHeight = 600) => new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = frameWidth;
                canvas.height = frameHeight;
                const ctx = canvas.getContext('2d');
                
                const widthRatio = frameWidth / img.width;
                const heightRatio = frameHeight / img.height;
                const ratio = Math.min(widthRatio, heightRatio);

                const newWidth = img.width * ratio;
                const newHeight = img.height * ratio;

                const x = (frameWidth - newWidth) / 2;
                const y = (frameHeight - newHeight) / 2;

                ctx.drawImage(img, x, y, newWidth, newHeight);

                resolve({
                    base64: canvas.toDataURL('image/png'),
                    width: frameWidth, 
                    height: frameHeight
                });
            };
            img.onerror = (e) => reject(new Error(`圖片載入失敗: ${url}`));
            img.src = url;
        });

        const handleFileSelect = async (e, isInsertion = false) => {
            if (appState !== AppState.IDLE) return;
            setAppState(AppState.PROCESSING_IMAGES);
            
            try {
                const files = Array.from(e.target.files);
                const photoPromises = files.map(async file => {
                    let processedFile = file;
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.heic') || fileName.endsWith('.heif')) {
                        try {
                            const convertedBlob = await heic2any({ blob: file, toType: "image/png" });
                            processedFile = new File([convertedBlob], `${file.name.split('.')[0]}.png`, { type: 'image/png' });
                        } catch (err) {
                            console.error(`HEIC 轉換失敗: ${file.name}`, err);
                            throw new Error(`檔案 ${file.name} 轉換失敗。`);
                        }
                    }
                    return {
                        id: Date.now() + Math.random(),
                        url: URL.createObjectURL(processedFile),
                        description: ''
                    };
                });

                const newPhotos = await Promise.all(photoPromises);

                if (isInsertion && insertIndex !== -1) {
                    photos.splice(insertIndex + 1, 0, ...newPhotos);
                } else {
                    photos.push(...newPhotos);
                }
            } catch (error) {
                alert(error.message);
            } finally {
                e.target.value = '';
                renderPhotos();
            }
        };

        const updatePhotoText = (id, value) => {
            const photo = photos.find(p => p.id === id);
            if (photo) photo.description = value;
        };

        const removePhoto = (id) => {
            const photo = photos.find(p => p.id === id);
            if (photo) URL.revokeObjectURL(photo.url);
            photos = photos.filter(p => p.id !== id);
            renderPhotos();
        };

        const toRocDate = (dateString, format = 'YYY/MM/DD') => {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            const year = date.getFullYear() - 1911;
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return format.replace('YYY', year).replace('MM', month).replace('DD', day);
        };

        const parsePageRange = (rangeStr, totalPages) => {
            const pages = new Set();
            if (!rangeStr || rangeStr.trim() === '') {
                for (let i = 1; i <= totalPages; i++) pages.add(i);
                return pages;
            }

            const parts = rangeStr.split(',');
            for (const part of parts) {
                const trimmedPart = part.trim();
                if (trimmedPart.includes('-')) {
                    const [start, end] = trimmedPart.split('-').map(Number);
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let i = start; i <= end; i++) {
                            if (i > 0 && i <= totalPages) pages.add(i);
                        }
                    }
                } else {
                    const page = Number(trimmedPart);
                    if (!isNaN(page) && page > 0 && page <= totalPages) pages.add(page);
                }
            }
            return pages;
        };

        const generateHTML = async () => {
            if (appState !== AppState.IDLE || photos.length === 0) return;
            setAppState(AppState.GENERATING_HTML);

            try {
                const imagePromises = photos.map(photo => convertImageToPngData(photo.url));
                const imageDatas = await Promise.all(imagePromises);
                
                const totalPages = Math.ceil(imageDatas.length / 2);
                const pagesWithFooter = parsePageRange(paginationSettings.range, totalPages);
                let bodyContent = '';

                for (let i = 0; i < imageDatas.length; i += 2) {
                    const currentPage = (i / 2) + 1;
                    const photo1 = photos[i];
                    const imageData1 = imageDatas[i];
                    const photo2 = (i + 1 < photos.length) ? photos[i+1] : null;
                    const imageData2 = (i + 1 < imageDatas.length) ? imageDatas[i+1] : null;

                    let paginationHtml = '';
                    if(pagesWithFooter.has(currentPage)) {
                        let pageText = paginationSettings.format
                            .replace('{page}', currentPage)
                            .replace('{total}', totalPages);
                        
                        paginationHtml = `<div class="footer" style="text-align:${paginationSettings.position}; font-size:${paginationSettings.fontSize}px; color:${paginationSettings.fontColor};">${pageText}</div>`;
                    }

                    bodyContent += `<div class="page">`;
                    
                    if (i === 0) {
                        let headerHtml = `<div class="header">`;
                        if (reportInfo.themeName) {
                            headerHtml += `<h1 class="main-title">${reportInfo.themeName}</h1>`;
                        }
                        let subHeaderHtml = `<div class="sub-header">`;
                        if (reportInfo.constructionLot) subHeaderHtml += `<p>施工標別：${reportInfo.constructionLot}</p>`;
                        if (reportInfo.reportDate) subHeaderHtml += `<p>日期：${toRocDate(reportInfo.reportDate)}</p>`;
                        subHeaderHtml += `</div>`;
                        headerHtml += subHeaderHtml + `</div>`;
                        bodyContent += headerHtml;
                    }

                    bodyContent += `<div class="content-area">`;
                    bodyContent += `<div class="photo-section">
                                        <div class="photo-container"><img src="${imageData1.base64}" /></div>
                                        <div class="caption">${photo1.description || '&nbsp;'}</div>
                                    </div>`;
                    if (photo2 && imageData2) {
                        bodyContent += `<div class="photo-section">
                                            <div class="photo-container"><img src="${imageData2.base64}" /></div>
                                            <div class="caption">${photo2.description || '&nbsp;'}</div>
                                        </div>`;
                    } else {
                        bodyContent += `<div class="photo-section empty"></div>`;
                    }
                    bodyContent += `</div>${paginationHtml}</div>`;
                }

                const htmlTemplate = `
                    <!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${reportInfo.themeName || '照片報告'}</title><style>
                    @page { size: A4; margin: 2cm; }
                    body { margin: 0; font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; -webkit-print-color-adjust: exact; color-adjust: exact; }
                    .page { width: 17cm; height: 25.7cm; page-break-after: always; box-sizing: border-box; display: flex; flex-direction: column; }
                    .header { margin-bottom: 0.5cm; flex-shrink: 0; }
                    .header .main-title { font-size: 28px; font-weight: bold; text-align: center; margin: 0 0 8px 0; }
                    .header .sub-header { font-size: 14px; text-align: left; }
                    .header .sub-header p { margin: 2px 0; font-weight: bold; }
                    .content-area { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
                    .photo-section { flex-basis: calc((100% - 0.3cm) / 2); min-height: 0; display: flex; flex-direction: column; border: 0.5pt solid #333; margin-bottom: 0.3cm; box-sizing: border-box; }
                    .content-area > .photo-section:last-child { margin-bottom: 0; }
                    .photo-section.empty { border: none; }
                    .photo-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 0.2cm; box-sizing: border-box; overflow: hidden; min-height: 0; }
                    .photo-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
                    .caption { text-align: center; padding: 0.2cm; border-top: 0.5pt solid #333; box-sizing: border-box; font-size: 16px; flex-shrink: 0; }
                    .footer { flex-shrink: 0; padding-top: 0.5cm; box-sizing: border-box; }
                    </style></head><body>${bodyContent}</body></html>`;

                const blob = new Blob([htmlTemplate], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${reportInfo.themeName || '照片報告'}_${new Date().toISOString().slice(0, 10)}.html`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('HTML 生成失敗:', error);
                alert(`HTML 生成失敗：${error.message}`);
            } finally {
                setAppState(AppState.IDLE);
            }
        };
        
        // --- 事件監聽 ---
        const saveInputToLocalStorage = () => {
            const data = {
                themeName: dom.themeNameInput.value,
                constructionLotSelect: dom.constructionLotSelect.value,
                constructionLotInput: dom.constructionLotInput.value,
                reportDate: dom.reportDateInput.value,
                paginationSettings: paginationSettings
            };
            localStorage.setItem('reportInfo', JSON.stringify(data));
        };

        const loadInputFromLocalStorage = () => {
            const data = JSON.parse(localStorage.getItem('reportInfo'));
            if (data) {
                dom.themeNameInput.value = data.themeName || '';
                dom.constructionLotSelect.value = data.constructionLotSelect || '萬大線';
                dom.constructionLotInput.value = data.constructionLotInput.value || '';
                dom.reportDateInput.value = data.reportDate || '';
                if(data.paginationSettings) {
                    paginationSettings = {...paginationSettings, ...data.paginationSettings};
                    dom.paginationPosition.value = paginationSettings.position;
                    dom.paginationShowTotal.checked = paginationSettings.showTotal;
                    dom.paginationFontSize.value = paginationSettings.fontSize;
                    dom.paginationFontColor.value = paginationSettings.fontColor;
                    dom.paginationFormat.value = paginationSettings.format;
                    dom.paginationRange.value = paginationSettings.range;
                }
                updateReportInfo();
            }
        };
        
        const updateReportInfo = () => {
            const selectValue = dom.constructionLotSelect.value;
            const inputValue = dom.constructionLotInput.value.trim();
            let combinedLot = selectValue === 'other' ? inputValue : selectValue;
            if (selectValue !== 'other' && inputValue) {
                combinedLot = `${selectValue} ${inputValue}`;
            }
            reportInfo = {
                themeName: dom.themeNameInput.value,
                constructionLot: combinedLot,
                reportDate: dom.reportDateInput.value
            };
            dom.rocDateDisplay.textContent = toRocDate(reportInfo.reportDate);
            saveInputToLocalStorage();
        }

        dom.fileInput.addEventListener('change', (e) => handleFileSelect(e, false));
        dom.insertFileInput.addEventListener('change', (e) => handleFileSelect(e, true));
        
        [dom.themeNameInput, dom.constructionLotInput, dom.constructionLotSelect, dom.reportDateInput].forEach(input => {
            input.addEventListener('input', updateReportInfo);
            input.addEventListener('change', updateReportInfo);
        });

        dom.generateHtmlBtn.addEventListener('click', generateHTML);

        dom.photoGrid.addEventListener('input', (e) => {
            if (e.target.classList.contains('text-input')) {
                const id = parseFloat(e.target.dataset.id);
                updatePhotoText(id, e.target.value);
            }
        });
        dom.photoGrid.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button || appState !== AppState.IDLE) return;
            if (button.classList.contains('remove-btn')) {
                removePhoto(parseFloat(button.dataset.id));
            } else if (button.classList.contains('insert-btn')) {
                insertIndex = parseInt(button.dataset.index, 10);
                dom.insertFileInput.click();
            }
        });
        
        // --- 頁碼 Modal 控制 ---
        dom.paginationSettingsBtn.addEventListener('click', () => {
            dom.paginationModal.style.display = 'flex';
        });
        const closeModal = () => {
            dom.paginationModal.style.display = 'none';
        }
        dom.paginationModalClose.addEventListener('click', closeModal);
        dom.paginationModalCloseIcon.addEventListener('click', closeModal);

        const updatePaginationSettings = (key, value) => {
            paginationSettings[key] = value;
            saveInputToLocalStorage();
        };

        dom.paginationPosition.addEventListener('change', (e) => updatePaginationSettings('position', e.target.value));
        dom.paginationFontSize.addEventListener('input', (e) => updatePaginationSettings('fontSize', e.target.value));
        dom.paginationFontColor.addEventListener('input', (e) => updatePaginationSettings('fontColor', e.target.value));
        dom.paginationRange.addEventListener('input', (e) => updatePaginationSettings('range', e.target.value));

        dom.paginationFormat.addEventListener('input', (e) => {
            const format = e.target.value;
            const hasTotal = format.includes('{total}');
            dom.paginationShowTotal.checked = hasTotal;
            paginationSettings.format = format;
            paginationSettings.showTotal = hasTotal;
            saveInputToLocalStorage();
        });

        dom.paginationShowTotal.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            let currentFormat = dom.paginationFormat.value;
            const totalRegex = /(\s*(\/|,|，)\s*(共|of)\s*{total}\s*(頁|pages|)?)/i;

            if (isChecked && !currentFormat.includes('{total}')) {
                 currentFormat += ' / 共 {total} 頁';
            } else if (!isChecked) {
                currentFormat = currentFormat.replace(totalRegex, '').trim();
            }
            dom.paginationFormat.value = currentFormat;
            dom.paginationFormat.dispatchEvent(new Event('input')); 
        });

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInputFromLocalStorage();
            if (!dom.reportDateInput.value) {
                dom.reportDateInput.value = '2025-10-05';
            }
            updateReportInfo(); 
            renderPhotos();
            lucide.createIcons();
        });

    </script>
</body>
</html></div></body></html>
