</html><!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>影音播放器</title>
  <style>
    :root{
      --bg: #f5f5f7;
      --panel-bg: rgba(245, 245, 247, 0.85);
      --stroke: rgba(0, 0, 0, 0.1);
      --shadow: 0 8px 30px rgba(0,0,0,.08);
      --blue: #0071e3;
      --red: #ff453a;
      --orange: #f97316;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --card-radius: 18px;
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      overflow: hidden;
    }
    .frame{max-width:1400px; height: calc(100% - 32px); margin:0 auto; display: flex; flex-direction: column;}
    .layout{ display:grid; grid-template-columns: 360px 1fr; gap:18px; flex-grow: 1; min-height: 0; }
    .sidebar{display:flex; flex-direction:column; gap:12px; min-height: 0;}
    .panel.library { display: flex; flex-direction: column; height: 100%; }
    .player-panel { padding: 0; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
    
    .video-player-container { 
      position: relative; background: #000; 
      border-radius: var(--card-radius); 
      overflow: hidden; display: flex; align-items: center; justify-content: center; width: 100%;
      flex: 1 1 0;
      min-height: 0;
    }
    .video-player-container.with-waveform {
        border-radius: var(--card-radius) var(--card-radius) 0 0;
    }
    #videoPlayer { width: 100%; height: 100%; object-fit: contain; cursor: pointer; }
    
    .titlebar{display:flex; align-items:center; justify-content:center; margin-bottom: 0.5rem; flex-shrink: 0;}
    .dots{display:flex; gap:8px; align-items:center}
    .dot{width:12px; height:12px; border-radius:50%;}
    .dot.red{background:#ff5f56;} .dot.yellow{background:#ffbd2e;} .dot.green{background:#27c93f;}
    .titles{text-align:center; flex-grow:1;}
    .titles h1{margin:0 0 4px 0; font-size:24px; font-weight:600;}
    .titles h2{margin:0; font-size:14px; font-weight:400; color:var(--muted); line-height: 1.2;}
    .author{margin-top:0; font-size:14px; font-weight:400; color:var(--muted); white-space:nowrap; line-height: 1.2;}

    .glass{background:var(--panel-bg); border:1px solid var(--stroke); border-radius:var(--card-radius); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter:saturate(180%) blur(20px); box-shadow:var(--shadow);}
    .panel{padding:18px;}
    .panel .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .panel h3{margin:0; font-size:16px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.8px;}
    
    .btn.primary { background: var(--orange); color: white; border-radius: 12px; padding: 12px 24px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn.primary:hover{filter:brightness(1.1);}
    .btn.primary svg { width: 20px; height: 20px; fill: white; }
    .btn.ghost { background: transparent; color: var(--muted); font-size: 12px; padding: 4px 8px; }
    .btn.ghost:hover { background: rgba(0,0,0,0.05); }

    .filedrop{border:2px dashed rgba(0,0,0,.12); border-radius:16px; padding:12px 16px; text-align:center; display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 12px;}
    .video-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 18px; pointer-events: none; text-align: center; }
    
    .controls-container { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px 15px; display: flex; flex-direction: column; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 20; }
    .video-player-container:hover .controls-container, .video-player-container.paused .controls-container { opacity: 1; visibility: visible; }
    #progressBar { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; cursor: pointer; margin-bottom: 8px; transition: height 0.15s ease; }
    .controls-container:hover #progressBar { height: 6px; }
    #progressBar::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--red); border-radius: 50%; border: none; }
    #progressBar::-moz-range-thumb { width: 14px; height: 14px; background: var(--red); border-radius: 50%; border: none; }
    .controls-group { display: flex; justify-content: space-between; align-items: center; }
    .controls-left, .controls-right { display: flex; align-items: center; gap: 16px; }
    .control-btn { background: none; border: none; padding: 0; cursor: pointer; color: white; line-height: 1; position: relative; }
    .control-btn:disabled svg { opacity: 0.4; cursor: not-allowed; }
    .control-btn:disabled:hover svg { transform: scale(1); }
    .control-btn svg { width: 24px; height: 24px; fill: white; pointer-events: none; transition: transform 0.2s; }
    .control-btn:not(:disabled):hover svg { transform: scale(1.1); }
    .control-btn.active svg { fill: var(--blue); }
    .control-btn[data-tooltip]::after { content: attr(data-tooltip); position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background-color: rgba(20, 20, 20, 0.9); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; pointer-events: none; }
    .control-btn[data-tooltip]:hover::after { opacity: 1; visibility: visible; }
    .volume-container { display: flex; align-items: center; }
    #volumeSlider { -webkit-appearance: none; appearance: none; width: 0px; height: 4px; background: white; border-radius: 5px; opacity: 0; transition: width 0.3s ease, opacity 0.3s ease; }
    .volume-container:hover #volumeSlider { width: 80px; opacity: 1; }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; }
    #volumeSlider::-moz-range-thumb { width: 12px; height: 12px; background: white; border-radius: 50%; border: none; }
    #timeDisplay { color: white; font-size: 14px; font-weight: 500; font-variant-numeric: tabular-nums; }

    #settingsPanel { position: absolute; right: 15px; bottom: 60px; width: 280px; border-radius: 12px; background: rgba(30,30,30,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); color: white; padding: 8px; z-index: 10; display: none; }
    .settings-header { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .settings-header h4 { margin: 0; font-weight: 500; }
    #speedView ul { list-style: none; padding: 0; margin: 0; }
    #speedView li { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; border-radius: 6px; }
    #speedView li:hover { background: rgba(255,255,255,0.1); }
    #speedView li.active { color: var(--blue); font-weight: 600; }
    #speedView li svg { width: 16px; height: 16px; fill: var(--blue); margin-right: 12px; visibility: hidden; }
    #speedView li.active svg { visibility: visible; }
    .custom-speed-control { padding: 12px 16px; }
    .custom-speed-control .label { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .custom-speed-control .label span:last-child { font-weight: 600; color: var(--blue); }
    #speedSlider { width: 100%; }

    #searchInput { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.5); margin-bottom: 12px; font-size: 14px; }
    .list-area { background: rgba(0,0,0,0.03); border-radius: 12px; padding: 8px; flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }
    .file-list-container { flex-grow: 1; overflow-y: auto; min-height: 0; }
    .file-list-label { font-size: 13px; color: var(--muted); display: flex; align-items: center; gap: 6px; margin-top: 10px; font-weight: 600; padding: 0 4px; }
    .file-list-label svg { width: 16px; height: 16px; fill: var(--muted); }
    #videoList, #audioList { list-style-type: none; padding-left: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; }
    #videoList li, #audioList li { position: relative; font-size: 14px; white-space: nowrap; overflow: hidden; padding: 8px 10px; cursor: pointer; border-radius: 8px; transition: background-color 0.15s ease; display: flex; align-items: center; }
    #videoList li:hover, #audioList li:hover { background-color: rgba(0,0,0,.07); }
    #videoList li.active, #audioList li.active { background-color: var(--blue); color: white; font-weight: 500; }
    #videoList:empty::after, #audioList:empty::after { content: "尚未匯入檔案"; color: var(--muted); font-style: italic; font-size: 13px; padding: 4px; }
    .media-type-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-right: 8px; flex-shrink: 0; }
    .media-type-badge.video { background: var(--blue); color: white; }
    .media-type-badge.audio { background: var(--green); color: white; }
    .filename-container { flex-grow: 1; overflow: hidden; position: relative; }
    li.active .filename-container { color: white; }
    .marquee-text { display: inline-block; white-space: nowrap; }
    li.active .marquee-text { animation: marquee 10s linear infinite; padding-left: 100%; }
    .remove-item-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; background: rgba(0,0,0,0.3); color: white; border: none; border-radius: 50%; text-align: center; line-height: 18px; font-size: 14px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
    li:hover .remove-item-btn { opacity: 1; }
    li.active .remove-item-btn { background: rgba(255,255,255,0.3); color: black; }
    @keyframes marquee { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
    
    #waveform-display {
        height: 80px;
        background-color: white;
        border: 1px solid var(--stroke);
        border-top: none;
        border-radius: 0 0 var(--card-radius) var(--card-radius);
        position: relative;
        overflow: hidden;
        display: none;
        flex-shrink: 0;
    }
    #waveformCanvas { width: 100%; height: 100%; display: block; }
    #waveform-playhead { position: absolute; top: 0; left: 0; width: 2px; height: 100%; background-color: var(--red); pointer-events: none; }

    #loadingIndicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(245,245,247,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 10px; color: var(--muted); font-weight: 600; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(0,0,0,0.1); border-top-color: var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 1024px) { .layout { grid-template-columns: 1fr; height: auto; } .sidebar { max-height: 40vh; } }
    @media (max-width: 768px) { body { padding: 16px; height: auto; overflow: auto; } .frame { height: auto; } .titles h1 { font-size: 22px; } }
  </style>
</head>
<body>
  <div class="frame">
    <div class="dots">
      <span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span>
    </div>
    <div class="titlebar">
      <div class="titles">
        <h1>影音播放器</h1>
        <h2>提供速度調整、循環播放、音訊波形圖與智慧媒體庫管理</h2>
        <div class="author">製作者：陳政德</div>
      </div>
    </div>

    <div class="layout">
      <!-- Left Panel -->
      <div class="sidebar">
        <div class="panel glass library">
          <div class="header">
            <h3>媒體庫</h3>
            <button id="clearPlaylistBtn" class="btn ghost">全部清除</button>
          </div>
          <div class="filedrop" id="drop">
            <label class="btn primary">
              <svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"></path></svg>
              <svg viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"></path></svg>
              <span>選擇影片或音訊檔案</span>
              <input id="file" type="file" accept="video/*,audio/*,.m4a,.ogg,.aac,.3gp,.mp4,.webm,.avi,.mov,.mkv" hidden multiple>
            </label>
          </div>
          <input type="search" id="searchInput" placeholder="搜尋媒體...">
          <div class="list-area">
            <div class="file-list-container">
                <label class="file-list-label">
                  <svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"></path></svg>
                  <span>影片列表</span>
                </label>
                <ol id="videoList"></ol>
            </div>
            <div class="file-list-container">
                <label class="file-list-label">
                  <svg viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"></path></svg>
                  <span>音訊列表</span>
                </label>
                <ol id="audioList"></ol>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="panel glass player-panel">
        <div class="video-player-container" id="videoPlayerContainer">
          <video id="videoPlayer" style="display: none;"></video>
          <div class="video-overlay" id="videoOverlay">
            請從左側媒體庫匯入檔案
          </div>
          <div class="controls-container">
            <input type="range" id="progressBar" value="0" step="0.01">
            <div class="controls-group">
              <div class="controls-left">
                <button class="control-btn" id="prevBtn" title="上一首">
                    <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg>
                </button>
                <button class="control-btn" id="playPauseBtn" title="播放/暫停">
                  <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                  <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
                <button class="control-btn" id="nextBtn" title="下一首">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
                </button>
                <div class="volume-container">
                   <button class="control-btn" id="muteBtn" title="靜音" data-tooltip="靜音 (m)">
                       <svg id="volumeHighIcon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                       <svg id="volumeMuteIcon" style="display: none;" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>
                   </button>
                   <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
                </div>
              </div>
              <div class="controls-right">
                <div id="timeDisplay">00:00 / 00:00</div>
                <button class="control-btn" id="loopBtn" title="循環播放">
                    <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"></path></svg>
                </button>
                <button class="control-btn" id="settingsBtn" title="設定">
                    <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59-1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                </button>
                <button class="control-btn" id="fullscreenBtn" title="全螢幕">
                    <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg>
                </button>
              </div>
            </div>
          </div>
          
          <div id="settingsPanel">
            <div id="speedView">
                <div class="settings-header"> <h4>播放速度</h4> </div>
                <div class="custom-speed-control">
                    <div class="label"> <span>自訂</span><span id="speedValue">1.00x</span> </div>
                    <input type="range" id="speedSlider" min="0.25" max="2" step="0.05" value="1">
                </div>
                <ul>
                    <li data-speed="0.25"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 18.99 21 7l-1.41-1.41z"></path></svg>0.25</li>
                    <li data-speed="0.75"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 18.99 21 7l-1.41-1.41z"></path></svg>0.75</li>
                    <li data-speed="1" class="active"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 18.99 21 7l-1.41-1.41z"></path></svg>正常</li>
                    <li data-speed="1.25"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 18.99 21 7l-1.41-1.41z"></path></svg>1.25</li>
                    <li data-speed="1.5"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 18.99 21 7l-1.41-1.41z"></path></svg>1.5</li>
                </ul>
            </div>
          </div>
        </div>
        <div id="waveform-display">
            <canvas id="waveformCanvas"></canvas>
            <div id="waveform-playhead"></div>
        </div>
      </div>
    </div>
    <div id="loadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <div id="loadingText">媒體檔案載入中...</div>
    </div>
  </div>

  <script>
    const AC = new (window.AudioContext || window.webkitAudioContext)();
    let audioBuffer = null;
    let currentFile = null;
    let allFiles = [];
    let currentFileIndex = -1;
    let isPlaying = false;
    let hasPlayedOnce = false;
    let animationFrameId;

    const $ = (id) => document.getElementById(id);
    const videoPlayer = $('videoPlayer');
    const videoPlayerContainer = $('videoPlayerContainer');
    const videoOverlay = $('videoOverlay');
    const playPauseBtn = $('playPauseBtn');
    const playIcon = $('playIcon');
    const pauseIcon = $('pauseIcon');
    const prevBtn = $('prevBtn');
    const nextBtn = $('nextBtn');
    const progressBar = $('progressBar');
    const timeDisplay = $('timeDisplay');
    const volumeSlider = $('volumeSlider');
    const muteBtn = $('muteBtn');
    const volumeHighIcon = $('volumeHighIcon');
    const volumeMuteIcon = $('volumeMuteIcon');
    const fullscreenBtn = $('fullscreenBtn');
    const loopBtn = $('loopBtn');
    const settingsBtn = $('settingsBtn');
    const settingsPanel = $('settingsPanel');
    const speedSlider = $('speedSlider');
    const speedValue = $('speedValue');
    const speedPresets = document.querySelectorAll('#speedView li');
    const waveformDisplay = $('waveform-display');
    const waveformCanvas = $('waveformCanvas');
    const waveformPlayhead = $('waveform-playhead');
    const waveformCtx = waveformCanvas.getContext('2d');
    const searchInput = $('searchInput');
    const clearPlaylistBtn = $('clearPlaylistBtn');
    const videoList = $('videoList');
    const audioList = $('audioList');

    videoPlayer.volume = 0.5;

    function updateFileLists(filterText = '') {
        videoList.innerHTML = '';
        audioList.innerHTML = '';
        const lowerCaseFilter = filterText.toLowerCase();
        let videoCount = 0;
        let audioCount = 0;

        allFiles.forEach((fileObj, index) => {
            if (!fileObj.file.name.toLowerCase().includes(lowerCaseFilter)) return;
            const li = document.createElement('li');
            const mediaType = fileObj.type;
            const badge = `<span class="media-type-badge ${mediaType}">${mediaType}</span>`;
            const fileNameContainer = document.createElement('div');
            fileNameContainer.className = 'filename-container';
            const fileNameSpan = document.createElement('span');
            fileNameSpan.className = 'marquee-text';
            fileNameSpan.textContent = fileObj.file.name;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-item-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.dataset.index = index;
            fileNameContainer.appendChild(fileNameSpan);
            li.appendChild(document.createRange().createContextualFragment(badge));
            li.appendChild(fileNameContainer);
            li.appendChild(removeBtn);
            li.title = fileObj.file.name;
            if (index === currentFileIndex) { li.classList.add('active'); }
            li.onclick = (e) => { if (e.target.classList.contains('remove-item-btn')) return; if (index !== currentFileIndex) { loadFile(fileObj.file); } };
            if (mediaType === 'video') { videoList.appendChild(li); videoCount++; } 
            else { audioList.appendChild(li); audioCount++; }
        });

        const currentType = allFiles[currentFileIndex]?.type;
        const relevantCount = currentType === 'video' ? videoCount : audioCount;
        const canNavigate = relevantCount > 1;
        prevBtn.disabled = !canNavigate;
        nextBtn.disabled = !canNavigate;
    }

    function handleFiles(files) {
        if (!files || files.length === 0) return;
        const wasEmpty = allFiles.length === 0;
        for (const file of files) {
            if (!allFiles.some(f => f.file.name === file.name)) {
                const type = file.type.startsWith('video/') ? 'video' : 'audio';
                allFiles.push({ file, type });
            }
        }
        updateFileLists();
        if (wasEmpty && files.length > 0) { loadFile(allFiles[0].file); }
    }

    async function loadFile(file) {
      if (isPlaying) pause();
      showLoading(true, "媒體檔案載入中...");
      try {
        currentFile = file;
        currentFileIndex = allFiles.findIndex(f => f.file.name === file.name);
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        videoPlayer.style.display = 'block';
        videoOverlay.style.display = 'none';
        if (file.type.startsWith('audio/')) {
            videoOverlay.innerHTML = `🎵<br><span style="font-size: 14px; margin-top: 8px;">${file.name}</span>`;
            videoOverlay.style.display = 'flex';
        }
        updateFileLists(searchInput.value);
        showLoading(true, "正在分析音訊...");
        try {
            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await AC.decodeAudioData(arrayBuffer.slice(0));
            waveformDisplay.style.display = 'block';
            videoPlayerContainer.classList.add('with-waveform');
        } catch(e) {
            console.warn("無法解析音訊或無音訊軌:", e.message);
            audioBuffer = null;
            waveformDisplay.style.display = 'none';
            videoPlayerContainer.classList.remove('with-waveform');
        }
      } catch (e) {
        console.error("Error loading file:", e);
        alert(`檔案載入失敗: ${e.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    function drawWaveform() {
        if (!audioBuffer || waveformCanvas.clientWidth === 0) return;
        const canvas = waveformCanvas;
        const ctx = waveformCtx;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * dpr;
        canvas.height = canvas.clientHeight * dpr;
        ctx.scale(dpr, dpr);
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const amp = height / 2;
        ctx.clearRect(0, 0, width, height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(0, 113, 227, 0.7)';
        const data = audioBuffer.getChannelData(0);
        const step = Math.ceil(data.length / width);
        ctx.beginPath();
        for (let i = 0; i < width; i++) {
            let min = 1.0; let max = -1.0;
            for (let j = 0; j < step; j++) {
                const datum = data[(i * step) + j];
                if (datum < min) min = datum;
                if (datum > max) max = datum;
            }
            ctx.moveTo(i, amp + min * amp);
            ctx.lineTo(i, amp + max * amp);
        }
        ctx.stroke();
    }
    
    const waveformResizeObserver = new ResizeObserver(entries => {
        for (const entry of entries) {
            if (entry.target.style.display !== 'none' && entry.contentRect.width > 0) {
                drawWaveform();
            }
        }
    });
    waveformResizeObserver.observe(waveformDisplay);

    function updateWaveformPlayhead() { if (!audioBuffer) return; const percent = videoPlayer.currentTime / videoPlayer.duration; waveformPlayhead.style.left = `${percent * 100}%`; }
    function showLoading(show, text = "媒體檔案載入中...") { $('loadingIndicator').style.display = show ? 'flex' : 'none'; $('loadingText').textContent = text; }
    function play() { videoPlayer.play(); hasPlayedOnce = true; }
    function pause() { videoPlayer.pause(); }
    function togglePlay() { if (isPlaying) { pause(); } else { play(); } }
    function updateProgressBar() { progressBar.value = videoPlayer.currentTime; const current = formatTime(videoPlayer.currentTime); const duration = formatTime(videoPlayer.duration); timeDisplay.textContent = `${current} / ${duration}`; updateWaveformPlayhead(); }
    function seek() { videoPlayer.currentTime = progressBar.value; updateWaveformPlayhead(); }
    function formatTime(seconds) { if (isNaN(seconds)) return '00:00'; const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60); return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`; }
    function updateSpeedUI(rate) { const rateFloat = parseFloat(rate); speedSlider.value = rateFloat; speedValue.textContent = `${rateFloat.toFixed(2)}x`; speedPresets.forEach(p => { p.classList.toggle('active', parseFloat(p.dataset.speed) === rateFloat); }); }

    function playAdjacentTrack(direction) {
        if (currentFileIndex === -1) return;
        const currentType = allFiles[currentFileIndex].type;
        const relevantIndices = allFiles.map((f, i) => f.type === currentType ? i : -1).filter(i => i !== -1);
        if (relevantIndices.length < 2) return;
        const currentPositionInList = relevantIndices.indexOf(currentFileIndex);
        const nextPositionInList = (currentPositionInList + direction + relevantIndices.length) % relevantIndices.length;
        const newFileIndex = relevantIndices[nextPositionInList];
        loadFile(allFiles[newFileIndex].file);
    }
    
    function resetPlayer() {
        if (isPlaying) pause();
        videoPlayer.src = '';
        videoPlayer.style.display = 'none';
        videoOverlay.innerHTML = '請從左側媒體庫匯入檔案';
        videoOverlay.style.display = 'flex';
        waveformDisplay.style.display = 'none';
        videoPlayerContainer.classList.remove('with-waveform');
        allFiles = [];
        currentFileIndex = -1;
        hasPlayedOnce = false;
        searchInput.value = '';
        updateFileLists();
    }

    $('file').onchange = e => handleFiles(e.target.files);
    const drop = $('drop');
    drop.ondragover = e => { e.preventDefault(); drop.style.borderColor = 'var(--blue)'; };
    drop.ondragleave = () => drop.style.borderColor = '';
    drop.ondrop = e => { e.preventDefault(); drop.style.borderColor = ''; handleFiles(e.dataTransfer.files); };

    playPauseBtn.onclick = togglePlay;
    videoPlayer.onclick = togglePlay;
    prevBtn.onclick = () => playAdjacentTrack(-1);
    nextBtn.onclick = () => playAdjacentTrack(1);
    
    videoPlayer.onplay = () => { isPlaying = true; videoPlayerContainer.classList.remove('paused'); playIcon.style.display = 'none'; pauseIcon.style.display = 'block'; };
    videoPlayer.onpause = () => { isPlaying = false; videoPlayerContainer.classList.add('paused'); playIcon.style.display = 'block'; pauseIcon.style.display = 'none'; };
    
    videoPlayer.onloadedmetadata = () => { progressBar.max = videoPlayer.duration; updateProgressBar(); updateSpeedUI(1); videoPlayer.playbackRate = 1; if (hasPlayedOnce) { play(); } };
    videoPlayer.ontimeupdate = updateProgressBar;
    progressBar.oninput = seek;
    volumeSlider.oninput = e => { videoPlayer.volume = e.target.value; videoPlayer.muted = e.target.value === '0'; };
    videoPlayer.onvolumechange = () => { volumeSlider.value = videoPlayer.volume; volumeHighIcon.style.display = (videoPlayer.muted || videoPlayer.volume === 0) ? 'none' : 'block'; volumeMuteIcon.style.display = (videoPlayer.muted || videoPlayer.volume === 0) ? 'block' : 'none'; };
    muteBtn.onclick = () => { videoPlayer.muted = !videoPlayer.muted; };
    fullscreenBtn.onclick = () => { if (document.fullscreenElement) { document.exitFullscreen(); } else { videoPlayerContainer.requestFullscreen(); } };
    loopBtn.onclick = () => { videoPlayer.loop = !videoPlayer.loop; loopBtn.classList.toggle('active'); };
    settingsBtn.onclick = (e) => { e.stopPropagation(); settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block'; };
    
    speedSlider.oninput = () => { const rate = speedSlider.value; videoPlayer.playbackRate = rate; updateSpeedUI(rate); };
    speedPresets.forEach(p => { p.onclick = () => { const rate = p.dataset.speed; videoPlayer.playbackRate = rate; updateSpeedUI(rate); settingsPanel.style.display = 'none'; } });
    document.addEventListener('click', (e) => { if (!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) { settingsPanel.style.display = 'none'; } });
    searchInput.addEventListener('input', (e) => { updateFileLists(e.target.value); });
    clearPlaylistBtn.onclick = resetPlayer;

    const handleRemove = (e) => {
        if (!e.target.classList.contains('remove-item-btn')) return;
        const indexToRemove = parseInt(e.target.dataset.index, 10);
        if (indexToRemove === currentFileIndex) {
            pause();
            videoPlayer.src = '';
            videoPlayer.style.display = 'none';
            videoOverlay.innerHTML = '請從左側媒體庫匯入檔案';
            videoOverlay.style.display = 'flex';
            waveformDisplay.style.display = 'none';
            videoPlayerContainer.classList.remove('with-waveform');
        }
        allFiles.splice(indexToRemove, 1);
        if (currentFileIndex > indexToRemove) {
            currentFileIndex--;
        } else if (currentFileIndex === indexToRemove) {
            currentFileIndex = -1;
        }
        updateFileLists(searchInput.value);
    };
    videoList.addEventListener('click', handleRemove);
    audioList.addEventListener('click', handleRemove);
  </script>
</body>
</html>