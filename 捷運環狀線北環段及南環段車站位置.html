<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>臺北捷運環狀線南北環段 預定設站位置導覽</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">

    <!-- Leaflet CSS (OpenStreetMap Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Apple System Fonts & Basics */
        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          background-color: #F5F5F7;
        }
    
        /* Custom Scrollbar */
        .ios-scroll::-webkit-scrollbar {
          width: 0px;
          background: transparent;
        }
        .ios-scroll:hover::-webkit-scrollbar {
          width: 6px;
        }
        .ios-scroll::-webkit-scrollbar-thumb {
          background: rgba(0,0,0,0.2);
          border-radius: 10px;
        }
    
        /* Map Marker Pin Styles for Leaflet */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        
        .marker-pin {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background-color: #FCD34D; /* Yellow-400 */
          border: 3px solid #FFFFFF;
          box-shadow: 0 4px 6px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 12px;
          color: #1F2937;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          cursor: pointer;
          position: relative;
        }
        
        /* Triangle arrow for the pin */
        .marker-pin::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #FFFFFF;
        }
        .marker-pin::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 6px solid #FCD34D;
            z-index: 1;
        }

        /* Active State */
        .marker-pin.active {
          background-color: #111827; /* Gray-900 */
          color: #FCD34D;
          transform: scale(1.2) translateY(-8px);
          border-color: #FFFFFF;
          box-shadow: 0 12px 20px rgba(0,0,0,0.3);
          z-index: 50;
        }
        .marker-pin.active::before {
            border-top-color: #111827;
        }

        /* Leaflet Popup Styling Override */
        .leaflet-popup-content-wrapper {
            padding: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .leaflet-popup-content {
            margin: 0 !important;
            width: 260px !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            top: 8px;
            right: 8px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            font-size: 20px;
            z-index: 10;
        }
        .leaflet-container a.leaflet-popup-close-button:hover {
            color: #FCD34D;
        }
    
        /* Frosted Glass Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Hide Leaflet Attribution for cleaner look (optional, but polite to keep) */
        .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.8) !important;
            font-size: 10px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-900">

    <!-- Header -->
    <header class="h-14 bg-white/80 backdrop-blur-md border-b border-gray-200/50 flex items-center justify-between px-4 z-30 shrink-0 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-yellow-400 flex items-center justify-center shadow-sm">
                <span class="material-symbols-rounded text-white" style="font-size: 20px;">subway</span>
            </div>
            <div>
                <h1 class="text-sm font-semibold tracking-tight text-gray-900">環狀線南北環段</h1>
                <p class="text-[10px] text-gray-500 font-medium">Station Map Viewer</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a class="text-xs font-medium text-gray-500 hover:text-gray-900 transition" href="https://www.dorts.gov.taipei/cp.aspx?n=7CEEE7ECF48CE83F" target="_blank">
                資料來源
            </a>
            <button class="flex items-center gap-1.5 bg-gray-900 hover:bg-black text-white text-xs font-medium px-3 py-1.5 rounded-full transition-all shadow-sm active:scale-95" onclick="exportHtml()">
                <span class="material-symbols-rounded text-[14px]">code</span>
                匯出 HTML
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- Left Panel: Sidebar -->
        <div class="w-full md:w-[380px] bg-[#F5F5F7] border-r border-gray-200 flex flex-col h-full z-20 relative shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <!-- Search/Filter Bar -->
            <div class="p-4 bg-[#F5F5F7]/90 backdrop-blur-md sticky top-0 z-10">
                <div class="bg-gray-200/50 p-1 rounded-lg flex shadow-inner">
                    <button class="flex-1 py-1.5 text-xs font-semibold rounded-md transition-all shadow-sm bg-white text-gray-900" id="btn-all" onclick="filterStations('all')">所有車站</button>
                    <button class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 hover:text-gray-900 transition-all hover:bg-white/50" id="btn-north" onclick="filterStations('north')">北環段</button>
                    <button class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 hover:text-gray-900 transition-all hover:bg-white/50" id="btn-south" onclick="filterStations('south')">南環段</button>
                </div>
            </div>
            <!-- List Container -->
            <div class="ios-scroll flex-1 overflow-y-auto px-4 pb-4 space-y-3" id="station-list-container">
                <!-- Stations will be rendered here by JS -->
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="flex-1 relative bg-gray-100 h-full">
            <div class="w-full h-full z-0" id="map"></div>
            
            <!-- Floating Legend -->
            <div class="absolute bottom-6 left-6 glass-panel px-4 py-3 rounded-2xl shadow-lg border border-white/20 text-xs space-y-2.5 backdrop-blur-xl z-[1000]">
                <div class="flex items-center gap-2.5">
                    <div class="w-3 h-3 rounded-full bg-yellow-400 border-[1.5px] border-white shadow-sm"></div>
                    <span class="font-medium text-gray-700">規劃車站 (Planned)</span>
                </div>
                <div class="flex items-center gap-2.5">
                    <div class="w-3 h-3 rounded-full bg-white border border-gray-200 flex items-center justify-center shadow-sm">
                        <span class="material-symbols-rounded text-[10px] text-blue-500">cached</span>
                    </div>
                    <span class="font-medium text-gray-700">轉乘站點 (Transfer)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Configuration ---
        const stations = [
          // South Ring (Y1 - Y5)
          {
            code: "Y1",
            section: "south",
            name: "動物園站",
            nameEn: "Taipei Zoo",
            location: "文山區新光路二段 (文湖線動物園站西南側)",
            desc: "轉乘文湖線",
            coords: { lat: 24.9989, lng: 121.5794 },
            imageQuery: "Taipei Zoo Entrance",
            transfer: "文湖線 (Wenhu Line)"
          },
          {
            code: "Y1A",
            section: "south",
            name: "政大站",
            nameEn: "NCCU / Wan Shou Rd",
            location: "文山區萬壽路與秀明路交叉口 (政大三角地)",
            desc: "鄰近政治大學",
            coords: { lat: 24.9868, lng: 121.5755 },
            imageQuery: "National Chengchi University main gate",
            transfer: null
          },
          {
            code: "Y2A",
            section: "south",
            name: "文山區公所站",
            nameEn: "Wenshan Dist. Office",
            location: "木新路一段與木柵路三段口 (文山公園)",
            desc: "鄰近文山區行政中心",
            coords: { lat: 24.9880, lng: 121.5665 },
            imageQuery: "Muzha Road Taipei street view",
            transfer: null
          },
          {
            code: "Y3",
            section: "south",
            name: "馬明潭站",
            nameEn: "Mamingtan",
            location: "木柵路二段與138巷交口",
            desc: "鄰近住宅區",
            coords: { lat: 24.9855, lng: 121.5580 },
            imageQuery: "Muzha Road Section 2 Taipei",
            transfer: null
          },
          {
            code: "Y4",
            section: "south",
            name: "試院站",
            nameEn: "Examination Yuan",
            location: "辛亥路與試院路間之木柵路",
            desc: "鄰近考試院",
            coords: { lat: 24.9825, lng: 121.5465 },
            imageQuery: "Examination Yuan Taipei building",
            transfer: null
          },
          {
            code: "Y5",
            section: "south",
            name: "寶橋站",
            nameEn: "Baoqiao",
            location: "新店榮工廠地公園用地 (近寶橋路)",
            desc: "鄰近景美溪",
            coords: { lat: 24.9785, lng: 121.5435 },
            imageQuery: "Xindian Jingmei River Park",
            transfer: null
          },
          // North Ring (Y19A - Y29)
          {
            code: "Y19A",
            section: "north",
            name: "新北產業園區站",
            nameEn: "New Taipei Ind. Park",
            location: "五股區五權路口 (五工路下方)",
            desc: "北環段起點",
            coords: { lat: 25.0615, lng: 121.4585 },
            imageQuery: "New Taipei Industrial Park MRT Station",
            transfer: "機場捷運 (Airport MRT)"
          },
          {
            code: "Y19B",
            section: "north",
            name: "更寮站",
            nameEn: "Gengliao",
            location: "五股區中興路二段37巷附近",
            desc: "鄰近疏洪道堤防",
            coords: { lat: 25.0755, lng: 121.4655 },
            imageQuery: "Wugu District street view Taipei",
            transfer: null
          },
          {
            code: "Y20",
            section: "north",
            name: "中路站",
            nameEn: "Zhonglu / Luzhou",
            location: "蘆洲區中山一路與永安南路口",
            desc: "蘆洲南側入口",
            coords: { lat: 25.0785, lng: 121.4725 },
            imageQuery: "Luzhou District Taipei street",
            transfer: null
          },
          {
            code: "Y21",
            section: "north",
            name: "徐匯中學站",
            nameEn: "St. Ignatius High School",
            location: "蘆洲區中山一路 (徐匯中學前)",
            desc: "轉乘中和新蘆線",
            coords: { lat: 25.0805, lng: 121.4795 },
            imageQuery: "St. Ignatius High School MRT Station exterior",
            transfer: "中和新蘆線 (O Line)"
          },
          {
            code: "Y22",
            section: "north",
            name: "五華國小站",
            nameEn: "Wuhua Elementary School",
            location: "三重區五華街與集賢路口",
            desc: "鄰近五華國小",
            coords: { lat: 25.0835, lng: 121.4885 },
            imageQuery: "Sanchong District Jixian Road",
            transfer: null
          },
          {
            code: "Y23",
            section: "north",
            name: "重陽橋站",
            nameEn: "Chongyang Bridge",
            location: "三重區集賢路 (近重陽橋)",
            desc: "淡水河畔",
            coords: { lat: 25.0865, lng: 121.4965 },
            imageQuery: "Chongyang Bridge Taipei",
            transfer: null
          },
          {
            code: "Y24",
            section: "north",
            name: "社子站",
            nameEn: "Shezi",
            location: "士林區中正路與通河西街口 (社正公園)",
            desc: "規劃轉乘社子輕軌",
            coords: { lat: 25.0885, lng: 121.5115 },
            imageQuery: "Shezi Island Taipei view",
            transfer: "社子輕軌 (Planned)"
          },
          {
            code: "Y25",
            section: "north",
            name: "士林區公所站",
            nameEn: "Shilin Dist. Office",
            location: "士林區中正路與基河路口",
            desc: "士林行政中心",
            coords: { lat: 25.0915, lng: 121.5215 },
            imageQuery: "Shilin District Office Taipei",
            transfer: null
          },
          {
            code: "Y26",
            section: "north",
            name: "士林站",
            nameEn: "Shilin Station",
            location: "士林區中正路 (捷運士林站)",
            desc: "轉乘淡水信義線",
            coords: { lat: 25.0935, lng: 121.5265 },
            imageQuery: "Shilin MRT Station elevated",
            transfer: "淡水信義線 (Red Line)"
          },
          {
            code: "Y27",
            section: "north",
            name: "福德洋站",
            nameEn: "Fudeyang / Yangming HS",
            location: "士林區中正路與雨農路口",
            desc: "鄰近陽明高中",
            coords: { lat: 25.0955, lng: 121.5335 },
            imageQuery: "Yangming High School Taipei",
            transfer: null
          },
          {
            code: "Y28",
            section: "north",
            name: "故宮站",
            nameEn: "National Palace Museum",
            location: "士林區至善路二段 (故宮路口)",
            desc: "鄰近故宮博物院",
            coords: { lat: 25.1015, lng: 121.5475 },
            imageQuery: "National Palace Museum Taipei exterior",
            transfer: null
          },
          {
            code: "Y29",
            section: "north",
            name: "劍南路站",
            nameEn: "Jiannan Road",
            location: "中山區北安路 (劍南路站)",
            desc: "轉乘文湖線",
            coords: { lat: 25.0845, lng: 121.5555 },
            imageQuery: "Jiannan Road MRT Station with Ferris Wheel",
            transfer: "文湖線 (Wenhu Line)"
          }
        ];
    
        let map;
        let markers = {}; // Stores Leaflet marker objects
        let polylineNorth, polylineSouth;
    
        // --- Map Initialization (Leaflet) ---
        function initMap() {
            // Initialize Leaflet Map
            // CartoDB.Positron is a free tile layer that looks clean (Apple Maps like)
            map = L.map('map', {
                center: [25.04, 121.52],
                zoom: 12,
                zoomControl: false // We can add it manually if needed, but default is top-left
            });

            // Add Zoom control to bottom right to match UI design
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Add Tile Layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
    
            // Routes (Polylines)
            const southPath = stations.filter(s => s.section === 'south').map(s => [s.coords.lat, s.coords.lng]);
            const northPath = stations.filter(s => s.section === 'north').map(s => [s.coords.lat, s.coords.lng]);
    
            const polylineOpts = {
                color: "#F59E0B", // Yellow-500
                weight: 5,
                opacity: 1.0,
                lineCap: 'round',
                lineJoin: 'round'
            };
    
            if (southPath.length > 0) L.polyline(southPath, polylineOpts).addTo(map);
            if (northPath.length > 0) L.polyline(northPath, polylineOpts).addTo(map);
    
            // Markers
            stations.forEach(station => {
                // Custom Icon using DivIcon
                const iconHtml = `<div class="marker-pin" id="pin-${station.code}">${station.code}</div>`;
                
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32], // Anchor point bottom-center roughly
                    popupAnchor: [0, -36]
                });

                const marker = L.marker([station.coords.lat, station.coords.lng], {
                    icon: customIcon,
                    title: station.name
                }).addTo(map);

                // Click event
                marker.on('click', () => {
                    selectStation(station.code);
                });

                markers[station.code] = { 
                    element: marker, 
                    data: station
                };
            });
    
            renderList('all');
        }
    
        // --- UI Logic ---
    
        function filterStations(type) {
            const btns = {
                'all': document.getElementById('btn-all'),
                'north': document.getElementById('btn-north'),
                'south': document.getElementById('btn-south')
            };
    
            Object.values(btns).forEach(btn => {
                btn.className = "flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 hover:text-gray-900 transition-all hover:bg-white/50";
            });
    
            const activeBtn = btns[type];
            activeBtn.className = "flex-1 py-1.5 text-xs font-semibold rounded-md transition-all shadow-sm bg-white text-gray-900";
    
            renderList(type);
        }
    
        function renderList(filter) {
            const container = document.getElementById('station-list-container');
            container.innerHTML = '';
    
            const filteredStations = stations.filter(s => filter === 'all' || s.section === filter);
    
            filteredStations.forEach(station => {
                const card = document.createElement('div');
                card.id = `card-${station.code}`;
                card.className = "group bg-white rounded-xl p-4 cursor-pointer border border-gray-100/50 shadow-[0_2px_8px_rgba(0,0,0,0.04)] hover:shadow-[0_4px_12px_rgba(0,0,0,0.08)] hover:scale-[1.01] transition-all duration-300 relative overflow-hidden";
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2.5">
                            <span class="bg-yellow-100 text-yellow-800 text-[11px] font-bold px-2 py-1 rounded-md min-w-[34px] text-center tracking-tight">${station.code}</span>
                            <h3 class="font-bold text-gray-900 text-[15px] tracking-tight group-hover:text-yellow-600 transition-colors">${station.name}</h3>
                        </div>
                        ${station.transfer ? '<span class="material-symbols-rounded text-blue-500/80 text-[18px]" title="轉乘站">cached</span>' : ''}
                    </div>
                    
                    <p class="text-[11px] text-gray-400 font-medium mb-3 uppercase tracking-wide pl-0.5">${station.nameEn}</p>
                    
                    <div class="flex items-start gap-2 text-gray-500 text-xs leading-relaxed">
                        <span class="material-symbols-rounded text-[14px] mt-[1px] shrink-0 text-gray-400">location_on</span>
                        <span class="font-medium opacity-90">${station.location}</span>
                    </div>
                `;
    
                card.onclick = () => selectStation(station.code);
                container.appendChild(card);
            });
        }
    
        function selectStation(code) {
            const entry = markers[code];
            if (!entry) return;
    
            const { element: marker, data } = entry;
    
            // 1. Highlight List Item
            document.querySelectorAll('#station-list-container > div').forEach(el => {
                el.classList.remove('ring-2', 'ring-yellow-400', 'bg-yellow-50/50');
                el.classList.add('bg-white');
            });
            const card = document.getElementById(`card-${code}`);
            if (card) {
                card.classList.remove('bg-white');
                card.classList.add('ring-2', 'ring-yellow-400', 'bg-yellow-50/50');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
    
            // 2. Highlight Marker (Manipulate the DIV icon)
            // Reset all markers
            Object.keys(markers).forEach(k => {
                const pin = document.getElementById(`pin-${k}`);
                if(pin) pin.classList.remove('active');
                markers[k].element.setZIndexOffset(0); // Reset z-index
            });
            
            // Set active
            const activePin = document.getElementById(`pin-${code}`);
            if(activePin) activePin.classList.add('active');
            marker.setZIndexOffset(1000); // Bring to front
    
            // 3. Pan Map
            map.flyTo([data.coords.lat, data.coords.lng], 15, {
                animate: true,
                duration: 0.8
            });
    
            // 4. Create Popup Content
            // NOTE: Using a placeholder image for demo since Google Search images won't load from another domain easily
            const imgUrl = `https://source.unsplash.com/800x450/?subway,station,taipei,${code}`; 
            
            const contentHTML = `
                <div class="w-full flex flex-col font-sans">
                    <div class="relative w-full h-36 bg-gray-200 overflow-hidden group">
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">
                           Image: ${data.nameEn}
                        </div>
                        <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 relative z-10" alt="${data.name}" onerror="this.style.display='none'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent z-20"></div>
                        <div class="absolute bottom-3 left-3 text-white z-30">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="bg-yellow-400 text-black text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">${data.code}</span>
                                <h3 class="font-bold text-lg shadow-black drop-shadow-sm">${data.name}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-white">
                        <p class="text-[10px] text-gray-400 font-bold tracking-wider uppercase mb-3">${data.nameEn}</p>
                        <div class="space-y-3">
                            <div class="flex gap-2.5 items-start">
                                <span class="material-symbols-rounded text-gray-400 text-[16px] mt-0.5">location_on</span>
                                <span class="text-xs text-gray-600 leading-relaxed">${data.location}</span>
                            </div>
                            <div class="flex gap-2.5 items-start">
                                <span class="material-symbols-rounded text-gray-400 text-[16px] mt-0.5">info</span>
                                <span class="text-xs text-gray-600 leading-relaxed">${data.desc}</span>
                            </div>
                            ${data.transfer ? `
                            <div class="mt-2 flex items-center gap-2 text-blue-600 bg-blue-50/80 px-2 py-1.5 rounded-lg border border-blue-100">
                                <span class="material-symbols-rounded text-[16px]">swap_calls</span>
                                <span class="text-xs font-semibold">轉乘: ${data.transfer}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            marker.bindPopup(contentHTML).openPopup();
        }
    
        // --- Export HTML Function ---
        function exportHtml() {
            const clone = document.documentElement.cloneNode(true);
            
            // Clean up the map container
            const mapDiv = clone.querySelector('#map');
            if (mapDiv) {
                mapDiv.innerHTML = '';
                mapDiv.removeAttribute('class'); // Leaflet adds classes we want to reset
                mapDiv.className = "w-full h-full z-0";
            }
            
            const htmlContent = `<!DOCTYPE html>\n${clone.outerHTML}`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'taipei_mrt_map.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    
        // Initialize
        document.addEventListener('DOMContentLoaded', initMap);
      </script>
</body>
</html>
