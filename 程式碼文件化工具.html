<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼ç¢¼æ–‡ä»¶åŒ–å·¥å…·</title>
    <!-- å¼•å…¥ Tailwind CSS ä»¥ç¾åŒ–ä»‹é¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ highlight.js ç”¨æ–¼ç¨‹å¼ç¢¼èªæ³•é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/gruvbox-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- è¼‰å…¥é¡å¤–çš„ç¨‹å¼èªè¨€é«˜äº®è…³æœ¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/markdown.min.js"></script>
    <!-- å¼•å…¥ jspdf å’Œ html2canvas ç”¨æ–¼ PDF ç”Ÿæˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- å¼•å…¥ Mermaid.js ç”¨æ–¼æ¸²æŸ“åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        // è‡ªè¨‚å“è¶Šé›œèªŒæœ¨è³ªèª¿é¢¨æ ¼çš„ Tailwind è‰²å½©
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'wood-bg': '#FBF9F6',      // äºéº»ç™½èƒŒæ™¯
                        'wood-panel': '#F1ECE5',   // æš–ç±³è‰²é¢æ¿
                        'wood-text': '#5D4037',    // èƒ¡æ¡ƒæœ¨è‰²æ–‡å­—
                        'wood-subtle': '#A1887F',  // ç°è¤è‰²æ¬¡è¦æ–‡å­—
                        'wood-border': '#D7CCC8', // æ·ºè¤è‰²é‚Šæ¡†
                        'wood-accent': '#8D6E63',  // æ²‰ç©©æœ¨è³ªå¼·èª¿è‰²
                        'wood-accent-hover': '#6D4C41', // æ·±æœ¨è‰²æŒ‰éˆ•æ‡¸åœ
                    },
                    fontFamily: {
                        'sans': ['Noto Sans JP', 'sans-serif'],
                        'serif': ['Noto Serif JP', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* è‡ªè¨‚ highlight.js çš„å®¹å™¨æ¨£å¼ä»¥åŒ¹é…æ–°ä¸»é¡Œ */
        .hljs-container {
            padding: 1.5rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            background-color: #F9F5F1;
            border: 1px solid #D7CCC8;
        }
        /* èª¿æ•´é¸å–®æ¨£å¼ */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238D6E63' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-wood-bg text-wood-text font-sans flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-7xl">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold font-serif text-wood-text">ç¨‹å¼ç¢¼æ–‡ä»¶åŒ–å·¥å…·</h1>
            <p class="text-wood-subtle mt-2">å°‡æ‚¨çš„ç¨‹å¼ç¢¼ï¼Œè½‰æ›ç‚ºå°ˆæ¥­ã€ç°¡æ½”çš„æ–‡ä»¶æ ¼å¼ã€‚</p>
            <p class="text-wood-subtle mt-4 text-sm">è£½ä½œè€…ï¼šé™³æ”¿å¾·</p>
        </header>

        <!-- ä¸»é«”å…§å®¹ï¼šå·¦å³ä½ˆå±€ -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- å·¦å´ï¼šç¨‹å¼ç¢¼è¼¸å…¥å€ -->
            <div class="bg-wood-panel p-6 rounded-lg flex flex-col">
                <h2 class="text-2xl font-serif font-semibold mb-4 border-b border-wood-border pb-2">1. è¼¸å…¥ç¨‹å¼ç¢¼</h2>
                <div class="flex items-center mb-4">
                    <label for="code_type" class="mr-3 text-wood-text">ç¨‹å¼ç¢¼é¡å‹:</label>
                    <select id="code_type" class="bg-wood-bg text-wood-text rounded px-3 py-1.5 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                        <option value="html">HTML</option>
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="css">CSS</option>
                        <option value="sql">SQL</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="typescript">TypeScript</option>
                        <option value="markdown">Markdown</option>
                        <option value="svg">SVG</option>
                        <option value="mermaid">Mermaid</option>
                    </select>
                </div>
                <textarea id="code_input" class="w-full h-96 flex-grow bg-white text-gray-800 p-4 rounded-md font-mono text-sm border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ç¨‹å¼ç¢¼..."></textarea>
            </div>

            <!-- å³å´ï¼šè¼¸å‡ºèˆ‡æ§åˆ¶å€ -->
            <div class="bg-wood-panel p-6 rounded-lg flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-serif font-semibold mb-4 border-b border-wood-border pb-2">2. é¸æ“‡è¼¸å‡º</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="output_format" class="block mb-2 text-wood-text">é¸æ“‡è½‰æ›æ ¼å¼:</label>
                            <select id="output_format" class="w-full bg-wood-bg text-wood-text rounded px-3 py-2 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                                <option value="pdf">PDF (.pdf)</option>
                                <option value="png">åœ–å½¢æª” (.png)</option>
                            </select>
                        </div>
                        <div id="orientation_controls" class="mb-4">
                            <label for="pdf_orientation" class="block mb-2 text-wood-text">PDF æ–¹å‘:</label>
                            <select id="pdf_orientation" class="w-full bg-wood-bg text-wood-text rounded px-3 py-2 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                                <option value="p">ç›´å¼ (Portrait)</option>
                                <option value="l">æ©«å¼ (Landscape)</option>
                            </select>
                            <label for="pdf_resolution" class="block mt-4 mb-2 text-wood-text">PDF è§£æåº¦:</label>
                            <select id="pdf_resolution" class="w-full bg-wood-bg text-wood-text rounded px-3 py-2 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                                <option value="1">æ¨™æº–</option>
                                <option value="2" selected>é«˜è§£æåº¦</option>
                                <option value="4">è¶…é«˜è§£æåº¦</option>
                            </select>
                            <label for="pdf_scale" class="block mt-4 mb-2 text-wood-text">ç¸®æ”¾æ¯”ä¾‹ (%):</label>
                            <input type="number" id="pdf_scale" value="100" min="10" max="200" step="1" class="w-full bg-wood-bg text-wood-text rounded px-3 py-2 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                        </div>
                        <div id="resolution_controls" class="mb-4 hidden">
                            <label for="png_resolution" class="block mb-2 text-wood-text">PNG è§£æåº¦:</label>
                            <select id="png_resolution" class="w-full bg-wood-bg text-wood-text rounded px-3 py-2 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                                <option value="1">æ¨™æº– (1x)</option>
                                <option value="2" selected>é«˜è§£æåº¦ (2x)</option>
                                <option value="4">è¶…é«˜è§£æåº¦ (4x)</option>
                            </select>
                            <label for="png_orientation" class="block mt-4 mb-2 text-wood-text">PNG æ–¹å‘:</label>
                            <select id="png_orientation" class="w-full bg-wood-bg text-wood-text rounded px-3 py-2 border border-wood-border focus:outline-none focus:ring-2 focus:ring-wood-accent">
                                <option value="p">ç›´å¼ (Portrait)</option>
                                <option value="l">æ©«å¼ (Landscape)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="convert_btn" class="w-full bg-wood-accent hover:bg-wood-accent-hover text-white font-bold py-3 px-4 rounded-md text-lg transition duration-300">
                        ğŸš€ é–‹å§‹è½‰æ›ä¸¦ä¸‹è¼‰
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ç”¨æ–¼ PDF/SVG æ¸²æŸ“çš„éš±è—å®¹å™¨ -->
    <div id="render-container" class="fixed top-0 -z-10 bg-white text-black p-8" style="width: 210mm; left: -9999px;"></div>
    
    <!-- è¼‰å…¥å‹•ç•« -->
    <div id="loader" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-wood-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="O 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg text-wood-text">æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({ startOnLoad: false });

        // ç²å– DOM å…ƒç´ 
        const codeInput = document.getElementById('code_input');
        const codeTypeSelect = document.getElementById('code_type');
        const outputFormatSelect = document.getElementById('output_format');
        const convertBtn = document.getElementById('convert_btn');
        const renderContainer = document.getElementById('render-container');
        const loader = document.getElementById('loader');
        const pdfOrientationSelect = document.getElementById('pdf_orientation');
        const pdfResolutionSelect = document.getElementById('pdf_resolution');
        const pdfScaleInput = document.getElementById('pdf_scale');
        const orientationControls = document.getElementById('orientation_controls');
        const pngResolutionSelect = document.getElementById('png_resolution');
        const resolutionControls = document.getElementById('resolution_controls');
        const pngOrientationSelect = document.getElementById('png_orientation');

        // --- åŠŸèƒ½å¯¦ç¾ ---

        /**
         * é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
         * @param {boolean} show - æ˜¯å¦é¡¯ç¤º
         */
        function toggleLoader(show) {
            loader.classList.toggle('hidden', !show);
        }

        /**
         * æº–å‚™ç”¨æ–¼æ¸²æŸ“çš„ HTML å…§å®¹
         * @returns {string} - æº–å‚™å¥½çš„ HTML å­—ä¸²
         */
        function prepareContentForRender() {
            const code = codeInput.value;
            const codeType = codeTypeSelect.value;
            const highlightableLanguages = ['python', 'javascript', 'css', 'sql', 'java', 'cpp', 'typescript', 'markdown'];
            
            if (highlightableLanguages.includes(codeType)) {
                 if (hljs.getLanguage(codeType)) {
                    const highlightedCode = hljs.highlight(code, { language: codeType }).value;
                    return `<div class="hljs-container"><pre><code class="language-${codeType} hljs">${highlightedCode}</code></pre></div>`;
                } else {
                    const highlightedCode = hljs.highlightAuto(code).value;
                    return `<div class="hljs-container"><pre><code class="hljs">${highlightedCode}</code></pre></div>`;
                }
            } else if (codeType === 'mermaid') {
                // å°æ–¼ Mermaidï¼Œè¿”å›å¸¶æœ‰ class çš„ divï¼Œä»¥ä¾¿å¾ŒçºŒæ¸²æŸ“
                return `<div class="mermaid">${code}</div>`;
            }
            // å°æ–¼ HTML å’Œ SVGï¼Œç›´æ¥è¿”å›åŸå§‹ç¢¼
            return code;
        }

        /**
         * å°‡å…§å®¹è½‰æ›ç‚º PDF (æ”¯æ´å¤šé )
         */
        async function convertToPdf() {
            toggleLoader(true);
            const contentHtml = prepareContentForRender();
            renderContainer.innerHTML = contentHtml;
            
            // å¦‚æœæ˜¯ Mermaidï¼Œå…ˆæ¸²æŸ“å®ƒ
            if (codeTypeSelect.value === 'mermaid') {
                const mermaidDiv = renderContainer.querySelector('.mermaid');
                if (mermaidDiv) {
                    await mermaid.run({ nodes: [mermaidDiv] });
                }
            }

            const originalWidth = renderContainer.style.width;
            const orientation = pdfOrientationSelect.value;
            
            const resolutionValue = parseInt(pdfResolutionSelect.value, 10);
            const scale = resolutionValue === 1 ? 2 : (resolutionValue === 2 ? 3 : 4);

            const customScale = parseInt(pdfScaleInput.value, 10) / 100.0;
            renderContainer.style.width = orientation === 'l' ? '297mm' : '210mm';

            try {
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(renderContainer, {
                    scale: scale,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: renderContainer.scrollWidth,
                    windowHeight: renderContainer.scrollHeight
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.92);
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                
                const pdf = new jsPDF({
                    orientation: orientation,
                    unit: 'pt',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const ratio = pdfWidth / imgWidth;
                const scaledImgHeight = imgHeight * ratio;

                const finalImgWidth = pdfWidth * customScale;
                const finalImgHeight = scaledImgHeight * customScale;

                let heightLeft = finalImgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'JPEG', 0, position, finalImgWidth, finalImgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = heightLeft - finalImgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, finalImgWidth, finalImgHeight);
                    heightLeft -= pdfHeight;
                }
                
                pdf.save('output.pdf');

            } catch (error) {
                console.error("PDF ç”Ÿæˆå¤±æ•—:", error);
                alert("æŠ±æ­‰ï¼Œç”Ÿæˆ PDF æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            } finally {
                renderContainer.innerHTML = '';
                renderContainer.style.width = originalWidth;
                toggleLoader(false);
            }
        }
        
        /**
         * å°‡å…§å®¹è½‰æ›ç‚º PNG åœ–å½¢æª”
         */
        async function convertToPng() {
            toggleLoader(true);
            const contentHtml = prepareContentForRender();
            renderContainer.innerHTML = contentHtml;
            
            // å¦‚æœæ˜¯ Mermaidï¼Œå…ˆæ¸²æŸ“å®ƒ
            if (codeTypeSelect.value === 'mermaid') {
                const mermaidDiv = renderContainer.querySelector('.mermaid');
                if (mermaidDiv) {
                    await mermaid.run({ nodes: [mermaidDiv] });
                }
            }
            
            const originalWidth = renderContainer.style.width;
            const orientation = pngOrientationSelect.value;
            renderContainer.style.width = orientation === 'l' ? '297mm' : '210mm';

            try {
                const scale = parseInt(pngResolutionSelect.value, 10);
                const canvas = await html2canvas(renderContainer, { 
                    scale: scale, 
                    useCORS: true,
                    backgroundColor: null,
                    windowWidth: renderContainer.scrollWidth,
                    windowHeight: renderContainer.scrollHeight
                });
                const imgData = canvas.toDataURL('image/png');
                
                const a = document.createElement('a');
                a.href = imgData;
                a.download = 'output.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

            } catch (error) {
                console.error("PNG ç”Ÿæˆå¤±æ•—:", error);
                alert("æŠ±æ­‰ï¼Œç”Ÿæˆåœ–å½¢æª”æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
            } finally {
                renderContainer.innerHTML = '';
                renderContainer.style.width = originalWidth;
                toggleLoader(false);
            }
        }
        
        /**
         * æ ¹æ“šé¸æ“‡çš„æ ¼å¼æ›´æ–°é¡¯ç¤ºçš„æ§åˆ¶é¸é …
         */
        function updateControlsVisibility() {
            const selectedFormat = outputFormatSelect.value;
            orientationControls.classList.toggle('hidden', selectedFormat !== 'pdf');
            resolutionControls.classList.toggle('hidden', selectedFormat !== 'png');
        }

        // --- äº‹ä»¶ç›£è½ ---
        convertBtn.addEventListener('click', () => {
            if (!codeInput.value.trim()) {
                alert("è«‹å…ˆè¼¸å…¥ä¸€äº›ç¨‹å¼ç¢¼ï¼");
                return;
            }

            const format = outputFormatSelect.value;
            switch (format) {
                case 'pdf':
                    convertToPdf();
                    break;
                case 'png':
                    convertToPng();
                    break;
                default:
                    alert('ç„¡æ•ˆçš„æ ¼å¼');
            }
        });

        outputFormatSelect.addEventListener('change', updateControlsVisibility);

        // åˆå§‹åŒ–æ™‚æ ¹æ“šé è¨­é¸é …æ±ºå®šé¡¯ç¤ºå“ªå€‹æ§åˆ¶é¸é …
        updateControlsVisibility();

    </script>
</body>
</html>

