<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HEIC批次轉檔工具</title>
  <!-- 保留功能腳本 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    /* ===== macOS 風格：系統字體與顏色 ===== */
    :root{
      --mac-bg: #f5f5f7;
      --surface-glass: rgba(255,255,255,0.55);
      --glass-border: rgba(255,255,255,0.6);
      --shadow: 0 10px 30px rgba(0,0,0,0.08);

      --text: #1d1d1f;
      --text-subtle: #6e6e73;
      --text-muted: #86868b;

      --primary: #007aff;
      --primary-hover: #0066d6;
      --primary-tint: rgba(0,122,255,0.12);

      --border: #d2d2d7;

      --success-bg: #d1f2d6;
      --success-text: #1b7a3d;
      --warn-bg: #f6f6f7;
      --warn-text: #6e6e73;
      --process-bg: #dbe9ff;
      --process-text: #0b63ce;
      --error-bg: #ffe2e0;
      --error-text: #c23b2a;

      --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      --radius-lg: 20px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --blur: 20px;
      --saturate: 180%;
    }

    html, body { height: 100%; }
    body{
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: var(--mac-bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    /* ===== 容器：毛玻璃卡片 ===== */
    .container{
      width: 100%;
      max-width: 920px;
      background: var(--surface-glass);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--blur)) saturate(var(--saturate));
      -webkit-backdrop-filter: blur(var(--blur)) saturate(var(--saturate));
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 32px 32px 40px;
    }

    /* ===== 標題列：左側三個原點 + 主標題（同一行） ===== */
    .header{ margin-bottom: 28px; }
    .title-row{
      display: flex;
      align-items: center;
      /* 讓主標題置中，同時保留左側三原點在同一行最左邊 */
      position: relative;
      justify-content: center;
      gap: 12px;
    }
    .traffic-lights{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-right: 4px;
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
    }
    .dot{
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 0.5px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 0 rgba(0,0,0,0.06) inset;
    }
    .dot.red{    background:#ff5f57; }
    .dot.yellow{ background:#febc2e; }
    .dot.green{  background:#28c840; }

    .header h1{
      font-size: 28px;
      letter-spacing: .2px;
      margin: 0;
      font-weight: 700;
      color: var(--text);
      text-align: center; /* 置中標題 */
    }
    .subtitle{
      margin: 8px 0 2px;
      color: var(--text-subtle);
      font-size: 14px;
      line-height: 1.6;
      text-align: center; /* 置中副標題 */
    }
    .author-name{
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 12px;
      text-align: center; /* 置中作者 */
    }

    /* ===== 上傳區（保留原功能與文案） ===== */
    .upload-wrapper{ display: flex; justify-content: center; margin: 18px 0 28px; }
    .upload-area{
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px 18px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(16px) saturate(var(--saturate));
      -webkit-backdrop-filter: blur(16px) saturate(var(--saturate));
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      cursor: pointer;
      max-width: 360px;
      width: 100%;
      text-align: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
    }
    .upload-area:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,0.08); border-color: var(--primary); }
    .upload-icon{ display:block; margin: 2px auto 8px; width:26px; height:26px; }
    .upload-text{ color: var(--primary-hover); font-weight:700; font-size:15px; letter-spacing:.2px; }
    .file-input{ display:none; }

    /* ===== 控制列（毛玻璃、系統藍按鈕） ===== */
    .controls{
      display:flex; gap:20px; flex-wrap:wrap; align-items:center;
      background: var(--surface-glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 16px;
      backdrop-filter: blur(16px) saturate(var(--saturate));
      -webkit-backdrop-filter: blur(16px) saturate(var(--saturate));
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }
    .control-group{ display:flex; align-items:center; gap:12px; flex-grow:1; min-width:220px; }
    .control-group label{ white-space:nowrap; font-weight:600; color: var(--text); font-size:14px; }
    .output-select{
      padding:10px 36px 10px 12px;
      font-size:14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
      appearance:none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="none" stroke="%23007aff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 5l6 6 6-6"/></svg>');
      background-repeat:no-repeat; background-position:right 12px center;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .output-select:hover{ border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-tint); }

    .quality-slider{ width:200px; height:6px; border-radius:999px; background:#e9e9ec; outline:none; -webkit-appearance:none; position:relative; }
    .quality-slider::-webkit-slider-thumb{
      -webkit-appearance:none; width:22px; height:22px; border-radius:50%;
      background:#fff; border:2px solid var(--primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12); cursor:pointer; transition: transform .15s ease;
    }
    .quality-slider::-webkit-slider-thumb:hover{ transform: scale(1.06); }
    .quality-value{ font-weight:700; color: var(--primary-hover); min-width:56px; text-align:center; font-size:14px; }

    .btn{ padding: 12px 22px; border:none; border-radius: 12px; cursor:pointer; font-size:14px; font-weight:600; letter-spacing:.2px; transition: transform .15s ease, box-shadow .15s ease, background .15s ease; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none !important; transform:none !important; }
    .btn-primary{ background: var(--primary); color:#fff; box-shadow: 0 6px 16px rgba(0,122,255,0.35); }
    .btn-primary:hover{ background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,122,255,0.38); }
    .btn-secondary{ background:#fff; color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover{ background:#f7f7f8; transform: translateY(-1px); }

    /* ===== 統計卡片（毛玻璃） ===== */
    .stats{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom: 18px; }
    .stat-card{ background: var(--surface-glass); border: 1px solid var(--glass-border); border-radius: var(--radius-md); text-align:center; padding: 10px 12px; box-shadow: var(--shadow); transition: transform .15s ease, box-shadow .15s ease; }
    .stat-card:hover{ transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,0,0,0.08); }
    .stat-number{ font-size:22px; font-weight:800; color: var(--primary-hover); display:block; }
    .stat-label{ color: var(--text-muted); font-size: 12px; margin-top: 4px; font-weight:400; }

    /* ===== 進度條 ===== */
    .progress-bar{ width:100%; height:10px; background:#e9e9ec; border-radius:999px; overflow:hidden; margin:22px 0 8px; }
    .progress-fill{ height:100%; background: var(--primary); width:0%; transition: width .25s ease; }
    .progress-text{ text-align:center; color: var(--text-subtle); font-weight:600; font-size:13px; }

    /* ===== 檔案清單（毛玻璃面板） ===== */
    .file-list-container{
      max-height: 220px; overflow-y:auto; margin: 18px 0 22px;
      border: 1px solid var(--glass-border); border-radius: var(--radius-md);
      padding: 10px; background: var(--surface-glass);
      backdrop-filter: blur(16px) saturate(var(--saturate));
      -webkit-backdrop-filter: blur(16px) saturate(var(--saturate));
      box-shadow: var(--shadow);
    }
    .file-item{
      display:flex; align-items:center; padding:10px 12px;
      background: rgba(255,255,255,0.8); border-radius: 12px; margin-bottom:10px;
      border-left: 6px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .file-info{ flex:1; }
    .file-name{ font-weight:600; color: var(--text); margin:0; }
    .file-size{ color: var(--text-muted); font-size:12px; margin-left:6px; }

    .file-status{ padding:6px 12px; border-radius:999px; font-size:12px; font-weight:700; letter-spacing:.2px; }
    .status-waiting{ background: var(--warn-bg); color: var(--warn-text); }
    .status-processing{ background: var(--process-bg); color: var(--process-text); }
    .status-completed{ background: var(--success-bg); color: var(--success-text); }
    .status-error{ background: var(--error-bg); color: var(--error-text); }

    /* ===== 結果區 ===== */
    .results{ margin-top: 28px; text-align:center; }
    .download-all{ margin:16px 0 6px; display:flex; justify-content:center; align-items:center; gap:12px; }

    /* ===== 訊息盒（毛玻璃） ===== */
    .message-box{
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--surface-glass); border: 1px solid var(--glass-border);
      border-radius: var(--radius-md); padding: 22px; box-shadow: 0 18px 44px rgba(0,0,0,0.18);
      text-align:center; z-index:1000; display:none; animation: fadeIn .25s ease-out;
      backdrop-filter: blur(20px) saturate(var(--saturate)); -webkit-backdrop-filter: blur(20px) saturate(var(--saturate));
    }
    .message-box .message-content{ display:flex; flex-direction:column; align-items:center; gap:12px; }
    .message-box .message-icon{ font-size:28px; color: var(--primary); }
    .message-box.error-box .message-icon{ color: #c23b2a; }
    .message-box.success-box .message-icon{ color: #1b7a3d; }
    .message-box .message-text{ font-weight:600; color: var(--text); margin:0; }
    .message-box .close-btn{ background:#fff; border: 1px solid var(--border); padding:8px 14px; border-radius: 10px; cursor:pointer; font-weight:600; }
    @keyframes fadeIn{ from{opacity:0; transform:translate(-50%,-46%);} to{opacity:1; transform:translate(-50%,-50%);} }

    /* ===== 響應式 ===== */
    @media (max-width: 768px){
      body{ padding: 16px; }
      .container{ padding: 24px; }
      .header h1{ font-size: 22px; }
      .controls{ flex-direction: column; align-items: stretch; }
      .control-group{ min-width: unset; }
      .btn{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title-row">
        <!-- macOS 三個原點（與主標題同一行、靠最左；主標題置中） -->
        <div class="traffic-lights" aria-hidden="true">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <h1>HEIC 批次轉檔工具</h1>
      </div>
      <p class="subtitle">輕鬆將 iPhone 的 HEIC 圖片轉換為 JPG、PNG、WebP 等多種格式</p>
      <p class="author-name">製作者：陳政德</p>
    </div>

    <div class="upload-wrapper">
      <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 2H8C6.89543 2 6 2.89543 6 4V20C6 21.1046 6.89543 22 8 22H16C17.1046 22 18 21.1046 18 20V4C18 2.89543 17.1046 2 16 2Z" stroke="var(--primary-hover)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 18H12.01" stroke="var(--primary-hover)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="9.5" cy="7.5" r="1.5" fill="var(--primary)"/>
            <path d="M6 15l2.5-2.5c.6-.6 1.7-.6 2.3 0l4.5 4.5" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 13l1.5-1.5c.6-.6 1.7-.6 2.3 0L20 13" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="upload-text">點選 iPhone 的 HEIC 格式照片</div>
      </div>
    </div>

    <input type="file" id="fileInput" class="file-input" multiple accept=".heic,.HEIC">

    <div class="controls">
      <div class="control-group">
        <label for="outputType">輸出類型:</label>
        <select id="outputType" class="output-select">
          <option value="image/jpeg">JPG</option>
          <option value="image/png">PNG</option>
          <option value="image/gif">GIF</option>
          <option value="image/webp">WebP</option>
        </select>
      </div>
      <div class="control-group">
        <label for="qualitySlider">品質:</label>
        <input type="range" id="qualitySlider" class="quality-slider" min="0.1" max="1" step="0.1" value="0.8">
        <span class="quality-value" id="qualityValue">80%</span>
      </div>
      <button class="btn btn-primary" id="convertBtn" disabled>開始轉換</button>
      <button class="btn btn-secondary" id="clearBtn">清除檔案</button>
    </div>

    <div class="stats" id="stats" style="display:none;">
      <div class="stat-card">
        <span class="stat-number" id="totalFiles">0</span>
        <div class="stat-label">總檔案數</div>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="completedFiles">0</span>
        <div class="stat-label">已完成</div>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalSize">0 MB</span>
        <div class="stat-label">總大小</div>
      </div>
    </div>

    <div class="progress-bar" id="progressBar" style="display:none;">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText"></div>

    <div class="file-list-container">
      <div class="file-list" id="fileList"></div>
    </div>

    <div class="results" id="results" style="display:none;">
      <div class="download-all">
        <button class="btn btn-primary" id="downloadAllBtn">📥 下載全部檔案</button>
      </div>
    </div>
  </div>

  <div class="message-box" id="messageBox">
    <div class="message-content">
      <span class="message-icon"></span>
      <p class="message-text" id="messageText"></p>
      <button class="close-btn" onclick="document.getElementById('messageBox').style.display='none'">關閉</button>
    </div>
  </div>

  <!-- 原功能 JavaScript 保留，僅樣式改造 -->
  <script>
    class HEICConverter {
      constructor() {
        this.files = [];
        this.convertedFiles = [];
        this.quality = 0.8;
        this.outputType = 'image/jpeg';
        this.initializeElements();
        this.bindEvents();
      }
      initializeElements() {
        this.uploadArea = document.querySelector('.upload-area');
        this.fileInput = document.getElementById('fileInput');
        this.fileList = document.getElementById('fileList');
        this.convertBtn = document.getElementById('convertBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.qualitySlider = document.getElementById('qualitySlider');
        this.qualityValue = document.getElementById('qualityValue');
        this.outputTypeSelect = document.getElementById('outputType');
        this.progressBar = document.getElementById('progressBar');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.stats = document.getElementById('stats');
        this.results = document.getElementById('results');
        this.downloadAllBtn = document.getElementById('downloadAllBtn');
        this.messageBox = document.getElementById('messageBox');
        this.messageText = document.getElementById('messageText');
        this.messageIcon = this.messageBox.querySelector('.message-icon');
      }
      bindEvents() {
        this.fileInput.addEventListener('change', (e) => { this.handleFiles(e.target.files); });
        this.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); this.uploadArea.classList.add('drag-over'); });
        this.uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); this.uploadArea.classList.remove('drag-over'); });
        this.uploadArea.addEventListener('drop', (e) => { e.preventDefault(); this.uploadArea.classList.remove('drag-over'); this.handleFiles(e.dataTransfer.files); });
        this.qualitySlider.addEventListener('input', (e) => {
          this.quality = parseFloat(e.target.value);
          this.qualityValue.textContent = Math.round(this.quality * 100) + '%';
        });
        this.outputTypeSelect.addEventListener('change', (e) => { this.outputType = e.target.value; });
        this.convertBtn.addEventListener('click', () => { this.startConversion(); });
        this.clearBtn.addEventListener('click', () => { this.clearFiles(); });
        this.downloadAllBtn.addEventListener('click', () => { this.downloadAll(); });
      }
      handleFiles(fileList) {
        const heicFiles = Array.from(fileList).filter(file => file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic'));
        if (heicFiles.length === 0) {
          this.showMessageBox('請選擇 HEIC 檔案！', 'error');
          return;
        }
        this.files = [...this.files, ...heicFiles];
        this.updateFileList();
        this.updateStats();
        this.convertBtn.disabled = false;
      }
      updateFileList() {
        this.fileList.innerHTML = '';
        this.files.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <div class="file-info">
              <div class="file-name">
                ${file.name}
                <span class="file-size">(${this.formatFileSize(file.size)})</span>
              </div>
            </div>
            <div class="file-status status-waiting" id="status-${index}">等待中</div>
          `;
          this.fileList.appendChild(fileItem);
        });
      }
      updateStats() {
        const totalSize = this.files.reduce((sum, file) => sum + file.size, 0);
        document.getElementById('totalFiles').textContent = this.files.length;
        document.getElementById('completedFiles').textContent = this.convertedFiles.length;
        document.getElementById('totalSize').textContent = this.formatFileSize(totalSize);
        this.stats.style.display = this.files.length > 0 ? 'grid' : 'none';
      }
      async startConversion() {
        if (this.files.length === 0) return;
        this.convertBtn.disabled = true;
        this.progressBar.style.display = 'block';
        this.convertedFiles = [];
        for (let i = 0; i < this.files.length; i++) {
          const file = this.files[i];
          const statusElement = document.getElementById(`status-${i}`);
          try {
            statusElement.textContent = '轉換中...';
            statusElement.className = 'file-status status-processing';
            this.updateProgress(i, this.files.length, `正在轉換: ${file.name}`);
            const convertedBlob = await this.convertHEIC(file);
            const newExtension = this.getExtFromMime(this.outputType);
            const fileName = file.name.replace(/\.heic$/i, `.${newExtension}`);
            this.convertedFiles.push({ blob: convertedBlob, name: fileName, originalFile: file });
            statusElement.textContent = '✓ 完成';
            statusElement.className = 'file-status status-completed';
          } catch (error) {
            console.error('轉換錯誤:', error);
            statusElement.textContent = '✗ 錯誤';
            statusElement.className = 'file-status status-error';
            this.showMessageBox(`轉換失敗: ${file.name}。請確認檔案沒有損壞或格式不完整。`, 'error');
          }
          this.updateStats();
        }
        this.updateProgress(this.files.length, this.files.length, '轉換完成！');
        this.convertBtn.disabled = false;
        if (this.convertedFiles.length > 0) { this.results.style.display = 'block'; }
      }
      async convertHEIC(file) {
        try {
          const convertedBlob = await heic2any({ blob: file, toType: this.outputType, quality: this.quality });
          return convertedBlob;
        } catch (error) {
          throw new Error(`轉換 ${file.name} 時發生錯誤: ${error.message}`);
        }
      }
      getExtFromMime(mimeType) {
        switch(mimeType){
          case 'image/jpeg': return 'jpg';
          case 'image/png':  return 'png';
          case 'image/gif':  return 'gif';
          case 'image/webp': return 'webp';
          default: return 'jpg';
        }
      }
      downloadAll() {
        if (this.convertedFiles.length === 0) return;
        const zip = new JSZip();
        this.convertedFiles.forEach(file => { zip.file(file.name, file.blob); });
        zip.generateAsync({ type: 'blob' }).then(content => {
          const url = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url; a.download = 'converted_images.zip'; a.style.display='none';
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }
      updateProgress(current, total, message){
        const percentage = total === 0 ? 0 : (current / total) * 100;
        this.progressFill.style.width = percentage + '%';
        this.progressText.textContent = `${message} (${current}/${total})`;
      }
      clearFiles(){
        this.files = [];
        this.convertedFiles = [];
        this.fileList.innerHTML = '';
        this.progressBar.style.display = 'none';
        this.results.style.display = 'none';
        this.stats.style.display = 'none';
        this.convertBtn.disabled = true;
        this.progressText.textContent = '';
        this.fileInput.value = '';
        this.updateProgress(0,0,'');
      }
      showMessageBox(message, type='info'){
        this.messageText.textContent = message;
        this.messageBox.className = `message-box ${type}-box`;
        this.messageIcon.textContent = type === 'error' ? '❌' : (type === 'success' ? '✅' : 'ℹ️');
        this.messageBox.style.display = 'block';
      }
      formatFileSize(bytes){
        if (bytes === 0) return '0 Bytes';
        const k = 1024; const sizes = ['Bytes','KB','MB','GB'];
        const i = Math.floor(Math.log(bytes)/Math.log(k));
        return parseFloat((bytes/Math.pow(k,i)).toFixed(2)) + ' ' + sizes[i];
      }
    }
    document.addEventListener('DOMContentLoaded', () => { new HEICConverter(); });
  </script>
</body>
</html>
