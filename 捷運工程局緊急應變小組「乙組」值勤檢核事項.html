<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>捷運工程局緊急應變小組「乙組」值勤檢核事項</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 日系和風主題 --- */
        :root {
            --theme-wood: #4a2c2a; /* 深木色 */
            --theme-paper: #fbfaf5; /* 和紙米白 */
            --theme-accent: #a13333; /* 朱紅點綴 */
            --theme-accent-hover: #c0392b; /* 強調朱紅 */
            --theme-text-main: #3d3d3d; /* 墨黑文字 */
            --theme-text-subtle: #707070; /* 淺灰文字 */
            --theme-border: #dcd9d4; /* 邊框色 */
            --navy-blue: #003366; /* 海軍藍 */
            --font-sans: 'Noto Sans TC', sans-serif;
            --font-serif: 'Noto Serif TC', serif;
        }

        body {
            font-family: var(--font-serif);
            background-color: var(--theme-paper);
            color: var(--theme-text-main);
            font-size: 1rem;
            line-height: 1.7;
        }

        /* --- Header & Navbar --- */
        .main-header {
            background-color: var(--theme-wood);
            border-bottom: 2px solid #3b2321;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .main-title {
            color: var(--theme-paper);
            font-family: var(--font-sans);
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .title-highlight {
            color: #FFD700; /* 黃色 */
        }
        
        .author-name {
            color: var(--theme-paper);
            font-size: 0.85rem;
            opacity: 0.8;
            font-family: var(--font-sans);
        }
        
        #nav-list {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        
        .nav-link {
            display: block;
            text-align: center;
            background-color: transparent;
            color: var(--theme-wood);
            border: 1px solid var(--theme-border);
            padding: 0.5rem 0.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: var(--font-sans);
            transition: all 0.3s ease;
            white-space: nowrap;
            background-color: rgba(255,255,255,0.1);
            color: var(--theme-paper);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .nav-link:hover {
            background-color: var(--theme-accent);
            color: var(--theme-paper);
            border-color: var(--theme-accent);
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        /* 導航標題點選時變更為更醒目的紅色，此樣式會由JS控制 */
        .nav-link.active {
            background-color: var(--theme-accent-hover);
            color: var(--theme-paper);
            border-color: var(--theme-accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .nav-link.visited {
            background-color: #7d6e6e;
            color: var(--theme-paper);
            border-color: #7d6e6e;
        }

        /* --- Content Sections --- */
        .content-section {
            display: none;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 4px;
            border: 1px solid var(--theme-border);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-top: 1.5rem;
            animation: fadeIn 0.5s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .collapsible-header {
            cursor: pointer;
            padding: 1rem 0.5rem;
            background-color: transparent;
            border-bottom: 2px solid var(--theme-wood);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
            font-family: var(--font-sans);
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--theme-wood);
        }
        
        .collapsible-header:hover {
            background-color: #fdf6e3;
        }

        .collapsible-header .subtitle {
            font-size: calc(1.6rem * 0.6);
            font-weight: 400;
            color: var(--theme-text-subtle);
            margin-left: 1rem;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding: 0 0.5rem;
        }

        .collapsible-content.expanded {
            max-height: none; 
            overflow-y: auto;
            padding: 0.5rem;
        }

        .arrow {
            transition: transform 0.3s ease;
            color: var(--theme-accent);
        }

        .arrow.expanded {
            transform: rotate(180deg);
        }
        
        /* --- Element Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border: 1px solid var(--theme-border);
        }

        th, td {
            border: 1px solid var(--theme-border);
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #f5f1e8;
            font-weight: 600;
            color: var(--theme-wood);
            font-family: var(--font-sans);
        }
        
        #main-content table th.th-item {
             writing-mode: horizontal-tb !important;
             text-align: center !important;
             vertical-align: middle !important;
             width: 80px !important;
        }
        
        #main-content table tbody tr td:first-child {
            text-align: center;
            vertical-align: middle;
            font-family: var(--font-sans);
        }

        th.th-content {
            text-align: center;
        }

        /* 超連結樣式直接設定為海軍藍粗體 */
        a {
            color: var(--navy-blue);
            font-weight: 700;
            text-decoration: none;
            border-bottom: 1px solid var(--navy-blue);
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        a:hover {
            color: var(--theme-accent-hover);
            border-bottom-color: transparent;
        }
        
        /* 用於JS套用的海軍藍粗體樣式 */
        .highlight-navy {
            color: var(--navy-blue);
            font-weight: 700;
        }


        /* --- Utilities --- */
        #back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: var(--theme-wood);
            color: var(--theme-paper);
            width: 3rem;
            height: 3rem;
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: opacity 0.3s, transform 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #back-to-top:hover {
            background-color: #3b2321;
            transform: scale(1.05);
        }

        #search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--theme-border);
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--theme-border);
            font-family: var(--font-sans);
        }

        .search-result-item:hover {
            background-color: #f5f1e8;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .highlight {
            background-color: #f8d7da;
            color: var(--theme-accent);
            padding: 0.1em 0;
            border-radius: 2px;
            font-weight: 600;
        }
        
        #search-box {
            background-color: rgba(255,255,255,0.85);
            border: 1px solid var(--theme-border);
            border-radius: 4px;
        }
        #search-box:focus {
            background-color: #fff;
            border-color: var(--theme-accent);
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <header class="main-header sticky top-0 z-50 py-3 px-4 sm:px-6 lg:px-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="main-title">捷運工程局緊急應變小組「<span class="title-highlight">乙組</span>」值勤檢核事項</h1>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="search" id="search-box" placeholder="全站搜尋..." class="w-48 sm:w-64 px-4 py-2 border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                    <div id="search-results" class="hidden"></div>
                </div>
                <span class="author-name hidden sm:block">製作者：陳政德</span>
            </div>
        </div>
        <!-- Navigation -->
        <nav class="mt-4">
            <ul id="nav-list">
                <!-- Nav links will be injected here by JavaScript -->
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="content-container">
            <!-- Content from DOCX will be parsed and placed here -->
            <section id="section-1" class="content-section">
                <h2 class="collapsible-header">
                    <span>一、值勤應辦事項</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <table>
                        <thead>
                            <tr><th class="th-item">項目</th><th class="th-content">內容</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>接獲本局一呼百應語音通報完成進駐開始值勤：<br>(1)完成刷卡，差勤系統→差勤→加班→專案加班：奉准（打勾）→○○年緊急應變小組-不受限，事由：○○颱風值勤。<br>(2)完成簽到簿簽到。<br>(3)防救災作業支援系統/專案開設/進駐簽到管理/簽到。<br>(4)上班期間空調控制箱鑰匙保管人陳秀英(8038)，下班期間請中控室(8685)開啟15樓空調，或使用起子打開側邊的螺絲，按壓1～4台空調開關。</td></tr>
                            <tr><td>2</td><td>(1)開啟電腦後，先以防災電子信箱登入帳號及密碼(兩台密碼皆為Aa123abc)，再以手機開啟台北通(Email需事先開通，務必與工務信箱一致)，掃描QRcode或以自然人憑證登入皆可，值勤結束後請登出系統。<br>(2)登入TAIPEION入口網，開啟右上角Outlook電子信箱，左側除個人電子信箱外，另已新增2組防災信箱(A捷運工程組防災信箱、B捷運局防災電子信箱)。<br>A.捷運工程組防災信箱dorts_eng@gov.taipei<br>B.捷運局防災電子信箱prev-dorts@gov.taipei<br>C.Outlook：https://outlook.office.com/mail/<br>（輸入Email信箱及TAIPEION密碼）</td></tr>
                            <tr><td>3</td><td>下一班接班人員未到達前，不得逕行離開。</td></tr>
                            <tr><td>4</td><td>(1)電話確認各工程處成立緊急應變小組之時間/人員姓名，並登錄於「防救災作業支援系統/防救災作業/工作記事」中。<br>(2)詳實記載每一項值勤過程處理情形於工作日誌。</td></tr>
                            <tr><td>5</td><td>(1)電話回報本局赴本市災害應變中心值勤高參組同仁，緊急應變小組已成立，並將時間/人員姓名登錄於「防救災作業支援系統/防救災作業/工作記事」中。<br>(2)本市災害應變中心捷運局高參組座位電話8786-3119轉8545</td></tr>
                            <tr><td>6</td><td>第1班負責預先電話通知接續5班人員何時值勤(日、夜班)。</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="section-2" class="content-section">
                <h2 class="collapsible-header">
                    <span>二、辦理工作會報事宜</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <table>
                        <thead>
                            <tr><th class="th-item">項目</th><th class="th-content">內容</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>請隨時注意工作會報的開會時間(請由指揮調度組長官確認局長或其代理人出席)。</td></tr>
                            <tr><td>2</td><td>工作會報提送及回覆：<br>(1)隨時注意工務局（★TAIPEION即時通工程搶修組第一報群組★）、消防局及捷運局2個防災電子信箱之通知。<br>A.工務局prevfa013@gmail.com(備用)<br>B.消防局tfd-prev@gov.taipei(備用)<br>C.捷運工程組防災信箱dorts_eng@gov.taipei<br>D.捷運局防災電子信箱prev-dorts@gov.taipei<br>(2)收到工務局即時通要求填報災害防救會報第N報檔案，即刻轉發至各工程處填列，資料後回傳，若本局未外援人力及機具，會報資料第12項表格之「本組【已】出動救災能量」皆填列0。<br>工務局水利科承辦人許聖鑫彙整資料：27256796＃6796<br>Email：a10707@gov.taipei<br>(3)奉指揮官核閱後，將彙整之工作會報資料Email傳送2個電子信箱、第1～6班緊急應變小組群組及工務局信箱(備用)，另需將資料傳送至工務局之TAIPEION即時通「工程搶修組第一報群組」。<br>工務局工程搶修組第N次災害防救會報定型稿下載：<br>https://pwd.gov.taipei/News_Content.aspx?n=DA851960F3010CCD&s=A165762475C4B30C<br>(4)注意提送時間並電話確認（工務局及高參組進駐災害應變中心同仁）。<br>(5)Outlook傳送新郵件時，寄件者內定為個人Email帳號，需手動調整為防災電子信箱，點選「其他電子郵件地址」，鍵入prev-dorts@gov.taipei防災信箱。</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="section-3" class="content-section">
                <h2 class="collapsible-header">
                    <span>三、防救災作業支援系統應辦事項</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <table>
                        <thead>
                            <tr><th class="th-item">項目</th><th class="th-content">內容</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>(1)進入臺北市應變中心單一入口登錄平台<br>https://www.eocemis.gov.taipei/EocSSO<br>(2)單一身分驗證/點我驗證登入/使用「台北通」登入。<br>(3)使用手機「台北通」App掃描QRcode後進入。<br>(4)點選「防救災作業支援系統」進入操作。<br>(5)專案開設/進駐簽到管理/點選「簽到」，值勤結束後點選「簽退」。<br>(6)災情傳遞管理/災情案件管理中注意有關本局列管案件。<br>(7)防救災作業/工作記事中登錄每一項有關值勤之處理情形。<br>(8)防救災作業/大事紀管理中登錄有關本局於本次專案之重要事項。<br>(9)防救災作業/會報指示作業，依序點選各項指示事項，右側即顯示權責單位，欄位若出現捷運局(紅底)，應立即新增回覆辦理情形。</td></tr>
                            <tr><td>2</td><td>如有災情發生時，各班值勤人員應使用防救災作業支援系統登入案件，並需向本局派赴「臺北市災害應變中心」輪值之高參組人員報告災情。惟非臺北市轄區之捷運工地災情，不需輸入此系統。</td></tr>
                            <tr><td>3</td><td>災情彙計：<br>(1)彙整各工程處之災情彙計總表(每3小時)後，填具於本局之災情彙計總表（動員人數：各工程處+本局，不含廠商），彙整後列印裝訂於公文夾，並Email至捷運工程組防災信箱及捷運局防災電子信箱。<br>(2)各工程處+本局動員人數以每12小時換班後累加之人數。</td></tr>
                            <tr><td>4</td><td>進入「災害情資網」網頁內查看最新訊息。<br>https://eocdss.ncdr.nat.gov.tw/web</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-4" class="content-section">
                <h2 class="collapsible-header">
                    <span>四、中央及地方單位指示辦理事項</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                     <table>
                        <thead>
                            <tr><th class="th-item">項目</th><th class="th-content">內容</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>(1)各單位（中央應變中心、本市災害應變中心、內政部、經濟部水利署、氣象署等）之傳真文件或Line訊息，應立即陳送指揮調度組輪值長官，並將指（裁）示事項立即Email各工程處防災電子信箱及本局2個防災信箱。<br>(2)以上文件列印紙本後，裝訂於公文夾。<br>捷運局一工處防災電子信箱rescue_1dpo@gov.taipei<br>捷運局二工處防災電子信箱rescue_2dpo@gov.taipei<br>機工處防災電子信箱rescue_sempo@gov.taipei</td></tr>
                            <tr><td>2</td><td>所有災害應變中心之指示事項均應陳報指揮調度組輪值長官及轉達各工程處。</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="section-5" class="content-section">
                <h2 class="collapsible-header">
                    <span>五、發生災情處理</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <table>
                        <thead>
                            <tr><th class="th-item">項目</th><th class="th-content">內容</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>(1)有緊急意外事故發生或媒體報導本局所轄工地災情時，應立即督導各工程處傳送至LINE「捷運局工地即時通報群組」，以利指揮官督導搶救災作業。<br>(2)★提醒各工程處及開發處，每日主動將各施工標防颱防汛整備情形傳送至LINE「捷運局工地即時通報群組」局長知悉。★<br>(3)★提醒指揮調度組長官於08：00～22：00LINE「捷運局工地即時通報群組」定時（每3小時）回報狀況。★<br>(4)★若遇有災情發生，請立即通知陳郭副局長及程總工程司，以利指揮救災。★</td></tr>
                            <tr><td>2</td><td>遵照指揮調度組指示辦理。</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="section-6" class="content-section">
                <h2 class="collapsible-header">
                    <span>六、二級開設應辦事項</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <table>
                        <thead>
                            <tr><th class="th-item">項目</th><th class="th-content">內容</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>接獲災害應變中心通知改為二級開設：<br>(1)經指揮調度組長官請示指揮官同意解除緊急應變小組任務。<br>(2)電話通知各工程處緊急應變小組同時解除任務。<br>(3)電話通知下一班(4組)及秘書室解除值勤任務。<br>一工處緊急應變小組：2896-9633分機174專線2896-9635<br>二工處緊急應變小組：2577-5900分機126、127專線2577-8790<br>機工處緊急應變小組：2788-1300分機214專線2788-1559</td></tr>
                            <tr><td>2</td><td>(1)於本市災害應變中心解除一級開設後1小時內，請各工程處緊急應變小組統計災損情形以捷運工程組災情彙計總表及彙整所有事件最新辦理情形，以Email至本局防災信箱或傳真至本局緊急應變小組，由緊急應變小組彙整結報後，陳送指揮調度組傳送至LINE「捷運局工地即時通報群組」。<br>(2)關閉15樓空調及所有電器類開關。</td></tr>
                            <tr><td>3</td><td>末班工務管理處值勤人員於次日將各工程處之災損統計資料綜簽陳核局長。</td></tr>
                            <tr><td>4</td><td>乙組工務管理處最末班輪值人員第1人簽報結報及誤餐費，第2人辦理參與值勤人員之加班費申報作業。</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="section-7" class="content-section">
                <h2 class="collapsible-header">
                    <span>七、特別指示事項</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <p>本府特別指示事項，如：工作會報指揮官指示事項及辦理情形。</p>
                </div>
            </section>
            
            <section id="section-8" class="content-section">
                <h2 class="collapsible-header">
                    <span>備註</span>
                    <span class="arrow">▼</span>
                </h2>
                <div class="collapsible-content">
                    <p>1.請乙組輪值同仁登入防救災作業支援系統後，同步點選簽到，值勤結束後須點選簽退。</p>
                    <p>2.各項表報已置於捷運局NAS雲端硬碟，請由「第1～6班緊急應變小組群組」之「記事本」，連結「緊急應變小組各項表格值勤檢核表及值勤使用手冊」目錄內。<br>（帳號：員工編號密碼：個人電腦開機密碼）</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Back to Top Button -->
    <button id="back-to-top" title="回到頂端">
        <span>↑</span>
    </button>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const contentContainer = document.getElementById('content-container');
    const navList = document.getElementById('nav-list');
    let searchIndex = [];

    function removeUnwantedSpaces(rootElement) {
        const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while (node = walker.nextNode()) {
            node.nodeValue = node.nodeValue.replace(/([\u4e00-\u9fa5])\s+([a-zA-Z0-9])/g, '$1$2');
            node.nodeValue = node.nodeValue.replace(/([a-zA-Z0-9])\s+([\u4e00-\u9fa5])/g, '$1$2');
        }
    }
    
    function applySpecialStyling(rootElement) {
        // MODIFIED: 重寫並簡化了括號匹配規則，使其更強健，能正確匹配 (1), (2) 等模式
        const combinedRegex = /(★.+?★|「.+?」|(?:（.+?）|\(.+?\))|\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b|\b(?:\d{4}-\d{4}|\d{8,})(?:[#＃分機轉]\d+)?\b)/g;

        const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null, false);
        const nodesToProcess = [];
        let node;
        while (node = walker.nextNode()) {
             if (node.parentElement.tagName !== 'A' && node.parentElement.tagName !== 'STRONG' && combinedRegex.test(node.nodeValue)) {
                nodesToProcess.push(node);
            }
        }

        nodesToProcess.forEach(node => {
            const fragments = node.nodeValue.split(combinedRegex);
            const parent = node.parentNode;
            const newContent = document.createDocumentFragment();

            fragments.forEach(part => {
                if (!part) return;
                if (part.match(combinedRegex)) {
                    const strong = document.createElement('strong');
                    strong.className = 'highlight-navy';
                    strong.textContent = part;
                    newContent.appendChild(strong);
                } else {
                    newContent.appendChild(document.createTextNode(part));
                }
            });
            parent.replaceChild(newContent, node);
        });
    }

    function initializeApp() {
        removeUnwantedSpaces(contentContainer);
        convertUrlsToLinks(contentContainer);
        applySpecialStyling(contentContainer);

        setupNavigation();
        buildSearchIndex();
        attachEventListeners();
        showSection('section-1', true);
        
        document.querySelectorAll('.collapsible-header').forEach(header => {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.arrow');
            if (content && arrow && !content.classList.contains('expanded')) {
                content.classList.add('expanded');
                arrow.classList.add('expanded');
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => {
                    if (content.classList.contains('expanded')) {
                       content.style.maxHeight = null;
                    }
                }, 500);
            }
        });
    }

    function convertUrlsToLinks(rootElement) {
        const urlRegex = /(https?:\/\/[^\s<>"'()]+)/g;
        const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null, false);
        let textNode;
        const nodesToProcess = [];

        while (textNode = walker.nextNode()) {
            if (urlRegex.test(textNode.nodeValue) && textNode.parentElement.tagName !== 'A') {
                nodesToProcess.push(textNode);
            }
        }

        nodesToProcess.forEach(node => {
            const parent = node.parentNode;
            const fragments = node.nodeValue.split(urlRegex);
            
            if (fragments.length > 1) {
                const newFragment = document.createDocumentFragment();
                fragments.forEach((text, i) => {
                    if (i % 2 === 1) {
                        const a = document.createElement('a');
                        a.href = text;
                        a.target = '_blank';
                        a.rel = 'noopener noreferrer';
                        a.textContent = text;
                        newFragment.appendChild(a);
                    } else if (text) {
                        newFragment.appendChild(document.createTextNode(text));
                    }
                });
                parent.replaceChild(newFragment, node);
            }
        });
    }

    function setupNavigation() {
        const headers = contentContainer.querySelectorAll('.collapsible-header');
        headers.forEach((header, index) => {
            const sectionId = header.closest('.content-section').id;
            const title = header.querySelector('span:first-child').textContent.replace(/^[一二三四五六七八]+、/, '');
            
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = `#${sectionId}`;
            a.textContent = title;
            a.className = 'nav-link';
            a.dataset.target = sectionId;
            
            li.appendChild(a);
            navList.appendChild(li);
        });
    }
    
    function attachEventListeners() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.target.dataset.target;
                showSection(targetId);
            });
        });

        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', () => {
                toggleCollapsible(header);
            });
        });

        const backToTopButton = document.getElementById('back-to-top');
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopButton.style.display = 'flex';
                setTimeout(() => backToTopButton.style.opacity = '1', 10);
            } else {
                backToTopButton.style.opacity = '0';
                setTimeout(() => backToTopButton.style.display = 'none', 300);
            }
        });
        backToTopButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        const searchBox = document.getElementById('search-box');
        const searchResults = document.getElementById('search-results');
        searchBox.addEventListener('input', handleSearch);
        searchBox.addEventListener('blur', () => setTimeout(() => searchResults.classList.add('hidden'), 200));
        searchBox.addEventListener('focus', handleSearch);
    }
    
    function buildSearchIndex() {
        searchIndex = [];
        const sections = document.querySelectorAll('.content-section');
        sections.forEach(section => {
            const sectionId = section.id;
            const header = section.querySelector('.collapsible-header span:first-child');
            if (header) {
                searchIndex.push({
                    id: sectionId,
                    type: 'header',
                    text: header.textContent.trim(),
                    element: header
                });
            }
            const content = section.querySelector('.collapsible-content');
            if (content) {
                searchIndex.push({
                    id: sectionId,
                    type: 'content',
                    text: content.innerText.trim(),
                    element: content
                });
            }
        });
    }

    function showSection(sectionId, isInitial = false) {
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        const targetSection = document.getElementById(sectionId);
        targetSection?.classList.add('active');

        // This loop ensures only the current link is 'active' (red)
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.target === sectionId);
        });
        
        if (!isInitial) {
            targetSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            const header = targetSection.querySelector('.collapsible-header');
            if (header) {
                const content = header.nextElementSibling;
                if (!content.classList.contains('expanded')) {
                    toggleCollapsible(header);
                }
            }
        }
    }

    function toggleCollapsible(header) {
        const content = header.nextElementSibling;
        const arrow = header.querySelector('.arrow');
        
        if (content.classList.contains('expanded')) {
            content.style.maxHeight = content.scrollHeight + 'px';
            requestAnimationFrame(() => {
                content.style.maxHeight = '0';
            });
            content.classList.remove('expanded');
            arrow.classList.remove('expanded');
        } else {
            content.classList.add('expanded');
            content.style.maxHeight = content.scrollHeight + 'px';
            arrow.classList.add('expanded');
            
            setTimeout(() => {
                if (content.classList.contains('expanded')) {
                    content.style.maxHeight = null;
                }
            }, 500);
        }
    }
    
    function handleSearch(e) {
        const query = e.target.value.trim().toLowerCase();
        const searchResultsContainer = document.getElementById('search-results');
        
        if (query.length < 1) {
            searchResultsContainer.classList.add('hidden');
            clearAllHighlights();
            return;
        }

        const results = searchIndex.filter(item => item.text.toLowerCase().includes(query));
        searchResultsContainer.innerHTML = '';

        if (results.length > 0) {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const text = result.text;
                const index = text.toLowerCase().indexOf(query);
                const snippet = text.substring(Math.max(0, index - 20), Math.min(text.length, index + query.length + 20));
                item.innerHTML = `<strong>${result.element.closest('.content-section').querySelector('h2 span').textContent}</strong>: ...${snippet.replace(new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi'), `<span class="highlight">$&</span>`)}...`;
                
                item.addEventListener('click', () => {
                    showSection(result.id);
                    setTimeout(() => {
                        const targetElement = document.getElementById(result.id);
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        clearAllHighlights();
                        highlightText(targetElement, query);
                    }, 100);
                });
                searchResultsContainer.appendChild(item);
            });
            searchResultsContainer.classList.remove('hidden');
        } else {
            searchResultsContainer.classList.add('hidden');
            clearAllHighlights();
        }
    }

    function clearAllHighlights() {
        const highlights = document.querySelectorAll('.highlight');
        highlights.forEach(span => {
            const parent = span.parentNode;
            parent.replaceChild(document.createTextNode(span.textContent), span);
            parent.normalize();
        });
    }

    function highlightText(element, query) {
        if (!query) return;
        const escapedQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        const regex = new RegExp(`(${escapedQuery})`, 'gi');
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const nodesToProcess = [];

        while (node = walker.nextNode()) {
            if (regex.test(node.nodeValue)) {
                nodesToProcess.push(node);
            }
        }
        
        nodesToProcess.forEach(textNode => {
            if (textNode.parentElement.tagName === 'A' || textNode.parentElement.classList.contains('highlight') || textNode.parentElement.classList.contains('highlight-navy')) return;

            const fragment = document.createDocumentFragment();
            const parts = textNode.nodeValue.split(regex);
            
            parts.forEach(part => {
                if (part.toLowerCase() === query.toLowerCase()) {
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    span.textContent = part;
                    fragment.appendChild(span);
                } else {
                    fragment.appendChild(document.createTextNode(part));
                }
            });
            textNode.parentNode.replaceChild(fragment, textNode);
        });
    }

    initializeApp();
});
</script>

</body>
</html>
