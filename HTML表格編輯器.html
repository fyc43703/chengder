<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML 內容編輯器</title>
    <style>
        :root {
            /* --- Light Theme --- */
            --system-font: -apple-system, "SF Pro", "Helvetica Neue", "Arial", sans-serif;
            --background-color: #f5f5f7;
            --window-background-color: rgba(255, 255, 255, 0.85);
            --panel-background-color: rgba(240, 240, 245, 0.85);
            --editor-background-color: #fff;
            --system-blue: #007aff;
            --system-green: #28a745;
            --system-red: #ff3b30;
            --system-gray: #8e8e93;
            --system-brown: #a2835b;
            --border-color: rgba(0, 0, 0, 0.1);
            --text-color: #1d1d1f;
            --text-color-secondary: #6e6e73;
            --table-header-bg: #f7f7f8;
            --window-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --blur-radius: 12px;
        }

        body[data-theme="dark"] {
            /* --- Dark Theme --- */
            --background-color: #1c1c1e;
            --window-background-color: rgba(44, 44, 46, 0.85);
            --panel-background-color: rgba(28, 28, 30, 0.85);
            --editor-background-color: #2c2c2e;
            --system-blue: #0a84ff;
            --system-green: #30d158;
            --system-red: #ff453a;
            --system-gray: #8e8e93;
            --system-brown: #ab8e68;
            --border-color: rgba(255, 255, 255, 0.15);
            --text-color: #f2f2f7;
            --text-color-secondary: #8d8d92;
            --table-header-bg: #3a3a3c;
        }

        /* --- 基本設定與佈局 --- */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scrolling */
        }
        body {
            font-family: var(--system-font);
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- 主視窗容器 (Flex佈局) --- */
        .window-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            width: 100%;
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--window-shadow);
            border: 1px solid var(--border-color);
            background: var(--background-color);
        }

        /* --- 固定頂部區域 --- */
        #sticky-header {
            flex-shrink: 0;
            background: var(--window-background-color);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
        }

        /* --- 標題列 --- */
        .title-bar {
            padding: 10px 12px;
            position: relative;
            text-align: center;
        }
        .title-bar-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 28px;
        }
        .window-controls { display: flex; align-items: center; gap: 8px; position: absolute; top: 10px; left: 12px; }
        .control-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-red { background-color: #ff5f56; }
        .dot-yellow { background-color: #ffbd2e; }
        .dot-green { background-color: #27c93f; }
        .title-content { margin: 0 auto; }
        .window-title { font-size: 20px; font-weight: 600; margin:0; }
        #current-filename { font-size: 13px; color: var(--text-color-secondary); margin-left: 8px; }
        #theme-toggle { background: transparent; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 10px; right: 12px; }
        #theme-toggle:hover { background-color: var(--border-color); }
        #theme-toggle svg { width: 24px; height: 24px; fill: var(--text-color-secondary); }
        .window-subtitle { font-size: 13px; color: var(--text-color-secondary); margin: 2px 0 0; }
        .window-creator { font-size: 12px; color: var(--text-color-secondary); margin: 2px 0 0; }

        /* --- 可捲動內容區域 --- */
        .main-content { 
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px; 
            background: var(--window-background-color);
        }
        
        /* --- 控制面板 --- */
        .controls-panel {
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .controls-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; }
        .control-group { display: flex; align-items: center; gap: 6px; }
        .control-group label, .control-group > label { font-size: 14px; color: var(--system-blue); font-weight: 600; white-space: nowrap; }
        .separator { width: 1px; height: 20px; background-color: var(--border-color); }
        .spacer { flex-grow: 1; }
        
        /* --- 按鈕與輸入框 --- */
        input[type="text"], input[type="number"] {
            font-family: var(--system-font); border: 1px solid var(--border-color);
            background-color: var(--editor-background-color); color: var(--text-color);
            padding: 6px 10px; border-radius: 6px; font-size: 14px;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        #search-input, #replace-input { width: 70px; }
        #font-size-input, #border-width-input { width: 36px; }
        #row-height-input, #col-width-input { width: 38px; }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--system-blue); box-shadow: 0 0 0 3px color-mix(in srgb, var(--system-blue) 30%, transparent); }
        input[type="color"] { -webkit-appearance: none; width: 28px; height: 28px; border: none; padding: 0; background-color: transparent; border-radius: 6px; overflow: hidden; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 4px; }
        
        button {
            padding: 5px 12px; border: none; background-color: var(--system-blue); color: white;
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;
            transition: transform 0.1s, filter 0.2s; display: flex; align-items: center; gap: 6px;
        }
        button:hover { filter: brightness(1.1); }
        button:active { transform: scale(0.98); filter: brightness(1.2); }
        button.secondary { background-color: var(--system-gray); }
        button.success { background-color: var(--system-green); }
        button.danger { background-color: var(--system-red); }
        button:disabled { background-color: color-mix(in srgb, var(--system-gray) 50%, var(--panel-background-color)); color: var(--text-color-secondary); cursor: not-allowed; filter: none; }
        button svg { width: 14px; height: 14px; fill: currentColor; }
        #save-html-btn svg, #save-rtf-btn svg { width: 16px; height: 16px; }
        button.icon-btn { padding: 6px; width: 30px; height: 30px; justify-content: center; }
        .btn-align { background-color: var(--system-green); }
        .btn-table { background-color: var(--system-brown); }

        /* --- 編輯器 --- */
        #editor-container { padding: 20px; background-color: var(--editor-background-color); border-radius: 8px; border: 1px solid var(--border-color); transition: width 0.3s, height 0.3s; }
        #content-display { min-height: 400px; transform-origin: top left; user-select: none; outline: none; }
        #content-display[contenteditable="true"] { user-select: text; cursor: text; }
        #editor-container.paged-view { margin: 20px auto; box-shadow: 0 0 15px rgba(0,0,0,0.15); padding: 2cm; box-sizing: content-box; }
        #editor-container.paged-view.portrait { width: 21cm; min-height: 29.7cm; }
        #editor-container.paged-view.landscape { width: 29.7cm; min-height: 21cm; }

        /* --- 表格與選取樣式 --- */
        #content-display table { border-collapse: collapse; width: 100%; position: relative; table-layout: fixed; }
        #content-display th, #content-display td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; position: relative; min-width: 40px; overflow: hidden; word-break: break-all; }
        #content-display th { background-color: var(--table-header-bg); font-weight: 600; }
        #content-display td.selected-cell, #content-display th.selected-cell { outline: 1px solid var(--system-blue); outline-offset: -1px; background-color: color-mix(in srgb, var(--system-blue) 5%, transparent) !important; }
        mark.highlight { background-color: #ffdd57; color: black; border-radius: 2px; padding: 0 2px; }
        
        /* --- Image Cropping and Resizing Styles --- */
        .image-wrapper {
            position: relative;
            display: inline-block;
            line-height: 0; /* Prevents extra space below the image */
            user-select: none;
        }
        .image-wrapper img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Important for cropping */
            pointer-events: none; /* Prevent image dragging */
        }
        .crop-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            cursor: move;
            touch-action: none;
        }
        .crop-handle {
            position: absolute;
            background-color: var(--system-blue);
            border: 1px solid var(--editor-background-color);
            z-index: 10;
        }
        .crop-handle.corner { width: 10px; height: 10px; border-radius: 50%; }
        .crop-handle.edge { background-color: transparent; } /* Invisible but larger hit area */
        .crop-handle.edge-n, .crop-handle.edge-s { left: 10px; right: 10px; height: 10px; cursor: ns-resize; }
        .crop-handle.edge-w, .crop-handle.edge-e { top: 10px; bottom: 10px; width: 10px; cursor: ew-resize; }
        .crop-handle.edge-n { top: -5px; } .crop-handle.edge-s { bottom: -5px; }
        .crop-handle.edge-w { left: -5px; } .crop-handle.edge-e { right: -5px; }
        .crop-handle.corner-nw { top: -5px; left: -5px; cursor: nwse-resize; }
        .crop-handle.corner-ne { top: -5px; right: -5px; cursor: nesw-resize; }
        .crop-handle.corner-sw { bottom: -5px; left: -5px; cursor: nesw-resize; }
        .crop-handle.corner-se { bottom: -5px; right: -5px; cursor: nwse-resize; }
        .crop-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        /* --- 提示訊息 --- */
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        #notification.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
    </style>
</head>
<body>

    <div class="window-container">
        <div id="sticky-header">
            <header class="title-bar">
                <div class="title-bar-top">
                    <div class="window-controls">
                        <span class="control-dot dot-red"></span>
                        <span class="control-dot dot-yellow"></span>
                        <span class="control-dot dot-green"></span>
                        <span id="current-filename"></span>
                    </div>
                     <div class="title-content">
                        <h1 class="window-title">HTML 內容編輯器</h1>
                    </div>
                    <button id="theme-toggle" title="切換明暗主題">
                        <span id="theme-icon-sun"><svg viewBox="0 0 24 24"><path d="M12 9.5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5-2.5-1.12-2.5-2.5 1.12-2.5 2.5-2.5M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 12h3m-1 9.78l2.12-2.12M12 2v3m8.12.88L18 7.12M22 12h-3m1-9.78L18.88 4.34M12 22v-3m-8.12-.88L6 16.88"/></svg></span>
                        <span id="theme-icon-moon" style="display: none;"><svg viewBox="0 0 24 24"><path d="M12.3 4.9c.4-.2.6-.7.4-1.1-.2-.4-.7-.6-1.1-.4C7.2 5.4 4 9.2 4 13.5 4 19.1 8.9 24 14.5 24c4.3 0 8-3.2 9.1-7.4.2-.4 0-.9-.4-1.1s-.9-.1-1.1.2c-1.3 2.1-3.6 3.3-6.1 3.3-4.1 0-7.5-3.4-7.5-7.5 0-2.5 1.2-4.8 3.3-6.1z"/></svg></span>
                    </button>
                </div>
                <p class="window-subtitle">本程式是針對 HTML 內容的視覺化編輯工具，提供直覺的操作介面。</p>
                <p class="window-creator">製作者：陳政德</p>
            </header>
            <div class="controls-panel">
                 <div class="controls-row">
                    <div class="control-group"><button id="select-file-btn">選擇檔案</button><input type="file" id="file-input" accept=".html,.htm" style="display: none;"></div>
                    <div class="control-group"><input type="text" id="search-input" placeholder="搜尋" disabled><button id="search-btn" disabled>搜尋</button><input type="text" id="replace-input" placeholder="取代" disabled><button id="replace-btn" class="secondary" disabled>全部取代</button></div>
                    <div class="separator"></div>
                    <div class="control-group"><label>縮放:</label><button id="zoom-in-btn" class="icon-btn" disabled title="放大">+</button><button id="zoom-out-btn" class="icon-btn" disabled title="縮小">-</button><button id="zoom-reset-btn" disabled title="重設縮放">100%</button></div>
                    <div class="control-group"><label>頁面:</label><button id="portrait-btn" class="icon-btn" disabled title="直向 A4"><svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></button><button id="landscape-btn" class="icon-btn" disabled title="橫向 A4"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg></button><button id="view-reset-btn" disabled title="重設檢視">重設</button></div>
                    <div class="control-group"><button id="undo-btn" title="復原上一步 (Ctrl+Z)" disabled><svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.38 11.23 17.28 8 12.5 8z"/></svg>復原</button></div>
                    <div class="spacer"></div>
                    <div class="control-group"><button id="save-rtf-btn" class="success" disabled><svg viewBox="0 0 24 24"><path d="M6 2c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6H6zm8 7V3.5L18.5 9H14z"/></svg>儲存為 RTF</button><button id="save-html-btn" class="success" disabled><svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>儲存為 HTML</button></div>
                </div>
                <div class="controls-row">
                     <div class="control-group"><label>文字:</label><input type="number" id="font-size-input" min="8" max="72" value="14" disabled title="文字大小"><input type="color" id="font-color-input" value="#000000" disabled title="文字顏色"></div>
                     <div class="control-group"><label>背景:</label><input type="color" id="bg-color-input" value="#FFFFFF" disabled title="儲存格背景顏色"></div>
                    <div class="separator"></div>
                    <div class="control-group"><label>對齊:</label><button id="align-left-btn" class="icon-btn btn-align" disabled title="靠左對齊"><svg viewBox="0 0 24 24"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button><button id="align-center-btn" class="icon-btn btn-align" disabled title="置中對齊"><svg viewBox="0 0 24 24"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button><button id="align-right-btn" class="icon-btn btn-align" disabled title="靠右對齊"><svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button><button id="align-top-btn" class="icon-btn btn-align" disabled title="靠上對齊"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button><button id="align-middle-btn" class="icon-btn btn-align" disabled title="垂直置中"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button><button id="align-bottom-btn" class="icon-btn btn-align" disabled title="靠下對齊"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button></div>
                     <div class="separator"></div>
                    <div class="control-group"><label>表格:</label><button id="add-row-btn" class="icon-btn btn-table" disabled title="在下方新增一列"><svg viewBox="0 0 24 24"><path d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM4 12h16v4H4v-4zm10-4.5h2v3h-2v-3zm-3 0h2v3h-2v-3zm-3 0h2v3H8v-3zM21 20H3v-1c0-.55.45-1 1-1h16c.55 0 1 .45 1 1v1zM11 2v3h2V2h-2z"/></svg></button><button id="add-col-btn" class="icon-btn btn-table" disabled title="在右方新增一欄"><svg viewBox="0 0 24 24"><path d="M8 4v16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm6 14h-4V6h4v12zm-8.5-2h3v-2h-3v2zm0-3h3v-2h-3v2zm0-3h3v-2h-3v2zM20 4c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H10V4h10zM19 21v-2h1c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-1V1h-2v2h-8V1H8v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14v2h2z" transform="scale(1, -1) translate(0, -24)"/></svg></button><button id="delete-row-btn" class="danger icon-btn" disabled title="刪除選取列"><svg viewBox="0 0 24 24"><path d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 9H6v-2h12v2z"/></svg></button><button id="delete-col-btn" class="danger icon-btn" disabled title="刪除選取欄"><svg viewBox="0 0 24 24"><path d="M14 4v16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2h-4zM4 8h4V6H4v2zm0 6h4v-2H4v2zm0-3h4v-2H4v2z"/></svg></button><button id="merge-cells-btn" class="icon-btn btn-table" disabled title="合併儲存格"><svg viewBox="0 0 24 24"><path d="M11 11H5v2h6v6h2v-6h6v-2h-6V5h-2v6Z M3 21V3h18v18H3Z"/></svg></button><button id="split-cell-btn" class="icon-btn btn-table" disabled title="拆分儲存格"><svg viewBox="0 0 24 24"><path d="M13 11V3h-2v8H3v2h8v8h2v-8h8v-2h-8Z M3 3v8h8V3H3Zm10 0v8h8V3h-8ZM3 13v8h8v-8H3Zm10 0v8h8v-8h-8Z"/></svg></button><button id="insert-image-btn" class="icon-btn btn-table" disabled title="插入圖片"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></button></div>
                     <div class="separator"></div>
                     <div class="control-group"><label>邊框:</label><input type="color" id="border-color-input" value="#dddddd" disabled><input type="number" id="border-width-input" min="0" max="10" value="1" disabled></div>
                     <div class="control-group"><label for="row-height-input">列高:</label><input type="number" id="row-height-input" min="1" disabled><input type="checkbox" id="fix-row-height-check" disabled><label for="fix-row-height-check">固定</label><label for="col-width-input" style="margin-left: 8px;">欄寬:</label><input type="number" id="col-width-input" min="1" disabled><input type="checkbox" id="fix-col-width-check" disabled><label for="fix-col-width-check">固定</label></div>
                </div>
            </div>
        </div>

        <main class="main-content">
            <div id="editor-container">
                <div id="content-display" contenteditable="false">
                    請從上方選擇一個 HTML 檔案...
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="image-upload-input" accept="image/*,.heic,.heif" style="display:none;">
    <div id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const getEl = (id) => document.getElementById(id);
            const contentDisplay = getEl('content-display');
            const fontSizeInput = getEl('font-size-input');
            const fontColorInput = getEl('font-color-input');
            
            // --- App State ---
            let originalFilename = '';
            let historyStack = [], HISTORY_MAX_SIZE = 30;
            let resizing = null, imageAction = null;

            // --- Utility Functions ---
            const showNotification = (message) => {
                const notification = getEl('notification');
                clearTimeout(notification.timer);
                notification.textContent = message;
                notification.classList.add('show');
                notification.timer = setTimeout(() => notification.classList.remove('show'), 3000);
            };

            const setControlsState = (enabled) => {
                getEl('sticky-header').querySelectorAll('button, input').forEach(control => {
                    if(control.id !== 'theme-toggle' && control.id !== 'select-file-btn' && control.id !== 'file-input') {
                       control.disabled = !enabled;
                    }
                });
                contentDisplay.contentEditable = enabled;
                getEl('undo-btn').disabled = historyStack.length <= 1;
            };

            // --- History (Undo/Redo) ---
            const saveState = () => {
                if (resizing || imageAction) return;
                historyStack.push(contentDisplay.innerHTML);
                if (historyStack.length > HISTORY_MAX_SIZE) historyStack.shift();
                getEl('undo-btn').disabled = false;
            };

            const undoState = () => {
                if (historyStack.length > 1) {
                    historyStack.pop();
                    contentDisplay.innerHTML = historyStack[historyStack.length - 1];
                    clearSelection();
                }
                getEl('undo-btn').disabled = historyStack.length <= 1;
            };

            // --- Selection ---
             const clearSelection = () => {
                document.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell'));
                const activeImage = document.querySelector('.image-wrapper.active');
                if(activeImage) {
                    activeImage.classList.remove('active');
                    removeImageControls(activeImage);
                }
            };

            // --- Core Functionality Initialization ---
            function initializeCoreFeatures() {

                // 1. File Handling
                try {
                    const selectFileBtn = getEl('select-file-btn');
                    const fileInput = getEl('file-input');
                    
                    selectFileBtn.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        originalFilename = file.name.replace(/\.[^/.]+$/, "");
                        getEl('current-filename').textContent = file.name;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const doc = new DOMParser().parseFromString(e.target.result, 'text/html');
                            contentDisplay.innerHTML = doc.body.innerHTML.trim() || '<p>&nbsp;</p>';
                            setControlsState(true);
                            historyStack = [];
                            saveState();
                            showNotification('檔案載入成功！');
                        };
                        reader.onerror = () => showNotification('讀取檔案時發生錯誤。');
                        reader.readAsText(file, 'UTF-8');
                        fileInput.value = '';
                    });
                } catch (e) {
                    console.error("File Handling initialization failed:", e);
                    showNotification("檔案處理功能初始化失敗。");
                }

                // 2. Text Formatting
                try {
                    const applyStyle = (command, value) => {
                        document.execCommand(command, false, value);
                        contentDisplay.focus();
                        saveState();
                    };
                    
                    fontSizeInput.addEventListener('change', () => {
                        // execCommand for font size is tricky, use a span wrapper instead for reliability
                        const selection = window.getSelection();
                        if (!selection.rangeCount || selection.isCollapsed) return;
                        
                        const range = selection.getRangeAt(0);
                        const span = document.createElement('span');
                        span.style.fontSize = fontSizeInput.value + 'px';
                        
                        span.appendChild(range.extractContents());
                        range.insertNode(span);
                        selection.removeAllRanges();
                        saveState();
                    });

                    fontColorInput.addEventListener('input', () => applyStyle('foreColor', fontColorInput.value));
                } catch (e) {
                    console.error("Text Formatting initialization failed:", e);
                    showNotification("文字格式化功能初始化失敗。");
                }

                // 3. Image Handling & Cropping
                try {
                    initializeImageHandling();
                } catch (e) {
                    console.error("Image Handling initialization failed:", e);
                    showNotification("圖片處理功能初始化失敗。");
                }

                // 4. RTF Export
                try {
                    initializeRtfExport();
                } catch (e) {
                    console.error("RTF Export initialization failed:", e);
                    showNotification("RTF 匯出功能初始化失敗。");
                }

                // 5. Other Controls
                try {
                    getEl('undo-btn').addEventListener('click', undoState);
                    getEl('save-html-btn').addEventListener('click', () => {
                         clearSelection();
                        const contentHTML = contentDisplay.innerHTML;
                        const filename = `${originalFilename || 'content'}.html`;
                        const fullHTML = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>Exported</title></head><body>${contentHTML}</body></html>`;
                        const blob = new Blob([fullHTML], { type: 'text/html' });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
                        showNotification('HTML 已儲存');
                    });
                     getEl('theme-toggle').addEventListener('click', () => {
                        const body = document.body;
                        const isDark = body.hasAttribute('data-theme');
                        if (isDark) {
                            body.removeAttribute('data-theme');
                            getEl('theme-icon-sun').style.display = 'block';
                            getEl('theme-icon-moon').style.display = 'none';
                        } else {
                            body.setAttribute('data-theme', 'dark');
                            getEl('theme-icon-sun').style.display = 'none';
                            getEl('theme-icon-moon').style.display = 'block';
                        }
                    });
                    // ... Add other simple listeners for table edits, alignment etc. here
                } catch (e) {
                    console.error("Other controls initialization failed:", e);
                }
            }
            
            function initializeImageHandling() {
                const createImageControls = (wrapper) => {
                    if (wrapper.querySelector('.crop-container')) return;
                    const controls = `<div class="crop-overlay"></div><div class="crop-handle edge edge-n"></div><div class="crop-handle edge edge-s"></div><div class="crop-handle edge edge-w"></div><div class="crop-handle edge edge-e"></div><div class="crop-handle corner corner-nw"></div><div class="crop-handle corner corner-ne"></div><div class="crop-handle corner corner-sw"></div><div class="crop-handle corner corner-se"></div>`;
                    const container = document.createElement('div');
                    container.className = 'crop-container';
                    container.innerHTML = controls;
                    wrapper.appendChild(container);
                };
                
                const removeImageControls = (wrapper) => {
                    const container = wrapper.querySelector('.crop-container');
                    if (container) wrapper.removeChild(container);
                };

                contentDisplay.addEventListener('click', (e) => {
                    const wrapper = e.target.closest('.image-wrapper');
                    const lastActive = document.querySelector('.image-wrapper.active');
                    if (lastActive && lastActive !== wrapper) {
                        lastActive.classList.remove('active');
                        removeImageControls(lastActive);
                    }
                    if (wrapper) {
                        e.stopPropagation();
                        if (!wrapper.classList.contains('active')) {
                            wrapper.classList.add('active');
                            createImageControls(wrapper);
                        }
                    }
                });
            
                contentDisplay.addEventListener('mousedown', (e) => {
                    const handle = e.target.closest('.crop-handle');
                    const wrapper = e.target.closest('.image-wrapper');
                    if (!handle || !wrapper) return;
                    
                    e.preventDefault();
                    e.stopPropagation();

                    const img = wrapper.querySelector('img');
                    const rect = wrapper.getBoundingClientRect();
                    const startX = e.clientX;
                    const startY = e.clientY;
                    
                    const initialClip = {
                        top: parseFloat(wrapper.dataset.clipTop) || 0, right: parseFloat(wrapper.dataset.clipRight) || 100,
                        bottom: parseFloat(wrapper.dataset.clipBottom) || 100, left: parseFloat(wrapper.dataset.clipLeft) || 0
                    };

                    const onMouseMove = (moveEvent) => {
                        const dx = (moveEvent.clientX - startX) / rect.width * 100;
                        const dy = (moveEvent.clientY - startY) / rect.height * 100;
                        let clip = {...initialClip};
                        
                        if (handle.classList.contains('edge-n') || handle.classList.contains('corner-nw') || handle.classList.contains('corner-ne')) clip.top = Math.max(0, Math.min(clip.bottom - 1, initialClip.top + dy));
                        if (handle.classList.contains('edge-s') || handle.classList.contains('corner-sw') || handle.classList.contains('corner-se')) clip.bottom = Math.min(100, Math.max(clip.top + 1, initialClip.bottom + dy));
                        if (handle.classList.contains('edge-w') || handle.classList.contains('corner-nw') || handle.classList.contains('corner-sw')) clip.left = Math.max(0, Math.min(clip.right - 1, initialClip.left + dx));
                        if (handle.classList.contains('edge-e') || handle.classList.contains('corner-ne') || handle.classList.contains('corner-se')) clip.right = Math.min(100, Math.max(clip.left + 1, initialClip.right + dx));
                        
                        img.style.clipPath = `polygon(${clip.left}% ${clip.top}%, ${clip.right}% ${clip.top}%, ${clip.right}% ${clip.bottom}%, ${clip.left}% ${clip.bottom}%)`;
                        wrapper.dataset.clipTop = clip.top; wrapper.dataset.clipRight = clip.right;
                        wrapper.dataset.clipBottom = clip.bottom; wrapper.dataset.clipLeft = clip.left;
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        saveState();
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
                
                const processImageFile = (file) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.execCommand('insertHTML', false, `<div class="image-wrapper" style="width: 200px;"><img src="${ev.target.result}" alt="${file.name}"></div>`);
                        saveState();
                    };
                    reader.readAsDataURL(file);
                };

                getEl('insert-image-btn').addEventListener('click', () => getEl('image-upload-input').click());
                getEl('image-upload-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.name.match(/\.(heic|heif)$/i)) {
                        showNotification('正在轉換 HEIC 檔案...');
                        heic2any({ blob: file, toType: "image/jpeg" })
                            .then(conversionResult => { processImageFile(conversionResult); showNotification('轉換成功！'); })
                            .catch(() => showNotification('HEIC 轉換失敗。'));
                    } else {
                        processImageFile(file);
                    }
                    e.target.value = '';
                });
            }

            function initializeRtfExport() {
                 function colorToHex(colorStr) {
                    if (!colorStr || colorStr === 'transparent') return '#FFFFFF'; // Default for transparent
                    const temp = document.createElement("div");
                    temp.style.color = colorStr;
                    document.body.appendChild(temp);
                    const computedColor = window.getComputedStyle(temp).color;
                    document.body.removeChild(temp);
                    const match = computedColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                    if (match) {
                        try {
                            const r = parseInt(match[1]); const g = parseInt(match[2]); const b = parseInt(match[3]);
                            return ("#" + ("0" + r.toString(16)).slice(-2) + ("0" + g.toString(16)).slice(-2) + ("0" + b.toString(16)).slice(-2)).toUpperCase();
                        } catch (e) { return '#000000'; }
                    }
                    return '#000000';
                }
                function base64ToHex(base64) { 
                    const raw = window.atob(base64); let hex = ''; 
                    for (let i = 0; i < raw.length; i++) { const charHex = raw.charCodeAt(i).toString(16); hex += (charHex.length === 2 ? charHex : '0' + charHex); } return hex; 
                }

                class RtfExporter {
                     constructor() {
                        this.colorTable = {}; this.fontTable = {}; this.colorIndex = 1; this.fontIndex = 1;
                    }
                    async generate(element) {
                        this.colorTable = { '#000000': { index: 0, def: '\\red0\\green0\\blue0;' }}; this.fontTable = { 'Microsoft JhengHei': { index: 0, def: '{\\f0 Microsoft JhengHei;}' } };
                        this.colorIndex = 1; this.fontIndex = 1;
                        let contentRtf = await this.parseNode(element);
                        const colorTableDef = Object.values(this.colorTable).map(c => c.def).join(''); const fontTableDef = Object.values(this.fontTable).map(f => f.def).join('');
                        return `{\\rtf1\\ansi\\deff0{\\fonttbl${fontTableDef}}{\\colortbl;${colorTableDef}}${contentRtf}}`;
                    }
                    getColorIndex(colorStr) {
                        const hex = colorToHex(colorStr); if (this.colorTable[hex]) return this.colorTable[hex].index;
                        const match = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                        if(match) {
                            const [r, g, b] = [match[1], match[2], match[3]];
                            this.colorTable[hex] = { index: this.colorIndex, def: `\\red${r}\\green${g}\\blue${b};` };
                            return this.colorIndex++;
                        } return 0;
                    }
                    async parseNode(node) {
                        let rtf = '';
                        for (const child of node.childNodes) {
                            if (child.nodeType === Node.TEXT_NODE) rtf += this.escapeText(child.textContent);
                            else if (child.nodeType === Node.ELEMENT_NODE) rtf += await this.parseElement(child);
                        } return rtf;
                    }
                    async parseElement(el) {
                        const style = window.getComputedStyle(el); let prefix = '{', suffix = '}';
                        prefix += `\\f0\\fs${parseInt(style.fontSize) * 2 || 24} `;
                        prefix += `\\cf${this.getColorIndex(style.color)} `;
                        if (style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700) prefix += '\\b ';
                        if (style.fontStyle === 'italic') prefix += '\\i ';
                        if (style.textDecorationLine === 'underline') prefix += '\\ul ';
                        let content = await this.parseNode(el);
                        const tagName = el.tagName.toUpperCase();
                        if (['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(tagName)) {
                            prefix += '\\pard ';
                            if (style.textAlign === 'center') prefix += '\\qc '; else if (style.textAlign === 'right') prefix += '\\qr ';
                            suffix += '\\par';
                        } else if (tagName === 'BR') return '\\par\n';
                        else if (tagName === 'TABLE') return await this.parseTable(el);
                        else if (tagName === 'IMG') return await this.parseImage(el);
                        return `${prefix}${content}${suffix}`;
                    }
                    async parseImage(img) {
                        try {
                            const wrapper = img.closest('.image-wrapper');
                            const response = await fetch(img.src); const blob = await response.blob();
                            const base64 = await new Promise(resolve => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(',')[1]); reader.readAsDataURL(blob); });
                            const hexData = base64ToHex(base64); const picType = blob.type === 'image/png' ? '\\pngblip' : '\\jpegblip';
                            const w = wrapper.offsetWidth * 15, h = wrapper.offsetHeight * 15;
                            let crop = { l:0, r:0, t:0, b:0 };
                            crop.l = (parseFloat(wrapper.dataset.clipLeft) || 0) / 100 * w; crop.r = (100 - (parseFloat(wrapper.dataset.clipRight) || 100)) / 100 * w;
                            crop.t = (parseFloat(wrapper.dataset.clipTop) || 0) / 100 * h; crop.b = (100 - (parseFloat(wrapper.dataset.clipBottom) || 100)) / 100 * h;
                            return `{\\pard\\qc{\\pict\\picwgoal${Math.round(w - crop.l - crop.r)}\\pichgoal${Math.round(h - crop.t - crop.b)}\\piccropl${Math.round(crop.l)}\\piccropr${Math.round(crop.r)}\\piccropt${Math.round(crop.t)}\\piccropb${Math.round(crop.b)}${picType} ${hexData}}\\par}`;
                        } catch (e) { console.error(e); return ''; }
                    }
                    async parseTable(table) {
                        const grid = []; Array.from(table.rows).forEach((row, r) => { if (!grid[r]) grid[r] = []; Array.from(row.cells).forEach(cell => { let c = 0; while (grid[r][c]) c++; const colspan = parseInt(cell.getAttribute('colspan') || 1); const rowspan = parseInt(cell.getAttribute('rowspan') || 1); for (let i = 0; i < rowspan; i++) { for (let j = 0; j < colspan; j++) { if (!grid[r + i]) grid[r + i] = []; grid[r + i][c + j] = { cell, isMerged: i > 0 || j > 0, isFirst: i === 0 && j === 0 }; } } }); });
                        let tableRtf = '';
                        for (let r = 0; r < grid.length; r++) {
                            let rowHeader = `{\\trowd\\trgaph108 `; let currentX = 0;
                            for (let c = 0; c < grid[r].length; c++) {
                                const cellEl = grid[r][c].cell; const colspan = parseInt(cellEl.getAttribute('colspan') || 1);
                                currentX += cellEl.getBoundingClientRect().width / colspan * 15;
                                if (grid[r][c].isFirst) rowHeader += this.getCellBorders(cellEl); rowHeader += `\\cellx${Math.round(currentX)} `;
                            }
                            let cellsContent = '';
                            for (let c = 0; c < grid[r].length; c++) {
                                const {cell, isFirst} = grid[r][c];
                                if(isFirst) {
                                    let cellContent = await this.parseNode(cell); let prefix = '{\\intbl ';
                                    if(parseInt(cell.getAttribute('rowspan')) > 1) prefix += '\\clvmgf '; if(parseInt(cell.getAttribute('colspan')) > 1) prefix += '\\clmrg ';
                                    cellsContent += `${prefix}${cellContent}}\\cell `;
                                } else { if(grid[r][c-1] && grid[r][c-1].cell === grid[r][c].cell) cellsContent += '{\\intbl \\clmrg }\\cell '; else cellsContent += '{\\intbl \\clvmrg }\\cell '; }
                            }
                            tableRtf += `${rowHeader}${cellsContent}}\\row\n`;
                        } return `{\\pard ${tableRtf}\\par}`;
                    }
                    getCellBorders(cell) {
                        const style = window.getComputedStyle(cell); let borderRtf = ''; const borderTypes = ['top', 'bottom', 'left', 'right'];
                        borderTypes.forEach(type => {
                            const width = parseInt(style[`border-${type}-width`]);
                            if(width > 0) {
                                const colorIndex = this.getColorIndex(style[`border-${type}-color`]);
                                borderRtf += `\\clbrdr${type.substring(0,1)} \\brdrw${width * 15}\\brdrs\\clbrdrcf${colorIndex} `;
                            }
                        }); return borderRtf;
                    }
                    escapeText(text) { return text.replace(/\\/g, '\\\\').replace(/{/g, '\\{').replace(/}/g, '\\}').replace(/\n/g, '\\par\n').split('').map(c => c.charCodeAt(0) > 127 ? `\\u${c.charCodeAt(0)}?` : c).join(''); }
                }

                getEl('save-rtf-btn').addEventListener('click', async () => {
                    showNotification('正在產生 RTF 檔案...');
                    try {
                        const rtfContent = await new RtfExporter().generate(contentDisplay);
                        const blob = new Blob([rtfContent], { type: 'application/rtf' });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${originalFilename || 'content'}.rtf`;
                        a.click(); URL.revokeObjectURL(a.href);
                        showNotification('RTF 檔案已儲存。');
                    } catch (error) { console.error("RTF Generation Error:", error); showNotification('產生 RTF 檔案失敗。'); }
                });
            }

            // --- Initial Load ---
            initializeCoreFeatures();
            setControlsState(false);
        });
    </script>
</body>
</html>
