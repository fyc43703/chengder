<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML視覺化編輯器</title>
  <style>
      :root {
          /* --- Light Theme --- */
          --system-font: -apple-system, "SF Pro", "Helvetica Neue", "Arial", sans-serif;
          --background-color: #f5f5f7;
          --window-background-color: rgba(255, 255, 255, 0.6);
          --panel-background-color: rgba(240, 240, 245, 0.7);
          --dropdown-background-color: rgba(255, 255, 255, 0.95);
          --editor-background-color: #fff;
          --system-blue: #007aff;
          --system-green: #28a745;
          --system-red: #ff3b30;
          --system-gray: #8e8e93;
          --system-brown: #a2835b;
          --system-purple: #5856d6;
          --border-color: rgba(0, 0, 0, 0.1);
          --text-color: #1d1d1f;
          --text-color-secondary: #6e6e73;
          --table-header-bg: #f7f7f8;
          --window-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
          --blur-radius: 12px;
      }

      body[data-theme="dark"] {
          /* --- Dark Theme --- */
          --background-color: #1c1c1e;
          --window-background-color: rgba(44, 44, 46, 0.7);
          --panel-background-color: rgba(28, 28, 30, 0.8);
          --dropdown-background-color: rgba(28, 28, 30, 0.95);
          --editor-background-color: #2c2c2e;
          --system-blue: #0a84ff;
          --system-green: #30d158;
          --system-red: #ff453a;
          --system-gray: #8e8e93;
          --system-brown: #ab8e68;
          --system-purple: #5e5ce6;
          --border-color: rgba(255, 255, 255, 0.15);
          --text-color: #f2f2f7;
          --text-color-secondary: #8d8d92;
          --table-header-bg: #3a3a3c;
      }

      /* --- 基本設定 --- */
      body {
          font-family: var(--system-font);
          margin: 0;
          padding: 20px;
          min-height: 100vh;
          background-color: var(--background-color);
          color: var(--text-color);
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          transition: background-color 0.3s, color 0.3s;
          box-sizing: border-box;
      }

      /* --- 主視窗容器 --- */
      .window-container {
          width: 100%;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: var(--window-shadow);
          border: 1px solid var(--border-color);
          background: var(--window-background-color);
          background-image: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
          backdrop-filter: blur(var(--blur-radius));
          -webkit-backdrop-filter: blur(var(--blur-radius));
          transition: background-color 0.3s, border-color 0.3s;
      }
      
      /* 【修改】新增詳細的列印樣式 */
      @media print {
          body {
              background-color: #fff !important;
              padding: 0;
              margin: 0;
          }
          .window-container {
              display: none;
          }
          #print-content {
              display: block !important;
              box-shadow: none;
              border: none;
              background-color: #fff !important;
              color: #000 !important;
          }
          /* 確保列印時表格背景是乾淨的 */
          #print-content table, 
          #print-content th, 
          #print-content td {
              background-color: transparent !important;
              color: #000 !important;
              border-color: #ddd !important;
          }
          /* 移除列印時的選取框 */
          #print-content .selected-cell {
              outline: none !important;
              background-color: transparent !important;
          }
      }

      /* --- 【新增】固定工具列的核心樣式 --- */
      #fixed-header {
          position: -webkit-sticky;
          position: sticky;
          top: -1px; /* 微調以避免頂部出現細線 */
          z-index: 100;
          background: var(--window-background-color);
          backdrop-filter: blur(var(--blur-radius));
          -webkit-backdrop-filter: blur(var(--blur-radius));
      }

      /* --- 標題列 --- */
      .title-bar {
          padding: 10px 12px;
          border-bottom: 1px solid var(--border-color);
          position: relative;
          text-align: center;
      }
      .title-bar-top {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 0;
          min-height: 28px;
      }
      .window-controls { display: flex; align-items: center; gap: 8px; position: absolute; top: 10px; left: 12px; }
      .control-dot { width: 12px; height: 12px; border-radius: 50%; }
      .dot-red { background-color: #ff5f56; }
      .dot-yellow { background-color: #ffbd2e; }
      .dot-green { background-color: #27c93f; }
      
      .title-content { margin: 0 auto; }
      .window-title { font-size: 20px; font-weight: 600; margin:0; }
      
      .window-subtitle { font-size: 13px; color: var(--text-color-secondary); margin: 2px 0 0; }
      .window-creator { font-size: 12px; color: var(--text-color-secondary); margin: 2px 0 0; }

      #current-filename {
          font-size: 13px;
          color: var(--text-color-secondary);
          margin-left: 8px;
      }

      #theme-toggle { background: transparent; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 10px; right: 12px; }
      #theme-toggle:hover { background-color: var(--border-color); }
      #theme-toggle svg { width: 24px; height: 24px; fill: var(--text-color-secondary); }

      /* --- 主要內容區域 --- */
      .main-content { padding: 16px; }
      
      /* --- 控制面板 --- */
      .controls-panel {
          display: flex;
          flex-direction: column;
          /* 【修改】因結構調整，這裡的 padding 由父層控制 */
          padding: 12px 16px; 
          gap: 12px;
      }
      .controls-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
      .control-group { display: flex; align-items: center; gap: 5px; }
      .control-group label, .control-group > label {
          font-size: 13px; 
          color: var(--system-blue); 
          font-weight: 600;
          white-space: nowrap; 
      }
      .separator { width: 1px; height: 20px; background-color: var(--border-color); }
      .spacer { margin-left: auto; }
      
      /* --- 按鈕與輸入框 --- */
      input[type="text"], input[type="number"] {
          font-family: var(--system-font);
          border: 1px solid var(--border-color);
          background-color: var(--editor-background-color);
          color: var(--text-color);
          padding: 6px 10px;
          border-radius: 6px;
          font-size: 14px;
          transition: box-shadow 0.2s, border-color 0.2s, background-color 0.3s;
      }
      #search-input, #replace-input { width: 60px; }
      #font-size-input, #border-width-input { width: 36px; text-align: center; }
      #row-height-input, #col-width-input { width: 40px; }
      input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--system-blue); box-shadow: 0 0 0 3px color-mix(in srgb, var(--system-blue) 30%, transparent); background-color: color-mix(in srgb, var(--editor-background-color) 95%, white); }
      
      #font-size-input::-webkit-outer-spin-button,
      #font-size-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      #font-size-input {
        -moz-appearance: textfield;
      }
      
      input[type="color"] {
          -webkit-appearance: none;
          width: 28px; height: 28px; border: none; padding: 0; background-color: transparent;
          border-radius: 6px; overflow: hidden; cursor: pointer;
      }
      input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
      input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 4px; }
      
      input[type="color"].mixed::-webkit-color-swatch {
          background-image:
              linear-gradient(45deg, rgba(0,0,0,0.2) 25%, transparent 25%),
              linear-gradient(-45deg, rgba(0,0,0,0.2) 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, rgba(0,0,0,0.2) 75%),
              linear-gradient(-45deg, transparent 75%, rgba(0,0,0,0.2) 75%);
          background-size: 8px 8px;
          background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
      }

      button {
          padding: 4px 10px; border: none; background-color: var(--system-blue); color: white;
          border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;
          transition: transform 0.1s, filter 0.2s, background-color 0.2s, box-shadow 0.2s; 
          display: flex; align-items: center; gap: 6px;
      }
      button:hover { 
          filter: brightness(1.1);
          transform: translateY(-1px);
          box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }
      button:active { 
          transform: scale(0.98) translateY(0); 
          filter: brightness(1.2); 
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      button.secondary { background-color: var(--system-gray); }
      button.success { background-color: var(--system-green); }
      button.danger { background-color: var(--system-red); }
      button:disabled { background-color: color-mix(in srgb, var(--system-gray) 50%, var(--panel-background-color)); color: var(--text-color-secondary); cursor: not-allowed; filter: none; }
      button:disabled:hover, button:disabled:active { transform: none; box-shadow: none; }
      button svg { width: 16px; height: 16px; fill: currentColor; }

      /* Custom Button Styles */
      #select-file-btn {
          background-color: #000080; /* Navy Blue */
          font-size: 15px;
          padding: 8px 14px;
      }
      #select-file-btn span {
          margin-left: 4px;
      }
      #select-file-btn svg {
          width: 18px;
          height: 18px;
      }
      #export-btn {
          background-color: orange;
          font-size: 15px;
          padding: 8px 14px;
      }
      #export-btn svg {
          width: 18px;
          height: 18px;
      }

      /* --- 圖示按鈕 --- */
      button.icon-btn {
          padding: 5px;
          width: 28px;
          height: 28px;
          justify-content: center;
      }
      .btn-align { background-color: var(--system-green); }
      .btn-table { background-color: var(--system-brown); }
      .btn-insert { background-color: var(--system-purple); }

      /* --- 下拉選單 (Dropdown) --- */
      .dropdown { position: relative; display: inline-block; }
      .dropdown-content { display: none; position: absolute; background-color: var(--dropdown-background-color); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 6px; padding: 5px 0; border: 1px solid var(--border-color); right: 0; backdrop-filter: blur(var(--blur-radius)); -webkit-backdrop-filter: blur(var(--blur-radius));}
      .dropdown-content a { color: var(--text-color); padding: 8px 12px; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; }
      .dropdown-content a:hover { background-color: var(--border-color); }
      .dropdown.show .dropdown-content { display: block; }
      .dropdown-content svg { width: 16px; height: 16px; fill: var(--text-color-secondary); }

      /* --- 編輯器 --- */
      #editor-container { 
          overflow: auto; 
          padding: 20px; 
          background-color: var(--editor-background-color); 
          border-radius: 8px; 
          border: 1px solid var(--border-color); 
          transition: all 0.3s;
          box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
      }
      
      #content-display { 
          background-color: var(--editor-background-color); /* Match editor background for seamless look */
          min-height: 250px; 
          transition: transform 0.2s ease, width 0.3s ease, height 0.3s ease; 
          transform-origin: top left; 
          user-select: none; 
          outline: none;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Softer shadow */
      }
      #content-display[contenteditable="true"] { 
          user-select: text; 
          cursor: text; 
      }

      /* --- 表格與選取樣式 --- */
      #content-display table {
          border-collapse: collapse;
          width: 100%;
          position: relative;
          table-layout: fixed;
      }
      #content-display th, #content-display td { 
          border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; font-size: 14px; 
          transition: background-color 0.3s, border-color 0.3s, border-width 0.3s; position: relative; min-width: 40px;
          overflow: hidden;
          word-break: break-all;
      }
      #content-display th { background-color: var(--table-header-bg); font-weight: 600; }
      
      #content-display td.selected-cell, #content-display th.selected-cell { 
           outline: 1px solid var(--system-blue); 
           outline-offset: -1px; 
           background-color: color-mix(in srgb, var(--system-blue) 5%, transparent) !important; 
      }
      
      #main-title.editing-target {
          outline: 2px solid var(--system-blue);
          border-radius: 4px;
          cursor: text;
      }

      mark.highlight { background-color: #ffdd57; color: black; border-radius: 2px; padding: 0 2px; }
      
      .resizable-image-container, .shape-container { 
          position: relative;
          display: inline-block;
          min-width: 20px; 
          min-height: 20px;
          cursor: move;
          user-select: none;
      }
      
      .shape-container[contenteditable="false"] {
           -webkit-user-select: none;
           -moz-user-select: none;
           -ms-user-select: none;
           user-select: none;
      }

      .resizable-image-container img, .shape-container svg { 
          display: block;
          pointer-events: none;
      }

      .resize-handle {
          position: absolute;
          width: 12px;
          height: 12px;
          background-color: var(--system-blue);
          border: 2px solid var(--editor-background-color);
          right: -6px;
          bottom: -6px;
          border-radius: 50%;
          cursor: nwse-resize;
          z-index: 10;
          opacity: 0;
          transition: opacity 0.2s;
      }
      .resizable-image-container:hover .resize-handle, .shape-container:hover .resize-handle {
          opacity: 1;
      }

      /* --- 徹底重寫、絕對穩健的全新圖片約束架構 --- */
      
      /* 1. 視口容器 (Viewport): 當圖片在表格內時，此容器將擁有固定高度，斬斷圖片對列高的影響 */
      #content-display td .resizable-image-container.image-in-cell,
      #content-display th .resizable-image-container.image-in-cell {
          position: relative; /* 成為絕對定位圖片的基準 */
          width: 100%;
          overflow: hidden; /* 確保內容不會溢出 */
          display: block; /* 使用 block 佈局 */
      }
      
      /* 2. 絕對定位的圖片: 將圖片從正常排版流中抽離，使其尺寸無法撐開表格 */
      #content-display td .image-in-cell img,
      #content-display th .image-in-cell img {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%; /* 填滿父層的固定高度視口 */
          object-fit: contain; /* 在視口內，以正確的長寬比縮放 */
      }
      
      /* 3. 一般圖片樣式 (表格外): 保持原有的自動縮放行為 */
      .resizable-image-container:not(.image-in-cell) img {
          width: 100%;
          height: auto;
      }


      /* --- 提示訊息 --- */
      #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
      #notification.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }

      /* --- 操作說明區塊 --- */
      .help-section {
          background-color: var(--panel-background-color);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 24px;
          margin-top: 24px;
      }
      .help-section h2 {
          font-size: 22px;
          font-weight: 600;
          color: var(--system-blue);
          border-bottom: 1px solid var(--border-color);
          padding-bottom: 12px;
          margin-top: 0;
          margin-bottom: 20px;
          text-align: center;
      }
      .help-cards-container {
          display: flex;
          flex-wrap: wrap;
          gap: 16px;
          justify-content: center;
      }
      .help-card {
          background-color: var(--window-background-color);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          padding: 16px;
          flex: 1 1 300px; /* Flexbox for responsive cards */
          min-width: 280px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          transition: transform 0.2s, box-shadow 0.2s;
      }
      .help-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .help-card h3 {
          font-size: 18px;
          font-weight: 600;
          color: var(--system-blue);
          margin-top: 0;
          margin-bottom: 16px;
      }
      .help-card ul {
          list-style: none;
          padding-left: 0;
          margin: 0;
      }
      .help-section li {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          margin-bottom: 12px;
          line-height: 1.5;
          color: var(--text-color-secondary);
      }
      .help-section .help-icon {
          width: 24px;
          height: 24px;
          flex-shrink: 0;
          margin-top: -2px;
      }
      .help-section .keyword {
          color: var(--system-blue);
          font-weight: 500;
      }

  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>
<body>

  <div class="window-container">
      <!-- 【修改】將 header 和 controls-panel 包裹在一個新的 div 中 -->
      <div id="fixed-header">
          <header class="title-bar">
              <div class="title-bar-top">
                  <div class="window-controls">
                      <span class="control-dot dot-red"></span>
                      <span class="control-dot dot-yellow"></span>
                      <span class="control-dot dot-green"></span>
                      <span id="current-filename"></span>
                  </div>
                   <div class="title-content">
                      <h1 id="main-title" class="window-title">HTML 視覺化編輯器</h1>
                  </div>
                  <button id="theme-toggle" title="切換明暗主題">
                        <span id="theme-icon-sun">
                            <svg viewBox="0 0 24 24"><path d="M12 9.5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5-2.5-1.12-2.5-2.5 1.12-2.5 2.5-2.5M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 12h3m-1 9.78l2.12-2.12M12 2v3m8.12.88L18 7.12M22 12h-3m1-9.78L18.88 4.34M12 22v-3m-8.12-.88L6 16.88"/></svg>
                        </span>
                        <span id="theme-icon-moon" style="display: none;">
                            <svg viewBox="0 0 24 24"><path d="M12.3 4.9c.4-.2.6-.7.4-1.1-.2-.4-.7-.6-1.1-.4C7.2 5.4 4 9.2 4 13.5 4 19.1 8.9 24 14.5 24c4.3 0 8-3.2 9.1-7.4.2-.4 0-.9-.4-1.1s-.9-.1-1.1.2c-1.3 2.1-3.6 3.3-6.1 3.3-4.1 0-7.5-3.4-7.5-7.5 0-2.5 1.2-4.8 3.3-6.1z"/></svg>
                        </span>
                    </button>
                </div>
                <p class="window-subtitle">一個簡易直觀的操作工具，可用於編輯 HTML 表格和文字內容。</p>
                <p class="window-creator">製作者：陳政德</p>
            </header>
            <div class="controls-panel">
                 <div class="controls-row">
                    <div class="control-group">
                        <button id="select-file-btn">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-8-8-8 8h4v6zm-4 2h14v2H5v-2z"/></svg>
                            <span>匯入檔案</span>
                        </button>
                        <input type="file" id="file-input" accept=".html,.htm" style="display: none;">
                        <button id="new-page-btn" class="icon-btn" title="新增空白頁">
                           <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2z"/></svg>
                        </button>
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <button id="undo-btn" title="復原 (Ctrl+Z)" class="icon-btn">
                             <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.38 11.23 17.28 8 12.5 8z"/></svg>
                        </button>
                        <button id="cut-btn" title="剪下 (Ctrl+X)" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M9.64 7.64c.23-.5.36-1.05.36-1.64 0-2.21-1.79-4-4-4S2 3.79 2 6c0 .59.13 1.14.36 1.64L9 14.29V22h6v-7.71l6.64-6.65c.23-.5.36-1.05.36-1.64 0-2.21-1.79-4-4-4s-4 1.79-4 4c0 .59.13 1.14.36 1.64L15 11l-5.36-3.36zM6 6c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm12 0c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z"/></svg></button>
                        <button id="copy-btn" title="複製 (Ctrl+C)" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                        <button id="paste-btn" title="貼上 (Ctrl+V)" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0S9.6.84 9.18 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg></button>
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <input type="text" id="search-input" placeholder="搜尋文字">
                        <button id="search-btn">搜尋</button>
                        <input type="text" id="replace-input" placeholder="取代為">
                        <button id="replace-btn">全部取代</button>
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <label>插入:</label>
                        <button id="insert-table-btn" class="icon-btn btn-insert" title="插入表格">
                           <svg viewBox="0 0 24 24"><path d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2m0 2v3h14V6H5m0 5v3h4v-3H5m6 0v3h8v-3h-8m-6 5v3h4v-3H5m6 0v3h8v-3h-8Z"/></svg>
                        </button>
                        <div class="dropdown">
                            <button id="insert-shape-btn" class="icon-btn btn-insert" title="插入圖案">
                                <svg viewBox="0 0 24 24"><path d="M23 12l-7 7v-4.2c-2.8.1-5.2.8-7.2 2.2-2 1.3-3.3 3-4 5-.5-1.8-.4-4.1.4-6.8 1-3 2.8-5.2 5.4-6.6C13.2 7.3 16 6.8 19 6.8V3l4 4.5V12z"/></svg>
                            </button>
                            <div class="dropdown-content" id="shape-options">
                                <a data-shape="rect">矩形</a>
                                <a data-shape="circle">圓形</a>
                            </div>
                        </div>
                        <button id="insert-image-btn" class="icon-btn btn-insert" title="插入圖片">
                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        </button>
                        <button id="insert-link-btn" class="icon-btn btn-insert" title="新增超連結 (Ctrl+K)">
                            <svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                        </button>
                    </div>
                    <div class="separator"></div>
                     <div class="control-group">
                        <label>縮放:</label>
                        <button id="zoom-in-btn" class="icon-btn" title="放大">+</button>
                        <button id="zoom-out-btn" class="icon-btn" title="縮小">-</button>
                        <button id="zoom-reset-btn" title="重設縮放">100%</button>
                    </div>
                    <div class="spacer"></div>
                    <div class="control-group">
                        <div class="dropdown">
                            <button id="export-btn" title="儲存或匯出檔案">
                                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                                <span>儲存 / 匯出</span>
                            </button>
                            <div class="dropdown-content" id="export-options">
                                <a id="export-html-link">
                                    <svg viewBox="0 0 24 24"><path d="M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                                    <span>儲存為 HTML</span>
                                </a>
                                <a id="export-pdf-link">
                                    <svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm-2.5.5H9v-2h-.5v2zm7 4.5h-3v-1h3v1zm0-2h-3v-1h3v1zm0-2h-3v-1h3v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/></svg>
                                    <span>另存 PDF / 列印</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="control-group">
                        <label>表格:</label>
                        <button id="add-row-btn" class="icon-btn btn-table" title="在下方新增一列"><svg viewBox="0 0 24 24"><path d="M22 14H2v-4h20v4zM8 20v-4H2v4h6zm2 0h12v-4H10v4zM8 4v4H2V4h6zm2 0v4h12V4H10zm-1-2a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v1H9V2zm0 20v1H9a1 1 0 0 1-1-1v-1h1zM2 15a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h1v12H2zm20-1V4h1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1z" opacity=".5"/><path d="M21 16H3a1 1 0 0 1-1-1v-2h20v2a1 1 0 0 1-1 1zm-1-6H2V8a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v2z"/><path d="M11 11h2v2h-2zm-4 0h2v2H7zm8 0h2v2h-2z" fill-rule="evenodd"/></svg></button>
                        <button id="add-col-btn" class="icon-btn btn-table" title="在右方新增一欄"><svg viewBox="0 0 24 24"><path d="M14 22H2v-6h12v6zm-4-8H2V2h8v12zm12 8h-6v-6h6v6zM16 2v12h6V2h-6z" opacity=".5"/><path d="M16 21H2a1 1 0 0 1-1-1v-5h12v6a1 1 0 0 1-1 1zM2 9V3a1 1 0 0 1 1-1h5v8H2zm18 12h-5v-6h6v5a1 1 0 0 1-1 1zM15 9V2a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v7h-7z"/><path d="M11 11h2v2h-2zm0-4h2v2h-2zm0 8h2v2h-2z" fill-rule="evenodd"/></svg></button>
                        <button id="delete-row-btn" class="danger icon-btn" title="刪除選取列"><svg viewBox="0 0 24 24"><path d="M3 6h18v12H3V6zm1 1v10h16V7H4z" opacity=".5"/><path d="M20 11H4v2h16v-2z" fill-rule="evenodd"/></svg></button>
                        <button id="delete-col-btn" class="danger icon-btn" title="刪除選取欄"><svg viewBox="0 0 24 24"><path d="M18 3v18H6V3h12zm-1 1H7v16h10V4z" opacity=".5"/><path d="M13 20h-2V4h2v16z" fill-rule="evenodd"/></svg></button>
                        <button id="merge-cells-btn" class="icon-btn btn-table" title="合併儲存格"><svg viewBox="0 0 24 24"><path d="M6 18V6h12v12H6zm1-1h10V7H7v10z" opacity=".5"/><path d="M11 15v2H9v-2h2zm-2-2h2v-2H9v2zm2-2v-2h2v2h-2zm2 2h2v-2h-2v2zm2-4V9h-2V7h2v2zM9 9v2h2V9H9z" fill-rule="evenodd"/><path d="M21 21H3V3h18v18zM5 19h14V5H5v14z" opacity=".5"/></svg></button>
                        <button id="split-cell-btn" class="icon-btn btn-table" title="拆分儲存格"><svg viewBox="0 0 24 24"><path d="M6 18V6h12v12H6zm1-1h10V7H7v10z" opacity=".5"/><path d="M11 13h2v6h-2v-6zM5 11h14v2H5v-2zm8-2h6V7h-6v2zM5 9h6V7H5v2z" fill-rule="evenodd"/><path d="M21 21H3V3h18v18zM5 19h14V5H5v14z" opacity=".5"/></svg></button>
                    </div>
                     <div class="separator"></div>
                    <div class="control-group">
                        <label>對齊:</label>
                        <button id="align-left-btn" class="icon-btn btn-align" title="靠左對齊"><svg viewBox="0 0 24 24"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-center-btn" class="icon-btn btn-align" title="置中對齊"><svg viewBox="0 0 24 24"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-right-btn" class="icon-btn btn-align" title="靠右對齊"><svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-top-btn" class="icon-btn btn-align" title="靠上對齊"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-middle-btn" class="icon-btn btn-align" title="垂直置中"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-bottom-btn" class="icon-btn btn-align" title="靠下對齊"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button>
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <label>文字:</label>
                        <button id="bold-btn" class="icon-btn" title="粗體 (Ctrl+B)"><svg viewBox="0 0 24 24"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4.25-4H7v14h7.04c2.1 0 3.71-1.7 3.71-3.78 0-1.52-.86-2.82-2.15-3.43zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg></button>
                        <button id="underline-btn" class="icon-btn" title="底線 (Ctrl+U)"><svg viewBox="0 0 24 24"><path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/></svg></button>
                        <button id="decrease-font-size-btn" class="icon-btn" title="縮小文字">A-</button>
                        <input type="number" id="font-size-input" min="8" max="72" value="14" title="文字大小">
                        <button id="increase-font-size-btn" class="icon-btn" title="放大文字">A+</button>
                        <input type="color" id="font-color-input" value="#000000" title="文字顏色">
                        <label for="text-bg-color-input" style="margin-left: 4px;">文字背景:</label>
                        <input type="color" id="text-bg-color-input" value="#FFFFFF" title="文字背景顏色">
                    </div>
                     <div class="control-group">
                        <label>儲存格背景:</label>
                        <input type="color" id="bg-color-input" value="#FFFFFF" title="儲存格背景顏色">
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <label>邊框:</label>
                        <input type="color" id="border-color-input" value="#dddddd" title="表格邊框顏色">
                        <input type="number" id="border-width-input" min="0" max="10" value="1" title="表格邊框寬度 (px)">
                        <div class="dropdown">
                            <button id="border-dropdown-btn" class="icon-btn btn-table" title="設定框線">
                               <svg viewBox="0 0 24 24"><path d="M7 21H5V9h2v12zM9 13v2h2v-2H9zM9 17v2h2v-2H9zM9 9v2h2V9H9zM13 21h-2V9h2v12zM15 9h2v2h-2V9zM15 13h2v2h-2v-2zM15 17h2v2h-2v-2zM19 21h-2V9h2v12zM3 7V5h18v2H3zM3 21v-2h18v2H3z"/></svg>
                            </button>
                            <div class="dropdown-content" id="border-options">
                                <a data-border="bottom">下框線</a><a data-border="top">上框線</a>
                                <a data-border="left">左框線</a><a data-border="right">右框線</a>
                                <a data-border="none">無框線</a><a data-border="all">所有框線</a>
                                <a data-border="outside">外框線</a><a data-border="inside">內框線</a>
                            </div>
                        </div>
                    </div>
                     <div class="separator"></div>
                     <div class="control-group">
                        <label for="row-height-input">列高:</label>
                        <input type="number" id="row-height-input" min="1" title="列高度 (px)">
                        <label for="col-width-input" style="margin-left: 8px;">欄寬:</label>
                        <input type="number" id="col-width-input" min="1" title="欄寬度 (px)">
                    </div>
                </div>
            </div>
      </div>

      <main class="main-content">
          <div id="editor-container">
              <div id="content-display" contenteditable="true"><p><br></p></div>
          </div>
      </main>
      
      <div class="help-section">
          <h2>功能與操作說明</h2>
          <div class="help-cards-container">
              <div class="help-card">
                  <h3><span class="keyword">檔案</span></h3>
                  <ul>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#9AA0A6" d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/><path fill="#FFFFFF" d="M19.5 6h-2.5V4.5C17 3.12 15.88 2 14.5 2h-5C8.12 2 7 3.12 7 4.5V6H4.5C3.12 6 2 7.12 2 8.5v9C2 18.88 3.12 20 4.5 20h15c1.38 0 2.5-1.12 2.5-2.5v-9C22 7.12 20.88 6 19.5 6zM9 4.5C9 4.22 9.22 4 9.5 4h5c.28 0 .5.22 .5 .5V6H9V4.5z"/></svg><div><span class="keyword">匯入檔案</span>：點擊以選擇並載入電腦中的 <span class="keyword">.html</span> 或 <span class="keyword">.htm</span> 檔案，將其內容顯示於編輯區。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M6 2c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6H6z"/><path fill="#FFFFFF" d="m14 2 6 6h-6V2z"/><path fill="#FFFFFF" d="M13 14h-2v3H8v2h3v3h2v-3h3v-2h-3z"/></svg><div><span class="keyword">新增空白頁</span>：快速清空目前編輯區的所有內容，方便您從頭開始一份新文件。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><g><path fill="#188038" d="M14 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9l-6-6z"/><path fill="#FFFFFF" d="M13 4l6 6h-5a1 1 0 0 1-1-1V4z"/><path fill="#34A853" d="M18 10h-5a1 1 0 0 1-1-1V4l6 6z"/><path d="M12 19l-4-4h3v-4h2v4h3l-4 4z" fill="#FFFFFF"/></g></svg><div><span class="keyword">儲存 / 匯出</span>：點擊後可選擇 <span class="keyword">儲存為 HTML</span> 檔案，或透過 <span class="keyword">另存 PDF / 列印</span> 功能將目前內容匯出為 PDF 或進行列印。</div></li>
                  </ul>
              </div>
              <div class="help-card">
                  <h3><span class="keyword">編輯</span></h3>
                  <ul>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.38 11.23 17.28 8 12.5 8z" fill="#4285F4"/></svg><div><span class="keyword">復原 (Undo)</span>：撤銷上一步的操作。程式會記錄您最近的30個步驟。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#F4B400" d="M6 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path fill="#757575" d="M9.64 7.64 15 11l-5.36 3.36.72.72 6.64-6.65c.23-.5.36-1.05.36-1.64a4 4 0 0 0-4-4 4 4 0 0 0-3.64 5.64zm-1.05 6.43-5.95-5.95A3.97 3.97 0 0 0 2 6a4 4 0 0 0 4 4c.59 0 1.14-.13 1.64-.36l6.65 6.65-.72-.72zM9 22h6v-7.71l-3-2-3 2V22z"/></svg><div><span class="keyword">剪下 (Cut)</span>：將選取的文字或物件從文件中移除，並複製到剪貼簿。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#757575" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1z"/><path fill="#4285F4" d="M19 5H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg><div><span class="keyword">複製 (Copy)</span>：複製選取的文字或物件到剪貼簿。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#757575" d="M19 2h-4.18C14.4.84 13.3 0 12 0S9.6.84 9.18 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/><path fill="#4285F4" d="M19 20H5V4h2v3h10V4h2v16z"/></svg><div><span class="keyword">貼上 (Paste)</span>：將剪貼簿中的內容貼到游標目前所在的位置。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#FBBC04" d="m14.06 9.02l4.95 4.95-4.95 4.95L12.64 17.5l2.12-2.12-8.3-8.3-2.12 2.12L3 10.47l4.95-4.95z"/><path fill="#4285F4" d="m11.5 6.5l-6 6l-1.41-1.41l6-6zM17.5 12.5l-6 6l-1.41-1.41l6-6z"/><path fill="#EA4335" d="M20.49 19.07L13 11.58l1.41-1.41l7.08 7.07z"/></svg><div><span class="keyword">搜尋與取代</span>：在輸入框中輸入文字，可進行 <span class="keyword">搜尋</span> 並以黃色標記所有符合項目，或進行 <span class="keyword">全部取代</span>。</div></li>
                  </ul>
              </div>
              <div class="help-card">
                  <h3><span class="keyword">插入</span></h3>
                  <ul>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#f4b400" d="M5 10h14v3H5z"/><path fill="#4285f4" d="M5 15h4v3H5z"/><path fill="#0f9d58" d="M11 15h8v3h-8z"/><path fill="#db4437" d="M5 6h14v3H5z"/><path d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm0 1v1h14V5H5z" fill-opacity=".2"/></svg><div><span class="keyword">插入表格</span>：點擊後會提示您輸入所需的 <span class="keyword">列數</span> 與 <span class="keyword">欄數</span>，以快速建立表格。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" fill="#4285F4"/><circle cx="12" cy="12" r="5" fill="#FFFFFF"/></svg><div><span class="keyword">插入圖案</span>：可選擇插入 <span class="keyword">矩形</span> 或 <span class="keyword">圓形</span>。插入後可拖曳右下角控制點來調整大小。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#db4437" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2z"/><path fill="#f4b400" d="m8.5 13.5 2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/><circle cx="8" cy="8" r="2" fill="#4285f4"/></svg><div><span class="keyword">插入圖片</span>：從您的電腦選擇一張圖片插入。支援 HEIC 格式自動轉檔。插入後可拖曳右下角控制點來調整大小。</div></li>
                  </ul>
              </div>
              <div class="help-card">
                  <h3><span class="keyword">表格工具</span></h3>
                  <ul>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H4v-4h16v4zm-6-5.5h-2v-3h2v3zm3 0h-2v-3h2v3zm3 0h-2v-3h2v3z"/><path fill="#FBBC04" d="M11 2v3h2V2zm0 18H3v1c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-1h-11z"/></svg><div><span class="keyword">新增/刪除 列/欄</span>：選取任一儲存格後，可 <span class="keyword">在其下方新增一列</span> 或 <span class="keyword">右方新增一欄</span>。也可 <span class="keyword">刪除選取儲存格所在的整列或整欄</span>。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path d="M3 3v18h18V3H3zm8 16H5v-6h6v6zm0-8H5V5h6v6zm8 8h-6v-6h6v6zm0-8h-6V5h6v6z" fill="#4285F4"/><path d="M13 11V3h-2v8H3v2h8v8h2v-8h8v-2h-8z" fill="#FFFFFF"/></svg><div><span class="keyword">合併/拆分 儲存格</span>：選取多個相鄰儲存格後可進行 <span class="keyword">合併</span>。選取一個已合併的儲存格後可進行 <span class="keyword">拆分</span>，還原其原始結構。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><g><path fill="#34A853" d="M3 3h18v2H3zM3 7h12v2H3zM3 11h18v2H3zM3 15h12v2H3zM3 19h18v2H3z"/></g></svg><div><span class="keyword">對齊</span>：對選取的儲存格內容進行 <span class="keyword">水平</span> (左、中、右) 或 <span class="keyword">垂直</span> (上、中、下) 對齊。</div></li>
                      <li><svg class="help-icon" viewBox="0 0 24 24"><path d="M7 21H5V9h2v12zM9 13v2h2v-2H9zM9 17v2h2v-2H9zM9 9v2h2V9H9zM13 21h-2V9h2v12zM15 9h2v2h-2V9zM15 13h2v2h-2v-2zM15 17h2v2h-2v-2zM19 21h-2V9h2v12zM3 7V5h18v2H3zM3 21v-2h18v2H3z" fill="#A142F4"/></svg><div><span class="keyword">框線設定</span>：可針對選取的儲存格設定特定邊框。</div></li>
                  </ul>
              </div>
          </div>
      </div>
  </div>

  <div id="notification"></div>
  <div id="print-content" style="display: none;"></div>
  <input type="file" id="image-upload-input" accept="image/*" style="display: none;">

  <script>
    window.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const getEl = (id) => document.getElementById(id);
            const fileInput = getEl('file-input'), selectFileBtn = getEl('select-file-btn');
            const newPageBtn = getEl('new-page-btn');
            const contentDisplay = getEl('content-display');
            const searchInput = getEl('search-input'), searchBtn = getEl('search-btn');
            const replaceInput = getEl('replace-input'), replaceBtn = getEl('replace-btn');
            const zoomInBtn = getEl('zoom-in-btn'), zoomOutBtn = getEl('zoom-out-btn'), zoomResetBtn = getEl('zoom-reset-btn');
            const exportBtn = getEl('export-btn'), exportOptions = getEl('export-options');
            const exportHtmlLink = getEl('export-html-link'), exportPdfLink = getEl('export-pdf-link');
            const notification = getEl('notification');
            const undoBtn = getEl('undo-btn');
            const cutBtn = getEl('cut-btn'), copyBtn = getEl('copy-btn'), pasteBtn = getEl('paste-btn');
            const alignLeftBtn = getEl('align-left-btn'), alignCenterBtn = getEl('align-center-btn'), alignRightBtn = getEl('align-right-btn');
            const alignTopBtn = getEl('align-top-btn'), alignMiddleBtn = getEl('align-middle-btn'), alignBottomBtn = getEl('align-bottom-btn');
            const addRowBtn = getEl('add-row-btn'), addColBtn = getEl('add-col-btn');
            const deleteRowBtn = getEl('delete-row-btn'), deleteColBtn = getEl('delete-col-btn');
            const mergeCellsBtn = getEl('merge-cells-btn'), splitCellBtn = getEl('split-cell-btn');
            const themeToggle = getEl('theme-toggle'), themeIconSun = getEl('theme-icon-sun'), themeIconMoon = getEl('theme-icon-moon');
            const boldBtn = getEl('bold-btn');
            const underlineBtn = getEl('underline-btn');
            const fontSizeInput = getEl('font-size-input');
            const decreaseFontSizeBtn = getEl('decrease-font-size-btn');
            const increaseFontSizeBtn = getEl('increase-font-size-btn');
            const fontColorInput = getEl('font-color-input');
            const textBgColorInput = getEl('text-bg-color-input');
            const bgColorInput = getEl('bg-color-input');
            const borderColorInput = getEl('border-color-input');
            const borderWidthInput = getEl('border-width-input');
            const borderDropdownBtn = getEl('border-dropdown-btn');
            const borderOptions = getEl('border-options');
            const insertImageBtn = getEl('insert-image-btn');
            const insertTableBtn = getEl('insert-table-btn');
            const insertShapeBtn = getEl('insert-shape-btn');
            const shapeOptions = getEl('shape-options');
            const insertLinkBtn = getEl('insert-link-btn');
            const imageUploadInput = getEl('image-upload-input');
            const rowHeightInput = getEl('row-height-input'), colWidthInput = getEl('col-width-input');
            const currentFilename = getEl('current-filename');
            
            // --- State Variables ---
            let currentZoom = 1.0, notificationTimer;
            let historyStack = [], HISTORY_MAX_SIZE = 30;
            let selectedCells = [], isSelecting = false, startCell = null, endCell = null, dragStart = false;
            let resizing = null;
            let objectResizing = null;
            let objectDragging = null;
            let originalFilename = 'untitled';
            let currentSelectionRange = null;
            const mainTitle = getEl('main-title'); 
            let activeEditingTarget = null;
            
            // --- Core Functions ---
            function showNotification(message) {
                clearTimeout(notificationTimer);
                notification.textContent = message;
                notification.classList.add('show');
                notificationTimer = setTimeout(() => notification.classList.remove('show'), 3000);
            }
            
            function saveState() {
                if (resizing || objectResizing || objectDragging) return;
                const currentState = contentDisplay.innerHTML;
                if (historyStack.length === 0 || historyStack[historyStack.length - 1] !== currentState) {
                    historyStack.push(currentState);
                    if (historyStack.length > HISTORY_MAX_SIZE) historyStack.shift();
                }
                undoBtn.disabled = historyStack.length <= 1;
            }

            function undoState() {
                if (historyStack.length > 1) {
                    historyStack.pop();
                    contentDisplay.innerHTML = historyStack[historyStack.length - 1];
                    clearSelection();
                }
                undoBtn.disabled = historyStack.length <= 1;
            }
            
            function clearTitleSelection() {
                if (activeEditingTarget) {
                    mainTitle.classList.remove('editing-target');
                    activeEditingTarget = null;
                }
            }
            
            function colorToHex(colorStr) {
                if (!colorStr) return '#FFFFFF';
                const temp = document.createElement("div");
                temp.style.color = colorStr;
                document.body.appendChild(temp);
                const computedColor = window.getComputedStyle(temp).color;
                document.body.removeChild(temp);
                
                const match = computedColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (match) {
                    try {
                        return "#" + ((1 << 24) + (parseInt(match[1]) << 16) + (parseInt(match[2]) << 8) + parseInt(match[3])).toString(16).slice(1).toUpperCase();
                    } catch (e) {
                        return '#000000';
                    }
                }
                return '#FFFFFF';
            }
            
            function getEffectiveBackgroundColor(element) {
                let el = element;
                while (el && el !== document.body) {
                    const style = window.getComputedStyle(el);
                    const color = style.backgroundColor;
                    if (color && color !== 'transparent' && color !== 'rgba(0, 0, 0, 0)') {
                        return color;
                    }
                    if (el === contentDisplay) break; 
                    el = el.parentElement;
                }
                const editorStyle = window.getComputedStyle(contentDisplay);
                if (editorStyle.backgroundColor !== 'transparent' && editorStyle.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                    return editorStyle.backgroundColor;
                }
                return window.getComputedStyle(getEl('editor-container')).backgroundColor;
            }


            function updateToolbarForSelection() {
                if (selectedCells.length > 0) {
                    const primaryCell = selectedCells[0];
                    const primaryStyle = window.getComputedStyle(primaryCell);
                    fontSizeInput.value = parseInt(primaryStyle.fontSize) || 14;
                    const primaryBgColor = colorToHex(getEffectiveBackgroundColor(primaryCell));
                    bgColorInput.value = primaryBgColor;
                    const primaryFontColor = colorToHex(primaryStyle.color);
                    fontColorInput.value = primaryFontColor;
                    const rect = primaryCell.getBoundingClientRect();
                    rowHeightInput.value = Math.round(rect.height / currentZoom);
                    colWidthInput.value = Math.round(rect.width / currentZoom);
                    bgColorInput.classList.toggle('mixed', selectedCells.some(c => colorToHex(getEffectiveBackgroundColor(c)) !== primaryBgColor));
                    fontColorInput.classList.toggle('mixed', selectedCells.some(c => colorToHex(window.getComputedStyle(c).color) !== primaryFontColor));
                } else {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                         const range = selection.getRangeAt(0);
                         let el = range.startContainer;
                         el = el.nodeType === Node.TEXT_NODE ? el.parentElement : el;

                         let size = window.getComputedStyle(el).fontSize;
                         let color = window.getComputedStyle(el).color;
                         
                         let parent = el;
                         while(parent && parent !== contentDisplay) {
                             size = window.getComputedStyle(parent).fontSize;
                             color = window.getComputedStyle(parent).color;
                             if(size !== "16px") break;
                             parent = parent.parentElement;
                         }

                         fontSizeInput.value = parseInt(size) || 14;
                         fontColorInput.value = colorToHex(color);
                    }
                }
            }


            function clearHighlight() {
                contentDisplay.querySelectorAll('mark.highlight').forEach(mark => {
                    const parent = mark.parentNode;
                    parent.replaceChild(document.createTextNode(mark.textContent), mark);
                    parent.normalize();
                });
            }
            
            function updateZoom() { contentDisplay.style.transform = `scale(${currentZoom})`; }
            
            function applyToSelectedCells(callback, shouldSaveState = true) {
                if (selectedCells.length === 0) {
                    showNotification('請先選擇一個或多個儲存格。');
                    return;
                }
                selectedCells.forEach(cell => callback(cell));
                if (shouldSaveState) saveState();
            }

            function clearSelection() {
                contentDisplay.querySelectorAll('.selected-cell').forEach(cell => {
                    cell.classList.remove('selected-cell');
                });
                selectedCells = [];
            }

            function selectCells(start, end, table) {
                clearSelection();
                const rows = Array.from(table.rows);
                const startCoords = { r: start.parentElement.rowIndex, c: start.cellIndex };
                const endCoords = { r: end.parentElement.rowIndex, c: end.cellIndex };

                const r1 = Math.min(startCoords.r, endCoords.r);
                const r2 = Math.max(startCoords.r, endCoords.r);
                const c1 = Math.min(startCoords.c, endCoords.c);
                const c2 = Math.max(startCoords.c, endCoords.c);

                for (let i = r1; i <= r2; i++) {
                    for (let j = c1; j <= c2; j++) {
                        const cell = rows[i]?.cells[j];
                        if (cell) {
                            cell.classList.add('selected-cell');
                            selectedCells.push(cell);
                        }
                    }
                }
            }
            
            async function execCmd(command, value = null) {
                contentDisplay.focus(); 
                document.execCommand(command, false, value);
                saveState();
            }
            
            // --- Event Listeners ---
            
            mainTitle.addEventListener('click', (e) => {
                e.stopPropagation(); 
                clearSelection(); 
                mainTitle.classList.add('editing-target');
                activeEditingTarget = mainTitle; 

                const titleStyle = window.getComputedStyle(mainTitle);
                fontSizeInput.value = parseInt(titleStyle.fontSize);
                fontColorInput.value = colorToHex(titleStyle.color);
            });

            selectFileBtn.addEventListener('click', () => fileInput.click());
            
            newPageBtn.addEventListener('click', () => {
                contentDisplay.innerHTML = '<p><br></p>';
                originalFilename = 'untitled';
                currentFilename.textContent = '';
                historyStack = [];
                saveState();
                showNotification('已新增空白頁');
            });

            function processImages() {
                const allImgs = contentDisplay.querySelectorAll('img:not(.resizable-image-container img)');
                allImgs.forEach(img => {
                    const parent = img.closest('td, th') || img.parentElement;
                    const isTableCell = !!img.closest('td, th');
                    const currentH = parent.offsetHeight || 250; 
                    const container = document.createElement('div');
                    container.className = isTableCell ? 'resizable-image-container image-in-cell' : 'resizable-image-container';
                    container.style.width = '100%';
                    container.style.height = `${currentH}px`;
                    img.parentNode.insertBefore(container, img);
                    container.appendChild(img);
                    const handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    container.appendChild(handle);
                });
            }

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                originalFilename = file.name.replace(/\.[^/.]+$/, ""); 
                currentFilename.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const doc = new DOMParser().parseFromString(e.target.result, 'text/html');
                    if (doc.body && doc.body.innerHTML.trim()) {
                        const styleContent = doc.querySelector('style') ? doc.querySelector('style').innerHTML : '';
                        contentDisplay.innerHTML = styleContent ? `<style>${styleContent}</style>${doc.body.innerHTML}` : doc.body.innerHTML;
                        contentDisplay.style.minHeight = 'auto';
                        contentDisplay.style.boxShadow = 'none';
                        processImages();
                        showNotification('檔案匯入成功！');
                        const table = contentDisplay.querySelector('table');
                        if (table) {
                            const firstCell = table.querySelector('td, th');
                            if (firstCell) {
                                const computedStyle = window.getComputedStyle(firstCell);
                                borderColorInput.value = colorToHex(computedStyle.borderColor);
                                borderWidthInput.value = parseInt(computedStyle.borderWidth) || 1;
                            }
                        }
                    } else {
                        contentDisplay.innerHTML = '<p style="color: red;">錯誤：檔案中找不到可編輯的內容。</p>';
                    }
                    historyStack = [];
                    saveState();
                };
                reader.readAsText(file);
                fileInput.value = '';
            });
            
            searchBtn.addEventListener('click', () => {
                clearHighlight();
                const searchTerm = searchInput.value;
                if (!searchTerm) return;
                const regex = new RegExp(searchTerm, 'gi');
                const walker = document.createTreeWalker(contentDisplay, NodeFilter.SHOW_TEXT, null, false);
                let nodes = [];
                while(walker.nextNode()) nodes.push(walker.currentNode);
                
                let count = 0;
                nodes.forEach(node => {
                     if (node.nodeValue.match(regex)) {
                        const parent = node.parentNode;
                        if (parent.nodeName === 'MARK') return;
                        const newHTML = node.nodeValue.replace(regex, match => {
                            count++;
                            return `<mark class="highlight">${match}</mark>`;
                        });
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = newHTML;
                        while(tempDiv.firstChild) {
                            parent.insertBefore(tempDiv.firstChild, node);
                        }
                        parent.removeChild(node);
                    }
                });
                showNotification(`找到 ${count} 個符合的項目。`);
            });

            replaceBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value;
                const replaceTerm = replaceInput.value;
                if (!searchTerm) {
                    showNotification('請先輸入要搜尋的文字。');
                    return;
                }
                let count = 0;
                const regex = new RegExp(searchTerm, 'gi');
                const walker = document.createTreeWalker(contentDisplay, NodeFilter.SHOW_TEXT, null, false);
                let nodesToReplace = [];
                while(walker.nextNode()) nodesToReplace.push(walker.currentNode);
                
                nodesToReplace.forEach(node => {
                    const matches = node.nodeValue.match(regex);
                    if(matches) {
                        count += matches.length;
                        node.nodeValue = node.nodeValue.replace(regex, replaceTerm);
                    }
                });
                
                if (count > 0) {
                    saveState();
                    showNotification(`已取代 ${count} 個項目。`);
                } else {
                    showNotification('找不到符合取代的項目。');
                }
            });

            function saveAsHtml() {
                clearSelection();
                clearHighlight();
                const contentHTML = contentDisplay.innerHTML;
                const filename = `${originalFilename || 'document'}.html`;
                const fullHTML = `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${filename}</title><style>body{font-family:sans-serif}table{border-collapse:collapse;width:100%;table-layout:fixed}td,th{border:1px solid #ddd;padding:8px;overflow:hidden;word-break:break-all}</style></head><body>${contentHTML}</body></html>`;
                const blob = new Blob([fullHTML], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                showNotification('HTML 檔案已儲存。');
            }

            function saveAsPdf() {
                const printContent = getEl('print-content');
                if (!printContent) return;
                
                const contentClone = contentDisplay.cloneNode(true);
                
                contentClone.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                contentClone.querySelectorAll('.selected-cell').forEach(cell => cell.classList.remove('selected-cell'));
                
                printContent.innerHTML = '';
                printContent.appendChild(contentClone);
                
                window.print();
            }
            
            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportBtn.parentElement.classList.toggle('show');
            });
            exportHtmlLink.addEventListener('click', () => {
                saveAsHtml();
                exportBtn.parentElement.classList.remove('show');
            });
            exportPdfLink.addEventListener('click', () => {
                saveAsPdf();
                exportBtn.parentElement.classList.remove('show');
            });

            zoomInBtn.addEventListener('click', () => { currentZoom = Math.min(2.0, currentZoom + 0.1); updateZoom(); });
            zoomOutBtn.addEventListener('click', () => { currentZoom = Math.max(0.2, currentZoom - 0.1); updateZoom(); });
            zoomResetBtn.addEventListener('click', () => { currentZoom = 1.0; updateZoom(); });
            
            const preventFocusSteal = (e) => e.preventDefault();
            const commandButtons = [cutBtn, copyBtn, pasteBtn, undoBtn, boldBtn, underlineBtn, alignLeftBtn, alignCenterBtn, alignRightBtn, alignTopBtn, alignMiddleBtn, alignBottomBtn];
            commandButtons.forEach(btn => btn.addEventListener('mousedown', preventFocusSteal));

            undoBtn.addEventListener('click', undoState);
            cutBtn.addEventListener('click', () => execCmd('cut'));
            copyBtn.addEventListener('click', () => execCmd('copy'));
            pasteBtn.addEventListener('click', () => execCmd('paste'));
            boldBtn.addEventListener('click', () => execCmd('bold'));
            underlineBtn.addEventListener('click', () => execCmd('underline'));


            document.addEventListener('keydown', (e) => { 
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); if (!undoBtn.disabled) undoState(); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); execCmd('bold'); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'u') { e.preventDefault(); execCmd('underline'); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') { 
                    e.preventDefault(); 
                    insertLinkBtn.click();
                }
            });

            function onMouseMove(e) {
                if (!resizing) return;
                if (resizing.type === 'col') {
                    const newW = resizing.startW + (e.clientX - resizing.startX);
                    if (newW > 40) resizing.target.style.width = newW + 'px';
                } else {
                    const newH = resizing.startH + (e.clientY - resizing.startY);
                    if (newH > 30) resizing.target.style.height = newH + 'px';
                }
            }
            function onMouseUpResize() {
                if (resizing) saveState();
                resizing = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUpResize);
            }

            function onObjectResizeMove(e) {
                if (!objectResizing) return;
                e.preventDefault();
                const dx = e.clientX - objectResizing.startX;
                const dy = e.clientY - objectResizing.startY;
                let newW = objectResizing.startW + dx;
                let newH = objectResizing.startH + dy;
                if (newW < 20) newW = 20;
                if (newH < 20) newH = 20;
                objectResizing.container.style.width = newW + 'px';
                objectResizing.container.style.height = newH + 'px';
            }
            function onObjectResizeUp() {
                if (objectResizing) saveState();
                document.removeEventListener('mousemove', onObjectResizeMove);
                document.removeEventListener('mouseup', onObjectResizeUp);
                objectResizing = null;
            }

            contentDisplay.addEventListener('mousemove', (e) => {
                if (resizing || objectResizing) return;
                const cell = e.target.closest('td, th');
                if (cell) {
                    const rect = cell.getBoundingClientRect();
                    const atRightEdge = Math.abs(e.clientX - rect.right) < 5;
                    const atBottomEdge = Math.abs(e.clientY - rect.bottom) < 5;
                    if (atRightEdge) cell.style.cursor = 'col-resize';
                    else if (atBottomEdge) cell.style.cursor = 'row-resize';
                    else cell.style.cursor = 'text';
                }
                if (!dragStart) return;
                if (!isSelecting) isSelecting = true;
                
                const currentCell = e.target.closest('td, th');
                const table = contentDisplay.querySelector('table');
                if (currentCell && table?.contains(currentCell) && currentCell !== endCell) {
                    endCell = currentCell;
                    clearTitleSelection();
                    selectCells(startCell, endCell, table);
                }
            });

            contentDisplay.addEventListener('mousedown', (e) => {
                const target = e.target;
                if (target.classList.contains('resize-handle')) {
                    e.preventDefault(); e.stopPropagation();
                    const container = target.closest('.resizable-image-container, .shape-container');
                    objectResizing = {
                        container: container, startX: e.clientX, startY: e.clientY,
                        startW: container.offsetWidth, startH: container.offsetHeight
                    };
                    document.addEventListener('mousemove', onObjectResizeMove);
                    document.addEventListener('mouseup', onObjectResizeUp);
                    return;
                }
                
                const cell = target.closest('td, th');
                if (!cell) return;
                 if (resizing) e.preventDefault();

                if (cell.style.cursor === 'col-resize') {
                    resizing = { type: 'col', target: cell, startX: e.clientX, startW: cell.offsetWidth };
                } else if (cell.style.cursor === 'row-resize') {
                    resizing = { type: 'row', target: cell.parentElement, startY: e.clientY, startH: cell.parentElement.offsetHeight };
                }

                if (resizing) {
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUpResize);
                } else {
                    dragStart = true;
                    isSelecting = false;
                    startCell = cell;
                    endCell = cell;
                }
            });
            
            contentDisplay.addEventListener('focus', () => {
                 const selection = window.getSelection();
                 if(selection.rangeCount > 0) {
                    currentSelectionRange = selection.getRangeAt(0).cloneRange();
                 }
            });

            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const activeEl = document.activeElement;
                    if (activeEl === contentDisplay || contentDisplay.contains(activeEl)) {
                       currentSelectionRange = selection.getRangeAt(0).cloneRange();
                    }
                }
                updateToolbarForSelection();
            });


            contentDisplay.addEventListener('click', (e) => {
                if (isSelecting) return;
                const cell = e.target.closest('td, th');
                if (cell) {
                    clearTitleSelection();
                    clearSelection();
                    cell.classList.add('selected-cell');
                    selectedCells.push(cell);
                    updateToolbarForSelection();
                } else {
                    clearTitleSelection();
                    clearSelection();
                }
            });

            window.addEventListener('mouseup', () => {
                if (dragStart && isSelecting) {
                    updateToolbarForSelection();
                }
                dragStart = false;
                isSelecting = false;
            });
            
            function setStyle(prop, val) {
                if (selectedCells.length > 0) {
                    applyToSelectedCells(c => c.style[prop] = val);
                } else {
                    let command = '';
                    if (prop === 'textAlign') {
                        if (val === 'left') command = 'justifyLeft';
                        else if (val === 'center') command = 'justifyCenter';
                        else if (val === 'right') command = 'justifyRight';
                    } else if (prop === 'verticalAlign') {
                        showNotification('垂直對齊僅適用於表格儲存格。');
                        return;
                    }
                    if (command) execCmd(command);
                }
            }

            alignLeftBtn.addEventListener('click', () => setStyle('textAlign', 'left'));
            alignCenterBtn.addEventListener('click', () => setStyle('textAlign', 'center'));
            alignRightBtn.addEventListener('click', () => setStyle('textAlign', 'right'));
            alignTopBtn.addEventListener('click', () => setStyle('verticalAlign', 'top'));
            alignMiddleBtn.addEventListener('click', () => setStyle('verticalAlign', 'middle'));
            alignBottomBtn.addEventListener('click', () => setStyle('verticalAlign', 'bottom'));
            
            const addInputListener = (input, styleProp, unit = '') => {
                 input.addEventListener('mousedown', preventFocusSteal);
                 input.addEventListener('input', () => {
                    const value = input.value + unit;
                    const rawValue = input.value;

                    const restoreSelection = () => {
                        contentDisplay.focus();
                        if (currentSelectionRange) {
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(currentSelectionRange);
                        }
                    };

                    if (styleProp === 'color' || styleProp === 'backColor') {
                        restoreSelection();
                        const command = styleProp === 'color' ? 'foreColor' : 'backColor';
                        execCmd(command, rawValue);
                        return; 
                    }
                    
                    if (!rawValue && styleProp !== 'backgroundColor') return;

                    if (activeEditingTarget === mainTitle) {
                        mainTitle.style[styleProp] = value;
                    } else {
                        restoreSelection();
                        
                        // 【修改】修正此處條件
                        if (selectedCells.length > 0) {
                            input.classList.remove('mixed');
                            applyToSelectedCells(c => c.style[styleProp] = value, false);
                        } else {
                            const selection = window.getSelection();
                            if (!selection || selection.isCollapsed ) {
                               if(styleProp !== 'height' && styleProp !== 'width') {
                                    showNotification('請先選取文字以套用樣式。');
                               }
                               return;
                            }
                            
                             if (styleProp === 'fontSize') {
                                 document.execCommand("fontSize", false, "1");
                                 const fontElements = contentDisplay.getElementsByTagName("font");
                                 for (let i = 0; i < fontElements.length; i++) {
                                     if (fontElements[i].size === "1") {
                                         fontElements[i].removeAttribute("size");
                                         fontElements[i].style.fontSize = value;
                                     }
                                 }
                             } else if (styleProp === 'backgroundColor') {
                                execCmd('backColor', rawValue);
                             }
                        }
                        clearTimeout(input.timer);
                        input.timer = setTimeout(saveState, 500);
                    }
                });
            };
            
            addInputListener(fontSizeInput, 'fontSize', 'px');
            addInputListener(fontColorInput, 'color');
            addInputListener(textBgColorInput, 'backColor');
            addInputListener(bgColorInput, 'backgroundColor');
            addInputListener(rowHeightInput, 'height', 'px');
            addInputListener(colWidthInput, 'width', 'px');
            
            function changeFontSize(amount) {
                let currentSize = parseInt(fontSizeInput.value);
                if (isNaN(currentSize)) currentSize = 14;
                const newSize = Math.max(8, Math.min(72, currentSize + amount));
                fontSizeInput.value = newSize;
                fontSizeInput.dispatchEvent(new Event('input'));
            }

            decreaseFontSizeBtn.addEventListener('mousedown', preventFocusSteal);
            increaseFontSizeBtn.addEventListener('mousedown', preventFocusSteal);
            decreaseFontSizeBtn.addEventListener('click', () => changeFontSize(-1));
            increaseFontSizeBtn.addEventListener('click', () => changeFontSize(1));


            borderDropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); borderDropdownBtn.parentElement.classList.toggle('show'); });
            borderOptions.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (!target) return;
                const borderType = target.dataset.border;
                if (selectedCells.length === 0) { showNotification('請先選擇儲存格'); return; }
                const width = borderWidthInput.value, color = borderColorInput.value, borderStyle = `${width}px solid ${color}`;
                const bounds = { minR: Infinity, maxR: -1, minC: Infinity, maxC: -1 };
                selectedCells.forEach(cell => {
                    bounds.minR = Math.min(bounds.minR, cell.parentElement.rowIndex);
                    bounds.maxR = Math.max(bounds.maxR, cell.parentElement.rowIndex);
                    bounds.minC = Math.min(bounds.minC, cell.cellIndex);
                    bounds.maxC = Math.max(bounds.maxC, cell.cellIndex);
                });
                applyToSelectedCells(cell => {
                    switch (borderType) {
                        case 'bottom': cell.style.borderBottom = borderStyle; break;
                        case 'top': cell.style.borderTop = borderStyle; break;
                        case 'left': cell.style.borderLeft = borderStyle; break;
                        case 'right': cell.style.borderRight = borderStyle; break;
                        case 'none': cell.style.border = 'none'; break;
                        case 'all': cell.style.border = borderStyle; break;
                        case 'outside':
                            if (cell.parentElement.rowIndex === bounds.minR) cell.style.borderTop = borderStyle;
                            if (cell.parentElement.rowIndex === bounds.maxR) cell.style.borderBottom = borderStyle;
                            if (cell.cellIndex === bounds.minC) cell.style.borderLeft = borderStyle;
                            if (cell.cellIndex === bounds.maxC) cell.style.borderRight = borderStyle;
                            break;
                         case 'inside':
                            if (cell.parentElement.rowIndex < bounds.maxR) cell.style.borderBottom = borderStyle;
                            if (cell.cellIndex < bounds.maxC) cell.style.borderRight = borderStyle;
                            break;
                    }
                }, false);
                saveState();
                borderDropdownBtn.parentElement.classList.remove('show');
            });
            
            function applyTableWideBorder() {
                const table = contentDisplay.querySelector('table');
                if (!table) return;
                const color = borderColorInput.value;
                const width = borderWidthInput.value + 'px';
                table.querySelectorAll('td, th').forEach(cell => {
                    cell.style.borderColor = color; cell.style.borderWidth = width;
                });
                saveState();
            }
            borderColorInput.addEventListener('input', applyTableWideBorder);
            borderWidthInput.addEventListener('input', applyTableWideBorder);

            addRowBtn.addEventListener('click', () => { 
                if(selectedCells.length === 0) { showNotification('請先選擇儲存格以確定新增位置'); return; }
                const currentRow = selectedCells[selectedCells.length - 1].parentElement;
                const table = currentRow.closest('table');
                if (!table || !currentRow) return;
                const colCount = table.rows[0].cells.length;
                const newRow = table.insertRow(currentRow.rowIndex + 1);
                for (let i = 0; i < colCount; i++) newRow.insertCell(i).innerHTML = '&nbsp;';
                saveState(); 
            });

            addColBtn.addEventListener('click', () => {
                if (selectedCells.length === 0) { showNotification('請先選擇儲存格以確定新增位置'); return; }
                const table = selectedCells[0].closest('table');
                const colIndex = selectedCells[selectedCells.length - 1].cellIndex;
                for (const row of table.rows) row.insertCell(colIndex + 1).innerHTML = '&nbsp;';
                saveState();
            });

            deleteRowBtn.addEventListener('click', () => {
                if (selectedCells.length === 0) { showNotification('請選擇要刪除的列'); return; }
                const rowsToDelete = [...new Set(selectedCells.map(cell => cell.parentElement))];
                if (rowsToDelete[0].closest('table').rows.length <= rowsToDelete.length) { showNotification('無法刪除所有列'); return; }
                rowsToDelete.forEach(row => row.remove());
                clearSelection();
                saveState();
            });

            deleteColBtn.addEventListener('click', () => {
                if (selectedCells.length === 0) { showNotification('請選擇要刪除的欄'); return; }
                const table = selectedCells[0].closest('table');
                if (table.rows[0].cells.length <= 1) { showNotification('無法刪除最後一欄'); return; }
                const colsToDelete = [...new Set(selectedCells.map(cell => cell.cellIndex))].sort((a, b) => b - a);
                colsToDelete.forEach(colIndex => { for (const row of table.rows) row.deleteCell(colIndex); });
                clearSelection();
                saveState();
            });
            
            mergeCellsBtn.addEventListener('click', () => {
                if (selectedCells.length < 2) { showNotification('請選擇至少兩個儲存格來合併'); return; }
                let minRow = Infinity, maxRow = -1, minCol = Infinity, maxCol = -1, content = '';
                selectedCells.forEach(cell => {
                    content += cell.innerHTML + ' ';
                    minRow = Math.min(minRow, cell.parentElement.rowIndex); maxRow = Math.max(maxRow, cell.parentElement.rowIndex);
                    minCol = Math.min(minCol, cell.cellIndex); maxCol = Math.max(maxCol, cell.cellIndex);
                });
                const firstCell = selectedCells.sort((a, b) => a.parentElement.rowIndex - b.parentElement.rowIndex || a.cellIndex - b.cellIndex)[0];
                firstCell.colSpan = maxCol - minCol + 1; firstCell.rowSpan = maxRow - minRow + 1;
                firstCell.innerHTML = content.trim();
                selectedCells.slice(1).forEach(cell => cell.remove());
                saveState(); clearSelection();
                firstCell.classList.add('selected-cell'); selectedCells.push(firstCell);
            });

            splitCellBtn.addEventListener('click', () => {
                if (selectedCells.length !== 1) { showNotification('請選擇一個要拆分的儲存格'); return; }
                const cell = selectedCells[0], rowSpan = cell.rowSpan || 1, colSpan = cell.colSpan || 1;
                if (rowSpan === 1 && colSpan === 1) { showNotification('此儲存格未被合併'); return; }
                const table = cell.closest('table'), parentRow = cell.parentElement;
                const rowIndex = parentRow.rowIndex, cellIndex = cell.cellIndex;
                cell.removeAttribute('rowspan'); cell.removeAttribute('colspan');
                for (let r = 0; r < rowSpan; r++) {
                    for (let c = 0; c < colSpan; c++) {
                        if (r === 0 && c === 0) continue; 
                        table.rows[rowIndex + r].insertCell(cellIndex + c).innerHTML = '&nbsp;';
                    }
                }
                saveState();
            });
            
            insertImageBtn.addEventListener('click', () => imageUploadInput.click());
            imageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const isHeic = /\.heic(f)?$/i.test(file.name);
                const processImage = (imageBlob) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        let isTableCell = false;
                        if (currentSelectionRange) {
                            let node = currentSelectionRange.startContainer;
                            if (node.nodeType === Node.TEXT_NODE) {
                                node = node.parentNode;
                            }
                            if (node.closest('td, th')) {
                                isTableCell = true;
                            }
                        }

                        const containerClass = isTableCell 
                            ? "resizable-image-container image-in-cell" 
                            : "resizable-image-container";
                        
                        const style = isTableCell 
                            ? '' 
                            : 'width: 150px; height: auto;';

                        const imgHTML = `<div class="${containerClass}" contenteditable="false" style="${style}">` + `<img src="${ev.target.result}" alt="">` + `<div class="resize-handle"></div>` + `</div>`;
                        execCmd('insertHTML', imgHTML);
                    };
                    reader.readAsDataURL(imageBlob);
                };
                if (isHeic) {
                    showNotification('正在轉換 HEIC 檔案...');
                    heic2any({ blob: file, toType: "image/jpeg", quality: 0.8, })
                    .then(res => { processImage(res); showNotification('HEIC 轉換成功！'); })
                    .catch(err => { console.error(err); showNotification('HEIC 轉換失敗。'); });
                } else { processImage(file); }
                imageUploadInput.value = '';
            });

            insertLinkBtn.addEventListener('click', () => {
                const selection = window.getSelection();
                if (!selection || selection.isCollapsed) {
                    showNotification('請先選取要加上連結的文字。');
                    return;
                }
                
                const savedRange = selection.getRangeAt(0).cloneRange();
                let url = prompt("請輸入網址:", "https://");

                if (url && url.trim() !== "" && url !== "https://") {
                    selection.removeAllRanges();
                    selection.addRange(savedRange);
                    document.execCommand('createLink', false, url);
                    
                    let parentElement = selection.getRangeAt(0).commonAncestorContainer;
                    if (parentElement.nodeType === Node.TEXT_NODE) {
                        parentElement = parentElement.parentNode;
                    }
                    const linkElement = parentElement.closest('a');
                    if (linkElement) {
                        linkElement.target = '_blank';
                        linkElement.rel = 'noopener noreferrer';
                    }
                    
                    saveState();
                }
            });

            insertTableBtn.addEventListener('click', () => {
                let rows = prompt("請輸入列數:", "3");
                let cols = prompt("請輸入欄數:", "3");
                if (rows && cols && !isNaN(rows) && !isNaN(cols)) {
                    let tableHTML = '<table border="1" style="width:100%; border-collapse: collapse;"><tbody>';
                    for (let r = 0; r < parseInt(rows); r++) {
                        tableHTML += '<tr>';
                        for (let c = 0; c < parseInt(cols); c++) tableHTML += '<td>&nbsp;</td>';
                        tableHTML += '</tr>';
                    }
                    tableHTML += '</tbody></table>';
                    execCmd('insertHTML', tableHTML);
                }
            });

            insertShapeBtn.addEventListener('click', (e) => { e.stopPropagation(); insertShapeBtn.parentElement.classList.toggle('show'); });
            shapeOptions.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (!target) return;
                const shapeType = target.dataset.shape;
                let shapeHTML = '';
                if (shapeType === 'rect') {
                    shapeHTML = `<svg viewBox="0 0 100 100" preserveAspectRatio="none"><rect x="0" y="0" width="100" height="100" fill="lightblue" stroke="blue" stroke-width="2"/></svg>`;
                } else if (shapeType === 'circle') {
                    shapeHTML = `<svg viewBox="0 0 100 100" preserveAspectRatio="none"><circle cx="50" cy="50" r="50" fill="lightgreen" stroke="green" stroke-width="2"/></svg>`;
                }
                if (shapeHTML) {
                    const fullHTML = `<div class="shape-container" contenteditable="false" style="width: 100px; height: 100px;">${shapeHTML}<div class="resize-handle"></div></div>`;
                    execCmd('insertHTML', fullHTML);
                }
                insertShapeBtn.parentElement.classList.remove('show');
            });
            
            themeToggle.addEventListener('click', () => {
                const isDark = document.body.toggleAttribute('data-theme');
                if (isDark) {
                     document.body.setAttribute('data-theme', 'dark');
                     themeIconSun.style.display = 'none';
                     themeIconMoon.style.display = 'block';
                } else {
                     document.body.removeAttribute('data-theme');
                     themeIconSun.style.display = 'block';
                     themeIconMoon.style.display = 'none';
                }
            });
            
            window.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown.show').forEach(d => d.classList.remove('show'));
                }
            });
            
            // Initial State
            saveState();
        });
    </script>
</body>
</html>
