<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML表格編輯器</title>
    <style>
        :root {
            /* --- Light Theme --- */
            --system-font: -apple-system, "SF Pro", "Helvetica Neue", "Arial", sans-serif;
            --background-color: #f5f5f7;
            --window-background-color: rgba(255, 255, 255, 0.6);
            --panel-background-color: rgba(240, 240, 245, 0.7);
            --editor-background-color: #fff;
            --system-blue: #007aff;
            --system-green: #28a745;
            --system-red: #ff3b30;
            --system-gray: #8e8e93;
            --system-brown: #a2835b;
            --border-color: rgba(0, 0, 0, 0.1);
            --text-color: #1d1d1f;
            --text-color-secondary: #6e6e73;
            --table-header-bg: #f7f7f8;
            --window-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --blur-radius: 12px;
        }

        body[data-theme="dark"] {
            /* --- Dark Theme --- */
            --background-color: #1c1c1e;
            --window-background-color: rgba(44, 44, 46, 0.7);
            --panel-background-color: rgba(28, 28, 30, 0.8);
            --editor-background-color: #2c2c2e;
            --system-blue: #0a84ff;
            --system-green: #30d158;
            --system-red: #ff453a;
            --system-gray: #8e8e93;
            --system-brown: #ab8e68;
            --border-color: rgba(255, 255, 255, 0.15);
            --text-color: #f2f2f7;
            --text-color-secondary: #8d8d92;
            --table-header-bg: #3a3a3c;
        }

        /* --- 基本設定 --- */
        body {
            font-family: var(--system-font);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s, color 0.3s;
            box-sizing: border-box;
        }

        /* --- 主視窗容器 --- */
        .window-container {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--window-shadow);
            border: 1px solid var(--border-color);
            background: var(--window-background-color);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* --- 標題列 --- */
        .title-bar {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            text-align: center;
        }
        .title-bar-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
            min-height: 28px;
        }
        .window-controls { display: flex; align-items: center; gap: 8px; position: absolute; top: 10px; left: 12px; }
        .control-dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot-red { background-color: #ff5f56; }
        .dot-yellow { background-color: #ffbd2e; }
        .dot-green { background-color: #27c93f; }
        
        .title-content { margin: 0 auto; }
        .window-title { font-size: 20px; font-weight: 600; margin:0; }
        
        .window-subtitle { font-size: 13px; color: var(--text-color-secondary); margin: 2px 0 0; }
        .window-creator { font-size: 12px; color: var(--text-color-secondary); margin: 2px 0 0; }

        #current-filename {
            font-size: 13px;
            color: var(--text-color-secondary);
            margin-left: 8px;
        }

        #theme-toggle { background: transparent; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 10px; right: 12px; }
        #theme-toggle:hover { background-color: var(--border-color); }
        #theme-toggle svg { width: 24px; height: 24px; fill: var(--text-color-secondary); }

        /* --- 主要內容區域 --- */
        .main-content { padding: 16px; }
        
        /* --- 控制面板 --- */
        .controls-panel {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background-color: var(--panel-background-color);
            border-radius: 8px;
            margin-bottom: 16px;
            gap: 12px;
        }
        .controls-row { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; }
        .control-group { display: flex; align-items: center; gap: 6px; }
        .control-group label, .control-group > label { /* Increased specificity */
            font-size: 14px; 
            color: var(--system-blue); 
            font-weight: 600;
            white-space: nowrap; 
        }
        .separator { width: 1px; height: 20px; background-color: var(--border-color); }
        .spacer { margin-left: auto; }
        
        /* --- 按鈕與輸入框 --- */
        input[type="text"], input[type="number"] {
            font-family: var(--system-font);
            border: 1px solid var(--border-color);
            background-color: var(--editor-background-color);
            color: var(--text-color);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 14px;
            transition: box-shadow 0.2s, border-color 0.2s, background-color 0.3s;
        }
        #search-input, #replace-input { width: 80px; }
        #font-size-input, #border-width-input { width: 36px; }
        #row-height-input, #col-width-input { width: 40px; }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--system-blue); box-shadow: 0 0 0 3px color-mix(in srgb, var(--system-blue) 30%, transparent); }
        
        input[type="color"] {
            -webkit-appearance: none;
            width: 28px; height: 28px; border: none; padding: 0; background-color: transparent;
            border-radius: 6px; overflow: hidden; cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 4px; }
        
        input[type="color"].mixed::-webkit-color-swatch {
            background-image:
                linear-gradient(45deg, rgba(0,0,0,0.2) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(0,0,0,0.2) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(0,0,0,0.2) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(0,0,0,0.2) 75%);
            background-size: 8px 8px;
            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
        }


        button {
            padding: 5px 12px; border: none; background-color: var(--system-blue); color: white;
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;
            transition: transform 0.1s, filter 0.2s, background-color 0.2s; display: flex; align-items: center; gap: 6px;
        }
        button:hover { filter: brightness(1.1); }
        button:active { transform: scale(0.98); filter: brightness(1.2); }
        button.secondary { background-color: var(--system-gray); }
        button.success { background-color: var(--system-green); }
        button.danger { background-color: var(--system-red); }
        button:disabled { background-color: color-mix(in srgb, var(--system-gray) 50%, var(--panel-background-color)); color: var(--text-color-secondary); cursor: not-allowed; filter: none; }
        button:disabled:hover, button:disabled:active { transform: none; }
        button svg { width: 14px; height: 14px; fill: currentColor; }
        #save-html-btn svg { width: 16px; height: 16px; }

        /* --- 圖示按鈕 --- */
        button.icon-btn {
            padding: 6px;
            width: 30px;
            height: 30px;
            justify-content: center;
        }
        .btn-align { background-color: var(--system-green); }
        .btn-table { background-color: var(--system-brown); }

        /* --- 下拉選單 (Dropdown) --- */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--panel-background-color); min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 6px; padding: 5px 0; border: 1px solid var(--border-color); }
        .dropdown-content a { color: var(--text-color); padding: 8px 12px; text-decoration: none; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .dropdown-content a:hover { background-color: var(--border-color); }
        .dropdown.show .dropdown-content { display: block; }
        .dropdown-content svg { width: 16px; height: 16px; fill: var(--text-color-secondary); }

        /* --- 編輯器 --- */
        #editor-container { overflow: auto; padding: 20px; background-color: var(--editor-background-color); border-radius: 8px; border: 1px solid var(--border-color); transition: background-color 0.3s; }
        #content-display { background-color: transparent; min-height: 250px; transition: transform 0.2s ease; transform-origin: top left; user-select: none; }
        #content-display[contenteditable="true"] { user-select: text; cursor: text; }
        #content-display:focus { outline: none; }

        /* --- 表格與選取樣式 --- */
        #content-display table {
            border-collapse: collapse;
            width: 100%;
            position: relative;
            table-layout: fixed;
        }
        #content-display th, #content-display td { 
            border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; font-size: 14px; 
            transition: background-color 0.3s, border-color 0.3s, border-width 0.3s; position: relative; min-width: 40px;
            overflow: hidden;
            word-break: break-all;
        }
        #content-display th { background-color: var(--table-header-bg); font-weight: 600; }
        
        #content-display td.selected-cell, #content-display th.selected-cell { 
             outline: 1px solid var(--system-blue); 
             outline-offset: -1px; 
             background-color: color-mix(in srgb, var(--system-blue) 5%, transparent) !important; 
        }

        mark.highlight { background-color: #ffdd57; color: black; border-radius: 2px; padding: 0 2px; }
        
        .resizable-image-container { 
            position: relative;
            display: inline-block; /* Changed for easier resize */
            min-width: 20px; 
            min-height: 20px;
            /* width and height are set via style */
        }

        .resizable-image-container img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain;
            display: block;
            user-select: none;
            -webkit-user-drag: none;
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--system-blue);
            border: 2px solid var(--editor-background-color);
            right: -6px;
            bottom: -6px;
            border-radius: 50%;
            cursor: nwse-resize;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .resizable-image-container:hover .resize-handle {
            opacity: 1;
        }
        
        /* --- 提示訊息 --- */
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        #notification.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }

        /* --- 操作說明區塊 --- */
        .instructions-section {
            padding: 0 16px 16px 16px;
        }
        .instructions-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .instruction-category {
            background-color: var(--panel-background-color);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }
        .instruction-category h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            color: var(--text-color-secondary);
            margin-bottom: 12px;
        }
        .instruction-item:last-child {
            margin-bottom: 0;
        }
        .instruction-item .icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            fill: var(--text-color-secondary);
            margin-top: 2px;
        }
        .instruction-item .description .keyword {
            color: var(--system-blue);
            font-weight: 600;
        }

    </style>
</head>
<body>

    <div class="window-container">
        <header class="title-bar">
            <div class="title-bar-top">
                <div class="window-controls">
                    <span class="control-dot dot-red"></span>
                    <span class="control-dot dot-yellow"></span>
                    <span class="control-dot dot-green"></span>
                    <span id="current-filename"></span>
                </div>
                 <div class="title-content">
                    <h1 class="window-title">HTML 表格編輯器</h1>
                </div>
                <button id="theme-toggle" title="切換明暗主題">
                    <span id="theme-icon-sun">
                        <svg viewBox="0 0 24 24"><path d="M12 9.5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5-2.5-1.12-2.5-2.5 1.12-2.5 2.5-2.5M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 12h3m-1 9.78l2.12-2.12M12 2v3m8.12.88L18 7.12M22 12h-3m1-9.78L18.88 4.34M12 22v-3m-8.12-.88L6 16.88"/></svg>
                    </span>
                    <span id="theme-icon-moon" style="display: none;">
                        <svg viewBox="0 0 24 24"><path d="M12.3 4.9c.4-.2.6-.7.4-1.1-.2-.4-.7-.6-1.1-.4C7.2 5.4 4 9.2 4 13.5 4 19.1 8.9 24 14.5 24c4.3 0 8-3.2 9.1-7.4.2-.4 0-.9-.4-1.1s-.9-.1-1.1.2c-1.3 2.1-3.6 3.3-6.1 3.3-4.1 0-7.5-3.4-7.5-7.5 0-2.5 1.2-4.8 3.3-6.1z"/></svg>
                    </span>
                </button>
            </div>
            <p class="window-subtitle">本程式是針對 HTML 表格的視覺化編輯工具，提供直覺的操作介面。</p>
            <p class="window-creator">製作者：陳政德</p>
        </header>

        <main class="main-content">
            <div class="controls-panel">
                 <div class="controls-row">
                    <div class="control-group">
                        <button id="select-file-btn">選擇檔案</button>
                        <input type="file" id="file-input" accept=".html,.htm" style="display: none;">
                    </div>
                    <div class="control-group">
                        <input type="text" id="search-input" placeholder="搜尋文字" disabled>
                        <button id="search-btn" disabled>搜尋</button>
                        <input type="text" id="replace-input" placeholder="取代為" disabled>
                        <button id="replace-btn" class="secondary" disabled>全部取代</button>
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <label>對齊:</label>
                        <button id="align-left-btn" class="icon-btn btn-align" disabled title="靠左對齊"><svg viewBox="0 0 24 24"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-center-btn" class="icon-btn btn-align" disabled title="置中對齊"><svg viewBox="0 0 24 24"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-right-btn" class="icon-btn btn-align" disabled title="靠右對齊"><svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-top-btn" class="icon-btn btn-align" disabled title="靠上對齊"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-middle-btn" class="icon-btn btn-align" disabled title="垂直置中"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg></button>
                        <button id="align-bottom-btn" class="icon-btn btn-align" disabled title="靠下對齊"><svg viewBox="0 0 24 24" transform="rotate(90)"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/></svg></button>
                    </div>
                     <div class="control-group">
                        <label>縮放:</label>
                        <button id="zoom-in-btn" class="icon-btn" disabled title="放大">+</button>
                        <button id="zoom-out-btn" class="icon-btn" disabled title="縮小">-</button>
                        <button id="zoom-reset-btn" disabled title="重設縮放">100%</button>
                    </div>
                    <div class="control-group">
                         <button id="undo-btn" title="復原上一步 (Ctrl+Z)" disabled>
                             <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.38 11.23 17.28 8 12.5 8z"/></svg>
                             復原
                         </button>
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <label>文字:</label>
                        <input type="number" id="font-size-input" min="8" max="72" value="14" disabled title="文字大小">
                        <input type="color" id="font-color-input" value="#000000" disabled title="文字顏色">
                    </div>
                     <div class="control-group">
                        <label>背景:</label>
                        <input type="color" id="bg-color-input" value="#FFFFFF" disabled title="儲存格背景顏色">
                    </div>
                    <div class="separator"></div>
                    <div class="control-group">
                        <label>邊框:</label>
                        <input type="color" id="border-color-input" value="#dddddd" disabled title="表格邊框顏色">
                        <input type="number" id="border-width-input" min="0" max="10" value="1" disabled title="表格邊框寬度 (px)">
                        <div class="dropdown">
                            <button id="border-dropdown-btn" class="icon-btn btn-table" disabled title="設定框線">
                               <svg viewBox="0 0 24 24"><path d="M7 21H5V9h2v12zM9 13v2h2v-2H9zM9 17v2h2v-2H9zM9 9v2h2V9H9zM13 21h-2V9h2v12zM15 9h2v2h-2V9zM15 13h2v2h-2v-2zM15 17h2v2h-2v-2zM19 21h-2V9h2v12zM3 7V5h18v2H3zM3 21v-2h18v2H3z"/></svg>
                            </button>
                            <div class="dropdown-content" id="border-options">
                                <a href="#" data-border="bottom">下框線</a>
                                <a href="#" data-border="top">上框線</a>
                                <a href="#" data-border="left">左框線</a>
                                <a href="#" data-border="right">右框線</a>
                                <a href="#" data-border="none">無框線</a>
                                <a href="#" data-border="all">所有框線</a>
                                <a href="#" data-border="outside">外框線</a>
                                <a href="#" data-border="inside">內框線</a>
                            </div>
                        </div>
                    </div>
                    <div class="separator"></div>
                     <div class="control-group">
                        <label>表格:</label>
                        <button id="add-row-btn" class="icon-btn btn-table" disabled title="在下方新增一列"><svg viewBox="0 0 24 24"><path d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM4 12h16v4H4v-4zm10-4.5h2v3h-2v-3zm-3 0h2v3h-2v-3zm-3 0h2v3H8v-3zM21 20H3v-1c0-.55.45-1 1-1h16c.55 0 1 .45 1 1v1zM11 2v3h2V2h-2z"/></svg></button>
                        <button id="add-col-btn" class="icon-btn btn-table" disabled title="在右方新增一欄"><svg viewBox="0 0 24 24"><path d="M8 4v16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm6 14h-4V6h4v12zm-8.5-2h3v-2h-3v2zm0-3h3v-2h-3v2zm0-3h3v-2h-3v2zM20 4c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H10V4h10zM19 21v-2h1c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-1V1h-2v2h-8V1H8v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14v2h2z" transform="scale(1, -1) translate(0, -24)"/></svg></button>
                        <button id="delete-row-btn" class="danger icon-btn" disabled title="刪除選取列"><svg viewBox="0 0 24 24"><path d="M20 6H4c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 9H6v-2h12v2z"/></svg></button>
                        <button id="delete-col-btn" class="danger icon-btn" disabled title="刪除選取欄"><svg viewBox="0 0 24 24"><path d="M14 4v16c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2h-4zM4 8h4V6H4v2zm0 6h4v-2H4v2zm0-3h4v-2H4v2z"/></svg></button>
                        <button id="merge-cells-btn" class="icon-btn btn-table" disabled title="合併儲存格"><svg viewBox="0 0 24 24"><path d="M11 11H5v2h6v6h2v-6h6v-2h-6V5h-2v6Z M3 21V3h18v18H3Z"/></svg></button>
                        <button id="split-cell-btn" class="icon-btn btn-table" disabled title="拆分儲存格"><svg viewBox="0 0 24 24"><path d="M13 11V3h-2v8H3v2h8v8h2v-8h8v-2h-8Z M3 3v8h8V3H3Zm10 0v8h8V3h-8ZM3 13v8h8v-8H3Zm10 0v8h8v-8h-8Z"/></svg></button>
                        <button id="insert-image-btn" class="icon-btn btn-table" disabled title="在選取儲存格插入圖片">
                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        </button>
                    </div>
                     <div class="separator"></div>
                     <div class="control-group">
                        <label for="row-height-input">列高:</label>
                        <input type="number" id="row-height-input" min="1" disabled title="列高度 (px)">
                        <input type="checkbox" id="fix-row-height-check" disabled title="固定列高，禁止拖曳調整">
                        <label for="fix-row-height-check">固定</label>
                        
                        <label for="col-width-input" style="margin-left: 8px;">欄寬:</label>
                        <input type="number" id="col-width-input" min="1" disabled title="欄寬度 (px)">
                        <input type="checkbox" id="fix-col-width-check" disabled title="固定欄寬，禁止拖曳調整">
                        <label for="fix-col-width-check">固定</label>
                    </div>
                    <div class="spacer"></div>
                    <div class="control-group">
                        <button id="save-html-btn" class="success" disabled>
                            <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                            儲存為 HTML
                        </button>
                    </div>
                </div>
            </div>
    
            <div id="editor-container">
                <div id="content-display" contenteditable="false">
                    請從上方選擇一個包含 HTML 表格的檔案...
                </div>
            </div>
        </main>

        <section class="instructions-section">
            <h3 class="instructions-title">功能與操作說明</h3>
            <div class="instructions-grid">
                <div class="instruction-category">
                    <h4>檔案操作</h4>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                        <div class="description">
                            點擊 <span class="keyword">選擇檔案</span> 按鈕，可從您的電腦讀取 <span class="keyword">.html</span> 或 <span class="keyword">.htm</span> 檔案，並將檔案中的第一個表格載入編輯區。
                        </div>
                    </div>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                        <div class="description">
                            完成編輯後，點擊 <span class="keyword">儲存為 HTML</span> 按鈕，即可將目前的表格儲存為一個獨立的 <span class="keyword">.html</span> 檔案。
                        </div>
                    </div>
                </div>

                <div class="instruction-category">
                    <h4>編輯功能</h4>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <div class="description">
                           使用 <span class="keyword">搜尋</span> 與 <span class="keyword">取代</span> 功能，可以快速在表格中尋找或批次修改文字內容。
                        </div>
                    </div>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.38 11.23 17.28 8 12.5 8z"/></svg>
                        <div class="description">
                            任何操作失誤，都可以透過 <span class="keyword">復原</span> 按鈕回到上一步。最多可復原 30 步。
                        </div>
                    </div>
                     <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 6C9.79 6 8 7.79 8 10s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0-8C7.47 4 3.28 6.27 2 10c1.28 3.73 5.47 6 10 6s8.72-2.27 10-6c-1.28-3.73-5.47-6-10-6zm0 10c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        <div class="description">
                           透過 <span class="keyword">縮放</span> 功能，可以放大或縮小整個表格的預覽畫面，方便檢視細節或總覽全局。
                        </div>
                    </div>
                </div>
                 <div class="instruction-category">
                    <h4>格式設定</h4>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                        <div class="description">
                           設定選取儲存格的 <span class="keyword">文字</span> 大小與顏色，以及儲存格的 <span class="keyword">背景</span> 顏色。
                        </div>
                    </div>
                     <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg>
                        <div class="description">
                           調整文字的水平（<span class="keyword">靠左</span>、<span class="keyword">置中</span>、<span class="keyword">靠右</span>）與垂直（<span class="keyword">靠上</span>、<span class="keyword">垂直置中</span>、<span class="keyword">靠下</span>）<span class="keyword">對齊</span>方式。
                        </div>
                    </div>
                    <div class="instruction-item">
                         <svg class="icon" viewBox="0 0 24 24"><path d="M7 21H5V9h2v12zM9 13v2h2v-2H9zM9 17v2h2v-2H9zM9 9v2h2V9H9zM13 21h-2V9h2v12zM15 9h2v2h-2V9zM15 13h2v2h-2v-2zM15 17h2v2h-2v-2zM19 21h-2V9h2v12zM3 7V5h18v2H3zM3 21v-2h18v2H3z"/></svg>
                        <div class="description">
                           設定表格的 <span class="keyword">邊框</span> 顏色與寬度，或透過下拉選單，針對選取範圍設定 <span class="keyword">內外框線</span> 或 <span class="keyword">單邊框線</span>。
                        </div>
                    </div>
                </div>
                <div class="instruction-category">
                    <h4>表格操作</h4>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M11 11V3h2v8h8v2h-8v8h-2v-8H3v-2h8z"/></svg>
                        <div class="description">
                           在選取儲存格的右方或下方 <span class="keyword">新增</span> 欄或列，也可以 <span class="keyword">刪除</span> 目前選取的所有欄或列。
                        </div>
                    </div>
                     <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M11 11H5v2h6v6h2v-6h6v-2h-6V5h-2v6Z M3 21V3h18v18H3Z"/></svg>
                        <div class="description">
                           <span class="keyword">合併</span> 多個儲存格為一個，或將已合併的儲存格 <span class="keyword">拆分</span> 回原始狀態。
                        </div>
                    </div>
                    <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        <div class="description">
                           <span class="keyword">插入圖片</span> 到儲存格中，並可拖曳右下角控制點調整圖片大小。支援 <span class="keyword">.heic</span> 格式。
                        </div>
                    </div>
                     <div class="instruction-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg>
                        <div class="description">
                          設定 <span class="keyword">列高</span> 與 <span class="keyword">欄寬</span>，並可勾選 <span class="keyword">固定</span>，防止後續拖曳儲存格框線時改變尺寸。
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <input type="file" id="image-upload-input" accept="image/*,.heic,.heif" style="display:none;">
    <div id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const getEl = (id) => document.getElementById(id);
            const fileInput = getEl('file-input'), selectFileBtn = getEl('select-file-btn');
            const contentDisplay = getEl('content-display');
            const searchInput = getEl('search-input'), searchBtn = getEl('search-btn');
            const replaceInput = getEl('replace-input'), replaceBtn = getEl('replace-btn');
            const zoomInBtn = getEl('zoom-in-btn'), zoomOutBtn = getEl('zoom-out-btn'), zoomResetBtn = getEl('zoom-reset-btn');
            const saveHtmlBtn = getEl('save-html-btn'), notification = getEl('notification');
            const undoBtn = getEl('undo-btn');
            const alignLeftBtn = getEl('align-left-btn'), alignCenterBtn = getEl('align-center-btn'), alignRightBtn = getEl('align-right-btn');
            const alignTopBtn = getEl('align-top-btn'), alignMiddleBtn = getEl('align-middle-btn'), alignBottomBtn = getEl('align-bottom-btn');
            const addRowBtn = getEl('add-row-btn'), addColBtn = getEl('add-col-btn');
            const deleteRowBtn = getEl('delete-row-btn'), deleteColBtn = getEl('delete-col-btn');
            const mergeCellsBtn = getEl('merge-cells-btn'), splitCellBtn = getEl('split-cell-btn');
            const themeToggle = getEl('theme-toggle'), themeIconSun = getEl('theme-icon-sun'), themeIconMoon = getEl('theme-icon-moon');
            const fontSizeInput = getEl('font-size-input');
            const fontColorInput = getEl('font-color-input');
            const bgColorInput = getEl('bg-color-input');
            const borderColorInput = getEl('border-color-input');
            const borderWidthInput = getEl('border-width-input');
            const borderDropdownBtn = getEl('border-dropdown-btn');
            const borderOptions = getEl('border-options');
            const insertImageBtn = getEl('insert-image-btn');
            const imageUploadInput = getEl('image-upload-input');
            const rowHeightInput = getEl('row-height-input'), colWidthInput = getEl('col-width-input');
            const fixRowHeightCheck = getEl('fix-row-height-check'), fixColWidthCheck = getEl('fix-col-width-check');
            const currentFilename = getEl('current-filename');
            
            // --- State Variables ---
            let currentZoom = 1.0, notificationTimer;
            let historyStack = [], HISTORY_MAX_SIZE = 30;
            let selectedCells = [], isSelecting = false, startCell = null, endCell = null, dragStart = false;
            let resizing = null;
            let imageResizing = null; // State for image resizing
            let originalFilename = '';

            const allControls = [
                searchInput, searchBtn, replaceInput, replaceBtn, zoomInBtn, zoomOutBtn, zoomResetBtn, saveHtmlBtn, undoBtn,
                alignLeftBtn, alignCenterBtn, alignRightBtn, alignTopBtn, alignMiddleBtn, alignBottomBtn,
                addRowBtn, addColBtn, deleteRowBtn, deleteColBtn, mergeCellsBtn, splitCellBtn,
                fontSizeInput, fontColorInput, bgColorInput, borderColorInput, borderWidthInput, borderDropdownBtn, insertImageBtn,
                rowHeightInput, colWidthInput, fixRowHeightCheck, fixColWidthCheck
            ];

            // --- Core Functions ---
            function showNotification(message) {
                clearTimeout(notificationTimer);
                notification.textContent = message;
                notification.classList.add('show');
                notificationTimer = setTimeout(() => notification.classList.remove('show'), 3000);
            }

            function setControlsState(enabled) {
                allControls.forEach(control => control.disabled = !enabled);
                contentDisplay.contentEditable = enabled;
                undoBtn.disabled = historyStack.length <= 1;
            }
            
            function saveState() {
                // To prevent saving intermediate states during resize
                if (resizing || imageResizing) return;
                historyStack.push(contentDisplay.innerHTML);
                if (historyStack.length > HISTORY_MAX_SIZE) historyStack.shift();
                undoBtn.disabled = false;
            }

            function undoState() {
                if (historyStack.length > 1) {
                    historyStack.pop();
                    contentDisplay.innerHTML = historyStack[historyStack.length - 1];
                    clearSelection();
                }
                undoBtn.disabled = historyStack.length <= 1;
            }
            
             function colorToHex(colorStr) {
                const temp = document.createElement("div");
                temp.style.color = colorStr;
                document.body.appendChild(temp);
                const computedColor = window.getComputedStyle(temp).color;
                document.body.removeChild(temp);
                
                const match = computedColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (match) {
                    try {
                        const r = parseInt(match[1]);
                        const g = parseInt(match[2]);
                        const b = parseInt(match[3]);
                        return ("#" + 
                               ("0" + r.toString(16)).slice(-2) +
                               ("0" + g.toString(16)).slice(-2) +
                               ("0" + b.toString(16)).slice(-2)).toUpperCase();
                    } catch (e) {
                        return '#000000';
                    }
                }
                return '#FFFFFF'; // Fallback for invalid colors
            }
            
            function getEffectiveBackgroundColor(element) {
                let el = element;
                while (el && el !== document.body) {
                    const style = window.getComputedStyle(el);
                    const color = style.backgroundColor;
                    if (color && color !== 'transparent' && color !== 'rgba(0, 0, 0, 0)') {
                        return color;
                    }
                    if (el === contentDisplay) break; 
                    el = el.parentElement;
                }
                return window.getComputedStyle(getEl('editor-container')).backgroundColor;
            }

            function updateToolbarForSelection() {
                if (selectedCells.length === 0) return;

                const primaryCell = selectedCells[0];
                const primaryStyle = window.getComputedStyle(primaryCell);
                const primaryBgColor = colorToHex(getEffectiveBackgroundColor(primaryCell));
                const primaryFontColor = colorToHex(primaryStyle.color);
                
                let hasMixedBg = false;
                let hasMixedFont = false;

                for (let i = 1; i < selectedCells.length; i++) {
                    const currentCell = selectedCells[i];
                    const currentStyle = window.getComputedStyle(currentCell);
                    if (colorToHex(getEffectiveBackgroundColor(currentCell)) !== primaryBgColor) {
                        hasMixedBg = true;
                    }
                    if (colorToHex(currentStyle.color) !== primaryFontColor) {
                        hasMixedFont = true;
                    }
                    if (hasMixedBg && hasMixedFont) break; 
                }

                // Update common properties
                fontSizeInput.value = parseInt(primaryStyle.fontSize);
                const rect = primaryCell.getBoundingClientRect();
                rowHeightInput.value = Math.round(rect.height / currentZoom);
                colWidthInput.value = Math.round(rect.width / currentZoom);

                // Update color pickers
                if (hasMixedBg) {
                    bgColorInput.classList.add('mixed');
                } else {
                    bgColorInput.classList.remove('mixed');
                    bgColorInput.value = primaryBgColor;
                }

                if (hasMixedFont) {
                    fontColorInput.classList.add('mixed');
                } else {
                    fontColorInput.classList.remove('mixed');
                    fontColorInput.value = primaryFontColor;
                }
            }


            function clearHighlight() {
                contentDisplay.querySelectorAll('mark.highlight').forEach(mark => {
                    const parent = mark.parentNode;
                    parent.replaceChild(document.createTextNode(mark.textContent), mark);
                    parent.normalize();
                });
            }
            
            function updateZoom() { contentDisplay.style.transform = `scale(${currentZoom})`; }
            
            function applyToSelectedCells(callback, shouldSaveState = true) {
                if (selectedCells.length === 0) {
                    showNotification('請先選擇一個或多個儲存格。');
                    return;
                }
                selectedCells.forEach(cell => callback(cell));
                if (shouldSaveState) saveState();
            }

            function clearSelection() {
                contentDisplay.querySelectorAll('.selected-cell').forEach(cell => {
                    cell.classList.remove('selected-cell');
                });
                selectedCells = [];
            }

            function selectCells(start, end, table) {
                clearSelection();
                const rows = Array.from(table.rows);
                const startCoords = { r: start.parentElement.rowIndex, c: start.cellIndex };
                const endCoords = { r: end.parentElement.rowIndex, c: end.cellIndex };

                const r1 = Math.min(startCoords.r, endCoords.r);
                const r2 = Math.max(startCoords.r, endCoords.r);
                const c1 = Math.min(startCoords.c, endCoords.c);
                const c2 = Math.max(startCoords.c, endCoords.c);

                for (let i = r1; i <= r2; i++) {
                    for (let j = c1; j <= c2; j++) {
                        const cell = rows[i]?.cells[j];
                        if (cell) {
                            cell.classList.add('selected-cell');
                            selectedCells.push(cell);
                        }
                    }
                }
            }
            
            // --- Event Listeners ---
            selectFileBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                originalFilename = file.name.replace(/\.[^/.]+$/, ""); 
                currentFilename.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const doc = new DOMParser().parseFromString(e.target.result, 'text/html');
                    const table = doc.querySelector('table');
                    if (table) {
                        contentDisplay.innerHTML = table.outerHTML;
                        setControlsState(true);
                        historyStack = [];
                        saveState();
                        const firstCell = table.querySelector('td, th');
                        if (firstCell) {
                            const computedStyle = window.getComputedStyle(firstCell);
                            borderColorInput.value = colorToHex(computedStyle.borderColor);
                            borderWidthInput.value = parseInt(computedStyle.borderWidth) || 1;
                        }
                        showNotification('檔案載入成功！');
                    } else {
                        contentDisplay.innerHTML = '<p style="color: red;">錯誤：檔案中找不到 &lt;table&gt; 元素。</p>';
                        setControlsState(false);
                    }
                };
                reader.readAsText(file);
                fileInput.value = ''; // Reset for re-uploading same file
            });
            
            searchBtn.addEventListener('click', () => {
                clearHighlight();
                const searchTerm = searchInput.value;
                if (!searchTerm) return;
                let count = 0;
                const regex = new RegExp(searchTerm, 'gi');
                contentDisplay.querySelectorAll('td, th').forEach(cell => {
                    const originalHTML = cell.innerHTML;
                    let matchesFound = 0;
                    const newHTML = originalHTML.replace(regex, (match) => {
                        matchesFound++;
                        return `<mark class="highlight">${match}</mark>`;
                    });
                    if (matchesFound > 0) {
                        cell.innerHTML = newHTML;
                        count += matchesFound;
                    }
                });
                showNotification(`找到 ${count} 個符合的項目。`);
            });

            replaceBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value;
                const replaceTerm = replaceInput.value;
                if (!searchTerm) {
                    showNotification('請先輸入要搜尋的文字。');
                    return;
                }
                let count = 0;
                const regex = new RegExp(searchTerm, 'gi');
                contentDisplay.querySelectorAll('td, th').forEach(cell => {
                    if (cell.textContent.match(regex)) {
                        count += (cell.innerHTML.match(regex) || []).length;
                        cell.innerHTML = cell.innerHTML.replace(regex, replaceTerm);
                    }
                });
                if (count > 0) {
                    saveState();
                    showNotification(`已取代 ${count} 個項目。`);
                } else {
                    showNotification('找不到符合取代的項目。');
                }
            });

            saveHtmlBtn.addEventListener('click', () => {
                clearSelection();
                clearHighlight();
                const tableHTML = contentDisplay.innerHTML;
                const filename = `${originalFilename || 'table'}.html`;

                const fullHTML = `<!DOCTYPE html>
    <html lang="zh-Hant">
    <head>
        <meta charset="UTF-8">
        <title>Exported Table</title>
        <style>
            body { font-family: sans-serif; }
            table { border-collapse: collapse; width: 100%; table-layout: fixed; }
            td, th { border: 1px solid #ddd; padding: 8px; overflow: hidden; word-break: break-all; }
        </style>
    </head>
    <body>
        ${tableHTML}
    </body>
    </html>`;
                const blob = new Blob([fullHTML], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                showNotification('HTML 檔案已儲存。');
            });
            
            zoomInBtn.addEventListener('click', () => { currentZoom = Math.min(2.0, currentZoom + 0.1); updateZoom(); });
            zoomOutBtn.addEventListener('click', () => { currentZoom = Math.max(0.2, currentZoom - 0.1); updateZoom(); });
            zoomResetBtn.addEventListener('click', () => { currentZoom = 1.0; updateZoom(); });
            undoBtn.addEventListener('click', undoState);
            document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); if (!undoBtn.disabled) undoState(); }});

            function onMouseMove(e) {
                if (!resizing) return;
                if (resizing.type === 'col') {
                    const newW = resizing.startW + (e.clientX - resizing.startX);
                    if (newW > 40) resizing.target.style.width = newW + 'px';
                } else {
                    const newH = resizing.startH + (e.clientY - resizing.startY);
                    if (newH > 30) resizing.target.style.height = newH + 'px';
                }
            }
            
            function onMouseUpResize() {
                if (resizing) saveState();
                resizing = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUpResize);
            }

            function onImageResizeMove(e) {
                if (!imageResizing) return;
                const dx = e.clientX - imageResizing.startX;
                const dy = e.clientY - imageResizing.startY;
                let newW = imageResizing.startW + dx;
                let newH = imageResizing.startH + dy;
                if (newW < 20) newW = 20;
                if (newH < 20) newH = 20;
                imageResizing.container.style.width = newW + 'px';
                imageResizing.container.style.height = newH + 'px';
            }

            function onImageResizeUp() {
                if (imageResizing) {
                    saveState();
                }
                document.removeEventListener('mousemove', onImageResizeMove);
                document.removeEventListener('mouseup', onImageResizeUp);
                imageResizing = null;
            }

            contentDisplay.addEventListener('mousemove', (e) => {
                if (resizing || imageResizing) return;
                const cell = e.target.closest('td, th');
                if (cell) {
                    const rect = cell.getBoundingClientRect();
                    const atRightEdge = Math.abs(e.clientX - rect.right) < 5;
                    const atBottomEdge = Math.abs(e.clientY - rect.bottom) < 5;

                    if (atRightEdge && !fixColWidthCheck.checked) {
                        cell.style.cursor = 'col-resize';
                    } else if (atBottomEdge && !fixRowHeightCheck.checked) {
                        cell.style.cursor = 'row-resize';
                    } else {
                        cell.style.cursor = 'text';
                    }
                }
                if (!dragStart) return;
                if (!isSelecting) isSelecting = true;
                
                const currentCell = e.target.closest('td, th');
                const table = contentDisplay.querySelector('table');
                if (currentCell && table?.contains(currentCell) && currentCell !== endCell) {
                    endCell = currentCell;
                    selectCells(startCell, endCell, table);
                }
            });

            contentDisplay.addEventListener('mousedown', (e) => {
                // Handle image resize first
                if (e.target.classList.contains('resize-handle')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const container = e.target.closest('.resizable-image-container');
                    imageResizing = {
                        container: container,
                        startX: e.clientX,
                        startY: e.clientY,
                        startW: container.offsetWidth,
                        startH: container.offsetHeight
                    };
                    document.addEventListener('mousemove', onImageResizeMove);
                    document.addEventListener('mouseup', onImageResizeUp);
                    return;
                }

                if (resizing) e.preventDefault();
                const cell = e.target.closest('td, th');
                
                if (!cell || e.target.closest('.resizable-image-container')) return;

                if (cell.style.cursor === 'col-resize' && !fixColWidthCheck.checked) {
                    resizing = { type: 'col', target: cell, startX: e.clientX, startW: cell.offsetWidth };
                } else if (cell.style.cursor === 'row-resize' && !fixRowHeightCheck.checked) {
                    resizing = { type: 'row', target: cell.parentElement, startY: e.clientY, startH: cell.parentElement.offsetHeight };
                }

                if (resizing) {
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUpResize);
                } else {
                    dragStart = true;
                    isSelecting = false;
                    startCell = cell;
                    endCell = cell;
                }
            });

            window.addEventListener('mouseup', () => {
                if (dragStart) {
                    if (!isSelecting) { // Handle single click selection
                        clearSelection();
                        if(startCell) {
                            startCell.classList.add('selected-cell');
                            selectedCells.push(startCell);
                        }
                    }
                    if (selectedCells.length > 0) {
                        updateToolbarForSelection();
                    }
                }
                dragStart = false;
                isSelecting = false;
            });

            const setStyle = (prop, val) => applyToSelectedCells(c => c.style[prop] = val);
            alignLeftBtn.addEventListener('click', () => setStyle('textAlign', 'left'));
            alignCenterBtn.addEventListener('click', () => setStyle('textAlign', 'center'));
            alignRightBtn.addEventListener('click', () => setStyle('textAlign', 'right'));
            alignTopBtn.addEventListener('click', () => setStyle('verticalAlign', 'top'));
            alignMiddleBtn.addEventListener('click', () => setStyle('verticalAlign', 'middle'));
            alignBottomBtn.addEventListener('click', () => setStyle('verticalAlign', 'bottom'));
            
            // Add delayed saveState to inputs
            const addInputListener = (input, styleProp, unit = '') => {
                input.addEventListener('input', () => {
                    const value = input.value + unit;
                    if (value) { 
                        input.classList.remove('mixed'); // When user picks a color, it's no longer mixed
                        applyToSelectedCells(c => c.style[styleProp] = value, false);
                        clearTimeout(input.timer);
                        input.timer = setTimeout(saveState, 500);
                    }
                });
            };

            addInputListener(fontSizeInput, 'fontSize', 'px');
            addInputListener(fontColorInput, 'color');
            addInputListener(bgColorInput, 'backgroundColor');
            addInputListener(rowHeightInput, 'height', 'px');
            addInputListener(colWidthInput, 'width', 'px');

            // --- New Border Logic ---
            borderDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                borderDropdownBtn.parentElement.classList.toggle('show');
            });

            borderOptions.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (!target) return;

                const borderType = target.dataset.border;
                if (selectedCells.length === 0) {
                    showNotification('請先選擇儲存格');
                    return;
                }
                
                const width = borderWidthInput.value;
                const color = borderColorInput.value;
                const borderStyle = `${width}px solid ${color}`;
                
                // For outside/inside logic, find selection boundaries
                const bounds = { minR: Infinity, maxR: -1, minC: Infinity, maxC: -1 };
                selectedCells.forEach(cell => {
                    bounds.minR = Math.min(bounds.minR, cell.parentElement.rowIndex);
                    bounds.maxR = Math.max(bounds.maxR, cell.parentElement.rowIndex);
                    bounds.minC = Math.min(bounds.minC, cell.cellIndex);
                    bounds.maxC = Math.max(bounds.maxC, cell.cellIndex);
                });

                applyToSelectedCells(cell => {
                    switch (borderType) {
                        case 'bottom': cell.style.borderBottom = borderStyle; break;
                        case 'top': cell.style.borderTop = borderStyle; break;
                        case 'left': cell.style.borderLeft = borderStyle; break;
                        case 'right': cell.style.borderRight = borderStyle; break;
                        case 'none': cell.style.border = 'none'; break;
                        case 'all': cell.style.border = borderStyle; break;
                        case 'outside':
                            if (cell.parentElement.rowIndex === bounds.minR) cell.style.borderTop = borderStyle;
                            if (cell.parentElement.rowIndex === bounds.maxR) cell.style.borderBottom = borderStyle;
                            if (cell.cellIndex === bounds.minC) cell.style.borderLeft = borderStyle;
                            if (cell.cellIndex === bounds.maxC) cell.style.borderRight = borderStyle;
                            break;
                         case 'inside':
                            if (cell.parentElement.rowIndex < bounds.maxR) cell.style.borderBottom = borderStyle;
                            if (cell.cellIndex < bounds.maxC) cell.style.borderRight = borderStyle;
                            break;
                    }
                }, false); // Defer saveState call

                saveState();
                borderDropdownBtn.parentElement.classList.remove('show');
            });
            
            function applyTableWideBorder() {
                const table = contentDisplay.querySelector('table');
                if (!table) return;
                const color = borderColorInput.value;
                const width = borderWidthInput.value + 'px';
                table.querySelectorAll('td, th').forEach(cell => {
                    cell.style.borderColor = color;
                    cell.style.borderWidth = width;
                });
                saveState();
            }
            borderColorInput.addEventListener('input', applyTableWideBorder);
            borderWidthInput.addEventListener('input', applyTableWideBorder);
            // --- End New Border Logic ---

            addRowBtn.addEventListener('click', () => { 
                if(selectedCells.length === 0) { 
                    showNotification('請先選擇一個儲存格以確定新增位置'); 
                    return; 
                }
                const lastSelectedCell = selectedCells[selectedCells.length - 1];
                const currentRow = lastSelectedCell.parentElement;
                const table = currentRow.closest('table');
                if (!table || !currentRow) return;
                const colCount = table.rows[0].cells.length;
                const newRow = table.insertRow(currentRow.rowIndex + 1);
                for (let i = 0; i < colCount; i++) {
                    newRow.insertCell(i).innerHTML = '&nbsp;';
                }
                saveState(); 
            });

            addColBtn.addEventListener('click', () => {
                if (selectedCells.length === 0) {
                    showNotification('請先選擇一個儲存格以確定新增位置');
                    return;
                }
                const lastSelectedCell = selectedCells[selectedCells.length - 1];
                const table = lastSelectedCell.closest('table');
                const colIndex = lastSelectedCell.cellIndex;
                for (const row of table.rows) {
                    const newCell = row.insertCell(colIndex + 1);
                    newCell.innerHTML = '&nbsp;';
                }
                saveState();
            });

            deleteRowBtn.addEventListener('click', () => {
                if (selectedCells.length === 0) {
                    showNotification('請選擇要刪除的列中的儲存格');
                    return;
                }
                const rowsToDelete = [...new Set(selectedCells.map(cell => cell.parentElement))];
                if (rowsToDelete[0].closest('table').rows.length <= rowsToDelete.length) {
                    showNotification('無法刪除表格的所有列');
                    return;
                }
                rowsToDelete.forEach(row => row.remove());
                clearSelection();
                saveState();
            });

            deleteColBtn.addEventListener('click', () => {
                if (selectedCells.length === 0) {
                    showNotification('請選擇要刪除的欄中的儲存格');
                    return;
                }
                const table = selectedCells[0].closest('table');
                if (table.rows[0].cells.length <= 1) {
                    showNotification('無法刪除表格的最後一欄');
                    return;
                }
                const colsToDelete = [...new Set(selectedCells.map(cell => cell.cellIndex))].sort((a, b) => b - a);
                colsToDelete.forEach(colIndex => {
                    for (const row of table.rows) {
                        row.deleteCell(colIndex);
                    }
                });
                clearSelection();
                saveState();
            });
            
            mergeCellsBtn.addEventListener('click', () => {
                if (selectedCells.length < 2) {
                    showNotification('請選擇至少兩個儲存格來合併。');
                    return;
                }

                let minRow = Infinity, maxRow = -1, minCol = Infinity, maxCol = -1;
                let content = '';

                selectedCells.forEach(cell => {
                    content += cell.innerHTML + ' ';
                    const r = cell.parentElement.rowIndex;
                    const c = cell.cellIndex;
                    if (r < minRow) minRow = r;
                    if (r > maxRow) maxRow = r;
                    if (c < minCol) minCol = c;
                    if (c > maxCol) maxCol = c;
                });
                
                selectedCells.sort((a, b) => a.parentElement.rowIndex - b.parentElement.rowIndex || a.cellIndex - b.cellIndex);
                const firstCell = selectedCells[0];

                const colSpan = maxCol - minCol + 1;
                const rowSpan = maxRow - minRow + 1;

                firstCell.setAttribute('colspan', colSpan);
                firstCell.setAttribute('rowspan', rowSpan);
                firstCell.innerHTML = content.trim();

                selectedCells.slice(1).forEach(cell => cell.remove());
                
                saveState();
                clearSelection();
                firstCell.classList.add('selected-cell');
                selectedCells.push(firstCell);
                showNotification('儲存格已合併。');
            });

            splitCellBtn.addEventListener('click', () => {
                if (selectedCells.length !== 1) {
                    showNotification('請選擇一個要拆分的儲存格。');
                    return;
                }
                const cell = selectedCells[0];
                const rowSpan = parseInt(cell.getAttribute('rowspan') || '1');
                const colSpan = parseInt(cell.getAttribute('colspan') || '1');

                if (rowSpan === 1 && colSpan === 1) {
                    showNotification('這個儲存格沒有被合併。');
                    return;
                }
                
                const table = cell.closest('table');
                const parentRow = cell.parentElement;
                const rowIndex = parentRow.rowIndex;
                const cellIndex = cell.cellIndex;

                cell.removeAttribute('rowspan');
                cell.removeAttribute('colspan');

                for (let r = 0; r < rowSpan; r++) {
                    const targetRow = table.rows[rowIndex + r];
                    for (let c = 0; c < colSpan; c++) {
                        if (r === 0 && c === 0) continue; 
                        const newCell = targetRow.insertCell(cellIndex + c);
                        newCell.innerHTML = '&nbsp;';
                    }
                }
                saveState();
                showNotification('儲存格已拆分。');
            });
            
            insertImageBtn.addEventListener('click', () => { if(selectedCells.length === 0) { showNotification('請選擇一個儲存格'); return; } imageUploadInput.click(); });
            
            imageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || /\.heic$/i.test(file.name) || /\.heif$/i.test(file.name);

                const processImage = (imageBlob) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const imgHTML = `<div class="resizable-image-container">` +
                                        `<img src="${ev.target.result}" alt="">` +
                                        `<div class="resize-handle"></div>` +
                                        `</div>`;
                        applyToSelectedCells(cell => {
                            cell.innerHTML = imgHTML;
                            const img = cell.querySelector('img');
                            img.onload = () => {
                                const container = img.parentElement;
                                const cellWidth = cell.clientWidth - 24; // Account for padding
                                const aspect = img.naturalWidth / img.naturalHeight;
                                let w = Math.min(img.naturalWidth, cellWidth);
                                let h = w / aspect;
                                container.style.width = w + 'px';
                                container.style.height = h + 'px';
                                saveState();
                            };
                        }, false);
                    };
                    reader.readAsDataURL(imageBlob);
                };

                if (isHeic) {
                    showNotification('正在轉換 HEIC 檔案...');
                    heic2any({
                        blob: file,
                        toType: "image/jpeg",
                        quality: 0.8,
                    })
                    .then((conversionResult) => {
                        processImage(conversionResult);
                         showNotification('HEIC 檔案轉換成功！');
                    })
                    .catch((err) => {
                        console.error(err);
                        showNotification('HEIC 檔案轉換失敗。');
                    });
                } else {
                    processImage(file);
                }
                
                imageUploadInput.value = '';
            });

            themeToggle.addEventListener('click', () => {
                const body = document.body;
                const isDark = body.getAttribute('data-theme') === 'dark';
                if (isDark) {
                    body.removeAttribute('data-theme');
                    themeIconSun.style.display = 'block';
                    themeIconMoon.style.display = 'none';
                } else {
                    body.setAttribute('data-theme', 'dark');
                    themeIconSun.style.display = 'none';
                    themeIconMoon.style.display = 'block';
                }
            });
            
            // Close dropdowns if clicked outside
            window.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown.show').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                }
            });

        });
    </script>
</body>
</html>
